<!DOCTYPE html>
<html lang="de">
<head>
    <link rel="icon" type="image/svg+xml" href="/assets/icons/icon_rift_r.svg">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <meta name="view-transition" content="same-origin">
    <title>RIFT – GM Kontrollzentrum</title>
    
    <link rel="stylesheet" href="/assets/css/core.css">
    <link rel="stylesheet" href="/assets/css/ui.css">
    <link rel="stylesheet" href="/assets/css/dock.css">
    <link rel="stylesheet" href="/assets/css/hub.css">
    <link rel="stylesheet" href="/assets/css/settings.css">
    <link rel="stylesheet" href="/assets/css/gm-characters.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.6.1/cropper.min.css">
    
    <style>
        /* ==================== BROADCAST CENTER STYLES ==================== */
        
        .broadcast-page {
            padding: 24px;
            --bc-accent: #8b5cf6;
            --bc-accent-light: #a78bfa;
            --bc-bg-card: #111111;
            --bc-bg-elevated: #1a1a1a;
            --bc-border: rgba(255,255,255,0.08);
            --bc-text: rgba(255,255,255,0.9);
            --bc-text-muted: rgba(255,255,255,0.5);
        }
        
        .broadcast-container {
            max-width: 1400px;
            margin: 0 auto;
        }
        
        .broadcast-header {
            margin-bottom: 32px;
        }
        
        .broadcast-header__title {
            font-size: 28px;
            font-weight: 700;
            color: white;
            margin: 0 0 8px 0;
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .broadcast-header__title svg {
            width: 32px;
            height: 32px;
            color: #8b5cf6;
        }
        
        .broadcast-header__subtitle {
            font-size: 14px;
            color: rgba(255,255,255,0.5);
            margin: 0;
        }
        
        /* ==================== TAB NAVIGATION ==================== */
        .broadcast-tabs {
            display: flex;
            gap: 2px;
            background: rgba(255,255,255,0.03);
            padding: 4px;
            border-radius: 14px;
            margin-bottom: 28px;
            overflow-x: auto;
            border: 1px solid rgba(255,255,255,0.06);
            scrollbar-width: none;
        }
        .broadcast-tabs::-webkit-scrollbar { display: none; }
        
        .broadcast-tab {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 11px 18px;
            background: transparent;
            border: none;
            border-radius: 10px;
            color: rgba(255,255,255,0.45);
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            white-space: nowrap;
            position: relative;
        }
        
        .broadcast-tab:hover {
            background: rgba(255,255,255,0.06);
            color: rgba(255,255,255,0.85);
        }
        
        .broadcast-tab.active {
            background: rgba(139,92,246,0.15);
            color: #c4b5fd;
            box-shadow: inset 0 0 0 1px rgba(139,92,246,0.25);
        }
        
        .broadcast-tab svg {
            width: 17px;
            height: 17px;
            flex-shrink: 0;
        }
        
        .broadcast-tab.active svg {
            color: #a78bfa;
        }
        
        /* ==================== CONTENT PANELS ==================== */
        .broadcast-panel {
            display: none;
        }
        
        .broadcast-panel.active {
            display: block;
        }
        
        /* Characters panel needs flex layout */
        #panel-characters.active {
            display: flex;
            flex-direction: column;
        }
        
        .broadcast-grid {
            display: grid;
            grid-template-columns: 1fr 400px;
            gap: 24px;
        }
        
        @media (max-width: 1200px) {
            .broadcast-grid {
                grid-template-columns: 1fr;
            }
        }
        
        /* ==================== CARDS ==================== */
        .bc-card {
            background: #111111;
            border: 1px solid rgba(255,255,255,0.08);
            border-radius: 16px;
            overflow: hidden;
            margin-bottom: 24px;
        }
        
        .bc-card__header {
            padding: 18px 24px;
            border-bottom: 1px solid rgba(255,255,255,0.06);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .bc-card__title {
            font-size: 15px;
            font-weight: 600;
            color: white;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .bc-card__title svg {
            width: 18px;
            height: 18px;
            color: var(--bc-accent);
            flex-shrink: 0;
        }
        
        .bc-card__body {
            padding: 24px;
        }
        
        /* Inline icon helper (replacing emojis) */
        .bc-icon {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 18px;
            height: 18px;
            flex-shrink: 0;
            vertical-align: middle;
        }
        .bc-icon svg { width: 100%; height: 100%; }
        .bc-icon--sm { width: 14px; height: 14px; }
        .bc-icon--lg { width: 22px; height: 22px; }
        
        /* ==================== FORM ELEMENTS ==================== */
        .bc-input {
            width: 100%;
            padding: 14px 16px;
            background: rgba(0,0,0,0.3);
            border: 1px solid rgba(255,255,255,0.08);
            border-radius: 10px;
            color: white;
            font-size: 14px;
            transition: all 0.2s;
            box-sizing: border-box;
        }
        
        .bc-input:focus {
            outline: none;
            border-color: #8b5cf6;
            background: rgba(0,0,0,0.4);
        }
        
        .bc-input::placeholder {
            color: rgba(255,255,255,0.4);
        }
        
        .bc-textarea {
            width: 100%;
            min-height: 120px;
            padding: 14px 16px;
            background: rgba(0,0,0,0.3);
            border: 1px solid rgba(255,255,255,0.08);
            border-radius: 10px;
            color: white;
            font-size: 14px;
            font-family: inherit;
            resize: vertical;
            transition: all 0.2s;
            box-sizing: border-box;
        }
        
        .bc-textarea:focus {
            outline: none;
            border-color: #8b5cf6;
        }
        
        .bc-label {
            display: block;
            font-size: 12px;
            font-weight: 600;
            color: rgba(255,255,255,0.5);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 8px;
        }
        
        .bc-field {
            margin-bottom: 20px;
        }
        
        .bc-field:last-child {
            margin-bottom: 0;
        }
        
        /* ==================== BUTTONS ==================== */
        .bc-btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            padding: 14px 24px;
            background: #8b5cf6;
            border: none;
            border-radius: 10px;
            color: white;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .bc-btn:hover {
            filter: brightness(1.1);
            transform: translateY(-1px);
        }
        
        .bc-btn svg {
            width: 18px;
            height: 18px;
        }
        
        .bc-btn--secondary {
            background: rgba(255,255,255,0.1);
        }
        
        .bc-btn--danger {
            background: #ef4444;
        }
        
        .bc-btn--success {
            background: #22c55e;
        }
        
        .bc-btn--warning {
            background: #f59e0b;
            color: #1a1200;
        }
        
        .bc-btn--full {
            width: 100%;
        }
        
        .bc-btn--small {
            padding: 10px 16px;
            font-size: 13px;
        }
        
        /* ==================== TYPE SELECTOR ==================== */
        .bc-types {
            display: grid;
            grid-template-columns: repeat(6, 1fr);
            gap: 8px;
            margin-bottom: 20px;
        }
        
        @media (max-width: 768px) {
            .bc-types {
                grid-template-columns: repeat(3, 1fr);
            }
        }
        
        .bc-type {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 6px;
            padding: 14px 12px;
            background: rgba(255,255,255,0.03);
            border: 2px solid transparent;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .bc-type:hover {
            background: rgba(255,255,255,0.06);
        }
        
        .bc-type.active {
            border-color: #8b5cf6;
            background: rgba(139,92,246,0.1);
        }
        
        .bc-type__icon {
            width: 40px;
            height: 40px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            background: rgba(255,255,255,0.05);
            color: rgba(255,255,255,0.6);
        }
        .bc-type__icon svg { width: 20px; height: 20px; }
        .bc-type.active .bc-type__icon { color: var(--bc-accent); }
        .bc-type--info .bc-type__icon { color: #60a5fa; }
        .bc-type--warning .bc-type__icon { color: #fbbf24; }
        .bc-type--danger .bc-type__icon { color: #f87171; }
        .bc-type--success .bc-type__icon { color: #4ade80; }
        .bc-type--epic .bc-type__icon { color: #c084fc; }
        .bc-type--mystery .bc-type__icon { color: #a78bfa; }
        
        .bc-type__label {
            font-size: 12px;
            color: rgba(255,255,255,0.5);
        }
        
        .bc-type.active .bc-type__label {
            color: white;
        }
        
        /* ==================== SOUND SELECTOR ==================== */
        .bc-sounds {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }
        
        .bc-sound {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 10px 14px;
            background: rgba(255,255,255,0.05);
            border: 1px solid transparent;
            border-radius: 8px;
            color: rgba(255,255,255,0.6);
            font-size: 13px;
            cursor: pointer;
            transition: all 0.2s;
        }
        .bc-sound svg { width: 15px; height: 15px; flex-shrink: 0; }
        
        .bc-sound:hover {
            background: rgba(255,255,255,0.08);
            color: white;
        }
        
        .bc-sound.active {
            border-color: #8b5cf6;
            background: rgba(139,92,246,0.1);
            color: white;
        }
        
        .bc-sound__preview {
            width: 24px;
            height: 24px;
            background: rgba(255,255,255,0.1);
            border: none;
            border-radius: 50%;
            color: white;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 10px;
        }
        
        .bc-sound__preview:hover {
            background: #8b5cf6;
        }
        
        /* ==================== IMAGE UPLOAD ==================== */
        .bc-image-upload {
            border: 2px dashed rgba(255,255,255,0.15);
            border-radius: 12px;
            padding: 40px 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
            position: relative;
            overflow: hidden;
            min-height: 80px;
        }
        
        .bc-image-upload:hover {
            border-color: #8b5cf6;
            background: rgba(139,92,246,0.05);
        }
        
        .bc-image-upload.has-image {
            padding: 0;
            border-style: solid;
            min-height: 120px;
        }
        
        .bc-image-upload__placeholder {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 12px;
            color: rgba(255,255,255,0.4);
        }
        
        .bc-image-upload__placeholder svg {
            width: 48px;
            height: 48px;
            opacity: 0.5;
        }
        
        .bc-image-upload__preview {
            position: relative;
            width: 100%;
            max-height: 200px;
            object-fit: contain;
            border-radius: 10px;
        }
        
        .bc-image-upload input[type="file"] {
            display: none !important;
        }
        
        /* ==================== PLAYER SELECTOR ==================== */
        .bc-players {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }
        
        .bc-player {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px 14px;
            background: rgba(255,255,255,0.03);
            border: 2px solid transparent;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .bc-player:hover {
            background: rgba(255,255,255,0.06);
        }
        
        .bc-player.selected {
            border-color: #8b5cf6;
            background: rgba(139,92,246,0.1);
        }
        
        .bc-player__avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            font-weight: 600;
            color: white;
        }
        
        .bc-player__name {
            font-size: 14px;
            color: white;
        }
        
        .bc-player__check {
            width: 20px;
            height: 20px;
            border: 2px solid rgba(255,255,255,0.2);
            border-radius: 50%;
            margin-left: auto;
            transition: all 0.2s;
        }
        
        .bc-player.selected .bc-player__check {
            background: #8b5cf6;
            border-color: #8b5cf6;
        }
        
        /* ==================== QUICK REACTIONS ==================== */
        .bc-reactions {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 12px;
        }
        
        @media (max-width: 768px) {
            .bc-reactions {
                grid-template-columns: repeat(2, 1fr);
            }
        }
        
        .bc-reaction {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
            padding: 20px 12px;
            background: rgba(255,255,255,0.03);
            border: 1px solid rgba(255,255,255,0.08);
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .bc-reaction:hover {
            background: rgba(255,255,255,0.08);
            transform: translateY(-2px);
        }
        
        .bc-reaction__emoji {
            font-size: 32px;
        }
        
        .bc-reaction__label {
            font-size: 11px;
            color: rgba(255,255,255,0.5);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        /* Emoji Picker */
        .emoji-pick {
            font-size: 20px;
            cursor: pointer;
            padding: 4px;
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background 0.15s;
        }
        
        .emoji-pick:hover {
            background: rgba(139,92,246,0.3);
        }
        
        /* ==================== POLL OPTIONS ==================== */
        .bc-poll-options {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        
        .bc-poll-option {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .bc-poll-option__emoji {
            width: 44px;
            height: 44px;
            background: rgba(0,0,0,0.3);
            border: 1px solid rgba(255,255,255,0.08);
            border-radius: 8px;
            font-size: 20px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
            color: white;
        }
        
        .bc-poll-option__emoji:hover {
            border-color: #8b5cf6;
        }
        
        .bc-poll-option__input {
            flex: 1;
        }
        
        .bc-poll-option__remove {
            width: 36px;
            height: 36px;
            background: transparent;
            border: none;
            color: rgba(255,255,255,0.4);
            cursor: pointer;
            border-radius: 8px;
            transition: all 0.2s;
            font-size: 16px;
        }
        
        .bc-poll-option__remove:hover {
            background: rgba(239,68,68,0.1);
            color: #ef4444;
        }
        
        /* ==================== POLL SETTINGS ==================== */
        .bc-poll-settings {
            display: flex;
            flex-wrap: wrap;
            gap: 16px;
            padding: 16px;
            background: rgba(255,255,255,0.02);
            border-radius: 10px;
            margin-top: 20px;
        }
        
        .bc-toggle {
            display: flex;
            align-items: center;
            gap: 10px;
            cursor: pointer;
        }
        
        .bc-toggle__switch {
            width: 44px;
            height: 24px;
            background: rgba(255,255,255,0.1);
            border-radius: 12px;
            position: relative;
            transition: all 0.2s;
        }
        
        .bc-toggle__switch::after {
            content: '';
            position: absolute;
            top: 2px;
            left: 2px;
            width: 20px;
            height: 20px;
            background: white;
            border-radius: 50%;
            transition: all 0.2s;
        }
        
        .bc-toggle input {
            display: none;
        }
        
        .bc-toggle input:checked + .bc-toggle__switch {
            background: #8b5cf6;
        }
        
        .bc-toggle input:checked + .bc-toggle__switch::after {
            left: 22px;
        }
        
        .bc-toggle__label {
            font-size: 13px;
            color: rgba(255,255,255,0.6);
        }
        
        /* ==================== COUNTDOWN BUTTONS ==================== */
        .bc-countdown-selector {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }
        
        .bc-countdown-btn {
            padding: 10px 16px;
            background: rgba(255,255,255,0.05);
            border: 1px solid transparent;
            border-radius: 8px;
            color: rgba(255,255,255,0.6);
            font-size: 13px;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .bc-countdown-btn:hover {
            background: rgba(255,255,255,0.1);
        }
        
        .bc-countdown-btn.active {
            border-color: #8b5cf6;
            background: rgba(139,92,246,0.1);
            color: white;
        }
        
        /* ==================== CINEMATIC GRID ==================== */
        .bc-cinematic-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 16px;
        }
        
        .bc-cinematic {
            position: relative;
            aspect-ratio: 16/9;
            background: #1a1a1a;
            border: 1px solid rgba(255,255,255,0.08);
            border-radius: 12px;
            overflow: hidden;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .bc-cinematic:hover {
            border-color: #8b5cf6;
            transform: translateY(-4px);
            box-shadow: 0 10px 40px rgba(139,92,246,0.2);
        }
        
        .bc-cinematic__preview {
            position: absolute;
            inset: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 48px;
        }
        
        .bc-cinematic__label {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            padding: 12px;
            background: linear-gradient(transparent, rgba(0,0,0,0.8));
            font-size: 13px;
            font-weight: 600;
            color: white;
        }
        
        /* Mini cinematic for ambient grid */
        .bc-cinematic--mini {
            aspect-ratio: 1;
            border-radius: 8px;
            min-height: 40px;
        }
        
        .bc-cinematic--mini .bc-cinematic__preview {
            font-size: 20px;
        }
        
        .bc-cinematic--mini:hover {
            transform: translateY(-2px);
        }
        
        .bc-cinematic--mini.selected {
            border-color: #8b5cf6;
            background: rgba(139,92,246,0.2);
        }
        
        /* ==================== ACTIVE POLL ==================== */
        .bc-active {
            background: rgba(139,92,246,0.1);
            border: 1px solid rgba(139,92,246,0.3);
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 24px;
        }
        
        .bc-active__header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
            flex-wrap: wrap;
            gap: 12px;
        }
        
        .bc-active__badge {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 6px 12px;
            background: #8b5cf6;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            color: white;
        }
        
        .bc-active__badge::before {
            content: '';
            width: 8px;
            height: 8px;
            background: white;
            border-radius: 50%;
            animation: pulse 1.5s infinite;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        
        .bc-active__content {
            font-size: 16px;
            color: white;
            margin-bottom: 16px;
        }
        
        .bc-active__results {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        
        .bc-active__result {
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .bc-active__result-label {
            min-width: 80px;
            font-size: 14px;
            color: white;
        }
        
        .bc-active__result-bar {
            flex: 1;
            height: 32px;
            background: rgba(255,255,255,0.1);
            border-radius: 8px;
            overflow: hidden;
            position: relative;
        }
        
        .bc-active__result-fill {
            height: 100%;
            background: linear-gradient(90deg, #8b5cf6, #a78bfa);
            transition: width 0.5s ease;
        }
        
        .bc-active__result-count {
            position: absolute;
            right: 12px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 13px;
            font-weight: 600;
            color: white;
        }
        
        /* ==================== EMPTY STATE ==================== */
        .bc-empty {
            text-align: center;
            padding: 60px 20px;
            color: rgba(255,255,255,0.5);
        }
        
        .bc-empty svg {
            width: 64px;
            height: 64px;
            opacity: 0.3;
            margin-bottom: 16px;
        }
        
        .bc-empty__title {
            font-size: 16px;
            font-weight: 600;
            color: white;
            margin-bottom: 8px;
        }
        
        /* ==================== HISTORY ==================== */
        .bc-history {
            max-height: 500px;
            overflow-y: auto;
        }
        
        .bc-history-item {
            display: flex;
            align-items: flex-start;
            gap: 14px;
            padding: 16px;
            border-bottom: 1px solid rgba(255,255,255,0.05);
        }
        
        .bc-history-item:last-child {
            border-bottom: none;
        }
        
        /* ==================== RESPONSIVE ==================== */
        @media (max-width: 768px) {
            .broadcast-page {
                padding: 16px;
            }
            
            .broadcast-tabs {
                padding: 3px;
            }
            
            .broadcast-tab {
                padding: 9px 12px;
                font-size: 12px;
            }
            
            .broadcast-tab span {
                display: none;
            }
        }
        
        /* ==================== SUB-TABS ==================== */
        .bc-subtabs {
            display: flex;
            gap: 6px;
            margin-bottom: 24px;
            flex-wrap: wrap;
        }
        .bc-subtab {
            display: inline-flex;
            align-items: center;
            gap: 7px;
            padding: 9px 16px;
            background: rgba(255,255,255,0.04);
            border: 1px solid rgba(255,255,255,0.07);
            border-radius: 9px;
            color: rgba(255,255,255,0.5);
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }
        .bc-subtab svg { width: 15px; height: 15px; flex-shrink: 0; }
        .bc-subtab:hover { background: rgba(255,255,255,0.08); color: rgba(255,255,255,0.9); }
        .bc-subtab.active { background: rgba(139,92,246,0.15); border-color: rgba(139,92,246,0.3); color: #c4b5fd; }
        .bc-subtab.active svg { color: #a78bfa; }
        .bc-subpanel { display: none; }
        .bc-subpanel.active { display: block; }
        
        /* ==================== PLAYER MANAGEMENT ==================== */
        .player-management-list { max-height: 600px; overflow-y: auto; }
        .player-management-item {
            display: flex;
            align-items: center;
            gap: 16px;
            padding: 16px 20px;
            border-bottom: 1px solid rgba(255,255,255,0.05);
            transition: background 0.2s;
        }
        .player-management-item:hover { background: rgba(255,255,255,0.02); }
        .player-management-item__avatar {
            width: 48px; height: 48px;
            border-radius: 12px;
            display: flex; align-items: center; justify-content: center;
            font-size: 20px; font-weight: 700; color: white;
            position: relative;
        }
        .player-management-item__status {
            position: absolute; bottom: -2px; right: -2px;
            width: 14px; height: 14px;
            border-radius: 50%;
            border: 2px solid #111;
        }
        .player-management-item__status--online { background: #22c55e; }
        .player-management-item__status--offline { background: #6b7280; }
        .player-management-item__status--paused { background: #f59e0b; }
        .player-management-item__info { flex: 1; min-width: 0; }
        .player-management-item__name {
            font-size: 15px; font-weight: 600; color: white;
            display: flex; align-items: center; gap: 8px;
        }
        .player-management-item__role {
            font-size: 10px; padding: 2px 8px;
            border-radius: 4px; font-weight: 600;
        }
        .player-management-item__role--gm { background: rgba(251,191,36,0.2); color: #fbbf24; }
        .player-management-item__role--cogm { background: rgba(139,92,246,0.2); color: #a78bfa; }
        .player-management-item__role--player { background: rgba(255,255,255,0.1); color: rgba(255,255,255,0.6); }
        .player-management-item__meta { font-size: 12px; color: rgba(255,255,255,0.4); margin-top: 2px; }
        .player-management-item__actions { display: flex; gap: 6px; }
        .player-management-item__btn {
            width: 32px; height: 32px;
            display: flex; align-items: center; justify-content: center;
            background: rgba(255,255,255,0.05);
            border: none; border-radius: 6px;
            color: rgba(255,255,255,0.5);
            cursor: pointer; font-size: 14px;
            transition: all 0.2s;
        }
        .player-management-item__btn:hover { background: rgba(255,255,255,0.1); color: white; }
        .player-management-item__btn--danger:hover { background: rgba(239,68,68,0.2); color: #ef4444; }
        .player-management-item__btn--warning:hover { background: rgba(251,191,36,0.2); color: #fbbf24; }
        
        /* ==================== CHARACTER GRID ==================== */
        .character-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
            gap: 20px;
        }
        .character-card {
            background: #111;
            border: 1px solid rgba(255,255,255,0.08);
            border-radius: 16px;
            overflow: hidden;
            transition: all 0.2s;
        }
        .character-card:hover { border-color: rgba(139,92,246,0.3); transform: translateY(-2px); }
        .character-card__header {
            padding: 20px;
            display: flex;
            align-items: center;
            gap: 16px;
            border-bottom: 1px solid rgba(255,255,255,0.05);
        }
        .character-card__avatar {
            width: 64px; height: 64px;
            border-radius: 14px;
            display: flex; align-items: center; justify-content: center;
            font-size: 28px; font-weight: 700; color: white;
        }
        .character-card__info { flex: 1; min-width: 0; }
        .character-card__name { font-size: 18px; font-weight: 700; color: white; }
        .character-card__class { font-size: 13px; color: rgba(255,255,255,0.5); margin-top: 2px; }
        .character-card__owner { font-size: 12px; color: rgba(255,255,255,0.4); margin-top: 4px; display: flex; align-items: center; gap: 6px; }
        .character-card__owner-dot { width: 8px; height: 8px; border-radius: 50%; }
        .character-card__owner-dot--online { background: #22c55e; }
        .character-card__owner-dot--offline { background: #6b7280; }
        .character-card__body { padding: 20px; }
        .character-card__stats {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 12px;
            margin-bottom: 16px;
        }
        .character-card__stat {
            text-align: center;
            padding: 12px;
            background: rgba(255,255,255,0.03);
            border-radius: 10px;
        }
        .character-card__stat-value { font-size: 20px; font-weight: 700; color: white; }
        .character-card__stat-label { font-size: 11px; color: rgba(255,255,255,0.4); text-transform: uppercase; }
        .character-card__hp { margin-bottom: 16px; }
        .character-card__hp-header { display: flex; justify-content: space-between; font-size: 12px; margin-bottom: 6px; }
        .character-card__hp-bar { height: 10px; background: rgba(255,255,255,0.1); border-radius: 5px; overflow: hidden; }
        .character-card__hp-fill { height: 100%; border-radius: 5px; transition: width 0.3s; }
        .character-card__hp-fill--high { background: linear-gradient(90deg, #22c55e, #16a34a); }
        .character-card__hp-fill--mid { background: linear-gradient(90deg, #f59e0b, #d97706); }
        .character-card__hp-fill--low { background: linear-gradient(90deg, #ef4444, #dc2626); }
        .character-card__actions { display: flex; gap: 8px; margin-top: 16px; }
        .character-card__actions .bc-btn { flex: 1; }
        .character-card--empty {
            border-style: dashed;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 300px;
            color: rgba(255,255,255,0.3);
        }
        
        /* ==================== ACTIVITY LOG ==================== */
        .bc-log-filter {
            padding: 6px 12px;
            background: rgba(255,255,255,0.05);
            border: 1px solid rgba(255,255,255,0.08);
            border-radius: 6px;
            color: rgba(255,255,255,0.5);
            font-size: 12px;
            cursor: pointer;
            transition: all 0.2s;
        }
        .bc-log-filter:hover { background: rgba(255,255,255,0.08); color: white; }
        .bc-log-filter.active { background: #8b5cf6; border-color: #8b5cf6; color: white; }
        .activity-log-list { max-height: 600px; overflow-y: auto; }
        .activity-log-item {
            display: flex;
            gap: 14px;
            padding: 14px 20px;
            border-bottom: 1px solid rgba(255,255,255,0.03);
            transition: background 0.2s;
        }
        .activity-log-item:hover { background: rgba(255,255,255,0.02); }
        @keyframes logFadeIn {
            from { opacity: 0; transform: translateX(-10px); background: rgba(139,92,246,0.15); }
            to { opacity: 1; transform: translateX(0); background: transparent; }
        }
        .activity-log-item { animation: logFadeIn 0.4s ease; }
        .activity-log-item__time {
            font-size: 11px;
            color: rgba(255,255,255,0.3);
            min-width: 70px;
            font-family: monospace;
        }
        .activity-log-item__icon {
            width: 32px; height: 32px;
            border-radius: 8px;
            display: flex; align-items: center; justify-content: center;
            font-size: 16px;
            flex-shrink: 0;
        }
        .activity-log-item__icon--dice { background: rgba(139,92,246,0.2); }
        .activity-log-item__icon--chat { background: rgba(59,130,246,0.2); }
        .activity-log-item__icon--character { background: rgba(16,185,129,0.2); }
        .activity-log-item__icon--session { background: rgba(251,191,36,0.2); }
        .activity-log-item__icon--member { background: rgba(236,72,153,0.2); }
        .activity-log-item__icon--broadcast { background: rgba(239,68,68,0.2); }
        .activity-log-item__content { flex: 1; min-width: 0; }
        .activity-log-item__user { font-weight: 600; color: white; }
        .activity-log-item__action { color: rgba(255,255,255,0.6); }
        .activity-log-item__detail { font-size: 12px; color: rgba(255,255,255,0.4); margin-top: 4px; word-break: break-word; }
        
        /* ==================== SETTINGS ==================== */
        .setting-row {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 16px;
            background: rgba(255,255,255,0.02);
            border-radius: 10px;
            margin-bottom: 8px;
        }
        .setting-row__info { flex: 1; }
        .setting-row__title { font-weight: 600; color: white; font-size: 14px; }
        .setting-row__desc { font-size: 12px; color: rgba(255,255,255,0.4); margin-top: 2px; }
        .danger-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 16px;
            padding: 16px;
            background: rgba(239,68,68,0.05);
            border: 1px solid rgba(239,68,68,0.15);
            border-radius: 10px;
            margin-bottom: 12px;
        }
        .danger-item__info h4 { margin: 0 0 2px 0; color: white; font-size: 14px; }
        .danger-item__info p { margin: 0; font-size: 12px; color: rgba(255,255,255,0.5); }
        
        /* ==================== CHARACTER SHEET MODAL ==================== */
        .character-sheet-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.8);
            z-index: 10000;
            align-items: center;
            justify-content: center;
            backdrop-filter: blur(4px);
        }
        .character-sheet-modal.active {
            display: flex;
        }
        .character-sheet-modal__content {
            width: 90%;
            max-width: 1200px;
            height: 85vh;
            background: #1a1a1a;
            border-radius: 16px;
            border: 1px solid rgba(139,92,246,0.3);
            overflow: hidden;
            display: flex;
            flex-direction: column;
            box-shadow: 0 25px 50px -12px rgba(0,0,0,0.5);
        }
        .character-sheet-modal__header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 16px 20px;
            background: rgba(139,92,246,0.1);
            border-bottom: 1px solid rgba(139,92,246,0.2);
        }
        .character-sheet-modal__header span {
            font-size: 16px;
            font-weight: 600;
            color: white;
        }
        .character-sheet-modal__close {
            width: 36px;
            height: 36px;
            border: none;
            background: rgba(255,255,255,0.1);
            border-radius: 8px;
            color: white;
            font-size: 24px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background 0.2s;
        }
        .character-sheet-modal__close:hover {
            background: rgba(239,68,68,0.3);
        }
        #characterSheetFrame {
            flex: 1;
            width: 100%;
            border: none;
            background: #0a0a0a;
        }

        /* ══ Tools Panel ══ */
        .gm-quicklinks {
            display: grid; grid-template-columns: repeat(6, 1fr); gap: 8px;
        }
        .gm-quicklink {
            display: flex; flex-direction: column; align-items: center; gap: 6px;
            padding: 14px 8px; border-radius: 6px;
            background: rgba(255,255,255,0.03); border: 1px solid rgba(255,255,255,0.06);
            color: rgba(255,255,255,0.5); font-size: 10px; font-weight: 600;
            text-decoration: none; text-transform: uppercase; letter-spacing: 0.5px;
            transition: all 0.2s; cursor: pointer;
        }
        .gm-quicklink:hover { background: rgba(139,92,246,0.1); border-color: rgba(139,92,246,0.3); color: #a78bfa; }
        .gm-quicklink svg { width: 22px; height: 22px; }

        .gm-chat-feed {
            max-height: 320px; overflow-y: auto; padding: 8px 12px;
            display: flex; flex-direction: column; gap: 4px;
            font-size: 12px;
        }
        .gm-chat-msg { display: flex; gap: 6px; padding: 4px 0; border-bottom: 1px solid rgba(255,255,255,0.03); }
        .gm-chat-msg__name { color: #a78bfa; font-weight: 600; flex-shrink: 0; min-width: 80px; }
        .gm-chat-msg__text { color: rgba(255,255,255,0.7); word-break: break-word; }
        .gm-chat-msg__time { color: rgba(255,255,255,0.2); font-size: 10px; flex-shrink: 0; margin-left: auto; }
        .gm-chat-msg--gm .gm-chat-msg__name { color: #d4a844; }
        .gm-chat-msg--whisper { opacity: 0.5; font-style: italic; }
        .gm-chat-msg--system { color: rgba(255,255,255,0.3); font-style: italic; }
        .gm-chat-empty { padding: 30px; text-align: center; color: rgba(255,255,255,0.3); font-size: 12px; }
        .gm-chat-input-row { display: flex; gap: 8px; padding: 8px 12px; border-top: 1px solid rgba(255,255,255,0.06); }

        .gm-dice-result {
            text-align: center; padding: 16px; margin-bottom: 12px;
            background: rgba(139,92,246,0.05); border: 1px solid rgba(139,92,246,0.15);
            border-radius: 8px;
        }
        .gm-dice-result__value { font-size: 36px; font-weight: 900; color: white; font-family: 'Cinzel', serif; }
        .gm-dice-result__detail { font-size: 11px; color: rgba(255,255,255,0.4); margin-top: 4px; }
        .gm-dice-buttons { display: flex; gap: 6px; flex-wrap: wrap; margin-bottom: 10px; }
        .gm-dice-btn {
            flex: 1; min-width: 50px; padding: 10px 6px;
            background: rgba(255,255,255,0.04); border: 1px solid rgba(255,255,255,0.1);
            border-radius: 6px; color: rgba(255,255,255,0.7); font-size: 12px; font-weight: 700;
            cursor: pointer; transition: all 0.15s; text-align: center;
        }
        .gm-dice-btn:hover { background: rgba(139,92,246,0.15); border-color: rgba(139,92,246,0.4); color: #a78bfa; }
        .gm-dice-btn--d20 { background: rgba(139,92,246,0.1); border-color: rgba(139,92,246,0.3); color: #a78bfa; }
        .gm-dice-custom { display: flex; gap: 8px; margin-top: 8px; }
        .gm-dice-log { max-height: 120px; overflow-y: auto; margin-top: 10px; font-size: 11px; color: rgba(255,255,255,0.35); border-top: 1px solid rgba(255,255,255,0.05); padding-top: 8px; }
        .gm-dice-log div { padding: 2px 0; }
        .gm-dice-log .crit { color: #22c55e; font-weight: 700; }
        .gm-dice-log .fail { color: #ef4444; font-weight: 700; }

        .gm-session-status { display: flex; align-items: center; gap: 6px; font-size: 11px; color: rgba(255,255,255,0.4); }
        .gm-session-dot { width: 8px; height: 8px; border-radius: 50%; }
        .gm-session-dot--online { background: #22c55e; box-shadow: 0 0 6px rgba(34,197,94,0.5); }
        .gm-session-dot--offline { background: #6b7280; }
        .gm-session-info { font-size: 12px; color: rgba(255,255,255,0.5); margin-bottom: 12px; }
        .gm-session-info strong { color: white; }
        .gm-session-actions { display: flex; gap: 8px; }

        .gm-feature-preview { padding: 20px; color: rgba(255,255,255,0.3); font-size: 12px; }
        .gm-feature-preview svg { width: 48px; height: 48px; margin-bottom: 8px; }
        .gm-feature-preview p { margin: 0; }

        @media (max-width: 768px) {
            .gm-quicklinks { grid-template-columns: repeat(3, 1fr); }
        }
    </style>
    <style>
        body:not(.auth-ready) .app { opacity: 0; pointer-events: none; }
        body:not(.auth-ready) .sheet-container { opacity: 0; pointer-events: none; }
        body:not(.auth-ready) main { opacity: 0; pointer-events: none; }
        body.auth-ready .app { opacity: 1; transition: opacity 0.15s ease; }
        body.auth-ready .sheet-container { opacity: 1; transition: opacity 0.15s ease; }
        body.auth-ready main { opacity: 1; transition: opacity 0.15s ease; }
    </style>
</head>
<body>
    <!-- Unified Layout Placeholders -->
    <div id="topnav-placeholder"></div>
    <div id="meganav-placeholder"></div>
    
    <div class="app">
        <main class="main main--hub">
            <div class="main__content">
                <div class="broadcast-page">
                    <div class="broadcast-container">
                    
                    <!-- Header -->
                    <div class="broadcast-header">
                        <h1 class="broadcast-header__title">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/>
                            </svg>
                            GM Kontrollzentrum
                        </h1>
                        <p class="broadcast-header__subtitle">Steuere dein Spiel – Raum: <code id="roomCodeDisplay" style="cursor:pointer;background:rgba(139,92,246,0.2);padding:2px 8px;border-radius:4px" onclick="BC.copyRoomCode()">---</code></p>
                    </div>
                    
                    <!-- Tab Navigation -->
                    <div class="broadcast-tabs">
                        <button class="broadcast-tab active" data-tab="broadcast" onclick="BC.switchTab('broadcast')">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polygon points="22 2 15 22 11 13 2 9 22 2"/></svg>
                            <span>Broadcast</span>
                        </button>
                        <button class="broadcast-tab" data-tab="poll" onclick="BC.switchTab('poll')">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 20V10M12 20V4M6 20v-6"/></svg>
                            <span>Umfragen</span>
                        </button>
                        <button class="broadcast-tab" data-tab="effects" onclick="BC.switchTab('effects')">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 2L2 7l10 5 10-5-10-5zM2 17l10 5 10-5M2 12l10 5 10-5"/></svg>
                            <span>Effekte</span>
                        </button>
                        <button class="broadcast-tab" data-tab="players" onclick="BC.switchTab('players')">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 0 0-3-3.87M16 3.13a4 4 0 0 1 0 7.75"/></svg>
                            <span>Spieler</span>
                        </button>
                        <button class="broadcast-tab" data-tab="characters" onclick="BC.switchTab('characters')">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>
                            <span>Charaktere</span>
                        </button>
                        <button class="broadcast-tab" data-tab="logs" onclick="BC.switchTab('logs')">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/></svg>
                            <span>Logs</span>
                        </button>
                        <button class="broadcast-tab" data-tab="settings" onclick="BC.switchTab('settings')">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"/></svg>
                            <span>Einstellungen</span>
                        </button>
                        <button class="broadcast-tab" data-tab="history" onclick="BC.switchTab('history')">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>
                            <span>GM Verlauf</span>
                        </button>
                        <button class="broadcast-tab" data-tab="tools" onclick="BC.switchTab('tools')">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14.7 6.3a1 1 0 000 1.4l1.6 1.6a1 1 0 001.4 0l3.77-3.77a6 6 0 01-7.94 7.94l-6.91 6.91a2.12 2.12 0 01-3-3l6.91-6.91a6 6 0 017.94-7.94l-3.76 3.76z"/></svg>
                            <span>Werkzeuge</span>
                        </button>
                    </div>
                    
                    <!-- ==================== BROADCAST PANEL ==================== -->
                    <div class="broadcast-panel active" id="panel-broadcast">
                        <div class="broadcast-grid">
                            <div class="bc-card">
                                <div class="bc-card__header">
                                    <div class="bc-card__title">
                                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polygon points="22 2 15 22 11 13 2 9 22 2"/></svg>
                                        Neue Nachricht
                                    </div>
                                </div>
                                <div class="bc-card__body">
                                    <!-- Broadcast Type -->
                                    <div class="bc-field">
                                        <label class="bc-label">Nachrichten-Typ</label>
                                        <div class="bc-types" id="broadcastTypes">
                                            <div class="bc-type bc-type--info active" data-type="info" onclick="BC.selectType('info')">
                                                <div class="bc-type__icon"><svg viewBox="0 0 24 24" fill="currentColor"><path d="M12 2c5.523 0 10 4.477 10 10s-4.477 10-10 10S2 17.523 2 12 6.477 2 12 2m0 9a1 1 0 0 0-1 1v4a1 1 0 0 0 2 0v-4a1 1 0 0 0-1-1m0-4a1 1 0 1 0 0 2 1 1 0 0 0 0-2"/></svg></div>
                                                <span class="bc-type__label">Info</span>
                                            </div>
                                            <div class="bc-type bc-type--warning" data-type="warning" onclick="BC.selectType('warning')">
                                                <div class="bc-type__icon"><svg viewBox="0 0 24 24" fill="currentColor"><path d="M12.865 3.01c-.385-.672-1.345-.672-1.73 0l-8.536 14.89C2.214 18.572 2.677 19.5 3.4 19.5h17.196c.723 0 1.186-.928.801-1.6zM12 16a1 1 0 1 1 0 2 1 1 0 0 1 0-2m0-7a1 1 0 0 1 1 1v3a1 1 0 0 1-2 0v-3a1 1 0 0 1 1-1"/></svg></div>
                                                <span class="bc-type__label">Warnung</span>
                                            </div>
                                            <div class="bc-type bc-type--danger" data-type="danger" onclick="BC.selectType('danger')">
                                                <div class="bc-type__icon"><svg viewBox="0 0 24 24" fill="currentColor"><path d="M12 2c5.523 0 10 4.477 10 10s-4.477 10-10 10S2 17.523 2 12 6.477 2 12 2m0 13a1 1 0 1 0 0 2 1 1 0 0 0 0-2m0-8a1 1 0 0 0-1 1v4a1 1 0 0 0 2 0V8a1 1 0 0 0-1-1"/></svg></div>
                                                <span class="bc-type__label">Gefahr</span>
                                            </div>
                                            <div class="bc-type bc-type--success" data-type="success" onclick="BC.selectType('success')">
                                                <div class="bc-type__icon"><svg viewBox="0 0 24 24" fill="currentColor"><path d="M12 2c5.523 0 10 4.477 10 10s-4.477 10-10 10S2 17.523 2 12 6.477 2 12 2m3.22 7.22a1 1 0 0 0-1.44 0L11 11.94l-1.28-1.28a1 1 0 0 0-1.44 1.42l2 2a1 1 0 0 0 1.44 0l3.5-3.5a1 1 0 0 0 0-1.42"/></svg></div>
                                                <span class="bc-type__label">Erfolg</span>
                                            </div>
                                            <div class="bc-type bc-type--epic" data-type="epic" onclick="BC.selectType('epic')">
                                                <div class="bc-type__icon"><svg viewBox="0 0 24 24" fill="currentColor"><path d="M13.414 2.1a2 2 0 0 0-2.828 0l-2.829 2.828a2 2 0 0 0 0 2.829L9.172 9.17 2.1 16.243a2 2 0 0 0 0 2.828l2.83 2.83a2 2 0 0 0 2.828 0L14.83 14.83l1.414 1.414a2 2 0 0 0 2.828 0l2.829-2.829a2 2 0 0 0 0-2.828z"/></svg></div>
                                                <span class="bc-type__label">Episch</span>
                                            </div>
                                            <div class="bc-type bc-type--mystery" data-type="mystery" onclick="BC.selectType('mystery')">
                                                <div class="bc-type__icon"><svg viewBox="0 0 24 24" fill="currentColor"><path d="M12 2c5.523 0 10 4.477 10 10s-4.477 10-10 10S2 17.523 2 12 6.477 2 12 2m0 4a4 4 0 0 0-4 4 1 1 0 0 0 2 0 2 2 0 1 1 3.58 1.23c-.766.57-1.58 1.5-1.58 2.77a1 1 0 0 0 2 0c0-.45.27-.86.78-1.24A4 4 0 0 0 12 6m0 11a1 1 0 1 0 0 2 1 1 0 0 0 0-2"/></svg></div>
                                                <span class="bc-type__label">Mysteriös</span>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <!-- Message -->
                                    <div class="bc-field">
                                        <label class="bc-label">Nachricht</label>
                                        <textarea class="bc-textarea" id="broadcastMessage" placeholder="Deine Nachricht an die Spieler..."></textarea>
                                    </div>
                                    
                                    <!-- Image Upload -->
                                    <div class="bc-field">
                                        <label class="bc-label">Bild (optional)</label>
                                        <div class="bc-image-upload" id="broadcastImageUpload" onclick="document.getElementById('broadcastImageInput').click()">
                                            <div class="bc-image-upload__placeholder" id="broadcastImagePlaceholder">
                                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><rect x="3" y="3" width="18" height="18" rx="2"/><circle cx="8.5" cy="8.5" r="1.5"/><path d="M21 15l-5-5L5 21"/></svg>
                                                <span>Bild hochladen oder hierher ziehen</span>
                                            </div>
                                            <img id="broadcastImagePreview" class="bc-image-upload__preview" style="display:none;">
                                            <input type="file" id="broadcastImageInput" accept="image/*" onchange="BC.handleImageUpload(event, 'broadcast')" style="display:none;">
                                        </div>
                                    </div>
                                    
                                    <!-- Sound -->
                                    <div class="bc-field">
                                        <label class="bc-label">Sound</label>
                                        <div class="bc-sounds" id="broadcastSounds">
                                            <div class="bc-sound active" data-sound="none" onclick="BC.selectSound('none')">
                                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M11 5L6 9H2v6h4l5 4zM23 9l-6 6M17 9l6 6"/></svg> Keiner
                                            </div>
                                            <div class="bc-sound" data-sound="notification" onclick="BC.selectSound('notification')">
                                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9M13.73 21a2 2 0 0 1-3.46 0"/></svg> Standard
                                                <button class="bc-sound__preview" onclick="event.stopPropagation(); BC.previewSound('notification')">▶</button>
                                            </div>
                                            <div class="bc-sound" data-sound="fanfare" onclick="BC.selectSound('fanfare')">
                                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/></svg> Fanfare
                                                <button class="bc-sound__preview" onclick="event.stopPropagation(); BC.previewSound('fanfare')">▶</button>
                                            </div>
                                            <div class="bc-sound" data-sound="dramatic" onclick="BC.selectSound('dramatic')">
                                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><path d="M8 14s1.5 2 4 2 4-2 4-2"/><line x1="9" y1="9" x2="9.01" y2="9"/><line x1="15" y1="9" x2="15.01" y2="9"/></svg> Dramatisch
                                                <button class="bc-sound__preview" onclick="event.stopPropagation(); BC.previewSound('dramatic')">▶</button>
                                            </div>
                                            <div class="bc-sound" data-sound="combat" onclick="BC.selectSound('combat')">
                                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14.5 2.1a2 2 0 0 0-2.83 0l-2.82 2.83a2 2 0 0 0 0 2.83L10.27 9.2 2.1 17.37a2 2 0 0 0 0 2.83l1.7 1.7a2 2 0 0 0 2.83 0l8.17-8.17 1.42 1.42a2 2 0 0 0 2.83 0l2.83-2.83a2 2 0 0 0 0-2.83z"/></svg> Kampf
                                                <button class="bc-sound__preview" onclick="event.stopPropagation(); BC.previewSound('combat')">▶</button>
                                            </div>
                                            <div class="bc-sound" data-sound="mystery" onclick="BC.selectSound('mystery')">
                                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/></svg> Mysteriös
                                                <button class="bc-sound__preview" onclick="event.stopPropagation(); BC.previewSound('mystery')">▶</button>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <!-- Target Players -->
                                    <div class="bc-field">
                                        <label class="bc-label">Empfänger</label>
                                        <div class="bc-players" id="broadcastTargets">
                                            <div class="bc-player selected" data-target="all" onclick="BC.toggleTarget('all')">
                                                <div class="bc-player__avatar" style="background: var(--accent);"><svg viewBox="0 0 24 24" fill="currentColor" style="width:18px;height:18px;"><path d="M9 11a4 4 0 1 1 0-8 4 4 0 0 1 0 8m8 0a3 3 0 1 0 0-6 3 3 0 0 0 0 6m-8 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4m8 0c-.29 0-.62.02-.97.05 1.16.84 1.97 1.97 1.97 3.45v2h6v-2c0-2.66-4.33-4-7-4"/></svg></div>
                                                <span class="bc-player__name">Alle Spieler</span>
                                                <div class="bc-player__check"></div>
                                            </div>
                                            <!-- Players loaded dynamically -->
                                        </div>
                                    </div>
                                    
                                    <button class="bc-btn bc-btn--full" onclick="BC.sendBroadcast()">
                                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polygon points="22 2 15 22 11 13 2 9 22 2"/></svg>
                                        Broadcast senden
                                    </button>
                                </div>
                            </div>
                            
                            <!-- Sidebar: Dice Request & Handouts -->
                            <div style="display: flex; flex-direction: column; gap: 24px;">
                                <!-- Dice Request -->
                                <div class="bc-card">
                                    <div class="bc-card__header">
                                        <div class="bc-card__title">
                                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="18" height="18" rx="2"/><circle cx="8.5" cy="8.5" r="1"/><circle cx="15.5" cy="8.5" r="1"/><circle cx="8.5" cy="15.5" r="1"/><circle cx="15.5" cy="15.5" r="1"/><circle cx="12" cy="12" r="1"/></svg>
                                            Würfelanforderung
                                        </div>
                                    </div>
                                    <div class="bc-card__body">
                                        <div class="bc-field">
                                            <label class="bc-label">Würfelart</label>
                                            <select class="bc-input" id="diceRequestType">
                                                <option value="d4">W4</option>
                                                <option value="d6">W6</option>
                                                <option value="d10">W10</option>
                                                <option value="d12">W12</option>
                                                <option value="d20" selected>W20 (Standard)</option>
                                                <option value="d100">W100</option>
                                                <option value="d20+mod">W20 + Modifikator</option>
                                                <option value="custom">Benutzerdefiniert</option>
                                            </select>
                                        </div>
                                        <div class="bc-field">
                                            <label class="bc-label">Beschreibung</label>
                                            <input type="text" class="bc-input" id="diceRequestDesc" placeholder="z.B. Wahrnehmungsprobe">
                                        </div>
                                        <div class="bc-field">
                                            <label class="bc-label">Empfänger</label>
                                            <div class="bc-players" id="diceRequestTargets">
                                                <div class="bc-player selected" data-target="all" onclick="BC.toggleDiceTarget('all')">
                                                    <div class="bc-player__avatar" style="background: #8b5cf6;"><svg viewBox="0 0 24 24" fill="currentColor" style="width:18px;height:18px;"><path d="M9 11a4 4 0 1 1 0-8 4 4 0 0 1 0 8m8 0a3 3 0 1 0 0-6 3 3 0 0 0 0 6m-8 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4m8 0c-.29 0-.62.02-.97.05 1.16.84 1.97 1.97 1.97 3.45v2h6v-2c0-2.66-4.33-4-7-4"/></svg></div>
                                                    <span class="bc-player__name">Alle Spieler</span>
                                                    <div class="bc-player__check"></div>
                                                </div>
                                            </div>
                                        </div>
                                        <button class="bc-btn bc-btn--full bc-btn--secondary" onclick="BC.sendDiceRequest()">
                                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width:16px;height:16px;"><rect x="3" y="3" width="18" height="18" rx="2"/><circle cx="8.5" cy="8.5" r="1"/><circle cx="15.5" cy="8.5" r="1"/><circle cx="8.5" cy="15.5" r="1"/><circle cx="15.5" cy="15.5" r="1"/><circle cx="12" cy="12" r="1"/></svg> Würfeln lassen
                                        </button>
                                    </div>
                                </div>
                                
                                <!-- Quick Handout -->
                                <div class="bc-card">
                                    <div class="bc-card__header">
                                        <div class="bc-card__title">
                                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/></svg>
                                            Schnelles Handout
                                        </div>
                                        <label class="bc-toggle">
                                            <input type="checkbox" id="handoutSound">
                                            <span class="bc-toggle__switch"></span>
                                            <span class="bc-toggle__label"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width:14px;height:14px;"><path d="M11 5L6 9H2v6h4l5 4z"/><path d="M19.07 4.93a10 10 0 0 1 0 14.14M15.54 8.46a5 5 0 0 1 0 7.07"/></svg></span>
                                        </label>
                                    </div>
                                    <div class="bc-card__body">
                                        <div class="bc-image-upload" id="handoutUpload" onclick="document.getElementById('handoutInput').click()">
                                            <div class="bc-image-upload__placeholder" id="handoutPlaceholder">
                                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/></svg>
                                                <span>Handout hochladen</span>
                                            </div>
                                            <img id="handoutPreview" class="bc-image-upload__preview" style="display:none;">
                                            <input type="file" id="handoutInput" accept="image/*" onchange="BC.previewHandout(event)" style="display:none;">
                                        </div>
                                        <button class="bc-btn bc-btn--full" style="margin-top: 12px;" onclick="BC.sendHandout()"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width:16px;height:16px;"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/></svg> Handout senden</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Reactions Section -->
                        <div class="bc-card" style="margin-top: 24px;">
                            <div class="bc-card__header">
                                <div class="bc-card__title">
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><path d="M8 14s1.5 2 4 2 4-2 4-2"/></svg>
                                    Schnelle Reaktionen
                                </div>
                                <label class="bc-toggle">
                                    <input type="checkbox" id="reactionSound">
                                    <span class="bc-toggle__switch"></span>
                                    <span class="bc-toggle__label"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width:14px;height:14px;"><path d="M11 5L6 9H2v6h4l5 4z"/><path d="M19.07 4.93a10 10 0 0 1 0 14.14M15.54 8.46a5 5 0 0 1 0 7.07"/></svg></span>
                                </label>
                            </div>
                            <div class="bc-card__body">
                                <div class="bc-reactions" style="grid-template-columns: repeat(10, 1fr); gap: 6px;">
                                    <div class="bc-reaction" onclick="BC.sendReaction('thumbsup', '👍')"><span class="bc-reaction__emoji">👍</span></div>
                                    <div class="bc-reaction" onclick="BC.sendReaction('thumbsdown', '👎')"><span class="bc-reaction__emoji">👎</span></div>
                                    <div class="bc-reaction" onclick="BC.sendReaction('fire', '🔥')"><span class="bc-reaction__emoji">🔥</span></div>
                                    <div class="bc-reaction" onclick="BC.sendReaction('skull', '💀')"><span class="bc-reaction__emoji">💀</span></div>
                                    <div class="bc-reaction" onclick="BC.sendReaction('laugh', '😂')"><span class="bc-reaction__emoji">😂</span></div>
                                    <div class="bc-reaction" onclick="BC.sendReaction('think', '🤔')"><span class="bc-reaction__emoji">🤔</span></div>
                                    <div class="bc-reaction" onclick="BC.sendReaction('crown', '👑')"><span class="bc-reaction__emoji">👑</span></div>
                                    <div class="bc-reaction" onclick="BC.sendReaction('heart', '❤️')"><span class="bc-reaction__emoji">❤️</span></div>
                                    <div class="bc-reaction" onclick="BC.sendReaction('star', '⭐')"><span class="bc-reaction__emoji">⭐</span></div>
                                    <div class="bc-reaction" onclick="BC.sendReaction('clap', '👏')"><span class="bc-reaction__emoji">👏</span></div>
                                    <div class="bc-reaction" onclick="BC.sendReaction('eyes', '👀')"><span class="bc-reaction__emoji">👀</span></div>
                                    <div class="bc-reaction" onclick="BC.sendReaction('question', '❓')"><span class="bc-reaction__emoji">❓</span></div>
                                    <div class="bc-reaction" onclick="BC.sendReaction('exclaim', '❗')"><span class="bc-reaction__emoji">❗</span></div>
                                    <div class="bc-reaction" onclick="BC.sendReaction('swords', '⚔️')"><span class="bc-reaction__emoji">⚔️</span></div>
                                    <div class="bc-reaction" onclick="BC.sendReaction('shield', '🛡️')"><span class="bc-reaction__emoji">🛡️</span></div>
                                    <div class="bc-reaction" onclick="BC.sendReaction('dice', '🎲')"><span class="bc-reaction__emoji">🎲</span></div>
                                    <div class="bc-reaction" onclick="BC.sendReaction('magic', '✨')"><span class="bc-reaction__emoji">✨</span></div>
                                    <div class="bc-reaction" onclick="BC.sendReaction('potion', '🧪')"><span class="bc-reaction__emoji">🧪</span></div>
                                    <div class="bc-reaction" onclick="BC.sendReaction('dragon', '🐉')"><span class="bc-reaction__emoji">🐉</span></div>
                                    <div class="bc-reaction" onclick="BC.sendReaction('wizard', '🧙')"><span class="bc-reaction__emoji">🧙</span></div>
                                </div>
                                
                                <!-- Custom Reaction -->
                                <div style="margin-top: 16px; padding-top: 16px; border-top: 1px solid rgba(255,255,255,0.08); display: flex; gap: 8px; align-items: center;">
                                    <div style="position: relative;">
                                        <button class="bc-btn bc-btn--secondary" id="emojiPickerBtn" onclick="BC.toggleEmojiPicker()" style="width: 44px; height: 44px; font-size: 20px; padding: 0;">
                                            <span id="selectedEmoji">🎉</span>
                                        </button>
                                        <div id="emojiPicker" style="display: none; position: absolute; bottom: 54px; left: 0; background: #1a1a1a; border: 1px solid rgba(255,255,255,0.1); border-radius: 12px; padding: 12px; width: 280px; max-height: 200px; overflow-y: auto; z-index: 100;">
                                            <div id="emojiPickerGrid" style="display: grid; grid-template-columns: repeat(7, 1fr); gap: 4px;"></div>
                                        </div>
                                    </div>
                                    <input type="text" class="bc-input" id="customReactionText" placeholder="Text..." style="flex: 1;">
                                    <label class="bc-toggle" title="Ohne Emoji">
                                        <input type="checkbox" id="reactionNoEmoji">
                                        <span class="bc-toggle__switch"></span>
                                    </label>
                                    <button class="bc-btn" onclick="BC.sendCustomReaction()">Senden</button>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Quick Tools Row -->
                        <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 16px; margin-top: 24px;">
                            <!-- Quick-Toast -->
                            <div class="bc-card">
                                <div class="bc-card__header">
                                    <div class="bc-card__title"><svg viewBox="0 0 24 24" fill="currentColor"><path d="M13 2L3 14h9l-1 8 10-12h-9l1-8z"/></svg>Quick-Toast</div>
                                </div>
                                <div class="bc-card__body" style="padding: 12px;">
                                    <div style="display: flex; gap: 8px; flex-wrap: wrap;">
                                        <button class="bc-btn bc-btn--small" onclick="BC.quickToast('☕ Kurze Pause!')">Pause</button>
                                        <button class="bc-btn bc-btn--small" onclick="BC.quickToast('🍕 Essen ist da!')">Essen</button>
                                        <button class="bc-btn bc-btn--small" onclick="BC.quickToast('✅ Weiter geht\'s!')">Weiter</button>
                                        <button class="bc-btn bc-btn--small" onclick="BC.quickToast('🔇 Bitte leise!')">Leise</button>
                                        <button class="bc-btn bc-btn--small" onclick="BC.quickToast('📱 AFK Check!')">AFK</button>
                                    </div>
                                    <div style="display: flex; gap: 8px; margin-top: 10px;">
                                        <input type="text" class="bc-input" id="customToastText" placeholder="Eigener Text..." style="flex: 1;">
                                        <button class="bc-btn" onclick="BC.sendCustomToast()">Senden</button>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Timer/Countdown -->
                            <div class="bc-card">
                                <div class="bc-card__header">
                                    <div class="bc-card__title"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>Timer</div>
                                    <button class="bc-btn bc-btn--small bc-btn--danger" onclick="BC.cancelTimer()" title="Timer abbrechen">✕</button>
                                </div>
                                <div class="bc-card__body" style="padding: 12px;">
                                    <div style="display: flex; gap: 8px; flex-wrap: wrap; margin-bottom: 10px;">
                                        <button class="bc-btn bc-btn--small" onclick="BC.startTimer(30)">30s</button>
                                        <button class="bc-btn bc-btn--small" onclick="BC.startTimer(60)">1min</button>
                                        <button class="bc-btn bc-btn--small" onclick="BC.startTimer(180)">3min</button>
                                        <button class="bc-btn bc-btn--small" onclick="BC.startTimer(300)">5min</button>
                                        <button class="bc-btn bc-btn--small" onclick="BC.startTimer(600)">10min</button>
                                    </div>
                                    <div style="display: flex; gap: 8px; align-items: center;">
                                        <input type="number" class="bc-input" id="customTimerSeconds" placeholder="Sek." min="5" max="3600" style="width: 70px;">
                                        <input type="text" class="bc-input" id="timerLabel" placeholder="Label (optional)" style="flex: 1;">
                                        <button class="bc-btn" onclick="BC.startCustomTimer()">Start</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Templates -->
                        <div class="bc-card" style="margin-top: 16px;">
                            <div class="bc-card__header">
                                <div class="bc-card__title"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2"/><rect x="8" y="2" width="8" height="4" rx="1" ry="1"/></svg>Templates</div>
                                <button class="bc-btn bc-btn--small bc-btn--secondary" onclick="BC.saveTemplate()">+ Speichern</button>
                            </div>
                            <div class="bc-card__body" style="padding: 12px;">
                                <div id="templateList" style="display: flex; gap: 8px; flex-wrap: wrap;">
                                    <span style="color: var(--text-muted); font-size: 13px;">Keine Templates gespeichert</span>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Player Status -->
                        <div class="bc-card" style="margin-top: 16px;">
                            <div class="bc-card__header">
                                <div class="bc-card__title"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 0 0-3-3.87M16 3.13a4 4 0 0 1 0 7.75"/></svg>Spieler-Status</div>
                                <button class="bc-btn bc-btn--small bc-btn--secondary" onclick="BC.requestStatusUpdate()"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width:14px;height:14px;"><polyline points="23 4 23 10 17 10"/><polyline points="1 20 1 14 7 14"/><path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"/></svg> Abfragen</button>
                            </div>
                            <div class="bc-card__body" style="padding: 12px;">
                                <div id="playerStatusList" class="bc-players" style="gap: 8px;">
                                    <!-- Player statuses loaded dynamically -->
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- ==================== POLL PANEL ==================== -->
                    <div class="broadcast-panel" id="panel-poll">
                        <div class="broadcast-grid">
                            <div>
                                <!-- Active Poll Display -->
                                <div class="bc-active" id="activePoll" style="display:none;">
                                    <div class="bc-active__header">
                                        <div class="bc-active__badge">
                                            <span>AKTIVE UMFRAGE</span>
                                            <span id="activePollCountdown" style="margin-left: 12px; color: #f59e0b; font-weight: 700;"></span>
                                        </div>
                                        <div style="display: flex; gap: 8px;">
                                            <button class="bc-btn bc-btn--small bc-btn--success" onclick="BC.resolvePoll()"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width:16px;height:16px;"><path d="M6 9H4.5a2.5 2.5 0 0 1 0-5H6m12 5h1.5a2.5 2.5 0 0 0 0-5H18M6 4h12v6a6 6 0 0 1-12 0V4z"/><path d="M8 21h8m-4-5v5"/></svg> Auflösen</button>
                                            <button class="bc-btn bc-btn--small bc-btn--secondary" onclick="BC.closePoll()">✕ Schließen</button>
                                        </div>
                                    </div>
                                    <div class="bc-active__content" id="activePollQuestion">-</div>
                                    <div class="bc-active__results" id="activePollResults"></div>
                                    <div id="activePollVoters" style="margin-top: 12px; font-size: 12px; color: rgba(255,255,255,0.5);"></div>
                                </div>
                                
                                <div class="bc-card">
                                    <div class="bc-card__header">
                                        <div class="bc-card__title">
                                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 20V10M12 20V4M6 20v-6"/></svg>
                                            Neue Umfrage
                                        </div>
                                    </div>
                                    <div class="bc-card__body">
                                        <!-- Question -->
                                        <div class="bc-field">
                                            <label class="bc-label">Frage</label>
                                            <input type="text" class="bc-input" id="pollQuestion" placeholder="Deine Frage an die Spieler...">
                                        </div>
                                        
                                        <!-- Quick Presets -->
                                        <div class="bc-field">
                                            <label class="bc-label">Schnellauswahl</label>
                                            <div style="display: flex; gap: 8px; flex-wrap: wrap;">
                                                <button class="bc-countdown-btn" onclick="BC.setPollPreset('yesno')">Ja / Nein</button>
                                                <button class="bc-countdown-btn" onclick="BC.setPollPreset('abc')">A / B / C</button>
                                                <button class="bc-countdown-btn" onclick="BC.setPollPreset('numbers')">1 - 5</button>
                                                <button class="bc-countdown-btn" onclick="BC.setPollPreset('werewolf')">"Wer war's?"</button>
                                            </div>
                                        </div>
                                        
                                        <!-- Poll Image -->
                                        <div class="bc-field">
                                            <label class="bc-label">Bild (optional)</label>
                                            <div class="bc-image-upload" id="pollImageUpload" onclick="document.getElementById('pollImageInput').click()" style="padding: 20px;">
                                                <div class="bc-image-upload__placeholder" id="pollImagePlaceholder">
                                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" style="width:32px;height:32px;"><rect x="3" y="3" width="18" height="18" rx="2"/><circle cx="8.5" cy="8.5" r="1.5"/><path d="M21 15l-5-5L5 21"/></svg>
                                                    <span>Bild hinzufügen</span>
                                                </div>
                                                <img id="pollImagePreview" class="bc-image-upload__preview" style="display:none;">
                                                <input type="file" id="pollImageInput" accept="image/*" onchange="BC.handleImageUpload(event, 'poll')" style="display:none;">
                                            </div>
                                        </div>
                                        
                                        <!-- Options -->
                                        <div class="bc-field">
                                            <label class="bc-label">Antwortmöglichkeiten</label>
                                            <div class="bc-poll-options" id="pollOptions">
                                                <div class="bc-poll-option" data-index="0">
                                                    <button class="bc-poll-option__emoji" onclick="BC.openEmojiPicker(0)">➊</button>
                                                    <input type="text" class="bc-input bc-poll-option__input" placeholder="Option 1">
                                                </div>
                                                <div class="bc-poll-option" data-index="1">
                                                    <button class="bc-poll-option__emoji" onclick="BC.openEmojiPicker(1)">➋</button>
                                                    <input type="text" class="bc-input bc-poll-option__input" placeholder="Option 2">
                                                </div>
                                            </div>
                                            <button class="bc-btn bc-btn--secondary bc-btn--small" style="margin-top: 12px;" onclick="BC.addPollOption()">
                                                + Option hinzufügen
                                            </button>
                                        </div>
                                        
                                        <!-- Poll Settings -->
                                        <div class="bc-poll-settings">
                                            <label class="bc-toggle">
                                                <input type="checkbox" id="pollCountdown">
                                                <div class="bc-toggle__switch"></div>
                                                <span class="bc-toggle__label"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width:13px;height:13px;display:inline;vertical-align:middle;margin-right:3px;"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg> Mit Countdown</span>
                                            </label>
                                            <label class="bc-toggle">
                                                <input type="checkbox" id="pollMultiple">
                                                <div class="bc-toggle__switch"></div>
                                                <span class="bc-toggle__label">☑️ Mehrfachauswahl</span>
                                            </label>
                                            <label class="bc-toggle">
                                                <input type="checkbox" id="pollBlind">
                                                <div class="bc-toggle__switch"></div>
                                                <span class="bc-toggle__label">🙈 Blind Vote</span>
                                            </label>
                                            <label class="bc-toggle">
                                                <input type="checkbox" id="pollShowVoters">
                                                <div class="bc-toggle__switch"></div>
                                                <span class="bc-toggle__label"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width:13px;height:13px;display:inline;vertical-align:middle;margin-right:3px;"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/></svg> Voter anzeigen</span>
                                            </label>
                                            <label class="bc-toggle">
                                                <input type="checkbox" id="pollNoEmojis">
                                                <div class="bc-toggle__switch"></div>
                                                <span class="bc-toggle__label">Ohne Emoji</span>
                                            </label>
                                            <label class="bc-toggle">
                                                <input type="checkbox" id="pollSound">
                                                <div class="bc-toggle__switch"></div>
                                                <span class="bc-toggle__label"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width:13px;height:13px;display:inline;vertical-align:middle;margin-right:3px;"><path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"/><path d="M13.73 21a2 2 0 0 1-3.46 0"/></svg> Mit Sound</span>
                                            </label>
                                        </div>
                                        
                                        <!-- Countdown Time -->
                                        <div class="bc-field" id="countdownField" style="display:none; margin-top: 20px;">
                                            <label class="bc-label">Countdown Zeit</label>
                                            <div class="bc-countdown-selector">
                                                <button class="bc-countdown-btn" data-time="15" onclick="BC.setCountdown(15)">15s</button>
                                                <button class="bc-countdown-btn active" data-time="30" onclick="BC.setCountdown(30)">30s</button>
                                                <button class="bc-countdown-btn" data-time="60" onclick="BC.setCountdown(60)">1 min</button>
                                                <button class="bc-countdown-btn" data-time="120" onclick="BC.setCountdown(120)">2 min</button>
                                                <button class="bc-countdown-btn" data-time="300" onclick="BC.setCountdown(300)">5 min</button>
                                            </div>
                                        </div>
                                        
                                        <button class="bc-btn bc-btn--full" style="margin-top: 24px;" onclick="BC.startPoll()">
                                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 20V10M12 20V4M6 20v-6"/></svg>
                                            Umfrage starten
                                        </button>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Poll History -->
                            <div class="bc-card">
                                <div class="bc-card__header">
                                    <div class="bc-card__title">
                                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>
                                        Umfrage-Verlauf
                                    </div>
                                </div>
                                <div class="bc-card__body" style="padding: 0;">
                                    <div class="bc-history" id="pollHistory">
                                        <div class="bc-empty">
                                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M18 20V10M12 20V4M6 20v-6"/></svg>
                                            <div class="bc-empty__title">Keine Umfragen</div>
                                            <p>Vergangene Umfragen erscheinen hier</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <!-- ==================== EFFECTS PANEL (Spotlight + Combat + Cinematic) ==================== -->
                    <div class="broadcast-panel" id="panel-effects">
                        <!-- Effects Sub-Navigation -->
                        <div class="bc-subtabs">
                            <button class="bc-subtab active" data-sub="spotlight" onclick="BC.switchSubTab('spotlight')"><svg viewBox="0 0 24 24" fill="currentColor"><path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14l-5-4.87 6.91-1.01z"/></svg> Spotlight</button>
                            <button class="bc-subtab" data-sub="combat" onclick="BC.switchSubTab('combat')"><svg viewBox="0 0 24 24" fill="currentColor"><path d="M14.5 2.1a2 2 0 0 0-2.83 0l-2.82 2.83a2 2 0 0 0 0 2.83L10.27 9.2 2.1 17.37a2 2 0 0 0 0 2.83l1.7 1.7a2 2 0 0 0 2.83 0l8.17-8.17 1.42 1.42a2 2 0 0 0 2.83 0l2.83-2.83a2 2 0 0 0 0-2.83z"/></svg> Kampf</button>
                            <button class="bc-subtab" data-sub="cinematic" onclick="BC.switchSubTab('cinematic')"><svg viewBox="0 0 24 24" fill="currentColor"><path d="M19.82 2H4.18A2.18 2.18 0 0 0 2 4.18v15.64A2.18 2.18 0 0 0 4.18 22h15.64A2.18 2.18 0 0 0 22 19.82V4.18A2.18 2.18 0 0 0 19.82 2M7 2v20M17 2v20M2 12h20M2 7h5M2 17h5M17 17h5M17 7h5"/></svg> Cinematic</button>
                            <button class="bc-subtab" data-sub="ambient" onclick="BC.switchSubTab('ambient')"><svg viewBox="0 0 24 24" fill="currentColor"><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/></svg> Atmosphäre</button>
                            <button class="bc-subtab" data-sub="sounds" onclick="BC.switchSubTab('sounds')"><svg viewBox="0 0 24 24" fill="currentColor"><path d="M11 5L6 9H2v6h4l5 4V5zM19.07 4.93a10 10 0 0 1 0 14.14M15.54 8.46a5 5 0 0 1 0 7.07"/></svg> Sounds</button>
                        </div>
                        
                        <!-- Spotlight Sub-Panel -->
                        <div class="bc-subpanel active" id="subpanel-spotlight">
                            <div class="broadcast-grid">
                                <div class="bc-card">
                                    <div class="bc-card__header"><div class="bc-card__title"><svg viewBox="0 0 24 24" fill="currentColor"><path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14l-5-4.87 6.91-1.01z"/></svg>Spieler-Spotlight</div></div>
                                    <div class="bc-card__body">
                                        <p style="color:rgba(255,255,255,0.5);margin-bottom:20px;">Setze einen Spieler in den Fokus - alle anderen sehen eine dramatische Ankündigung.</p>
                                        <div class="bc-field"><label class="bc-label">Spieler</label><div class="bc-players" id="spotlightPlayers"></div></div>
                                        <div class="bc-field"><label class="bc-label">Nachricht (optional)</label><input type="text" class="bc-input" id="spotlightMessage" placeholder="z.B. Du bist dran!"></div>
                                        <button class="bc-btn bc-btn--full" onclick="BC.sendSpotlight()"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width:16px;height:16px;"><path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14l-5-4.87 6.91-1.01z"/></svg> Spotlight aktivieren</button>
                                    </div>
                                </div>
                                <div class="bc-card">
                                    <div class="bc-card__header"><div class="bc-card__title"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="11" width="18" height="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/></svg>Geheime Nachricht</div></div>
                                    <div class="bc-card__body">
                                        <div class="bc-field"><label class="bc-label">Empfänger</label><div class="bc-players" id="secretPlayers"></div></div>
                                        <div class="bc-field"><label class="bc-label">Nachricht</label><textarea class="bc-textarea" id="secretMessage" placeholder="Nur dieser Spieler sieht das..."></textarea></div>
                                        <button class="bc-btn bc-btn--full bc-btn--secondary" onclick="BC.sendSecretMessage()"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width:16px;height:16px;"><rect x="3" y="11" width="18" height="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/></svg> Geheim senden</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Combat Sub-Panel -->
                        <div class="bc-subpanel" id="subpanel-combat">
                            <div class="broadcast-grid">
                                <div class="bc-card">
                                    <div class="bc-card__header"><div class="bc-card__title"><svg viewBox="0 0 24 24" fill="currentColor"><path d="M14.5 2.1a2 2 0 0 0-2.83 0l-2.82 2.83a2 2 0 0 0 0 2.83L10.27 9.2 2.1 17.37a2 2 0 0 0 0 2.83l1.7 1.7a2 2 0 0 0 2.83 0l8.17-8.17 1.42 1.42a2 2 0 0 0 2.83 0l2.83-2.83a2 2 0 0 0 0-2.83z"/></svg>Kampf beginnt!</div></div>
                                    <div class="bc-card__body">
                                        <div class="bc-field"><input type="text" class="bc-input" id="combatTitle" placeholder="Titel" value="Ein Kampf beginnt!"></div>
                                        <div class="bc-field"><input type="text" class="bc-input" id="combatSubtitle" placeholder="Untertitel" value="Macht euch bereit."></div>
                                        <div class="bc-field" style="display:flex;align-items:center;gap:8px;">
                                            <input type="checkbox" id="combatSound" style="width:18px;height:18px;">
                                            <label for="combatSound" style="margin:0;cursor:pointer;"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width:14px;height:14px;display:inline;vertical-align:middle;margin-right:4px;"><path d="M11 5L6 9H2v6h4l5 4z"/><path d="M19.07 4.93a10 10 0 0 1 0 14.14M15.54 8.46a5 5 0 0 1 0 7.07"/></svg> Mit Sound</label>
                                        </div>
                                        <div class="bc-field" style="display:flex;align-items:center;gap:8px;">
                                            <input type="checkbox" id="combatParticles" checked style="width:18px;height:18px;">
                                            <label for="combatParticles" style="margin:0;cursor:pointer;"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width:14px;height:14px;display:inline;vertical-align:middle;margin-right:4px;"><path d="M12 3v4m0 14v-4m9-5h-4M7 12H3m14.657-5.657l-2.828 2.828M9.172 14.828l-2.829 2.829m11.314 0l-2.828-2.828M9.172 9.172L6.343 6.343"/></svg> Mit Partikel-Effekt</label>
                                        </div>
                                        <button class="bc-btn bc-btn--full bc-btn--danger" onclick="BC.sendCombatStart()"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width:16px;height:16px;"><path d="M14.5 2.1a2 2 0 0 0-2.83 0l-2.82 2.83a2 2 0 0 0 0 2.83L10.27 9.2 2.1 17.37a2 2 0 0 0 0 2.83l1.7 1.7a2 2 0 0 0 2.83 0l8.17-8.17 1.42 1.42a2 2 0 0 0 2.83 0l2.83-2.83a2 2 0 0 0 0-2.83z"/></svg> Kampf starten!</button>
                                    </div>
                                </div>
                                <div class="bc-card">
                                    <div class="bc-card__header"><div class="bc-card__title"><svg viewBox="0 0 24 24" fill="currentColor"><path d="M12 2a9 9 0 0 0-9 9c0 3.6 2.4 6.6 5.5 7.7.3-.8.5-1.7.5-2.7 0-1-.5-2-1-3 0 0 1-1 4-1s4 1 4 1c-.5 1-1 2-1 3 0 1 .2 1.9.5 2.7A9 9 0 0 0 12 2m-3 9a1 1 0 1 1 0-2 1 1 0 0 1 0 2m6 0a1 1 0 1 1 0-2 1 1 0 0 1 0 2"/></svg>Boss-Einführung</div></div>
                                    <div class="bc-card__body">
                                        <div class="bc-field">
                                            <div class="bc-image-upload" id="bossImageUpload" onclick="document.getElementById('bossImageInput').click()">
                                                <div class="bc-image-upload__placeholder"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" style="width:24px;height:24px;"><rect x="3" y="3" width="18" height="18" rx="2"/><path d="M21 15l-5-5L5 21"/></svg><span>Boss-Bild</span></div>
                                                <img id="bossImagePreview" class="bc-image-upload__preview" style="display:none;">
                                                <input type="file" id="bossImageInput" accept="image/*" onchange="BC.handleImageUpload(event, 'boss')" style="display:none;">
                                            </div>
                                        </div>
                                        <div class="bc-field"><input type="text" class="bc-input" id="bossName" placeholder="Name"></div>
                                        <div class="bc-field"><input type="text" class="bc-input" id="bossTitle" placeholder="Titel"></div>
                                        <button class="bc-btn bc-btn--full bc-btn--danger" onclick="BC.sendBossIntro()"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width:16px;height:16px;"><circle cx="12" cy="12" r="10"/><path d="M8 14s1.5 2 4 2 4-2 4-2"/><line x1="9" y1="9" x2="9.01" y2="9"/><line x1="15" y1="9" x2="15.01" y2="9"/></svg> Boss einführen!</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Cinematic Sub-Panel -->
                        <div class="bc-subpanel" id="subpanel-cinematic">
                            <div class="broadcast-grid">
                                <div class="bc-card" id="sceneCard">
                                    <div class="bc-card__header"><div class="bc-card__title"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="2" y="2" width="20" height="20" rx="2.18" ry="2.18"/><line x1="7" y1="2" x2="7" y2="22"/><line x1="17" y1="2" x2="17" y2="22"/><line x1="2" y1="12" x2="22" y2="12"/><line x1="2" y1="7" x2="7" y2="7"/><line x1="2" y1="17" x2="7" y2="17"/><line x1="17" y1="17" x2="22" y2="17"/><line x1="17" y1="7" x2="22" y2="7"/></svg>Szenen-Übergang</div></div>
                                    <div class="bc-card__body">
                                        <div class="bc-field"><input type="text" class="bc-input" id="sceneText" placeholder="z.B. 3 Tage später..."></div>
                                        <div style="display:flex;gap:6px;flex-wrap:wrap;margin-bottom:12px;" id="sceneStyleBtns">
                                            <button class="bc-countdown-btn active" data-style="fade" onclick="BC.setSceneStyle('fade')">Fade</button>
                                            <button class="bc-countdown-btn" data-style="slide" onclick="BC.setSceneStyle('slide')">Slide</button>
                                            <button class="bc-countdown-btn" data-style="zoom" onclick="BC.setSceneStyle('zoom')">Zoom</button>
                                            <button class="bc-countdown-btn" data-style="blur" onclick="BC.setSceneStyle('blur')">Blur</button>
                                            <button class="bc-countdown-btn" data-style="glitch" onclick="BC.setSceneStyle('glitch')">Glitch</button>
                                            <button class="bc-countdown-btn" data-style="shatter" onclick="BC.setSceneStyle('shatter')">Shatter</button>
                                            <button class="bc-countdown-btn" data-style="vortex" onclick="BC.setSceneStyle('vortex')">Vortex</button>
                                            <button class="bc-countdown-btn" data-style="flames" onclick="BC.setSceneStyle('flames')">Flames</button>
                                            <button class="bc-countdown-btn" data-style="lightning" onclick="BC.setSceneStyle('lightning')">Lightning</button>
                                            <button class="bc-countdown-btn" data-style="portal" onclick="BC.setSceneStyle('portal')">Portal</button>
                                        </div>
                                        <button class="bc-btn bc-btn--full" onclick="BC.sendSceneTransition()"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width:16px;height:16px;"><polygon points="5 3 19 12 5 21 5 3"/></svg> Abspielen</button>
                                    </div>
                                </div>
                                <div class="bc-card">
                                    <div class="bc-card__header"><div class="bc-card__title">📍 Location Banner</div></div>
                                    <div class="bc-card__body">
                                        <div class="bc-field">
                                            <div class="bc-image-upload" id="locationImageUpload" onclick="document.getElementById('locationImageInput').click()">
                                                <div class="bc-image-upload__placeholder"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" style="width:24px;height:24px;"><rect x="3" y="3" width="18" height="18" rx="2"/><path d="M21 15l-5-5L5 21"/></svg><span>Bild (optional)</span></div>
                                                <img id="locationImagePreview" class="bc-image-upload__preview" style="display:none;">
                                                <input type="file" id="locationImageInput" accept="image/*" onchange="BC.handleImageUpload(event, 'location')" style="display:none;">
                                            </div>
                                        </div>
                                        <div class="bc-field"><input type="text" class="bc-input" id="locationName" placeholder="Ortsname"></div>
                                        <div class="bc-field"><input type="text" class="bc-input" id="locationSubtitle" placeholder="Beschreibung (optional)"></div>
                                        <button class="bc-btn bc-btn--full" onclick="BC.sendLocationBanner()">📍 Anzeigen</button>
                                    </div>
                                </div>
                                <div class="bc-card">
                                    <div class="bc-card__header"><div class="bc-card__title">💰 Loot Drop</div></div>
                                    <div class="bc-card__body">
                                        <div class="bc-field"><textarea class="bc-textarea" id="lootItems" placeholder="Items (eines pro Zeile)" style="height:80px;"></textarea></div>
                                        <div class="bc-field" style="display:flex;gap:8px;align-items:center;">
                                            <input type="number" class="bc-input" id="lootGold" placeholder="Anzahl" min="0" style="flex:1;">
                                            <select class="bc-input" id="lootCurrency" style="width:auto;">
                                                <option value="coins">🪙 Münzen</option>
                                                <option value="gold">💰 Gold</option>
                                                <option value="silver">🥈 Silber</option>
                                                <option value="copper">🥉 Kupfer</option>
                                                <option value="platinum">💎 Platin</option>
                                                <option value="gems">💠 Edelsteine</option>
                                                <option value="berry">🍓 Berry</option>
                                                <option value="dollar">💵 Dollar</option>
                                                <option value="euro">💶 Euro</option>
                                                <option value="credits">🔋 Credits</option>
                                                <option value="yen">💴 Yen</option>
                                            </select>
                                        </div>
                                        <div class="bc-field" style="display:flex;align-items:center;gap:8px;">
                                            <label class="bc-toggle"><input type="checkbox" id="lootSound" checked><span class="bc-toggle__switch"></span></label>
                                            <span style="color:rgba(255,255,255,0.7);font-size:13px;">Sound abspielen</span>
                                        </div>
                                        <button class="bc-btn bc-btn--full bc-btn--success" onclick="BC.sendLootDrop()">💰 Loot zeigen!</button>
                                    </div>
                                </div>
                                <div class="bc-card">
                                    <div class="bc-card__header"><div class="bc-card__title"><svg viewBox="0 0 24 24" fill="currentColor"><path d="M12 2a9 9 0 0 0-9 9c0 3.9 2.5 7.1 6 8.4V21a1 1 0 0 0 1 1h4a1 1 0 0 0 1-1v-1.6c3.5-1.3 6-4.5 6-8.4a9 9 0 0 0-9-9M9 14a2 2 0 1 1 0-4 2 2 0 0 1 0 4m6 0a2 2 0 1 1 0-4 2 2 0 0 1 0 4"/></svg>Death Screen</div></div>
                                    <div class="bc-card__body">
                                        <div class="bc-field"><label class="bc-label">Charakter</label><div class="bc-players" id="deathPlayers"></div></div>
                                        <div class="bc-field"><input type="text" class="bc-input" id="deathMessage" placeholder="Letzte Worte... (optional)"></div>
                                        <button class="bc-btn bc-btn--full bc-btn--danger" onclick="BC.sendDeathScreen()">R.I.P.</button>
                                    </div>
                                </div>
                                <div class="bc-card">
                                    <div class="bc-card__header"><div class="bc-card__title"><svg viewBox="0 0 24 24" fill="currentColor"><circle cx="12" cy="12" r="10"/></svg>Münzwurf</div></div>
                                    <div class="bc-card__body">
                                        <div class="bc-field"><input type="text" class="bc-input" id="coinQuestion" placeholder="Frage (optional)"></div>
                                        <div style="display:flex;gap:8px;"><button class="bc-btn bc-btn--full" onclick="BC.sendCoinFlip()">Werfen!</button><button class="bc-btn" onclick="BC.sendCoinFlip('heads')"><svg viewBox='0 0 24 24' fill='currentColor' style='width:16px;height:16px;'><path d='M5 16L3 5l5.5 5L12 4l3.5 6L21 5l-2 11z'/></svg></button><button class="bc-btn" onclick="BC.sendCoinFlip('tails')"><svg viewBox='0 0 24 24' fill='currentColor' style='width:16px;height:16px;'><path d='M4 4h6v6H4zM14 4h6v6h-6zM4 14h6v6H4zM14 14h6v6h-6z'/></svg></button></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Ambient Sub-Panel -->
                        <div class="bc-subpanel" id="subpanel-ambient">
                            <div class="bc-card">
                                <div class="bc-card__header"><div class="bc-card__title"><svg viewBox="0 0 24 24" fill="currentColor"><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/></svg>Atmosphäre-Effekte</div></div>
                                <div class="bc-card__body">
                                    <div style="display:grid;grid-template-columns:repeat(6,1fr);gap:8px;">
                                        <button class="bc-btn" onclick="BC.sendAmbient('rain')" title="Regen" style="padding:12px;"><svg viewBox='0 0 24 24' fill='none' stroke='currentColor' stroke-width='2' style='width:20px;height:20px;'><path d='M20 17.58A5 5 0 0 0 18 8h-1.26A8 8 0 1 0 4 16.25'/><line x1='8' y1='16' x2='8' y2='20'/><line x1='12' y1='18' x2='12' y2='22'/><line x1='16' y1='16' x2='16' y2='20'/></svg></button>
                                        <button class="bc-btn" onclick="BC.sendAmbient('storm')" title="Gewitter" style="padding:12px;"><svg viewBox='0 0 24 24' fill='none' stroke='currentColor' stroke-width='2' style='width:20px;height:20px;'><path d='M19 16.9A5 5 0 0 0 18 7h-1.26a8 8 0 1 0-11.62 9'/><polyline points='13 11 9 17 15 17 11 23'/></svg></button>
                                        <button class="bc-btn" onclick="BC.sendAmbient('snow')" title="Schnee" style="padding:12px;"><svg viewBox='0 0 24 24' fill='none' stroke='currentColor' stroke-width='2' style='width:20px;height:20px;'><line x1='12' y1='2' x2='12' y2='22'/><path d='M20 12H4m14.364-5.636L5.636 17.636M18.364 17.636L5.636 6.364'/></svg></button>
                                        <button class="bc-btn" onclick="BC.sendAmbient('fog')" title="Nebel" style="padding:12px;"><svg viewBox='0 0 24 24' fill='none' stroke='currentColor' stroke-width='2' style='width:20px;height:20px;'><path d='M20 17.58A5 5 0 0 0 18 8h-1.26A8 8 0 1 0 4 16.25'/></svg></button>
                                        <button class="bc-btn" onclick="BC.sendAmbient('fire')" title="Feuer" style="padding:12px;"><svg viewBox='0 0 24 24' fill='currentColor' style='width:20px;height:20px;color:#ef4444;'><path d='M12 23c-3.866 0-7-2.686-7-6 0-2.907 1.95-5.508 4-7.5l1.2-1.2a.6.6 0 0 1 1.02.424l.036 1.476c.028 1.133.892 2.05 1.944 2.3.71.169 1.455-.081 1.937-.66l2.83-3.393A.6.6 0 0 1 19 9c0 6-3.134 14-7 14z'/></svg></button>
                                        <button class="bc-btn" onclick="BC.sendAmbient('darkness')" title="Dunkelheit" style="padding:12px;"><svg viewBox='0 0 24 24' fill='currentColor' style='width:20px;height:20px;'><circle cx='12' cy='12' r='10'/></svg></button>
                                        <button class="bc-btn" onclick="BC.sendAmbient('magic')" title="Magie" style="padding:12px;"><svg viewBox='0 0 24 24' fill='none' stroke='currentColor' stroke-width='2' style='width:20px;height:20px;color:#a78bfa;'><path d='M12 3v4m0 14v-4m9-5h-4M7 12H3m14.657-5.657l-2.828 2.828M9.172 14.828l-2.829 2.829m11.314 0l-2.828-2.828M9.172 9.172L6.343 6.343'/></svg></button>
                                        <button class="bc-btn" onclick="BC.sendAmbient('stars')" title="Sterne" style="padding:12px;"><svg viewBox='0 0 24 24' fill='currentColor' style='width:20px;height:20px;color:#fbbf24;'><path d='M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14l-5-4.87 6.91-1.01z'/></svg></button>
                                        <button class="bc-btn" onclick="BC.sendAmbient('blood')" title="Blut" style="padding:12px;"><svg viewBox='0 0 24 24' fill='currentColor' style='width:20px;height:20px;color:#dc2626;'><path d='M12 2s-7 7.59-7 12a7 7 0 1 0 14 0c0-4.41-7-12-7-12z'/></svg></button>
                                        <button class="bc-btn" onclick="BC.sendAmbient('holy')" title="Heilig" style="padding:12px;"><svg viewBox='0 0 24 24' fill='currentColor' style='width:20px;height:20px;color:#fbbf24;'><path d='M12 2l1.09 3.41h3.58l-2.89 2.1 1.1 3.41L12 8.82l-2.88 2.1 1.1-3.41-2.89-2.1h3.58zM12 18a6 6 0 1 0 0-12 6 6 0 0 0 0 12z'/></svg></button>
                                        <button class="bc-btn" onclick="BC.sendAmbient('underwater')" title="Unterwasser" style="padding:12px;"><svg viewBox='0 0 24 24' fill='none' stroke='currentColor' stroke-width='2' style='width:20px;height:20px;color:#38bdf8;'><path d='M2 6c.6.5 1.2 1 2.5 1C7 7 7 5 9.5 5c2.6 0 2.4 2 5 2 2.5 0 2.5-2 5-2 1.3 0 1.9.5 2.5 1'/><path d='M2 12c.6.5 1.2 1 2.5 1 2.5 0 2.5-2 5-2 2.6 0 2.4 2 5 2 2.5 0 2.5-2 5-2 1.3 0 1.9.5 2.5 1'/><path d='M2 18c.6.5 1.2 1 2.5 1 2.5 0 2.5-2 5-2 2.6 0 2.4 2 5 2 2.5 0 2.5-2 5-2 1.3 0 1.9.5 2.5 1'/></svg></button>
                                        <button class="bc-btn" onclick="BC.sendAmbient('poison')" title="Gift/Säure" style="padding:12px;"><svg viewBox='0 0 24 24' fill='currentColor' style='width:20px;height:20px;color:#84cc16;'><path d='M12 2a9 9 0 0 0-9 9c0 3.9 2.5 7.1 6 8.4V21a1 1 0 0 0 1 1h4a1 1 0 0 0 1-1v-1.6c3.5-1.3 6-4.5 6-8.4a9 9 0 0 0-9-9M9 14a2 2 0 1 1 0-4 2 2 0 0 1 0 4m6 0a2 2 0 1 1 0-4 2 2 0 0 1 0 4'/></svg></button>
                                        <button class="bc-btn" onclick="BC.sendAmbient('forest')" title="Wald" style="padding:12px;"><svg viewBox='0 0 24 24' fill='currentColor' style='width:20px;height:20px;color:#22c55e;'><path d='M12 3L4 14h3l-2 5h4l-1 3h8l-1-3h4l-2-5h3z'/></svg></button>
                                        <button class="bc-btn" onclick="BC.sendAmbient('sandstorm')" title="Sandsturm" style="padding:12px;"><svg viewBox='0 0 24 24' fill='none' stroke='currentColor' stroke-width='2' style='width:20px;height:20px;color:#d97706;'><path d='M9.59 4.59A2 2 0 1 1 11 8H2m10.59 11.41A2 2 0 1 0 14 16H2m15.73-8.27A2.5 2.5 0 1 1 19.5 12H2'/></svg></button>
                                        <button class="bc-btn" onclick="BC.sendAmbient('ash')" title="Asche/Vulkan" style="padding:12px;"><svg viewBox='0 0 24 24' fill='currentColor' style='width:20px;height:20px;color:#f97316;'><path d='M12 2l-2 6 3-2 1 4 2-3 1 5 3-4 2 14H2l2-14 3 4z'/></svg></button>
                                        <button class="bc-btn" onclick="BC.sendAmbient('aurora')" title="Nordlichter" style="padding:12px;"><svg viewBox='0 0 24 24' fill='none' stroke='currentColor' stroke-width='2' style='width:20px;height:20px;color:#818cf8;'><path d='M12 3v4m0 14v-4m9-5h-4M7 12H3m14.657-5.657l-2.828 2.828M9.172 14.828l-2.829 2.829m11.314 0l-2.828-2.828M9.172 9.172L6.343 6.343'/></svg></button>
                                        <button class="bc-btn" onclick="BC.sendAmbient('swamp')" title="Sumpf" style="padding:12px;"><svg viewBox='0 0 24 24' fill='currentColor' style='width:20px;height:20px;color:#65a30d;'><path d='M12 2s-7 7.59-7 12a7 7 0 1 0 14 0c0-4.41-7-12-7-12z'/></svg></button>
                                        <button class="bc-btn" onclick="BC.sendAmbient('void')" title="Leere/Void" style="padding:12px;"><svg viewBox='0 0 24 24' fill='currentColor' style='width:20px;height:20px;color:#6366f1;'><circle cx='12' cy='12' r='10'/></svg></button>
                                        <button class="bc-btn" onclick="BC.sendAmbient('nightmare')" title="Albtraum" style="padding:12px;"><svg viewBox='0 0 24 24' fill='currentColor' style='width:20px;height:20px;color:#dc2626;'><path d='M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z'/><circle cx='12' cy='12' r='3'/></svg></button>
                                        <button class="bc-btn" onclick="BC.sendAmbient('sakura')" title="Kirschblüten" style="padding:12px;"><svg viewBox='0 0 24 24' fill='currentColor' style='width:20px;height:20px;color:#f472b6;'><path d='M12 2l1.09 3.41h3.58l-2.89 2.1 1.1 3.41L12 8.82l-2.88 2.1 1.1-3.41-2.89-2.1h3.58zM12 18a6 6 0 1 0 0-12 6 6 0 0 0 0 12z'/></svg></button>
                                        <button class="bc-btn" onclick="BC.sendAmbient('lightning')" title="Blitze" style="padding:12px;"><svg viewBox='0 0 24 24' fill='currentColor' style='width:20px;height:20px;color:#eab308;'><path d='M13 2L3 14h9l-1 8 10-12h-9l1-8z'/></svg></button>
                                        <button class="bc-btn bc-btn--danger" onclick="BC.sendAmbient('clear')" title="Effekt beenden" style="padding:12px;"><svg viewBox='0 0 24 24' fill='none' stroke='currentColor' stroke-width='2.5' style='width:20px;height:20px;'><line x1='18' y1='6' x2='6' y2='18'/><line x1='6' y1='6' x2='18' y2='18'/></svg></button>
                                    </div>
                                    <div style="margin-top:24px;">
                                        <label class="bc-label">Tageszeit</label>
                                        <div style="display:grid;grid-template-columns:repeat(5,1fr);gap:8px;margin-top:8px;">
                                            <button class="bc-btn bc-btn--small" onclick="BC.sendTimeOfDay('dawn')" style="background:linear-gradient(135deg,#fcd34d,#fb923c);"><svg viewBox='0 0 24 24' fill='currentColor' style='width:13px;height:13px;margin-right:3px;'><path d='M12 2v4m6.364 1.636l-2.828 2.828M20 12h4M17.536 17.536l2.828 2.828M12 20v4M6.464 17.536l-2.828 2.828M4 12H0M6.464 6.464L3.636 3.636'/></svg>Morgen</button>
                                            <button class="bc-btn bc-btn--small" onclick="BC.sendTimeOfDay('noon')" style="background:linear-gradient(135deg,#fbbf24,#f59e0b);"><svg viewBox='0 0 24 24' fill='currentColor' style='width:13px;height:13px;margin-right:3px;'><circle cx='12' cy='12' r='5'/><path d='M12 1v2m0 18v2M4.22 4.22l1.42 1.42m12.72 12.72l1.42 1.42M1 12h2m18 0h2M4.22 19.78l1.42-1.42M18.36 5.64l1.42-1.42'/></svg>Mittag</button>
                                            <button class="bc-btn bc-btn--small" onclick="BC.sendTimeOfDay('dusk')" style="background:linear-gradient(135deg,#f97316,#dc2626);"><svg viewBox='0 0 24 24' fill='currentColor' style='width:13px;height:13px;margin-right:3px;'><path d='M17 18a5 5 0 0 0-10 0'/><line x1='12' y1='9' x2='12' y2='2'/><line x1='4.22' y1='10.22' x2='5.64' y2='11.64'/><line x1='1' y1='18' x2='3' y2='18'/><line x1='21' y1='18' x2='23' y2='18'/><line x1='18.36' y1='11.64' x2='19.78' y2='10.22'/><line x1='23' y1='22' x2='1' y2='22'/></svg>Abend</button>
                                            <button class="bc-btn bc-btn--small" onclick="BC.sendTimeOfDay('midnight')" style="background:linear-gradient(135deg,#1e3a5f,#0f172a);"><svg viewBox='0 0 24 24' fill='currentColor' style='width:13px;height:13px;margin-right:3px;'><path d='M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z'/></svg>Nacht</button>
                                            <button class="bc-btn bc-btn--small bc-btn--danger" onclick="BC.sendTimeOfDay('clear')"><svg viewBox='0 0 24 24' fill='none' stroke='currentColor' stroke-width='2.5' style='width:12px;height:12px;margin-right:3px;'><line x1='18' y1='6' x2='6' y2='18'/><line x1='6' y1='6' x2='18' y2='18'/></svg>Aus</button>
                                        </div>
                                    </div>
                                    <div style="margin-top:24px;">
                                        <label class="bc-label">Globale Pause</label>
                                        <div style="display:flex;gap:8px;margin-top:8px;">
                                            <button class="bc-btn bc-btn--warning" onclick="BC.pauseAllPlayers()" style="flex:1;">Pausieren</button>
                                            <button class="bc-btn bc-btn--success" onclick="BC.unpauseAllPlayers()" style="flex:1;">Fortsetzen</button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Sounds Sub-Panel -->
                        <div class="bc-subpanel" id="subpanel-sounds">
                            <div class="bc-card">
                                <div class="bc-card__header"><div class="bc-card__title"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M11 5L6 9H2v6h4l5 4z"/><path d="M19.07 4.93a10 10 0 0 1 0 14.14M15.54 8.46a5 5 0 0 1 0 7.07"/></svg>Sound Board</div></div>
                                <div class="bc-card__body">
                                    <div style="display:grid;grid-template-columns:repeat(6,1fr);gap:12px;">
                                        <button class="bc-btn" onclick="BC.playGlobalSound('doorCreak')" title="Tür knarrt"><svg viewBox='0 0 24 24' fill='none' stroke='currentColor' stroke-width='2' style='width:22px;height:22px;'><path d='M3 21V3h12l4 4v14H3z'/><path d='M15 3v4h4'/></svg></button>
                                        <button class="bc-btn" onclick="BC.playGlobalSound('thunder')" title="Donner"><svg viewBox="0 0 24 24" fill="currentColor" style="width:22px;height:22px;"><path d="M13 2L3 14h9l-1 8 10-12h-9l1-8z"/></svg></button>
                                        <button class="bc-btn" onclick="BC.playGlobalSound('explosion')" title="Explosion"><svg viewBox="0 0 24 24" fill="currentColor" style="width:22px;height:22px;"><path d="M12 3v4m0 14v-4m9-5h-4M7 12H3m14.657-5.657l-2.828 2.828M9.172 14.828l-2.829 2.829m11.314 0l-2.828-2.828M9.172 9.172L6.343 6.343"/></svg></button>
                                        <button class="bc-btn" onclick="BC.playGlobalSound('wolf')" title="Wolf heult"><svg viewBox='0 0 24 24' fill='currentColor' style='width:22px;height:22px;'><path d='M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z'/></svg></button>
                                        <button class="bc-btn" onclick="BC.playGlobalSound('swordClash')" title="Schwertklirren"><svg viewBox="0 0 24 24" fill="currentColor" style="width:22px;height:22px;"><path d="M14.5 2.1a2 2 0 0 0-2.83 0l-2.82 2.83a2 2 0 0 0 0 2.83L10.27 9.2 2.1 17.37a2 2 0 0 0 0 2.83l1.7 1.7a2 2 0 0 0 2.83 0l8.17-8.17 1.42 1.42a2 2 0 0 0 2.83 0l2.83-2.83a2 2 0 0 0 0-2.83z"/></svg></button>
                                        <button class="bc-btn" onclick="BC.playGlobalSound('magic')" title="Magie"><svg viewBox="0 0 24 24" fill="currentColor" style="width:22px;height:22px;"><path d="M12 3v4m0 14v-4m9-5h-4M7 12H3m14.657-5.657l-2.828 2.828M9.172 14.828l-2.829 2.829m11.314 0l-2.828-2.828M9.172 9.172L6.343 6.343"/></svg></button>
                                        <button class="bc-btn" onclick="BC.playGlobalSound('heartbeat')" title="Herzschlag"><svg viewBox='0 0 24 24' fill='currentColor' style='width:22px;height:22px;color:#ef4444;'><path d='M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z'/></svg></button>
                                        <button class="bc-btn" onclick="BC.playGlobalSound('laugh')" title="Böses Lachen"><svg viewBox='0 0 24 24' fill='none' stroke='currentColor' stroke-width='2' style='width:22px;height:22px;color:#a855f7;'><circle cx='12' cy='12' r='10'/><path d='M8 14s1.5 2 4 2 4-2 4-2'/><line x1='9' y1='9' x2='9.01' y2='9'/><line x1='15' y1='9' x2='15.01' y2='9'/></svg></button>
                                        <button class="bc-btn" onclick="BC.playGlobalSound('glass')" title="Glas zerbricht"><svg viewBox='0 0 24 24' fill='none' stroke='currentColor' stroke-width='2' style='width:22px;height:22px;'><path d='M8 22h8m-4-7v7M5 2l2 10h10L19 2z'/></svg></button>
                                        <button class="bc-btn" onclick="BC.playGlobalSound('chains')" title="Ketten"><svg viewBox='0 0 24 24' fill='none' stroke='currentColor' stroke-width='2' style='width:22px;height:22px;'><path d='M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71'/><path d='M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71'/></svg></button>
                                        <button class="bc-btn" onclick="BC.playGlobalSound('whisper')" title="Flüstern"><svg viewBox='0 0 24 24' fill='none' stroke='currentColor' stroke-width='2' style='width:22px;height:22px;color:rgba(255,255,255,0.5);'><path d='M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z'/></svg></button>
                                        <button class="bc-btn" onclick="BC.playGlobalSound('coin')" title="Münzen"><svg viewBox='0 0 24 24' fill='currentColor' style='width:22px;height:22px;color:#fbbf24;'><circle cx='12' cy='12' r='10'/><path d='M12 6v12m-3-9h6m-6 6h6' fill='none' stroke='#1a1200' stroke-width='2'/></svg></button>
                                    </div>
                                    <div style="margin-top:24px;padding-top:16px;border-top:1px solid rgba(255,255,255,0.1);">
                                        <label class="bc-label">Eigene Audio-Datei</label>
                                        <div style="display:flex;gap:8px;margin-top:8px;">
                                            <input type="file" id="customSoundInput" accept="audio/*,.mp3,.wav,.ogg" style="display:none;" onchange="BC.handleSoundUpload(event)">
                                            <button class="bc-btn" onclick="document.getElementById('customSoundInput').click()" style="flex:1;"><svg viewBox='0 0 24 24' fill='none' stroke='currentColor' stroke-width='2' style='width:14px;height:14px;margin-right:4px;'><path d='M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z'/></svg>Datei wählen...</button>
                                            <button class="bc-btn bc-btn--danger" onclick="BC.stopGlobalSound()" id="stopSoundBtn" style="display:none;">Stopp</button>
                                        </div>
                                        <div id="customSoundName" style="margin-top:8px;font-size:13px;color:rgba(255,255,255,0.5);"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- ==================== PLAYERS PANEL ==================== -->
                    <div class="broadcast-panel" id="panel-players">
                        <div class="broadcast-grid">
                            <!-- Player List -->
                            <div class="bc-card">
                                <div class="bc-card__header">
                                    <div class="bc-card__title"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 0 0-3-3.87M16 3.13a4 4 0 0 1 0 7.75"/></svg>Spieler im Raum</div>
                                    <span id="playerCountDisplay" style="font-size:13px;color:rgba(255,255,255,0.5);">0 Spieler</span>
                                </div>
                                <div class="bc-card__body" style="padding:0;">
                                    <div id="playerManagementList" class="player-management-list"></div>
                                </div>
                            </div>
                            
                            <!-- Moderation -->
                            <div style="display:flex;flex-direction:column;gap:24px;">
                                <!-- GM Transfer -->
                                <div class="bc-card">
                                    <div class="bc-card__header"><div class="bc-card__title"><svg viewBox="0 0 24 24" fill="currentColor"><path d="M5 16L3 5l5.5 5L12 4l3.5 6L21 5l-2 11H5z"/></svg>GM übertragen</div></div>
                                    <div class="bc-card__body">
                                        <div class="bc-field"><label class="bc-label">Neuer GM</label><select class="bc-input" id="gmTransferSelect"><option value="">Wählen...</option></select></div>
                                        <button class="bc-btn bc-btn--full bc-btn--warning" id="gmTransferBtn" onclick="BC.transferGM()" disabled><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width:16px;height:16px;"><path d="M5 16L3 5l5.5 5L12 4l3.5 6L21 5l-2 11z"/></svg> GM-Rolle übertragen</button>
                                    </div>
                                </div>
                                
                                <!-- Quick Actions -->
                                <div class="bc-card">
                                    <div class="bc-card__header"><div class="bc-card__title"><svg viewBox="0 0 24 24" fill="currentColor"><path d="M13 2L3 14h9l-1 8 10-12h-9l1-8z"/></svg>Schnellaktionen</div></div>
                                    <div class="bc-card__body">
                                        <button class="bc-btn bc-btn--full bc-btn--secondary" onclick="BC.pauseAllPlayers()" style="margin-bottom:8px;"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width:16px;height:16px;"><rect x="6" y="4" width="4" height="16"/><rect x="14" y="4" width="4" height="16"/></svg> Alle pausieren</button>
                                        <button class="bc-btn bc-btn--full bc-btn--secondary" onclick="BC.unpauseAllPlayers()"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width:16px;height:16px;"><polygon points="5 3 19 12 5 21 5 3"/></svg> Alle fortsetzen</button>
                                    </div>
                                </div>
                                
                                <!-- Banned Players -->
                                <div class="bc-card">
                                    <div class="bc-card__header"><div class="bc-card__title" style="color:#ef4444;"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20 13c0 5-3.5 7.5-7.66 8.95a1 1 0 0 1-.67-.01C7.5 20.5 4 18 4 13V6a1 1 0 0 1 1-1c2 0 4.5-1.2 6.24-2.72a1.17 1.17 0 0 1 1.52 0C14.51 3.81 17 5 19 5a1 1 0 0 1 1 1z"/><path d="m14.5 9.5-5 5m0-5 5 5"/></svg>Gebannte Spieler</div></div>
                                    <div class="bc-card__body" style="padding:0;max-height:200px;overflow-y:auto;">
                                        <div id="bannedPlayersList"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- ==================== CHARACTERS PANEL ==================== -->
                    <div class="broadcast-panel" id="panel-characters">
                        <div id="characterGlobalActions"></div>
                        <div id="characterGrid" class="character-grid"></div>
                    </div>
                    
                    <!-- ==================== LOGS PANEL ==================== -->
                    <div class="broadcast-panel" id="panel-logs">
                        <!-- Log Filters -->
                        <div class="bc-card" style="margin-bottom:24px;">
                            <div class="bc-card__body" style="padding:16px;">
                                <div style="display:flex;gap:8px;flex-wrap:wrap;align-items:center;">
                                    <span style="color:rgba(255,255,255,0.5);font-size:13px;">Filter:</span>
                                    <button class="bc-log-filter active" data-filter="all" onclick="BC.filterLogs('all')">Alle</button>
                                    <button class="bc-log-filter" data-filter="dice" onclick="BC.filterLogs('dice')"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width:13px;height:13px;display:inline;vertical-align:middle;margin-right:4px;"><rect x="3" y="3" width="18" height="18" rx="2"/><circle cx="8.5" cy="8.5" r="1"/><circle cx="15.5" cy="15.5" r="1"/><circle cx="12" cy="12" r="1"/></svg>Würfel</button>
                                    <button class="bc-log-filter" data-filter="chat" onclick="BC.filterLogs('chat')"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width:13px;height:13px;display:inline;vertical-align:middle;margin-right:4px;"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/></svg>Chat</button>
                                    <button class="bc-log-filter" data-filter="character" onclick="BC.filterLogs('character')"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width:13px;height:13px;display:inline;vertical-align:middle;margin-right:4px;"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>Charaktere</button>
                                    <button class="bc-log-filter" data-filter="session" onclick="BC.filterLogs('session')"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width:13px;height:13px;display:inline;vertical-align:middle;margin-right:4px;"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>Sessions</button>
                                    <button class="bc-log-filter" data-filter="member" onclick="BC.filterLogs('member')"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width:13px;height:13px;display:inline;vertical-align:middle;margin-right:4px;"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 0 0-3-3.87M16 3.13a4 4 0 0 1 0 7.75"/></svg>Spieler</button>
                                    <button class="bc-log-filter" data-filter="broadcast" onclick="BC.filterLogs('broadcast')"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width:13px;height:13px;display:inline;vertical-align:middle;margin-right:4px;"><polygon points="22 2 15 22 11 13 2 9 22 2"/></svg>Broadcasts</button>
                                    <div style="flex:1;"></div>
                                    <input type="text" class="bc-input" id="logSearch" placeholder="Suchen..." style="width:200px;" oninput="BC.searchLogs(this.value)">
                                    <button class="bc-btn bc-btn--small bc-btn--secondary" onclick="BC.exportLogs()"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width:14px;height:14px;"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg> Export</button>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Log List -->
                        <div class="bc-card">
                            <div class="bc-card__header">
                                <div class="bc-card__title"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/></svg>Aktivitäts-Log</div>
                                <span id="logCount" style="font-size:13px;color:rgba(255,255,255,0.5);">0 Einträge</span>
                            </div>
                            <div class="bc-card__body" style="padding:0;">
                                <div id="activityLogList" class="activity-log-list"></div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- ==================== SETTINGS PANEL ==================== -->
                    <div class="broadcast-panel" id="panel-settings">
                        <div class="broadcast-grid">
                            <!-- Room Info -->
                            <div class="bc-card">
                                <div class="bc-card__header"><div class="bc-card__title"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg>Raum-Info</div></div>
                                <div class="bc-card__body">
                                    <div class="bc-field">
                                        <label class="bc-label">Raum-Code</label>
                                        <div style="display:flex;gap:8px;">
                                            <input type="text" class="bc-input" id="roomCodeInput" readonly>
                                            <button class="bc-btn" onclick="BC.copyRoomCode()"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width:16px;height:16px;"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"/><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"/></svg></button>
                                        </div>
                                    </div>
                                    <div class="bc-field">
                                        <label class="bc-label">Einladungslink</label>
                                        <div style="display:flex;gap:8px;">
                                            <input type="text" class="bc-input" id="inviteLinkInput" readonly>
                                            <button class="bc-btn" onclick="BC.copyInviteLink()"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width:16px;height:16px;"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"/><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"/></svg></button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Room Settings -->
                            <div class="bc-card">
                                <div class="bc-card__header"><div class="bc-card__title"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1-2.83 2.83l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-4 0v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1 0-4h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 2.83-2.83l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 4 0v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9c.26.604.852.997 1.51 1H21a2 2 0 0 1 0 4h-.09c-.658.003-1.25.396-1.51 1z"/></svg>Einstellungen</div></div>
                                <div class="bc-card__body">
                                    <div class="setting-row">
                                        <div class="setting-row__info"><div class="setting-row__title">Spieler können Marker setzen</div><div class="setting-row__desc">Auf der Karte</div></div>
                                        <label class="bc-toggle"><input type="checkbox" id="settingMapEdit" onchange="BC.saveSetting('mapEdit', this.checked)"><span class="bc-toggle__switch"></span></label>
                                    </div>
                                    <div class="setting-row">
                                        <div class="setting-row__info"><div class="setting-row__title">Spieler können Notizen erstellen</div></div>
                                        <label class="bc-toggle"><input type="checkbox" id="settingNotes" onchange="BC.saveSetting('notes', this.checked)" checked><span class="bc-toggle__switch"></span></label>
                                    </div>
                                    <div class="setting-row">
                                        <div class="setting-row__info"><div class="setting-row__title">Multi-Charakter erlauben</div><div class="setting-row__desc">Spieler können mehrere Charaktere haben</div></div>
                                        <label class="bc-toggle"><input type="checkbox" id="settingMultiChar" onchange="BC.saveSetting('multiChar', this.checked)"><span class="bc-toggle__switch"></span></label>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Pause Controls -->
                            <div class="bc-card">
                                <div class="bc-card__header"><div class="bc-card__title"><svg viewBox="0 0 24 24" fill="currentColor"><rect x="6" y="4" width="4" height="16" rx="1"/><rect x="14" y="4" width="4" height="16" rx="1"/></svg>Pause &amp; Kontrolle</div></div>
                                <div class="bc-card__body">
                                    <div class="bc-field">
                                        <label class="bc-label">Globale Pause (Blur-Effekt)</label>
                                        <p style="font-size:12px;color:rgba(255,255,255,0.5);margin:8px 0;">Blendet alle Spieler-Bildschirme aus bis du fortfährst.</p>
                                        <div style="display:flex;gap:8px;margin-top:8px;">
                                            <button class="bc-btn bc-btn--warning" onclick="BC.pauseAllPlayers()" style="flex:1;">Alle pausieren</button>
                                            <button class="bc-btn bc-btn--success" onclick="BC.unpauseAllPlayers()" style="flex:1;">Fortsetzen</button>
                                        </div>
                                    </div>
                                    <div class="bc-field" style="margin-top:20px;">
                                        <label class="bc-label">Kurze Pause (Countdown)</label>
                                        <div style="display:grid;grid-template-columns:repeat(4,1fr);gap:8px;margin-top:8px;">
                                            <button class="bc-btn bc-btn--small" onclick="BC.sendBreakCountdown(5)">5 min</button>
                                            <button class="bc-btn bc-btn--small" onclick="BC.sendBreakCountdown(10)">10 min</button>
                                            <button class="bc-btn bc-btn--small" onclick="BC.sendBreakCountdown(15)">15 min</button>
                                            <button class="bc-btn bc-btn--small" onclick="BC.sendBreakCountdown(30)">30 min</button>
                                        </div>
                                    </div>
                                    <div class="bc-field" style="margin-top:20px;">
                                        <label class="bc-label">Pause beenden</label>
                                        <button class="bc-btn bc-btn--full bc-btn--secondary" onclick="BC.endBreak()">Pause-Countdown beenden</button>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Danger Zone -->
                            <div class="bc-card" style="border-color:rgba(239,68,68,0.3);">
                                <div class="bc-card__header"><div class="bc-card__title" style="color:#ef4444;"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"/><line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg>Gefahrenzone</div></div>
                                <div class="bc-card__body">
                                    <div class="danger-item">
                                        <div class="danger-item__info"><h4>Raum verlassen</h4><p>Du verlierst GM-Rechte (erst GM übertragen!)</p></div>
                                        <button class="bc-btn bc-btn--small bc-btn--warning" onclick="BC.leaveRoom()">Verlassen</button>
                                    </div>
                                    <div class="danger-item">
                                        <div class="danger-item__info"><h4>Raum löschen</h4><p>Alle Daten werden unwiderruflich gelöscht</p></div>
                                        <button class="bc-btn bc-btn--small bc-btn--danger" onclick="BC.deleteRoom()">Löschen</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- ==================== HISTORY PANEL ==================== -->
                    <div class="broadcast-panel" id="panel-history">
                        <div class="bc-card">
                            <div class="bc-card__header">
                                <div class="bc-card__title">
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>
                                    GM Verlauf
                                </div>
                                <button class="bc-btn bc-btn--small bc-btn--secondary" onclick="BC.clearHistory()">Löschen</button>
                            </div>
                            <div class="bc-card__body" style="padding: 0;">
                                <div class="bc-history" id="fullHistory">
                                    <div class="bc-empty" id="historyEmpty">
                                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>
                                        <div class="bc-empty__title">Keine Einträge</div>
                                        <p>Broadcasts und Umfragen erscheinen hier</p>
                                    </div>
                                    <div id="historyList"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- ==================== TOOLS PANEL ==================== -->
                    <div class="broadcast-panel" id="panel-tools">
                        <!-- Quick Links -->
                        <div class="bc-card">
                            <div class="bc-card__header"><div class="bc-card__title"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M10 13a5 5 0 007.54.54l3-3a5 5 0 00-7.07-7.07l-1.72 1.71"/><path d="M14 11a5 5 0 00-7.54-.54l-3 3a5 5 0 007.07 7.07l1.71-1.71"/></svg>Schnellzugriff</div></div>
                            <div class="bc-card__body">
                                <div class="gm-quicklinks">
                                    <a class="gm-quicklink" href="/pages/chat.html" target="_blank">
                                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15a2 2 0 01-2 2H7l-4 4V5a2 2 0 012-2h14a2 2 0 012 2z"/></svg>
                                        <span>Chat</span>
                                    </a>
                                    <a class="gm-quicklink" href="/pages/dice.html" target="_blank">
                                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="18" height="18" rx="2"/><circle cx="8.5" cy="8.5" r="1.5"/><circle cx="15.5" cy="15.5" r="1.5"/><circle cx="12" cy="12" r="1.5"/></svg>
                                        <span>Würfel</span>
                                    </a>
                                    <a class="gm-quicklink" href="/pages/whiteboard.html" target="_blank">
                                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="18" height="18" rx="2"/><line x1="3" y1="9" x2="21" y2="9"/><line x1="9" y1="21" x2="9" y2="9"/></svg>
                                        <span>Whiteboard</span>
                                    </a>
                                    <a class="gm-quicklink" href="/pages/map.html" target="_blank">
                                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polygon points="1 6 1 22 8 18 16 22 23 18 23 2 16 6 8 2 1 6"/><line x1="8" y1="2" x2="8" y2="18"/><line x1="16" y1="6" x2="16" y2="22"/></svg>
                                        <span>Karte</span>
                                    </a>
                                    <a class="gm-quicklink" href="/pages/sessions.html" target="_blank">
                                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="4" width="18" height="18" rx="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>
                                        <span>Sessions</span>
                                    </a>
                                    <a class="gm-quicklink" id="toolsSheetLink" href="/pages/sheets/sheet-worldsapart.html" target="_blank">
                                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8z"/><polyline points="14 2 14 8 20 8"/></svg>
                                        <span>Bogen</span>
                                    </a>
                                </div>
                            </div>
                        </div>

                        <div class="broadcast-grid" style="margin-top:16px">
                            <!-- Live Chat Feed -->
                            <div class="bc-card">
                                <div class="bc-card__header">
                                    <div class="bc-card__title"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15a2 2 0 01-2 2H7l-4 4V5a2 2 0 012-2h14a2 2 0 012 2z"/></svg>Live Chat</div>
                                    <a href="/pages/chat.html" target="_blank" class="bc-btn bc-btn--small bc-btn--secondary" style="font-size:10px">Öffnen</a>
                                </div>
                                <div class="bc-card__body" style="padding:0">
                                    <div class="gm-chat-feed" id="gmChatFeed">
                                        <div class="gm-chat-empty">Verbinde mit Chat...</div>
                                    </div>
                                    <div class="gm-chat-input-row">
                                        <input type="text" class="bc-input" id="gmChatInput" placeholder="Nachricht als GM senden..." style="flex:1">
                                        <button class="bc-btn" onclick="BC.sendGMChat()">Senden</button>
                                    </div>
                                </div>
                            </div>

                            <!-- GM Quick Dice -->
                            <div class="bc-card">
                                <div class="bc-card__header">
                                    <div class="bc-card__title"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="18" height="18" rx="2"/><circle cx="8.5" cy="8.5" r="1.5"/><circle cx="15.5" cy="15.5" r="1.5"/><circle cx="12" cy="12" r="1.5"/></svg>GM Würfel</div>
                                </div>
                                <div class="bc-card__body" style="padding:12px">
                                    <div class="gm-dice-result" id="gmDiceResult">
                                        <span class="gm-dice-result__value">—</span>
                                    </div>
                                    <div class="gm-dice-buttons">
                                        <button class="gm-dice-btn" onclick="BC.gmRoll(4)">D4</button>
                                        <button class="gm-dice-btn" onclick="BC.gmRoll(6)">D6</button>
                                        <button class="gm-dice-btn" onclick="BC.gmRoll(8)">D8</button>
                                        <button class="gm-dice-btn" onclick="BC.gmRoll(10)">D10</button>
                                        <button class="gm-dice-btn" onclick="BC.gmRoll(12)">D12</button>
                                        <button class="gm-dice-btn gm-dice-btn--d20" onclick="BC.gmRoll(20)">D20</button>
                                        <button class="gm-dice-btn" onclick="BC.gmRoll(100)">D100</button>
                                    </div>
                                    <div class="gm-dice-custom">
                                        <input type="text" class="bc-input" id="gmDiceFormula" placeholder="z.B. 2d6+4, 1d20+3" style="flex:1">
                                        <button class="bc-btn" onclick="BC.gmRollCustom()">Würfeln</button>
                                    </div>
                                    <div style="margin-top:8px;display:flex;gap:6px">
                                        <label style="font-size:11px;color:rgba(255,255,255,0.4);display:flex;align-items:center;gap:4px;cursor:pointer">
                                            <input type="checkbox" id="gmDiceSecret"> Geheimer Wurf
                                        </label>
                                        <label style="font-size:11px;color:rgba(255,255,255,0.4);display:flex;align-items:center;gap:4px;cursor:pointer">
                                            <input type="checkbox" id="gmDiceBroadcast"> An Spieler senden
                                        </label>
                                    </div>
                                    <div style="margin-top:10px;border-top:1px solid rgba(255,255,255,0.05);padding-top:8px">
                                        <div style="font-size:10px;color:rgba(255,255,255,0.3);text-transform:uppercase;letter-spacing:0.5px;margin-bottom:6px">Letzte Würfe (alle Spieler)</div>
                                        <div class="gm-dice-log" id="gmDiceLog"><div style="color:rgba(255,255,255,0.2)">Lade...</div></div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Session Controls -->
                        <div class="bc-card" style="margin-top:16px">
                            <div class="bc-card__header">
                                <div class="bc-card__title"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><polygon points="10 8 16 12 10 16 10 8"/></svg>Session-Kontrolle</div>
                                <div class="gm-session-status" id="gmSessionStatus">
                                    <span class="gm-session-dot gm-session-dot--offline"></span> Keine aktive Session
                                </div>
                            </div>
                            <div class="bc-card__body" style="padding:12px">
                                <div id="gmSessionInfo" class="gm-session-info">
                                    <p style="font-size:12px;color:rgba(255,255,255,0.4)">Lade Session-Daten...</p>
                                </div>
                                <div class="gm-session-actions" id="gmSessionActions">
                                    <a href="/pages/sessions.html" target="_blank" class="bc-btn bc-btn--full bc-btn--secondary">Session-Manager öffnen</a>
                                </div>
                            </div>
                        </div>

                        <!-- Whiteboard & Map Preview -->
                        <div class="broadcast-grid" style="margin-top:16px">
                            <div class="bc-card">
                                <div class="bc-card__header">
                                    <div class="bc-card__title"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="18" height="18" rx="2"/><line x1="3" y1="9" x2="21" y2="9"/><line x1="9" y1="21" x2="9" y2="9"/></svg>Whiteboard</div>
                                    <a href="/pages/whiteboard.html" target="_blank" class="bc-btn bc-btn--small bc-btn--secondary" style="font-size:10px">Öffnen</a>
                                </div>
                                <div class="bc-card__body" style="padding:12px;text-align:center">
                                    <div id="gmWhiteboardPreview" class="gm-feature-preview">
                                        <svg viewBox="0 0 48 48" fill="none" stroke="currentColor" stroke-width="1" opacity="0.2"><rect x="4" y="4" width="40" height="40" rx="4"/><line x1="4" y1="16" x2="44" y2="16"/><line x1="16" y1="44" x2="16" y2="16"/><circle cx="30" cy="30" r="6"/></svg>
                                        <p>Whiteboard in neuem Tab öffnen</p>
                                    </div>
                                </div>
                            </div>
                            <div class="bc-card">
                                <div class="bc-card__header">
                                    <div class="bc-card__title"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polygon points="1 6 1 22 8 18 16 22 23 18 23 2 16 6 8 2 1 6"/><line x1="8" y1="2" x2="8" y2="18"/><line x1="16" y1="6" x2="16" y2="22"/></svg>Karte</div>
                                    <a href="/pages/map.html" target="_blank" class="bc-btn bc-btn--small bc-btn--secondary" style="font-size:10px">Öffnen</a>
                                </div>
                                <div class="bc-card__body" style="padding:12px;text-align:center">
                                    <div id="gmMapPreview" class="gm-feature-preview">
                                        <svg viewBox="0 0 48 48" fill="none" stroke="currentColor" stroke-width="1" opacity="0.2"><polygon points="2 8 2 42 16 34 32 42 46 34 46 2 32 10 16 2 2 8"/><line x1="16" y1="2" x2="16" y2="34"/><line x1="32" y1="10" x2="32" y2="42"/></svg>
                                        <p>Karte in neuem Tab öffnen</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                </div>
            </div>
        </main>
    </div>
    
    <!-- Dock Placeholder -->
    <div id="dock-placeholder"></div>
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    
    <!-- RIFT Services -->
    <script src="/assets/js/firebase-config.js"></script>
    <script src="/assets/js/rift-state.js"></script>
    <script src="/assets/js/riftlink.js"></script>
    <script>
        // Auth Guard - redirect to login if not authenticated
        (function() {
            function waitForAuth() {
                // Wait for Firebase SDK
                if (typeof firebase === 'undefined' || !firebase.auth) {
                    return setTimeout(waitForAuth, 50);
                }
                // Wait for Firebase app initialization
                try {
                    var auth = firebase.auth();
                    auth.onAuthStateChanged(function(user) {
                        if (!user) {
                            window.location.href = '/login';
                        } else {
                            document.body.classList.add('auth-ready');
                        }
                    });
                } catch(e) {
                    // Firebase not initialized yet, retry
                    setTimeout(waitForAuth, 50);
                }
            }
            waitForAuth();
        })();
    </script>

    <script src="/assets/js/room-service.js"></script>
    <script src="/assets/js/user-service.js"></script>
    <script src="/assets/js/pro-status.js"></script>
    <script src="/assets/js/auth.js"></script>
    <script src="/assets/js/ui.js"></script>
    <script src="/assets/js/layout-unified.js"></script>
    <script src="/assets/js/settings.js"></script>
    <script src="/assets/js/transitions.js"></script>
    <script src="/assets/js/app.js"></script>
    <script>initUnifiedLayout();</script>
    <script src="/assets/js/gm-characters.js"></script>
    
    <script>
        // ==================== WORLDS APART DATA MAPS ====================
        const WA_FOKUS_NAMES = {
            fire: { name: 'Feuer', attr: 'KRF', color: '#ff6b35' },
            water: { name: 'Wasser', attr: 'GES', color: '#4dabf7' },
            wind: { name: 'Wind', attr: 'GES', color: '#69db7c' },
            earth: { name: 'Erde', attr: 'ZÄH', color: '#a9845b' },
            air: { name: 'Luft', attr: 'INT', color: '#74c0fc' },
            light: { name: 'Licht', attr: 'PRÄ', color: '#ffd43b' },
            lightning: { name: 'Blitz', attr: 'KRF', color: '#f59f00' },
            shadow: { name: 'Schatten', attr: 'GEI', color: '#495057' },
            illusion: { name: 'Illusion', attr: 'PRÄ', color: '#da77f2' },
            room: { name: 'Raum', attr: 'GEI', color: '#748ffc' },
            time: { name: 'Zeit', attr: 'VER', color: '#d4a574' },
            poison: { name: 'Gift', attr: 'ZÄH', color: '#7cb342' },
            sound: { name: 'Schall', attr: 'PRÄ', color: '#26c6da' },
            none: { name: 'Keiner', attr: '-', color: '#868e96' }
        };
        
        const WA_SCHWAECHE_NAMES = {
            hoehenangst: 'Höhenangst',
            platzangst: 'Platzangst',
            seekrank: 'Seekrank',
            'schlechte-sicht': 'Schlechte Sicht',
            gleichgewicht: 'Gleichgewichtssinn',
            ausdauer: 'Geringe Ausdauer',
            reaktion: 'Langsame Reaktion',
            feinmotorik: 'Feinmotorik',
            zittrig: 'Zittrige Hände',
            verletzungen: 'Verletzungsanfällig',
            hitze: 'Hitzeempfindlich',
            kaelte: 'Kälteempfindlich',
            reizueberflutung: 'Reizüberflutung',
            orientierung: 'Orientierungslos',
            geraeusch: 'Geräuschempfindlich',
            griff: 'Schwacher Griff',
            // Legacy entries
            verlangen: 'Verlangen',
            paranoia: 'Paranoia', 
            trauma: 'Trauma',
            phobia: 'Phobie',
            obsession: 'Obsession',
            sucht: 'Sucht',
            aberglaube: 'Aberglaube',
            aggression: 'Aggression',
            melancholie: 'Melancholie',
            geltungsdrang: 'Geltungsdrang'
        };
        
        // ==================== BROADCAST CENTER ====================
        window.BC = {
            db: null,
            rtdb: null,
            roomCode: null,
            members: [],
            characters: [],
            logs: [],
            banned: [],
            onlineStatus: {},
            pollVotes: [],
            currentPoll: null,
            pollOptionCount: 2,
            selectedBroadcastType: 'info',
            selectedSound: 'none',
            selectedCountdown: 30,
            selectedAmbient: null,
            broadcastImageData: null,
            pollImageData: null,
            revealImageData: null,
            unsubs: [],
            logFilter: 'all',
            logSearch: '',
            
            pollEmojis: ['➊','➋','➌','➍','➎','➏','➐','➑','🅰️','🅱️','✅','❌','👍','👎','❤️','⭐','🔥','💎','🎯','🎲','⚔️','🛡️','💀','👑','🗡️','🏆','💰','🎭','🧙','🐉','🏰','📜','⚡','🌟','💫','🔮'],
            
            // ============ INIT ============
            async init() {
                console.log('[BC] Initializing Broadcast Center...');
                
                // Wait for Firebase SDK to be loaded
                let attempts = 0;
                while (!window.firebase?.firestore || !window.firebase?.auth) {
                    await new Promise(r => setTimeout(r, 100));
                    attempts++;
                    if (attempts > 50) {
                        console.error('[BC] Firebase SDK not available after 5s');
                        return;
                    }
                }
                
                // Initialize Firebase App (IMPORTANT!)
                if (window.RIFT?.firebase?.init) {
                    console.log('[BC] Calling RIFT.firebase.init()...');
                    await window.RIFT.firebase.init();
                } else {
                    // Fallback: Check if already initialized
                    if (!firebase.apps || firebase.apps.length === 0) {
                        console.error('[BC] Firebase not initialized and no init function available');
                        return;
                    }
                }
                
                console.log('[BC] Firebase ready');
                this.db = firebase.firestore();
                
                // Wait for auth state
                const user = await new Promise(resolve => {
                    const unsubscribe = firebase.auth().onAuthStateChanged(u => {
                        unsubscribe();
                        resolve(u);
                    });
                });
                
                console.log('[BC] Auth user:', user?.uid);
                
                if (!user) {
                    console.log('[BC] No user logged in');
                    this.toast('Bitte einloggen!', 'error');
                    return;
                }
                
                // Get and normalize room code
                let rawRoomCode = localStorage.getItem('rift_current_room');
                this.roomCode = rawRoomCode ? rawRoomCode.replace(/-/g, '').toUpperCase() : null;
                console.log('[BC] Room code (raw):', rawRoomCode, '(normalized):', this.roomCode);
                
                if (!this.roomCode) {
                    console.log('[BC] No room code');
                    this.toast('Kein Raum aktiv!', 'error');
                    return;
                }
                
                // Check if user is GM
                const isGM = await this.checkGM(user.uid);
                console.log('[BC] Is GM:', isGM);
                
                if (!isGM) {
                    this.toast('Nur für Spielleiter!', 'error');
                    setTimeout(() => {
                        window.location.href = 'index.html';
                    }, 1500);
                    return;
                }
                
                // Load members
                await this.loadMembers();
                
                // Initialize Realtime Database
                this.rtdb = firebase.database();
                
                // Subscribe to all data
                this.subPoll();
                this.subMembers();
                this.subCharacters();
                this.subPresence();
                this.subBanned();
                this.subLogs();
                
                // Initialize RiftLink-powered Characters Panel
                if (window.RIFT && RIFT.gmChars) {
                    RIFT.gmChars.init(this.roomCode, this.members, (uid) => this.isOnline(uid));
                    console.log('[BC] GM Characters panel initialized via RiftLink');
                }
                
                // Load poll history
                this.loadPollHistory();
                
                // Load GM history (persistent)
                this.loadGmHistory();
                
                // Load templates
                this.loadTemplates();
                
                // Render player statuses
                this.renderPlayerStatuses();
                
                // Initialize new panels
                this.initSettings();
                
                // Initialize Tools panel (chat feed, dice, session status)
                this.initTools();
                
                // Setup countdown toggle
                const countdownCheckbox = document.getElementById('pollCountdown');
                if (countdownCheckbox) {
                    countdownCheckbox.addEventListener('change', (e) => {
                        document.getElementById('countdownField').style.display = e.target.checked ? 'block' : 'none';
                    });
                }
                
                // Setup GM transfer select
                const gmTransferSelect = document.getElementById('gmTransferSelect');
                if (gmTransferSelect) {
                    gmTransferSelect.addEventListener('change', (e) => {
                        document.getElementById('gmTransferBtn').disabled = !e.target.value;
                    });
                }
                
                console.log('[BC] GM Control Center initialized');
                this.toast('GM Kontrollzentrum bereit!', 'success');
            },
            
            escapeHtml(text) {
                const div = document.createElement('div');
                div.textContent = text || '';
                return div.innerHTML;
            },
            
            capitalize(str) {
                if (!str) return '';
                return str.charAt(0).toUpperCase() + str.slice(1);
            },
            
            async checkGM(uid) {
                try {
                    const doc = await this.db.collection('rooms').doc(this.roomCode).get();
                    if (!doc.exists) return false;
                    
                    const gmId = doc.data()?.gmId;
                    console.log('[BC] Room gmId:', gmId, 'User uid:', uid);
                    
                    // Check if user is the main GM
                    if (gmId === uid) return true;
                    
                    // Check if user is Co-GM
                    const memberDoc = await this.db.collection('rooms').doc(this.roomCode)
                        .collection('members').doc(uid).get();
                    
                    if (memberDoc.exists) {
                        const role = memberDoc.data()?.role;
                        console.log('[BC] User role:', role);
                        return role === 'gm' || role === 'cogm';
                    }
                    
                    return false;
                } catch (e) {
                    console.error('[BC] Error checking GM:', e);
                    return false;
                }
            },
            
            ref() {
                if (!this.db) {
                    console.error('[BC] Database not initialized!');
                    this.toast('Datenbank nicht bereit!', 'error');
                    return null;
                }
                return this.db.collection('rooms').doc(this.roomCode);
            },
            
            // ============ MEMBERS ============
            async loadMembers() {
                const ref = this.ref();
                if (!ref) return;
                
                try {
                    const snap = await ref.collection('members').get();
                    this.members = snap.docs.map(d => ({ id: d.id, ...d.data() }));
                    this.renderPlayerSelectors();
                    console.log('[BC] Loaded members:', this.members.length);
                } catch (e) {
                    console.error('[BC] Error loading members:', e);
                }
            },
            
            renderPlayerSelectors() {
                const players = this.members.filter(m => m.id !== firebase.auth().currentUser?.uid);
                
                const html = players.map(p => `
                    <div class="bc-player" data-id="${p.id}" onclick="BC.togglePlayerSelect(this, '${p.id}')">
                        <div class="bc-player__avatar" style="background: ${p.color || '#8b5cf6'};">${(p.name || '?')[0].toUpperCase()}</div>
                        <span class="bc-player__name">${p.name || 'Unbekannt'}</span>
                        <div class="bc-player__check"></div>
                    </div>
                `).join('');
                
                // Broadcast targets (with "All" option)
                const broadcastTargets = document.getElementById('broadcastTargets');
                if (broadcastTargets) {
                    broadcastTargets.innerHTML = `
                        <div class="bc-player selected" data-target="all" onclick="BC.toggleTarget('all')">
                            <div class="bc-player__avatar" style="background: #8b5cf6;"><svg viewBox="0 0 24 24" fill="currentColor" style="width:18px;height:18px;"><path d="M9 11a4 4 0 1 1 0-8 4 4 0 0 1 0 8m8 0a3 3 0 1 0 0-6 3 3 0 0 0 0 6m-8 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4m8 0c-.29 0-.62.02-.97.05 1.16.84 1.97 1.97 1.97 3.45v2h6v-2c0-2.66-4.33-4-7-4"/></svg></div>
                            <span class="bc-player__name">Alle Spieler</span>
                            <div class="bc-player__check"></div>
                        </div>
                        ${html}
                    `;
                }
                
                // Dice Request targets
                const diceTargets = document.getElementById('diceRequestTargets');
                if (diceTargets) {
                    diceTargets.innerHTML = `
                        <div class="bc-player selected" data-target="all" onclick="BC.toggleDiceTarget('all')">
                            <div class="bc-player__avatar" style="background: #8b5cf6;"><svg viewBox="0 0 24 24" fill="currentColor" style="width:18px;height:18px;"><path d="M9 11a4 4 0 1 1 0-8 4 4 0 0 1 0 8m8 0a3 3 0 1 0 0-6 3 3 0 0 0 0 6m-8 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4m8 0c-.29 0-.62.02-.97.05 1.16.84 1.97 1.97 1.97 3.45v2h6v-2c0-2.66-4.33-4-7-4"/></svg></div>
                            <span class="bc-player__name">Alle Spieler</span>
                            <div class="bc-player__check"></div>
                        </div>
                        ${players.map(p => `
                            <div class="bc-player" data-id="${p.id}" onclick="BC.toggleDiceTarget('${p.id}')">
                                <div class="bc-player__avatar" style="background: ${p.color || '#8b5cf6'};">${(p.name || '?')[0].toUpperCase()}</div>
                                <span class="bc-player__name">${p.name || 'Unbekannt'}</span>
                                <div class="bc-player__check"></div>
                            </div>
                        `).join('')}
                    `;
                }
                
                // Spotlight players
                if (document.getElementById('spotlightPlayers')) {
                    document.getElementById('spotlightPlayers').innerHTML = html;
                }
                if (document.getElementById('secretPlayers')) {
                    document.getElementById('secretPlayers').innerHTML = html;
                }
                if (document.getElementById('levelUpPlayers')) {
                    document.getElementById('levelUpPlayers').innerHTML = html;
                }
                if (document.getElementById('deathPlayers')) {
                    document.getElementById('deathPlayers').innerHTML = html;
                }
            },
            
            toggleTarget(target) {
                if (target === 'all') {
                    document.querySelectorAll('#broadcastTargets .bc-player').forEach(p => {
                        p.classList.toggle('selected', p.dataset.target === 'all');
                    });
                } else {
                    document.querySelector('#broadcastTargets .bc-player[data-target="all"]').classList.remove('selected');
                    document.querySelector(`#broadcastTargets .bc-player[data-id="${target}"]`)?.classList.toggle('selected');
                }
            },
            
            toggleDiceTarget(target) {
                if (target === 'all') {
                    document.querySelectorAll('#diceRequestTargets .bc-player').forEach(p => {
                        p.classList.toggle('selected', p.dataset.target === 'all');
                    });
                } else {
                    document.querySelector('#diceRequestTargets .bc-player[data-target="all"]').classList.remove('selected');
                    document.querySelector(`#diceRequestTargets .bc-player[data-id="${target}"]`)?.classList.toggle('selected');
                }
            },
            
            togglePlayerSelect(el, id) {
                const container = el.closest('.bc-players');
                container.querySelectorAll('.bc-player').forEach(p => p.classList.remove('selected'));
                el.classList.add('selected');
            },
            
            // ============ TABS ============
            switchTab(tab) {
                document.querySelectorAll('.broadcast-tab').forEach(t => t.classList.remove('active'));
                document.querySelector(`.broadcast-tab[data-tab="${tab}"]`).classList.add('active');
                
                document.querySelectorAll('.broadcast-panel').forEach(p => p.classList.remove('active'));
                document.getElementById(`panel-${tab}`).classList.add('active');
            },
            
            // ============ BROADCAST ============
            selectType(type) {
                this.selectedBroadcastType = type;
                document.querySelectorAll('#broadcastTypes .bc-type').forEach(t => {
                    t.classList.toggle('active', t.dataset.type === type);
                });
            },
            
            selectSound(sound) {
                this.selectedSound = sound;
                document.querySelectorAll('#broadcastSounds .bc-sound').forEach(s => {
                    s.classList.toggle('active', s.dataset.sound === sound);
                });
            },
            
            previewSound(sound) {
                // TODO: Implement sound preview
                console.log('[BC] Preview sound:', sound);
                this.toast('Sound: ' + sound, 'info');
            },
            
            async handleImageUpload(event, target) {
                const file = event.target.files[0];
                if (!file) return;
                
                this.toast('Bild wird verarbeitet...', 'info');
                
                try {
                    // Compress image
                    const data = await this.compressImage(file, 1200, 0.8);
                    
                    if (target === 'broadcast') {
                        this.broadcastImageData = data;
                        document.getElementById('broadcastImagePreview').src = data;
                        document.getElementById('broadcastImagePreview').style.display = 'block';
                        document.getElementById('broadcastImagePlaceholder').style.display = 'none';
                        document.getElementById('broadcastImageUpload').classList.add('has-image');
                    } else if (target === 'poll') {
                        this.pollImageData = data;
                        document.getElementById('pollImagePreview').src = data;
                        document.getElementById('pollImagePreview').style.display = 'block';
                        document.getElementById('pollImagePlaceholder').style.display = 'none';
                        document.getElementById('pollImageUpload').classList.add('has-image');
                    } else if (target === 'reveal') {
                        this.revealImageData = data;
                        document.getElementById('revealImagePreview').src = data;
                        document.getElementById('revealImagePreview').style.display = 'block';
                        document.getElementById('revealImageUpload').classList.add('has-image');
                    } else if (target === 'location') {
                        this.locationImageData = data;
                        document.getElementById('locationImagePreview').src = data;
                        document.getElementById('locationImagePreview').style.display = 'block';
                        document.getElementById('locationImageUpload').querySelector('.bc-image-upload__placeholder').style.display = 'none';
                        document.getElementById('locationImageUpload').classList.add('has-image');
                    } else if (target === 'boss') {
                        this.bossImageData = data;
                        document.getElementById('bossImagePreview').src = data;
                        document.getElementById('bossImagePreview').style.display = 'block';
                        document.getElementById('bossImageUpload').querySelector('.bc-image-upload__placeholder').style.display = 'none';
                        document.getElementById('bossImageUpload').classList.add('has-image');
                    } else if (target === 'quickHandout') {
                        this.quickHandoutImageData = data;
                        document.getElementById('quickHandoutPreview').src = data;
                        document.getElementById('quickHandoutPreview').style.display = 'block';
                        document.getElementById('quickHandoutUpload').querySelector('.bc-image-upload__placeholder').style.display = 'none';
                        document.getElementById('quickHandoutUpload').classList.add('has-image');
                    }
                } catch (e) {
                    console.error('[BC] Image processing error:', e);
                    this.toast('Fehler beim Verarbeiten', 'error');
                }
            },
            
            async sendBroadcast() {
                const message = document.getElementById('broadcastMessage').value.trim();
                if (!message && !this.broadcastImageData) {
                    this.toast('Nachricht oder Bild erforderlich!', 'error');
                    return;
                }
                
                // Get selected targets
                const allSelected = document.querySelector('#broadcastTargets .bc-player[data-target="all"]').classList.contains('selected');
                let targets = null;
                if (!allSelected) {
                    targets = Array.from(document.querySelectorAll('#broadcastTargets .bc-player.selected'))
                        .map(p => p.dataset.id)
                        .filter(id => id);
                }
                
                const typeLabels = {
                    info: 'Info', warning: 'Warnung', danger: 'Gefahr',
                    success: 'Erfolg', epic: 'Episch', mystery: 'Mysteriös'
                };
                
                try {
                    await this.ref().update({
                        broadcast: {
                            message,
                            type: this.selectedBroadcastType,
                            sound: this.selectedSound,
                            image: this.broadcastImageData || null,
                            targets,
                            id: Date.now(),
                            timestamp: firebase.firestore.FieldValue.serverTimestamp()
                        }
                    });
                    
                    // Clear form
                    document.getElementById('broadcastMessage').value = '';
                    this.broadcastImageData = null;
                    document.getElementById('broadcastImagePreview').style.display = 'none';
                    document.getElementById('broadcastImagePlaceholder').style.display = 'flex';
                    document.getElementById('broadcastImageUpload').classList.remove('has-image');
                    
                    this.addToHistory('broadcast', `${typeLabels[this.selectedBroadcastType] || 'Broadcast'}: ${message.substring(0, 50)}${message.length > 50 ? '...' : ''}`);
                    this.toast('Broadcast gesendet!', 'success');
                } catch (e) {
                    console.error('[BC] Broadcast error:', e);
                    this.toast('Fehler beim Senden', 'error');
                }
            },
            
            // ============ POLL ============
            subPoll() {
                // Subscribe to room for poll config
                const u = this.ref().onSnapshot(doc => {
                    const poll = doc.data()?.poll;
                    if (poll?.active) {
                        document.getElementById('activePoll').style.display = 'block';
                        document.getElementById('activePollQuestion').textContent = poll.question;
                        this.currentPoll = poll;
                        this.updatePollResults();
                        
                        // Start or update countdown
                        if (poll.countdown && poll.startedAt) {
                            this.startGMCountdown(poll.countdown, poll.startedAt);
                        } else {
                            document.getElementById('activePollCountdown').textContent = '';
                        }
                    } else {
                        document.getElementById('activePoll').style.display = 'none';
                        this.currentPoll = null;
                        this.stopGMCountdown();
                    }
                });
                this.unsubs.push(u);
                
                // Subscribe to poll_votes subcollection
                const v = this.ref().collection('poll_votes').onSnapshot(snap => {
                    this.pollVotes = snap.docs.map(d => ({ oderId: d.id, ...d.data() }));
                    this.updatePollResults();
                });
                this.unsubs.push(v);
            },
            
            gmCountdownInterval: null,
            
            startGMCountdown(countdown, startedAt) {
                this.stopGMCountdown();
                
                const startTime = startedAt?.toDate?.() || new Date(startedAt);
                const endTime = new Date(startTime.getTime() + countdown * 1000);
                
                const update = () => {
                    const now = new Date();
                    const remaining = Math.max(0, Math.ceil((endTime - now) / 1000));
                    document.getElementById('activePollCountdown').textContent = remaining > 0 ? `${remaining}s` : 'Abgelaufen';
                };
                
                update();
                this.gmCountdownInterval = setInterval(update, 1000);
            },
            
            stopGMCountdown() {
                if (this.gmCountdownInterval) {
                    clearInterval(this.gmCountdownInterval);
                    this.gmCountdownInterval = null;
                }
            },
            
            updatePollResults() {
                if (!this.currentPoll) return;
                const el = document.getElementById('activePollResults');
                const votersEl = document.getElementById('activePollVoters');
                const options = this.currentPoll.options || [];
                const emojis = this.currentPoll.emojis || [];
                const showVoters = this.currentPoll.showVoters;
                
                // Count votes from subcollection (support both single and multi-select)
                const voteCounts = {};
                const votersByOption = {};
                options.forEach(opt => {
                    voteCounts[opt] = 0;
                    votersByOption[opt] = [];
                });
                
                (this.pollVotes || []).forEach(vote => {
                    // Support multi-select (options array) and single select (option string)
                    const voteOptions = vote.options || (vote.option ? [vote.option] : []);
                    voteOptions.forEach(opt => {
                        if (voteCounts.hasOwnProperty(opt)) {
                            voteCounts[opt]++;
                            // Get voter name
                            const member = this.members.find(m => m.id === vote.oderId);
                            const voterName = member?.name || 'Unbekannt';
                            votersByOption[opt].push(voterName);
                        }
                    });
                });
                
                const total = Object.values(voteCounts).reduce((a, b) => a + b, 0) || 1;
                
                el.innerHTML = options.map((opt, i) => {
                    const count = voteCounts[opt] || 0;
                    const pct = Math.round((count / total) * 100);
                    const emoji = emojis[i] || '';
                    const label = emoji ? `${emoji} ${opt}` : opt;
                    const voters = showVoters && votersByOption[opt].length > 0 
                        ? `<div style="font-size: 11px; color: rgba(255,255,255,0.4); margin-top: 4px;">${votersByOption[opt].join(', ')}</div>` 
                        : '';
                    return `<div class="bc-active__result">
                        <span class="bc-active__result-label">${label}</span>
                        <div class="bc-active__result-bar">
                            <div class="bc-active__result-fill" style="width:${pct}%"></div>
                            <span class="bc-active__result-count">${count}</span>
                        </div>
                        ${voters}
                    </div>`;
                }).join('');
                
                // Show total voters
                const totalVoters = (this.pollVotes || []).length;
                if (votersEl) {
                    votersEl.textContent = `${totalVoters} Stimme${totalVoters !== 1 ? 'n' : ''} abgegeben`;
                }
            },
            
            setPollPreset(preset) {
                const container = document.getElementById('pollOptions');
                
                let options = [];
                let emojis = [];
                
                if (preset === 'yesno') {
                    options = ['Ja', 'Nein'];
                    emojis = ['✅', '❌'];
                } else if (preset === 'abc') {
                    options = ['A', 'B', 'C'];
                    emojis = ['🅰️', '🅱️', '©️'];
                } else if (preset === 'numbers') {
                    options = ['1', '2', '3', '4', '5'];
                    emojis = ['➊', '➋', '➌', '➍', '➎'];
                } else if (preset === 'werewolf') {
                    // Load players as options
                    const players = this.members.filter(m => m.id !== firebase.auth().currentUser?.uid);
                    options = players.map(p => p.name || 'Unbekannt');
                    emojis = players.map(() => '🎭');
                }
                
                container.innerHTML = options.map((opt, i) => `
                    <div class="bc-poll-option" data-index="${i}">
                        <button class="bc-poll-option__emoji" onclick="BC.openEmojiPicker(${i})">${emojis[i] || this.pollEmojis[i]}</button>
                        <input type="text" class="bc-input bc-poll-option__input" placeholder="Option ${i + 1}" value="${opt}">
                        ${i > 1 ? `<button class="bc-poll-option__remove" onclick="BC.removePollOption(${i})">✕</button>` : ''}
                    </div>
                `).join('');
                
                this.pollOptionCount = options.length;
            },
            
            addPollOption() {
                if (this.pollOptionCount >= 10) {
                    this.toast('Maximum 10 Optionen', 'error');
                    return;
                }
                
                const container = document.getElementById('pollOptions');
                const index = this.pollOptionCount;
                const emoji = this.pollEmojis[index] || '⭐';
                
                const row = document.createElement('div');
                row.className = 'bc-poll-option';
                row.dataset.index = index;
                row.innerHTML = `
                    <button class="bc-poll-option__emoji" onclick="BC.openEmojiPicker(${index})">${emoji}</button>
                    <input type="text" class="bc-input bc-poll-option__input" placeholder="Option ${index + 1}">
                    <button class="bc-poll-option__remove" onclick="BC.removePollOption(${index})">✕</button>
                `;
                container.appendChild(row);
                this.pollOptionCount++;
                
                row.querySelector('input').focus();
            },
            
            removePollOption(index) {
                const row = document.querySelector(`.bc-poll-option[data-index="${index}"]`);
                if (row) {
                    row.remove();
                    this.pollOptionCount--;
                }
            },
            
            openEmojiPicker(index) {
                // Simple emoji picker - could be enhanced
                const emojis = this.pollEmojis;
                const picker = document.createElement('div');
                picker.className = 'emoji-picker-modal';
                picker.style.cssText = `
                    position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
                    background: #1a1a1a; border: 1px solid rgba(255,255,255,0.1); border-radius: 12px;
                    padding: 16px; z-index: 10000; max-width: 320px;
                    display: grid; grid-template-columns: repeat(8, 1fr); gap: 4px;
                `;
                picker.innerHTML = emojis.map(e => `
                    <button style="width:36px;height:36px;background:transparent;border:none;font-size:20px;cursor:pointer;border-radius:6px;"
                        onmouseover="this.style.background='rgba(255,255,255,0.1)'"
                        onmouseout="this.style.background='transparent'"
                        selectPollEmoji?.(${index}, '${e}'); this.closest('.emoji-picker-modal').remove()">
                        ${e}
                    </button>
                `).join('');
                
                // Backdrop
                const backdrop = document.createElement('div');
                backdrop.style.cssText = 'position:fixed;inset:0;background:rgba(0,0,0,0.5);z-index:9999;';
                backdrop.onclick = () => { backdrop.remove(); picker.remove(); };
                
                document.body.appendChild(backdrop);
                document.body.appendChild(picker);
            },
            
            selectPollEmoji(index, emoji) {
                const btn = document.querySelector(`.bc-poll-option[data-index="${index}"] .bc-poll-option__emoji`);
                if (btn) btn.textContent = emoji;
            },
            
            setCountdown(seconds) {
                this.selectedCountdown = seconds;
                document.querySelectorAll('.bc-countdown-selector .bc-countdown-btn').forEach(b => {
                    b.classList.toggle('active', parseInt(b.dataset.time) === seconds);
                });
            },
            
            async startPoll() {
                const question = document.getElementById('pollQuestion').value.trim();
                if (!question) {
                    this.toast('Frage eingeben!', 'error');
                    return;
                }
                
                // Collect options
                const options = [];
                const emojis = [];
                document.querySelectorAll('.bc-poll-option').forEach(row => {
                    const input = row.querySelector('input');
                    const emojiBtn = row.querySelector('.bc-poll-option__emoji');
                    const text = input.value.trim();
                    if (text) {
                        options.push(text);
                        emojis.push(emojiBtn.textContent);
                    }
                });
                
                if (options.length < 2) {
                    this.toast('Mindestens 2 Optionen!', 'error');
                    return;
                }
                
                const withCountdown = document.getElementById('pollCountdown').checked;
                const withMultiple = document.getElementById('pollMultiple').checked;
                const withBlind = document.getElementById('pollBlind').checked;
                const showVoters = document.getElementById('pollShowVoters').checked;
                const noEmojis = document.getElementById('pollNoEmojis').checked;
                const withSound = document.getElementById('pollSound').checked;
                
                try {
                    // Delete old votes first
                    const votesSnap = await this.ref().collection('poll_votes').get();
                    const batch = this.db.batch();
                    votesSnap.docs.forEach(doc => batch.delete(doc.ref));
                    if (votesSnap.docs.length) await batch.commit();
                    
                    const pollData = {
                        question,
                        options,
                        emojis: noEmojis ? [] : emojis,
                        withSound,
                        withCountdown,
                        multiSelect: withMultiple,
                        blindVote: withBlind,
                        showVoters,
                        image: this.pollImageData || null,
                        active: true,
                        resolved: false,
                        countdown: withCountdown ? this.selectedCountdown : null,
                        startedAt: firebase.firestore.FieldValue.serverTimestamp(),
                        timestamp: Date.now()
                    };
                    
                    await this.ref().update({ poll: pollData });
                    
                    // Clear form
                    document.getElementById('pollQuestion').value = '';
                    this.pollImageData = null;
                    document.getElementById('pollImagePreview').style.display = 'none';
                    document.getElementById('pollImagePlaceholder').style.display = 'flex';
                    
                    this.addToHistory('poll', `Umfrage: ${question}`);
                    this.toast('Umfrage gestartet!', 'success');
                } catch (e) {
                    console.error('[BC] Poll error:', e);
                    this.toast('Fehler', 'error');
                }
            },
            
            async resolvePoll() {
                if (!this.currentPoll) return;
                
                try {
                    console.log('[BC] Resolving poll...');
                    const options = this.currentPoll.options || [];
                    const emojis = this.currentPoll.emojis || [];
                    const voteCounts = {};
                    options.forEach(opt => voteCounts[opt] = 0);
                    
                    // Support both single and multi-select votes
                    this.pollVotes.forEach(vote => {
                        const voteOptions = vote.options || (vote.option ? [vote.option] : []);
                        voteOptions.forEach(opt => {
                            if (voteCounts.hasOwnProperty(opt)) {
                                voteCounts[opt]++;
                            }
                        });
                    });
                    
                    const maxVotes = Math.max(...Object.values(voteCounts), 0);
                    
                    const results = options.map((opt, i) => ({
                        option: opt,
                        emoji: emojis[i] || '',
                        votes: voteCounts[opt],
                        isWinner: voteCounts[opt] === maxVotes && maxVotes > 0,
                        voters: this.currentPoll.showVoters ? 
                            this.pollVotes.filter(v => v.option === opt).map(v => {
                                const member = this.members.find(m => m.id === v.oderId);
                                return member?.name || 'Unbekannt';
                            }) : null
                    }));
                    
                    const resolvedPoll = {
                        ...this.currentPoll,
                        active: false,
                        resolved: true,
                        results,
                        totalVotes: Object.values(voteCounts).reduce((a, b) => a + b, 0),
                        resolvedAt: Date.now()
                    };
                    
                    // Save to pollHistory array in room document (keep last 10)
                    const historyEntry = {
                        question: this.currentPoll.question,
                        options,
                        emojis,
                        results,
                        totalVotes: resolvedPoll.totalVotes,
                        resolvedAt: Date.now()
                    };
                    
                    // Get current history and add new entry
                    const currentHistory = this.pollHistory || [];
                    const newHistory = [historyEntry, ...currentHistory].slice(0, 10);
                    
                    console.log('[BC] Saving poll history:', newHistory);
                    
                    await this.ref().update({ 
                        poll: resolvedPoll,
                        pollHistory: newHistory
                    });
                    
                    // Update local history
                    this.pollHistory = newHistory;
                    this.renderPollHistory();
                    
                    console.log('[BC] Poll resolved and history saved');
                    this.toast('Umfrage aufgelöst!', 'success');
                } catch (e) {
                    console.error('[BC] Resolve error:', e);
                    this.toast('Fehler', 'error');
                }
            },
            
            pollHistory: [],
            
            async loadPollHistory() {
                try {
                    console.log('[BC] Loading poll history...');
                    // Load pollHistory from room document
                    const doc = await this.ref().get();
                    const data = doc.data();
                    console.log('[BC] Poll history data:', data?.pollHistory);
                    this.pollHistory = data?.pollHistory || [];
                    this.renderPollHistory();
                } catch (e) {
                    console.error('[BC] Load poll history error:', e);
                }
            },
            
            renderPollHistory() {
                const container = document.getElementById('pollHistory');
                if (!container) return;
                
                if (!this.pollHistory || this.pollHistory.length === 0) {
                    container.innerHTML = `
                        <div class="bc-empty">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M18 20V10M12 20V4M6 20v-6"/></svg>
                            <div class="bc-empty__title">Keine Umfragen</div>
                            <p>Vergangene Umfragen erscheinen hier</p>
                        </div>
                    `;
                    return;
                }
                
                let html = '';
                this.pollHistory.forEach(poll => {
                    const winner = poll.results?.find(r => r.isWinner);
                    const date = poll.resolvedAt ? new Date(poll.resolvedAt) : new Date();
                    const timeStr = date.toLocaleDateString('de-DE', { day: '2-digit', month: '2-digit' }) + 
                                   ' ' + date.toLocaleTimeString('de-DE', { hour: '2-digit', minute: '2-digit' });
                    
                    html += `
                        <div style="padding: 12px; background: rgba(255,255,255,0.02); border-radius: 8px; margin-bottom: 8px;">
                            <div style="font-weight: 500; color: var(--text-primary);">${this.escapeHtml(poll.question)}</div>
                            <div style="display: flex; justify-content: space-between; margin-top: 8px; font-size: 13px; color: var(--text-muted);">
                                <span>🏆 ${winner ? `${winner.emoji || ''} ${this.escapeHtml(winner.option)} (${winner.votes})` : 'Unentschieden'}</span>
                                <span>${poll.totalVotes} Stimmen • ${timeStr}</span>
                            </div>
                        </div>
                    `;
                });
                
                container.innerHTML = html;
            },
            
            async closePoll() {
                if (!this.currentPoll) {
                    await this.ref().update({ 'poll.active': false });
                    this.toast('Umfrage geschlossen', 'success');
                    return;
                }
                
                try {
                    // Also save to history when closing (without resolving)
                    const options = this.currentPoll.options || [];
                    const emojis = this.currentPoll.emojis || [];
                    const voteCounts = {};
                    options.forEach(opt => voteCounts[opt] = 0);
                    
                    this.pollVotes.forEach(vote => {
                        const voteOptions = vote.options || (vote.option ? [vote.option] : []);
                        voteOptions.forEach(opt => {
                            if (voteCounts.hasOwnProperty(opt)) {
                                voteCounts[opt]++;
                            }
                        });
                    });
                    
                    const maxVotes = Math.max(...Object.values(voteCounts), 0);
                    
                    const results = options.map((opt, i) => ({
                        option: opt,
                        emoji: emojis[i] || '',
                        votes: voteCounts[opt],
                        isWinner: voteCounts[opt] === maxVotes && maxVotes > 0
                    }));
                    
                    const historyEntry = {
                        question: this.currentPoll.question,
                        options,
                        emojis,
                        results,
                        totalVotes: Object.values(voteCounts).reduce((a, b) => a + b, 0),
                        resolvedAt: Date.now()
                    };
                    
                    const currentHistory = this.pollHistory || [];
                    const newHistory = [historyEntry, ...currentHistory].slice(0, 10);
                    
                    await this.ref().update({ 
                        'poll.active': false,
                        pollHistory: newHistory
                    });
                    
                    this.pollHistory = newHistory;
                    this.renderPollHistory();
                    
                    this.toast('Umfrage geschlossen', 'success');
                } catch (e) {
                    console.error('[BC] Close poll error:', e);
                    this.toast('Fehler', 'error');
                }
            },
            
            // ============ REACTIONS ============
            selectedCustomEmoji: '🎉',
            emojiPickerInitialized: false,
            
            toggleEmojiPicker() {
                const picker = document.getElementById('emojiPicker');
                const isHidden = picker.style.display === 'none';
                
                // Initialize emoji grid on first open
                if (!this.emojiPickerInitialized && isHidden) {
                    const grid = document.getElementById('emojiPickerGrid');
                    const emojis = ['😀','😃','😄','😁','😅','😂','🤣','😊','😇','🙂','😉','😍','🥰','😘','😋','😛','😜','🤪','🤗','🤭','🤫','🤔','😏','🙄','😬','😲','😳','🥺','😢','😭','😱','😤','😡','🤬','😈','👿','💀','☠️','💩','🤡','👹','👺','👻','👽','👾','🤖','💪','👊','✊','👏','🙌','🤝','🙏','👍','👎','👀','🧠','❤️','🔥','⭐','✨','💫','🌟','💥','💢','💦','🎉','🎊','🏆','👑','💎','🎭','🎪','🎯','🎲','🗡️','⚔️','🛡️','🏹','🔮','🧿','📜','📚','🗝️','⚡','💨','🌊','❄️','☀️','🌙','🐉','🐲','🦄','🐺','🦊','🐻','🦁','🐯','🧙','🧝','🧛','🧟','👹','💀','☠️','⚰️','🪦','🕯️'];
                    grid.innerHTML = emojis.map(e => 
                        `<span class="emoji-pick" onclick="BC.selectEmoji('${e}')">${e}</span>`
                    ).join('');
                    this.emojiPickerInitialized = true;
                }
                
                picker.style.display = isHidden ? 'block' : 'none';
            },
            
            selectEmoji(emoji) {
                this.selectedCustomEmoji = emoji;
                document.getElementById('selectedEmoji').textContent = emoji;
                document.getElementById('emojiPicker').style.display = 'none';
            },
            
            async sendReaction(type, emoji) {
                const withSound = document.getElementById('reactionSound')?.checked !== false;
                
                try {
                    await this.ref().update({
                        broadcast: {
                            message: '',
                            type: 'reaction',
                            emoji,
                            sound: withSound ? 'notification' : 'none',
                            id: Date.now(),
                            timestamp: firebase.firestore.FieldValue.serverTimestamp()
                        }
                    });
                    this.addToHistory('reaction', `Reaktion: ${emoji}`);
                    this.toast(`${emoji} gesendet!`, 'success');
                } catch (e) {
                    this.toast('Fehler', 'error');
                }
            },
            
            async sendCustomReaction() {
                const noEmoji = document.getElementById('reactionNoEmoji')?.checked;
                const emoji = noEmoji ? '' : this.selectedCustomEmoji;
                const text = document.getElementById('customReactionText').value.trim();
                
                // Require at least emoji or text
                if (!emoji && !text) {
                    this.toast('Text eingeben!', 'error');
                    return;
                }
                
                const withSound = document.getElementById('reactionSound')?.checked !== false;
                
                try {
                    await this.ref().update({
                        broadcast: {
                            message: text,
                            type: 'reaction',
                            emoji: emoji,
                            sound: withSound ? 'notification' : 'none',
                            id: Date.now(),
                            timestamp: firebase.firestore.FieldValue.serverTimestamp()
                        }
                    });
                    
                    document.getElementById('customReactionText').value = '';
                    this.addToHistory('reaction', `Reaktion: ${emoji || ''} ${text}`.trim());
                    this.toast('Reaktion gesendet!', 'success');
                } catch (e) {
                    this.toast('Fehler', 'error');
                }
            },
            
            // ============ SPOTLIGHT ============
            async sendSpotlight() {
                const selected = document.querySelector('#spotlightPlayers .bc-player.selected');
                if (!selected) {
                    this.toast('Spieler auswählen!', 'error');
                    return;
                }
                
                const playerId = selected.dataset.id;
                const playerName = selected.querySelector('.bc-player__name').textContent;
                const message = document.getElementById('spotlightMessage').value.trim();
                
                try {
                    await this.ref().update({
                        broadcast: {
                            type: 'spotlight',
                            targetId: playerId,
                            targetName: playerName,
                            message: message || 'Du bist dran!',
                            sound: 'fanfare',
                            id: Date.now(),
                            timestamp: firebase.firestore.FieldValue.serverTimestamp()
                        }
                    });
                    this.addToHistory('spotlight', `Spotlight: ${playerName}`);
                    this.toast('Spotlight aktiviert!', 'success');
                } catch (e) {
                    this.toast('Fehler', 'error');
                }
            },
            
            async sendSecretMessage() {
                const selected = document.querySelector('#secretPlayers .bc-player.selected');
                if (!selected) {
                    this.toast('Empfänger auswählen!', 'error');
                    return;
                }
                
                const message = document.getElementById('secretMessage').value.trim();
                if (!message) {
                    this.toast('Nachricht eingeben!', 'error');
                    return;
                }
                
                const playerId = selected.dataset.id;
                const playerName = selected.querySelector('.bc-player__name').textContent;
                const withSound = document.getElementById('secretSound')?.checked;
                
                try {
                    await this.ref().update({
                        broadcast: {
                            type: 'secret',
                            message,
                            targets: [playerId],
                            sound: withSound ? 'mystery' : 'none',
                            id: Date.now(),
                            timestamp: firebase.firestore.FieldValue.serverTimestamp()
                        }
                    });
                    
                    document.getElementById('secretMessage').value = '';
                    this.addToHistory('secret', `Geheime Nachricht an ${playerName}`);
                    this.toast('Geheime Nachricht gesendet!', 'success');
                } catch (e) {
                    this.toast('Fehler', 'error');
                }
            },
            
            // ============ DICE REQUEST ============
            async sendDiceRequest() {
                const type = document.getElementById('diceRequestType').value;
                const desc = document.getElementById('diceRequestDesc').value.trim();
                
                // Get selected targets
                const selectedAll = document.querySelector('#diceRequestTargets .bc-player[data-target="all"].selected');
                let targets = null;
                
                if (!selectedAll) {
                    const selectedPlayers = document.querySelectorAll('#diceRequestTargets .bc-player.selected[data-id]');
                    if (selectedPlayers.length === 0) {
                        this.toast('Mindestens einen Empfänger wählen!', 'error');
                        return;
                    }
                    targets = Array.from(selectedPlayers).map(p => p.dataset.id);
                }
                
                try {
                    await this.ref().update({
                        broadcast: {
                            type: 'diceRequest',
                            diceType: type,
                            description: desc || 'Würfelprobe',
                            targets: targets,
                            sound: 'notification',
                            id: Date.now(),
                            timestamp: firebase.firestore.FieldValue.serverTimestamp()
                        }
                    });
                    
                    document.getElementById('diceRequestDesc').value = '';
                    this.addToHistory('diceRequest', `Würfelanforderung: ${type.toUpperCase()}`);
                    this.toast('Würfelanforderung gesendet!', 'success');
                } catch (e) {
                    this.toast('Fehler', 'error');
                }
            },
            
            // ============ HANDOUT ============
            async previewHandout(event) {
                const file = event.target.files[0];
                if (!file) return;
                
                this.toast('Bild wird verarbeitet...', 'info');
                
                try {
                    const compressedData = await this.compressImage(file, 1200, 0.8);
                    this.handoutImageData = compressedData;
                    
                    document.getElementById('handoutPreview').src = compressedData;
                    document.getElementById('handoutPreview').style.display = 'block';
                    document.getElementById('handoutPlaceholder').style.display = 'none';
                    document.getElementById('handoutUpload').classList.add('has-image');
                } catch (e) {
                    console.error('[Handout]', e);
                    this.toast('Fehler beim Verarbeiten', 'error');
                }
            },
            
            handoutImageData: null,
            
            async sendHandout() {
                if (!this.handoutImageData) {
                    this.toast('Bild hochladen!', 'error');
                    return;
                }
                
                const withSound = document.getElementById('handoutSound')?.checked;
                
                try {
                    await this.ref().update({
                        broadcast: {
                            type: 'handout',
                            image: this.handoutImageData,
                            sound: withSound ? 'notification' : 'none',
                            id: Date.now(),
                            timestamp: firebase.firestore.FieldValue.serverTimestamp()
                        }
                    });
                    
                    // Reset
                    this.handoutImageData = null;
                    document.getElementById('handoutPreview').style.display = 'none';
                    document.getElementById('handoutPlaceholder').style.display = 'flex';
                    document.getElementById('handoutUpload').classList.remove('has-image');
                    
                    this.addToHistory('handout', 'Handout gesendet');
                    this.toast('Handout gesendet!', 'success');
                } catch (e) {
                    console.error('[Handout]', e);
                    this.toast('Fehler beim Senden', 'error');
                }
            },
            
            // Image compression helper
            compressImage(file, maxSize = 1200, quality = 0.8) {
                return new Promise((resolve) => {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        const img = new Image();
                        img.onload = () => {
                            const canvas = document.createElement('canvas');
                            let { width, height } = img;
                            
                            // Scale down if larger than maxSize
                            if (width > maxSize || height > maxSize) {
                                if (width > height) {
                                    height = (height / width) * maxSize;
                                    width = maxSize;
                                } else {
                                    width = (width / height) * maxSize;
                                    height = maxSize;
                                }
                            }
                            
                            canvas.width = width;
                            canvas.height = height;
                            
                            const ctx = canvas.getContext('2d');
                            ctx.drawImage(img, 0, 0, width, height);
                            
                            resolve(canvas.toDataURL('image/jpeg', quality));
                        };
                        img.src = e.target.result;
                    };
                    reader.readAsDataURL(file);
                });
            },
            
            // ============ CINEMATIC ============
            openCinematic(type) {
                // Hide all cinematic cards
                document.querySelectorAll('[id^="cinematic"]').forEach(el => el.style.display = 'none');
                
                // Show selected
                const card = document.getElementById('cinematic' + type.charAt(0).toUpperCase() + type.slice(1));
                if (card) card.style.display = 'block';
            },
            
            closeCinematic() {
                document.querySelectorAll('[id^="cinematic"]').forEach(el => el.style.display = 'none');
            },
            
            setSceneStyle(style) {
                this.selectedSceneStyle = style;
                document.querySelectorAll('#sceneStyleBtns .bc-countdown-btn').forEach(b => {
                    b.classList.toggle('active', b.dataset.style === style);
                });
            },
            
            async sendSceneTransition() {
                const text = document.getElementById('sceneText').value.trim();
                const style = document.querySelector('#sceneCard .bc-countdown-btn.active')?.dataset.style || 'fade';
                const withSound = document.getElementById('sceneSound')?.checked;
                
                if (!text) {
                    this.toast('Text eingeben!', 'error');
                    return;
                }
                
                try {
                    await this.ref().update({
                        broadcast: {
                            type: 'scene',
                            text,
                            style,
                            sound: withSound ? 'dramatic' : 'none',
                            id: Date.now(),
                            timestamp: firebase.firestore.FieldValue.serverTimestamp()
                        }
                    });
                    
                    document.getElementById('sceneText').value = '';
                    this.closeCinematic();
                    this.addToHistory('scene', `Szene: ${text}`);
                    this.toast('Szenen-Übergang gesendet!', 'success');
                } catch (e) {
                    this.toast('Fehler', 'error');
                }
            },
            
            async sendReveal() {
                if (!this.revealImageData) {
                    this.toast('Bild hochladen!', 'error');
                    return;
                }
                
                const title = document.getElementById('revealTitle').value.trim();
                const withSound = document.getElementById('revealSound')?.checked !== false;
                
                try {
                    await this.ref().update({
                        broadcast: {
                            type: 'reveal',
                            image: this.revealImageData,
                            title,
                            sound: withSound ? 'dramatic' : 'none',
                            id: Date.now(),
                            timestamp: firebase.firestore.FieldValue.serverTimestamp()
                        }
                    });
                    
                    this.revealImageData = null;
                    document.getElementById('revealImagePreview').style.display = 'none';
                    document.getElementById('revealTitle').value = '';
                    this.closeCinematic();
                    this.addToHistory('reveal', `Reveal: ${title || 'Bild'}`);
                    this.toast('Reveal gesendet!', 'success');
                } catch (e) {
                    this.toast('Fehler', 'error');
                }
            },
            
            async sendCombatStart() {
                const title = document.getElementById('combatTitle').value.trim() || 'Ein Kampf beginnt!';
                const subtitle = document.getElementById('combatSubtitle').value.trim() || 'Macht euch bereit.';
                const withSound = document.getElementById('combatSound')?.checked === true;
                const withParticles = document.getElementById('combatParticles')?.checked !== false;
                
                try {
                    await this.ref().update({
                        broadcast: {
                            type: 'combat',
                            title,
                            subtitle,
                            sound: withSound ? 'combat' : 'none',
                            particles: withParticles,
                            id: Date.now(),
                            timestamp: firebase.firestore.FieldValue.serverTimestamp()
                        }
                    });
                    
                    this.closeCinematic();
                    this.addToHistory('combat', `Kampf: ${title}`);
                    this.toast('Kampf gestartet!', 'success');
                } catch (e) {
                    this.toast('Fehler', 'error');
                }
            },
            
            selectAmbient(ambient) {
                this.selectedAmbient = ambient;
                document.querySelectorAll('[data-ambient]').forEach(c => {
                    c.classList.toggle('selected', c.dataset.ambient === ambient);
                });
            },
            
            async sendAmbient(type) {
                const effectNames = {
                    rain: 'Regen', storm: 'Gewitter', snow: 'Schnee', fog: 'Nebel',
                    fire: 'Feuer', darkness: 'Dunkelheit', magic: 'Magie', blood: 'Blut',
                    underwater: 'Unterwasser', poison: 'Gift', holy: 'Heilig',
                    sea: 'Auf See', forest: 'Wald', desert: 'Wüste', cave: 'Höhle',
                    stars: 'Sterne', ash: 'Asche', clear: 'Aus'
                };
                
                try {
                    await this.ref().update({
                        broadcast: {
                            type: 'ambient',
                            effect: type,
                            sound: 'none',
                            id: Date.now(),
                            timestamp: firebase.firestore.FieldValue.serverTimestamp()
                        }
                    });
                    
                    this.addToHistory('ambient', `Atmosphäre: ${effectNames[type] || type}`);
                    this.toast(type === 'clear' ? 'Effekt beendet!' : `${effectNames[type] || type} aktiviert!`, 'success');
                } catch (e) {
                    this.toast('Fehler', 'error');
                }
            },
            
            // ============ QUICK-TOAST ============
            async quickToast(message) {
                try {
                    await this.ref().update({
                        broadcast: {
                            type: 'toast',
                            message,
                            sound: 'none',
                            id: Date.now(),
                            timestamp: firebase.firestore.FieldValue.serverTimestamp()
                        }
                    });
                    this.addToHistory('toast', `Toast: ${message}`);
                } catch (e) {
                    this.toast('Fehler', 'error');
                }
            },
            
            async sendCustomToast() {
                const text = document.getElementById('customToastText').value.trim();
                if (!text) {
                    this.toast('Text eingeben!', 'error');
                    return;
                }
                await this.quickToast(text);
                document.getElementById('customToastText').value = '';
                this.toast('Toast gesendet!', 'success');
            },
            
            // ============ TIMER ============
            async startTimer(seconds, label = '') {
                try {
                    await this.ref().update({
                        broadcast: {
                            type: 'timer',
                            seconds,
                            label: label || `${seconds}s Timer`,
                            startTime: Date.now(),
                            sound: 'none',
                            id: Date.now(),
                            timestamp: firebase.firestore.FieldValue.serverTimestamp()
                        }
                    });
                    this.addToHistory('timer', `Timer: ${label || seconds + 's'}`);
                    this.toast(`Timer gestartet: ${seconds}s`, 'success');
                } catch (e) {
                    this.toast('Fehler', 'error');
                }
            },
            
            startCustomTimer() {
                const seconds = parseInt(document.getElementById('customTimerSeconds').value) || 60;
                const label = document.getElementById('timerLabel').value.trim();
                this.startTimer(seconds, label);
                document.getElementById('customTimerSeconds').value = '';
                document.getElementById('timerLabel').value = '';
            },
            
            async cancelTimer() {
                try {
                    await this.ref().update({
                        broadcast: {
                            type: 'cancelTimer',
                            id: Date.now(),
                            timestamp: firebase.firestore.FieldValue.serverTimestamp()
                        }
                    });
                    this.toast('Timer abgebrochen', 'success');
                } catch (e) {
                    this.toast('Fehler', 'error');
                }
            },
            
            // ============ TEMPLATES ============
            templates: [],
            
            loadTemplates() {
                const saved = localStorage.getItem('rift_broadcast_templates');
                this.templates = saved ? JSON.parse(saved) : [];
                this.renderTemplates();
            },
            
            saveTemplate() {
                const message = document.getElementById('broadcastMessage').value.trim();
                const type = this.selectedBroadcastType;
                
                if (!message) {
                    this.toast('Erst eine Nachricht eingeben!', 'error');
                    return;
                }
                
                const name = prompt('Template-Name:');
                if (!name) return;
                
                this.templates.push({ name, message, type });
                localStorage.setItem('rift_broadcast_templates', JSON.stringify(this.templates));
                this.renderTemplates();
                this.toast('Template gespeichert!', 'success');
            },
            
            renderTemplates() {
                const container = document.getElementById('templateList');
                if (!container) return;
                
                if (this.templates.length === 0) {
                    container.innerHTML = '<span style="color: var(--text-muted); font-size: 13px;">Keine Templates gespeichert</span>';
                    return;
                }
                
                container.innerHTML = this.templates.map((t, i) => `
                    <div class="bc-template" style="display: flex; align-items: center; gap: 6px; background: rgba(255,255,255,0.05); padding: 6px 10px; border-radius: 6px; cursor: pointer;" onclick="BC.useTemplate(${i})">
                        <span style="font-size: 13px;">${this.escapeHtml(t.name)}</span>
                        <button class="bc-btn bc-btn--small" style="padding: 2px 6px; font-size: 10px;" onclick="event.stopPropagation(); BC.deleteTemplate(${i})">✕</button>
                    </div>
                `).join('');
            },
            
            useTemplate(index) {
                const t = this.templates[index];
                if (!t) return;
                
                document.getElementById('broadcastMessage').value = t.message;
                this.selectType(t.type);
                this.toast('Template geladen!', 'info');
            },
            
            deleteTemplate(index) {
                this.templates.splice(index, 1);
                localStorage.setItem('rift_broadcast_templates', JSON.stringify(this.templates));
                this.renderTemplates();
                this.toast('Template gelöscht!', 'info');
            },
            
            // ============ PLAYER STATUS ============
            playerStatuses: {},
            statusUnsubscribe: null,
            
            async requestStatusUpdate() {
                try {
                    await this.ref().update({
                        broadcast: {
                            type: 'statusRequest',
                            id: Date.now(),
                            timestamp: firebase.firestore.FieldValue.serverTimestamp()
                        }
                    });
                    this.toast('Status-Abfrage gesendet!', 'success');
                    
                    // Start listening for status updates
                    this.listenForStatusUpdates();
                } catch (e) {
                    this.toast('Fehler', 'error');
                }
            },
            
            listenForStatusUpdates() {
                // Unsubscribe from previous listener
                if (this.statusUnsubscribe) {
                    this.statusUnsubscribe();
                }
                
                // Subscribe to status_responses subcollection
                this.statusUnsubscribe = this.ref().collection('status_responses').onSnapshot(snap => {
                    if (!this.playerStatuses) this.playerStatuses = {};
                    
                    snap.docs.forEach(doc => {
                        const data = doc.data();
                        this.playerStatuses[doc.id] = {
                            status: data.status,
                            name: data.playerName,
                            updatedAt: data.updatedAt
                        };
                    });
                    
                    this.renderPlayerStatuses();
                }, error => {
                    console.error('[Status] Listener error:', error);
                });
            },
            
            renderPlayerStatuses() {
                const container = document.getElementById('playerStatusList');
                if (!container) return;
                
                const statusIcons = {
                    ready: '●', 
                    notready: '❌', 
                    editing: '✏️', 
                    needsupport: '🆘',
                    unknown: '❓'
                };
                
                const statusLabels = {
                    ready: 'Bereit',
                    notready: 'Nicht bereit',
                    editing: 'Editiert noch',
                    needsupport: 'Braucht Hilfe',
                    unknown: 'Unbekannt'
                };
                
                let html = '';
                this.members.forEach(m => {
                    if (m.isGM) return;
                    const statusData = this.playerStatuses[m.id] || { status: 'unknown' };
                    const icon = statusIcons[statusData.status] || '❓';
                    const label = statusLabels[statusData.status] || statusData.status;
                    const time = statusData.updatedAt ? new Date(statusData.updatedAt).toLocaleTimeString('de-DE', { hour: '2-digit', minute: '2-digit' }) : '';
                    
                    // Highlight if needs support
                    const needsHelp = statusData.status === 'needsupport';
                    const bgStyle = needsHelp ? 'background: rgba(139,92,246,0.2); border: 1px solid rgba(139,92,246,0.4);' : '';
                    
                    html += `
                        <div class="bc-player" style="pointer-events: none; ${bgStyle}">
                            <div class="bc-player__avatar" style="background: ${m.color || '#8b5cf6'};">${m.name?.charAt(0) || '?'}</div>
                            <span class="bc-player__name">${this.escapeHtml(m.name)}</span>
                            <span style="margin-left: auto; font-size: 16px;" title="${label}">${icon}</span>
                            ${time ? `<span style="font-size: 10px; color: var(--text-muted);">${time}</span>` : ''}
                        </div>
                    `;
                });
                
                container.innerHTML = html || '<span style="color: var(--text-muted); font-size: 13px;">Keine Spieler</span>';
            },
            
            // ============ QUICK HANDOUT ============
            quickHandoutImageData: null,
            
            async sendQuickHandout() {
                if (!this.quickHandoutImageData) {
                    this.toast('Bild hochladen!', 'error');
                    return;
                }
                
                const title = document.getElementById('quickHandoutTitle').value.trim();
                
                try {
                    await this.ref().update({
                        broadcast: {
                            type: 'handout',
                            image: this.quickHandoutImageData,
                            title,
                            sound: 'none',
                            id: Date.now(),
                            timestamp: firebase.firestore.FieldValue.serverTimestamp()
                        }
                    });
                    
                    document.getElementById('quickHandoutTitle').value = '';
                    this.quickHandoutImageData = null;
                    document.getElementById('quickHandoutPreview').style.display = 'none';
                    document.getElementById('quickHandoutUpload').querySelector('.bc-image-upload__placeholder').style.display = 'flex';
                    
                    this.addToHistory('handout', `Handout${title ? ': ' + title : ''}`);
                    this.toast('Handout gesendet!', 'success');
                } catch (e) {
                    this.toast('Fehler', 'error');
                }
            },
            
            // ============ LOCATION BANNER ============
            locationImageData: null,
            
            async sendLocationBanner() {
                const name = document.getElementById('locationName').value.trim();
                if (!name) {
                    this.toast('Ortsname eingeben!', 'error');
                    return;
                }
                
                const subtitle = document.getElementById('locationSubtitle').value.trim();
                
                try {
                    await this.ref().update({
                        broadcast: {
                            type: 'location',
                            name,
                            subtitle,
                            image: this.locationImageData || null,
                            id: Date.now(),
                            timestamp: firebase.firestore.FieldValue.serverTimestamp()
                        }
                    });
                    
                    document.getElementById('locationName').value = '';
                    document.getElementById('locationSubtitle').value = '';
                    this.locationImageData = null;
                    document.getElementById('locationImagePreview').style.display = 'none';
                    document.getElementById('locationImageUpload').querySelector('.bc-image-upload__placeholder').style.display = 'flex';
                    
                    this.addToHistory('location', `Location: ${name}`);
                    this.toast('Location Banner gesendet!', 'success');
                } catch (e) {
                    this.toast('Fehler', 'error');
                }
            },
            
            // ============ BOSS INTRO ============
            bossImageData: null,
            
            async sendBossIntro() {
                const name = document.getElementById('bossName').value.trim();
                if (!name) {
                    this.toast('Boss-Name eingeben!', 'error');
                    return;
                }
                
                const title = document.getElementById('bossTitle').value.trim();
                const withSound = document.getElementById('bossSound')?.checked;
                
                try {
                    await this.ref().update({
                        broadcast: {
                            type: 'boss',
                            name,
                            title,
                            image: this.bossImageData || null,
                            sound: withSound ? 'dramatic' : 'none',
                            id: Date.now(),
                            timestamp: firebase.firestore.FieldValue.serverTimestamp()
                        }
                    });
                    
                    document.getElementById('bossName').value = '';
                    document.getElementById('bossTitle').value = '';
                    this.bossImageData = null;
                    document.getElementById('bossImagePreview').style.display = 'none';
                    document.getElementById('bossImageUpload').querySelector('.bc-image-upload__placeholder').style.display = 'flex';
                    
                    this.addToHistory('boss', `Boss: ${name}`);
                    this.toast('Boss Intro gesendet!', 'success');
                } catch (e) {
                    this.toast('Fehler', 'error');
                }
            },
            
            // ============ LOOT DROP ============
            async sendLootDrop() {
                const itemsText = document.getElementById('lootItems').value.trim();
                const gold = parseInt(document.getElementById('lootGold').value) || 0;
                const currency = document.getElementById('lootCurrency')?.value || 'coins';
                const withSound = document.getElementById('lootSound')?.checked !== false;
                
                const currencyNames = {
                    coins: 'Münzen', gold: 'Gold', silver: 'Silber', copper: 'Kupfer', 
                    platinum: 'Platin', gems: 'Edelsteine', berry: 'Berry',
                    dollar: 'Dollar', euro: 'Euro', credits: 'Credits', yen: 'Yen'
                };
                const currencyIcons = {
                    coins: '🪙', gold: '💰', silver: '🥈', copper: '🥉', 
                    platinum: '💎', gems: '💠', berry: '🍓',
                    dollar: '💵', euro: '💶', credits: '🔋', yen: '💴'
                };
                
                const items = itemsText ? itemsText.split('\n').filter(i => i.trim()) : [];
                
                if (items.length === 0 && gold === 0) {
                    this.toast('Items oder Währung eingeben!', 'error');
                    return;
                }
                
                try {
                    await this.ref().update({
                        broadcast: {
                            type: 'loot',
                            items,
                            gold,
                            currency,
                            currencyName: currencyNames[currency] || 'Münzen',
                            currencyIcon: currencyIcons[currency] || '🪙',
                            sound: withSound ? 'coin' : 'none',
                            id: Date.now(),
                            timestamp: firebase.firestore.FieldValue.serverTimestamp()
                        }
                    });
                    
                    document.getElementById('lootItems').value = '';
                    document.getElementById('lootGold').value = '';
                    
                    const currencyLabel = currencyNames[currency] || 'Münzen';
                    const historyText = items.length > 0 
                        ? `Loot: ${items.length} Items${gold > 0 ? ` + ${gold} ${currencyLabel}` : ''}`
                        : `Loot: ${gold} ${currencyLabel}`;
                    this.addToHistory('loot', historyText);
                    this.toast('Loot Drop gesendet!', 'success');
                } catch (e) {
                    this.toast('Fehler', 'error');
                }
            },
            
            // ============ LEVEL UP ============
            async sendLevelUp() {
                const selected = document.querySelector('#levelUpPlayers .bc-player.selected');
                if (!selected) {
                    this.toast('Spieler auswählen!', 'error');
                    return;
                }
                
                const level = parseInt(document.getElementById('levelUpLevel').value);
                if (!level || level < 1) {
                    this.toast('Level eingeben!', 'error');
                    return;
                }
                
                const playerId = selected.dataset.id;
                const playerName = selected.querySelector('.bc-player__name').textContent;
                
                try {
                    await this.ref().update({
                        broadcast: {
                            type: 'levelup',
                            targetId: playerId,
                            targetName: playerName,
                            level,
                            sound: 'fanfare',
                            id: Date.now(),
                            timestamp: firebase.firestore.FieldValue.serverTimestamp()
                        }
                    });
                    
                    document.getElementById('levelUpLevel').value = '';
                    
                    this.addToHistory('levelup', `${playerName} erreicht Level ${level}!`);
                    this.toast('Level Up gesendet!', 'success');
                } catch (e) {
                    this.toast('Fehler', 'error');
                }
            },
            
            // ============ DEATH SCREEN ============
            async sendDeathScreen() {
                const selected = document.querySelector('#deathPlayers .bc-player.selected');
                if (!selected) {
                    this.toast('Spieler/Charakter auswählen!', 'error');
                    return;
                }
                
                const playerId = selected.dataset.id;
                const playerName = selected.querySelector('.bc-player__name').textContent;
                const message = document.getElementById('deathMessage').value.trim();
                
                try {
                    await this.ref().update({
                        broadcast: {
                            type: 'death',
                            targetId: playerId,
                            targetName: playerName,
                            message,
                            sound: 'dramatic',
                            id: Date.now(),
                            timestamp: firebase.firestore.FieldValue.serverTimestamp()
                        }
                    });
                    
                    document.getElementById('deathMessage').value = '';
                    
                    this.addToHistory('death', `${playerName} ist gefallen`);
                    this.toast('Death Screen gesendet!', 'success');
                } catch (e) {
                    this.toast('Fehler', 'error');
                }
            },
            
            // ============ COIN FLIP ============
            async sendCoinFlip(forceResult = null) {
                const question = document.getElementById('coinQuestion').value.trim();
                const result = forceResult || (Math.random() < 0.5 ? 'heads' : 'tails');
                
                try {
                    await this.ref().update({
                        broadcast: {
                            type: 'coinflip',
                            question,
                            result,
                            sound: 'coin',
                            id: Date.now(),
                            timestamp: firebase.firestore.FieldValue.serverTimestamp()
                        }
                    });
                    
                    document.getElementById('coinQuestion').value = '';
                    
                    this.addToHistory('coinflip', `Münzwurf: ${result === 'heads' ? 'Kopf' : 'Zahl'}`);
                    this.toast(`Münzwurf: ${result === 'heads' ? 'Kopf' : 'Zahl'}!`, 'success');
                } catch (e) {
                    this.toast('Fehler', 'error');
                }
            },
            
            // ============ BREAK TIMER ============
            async sendBreakCountdown(minutes) {
                const endTime = Date.now() + (minutes * 60 * 1000);
                
                try {
                    await this.ref().update({
                        broadcast: {
                            type: 'break',
                            endTime,
                            minutes,
                            id: Date.now(),
                            timestamp: firebase.firestore.FieldValue.serverTimestamp()
                        }
                    });
                    
                    this.addToHistory('break', `Pause: ${minutes} Minuten`);
                    this.toast(`Pause: ${minutes} Minuten!`, 'success');
                } catch (e) {
                    this.toast('Fehler', 'error');
                }
            },
            
            // ============ SOUND BOARD ============
            customSoundData: null,
            
            async playGlobalSound(soundType) {
                try {
                    await this.ref().update({
                        broadcast: {
                            type: 'sound',
                            soundType,
                            id: Date.now(),
                            timestamp: firebase.firestore.FieldValue.serverTimestamp()
                        }
                    });
                    this.addToHistory('sound', `Sound: ${soundType}`);
                } catch (e) {
                    this.toast('Fehler', 'error');
                }
            },
            
            async handleSoundUpload(event) {
                const file = event.target.files[0];
                if (!file) return;
                
                // Check file size (max 5MB)
                if (file.size > 5 * 1024 * 1024) {
                    this.toast('Datei zu groß (max 5MB)', 'error');
                    return;
                }
                
                this.toast('Audio wird verarbeitet...', 'info');
                
                try {
                    const reader = new FileReader();
                    reader.onload = async (e) => {
                        this.customSoundData = e.target.result;
                        document.getElementById('customSoundName').textContent = `📁 ${file.name}`;
                        document.getElementById('stopSoundBtn').style.display = 'inline-flex';
                        
                        // Send to all players
                        await this.ref().update({
                            broadcast: {
                                type: 'customSound',
                                soundData: this.customSoundData,
                                fileName: file.name,
                                id: Date.now(),
                                timestamp: firebase.firestore.FieldValue.serverTimestamp()
                            }
                        });
                        
                        this.addToHistory('sound', `Custom Sound: ${file.name}`);
                        this.toast('Sound wird abgespielt!', 'success');
                    };
                    reader.readAsDataURL(file);
                } catch (e) {
                    console.error('Sound upload error:', e);
                    this.toast('Fehler beim Hochladen', 'error');
                }
            },
            
            async stopGlobalSound() {
                try {
                    await this.ref().update({
                        broadcast: {
                            type: 'stopSound',
                            id: Date.now(),
                            timestamp: firebase.firestore.FieldValue.serverTimestamp()
                        }
                    });
                    document.getElementById('stopSoundBtn').style.display = 'none';
                    document.getElementById('customSoundName').textContent = '';
                    this.customSoundData = null;
                    this.toast('Sound gestoppt', 'success');
                } catch (e) {
                    this.toast('Fehler', 'error');
                }
            },
            
            // ============ TIME OF DAY ============
            async sendTimeOfDay(timeType) {
                const labels = {
                    dawn: '🌅 Morgengrauen',
                    noon: '☀️ Mittag',
                    dusk: '🌆 Abenddämmerung',
                    midnight: 'Mitternacht',
                    flashback: 'Flashback',
                    vision: '👁️ Vision',
                    clear: '❌ Effekt aus'
                };
                
                try {
                    await this.ref().update({
                        broadcast: {
                            type: 'timeofday',
                            timeType,
                            label: labels[timeType] || timeType,
                            id: Date.now(),
                            timestamp: firebase.firestore.FieldValue.serverTimestamp()
                        }
                    });
                    
                    this.addToHistory('timeofday', labels[timeType] || timeType);
                    this.toast(`${labels[timeType] || 'Effekt'} aktiviert!`, 'success');
                } catch (e) {
                    this.toast('Fehler', 'error');
                }
            },
            
            // ============ END BREAK ============
            async endBreak() {
                try {
                    await this.ref().update({
                        broadcast: {
                            type: 'endbreak',
                            id: Date.now(),
                            timestamp: firebase.firestore.FieldValue.serverTimestamp()
                        }
                    });
                    this.toast('Pause beendet!', 'success');
                } catch (e) {
                    this.toast('Fehler', 'error');
                }
            },
            
            // ============ GM HISTORY (PERSISTENT) ============
            historyItems: [],
            
            async loadGmHistory() {
                try {
                    const doc = await this.ref().get();
                    const data = doc.data();
                    this.historyItems = data?.gmHistory || [];
                    console.log('[BC] GM History loaded:', this.historyItems.length, 'items');
                    this.renderHistory();
                } catch (e) {
                    console.error('[BC] Error loading GM history:', e);
                }
            },
            
            async addToHistory(type, text) {
                const now = new Date();
                const time = now.toLocaleTimeString('de-DE', { hour: '2-digit', minute: '2-digit' });
                const date = now.toLocaleDateString('de-DE', { day: '2-digit', month: '2-digit' });
                
                const icons = {
                    broadcast: '📢', poll: '📊', reaction: '😀', spotlight: '🌟',
                    secret: '🤫', diceRequest: '🎲', handout: '📜', scene: '🎬',
                    reveal: '✨', combat: '⚔️', ambient: '🌙', toast: '⚡', timer: '⏱️',
                    location: '📍', boss: '👹', loot: '💰', levelup: '🎉', death: '💀',
                    coinflip: '🪙', break: '☕', sound: '🔊', timeofday: '🌅'
                };
                
                const newItem = { 
                    type, 
                    text, 
                    time, 
                    date,
                    icon: icons[type] || '📋',
                    timestamp: Date.now()
                };
                
                this.historyItems.unshift(newItem);
                
                // Keep only last 100 items
                if (this.historyItems.length > 100) {
                    this.historyItems = this.historyItems.slice(0, 100);
                }
                
                this.renderHistory();
                
                // Save to Firebase (persistent!)
                try {
                    await this.ref().update({
                        gmHistory: this.historyItems
                    });
                    console.log('[BC] GM History saved');
                } catch (e) {
                    console.error('[BC] Error saving GM history:', e);
                }
            },
            
            renderHistory() {
                const list = document.getElementById('historyList');
                const empty = document.getElementById('historyEmpty');
                
                if (!list) return;
                
                if (this.historyItems.length === 0) {
                    if (empty) empty.style.display = 'block';
                    list.innerHTML = '';
                    return;
                }
                
                if (empty) empty.style.display = 'none';
                
                list.innerHTML = this.historyItems.map(item => `
                    <div class="bc-history-item" style="display: flex; align-items: center; gap: 12px; padding: 12px 16px; border-bottom: 1px solid rgba(255,255,255,0.05);">
                        <span style="font-size: 20px;">${item.icon}</span>
                        <div style="flex: 1;">
                            <div style="font-size: 14px; color: white;">${this.escapeHtml(item.text)}</div>
                            <div style="font-size: 12px; color: rgba(255,255,255,0.4);">${item.date ? item.date + ' ' : ''}${item.time}</div>
                        </div>
                    </div>
                `).join('');
            },
            
            async clearHistory() {
                if (!confirm('GM Verlauf wirklich löschen? Diese Aktion kann nicht rückgängig gemacht werden.')) return;
                
                this.historyItems = [];
                this.renderHistory();
                
                try {
                    await this.ref().update({ gmHistory: [] });
                    this.toast('GM Verlauf gelöscht', 'success');
                } catch (e) {
                    console.error('[BC] Error clearing GM history:', e);
                    this.toast('Fehler beim Löschen', 'error');
                }
            },
            
            // ============ UTILS ============
            toast(message, type = 'info') {
                // Simple toast
                const toast = document.createElement('div');
                toast.style.cssText = `
                    position: fixed; bottom: 24px; right: 24px; z-index: 10000;
                    padding: 14px 24px; border-radius: 10px;
                    background: ${type === 'success' ? '#22c55e' : type === 'error' ? '#ef4444' : '#8b5cf6'};
                    color: white; font-weight: 500; font-size: 14px;
                    animation: slideIn 0.3s ease;
                `;
                toast.textContent = message;
                document.body.appendChild(toast);
                
                setTimeout(() => {
                    toast.style.animation = 'slideOut 0.3s ease';
                    setTimeout(() => toast.remove(), 300);
                }, 2500);
            },
            
            // ============ SUB-TAB NAVIGATION ============
            switchSubTab(sub) {
                document.querySelectorAll('.bc-subtab').forEach(t => t.classList.toggle('active', t.dataset.sub === sub));
                document.querySelectorAll('.bc-subpanel').forEach(p => p.classList.toggle('active', p.id === 'subpanel-' + sub));
            },
            
            // ============ MEMBERS SUBSCRIPTION ============
            previousMembers: {},
            initialMembersLoaded: false,
            
            subMembers() {
                const unsub = this.ref().collection('members').onSnapshot(snap => {
                    const newMembers = snap.docs.map(d => ({ id: d.id, ...d.data() }));
                    
                    // Beim ersten Load nur speichern, nicht loggen
                    if (!this.initialMembersLoaded) {
                        console.log('[BC] Initial members load - storing baseline');
                        newMembers.forEach(member => {
                            this.previousMembers[member.id] = { ...member };
                        });
                        this.initialMembersLoaded = true;
                        this.members = newMembers;
                        this.renderPlayerManagement();
                        this.renderPlayerSelectors();
                        this.updateGMTransferSelect();
                        return;
                    }
                    
                    // Track changes (nur nach initialem Load)
                    newMembers.forEach(member => {
                        const prev = this.previousMembers[member.id];
                        if (prev) {
                            this.trackMemberChanges(prev, member);
                        } else {
                            // Wirklich neuer Member (nach initialem Load)
                            this.addLiveLog({
                                type: 'member',
                                icon: '👋',
                                action: 'joined',
                                userName: member.displayName || member.name || 'Unbekannt',
                                userId: member.id
                            });
                        }
                        this.previousMembers[member.id] = { ...member };
                    });
                    
                    this.members = newMembers;
                    if (window.RIFT?.gmChars) RIFT.gmChars.updateMembers(this.members);
                    this.renderPlayerManagement();
                    this.renderPlayerSelectors();
                    this.updateGMTransferSelect();
                }, e => console.error('[BC] Members error:', e));
                this.unsubs.push(unsub);
            },
            
            trackMemberChanges(prev, curr) {
                const userName = curr.displayName || curr.name || 'Unbekannt';
                const changes = [];
                
                // Name changed
                if (prev.displayName !== curr.displayName && curr.displayName) {
                    changes.push({ field: 'Name', old: prev.displayName, new: curr.displayName });
                }
                
                // Color changed
                if (prev.color !== curr.color && curr.color) {
                    changes.push({ field: 'Farbe', old: prev.color, new: curr.color });
                }
                
                // Avatar changed
                if (prev.avatar !== curr.avatar && curr.avatar) {
                    changes.push({ field: 'Profilbild', old: '(alt)', new: '(neu)' });
                }
                
                // Role changed
                if (prev.role !== curr.role) {
                    changes.push({ field: 'Rolle', old: prev.role || '-', new: curr.role || '-' });
                }
                
                changes.forEach(c => {
                    this.addLiveLog({
                        type: 'member',
                        icon: '👤',
                        action: 'profile_change',
                        userName: userName,
                        userId: curr.id,
                        field: c.field,
                        oldValue: c.old,
                        newValue: c.new
                    });
                });
            },
            
            // ============ CHARACTERS SUBSCRIPTION ============
            previousCharacters: {},
            initialCharactersLoaded: false,
            
            subCharacters() {
                console.log('[BC] Setting up characters subscription...');
                const unsub = this.ref().collection('characters').onSnapshot(snap => {
                    console.log('[BC] Characters snapshot received:', snap.docs.length, 'characters');
                    
                    const newCharacters = snap.docs.map(d => {
                        const data = { id: d.id, ...d.data() };
                        return data;
                    });
                    
                    // Beim ersten Load nur speichern, nicht loggen
                    if (!this.initialCharactersLoaded) {
                        console.log('[BC] Initial characters load - storing baseline');
                        newCharacters.forEach(char => {
                            this.previousCharacters[char.id] = JSON.parse(JSON.stringify(char));
                        });
                        this.initialCharactersLoaded = true;
                        this.characters = newCharacters;
                        this.renderCharacters();
                        return;
                    }
                    
                    // Track changes (nur nach initialem Load)
                    newCharacters.forEach(char => {
                        const prev = this.previousCharacters[char.id];
                        if (prev) {
                            this.trackCharacterChanges(prev, char);
                        } else {
                            // Wirklich neuer Charakter (nach initialem Load)
                            this.addLiveLog({
                                type: 'character',
                                icon: '🆕',
                                action: 'created',
                                characterName: char.name || char.characterName || 'Unbenannt',
                                characterId: char.id,
                                userName: this.getMemberName(char.ownerId || char.owner)
                            });
                        }
                        // Deep copy for comparison
                        this.previousCharacters[char.id] = JSON.parse(JSON.stringify(char));
                    });
                    
                    this.characters = newCharacters;
                    this.renderCharacters();
                }, e => console.error('[BC] Characters error:', e));
                this.unsubs.push(unsub);
            },
            
            getMemberName(memberId) {
                if (!memberId) return 'Unbekannt';
                const member = this.members.find(m => m.id === memberId);
                return member?.displayName || member?.name || 'Unbekannt';
            },
            
            trackCharacterChanges(prev, curr) {
                const charName = curr.name || curr.characterName || 'Unbenannt';
                const ownerName = this.getMemberName(curr.ownerId || curr.owner);
                const d = curr.data || {};
                const pd = prev.data || {};
                
                // Skip if lastModifiedBy is 'gm' (GM's own changes)
                if (curr.lastModifiedBy === 'gm' && prev.lastModifiedBy !== 'gm') {
                    return; // GM-Änderungen nicht doppelt loggen
                }
                
                const changes = [];
                
                // === BASIC INFO ===
                if (prev.name !== curr.name && curr.name) {
                    changes.push({ field: 'Name', old: prev.name, new: curr.name, icon: '📝' });
                }
                
                // === STATUS (HP, Moral) ===
                const prevHP = pd.status?.health ?? prev.hp;
                const currHP = d.status?.health ?? curr.hp;
                if (prevHP !== currHP && currHP !== undefined) {
                    const diff = currHP - (prevHP || 0);
                    const arrow = diff > 0 ? '↑' : '↓';
                    changes.push({ field: `LP ${arrow}${Math.abs(diff)}%`, old: `${prevHP}%`, new: `${currHP}%`, icon: '❤️' });
                }
                
                const prevMoral = pd.status?.moral ?? prev.moral;
                const currMoral = d.status?.moral ?? curr.moral;
                if (prevMoral !== currMoral && currMoral !== undefined) {
                    const diff = currMoral - (prevMoral || 0);
                    const arrow = diff > 0 ? '↑' : '↓';
                    changes.push({ field: `Moral ${arrow}${Math.abs(diff)}%`, old: `${prevMoral}%`, new: `${currMoral}%`, icon: '💪' });
                }
                
                // === ATTRIBUTES ===
                const attrNames = { power: 'Kraft', agility: 'Geschick', endurance: 'Zähigkeit', mind: 'Verstand', presence: 'Präsenz' };
                ['power', 'agility', 'endurance', 'mind', 'presence'].forEach(attr => {
                    const prevVal = pd.attributes?.[attr];
                    const currVal = d.attributes?.[attr];
                    if (prevVal !== currVal && currVal !== undefined) {
                        changes.push({ field: attrNames[attr], old: prevVal, new: currVal, icon: '📊' });
                    }
                });
                
                // === CURRENCY ===
                if (pd.currency !== d.currency && d.currency !== undefined) {
                    changes.push({ field: 'Währung', old: pd.currency, new: d.currency, icon: '💰' });
                }
                
                // === INVENTORY ===
                const prevInv = JSON.stringify(pd.inventory || []);
                const currInv = JSON.stringify(d.inventory || []);
                if (prevInv !== currInv) {
                    const prevCount = (pd.inventory || []).length;
                    const currCount = (d.inventory || []).length;
                    if (currCount > prevCount) {
                        changes.push({ field: 'Inventar', old: `${prevCount} Items`, new: `${currCount} Items (+${currCount - prevCount})`, icon: '🎒' });
                    } else if (currCount < prevCount) {
                        changes.push({ field: 'Inventar', old: `${prevCount} Items`, new: `${currCount} Items (${currCount - prevCount})`, icon: '🎒' });
                    } else {
                        changes.push({ field: 'Inventar', old: '(geändert)', new: '(aktualisiert)', icon: '🎒' });
                    }
                }
                
                // === WEAPON ===
                const prevWeapon = JSON.stringify(pd.weapon || {});
                const currWeapon = JSON.stringify(d.weapon || {});
                if (prevWeapon !== currWeapon) {
                    const weaponName = d.weapon?.name || 'Waffe';
                    changes.push({ field: 'Waffe', old: pd.weapon?.name || '-', new: weaponName, icon: '⚔️' });
                }
                
                // === NOTES ===
                if (pd.notes !== d.notes && d.notes !== undefined) {
                    const prevLen = (pd.notes || '').length;
                    const currLen = (d.notes || '').length;
                    changes.push({ field: 'Notizen', old: `${prevLen} Zeichen`, new: `${currLen} Zeichen`, icon: '📝' });
                }
                
                // === FOKUS ===
                const prevFokusType = pd.fokus?.type;
                const currFokusType = d.fokus?.type;
                if (prevFokusType !== currFokusType && currFokusType) {
                    const oldFokusName = prevFokusType ? (WA_FOKUS_NAMES[prevFokusType]?.name || this.capitalize(prevFokusType)) : '-';
                    const newFokusName = WA_FOKUS_NAMES[currFokusType]?.name || this.capitalize(currFokusType);
                    changes.push({ field: 'Fokus', old: oldFokusName, new: newFokusName, icon: '🎯' });
                }
                
                // === SCHWÄCHE ===
                if (pd.schwaeche !== d.schwaeche && d.schwaeche) {
                    const oldSchwaecheName = pd.schwaeche ? (WA_SCHWAECHE_NAMES[pd.schwaeche] || this.capitalize(pd.schwaeche)) : '-';
                    const newSchwaecheName = WA_SCHWAECHE_NAMES[d.schwaeche] || this.capitalize(d.schwaeche);
                    changes.push({ field: 'Schwäche', old: oldSchwaecheName, new: newSchwaecheName, icon: '⚠️' });
                }
                
                // === SECOND CHANCE ===
                const prevSC = JSON.stringify(pd.secondChance || []);
                const currSC = JSON.stringify(d.secondChance || []);
                if (prevSC !== currSC) {
                    const used = (d.secondChance || []).filter(x => x).length;
                    changes.push({ field: '2. Chance', old: '-', new: `${used}/3 verwendet`, icon: '🍀' });
                }
                
                // === ROLE / CLASS ===
                if (pd.role !== d.role && d.role) {
                    changes.push({ field: 'Rolle', old: pd.role || '-', new: d.role, icon: '🎭' });
                }
                
                // === CREW ===
                if (pd.crew !== d.crew && d.crew) {
                    changes.push({ field: 'Crew', old: pd.crew || '-', new: d.crew, icon: '🏴‍☠️' });
                }
                
                // === AGE / GENDER ===
                if (pd.age !== d.age && d.age) {
                    changes.push({ field: 'Alter', old: pd.age || '-', new: d.age, icon: '📅' });
                }
                if (pd.gender !== d.gender && d.gender) {
                    changes.push({ field: 'Geschlecht', old: pd.gender || '-', new: d.gender, icon: '👤' });
                }
                
                // === PORTRAIT ===
                if (pd.portrait !== d.portrait && d.portrait) {
                    changes.push({ field: 'Portrait', old: '(alt)', new: '(neu)', icon: '🖼️' });
                }
                
                // Log all changes
                changes.forEach(c => {
                    this.addLiveLog({
                        type: 'character',
                        icon: c.icon,
                        action: 'change',
                        field: c.field,
                        oldValue: c.old,
                        newValue: c.new,
                        characterName: charName,
                        characterId: curr.id,
                        userName: ownerName
                    });
                });
            },
            
            // ============ PRESENCE SUBSCRIPTION ============
            subPresence() {
                if (!this.rtdb) return;
                const ref = this.rtdb.ref(`presence/${this.roomCode}`);
                ref.on('value', snap => {
                    const data = snap.val() || {};
                    this.onlineStatus = {};
                    Object.keys(data).forEach(uid => {
                        this.onlineStatus[uid] = data[uid]?.online === true;
                    });
                    // Push to new module
                    if (window.RIFT?.gmChars) {
                        RIFT.gmChars.updateOnline(Object.keys(this.onlineStatus).filter(uid => this.onlineStatus[uid]));
                    }
                    this.renderPlayerManagement();
                    this.renderCharacters();
                });
                this.unsubs.push(() => ref.off());
            },
            
            isOnline(uid) { return this.onlineStatus[uid] === true; },
            
            // ============ BANNED SUBSCRIPTION ============
            subBanned() {
                const unsub = this.ref().collection('banned').onSnapshot(snap => {
                    this.banned = snap.docs.map(d => ({ id: d.id, ...d.data() }));
                    this.renderBannedPlayers();
                }, e => console.error('[BC] Banned error:', e));
                this.unsubs.push(unsub);
            },
            
            // ============ LOGS SUBSCRIPTION ============
            subLogs() {
                console.log('[BC] Starting subLogs...');
                
                // Subscribe to multiple collections for comprehensive logging
                const collections = [
                    { name: 'dice', icon: '🎲', type: 'dice' },
                    { name: 'chat', icon: '💬', type: 'chat' },
                    { name: 'changelog', icon: '📝', type: 'character' }
                ];
                
                collections.forEach(col => {
                    console.log(`[BC] Subscribing to ${col.name}...`);
                    
                    const query = this.ref().collection(col.name);
                    
                    const unsub = query.onSnapshot(snap => {
                        console.log(`[BC] ${col.name} snapshot: ${snap.docs.length} docs`);
                        
                        const items = snap.docs.map(d => {
                            const data = d.data();
                            console.log(`[BC] ${col.name} item:`, data.type, data.action, data.field);
                            return {
                                id: d.id,
                                collection: col.name,
                                icon: data.icon || col.icon,
                                type: data.type || col.type,
                                timestamp: data.timestamp || data.createdAt || data.clientTimestamp || null,
                                ...data
                            };
                        });
                        
                        // Merge with existing logs
                        this.logs = this.logs.filter(l => l.collection !== col.name).concat(items);
                        
                        // Sort by timestamp
                        this.logs.sort((a, b) => {
                            const getTime = (t) => {
                                if (!t) return 0;
                                if (t.toDate) return t.toDate().getTime();
                                if (t.seconds) return t.seconds * 1000;
                                if (typeof t === 'number') return t;
                                return 0;
                            };
                            return getTime(b.timestamp) - getTime(a.timestamp);
                        });
                        
                        console.log('[BC] Total logs after merge:', this.logs.length);
                        this.renderLogs();
                    }, e => {
                        console.error(`[BC] ${col.name} error:`, e);
                        this.renderLogsError(`${col.name}: ${e.message || 'Fehler'}`);
                    });
                    this.unsubs.push(unsub);
                });
                
                // Also log broadcasts from room document
                const broadcastUnsub = this.ref().onSnapshot(snap => {
                    const data = snap.data();
                    if (data?.broadcast && data.broadcast.id) {
                        const existing = this.logs.find(l => l.id === 'broadcast-' + data.broadcast.id);
                        if (!existing) {
                            this.logs.unshift({
                                id: 'broadcast-' + data.broadcast.id,
                                collection: 'broadcast',
                                icon: '📢',
                                type: 'broadcast',
                                timestamp: data.broadcast.timestamp || { seconds: Date.now() / 1000 },
                                ...data.broadcast
                            });
                            this.renderLogs();
                        }
                    }
                }, e => console.error('[BC] Broadcast error:', e));
                this.unsubs.push(broadcastUnsub);
                
                // Initial render
                setTimeout(() => this.renderLogs(), 500);
            },
            
            renderLogsError(message) {
                const list = document.getElementById('activityLogList');
                if (!list) return;
                
                // Check if error already shown
                if (!list.querySelector('.log-error')) {
                    const errorDiv = document.createElement('div');
                    errorDiv.className = 'log-error';
                    errorDiv.style.cssText = 'padding:12px;background:rgba(239,68,68,0.1);border:1px solid rgba(239,68,68,0.3);border-radius:8px;margin:8px;color:#f87171;font-size:12px;';
                    errorDiv.innerHTML = `<strong>Log-Fehler:</strong> ${message}<br><small>Bitte Firestore Rules deployen!</small>`;
                    list.prepend(errorDiv);
                }
            },
            
            // ============ PLAYER MANAGEMENT ============
            renderPlayerManagement() {
                const list = document.getElementById('playerManagementList');
                const countDisplay = document.getElementById('playerCountDisplay');
                if (!list) return;
                
                const uid = firebase.auth().currentUser?.uid;
                const onlineCount = this.members.filter(m => this.isOnline(m.id)).length;
                
                if (countDisplay) {
                    countDisplay.textContent = `${this.members.length} Spieler (${onlineCount} online)`;
                }
                
                if (!this.members.length) {
                    list.innerHTML = '<div style="padding:40px;text-align:center;color:rgba(255,255,255,0.4);">Keine Spieler</div>';
                    return;
                }
                
                list.innerHTML = this.members.map(m => {
                    const name = this.escapeHtml(m.displayName || m.name || 'Unbekannt');
                    const role = m.role || 'player';
                    const online = this.isOnline(m.id);
                    const paused = m.paused === true;
                    const isMe = m.id === uid;
                    const isGM = role === 'gm';
                    const color = m.color || '#8b5cf6';
                    const lastSeen = m.lastSeen?.toDate?.();
                    
                    const statusClass = paused ? 'paused' : (online ? 'online' : 'offline');
                    const statusText = paused ? 'Pausiert' : (online ? 'Online' : (lastSeen ? this.formatDate(lastSeen) : 'Offline'));
                    
                    const roleLabel = { gm: 'GM', cogm: 'Co-GM', player: 'Spieler' }[role] || 'Spieler';
                    const roleClass = role;
                    
                    const pauseIcon = paused 
                        ? '<svg viewBox="0 0 24 24" fill="currentColor" style="width:14px;height:14px;"><polygon points="5 3 19 12 5 21 5 3"/></svg>'
                        : '<svg viewBox="0 0 24 24" fill="currentColor" style="width:14px;height:14px;"><rect x="6" y="4" width="4" height="16"/><rect x="14" y="4" width="4" height="16"/></svg>';
                    
                    return `
                        <div class="player-management-item" data-id="${m.id}">
                            <div class="player-management-item__avatar" style="background:${color}">
                                ${name[0].toUpperCase()}
                                <div class="player-management-item__status player-management-item__status--${statusClass}"></div>
                            </div>
                            <div class="player-management-item__info">
                                <div class="player-management-item__name">
                                    ${name}${isMe ? ' (Du)' : ''}
                                    <span class="player-management-item__role player-management-item__role--${roleClass}">${roleLabel}</span>
                                </div>
                                <div class="player-management-item__meta">${statusText}</div>
                            </div>
                            <div class="player-management-item__actions">
                                ${!isMe && !isGM ? `
                                    <button class="player-management-item__btn" onclick="BC.openRoleMenu('${m.id}')" title="Rolle ändern"><svg viewBox="0 0 24 24" fill="currentColor" style="width:14px;height:14px;"><path d="M5 16L3 5l5.5 5L12 4l3.5 6L21 5l-2 11z"/></svg></button>
                                    <button class="player-management-item__btn player-management-item__btn--warning" onclick="BC.togglePause('${m.id}')" title="${paused ? 'Fortsetzen' : 'Pausieren'}">${pauseIcon}</button>
                                    <button class="player-management-item__btn player-management-item__btn--danger" onclick="BC.openKickModal('${m.id}')" title="Kicken/Bannen"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width:14px;height:14px;"><circle cx="12" cy="12" r="10"/><line x1="4.93" y1="4.93" x2="19.07" y2="19.07"/></svg></button>
                                ` : ''}
                            </div>
                        </div>
                    `;
                }).join('');
            },
            
            updateGMTransferSelect() {
                const select = document.getElementById('gmTransferSelect');
                if (!select) return;
                const uid = firebase.auth().currentUser?.uid;
                const eligible = this.members.filter(m => m.role !== 'gm' && m.id !== uid);
                select.innerHTML = '<option value="">Wählen...</option>' + eligible.map(m => 
                    `<option value="${m.id}">${this.escapeHtml(m.displayName || m.name || '?')}</option>`
                ).join('');
            },
            
            renderBannedPlayers() {
                const list = document.getElementById('bannedPlayersList');
                if (!list) return;
                
                if (!this.banned.length) {
                    list.innerHTML = '<div style="padding:20px;text-align:center;color:rgba(255,255,255,0.4);font-size:13px;">Keine gebannten Spieler</div>';
                    return;
                }
                
                list.innerHTML = this.banned.map(b => `
                    <div style="display:flex;align-items:center;gap:12px;padding:12px 16px;border-bottom:1px solid rgba(255,255,255,0.05);">
                        <div style="flex:1;">
                            <div style="font-weight:600;color:white;font-size:14px;">${this.escapeHtml(b.displayName || b.name || b.id)}</div>
                            <div style="font-size:12px;color:rgba(255,255,255,0.4);">${this.escapeHtml(b.reason || 'Kein Grund')}</div>
                        </div>
                        <button class="bc-btn bc-btn--small bc-btn--secondary" onclick="BC.unban('${b.id}')">Entbannen</button>
                    </div>
                `).join('');
            },
            
            openRoleMenu(id) {
                const member = this.members.find(m => m.id === id);
                if (!member) return;
                const role = prompt(`Rolle für ${member.displayName || member.name}:\n\n1 = Spieler\n2 = Co-GM\n\nAktuell: ${member.role}`);
                if (role === '1') this.setRole(id, 'player');
                else if (role === '2') this.setRole(id, 'cogm');
            },
            
            async setRole(id, role) {
                try {
                    await this.ref().collection('members').doc(id).update({ role });
                    this.toast('Rolle geändert!', 'success');
                    this.addLog('member', `Rolle geändert: ${role}`);
                } catch (e) {
                    this.toast('Fehler', 'error');
                }
            },
            
            async togglePause(id) {
                const member = this.members.find(m => m.id === id);
                if (!member) return;
                const paused = !member.paused;
                try {
                    await this.ref().collection('members').doc(id).update({ paused });
                    // Send pause broadcast to that player
                    await this.ref().update({
                        broadcast: {
                            type: paused ? 'pause' : 'unpause',
                            targetId: id,
                            id: Date.now(),
                            timestamp: firebase.firestore.FieldValue.serverTimestamp()
                        }
                    });
                    this.toast(paused ? 'Spieler pausiert' : 'Spieler fortgesetzt', 'success');
                } catch (e) {
                    this.toast('Fehler', 'error');
                }
            },
            
            async pauseAllPlayers() {
                const players = this.members.filter(m => m.role !== 'gm' && m.id !== firebase.auth().currentUser?.uid);
                for (const p of players) {
                    await this.ref().collection('members').doc(p.id).update({ paused: true });
                }
                await this.ref().update({
                    broadcast: { type: 'pause', id: Date.now(), timestamp: firebase.firestore.FieldValue.serverTimestamp() }
                });
                this.toast('Alle Spieler pausiert', 'success');
            },
            
            async unpauseAllPlayers() {
                const players = this.members.filter(m => m.paused === true);
                for (const p of players) {
                    await this.ref().collection('members').doc(p.id).update({ paused: false });
                }
                await this.ref().update({
                    broadcast: { type: 'unpause', id: Date.now(), timestamp: firebase.firestore.FieldValue.serverTimestamp() }
                });
                this.toast('Alle Spieler fortgesetzt', 'success');
            },
            
            openKickModal(id) {
                const member = this.members.find(m => m.id === id);
                if (!member) return;
                const action = prompt(`${member.displayName || member.name} entfernen?\n\n1 = Kicken (kann wieder beitreten)\n2 = Bannen (dauerhaft)\n\n0 = Abbrechen`);
                if (action === '1') this.kickPlayer(id);
                else if (action === '2') this.banPlayer(id);
            },
            
            async kickPlayer(id) {
                const member = this.members.find(m => m.id === id);
                const memberName = member?.displayName || member?.name || 'Unbekannt';
                try {
                    // Erst Kick-Broadcast senden (damit der Spieler es mitbekommt)
                    await this.ref().update({
                        broadcast: {
                            type: 'kick',
                            targetId: id,
                            targetName: memberName,
                            message: 'Du wurdest aus dem Raum entfernt.',
                            id: Date.now(),
                            timestamp: firebase.firestore.FieldValue.serverTimestamp()
                        }
                    });
                    // Kurz warten damit Broadcast ankommt
                    await new Promise(r => setTimeout(r, 500));
                    // Dann aus members entfernen
                    await this.ref().collection('members').doc(id).delete();
                    this.toast('Spieler gekickt', 'success');
                    this.addLog('member', `Spieler gekickt: ${memberName}`);
                } catch (e) {
                    console.error('Kick error:', e);
                    this.toast('Fehler beim Kicken', 'error');
                }
            },
            
            async banPlayer(id) {
                const member = this.members.find(m => m.id === id);
                const memberName = member?.displayName || member?.name || 'Unbekannt';
                const reason = prompt('Grund für Ban (optional):') || '';
                try {
                    // Erst Ban-Broadcast senden (damit der Spieler es mitbekommt)
                    await this.ref().update({
                        broadcast: {
                            type: 'ban',
                            targetId: id,
                            targetName: memberName,
                            reason: reason,
                            message: reason ? `Du wurdest gebannt. Grund: ${reason}` : 'Du wurdest gebannt.',
                            id: Date.now(),
                            timestamp: firebase.firestore.FieldValue.serverTimestamp()
                        }
                    });
                    // Kurz warten damit Broadcast ankommt
                    await new Promise(r => setTimeout(r, 500));
                    // In banned collection speichern
                    await this.ref().collection('banned').doc(id).set({
                        displayName: memberName,
                        reason,
                        bannedAt: firebase.firestore.FieldValue.serverTimestamp()
                    });
                    // Aus members entfernen
                    await this.ref().collection('members').doc(id).delete();
                    this.toast('Spieler gebannt', 'success');
                    this.addLog('member', `Spieler gebannt: ${memberName}`);
                } catch (e) {
                    console.error('Ban error:', e);
                    this.toast('Fehler beim Bannen', 'error');
                }
            },
            
            async unban(id) {
                try {
                    await this.ref().collection('banned').doc(id).delete();
                    this.toast('Spieler entbannt', 'success');
                } catch (e) {
                    this.toast('Fehler', 'error');
                }
            },
            
            async transferGM() {
                const target = document.getElementById('gmTransferSelect').value;
                if (!target) return;
                const targetMember = this.members.find(m => m.id === target);
                if (!confirm(`GM-Rolle an "${targetMember?.displayName || targetMember?.name}" übertragen?\n\nDu wirst zum Spieler.`)) return;
                
                const uid = firebase.auth().currentUser?.uid;
                try {
                    await this.ref().update({ gm: target, gmId: target });
                    await this.ref().collection('members').doc(target).update({ role: 'gm' });
                    await this.ref().collection('members').doc(uid).update({ role: 'player' });
                    this.toast('GM-Rolle übertragen!', 'success');
                    setTimeout(() => window.location.href = 'index.html', 1500);
                } catch (e) {
                    this.toast('Fehler', 'error');
                }
            },
            
            // ============ CHARACTER MANAGEMENT ============
            renderCharacters() {
                // Delegate to RiftLink-powered module if available
                if (window.RIFT?.gmChars) {
                    RIFT.gmChars.updateMembers(this.members);
                    // RiftLink handles its own rendering via events
                    return;
                }
                
                // Legacy fallback below
                const grid = document.getElementById('characterGrid');
                const globalActionsContainer = document.getElementById('characterGlobalActions');
                if (!grid) return;
                
                const approved = this.characters.filter(c => c.approved !== false);
                
                // Add global action buttons above character grid
                if (globalActionsContainer) {
                    if (approved.length > 0) {
                        const waChars = approved.filter(c => c.ruleset === 'worldsapart');
                        if (waChars.length > 0) {
                            globalActionsContainer.innerHTML = `
                                <div style="display:flex;gap:8px;margin-bottom:16px;padding:12px;background:rgba(139,92,246,0.1);border-radius:8px;align-items:center;justify-content:flex-start;">
                                    <span style="font-size:13px;color:rgba(255,255,255,0.7);margin-right:8px;">Alle Spieler:</span>
                                    <button class="bc-btn bc-btn--small bc-btn--success" onclick="BC.modifyAllStats('hp', 1)" title="Alle LP erhöhen">+LP alle</button>
                                    <button class="bc-btn bc-btn--small bc-btn--danger" onclick="BC.modifyAllStats('hp', -1)" title="Alle LP verringern">−LP alle</button>
                                    <button class="bc-btn bc-btn--small bc-btn--success" onclick="BC.modifyAllStats('moral', 1)" title="Alle Moral erhöhen">+MO alle</button>
                                    <button class="bc-btn bc-btn--small bc-btn--danger" onclick="BC.modifyAllStats('moral', -1)" title="Alle Moral verringern">−MO alle</button>
                                </div>
                            `;
                        } else {
                            globalActionsContainer.innerHTML = '';
                        }
                    } else {
                        globalActionsContainer.innerHTML = '';
                    }
                }
                
                if (!approved.length) {
                    grid.innerHTML = `
                        <div class="character-card character-card--empty">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" style="width:48px;height:48px;opacity:0.3;margin-bottom:12px;">
                                <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/>
                            </svg>
                            <div style="font-size:16px;margin-bottom:4px;">Keine Charaktere</div>
                            <div style="font-size:13px;">Charaktere erscheinen hier sobald Spieler welche erstellen</div>
                        </div>
                    `;
                    return;
                }
                
                grid.innerHTML = approved.map(c => {
                    const name = this.escapeHtml(c.name || c.characterName || 'Unbenannt');
                    const d = c.data || {};
                    
                    console.log('[BC] Character data:', c.name, c.ruleset, d);
                    
                    // Extract class/level based on ruleset
                    let cls = '–', lvl = '?';
                    let hp = 100, maxHp = 100;
                    let moral = 100, maxMoral = 100;
                    let resonanz = 10, maxResonanz = 100;
                    
                    // Portrait
                    const portrait = c.portrait || d.portrait || null;
                    let portraitHtml = '';
                    if (portrait) {
                        if (portrait.startsWith('data:') || portrait.startsWith('http')) {
                            portraitHtml = `<img src="${portrait}" style="width:100%;height:100%;object-fit:cover;border-radius:6px;">`;
                        } else {
                            // Preset portrait
                            portraitHtml = `<img src="/assets/img/portraits/${portrait}.png" style="width:100%;height:100%;object-fit:cover;border-radius:6px;" onerror="this.style.display='none'">`;
                        }
                    }
                    
                    if (c.ruleset === 'worldsapart') {
                        // WORLDS APART: data.status.health, data.status.moral, calculated resonanz
                        cls = d.role || c.class || '–';
                        lvl = '1'; // WA hat keine Level
                        
                        // Health ist ein Prozent (0-100)
                        hp = parseInt(d.status?.health) || 100;
                        maxHp = 100;
                        
                        // Moral ist ein Prozent (0-100)
                        moral = parseInt(d.status?.moral) || 100;
                        maxMoral = 100;
                        
                        // Resonanz = 10 + (power * presence)
                        const power = parseInt(d.attributes?.power) || 0;
                        const presence = parseInt(d.attributes?.presence) || 0;
                        resonanz = 10 + (power * presence);
                        maxResonanz = 100; // Max sinnvoll
                        
                    } else if (c.ruleset === 'dnd5e' || d.header || d.combat?.hpCurrent !== undefined) {
                        // D&D 5e
                        cls = c.class || d.header?.charClass || d.class || '–';
                        lvl = c.level || d.header?.level || d.level || '?';
                        
                        hp = parseInt(d.combat?.hpCurrent) || c.hp || c.currentHP || 10;
                        maxHp = parseInt(d.combat?.hpMax) || c.maxHp || c.maxHP || hp || 1;
                        
                        // D&D hat keine Moral/Resonanz - zeige andere Stats
                        moral = parseInt(d.combat?.armorClass) || c.ac || 10;
                        maxMoral = 20;
                        resonanz = parseInt(d.combat?.initiative) || c.initiative || 0;
                        maxResonanz = 20;
                        
                    } else if (c.ruleset === 'htbah') {
                        cls = d.class || c.class || '–';
                        lvl = d.level || c.level || '?';
                        hp = c.hp || 100;
                        maxHp = 100;
                        moral = 100;
                        maxMoral = 100;
                        resonanz = 10;
                        maxResonanz = 100;
                    } else {
                        // Fallback
                        cls = c.class || d.class || d.role || '–';
                        lvl = c.level || d.level || '?';
                        hp = c.hp || d.hp || d.status?.health || 100;
                        maxHp = c.maxHp || d.maxHp || 100;
                        moral = c.moral || d.moral || d.status?.moral || 100;
                        maxMoral = c.maxMoral || 100;
                        resonanz = c.resonanz || 10;
                        maxResonanz = 100;
                    }
                    
                    const color = c.color || '#8b5cf6';
                    
                    // Für Worlds Apart: hp/moral/resonanz sind schon Prozent (0-100)
                    // Für andere: berechne Prozent
                    const hpPct = c.ruleset === 'worldsapart' ? hp : Math.round((hp / maxHp) * 100);
                    const hpClass = hpPct > 50 ? 'high' : hpPct > 25 ? 'mid' : 'low';
                    
                    const moralPct = c.ruleset === 'worldsapart' ? moral : Math.round((moral / maxMoral) * 100);
                    const moralClass = moralPct > 50 ? 'high' : moralPct > 25 ? 'mid' : 'low';
                    
                    const resonanzPct = Math.min(100, Math.round((resonanz / maxResonanz) * 100));
                    
                    const ownerId = c.ownerId || c.owner || c.userId;
                    const owner = this.members.find(m => m.id === ownerId);
                    const ownerName = this.escapeHtml(owner?.displayName || owner?.name || 'Unbekannt');
                    const ownerOnline = this.isOnline(ownerId);
                    
                    // Unterschiedliche Labels je nach Ruleset
                    const isWA = c.ruleset === 'worldsapart';
                    const isDnD = c.ruleset === 'dnd5e' || d.header || d.combat?.hpCurrent !== undefined;
                    
                    const stat1Label = isWA ? 'LP' : (isDnD ? 'HP' : 'LP');
                    const stat2Label = isWA ? 'Moral' : (isDnD ? 'RK' : 'Moral');
                    const stat3Label = isWA ? 'Reso' : (isDnD ? 'INI' : 'Reso');
                    
                    const stat1Val = isWA ? `${hp}%` : `${hp}/${maxHp}`;
                    const stat2Val = isWA ? `${moral}%` : (isDnD ? moral : `${moral}%`);
                    const stat3Val = isWA ? resonanz : (isDnD ? (resonanz >= 0 ? `+${resonanz}` : resonanz) : resonanz);
                    
                    // Extract Fokus, Fokus-Fähigkeiten, Schwäche for Worlds Apart
                    let fokusHtml = '';
                    let attributesHtml = '';
                    let secondChanceHtml = '';
                    
                    // Extra info for Worlds Apart
                    const crew = d.crew || '';
                    const age = d.age || '';
                    const gender = d.gender || '';
                    const ageGender = [age, gender].filter(x => x).join(', ');
                    
                    if (isWA) {
                        // fokus can be at multiple locations depending on how data was saved
                        const fokus = d.fokus || c.fokus || {};
                        const schwaeche = d.schwaeche || c.schwaeche; // String ID like "gleichgewicht"
                        
                        console.log('[BC] Character fokus data:', c.name, { fokus, schwaeche, dFokus: d.fokus, cFokus: c.fokus, fullData: d });
                        
                        // Get fokus name from type using the map
                        // fokus.type is the element type like 'fire', 'water', etc.
                        const fokusType = fokus?.type || null;
                        const fokusData = fokusType && fokusType !== 'none' ? WA_FOKUS_NAMES[fokusType] : null;
                        const fokusName = fokusData?.name || (fokusType === 'none' ? 'Keiner' : (fokusType ? this.capitalize(fokusType) : 'Nicht gewählt'));
                        const fokusAttr = fokusData?.attr || '';
                        const fokusColor = fokusData?.color || '#868e96';
                        const fokusFaehigkeiten = fokus?.abilities || [];
                        
                        console.log('[BC] Fokus abilities for', c.name, ':', fokusFaehigkeiten);
                        
                        // Get schwäche name from ID using the map - capitalize if not found
                        const rawSchwaecheName = schwaeche ? (WA_SCHWAECHE_NAMES[schwaeche] || this.capitalize(schwaeche)) : '–';
                        const schwaecheName = rawSchwaecheName;
                        
                        // Build abilities HTML - handle both object format {name: 'x'} and string format 'x'
                        const abilitiesHtml = fokusFaehigkeiten.length > 0 ? fokusFaehigkeiten.map(f => {
                            const abilityName = typeof f === 'string' ? f : (f?.name || f?.desc || JSON.stringify(f));
                            return `<span style="font-size:10px;background:rgba(139,92,246,0.3);padding:2px 5px;border-radius:3px;">${this.escapeHtml(abilityName)}</span>`;
                        }).join('') : '';
                        
                        fokusHtml = `
                            <div style="display:flex;gap:6px;margin-top:8px;">
                                <div style="flex:1;background:rgba(139,92,246,0.15);padding:6px;border-radius:4px;">
                                    <div style="font-size:9px;color:rgba(255,255,255,0.5);text-transform:uppercase;">Fokus</div>
                                    <div style="font-size:12px;font-weight:600;color:${fokusColor};">${this.escapeHtml(fokusName)}</div>
                                    ${fokusAttr ? `<div style="font-size:10px;color:rgba(255,255,255,0.5);">${fokusAttr}</div>` : ''}
                                </div>
                                <div style="flex:1;background:rgba(239,68,68,0.15);padding:6px;border-radius:4px;">
                                    <div style="font-size:9px;color:rgba(255,255,255,0.5);text-transform:uppercase;">Schwäche</div>
                                    <div style="font-size:12px;font-weight:600;color:#f87171;">${this.escapeHtml(schwaecheName)}</div>
                                </div>
                            </div>
                            ${fokusFaehigkeiten.length > 0 ? `
                                <div style="background:rgba(139,92,246,0.1);padding:6px;border-radius:4px;margin-top:6px;">
                                    <div style="font-size:9px;color:rgba(255,255,255,0.5);text-transform:uppercase;margin-bottom:3px;">Fähigkeiten</div>
                                    <div style="display:flex;flex-wrap:wrap;gap:3px;">${abilitiesHtml}</div>
                                </div>
                            ` : ''}
                        `;
                        
                        // Attributes HTML (5 kleine Felder)
                        const attrs = d.attributes || {};
                        const attrLabels = { power: 'KRF', agility: 'GES', endurance: 'ZÄH', mind: 'VER', presence: 'PRÄ' };
                        attributesHtml = `
                            <div style="display:flex;gap:4px;margin-top:8px;">
                                ${['power', 'agility', 'endurance', 'mind', 'presence'].map(attr => `
                                    <div style="flex:1;text-align:center;background:rgba(255,255,255,0.05);padding:4px 2px;border-radius:4px;">
                                        <div style="font-size:14px;font-weight:700;color:white;">${attrs[attr] || 0}</div>
                                        <div style="font-size:8px;color:rgba(255,255,255,0.5);">${attrLabels[attr]}</div>
                                    </div>
                                `).join('')}
                            </div>
                        `;
                        
                        // Second Chance Indikatoren
                        const secondChance = d.secondChance || [false, false, false];
                        secondChanceHtml = `
                            <div style="display:flex;align-items:center;gap:6px;margin-top:8px;">
                                <span style="font-size:9px;color:rgba(255,255,255,0.5);">🍀 2. Chance:</span>
                                <div style="display:flex;gap:3px;">
                                    ${[0, 1, 2].map(i => `
                                        <div style="width:14px;height:14px;border-radius:50%;border:2px solid ${secondChance[i] ? '#22c55e' : 'rgba(255,255,255,0.3)'};background:${secondChance[i] ? '#22c55e' : 'transparent'};"></div>
                                    `).join('')}
                                </div>
                            </div>
                        `;
                    }
                    
                    // Get sheet URL for this character
                    const sheetUrls = {
                        'worldsapart': 'sheet-worldsapart.html',
                        'dnd5e': 'sheet-5e-de.html',
                        'htbah': 'sheet-htbah.html',
                        'cyberpunk': 'sheet-cyberpunk.html'
                    };
                    const sheetUrl = sheetUrls[c.ruleset] || 'sheet-worldsapart.html';
                    const openSheetUrl = `${sheetUrl}?id=${c.id}&room=${this.roomCode}`;
                    
                    return `
                        <div class="character-card" data-id="${c.id}" data-ruleset="${c.ruleset || 'unknown'}" style="display:flex;flex-direction:column;">
                            <!-- Header mit Portrait und Info -->
                            <div style="display:flex;gap:12px;padding:12px;">
                                <!-- Größeres Portrait -->
                                <div style="width:70px;height:70px;flex-shrink:0;background:${color};border-radius:8px;overflow:hidden;display:flex;align-items:center;justify-content:center;font-size:28px;font-weight:700;color:white;">
                                    ${portraitHtml || name[0].toUpperCase()}
                                </div>
                                <!-- Info -->
                                <div style="flex:1;min-width:0;">
                                    <!-- Owner klein -->
                                    <div style="display:flex;align-items:center;gap:4px;font-size:11px;color:rgba(255,255,255,0.5);margin-bottom:2px;">
                                        <div style="width:6px;height:6px;border-radius:50%;background:${ownerOnline ? '#22c55e' : '#6b7280'};"></div>
                                        ${ownerName}
                                    </div>
                                    <!-- Charaktername groß -->
                                    <div style="font-size:16px;font-weight:700;color:white;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">${name}</div>
                                    <!-- Rolle / Crew -->
                                    <div style="font-size:12px;color:rgba(255,255,255,0.7);">${cls}${crew ? ' • ' + this.escapeHtml(crew) : ''}</div>
                                    <!-- Alter / Geschlecht -->
                                    ${ageGender ? `<div style="font-size:11px;color:rgba(255,255,255,0.4);">${this.escapeHtml(ageGender)}</div>` : ''}
                                </div>
                            </div>
                            
                            <!-- Body -->
                            <div style="padding:0 12px 12px;flex:1;display:flex;flex-direction:column;">
                                <!-- Stats: LP, Moral, Reso -->
                                <div style="display:flex;gap:8px;margin-bottom:8px;">
                                    <div style="flex:1;text-align:center;padding:8px;background:rgba(255,255,255,0.05);border-radius:6px;">
                                        <div style="font-size:18px;font-weight:700;color:${hpClass === 'low' ? '#ef4444' : hpClass === 'mid' ? '#f59e0b' : '#22c55e'};">${stat1Val}</div>
                                        <div style="font-size:10px;color:rgba(255,255,255,0.5);">${stat1Label}</div>
                                    </div>
                                    <div style="flex:1;text-align:center;padding:8px;background:rgba(255,255,255,0.05);border-radius:6px;">
                                        <div style="font-size:18px;font-weight:700;color:${moralClass === 'low' ? '#ef4444' : moralClass === 'mid' ? '#f59e0b' : '#3b82f6'};">${stat2Val}</div>
                                        <div style="font-size:10px;color:rgba(255,255,255,0.5);">${stat2Label}</div>
                                    </div>
                                    <div style="flex:1;text-align:center;padding:8px;background:rgba(255,255,255,0.05);border-radius:6px;">
                                        <div style="font-size:18px;font-weight:700;color:#a78bfa;">${stat3Val}</div>
                                        <div style="font-size:10px;color:rgba(255,255,255,0.5);">${stat3Label}</div>
                                    </div>
                                </div>
                                
                                <!-- Attribute (nur WA) -->
                                ${attributesHtml}
                                
                                <!-- Second Chance (nur WA) -->
                                ${secondChanceHtml}
                                
                                <!-- Fokus/Schwäche (nur WA) -->
                                ${fokusHtml}
                                
                                <!-- Spacer -->
                                <div style="flex:1;"></div>
                                
                                <!-- Action Buttons -->
                                <div style="display:grid;grid-template-columns:repeat(2,1fr);gap:4px;margin-top:10px;">
                                    <button class="bc-btn bc-btn--small bc-btn--danger" onclick="BC.modifyStat('${c.id}', 'hp', -1)" title="${isWA ? 'LP' : 'HP'} verringern">−${isWA ? 'LP' : 'HP'}</button>
                                    <button class="bc-btn bc-btn--small bc-btn--success" onclick="BC.modifyStat('${c.id}', 'hp', 1)" title="${isWA ? 'LP' : 'HP'} erhöhen">+${isWA ? 'LP' : 'HP'}</button>
                                    ${!isDnD ? `
                                        <button class="bc-btn bc-btn--small bc-btn--danger" onclick="BC.modifyStat('${c.id}', 'moral', -1)" title="Moral verringern">−MO</button>
                                        <button class="bc-btn bc-btn--small bc-btn--success" onclick="BC.modifyStat('${c.id}', 'moral', 1)" title="Moral erhöhen">+MO</button>
                                    ` : ''}
                                </div>
                                
                                <!-- Footer Buttons (Charakterbogen & Löschen) -->
                                <div style="display:flex;gap:4px;margin-top:8px;padding-top:8px;border-top:1px solid rgba(255,255,255,0.1);">
                                    <button class="bc-btn bc-btn--small bc-btn--secondary" onclick="BC.openCharacterSheet('${c.id}', '${name.replace(/'/g, "\\'")}', '${openSheetUrl}')" title="Charakterbogen öffnen" style="flex:1;font-size:11px;">
                                        Bogen öffnen
                                    </button>
                                    <button class="bc-btn bc-btn--small" onclick="BC.removeCharacterFromRoom('${c.id}', '${name.replace(/'/g, "\\'")}')" title="Aus Raum entfernen" style="padding:4px 8px;font-size:11px;background:rgba(239,68,68,0.2);color:#f87171;">
                                        🗑️
                                    </button>
                                </div>
                            </div>
                        </div>
                    `;
                }).join('');
            },
            
            async modifyStat(id, statType, direction) {
                // Delegate to RiftLink-powered module if available
                if (window.RIFT?.gmChars) {
                    const pathMap = { hp: 'hp.current', moral: 'resource.current', resonanz: 'resource.current' };
                    RIFT.gmChars.modifyStat(id, pathMap[statType] || statType, direction > 0 ? 10 : -10);
                    return;
                }
                
                // Legacy fallback
                const statNames = { hp: 'Lebenspunkte', moral: 'Moral', resonanz: 'Resonanz' };
                const amount = parseInt(prompt(`${statNames[statType]}-Änderung:`, '10')) || 0;
                if (!amount) return;
                
                const char = this.characters.find(c => c.id === id);
                if (!char) return;
                
                const d = char.data || {};
                let currentVal, maxVal, updatePath;
                
                console.log('[BC] modifyStat:', char.name, statType, char.ruleset, d);
                
                if (statType === 'hp') {
                    if (char.ruleset === 'worldsapart') {
                        // WORLDS APART: data.status.health (0-100 percent)
                        currentVal = parseInt(d.status?.health) || 100;
                        maxVal = 100;
                        updatePath = 'data.status.health';
                    } else if (char.ruleset === 'dnd5e' || d.combat?.hpCurrent !== undefined) {
                        // D&D 5e
                        currentVal = parseInt(d.combat?.hpCurrent) || char.hp || 0;
                        maxVal = parseInt(d.combat?.hpMax) || char.maxHp || 100;
                        updatePath = 'data.combat.hpCurrent';
                    } else {
                        // Fallback
                        currentVal = char.hp || char.currentHP || 0;
                        maxVal = char.maxHp || char.maxHP || 100;
                        updatePath = 'hp';
                    }
                } else if (statType === 'moral') {
                    if (char.ruleset === 'worldsapart') {
                        // WORLDS APART: data.status.moral (0-100 percent)
                        currentVal = parseInt(d.status?.moral) || 100;
                        maxVal = 100;
                        updatePath = 'data.status.moral';
                    } else {
                        // Fallback
                        currentVal = char.moral || 0;
                        maxVal = 100;
                        updatePath = 'moral';
                    }
                } else if (statType === 'resonanz') {
                    // Resonanz in Worlds Apart wird berechnet (10 + power*presence)
                    // und kann nicht direkt geändert werden
                    if (char.ruleset === 'worldsapart') {
                        this.toast('Resonanz wird automatisch berechnet (10 + KRF × PRÄ)', 'info');
                        return;
                    }
                    // Fallback für andere Systeme
                    currentVal = char.resonanz || 0;
                    maxVal = 100;
                    updatePath = 'resonanz';
                }
                
                const newVal = Math.max(0, Math.min(maxVal, currentVal + (amount * direction)));
                
                try {
                    const updates = {};
                    updates[updatePath] = newVal;
                    
                    // Also update flat fields for compatibility
                    if (statType === 'hp') {
                        updates.hp = newVal;
                        updates.currentHP = newVal;
                    } else if (statType === 'moral') {
                        updates.moral = newVal;
                    }
                    
                    // Mark as GM modification for player sync
                    updates.lastModifiedBy = 'gm';
                    updates.updatedAt = firebase.firestore.FieldValue.serverTimestamp();
                    
                    console.log('[BC] Updating character:', id, updates);
                    
                    await this.ref().collection('characters').doc(id).update(updates);
                    this.toast(`${statNames[statType]}: ${currentVal}% → ${newVal}%`, 'success');
                    this.addLog('character', `${statNames[statType]} geändert: ${char.name || char.characterName} (${currentVal}% → ${newVal}%)`);
                } catch (e) {
                    console.error('Stat modify error:', e);
                    this.toast('Fehler: ' + e.message, 'error');
                }
            },
            
            async modifyHP(id, direction) {
                // Legacy function - redirect to modifyStat
                this.modifyStat(id, 'hp', direction);
            },
            
            // Modify stat for ALL Worlds Apart characters at once
            async modifyAllStats(statType, direction) {
                // Delegate to RiftLink-powered module if available
                if (window.RIFT?.gmChars) {
                    const pathMap = { hp: 'hp.current', moral: 'resource.current' };
                    RIFT.gmChars.modifyAll(pathMap[statType] || statType, direction);
                    return;
                }
                
                // Legacy fallback
                const statNames = { hp: 'Lebenspunkte', moral: 'Moral' };
                const amount = parseInt(prompt(`${statNames[statType]}-Änderung für ALLE Spieler:`, '10')) || 0;
                if (!amount) return;
                
                // Filter only Worlds Apart characters
                const waChars = this.characters.filter(c => c.ruleset === 'worldsapart');
                if (waChars.length === 0) {
                    this.toast('Keine Worlds Apart Charaktere vorhanden', 'warning');
                    return;
                }
                
                const confirmMsg = `${statNames[statType]} für ${waChars.length} Charakter(e) um ${direction > 0 ? '+' : ''}${amount * direction}% ändern?`;
                if (!confirm(confirmMsg)) return;
                
                let successCount = 0;
                let errors = [];
                
                for (const char of waChars) {
                    const d = char.data || {};
                    let currentVal, maxVal, updatePath;
                    
                    if (statType === 'hp') {
                        currentVal = parseInt(d.status?.health) || 100;
                        maxVal = 100;
                        updatePath = 'data.status.health';
                    } else if (statType === 'moral') {
                        currentVal = parseInt(d.status?.moral) || 100;
                        maxVal = 100;
                        updatePath = 'data.status.moral';
                    }
                    
                    const newVal = Math.max(0, Math.min(maxVal, currentVal + (amount * direction)));
                    
                    try {
                        const updates = {};
                        updates[updatePath] = newVal;
                        
                        // Also update flat fields for compatibility
                        if (statType === 'hp') {
                            updates.hp = newVal;
                            updates.currentHP = newVal;
                        } else if (statType === 'moral') {
                            updates.moral = newVal;
                        }
                        
                        // Mark as GM modification for player sync
                        updates.lastModifiedBy = 'gm';
                        updates.updatedAt = firebase.firestore.FieldValue.serverTimestamp();
                        
                        await this.ref().collection('characters').doc(char.id).update(updates);
                        successCount++;
                    } catch (e) {
                        console.error('Bulk modify error for', char.name, e);
                        errors.push(char.name);
                    }
                }
                
                if (errors.length > 0) {
                    this.toast(`${successCount} aktualisiert, ${errors.length} Fehler`, 'warning');
                } else {
                    this.toast(`${statNames[statType]} für ${successCount} Charakter(e) geändert`, 'success');
                }
                
                this.addLog('character', `Massen-${statNames[statType]}-Änderung: ${amount * direction}% für ${successCount} Charaktere`);
            },
            
            // ============ CHARACTER SHEET MODAL ============
            openCharacterSheet(charId, charName, sheetUrl) {
                console.log('[BC] openCharacterSheet called:', { charId, charName, sheetUrl });
                
                const modal = document.getElementById('characterSheetModal');
                const frame = document.getElementById('characterSheetFrame');
                const title = document.getElementById('characterSheetModalTitle');
                
                console.log('[BC] Modal elements:', { modal: !!modal, frame: !!frame, title: !!title });
                
                if (!modal || !frame) {
                    console.error('[BC] Modal elements not found!');
                    this.toast('Modal nicht gefunden!', 'error');
                    return;
                }
                
                // Set title
                if (title) {
                    title.textContent = `Charakterbogen: ${charName}`;
                }
                
                // Build URL with GM mode parameter
                const fullUrl = `${sheetUrl}&gm=true`;
                console.log('[BC] Opening character sheet:', fullUrl);
                
                // Set iframe source
                frame.src = fullUrl;
                
                // Show modal
                modal.classList.add('active');
                document.body.style.overflow = 'hidden';
                
                console.log('[BC] Modal should be visible now');
            },
            
            closeCharacterSheet(event) {
                // If called with event, only close if clicking the backdrop
                if (event && event.target !== event.currentTarget) return;
                
                const modal = document.getElementById('characterSheetModal');
                const frame = document.getElementById('characterSheetFrame');
                
                if (modal) {
                    modal.classList.remove('active');
                    document.body.style.overflow = '';
                }
                if (frame) {
                    frame.src = 'about:blank';
                }
            },
            
            async removeCharacterFromRoom(charId, charName) {
                if (!confirm(`"${charName}" wirklich aus dem Raum entfernen?\n\nDer Charakter wird nur aus der Raum-Übersicht entfernt, nicht beim Spieler gelöscht.`)) {
                    return;
                }
                
                try {
                    const charRef = this.ref().collection('characters').doc(charId);
                    await charRef.delete();
                    
                    this.toast(`"${charName}" entfernt`, 'success');
                    console.log('[BC] Removed character from room:', charId);
                    
                    // Log action
                    this.addLog({
                        type: 'character',
                        action: 'removed_from_room',
                        characterName: charName,
                        characterId: charId
                    });
                } catch (e) {
                    console.error('[BC] Failed to remove character:', e);
                    this.toast('Fehler beim Entfernen', 'error');
                }
            },
            
            // ============ LOGS ============
            renderLogs() {
                const list = document.getElementById('activityLogList');
                const countDisplay = document.getElementById('logCount');
                if (!list) return;
                
                let filtered = this.logs;
                
                // Apply filter
                if (this.logFilter !== 'all') {
                    filtered = filtered.filter(l => l.type === this.logFilter);
                }
                
                // Apply search
                if (this.logSearch) {
                    const search = this.logSearch.toLowerCase();
                    filtered = filtered.filter(l => 
                        (l.message || '').toLowerCase().includes(search) ||
                        (l.userName || l.user || '').toLowerCase().includes(search) ||
                        (l.characterName || '').toLowerCase().includes(search) ||
                        (l.field || '').toLowerCase().includes(search) ||
                        (l.action || '').toLowerCase().includes(search) ||
                        (l.notation || '').toLowerCase().includes(search)
                    );
                }
                
                if (countDisplay) {
                    countDisplay.textContent = `${filtered.length} Einträge`;
                }
                
                // Keep existing error messages
                const existingErrors = list.querySelectorAll('.log-error');
                
                if (!filtered.length) {
                    list.innerHTML = `
                        <div style="padding:40px;text-align:center;color:rgba(255,255,255,0.4);">
                            <div style="margin-bottom:12px;color:rgba(255,255,255,0.15);"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" style="width:40px;height:40px;"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg></div>
                            <div>Keine Log-Einträge</div>
                            <div style="font-size:12px;margin-top:8px;">Würfelwürfe, Chat und Änderungen erscheinen hier</div>
                        </div>
                    `;
                    existingErrors.forEach(e => list.prepend(e));
                    return;
                }
                
                list.innerHTML = filtered.slice(0, 200).map(log => {
                    // Handle various timestamp formats
                    let time = null;
                    if (log.timestamp) {
                        if (log.timestamp.toDate) {
                            time = log.timestamp.toDate();
                        } else if (log.timestamp.seconds) {
                            time = new Date(log.timestamp.seconds * 1000);
                        } else if (typeof log.timestamp === 'number') {
                            time = new Date(log.timestamp);
                        }
                    }
                    
                    const timeStr = time ? time.toLocaleTimeString('de-DE', { hour: '2-digit', minute: '2-digit', second: '2-digit' }) : '--:--:--';
                    const dateStr = time ? time.toLocaleDateString('de-DE', { day: '2-digit', month: '2-digit' }) : '';
                    
                    const user = this.escapeHtml(log.userName || log.senderName || log.user || log.player || log.playerName || log.displayName || 'System');
                    const action = this.getLogAction(log);
                    const detail = this.getLogDetail(log);
                    
                    return `
                        <div class="activity-log-item" data-type="${log.type}">
                            <div class="activity-log-item__time">${dateStr}<br>${timeStr}</div>
                            <div class="activity-log-item__icon activity-log-item__icon--${log.type}">${log.icon}</div>
                            <div class="activity-log-item__content">
                                <span class="activity-log-item__user">${user}</span>
                                <span class="activity-log-item__action">${action}</span>
                                ${detail ? `<div class="activity-log-item__detail">${detail}</div>` : ''}
                            </div>
                        </div>
                    `;
                }).join('');
                
                // Re-add error messages
                existingErrors.forEach(e => list.prepend(e));
            },
            
            getLogAction(log) {
                if (log.collection === 'dice') return 'hat gewürfelt';
                if (log.collection === 'chat') return 'schrieb';
                if (log.collection === 'broadcast') return 'sendete Broadcast';
                
                // Changelog entries und type-basierte Logs
                if (log.collection === 'changelog' || log.type === 'character' || log.type === 'member') {
                    if (log.type === 'character') {
                        if (log.action === 'created') return 'erstellte Charakter';
                        if (log.action === 'change') return `änderte ${log.field || 'etwas'}`;
                        return 'änderte Charakter';
                    }
                    if (log.type === 'member') {
                        if (log.action === 'joined') return 'ist beigetreten';
                        if (log.action === 'left') return 'hat verlassen';
                        if (log.action === 'profile_change') return `änderte ${log.field || 'Profil'}`;
                        return log.action || 'Aktion';
                    }
                    // Fallback für alte changelog Einträge
                    return log.action || 'änderte etwas';
                }
                
                return '';
            },
            
            getLogDetail(log) {
                if (log.collection === 'dice') {
                    // Support both old and new format
                    const notation = log.notation || log.formula || log.dice || '?';
                    const result = log.total || log.result || '?';
                    const critical = log.critical;
                    
                    let html = `<span style="font-family:monospace;">${notation}</span> → <strong>${result}</strong>`;
                    
                    // Add critical indicator
                    if (critical === 'success') {
                        html += ' <span style="color:#22c55e;font-weight:bold;">KRITISCH!</span>';
                    } else if (critical === 'failure') {
                        html += ' <span style="color:#ef4444;font-weight:bold;">PATZER!</span>';
                    }
                    
                    // Add secret indicator
                    if (log.secret) {
                        html += ' <span style="color:#f59e0b;font-size:11px;">Geheim</span>';
                    }
                    
                    return html;
                }
                if (log.collection === 'chat') {
                    return this.escapeHtml(log.message || log.text || '');
                }
                if (log.collection === 'broadcast') {
                    return this.escapeHtml(log.message || `[${log.type}]`);
                }
                
                // Changelog entries (persistent logs) - check by type
                if (log.collection === 'changelog' || log.type === 'character' || log.type === 'member') {
                    if (log.type === 'character') {
                        if (log.action === 'created') {
                            return `<strong>${this.escapeHtml(log.characterName || 'Charakter')}</strong>`;
                        }
                        if (log.action === 'change') {
                            let html = `<strong>${this.escapeHtml(log.characterName || 'Charakter')}</strong>: `;
                            html += `<span style="color:rgba(255,255,255,0.5);">${this.escapeHtml(String(log.oldValue || '-'))}</span>`;
                            html += ` → <span style="color:#22c55e;">${this.escapeHtml(String(log.newValue || '-'))}</span>`;
                            return html;
                        }
                        // Fallback für alte changelog Einträge
                        if (log.field) {
                            let html = `<strong>${this.escapeHtml(log.characterName || 'Charakter')}</strong>: `;
                            html += `${this.escapeHtml(log.field)} `;
                            html += `<span style="color:rgba(255,255,255,0.5);">${this.escapeHtml(String(log.oldValue || '-'))}</span>`;
                            html += ` → <span style="color:#22c55e;">${this.escapeHtml(String(log.newValue || '-'))}</span>`;
                            return html;
                        }
                    }
                    if (log.type === 'member') {
                        if (log.action === 'joined') {
                            return `Willkommen!`;
                        }
                        if (log.action === 'profile_change') {
                            let html = `<span style="color:rgba(255,255,255,0.5);">${this.escapeHtml(String(log.oldValue || '-'))}</span>`;
                            html += ` → <span style="color:#22c55e;">${this.escapeHtml(String(log.newValue || '-'))}</span>`;
                            return html;
                        }
                    }
                    // Generic fallback
                    if (log.description || log.details) {
                        return this.escapeHtml(log.description || log.details);
                    }
                }
                
                return '';
            },
            
            filterLogs(filter) {
                this.logFilter = filter;
                document.querySelectorAll('.bc-log-filter').forEach(f => f.classList.toggle('active', f.dataset.filter === filter));
                this.renderLogs();
            },
            
            searchLogs(query) {
                this.logSearch = query;
                this.renderLogs();
            },
            
            exportLogs() {
                const data = this.logs.map(l => ({
                    time: l.timestamp?.toDate?.()?.toISOString() || '',
                    type: l.type,
                    user: l.userName || l.user || '',
                    action: this.getLogAction(l),
                    detail: this.getLogDetail(l).replace(/<[^>]*>/g, '')
                }));
                
                const csv = 'Zeit,Typ,Benutzer,Aktion,Detail\n' + data.map(d => 
                    `"${d.time}","${d.type}","${d.user}","${d.action}","${d.detail}"`
                ).join('\n');
                
                const blob = new Blob([csv], { type: 'text/csv' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `rift-logs-${this.roomCode}-${new Date().toISOString().split('T')[0]}.csv`;
                a.click();
                URL.revokeObjectURL(url);
                this.toast('Logs exportiert!', 'success');
            },
            
            addLog(type, message) {
                // Add to local history (for immediate feedback)
                this.addToHistory(type, message);
            },
            
            /**
             * Fügt einen Live-Log hinzu (für Echtzeit-Tracking von Änderungen)
             * Speichert auch persistent in Firestore
             */
            recentLogHashes: new Set(),
            
            async addLiveLog(logData) {
                // Erstelle Hash zur Duplikat-Vermeidung
                const hash = `${logData.type}_${logData.action}_${logData.field}_${logData.characterId || logData.userId}_${logData.newValue}`;
                
                // Prüfe auf Duplikat (innerhalb der letzten 5 Sekunden)
                if (this.recentLogHashes.has(hash)) {
                    console.log('[BC] Duplicate log skipped:', hash);
                    return;
                }
                
                // Hash speichern und nach 5 Sekunden entfernen
                this.recentLogHashes.add(hash);
                setTimeout(() => this.recentLogHashes.delete(hash), 5000);
                
                // Persistent nach Firestore speichern (wird dann via subLogs() gelesen)
                try {
                    await this.ref().collection('changelog').add({
                        ...logData,
                        timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                        clientTimestamp: Date.now()
                    });
                    console.log('[BC] Log persisted:', logData.type, logData.action, logData.field);
                } catch (e) {
                    console.warn('[BC] Failed to persist log:', e);
                }
                // Note: renderLogs wird automatisch durch den onSnapshot listener in subLogs() aufgerufen
            },
            
            // ============ SETTINGS ============
            initSettings() {
                // Set room code display
                const roomCodeDisplay = document.getElementById('roomCodeDisplay');
                const roomCodeInput = document.getElementById('roomCodeInput');
                const inviteLinkInput = document.getElementById('inviteLinkInput');
                
                if (roomCodeDisplay) roomCodeDisplay.textContent = this.roomCode.replace(/(.{3})(.{3})/, '$1-$2');
                if (roomCodeInput) roomCodeInput.value = this.roomCode;
                if (inviteLinkInput) inviteLinkInput.value = `${window.location.origin}/login.html?room=${this.roomCode}`;
                
                // Load room settings
                this.loadRoomSettings();
            },
            
            async loadRoomSettings() {
                try {
                    const doc = await this.ref().get();
                    const settings = doc.data()?.settings || {};
                    
                    const mapEdit = document.getElementById('settingMapEdit');
                    const notes = document.getElementById('settingNotes');
                    const multiChar = document.getElementById('settingMultiChar');
                    
                    if (mapEdit) mapEdit.checked = settings.mapEdit === true;
                    if (notes) notes.checked = settings.notes !== false;
                    if (multiChar) multiChar.checked = settings.multiChar === true;
                } catch (e) {
                    console.error('[BC] Error loading settings:', e);
                }
            },
            
            async saveSetting(key, value) {
                try {
                    await this.ref().update({ [`settings.${key}`]: value });
                    this.toast('Einstellung gespeichert', 'success');
                } catch (e) {
                    this.toast('Fehler', 'error');
                }
            },
            
            copyRoomCode() {
                navigator.clipboard.writeText(this.roomCode);
                this.toast('Raum-Code kopiert!', 'success');
            },
            
            copyInviteLink() {
                const link = `${window.location.origin}/join.html?room=${this.roomCode}`;
                navigator.clipboard.writeText(link);
                this.toast('Einladungslink kopiert!', 'success');
            },
            
            async leaveRoom() {
                const uid = firebase.auth().currentUser?.uid;
                const member = this.members.find(m => m.id === uid);
                
                if (member?.role === 'gm') {
                    this.toast('Als GM musst du erst die Rolle übertragen!', 'error');
                    return;
                }
                
                if (!confirm('Raum verlassen?')) return;
                
                try {
                    await this.ref().collection('members').doc(uid).delete();
                    localStorage.removeItem('rift_current_room');
                    window.location.href = 'sessions.html';
                } catch (e) {
                    this.toast('Fehler', 'error');
                }
            },
            
            async deleteRoom() {
                const uid = firebase.auth().currentUser?.uid;
                const member = this.members.find(m => m.id === uid);
                
                if (member?.role !== 'gm') {
                    this.toast('Nur der GM kann den Raum löschen!', 'error');
                    return;
                }
                
                if (!confirm('Raum WIRKLICH löschen?\n\nAlle Daten werden unwiderruflich gelöscht!')) return;
                if (!confirm('LETZTE WARNUNG!\n\nDieser Vorgang kann nicht rückgängig gemacht werden.')) return;
                
                this.toast('Lösche Raum...', 'info');
                
                try {
                    const collections = ['members', 'characters', 'sessions', 'chat', 'dice', 'broadcasts', 'waitlist', 'banned', 'notes', 'changelog', 'polls', 'maps'];
                    for (const col of collections) {
                        const snap = await this.ref().collection(col).get();
                        for (const doc of snap.docs) await doc.ref.delete();
                    }
                    await this.ref().delete();
                    localStorage.removeItem('rift_current_room');
                    this.toast('Raum gelöscht!', 'success');
                    setTimeout(() => window.location.href = 'sessions.html', 1500);
                } catch (e) {
                    console.error('[BC] Delete error:', e);
                    this.toast('Fehler beim Löschen', 'error');
                }
            },
            
            formatDate(d) {
                if (!d) return '–';
                const now = new Date();
                const diff = now - d;
                if (diff < 60000) return 'Gerade eben';
                if (diff < 3600000) return Math.floor(diff / 60000) + ' Min';
                if (diff < 86400000) return Math.floor(diff / 3600000) + ' Std';
                return d.toLocaleDateString('de', { day: '2-digit', month: '2-digit' });
            },

            // ══════════════════════════════════
            //  TOOLS PANEL
            // ══════════════════════════════════

            _chatUnsub: null,
            _sessionUnsub: null,
            _diceLog: [],

            initTools() {
                if (!this.roomCode || !this.db) return;
                console.log('[BC] Initializing Tools panel...');

                // Wire up quicklinks with room code
                const sheetLink = document.getElementById('toolsSheetLink');
                if (sheetLink) {
                    sheetLink.href = `/pages/sheets/sheet-worldsapart.html?room=${this.roomCode}`;
                }

                this.initLiveChat();
                this.initSessionStatus();
                this.initDiceHistory();
            },

            // ── Live Chat Feed ──
            initLiveChat() {
                const feed = document.getElementById('gmChatFeed');
                if (!feed || !this.db) return;

                if (this._chatUnsub) this._chatUnsub();

                this._chatUnsub = this.ref().collection('chat')
                    .orderBy('timestamp', 'desc').limit(20)
                    .onSnapshot(snap => {
                        const msgs = snap.docs.map(d => ({ id: d.id, ...d.data() })).reverse();
                        this.renderChatFeed(msgs);
                    }, e => {
                        console.warn('[BC] Chat feed error:', e);
                        feed.innerHTML = '<div class="gm-chat-empty">Chat nicht verfügbar</div>';
                    });

                // Send on Enter
                const input = document.getElementById('gmChatInput');
                if (input) {
                    input.addEventListener('keydown', (e) => {
                        if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); this.sendGMChat(); }
                    });
                }
            },

            renderChatFeed(msgs) {
                const feed = document.getElementById('gmChatFeed');
                if (!feed) return;

                if (!msgs.length) {
                    feed.innerHTML = '<div class="gm-chat-empty">Noch keine Nachrichten</div>';
                    return;
                }

                feed.innerHTML = msgs.filter(m => !m.deleted).map(m => {
                    const cls = m.isGM ? 'gm-chat-msg gm-chat-msg--gm' : (m.isWhisper ? 'gm-chat-msg gm-chat-msg--whisper' : 'gm-chat-msg');
                    const time = m.timestamp?.toDate ? m.timestamp.toDate().toLocaleTimeString('de', { hour: '2-digit', minute: '2-digit' }) : '';
                    const name = m.senderName || 'Unbekannt';
                    const text = m.text || (m.imageUrl ? '[Bild]' : (m.gifUrl ? '[GIF]' : ''));
                    const whisperTag = m.isWhisper ? ` → ${m.whisperToName || '?'}` : '';
                    return `<div class="${cls}"><span class="gm-chat-msg__name">${name}${whisperTag}</span><span class="gm-chat-msg__text">${this.escapeHtml(text)}</span><span class="gm-chat-msg__time">${time}</span></div>`;
                }).join('');

                feed.scrollTop = feed.scrollHeight;
            },
            async sendGMChat() {
                const input = document.getElementById('gmChatInput');
                if (!input || !this.db) return;
                const text = input.value.trim();
                if (!text) return;

                try {
                    await this.ref().collection('chat').add({
                        text,
                        senderId: this.userId,
                        senderName: this.userName || 'GM',
                        senderColor: '#d4a844',
                        senderAvatar: null,
                        isGM: true,
                        timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                        clientTimestamp: Date.now(),
                        reactions: {}
                    });
                    input.value = '';
                } catch (e) {
                    console.error('[BC] Chat send error:', e);
                }
            },

            // ── GM Dice ──
            gmRoll(sides) {
                const result = Math.floor(Math.random() * sides) + 1;
                const isSecret = document.getElementById('gmDiceSecret')?.checked;
                const doBroadcast = document.getElementById('gmDiceBroadcast')?.checked;

                // Display
                const resultEl = document.getElementById('gmDiceResult');
                if (resultEl) {
                    const isCrit = sides === 20 && result === 20;
                    const isFail = sides === 20 && result === 1;
                    resultEl.innerHTML = `
                        <div class="gm-dice-result__value" style="${isCrit ? 'color:#22c55e' : isFail ? 'color:#ef4444' : ''}">${result}</div>
                        <div class="gm-dice-result__detail">D${sides}${isSecret ? ' (geheim)' : ''}</div>
                    `;
                }

                // Log
                const isCrit = sides === 20 && result === 20;
                const isFail = sides === 20 && result === 1;
                const cls = isCrit ? 'crit' : (isFail ? 'fail' : '');
                const time = new Date().toLocaleTimeString('de', { hour: '2-digit', minute: '2-digit', second: '2-digit' });
                this._diceLog.unshift(`<div class="${cls}">${time} — D${sides}: <strong>${result}</strong>${isSecret ? ' (geheim)' : ''}</div>`);
                if (this._diceLog.length > 20) this._diceLog.pop();
                const logEl = document.getElementById('gmDiceLog');
                if (logEl) logEl.innerHTML = this._diceLog.join('');

                // Broadcast to players
                if (doBroadcast && !isSecret && this.db) {
                    this.ref().collection('dice').add({
                        type: 'gm-roll',
                        formula: `1d${sides}`,
                        result,
                        roller: this.userName || 'GM',
                        rollerId: this.userId,
                        isGM: true,
                        timestamp: firebase.firestore.FieldValue.serverTimestamp()
                    }).catch(e => console.warn('[BC] Dice broadcast error:', e));
                }
            },

            gmRollCustom() {
                const input = document.getElementById('gmDiceFormula');
                if (!input) return;
                const formula = input.value.trim();
                if (!formula) return;

                // Parse: NdM+K or NdM-K
                const match = formula.match(/^(\d+)?d(\d+)([+-]\d+)?$/i);
                if (!match) { this.toast('Format: NdM+K (z.B. 2d6+4)', 'warning'); return; }

                const count = parseInt(match[1] || '1', 10);
                const sides = parseInt(match[2], 10);
                const mod = parseInt(match[3] || '0', 10);

                if (count < 1 || count > 20 || sides < 2 || sides > 100) {
                    this.toast('Ungültige Würfelformel', 'warning');
                    return;
                }

                const rolls = [];
                for (let i = 0; i < count; i++) rolls.push(Math.floor(Math.random() * sides) + 1);
                const sum = rolls.reduce((a, b) => a + b, 0) + mod;

                const resultEl = document.getElementById('gmDiceResult');
                const isSecret = document.getElementById('gmDiceSecret')?.checked;
                if (resultEl) {
                    resultEl.innerHTML = `
                        <div class="gm-dice-result__value">${sum}</div>
                        <div class="gm-dice-result__detail">${formula} = [${rolls.join(', ')}]${mod ? (mod > 0 ? '+' : '') + mod : ''}${isSecret ? ' (geheim)' : ''}</div>
                    `;
                }

                const time = new Date().toLocaleTimeString('de', { hour: '2-digit', minute: '2-digit', second: '2-digit' });
                this._diceLog.unshift(`<div>${time} — ${formula}: <strong>${sum}</strong> [${rolls.join(',')}]${isSecret ? ' (geheim)' : ''}</div>`);
                if (this._diceLog.length > 20) this._diceLog.pop();
                const logEl = document.getElementById('gmDiceLog');
                if (logEl) logEl.innerHTML = this._diceLog.join('');

                const doBroadcast = document.getElementById('gmDiceBroadcast')?.checked;
                if (doBroadcast && !isSecret && this.db) {
                    this.ref().collection('dice').add({
                        type: 'gm-roll', formula, result: sum, rolls,
                        roller: this.userName || 'GM', rollerId: this.userId, isGM: true,
                        timestamp: firebase.firestore.FieldValue.serverTimestamp()
                    }).catch(e => console.warn('[BC] Dice broadcast error:', e));
                }
            },

            // ── Session Status ──
            initSessionStatus() {
                if (!this.db || !this.roomCode) return;
                const statusEl = document.getElementById('gmSessionStatus');
                const infoEl = document.getElementById('gmSessionInfo');
                const actionsEl = document.getElementById('gmSessionActions');

                // Listen for active sessions
                if (this._sessionUnsub) this._sessionUnsub();

                this._sessionUnsub = this.ref().collection('sessions')
                    .where('status', 'in', ['live', 'paused'])
                    .limit(1)
                    .onSnapshot(snap => {
                        if (snap.empty) {
                            if (statusEl) statusEl.innerHTML = '<span class="gm-session-dot gm-session-dot--offline"></span> Keine aktive Session';
                            if (infoEl) infoEl.innerHTML = '<p style="font-size:12px;color:rgba(255,255,255,0.4)">Keine Session aktiv. Starte eine über den Session-Manager.</p>';
                            if (actionsEl) actionsEl.innerHTML = '<a href="/pages/sessions.html" target="_blank" class="bc-btn bc-btn--full bc-btn--secondary">Session-Manager öffnen</a>';
                            return;
                        }

                        const session = snap.docs[0].data();
                        const sessionId = snap.docs[0].id;
                        const isPaused = session.status === 'paused';

                        if (statusEl) {
                            statusEl.innerHTML = `<span class="gm-session-dot gm-session-dot--online" style="${isPaused ? 'background:#f59e0b;box-shadow:0 0 6px rgba(245,158,11,0.5)' : ''}"></span> ${isPaused ? 'Pausiert' : 'Live'}`;
                        }

                        const startTime = session.startTime?.toDate ? session.startTime.toDate() : null;
                        const elapsed = startTime ? this.formatElapsed(Date.now() - startTime.getTime() - (session.totalPausedMs || 0)) : '?';

                        if (infoEl) {
                            infoEl.innerHTML = `
                                <p><strong>${session.name || 'Unbenannte Session'}</strong></p>
                                <p>Laufzeit: ${elapsed} &middot; Status: ${isPaused ? 'Pausiert' : 'Live'}</p>
                            `;
                        }

                        if (actionsEl) {
                            actionsEl.innerHTML = `
                                <a href="/pages/session.html?id=${sessionId}" target="_blank" class="bc-btn bc-btn--full bc-btn--secondary">Session öffnen</a>
                            `;
                        }
                    }, e => {
                        console.warn('[BC] Session status error:', e);
                    });
            },

            formatElapsed(ms) {
                if (ms < 0) ms = 0;
                const h = Math.floor(ms / 3600000);
                const m = Math.floor((ms % 3600000) / 60000);
                return h > 0 ? `${h}h ${m}min` : `${m}min`;
            },

            // ── Dice History from Firebase ──
            _diceHistoryUnsub: null,

            initDiceHistory() {
                if (!this.db || !this.roomCode) return;

                if (this._diceHistoryUnsub) this._diceHistoryUnsub();

                this._diceHistoryUnsub = this.ref().collection('dice')
                    .orderBy('timestamp', 'desc').limit(15)
                    .onSnapshot(snap => {
                        const rolls = snap.docs.map(d => ({ id: d.id, ...d.data() }));
                        this.renderDiceHistory(rolls);
                    }, e => {
                        console.warn('[BC] Dice history error:', e);
                    });
            },

            renderDiceHistory(rolls) {
                const logEl = document.getElementById('gmDiceLog');
                if (!logEl) return;

                // Merge local GM rolls with Firebase rolls
                const combined = rolls.map(r => {
                    const time = r.timestamp?.toDate ? r.timestamp.toDate().toLocaleTimeString('de', { hour: '2-digit', minute: '2-digit' }) : '';
                    const name = this.escapeHtml(r.roller || r.playerName || 'Unbekannt');
                    const formula = r.formula || (r.diceType ? `1d${r.diceType}` : '?');
                    const result = r.result ?? r.total ?? '?';
                    const isGM = r.isGM;
                    const isCrit = (r.diceType === 20 || formula.includes('d20')) && result === 20;
                    const isFail = (r.diceType === 20 || formula.includes('d20')) && result === 1;
                    const cls = isCrit ? 'crit' : (isFail ? 'fail' : '');
                    return `<div class="${cls}">${time} <strong style="color:${isGM ? '#d4a844' : '#a78bfa'}">${name}</strong> ${formula}: <strong>${result}</strong></div>`;
                });

                logEl.innerHTML = combined.join('') || '<div style="color:rgba(255,255,255,0.2)">Noch keine Würfe</div>';
            }
        };
        
        // Keyframe animations
        const style = document.createElement('style');
        style.textContent = `
            @keyframes slideIn { from { transform: translateX(100px); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
            @keyframes slideOut { from { transform: translateX(0); opacity: 1; } to { transform: translateX(100px); opacity: 0; } }
        `;
        document.head.appendChild(style);
        
        // Init AFTER layout is fully rendered
        // Use requestAnimationFrame to wait for next render cycle after initLayout()
        requestAnimationFrame(() => {
            requestAnimationFrame(() => {
                BC.init();
                // Hash-based tab navigation (from whiteboard buttons)
                const hashTab = location.hash.replace('#', '');
                if (hashTab && ['broadcast','poll','effects','players','characters','logs','settings','history','tools'].includes(hashTab)) {
                    setTimeout(() => BC.switchTab(hashTab), 300);
                }
            });
        });
    </script>
    
    <!-- Character Sheet Modal/Popup - MUST be outside all containers -->
    <div id="characterSheetModal" class="character-sheet-modal" onclick="BC.closeCharacterSheet(event)">
        <div class="character-sheet-modal__content" onclick="event.stopPropagation()">
            <div class="character-sheet-modal__header">
                <span id="characterSheetModalTitle">Charakterbogen</span>
                <button class="character-sheet-modal__close" onclick="BC.closeCharacterSheet()">&times;</button>
            </div>
            <iframe id="characterSheetFrame" src="about:blank"></iframe>
        </div>
    </div>
</body>
</html>
