<!DOCTYPE html>
<html lang="de">
<head>
    <link rel="icon" type="image/svg+xml" href="/assets/icons/icon_rift_r.svg">
    <base href="/">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Charakterbogen | Worlds Apart | RIFT</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Rounded:opsz,wght,FILL,GRAD@24,400,1,0" rel="stylesheet">
    <!-- Unified Layout CSS (same order as dice.html) -->
    <link rel="stylesheet" href="../../assets/css/core.css">
    <link rel="stylesheet" href="../../assets/css/ui.css">
    <link rel="stylesheet" href="../../assets/css/dock.css">
    <link rel="stylesheet" href="../../assets/css/hub.css">
    <style>
        :root {
            /* Layout */
            --sidebar-width: 0px;
            
            /* Map local variables to core.css variables */
            --bg-darkest: var(--black, #161616);
            --bg-dark: var(--bg, #1a1a1a);
            --bg-card-hover: #252525;
            --bg-input: var(--black, #161616);
            --hover-bg: rgba(255, 255, 255, 0.06);
            
            /* Primary Accent - RIFT Red */
            --accent-primary: var(--accent, #FF4655);
            --accent-primary-light: #ff6b77;
            --accent-primary-dim: var(--red-dim, rgba(255, 70, 85, 0.12));
            --accent-primary-glow: var(--red-glow, rgba(255, 70, 85, 0.4));
            
            /* Gold for special elements */
            --accent-gold: #fbbf24;
            --accent-gold-dim: rgba(251, 191, 36, 0.12);
            
            /* Status Colors */
            --color-health: #22c55e;
            --color-moral: #3b82f6;
            --color-resonanz: #8b5cf6;
            --color-green: #22c55e;
            
            /* Text - map to core.css */
            --text-primary: var(--text, #dedede);
            --text-secondary: var(--text-muted, #bebebe);
            
            /* Borders - map to core.css */
            --border-subtle: var(--border, rgba(255, 255, 255, 0.06));
            --border-default: var(--border-hover, rgba(255, 255, 255, 0.1));
            
            /* Spacing */
            --gap-xs: 4px;
            --gap-sm: 8px;
            --gap-md: 12px;
            --gap-lg: 16px;
            --gap-xl: 24px;
        }

        /* ===== PAGE HEADER (RIFT Style) ===== */
        .page-header {
            display: flex;
            align-items: center;
            gap: 16px;
            padding: 24px 24px 0 24px;
            margin-bottom: 0;
        }
        
        .wa-back-btn {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 8px 14px;
            margin-left: 8px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            color: var(--text-secondary, #999);
            font-size: 13px;
            font-weight: 500;
            text-decoration: none;
            transition: all 0.2s ease;
            white-space: nowrap;
        }
        
        .wa-back-btn:first-of-type {
            margin-left: auto;
        }
        
        .wa-back-btn:hover {
            background: rgba(255, 255, 255, 0.1);
            border-color: rgba(255, 255, 255, 0.2);
            color: var(--text-primary, #fff);
        }
        
        .wa-back-btn svg {
            width: 14px;
            height: 14px;
            flex-shrink: 0;
        }

        .page-header__icon {
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--text-secondary);
        }

        .page-header__icon svg {
            width: 20px;
            height: 20px;
            fill: currentColor;
        }

        .page-header__divider {
            width: 1px;
            height: 28px;
            background: rgba(255, 255, 255, 0.2);
        }

        .page-header__title {
            font-family: 'Dharma Gothic', sans-serif;
            font-size: 56px;
            font-weight: 700;
            font-style: italic;
            color: var(--text-primary);
            margin: 0;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .page-header__tagline {
            color: var(--accent-primary);
            font-family: 'Dharma Gothic', sans-serif;
            font-size: 24px;
            font-weight: 400;
            font-style: italic;
        }

        .section-divider {
            height: 1px;
            background: linear-gradient(90deg, transparent, var(--border-default), transparent);
            margin: 16px 24px 24px 24px;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            color: var(--text-primary);
            min-height: 100vh;
            line-height: 1.5;
            font-size: 14px;
            background: #0a0a0a;
        }

        /* RIFT App Container - Unified Layout */
        .app {
            min-height: 100vh;
            width: 100% !important;
            display: block !important; /* Override flex from core.css */
        }
        
        /* Unified Layout für Sheet */
        .main, .main--hub {
            position: relative !important;
            background: #0a0a0a !important;
            width: 100% !important;
            display: block !important; /* Override flex from core.css */
            margin-left: 0 !important; /* Override sheet-layout.css sidebar offset! */
        }
        
        /* Deaktiviere hub.css ::before - wir machen es anders */
        .main--hub::before {
            display: none !important;
        }
        
        .main__content {
            position: relative !important;
            z-index: 1 !important;
            max-width: 1500px !important;
            width: 100% !important;
            margin: 0 auto !important;
            padding: 121px 50px 0 50px !important;
            background: #111111 !important; /* Hintergrund direkt auf Content */
            display: block !important;
        }

        /* ===== FOOTER STYLES ===== */
        .site-footer {
            background: transparent;
            border-top: 1px solid var(--border-subtle);
            margin-top: var(--gap-xl);
            padding: var(--gap-xl) 16px;
        }

        .footer-divider {
            display: none;
        }

        .footer-content {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: var(--gap-sm);
            opacity: 0.7;
            transition: opacity 0.2s;
        }

        .footer-content:hover {
            opacity: 1;
        }

        .footer-primary,
        .footer-secondary,
        .footer-tertiary {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: var(--gap-sm);
        }

        .footer-primary a,
        .footer-secondary a,
        .footer-tertiary a {
            color: var(--text-secondary);
            text-decoration: none;
            font-size: 13px;
            transition: color 0.15s;
        }

        .footer-primary a:hover,
        .footer-secondary a:hover,
        .footer-tertiary a:hover {
            color: var(--text-primary);
        }

        .footer-dot {
            color: var(--text-muted);
            font-size: 13px;
        }

        .footer-copyright {
            color: var(--text-muted);
            font-size: 12px;
            margin-top: var(--gap-sm);
        }

        .footer-lang-btn {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            margin-top: var(--gap-md);
            padding: 8px 16px;
            background: var(--bg-elevated);
            border: 1px solid var(--border-subtle);
            border-radius: 20px;
            color: var(--text-secondary);
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.15s;
        }

        .footer-lang-btn:hover {
            background: var(--bg-card-hover);
            border-color: var(--accent-primary);
            color: var(--text-primary);
        }

        /* Background Image - handled by rift.css */

        /* ===== LAYOUT ===== */
        .sheet-container {
            max-width: 100%; /* Nutzt den verfügbaren Platz innerhalb main__content */
            margin: 0;
            padding: 0;
            padding-bottom: 80px;
        }

        /* 2x2 Grid */
        .main-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: var(--gap-lg) 40px;
            margin-bottom: var(--gap-lg);
        }

        .grid-section {
            position: relative;
        }

        /* Grid dividers removed for cleaner RIFT look */

        /* ===== CARDS ===== */
        .card {
            background: var(--bg-card);
            border-radius: var(--radius-lg);
            border: 1px solid var(--border-subtle);
            overflow: hidden;
        }
        
        /* Character card needs overflow visible for level badge */
        #character-card {
            overflow: visible;
        }
        
        /* Fokus card needs overflow visible for ability tooltips */
        #fokus-card {
            overflow: visible;
        }
        
        #fokus-card .card-header {
            border-radius: var(--radius-lg) var(--radius-lg) 0 0;
        }
        
        #character-card .card-header {
            border-radius: var(--radius-lg) var(--radius-lg) 0 0; /* Obere Ecken abrunden */
        }
        
        #character-card .card-body {
            overflow: visible;
        }

        .card-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: var(--gap-md) var(--gap-lg);
            border-bottom: 1px solid var(--border-subtle);
            background: var(--bg-elevated);
        }

        .card-title {
            font-family: 'Dharma Gothic', sans-serif;
            font-size: 16px;
            font-weight: 700;
            font-style: italic;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: rgba(255, 255, 255, 0.5);
            display: flex;
            align-items: center;
            gap: var(--gap-sm);
        }

        .card-title-icon {
            font-family: 'Material Symbols Rounded';
            font-size: 20px;
            font-weight: normal;
            font-style: normal;
            line-height: 1;
            letter-spacing: normal;
            text-transform: none;
            display: inline-block;
            white-space: nowrap;
            word-wrap: normal;
            direction: ltr;
            -webkit-font-smoothing: antialiased;
        }

        .card-actions {
            display: flex;
            gap: var(--gap-sm);
        }

        .card-action-btn {
            width: 28px;
            height: 28px;
            border-radius: var(--radius-sm);
            background: var(--bg-elevated);
            border: none;
            color: var(--text-muted);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.15s;
            position: relative;
            z-index: 10;
        }

        .card-action-btn:hover {
            background: var(--bg-card-hover);
            color: var(--accent-primary);
            animation: diceWobble 0.5s ease;
        }

        .card-action-btn:active {
            animation: diceClick 0.15s ease;
        }

        .card-action-btn svg {
            width: 14px;
            height: 14px;
            pointer-events: none;
        }

        /* GM-only elements - hidden by default */
        .gm-only {
            display: none !important;
        }

        .gm-mode .gm-only {
            display: flex !important;
        }

        .card-action-btn.gm-only {
            background: rgba(139, 92, 246, 0.15);
            border-color: rgba(139, 92, 246, 0.3);
            color: #a78bfa;
        }

        .card-action-btn.gm-only:hover {
            background: rgba(139, 92, 246, 0.25);
            border-color: rgba(139, 92, 246, 0.5);
        }

        .card-body {
            padding: var(--gap-lg);
        }

        /* ===== CHARACTER CARD ===== */
        .character-layout {
            display: grid;
            grid-template-columns: auto 1fr;
            gap: var(--gap-xl);
            overflow: visible;
        }

        .character-visual {
            display: flex;
            flex-direction: column;
            gap: var(--gap-sm);
            align-items: center;
            overflow: visible;
        }

        .portrait-container {
            position: relative;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 0;
            margin-bottom: 12px; /* Platz für Level-Badge der rausragt */
            overflow: visible;
        }

        .portrait {
            width: 140px;
            height: 210px; /* 2:3 ratio */
            border-radius: var(--radius-md);
            background: var(--bg-elevated);
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: visible; /* Level-Badge kann rausragen */
            transition: all 0.2s;
            border: 1px solid var(--border-subtle);
            position: relative;
        }
        
        .portrait:hover {
            border-color: var(--border-default);
        }
        
        .portrait img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: var(--radius-md); /* Bild selbst abrunden */
        }

        .portrait-placeholder {
            color: var(--text-muted);
            font-size: 10px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .portrait-health-overlay {
            position: absolute;
            inset: 0;
            pointer-events: none;
            z-index: 3;
            border-radius: var(--radius-md);
            transition: all 0.3s;
        }

        .portrait-health-overlay.critical {
            box-shadow: inset 0 0 15px rgba(220, 38, 38, 0.4);
            animation: pulse-critical 2s infinite;
        }

        .portrait-health-overlay.low {
            box-shadow: inset 0 0 12px rgba(245, 158, 11, 0.3);
        }

        .portrait-health-overlay.dead {
            background: rgba(0, 0, 0, 0.6);
        }

        /* healthy = no effect */
        .portrait-health-overlay.healthy {
            /* Intentionally empty - no vignette when healthy */
        }

        @keyframes pulse-critical {
            0%, 100% { box-shadow: inset 0 0 15px rgba(220, 38, 38, 0.4); }
            50% { box-shadow: inset 0 0 20px rgba(220, 38, 38, 0.5); }
        }

        .portrait-controls-row {
            position: absolute;
            bottom: 24px; /* Über dem Level-Badge */
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            align-items: center;
            gap: 8px;
            z-index: 4;
        }

        .portrait-controls-row .img-control-btn {
            opacity: 0;
            transition: opacity 0.2s ease;
        }

        .portrait:hover .portrait-controls-row .img-control-btn {
            opacity: 1;
        }

        .level-badge {
            position: absolute;
            bottom: -16px;
            left: 50%;
            transform: translateX(-50%);
            background: var(--accent-primary);
            color: white;
            font-size: 14px;
            font-weight: 700;
            width: 32px;
            height: 32px;
            border-radius: 50%;
            display: grid;
            place-items: center;
            cursor: pointer;
            transition: all 0.2s;
            line-height: 1;
            padding: 0;
            margin: 0;
            z-index: 5;
            border: 2px solid var(--bg-card);
        }

        .level-badge:hover {
            transform: translateX(-50%) scale(1.1);
        }

        .crew-flag-controls {
            position: absolute;
            bottom: 4px;
            right: 4px;
            display: none;
            gap: 4px;
            z-index: 10;
        }

        .crew-flag-container:hover .crew-flag-controls {
            display: flex;
        }

        .img-control-btn {
            width: 24px;
            height: 24px;
            border-radius: var(--radius-sm);
            background: rgba(0, 0, 0, 0.7);
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.15s;
        }

        .img-control-btn .card-title-icon {
            font-size: 14px;
            color: white;
        }

        .img-control-btn:hover {
            background: var(--accent-primary);
        }

        .img-control-btn.delete:hover {
            background: #dc2626;
        }

        .img-control-btn.gallery:hover {
            background: #2563eb;
        }

        /* Portrait Gallery Modal */
        .portrait-gallery-item {
            aspect-ratio: 3/4;
            border-radius: var(--radius-md);
            overflow: hidden;
            cursor: pointer;
            background: var(--bg-elevated);
            transition: all 0.15s ease;
            position: relative;
        }

        .portrait-gallery-item:hover {
            transform: scale(1.03);
            box-shadow: 0 4px 20px rgba(249, 115, 22, 0.3);
        }

        .portrait-gallery-item img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .loading-spinner {
            width: 32px;
            height: 32px;
            border: 3px solid var(--border);
            border-top-color: var(--accent-primary);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .img-control-btn.small {
            width: 20px;
            height: 20px;
        }

        .img-control-btn.small .card-title-icon {
            font-size: 12px;
        }

        .crew-flag-container {
            position: relative;
            margin-top: 4px;
        }

        .crew-flag {
            width: 140px;
            height: 80px; /* ~7:4 ratio for crew flags */
            border-radius: var(--radius-sm);
            background: var(--bg-elevated);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
            border: 1px solid var(--border-subtle);
            transition: all 0.2s;
        }

        .crew-flag:hover {
            border-color: var(--accent-primary);
        }

        .crew-flag img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .crew-flag-placeholder {
            color: var(--text-muted);
            font-size: 9px;
            text-transform: uppercase;
        }

        .character-info {
            display: flex;
            flex-direction: column;
            gap: var(--gap-md);
            height: 100%;
        }

        .character-name {
            background: transparent;
            border: none;
            font-family: 'Dharma Gothic', sans-serif;
            font-size: 42px;
            font-weight: 700;
            font-style: italic;
            letter-spacing: 1px;
            color: var(--text-primary);
            outline: none;
            padding: 0;
            width: 100%;
            padding-bottom: var(--gap-sm);
            border-bottom: 1px solid var(--border-subtle);
        }

        .character-name:focus {
            border-color: var(--accent-primary);
        }

        .character-name::placeholder {
            color: var(--text-muted);
        }

        .character-meta {
            display: flex;
            gap: var(--gap-md);
            color: var(--text-secondary);
            font-size: 13px;
        }

        .character-meta-item {
            display: flex;
            align-items: center;
            gap: var(--gap-xs);
        }

        .character-meta-item input {
            background: transparent;
            border: none;
            color: var(--text-secondary);
            font-size: 13px;
            outline: none;
            width: 80px;
        }

        .character-meta-item select {
            background: var(--bg-input);
            border: 1px solid var(--border-subtle);
            border-radius: var(--radius-sm);
            color: var(--text-secondary);
            font-size: 12px;
            padding: 6px 10px;
            outline: none;
            cursor: pointer;
            appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 24 24' fill='none' stroke='%23888' stroke-width='2'%3E%3Cpath d='M6 9l6 6 6-6'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 8px center;
            padding-right: 28px;
            min-width: 100px;
        }

        .character-meta-item select:hover {
            border-color: var(--border-hover);
        }

        .character-meta-item select:focus {
            border-color: var(--accent-primary);
        }

        .character-meta-item select option {
            background: var(--bg-card);
            color: var(--text-primary);
        }

        .character-fields {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: var(--gap-sm);
            flex: 1;
        }

        .field-group {
            display: flex;
            flex-direction: column;
            gap: var(--gap-xs);
        }

        .field-label {
            font-size: 10px;
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: var(--text-muted);
        }

        .field-input {
            background: var(--bg-input);
            border: 1px solid var(--border-subtle);
            border-radius: var(--radius-sm);
            padding: var(--gap-sm) var(--gap-md);
            font-size: 13px;
            color: var(--text-primary);
            outline: none;
            transition: border-color 0.2s;
        }

        .field-input:focus {
            border-color: var(--border-default);
        }

        .field-textarea {
            background: var(--bg-input);
            border: 1px solid var(--border-subtle);
            border-radius: var(--radius-sm);
            padding: var(--gap-sm) var(--gap-md);
            font-size: 12px;
            color: var(--text-primary);
            outline: none;
            resize: none;
            min-height: 88px;
            font-family: inherit;
            grid-column: 1 / -1;
            align-self: stretch;
        }

        .field-textarea:focus {
            border-color: var(--border-default);
        }

        /* ===== ATTRIBUTES CARD ===== */
        .attributes-layout {
            display: flex;
            align-items: center;
            gap: 0;
        }

        .attributes-left {
            display: flex;
            flex-direction: column;
            align-items: center;
            min-width: 0;
        }

        .attributes-top-row {
            display: flex;
            justify-content: center;
            gap: var(--gap-lg);
        }

        .attributes-bottom-row {
            display: flex;
            justify-content: center;
            gap: var(--gap-lg);
            margin-top: var(--gap-md);
        }

        .attr-points-row {
            display: flex;
            justify-content: center;
            margin-bottom: var(--gap-md);
        }

        .attributes-divider {
            width: 1px;
            background: var(--border-subtle);
            margin: 0 var(--gap-xl);
            align-self: stretch;
        }

        .initiative-box-wrapper {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 2px;
            transform: translate(25px, 20px);
        }

        .initiative-box {
            background-color: transparent;
            border: none;
            border-radius: 0;
            padding: var(--gap-lg) var(--gap-xl);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 2px;
            width: 120px;
            min-width: 120px;
            max-width: 120px;
            height: 205px;
            transition: all 0.2s;
            position: relative;
            z-index: 1;
            cursor: default;
        }

        .initiative-box::before {
            content: '';
            position: absolute;
            inset: 0;
            background-image: url('https://res.cloudinary.com/dza4jgreq/image/upload/v1770589272/kkowjbtqantjop0pfbyf.svg');
            background-size: 100% 100%;
            background-repeat: no-repeat;
            opacity: 0.6;
            z-index: -1;
            transition: opacity 0.2s;
            filter: invert(1) brightness(0.553);
        }

        .initiative-box:hover::before {
            opacity: 1;
        }

        .initiative-value {
            font-size: 52px;
            font-weight: 700;
            color: var(--text-primary);
            line-height: 1;
            text-align: center;
            width: 100%;
        }

        .initiative-value input {
            background: transparent;
            border: none;
            width: 100%;
            text-align: center;
            font-size: 52px;
            font-weight: 700;
            color: inherit;
            outline: none;
            -moz-appearance: textfield;
            padding: 0;
            margin: 0;
        }

        .initiative-value input::-webkit-outer-spin-button,
        .initiative-value input::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }

        .initiative-name {
            font-size: 10px;
            font-weight: 500;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .initiative-base {
            background: var(--bg-card);
            border-radius: var(--radius-sm);
            padding: 2px 8px;
            font-size: 11px;
            font-weight: 600;
            color: var(--text-secondary);
            margin-top: 2px;
        }

        /* ===== MOVEMENT & RANGE BAR ===== */
        .movement-range-bar {
            display: flex;
            align-items: center;
            gap: var(--gap-md);
            margin-top: var(--gap-lg);
            padding: 6px 12px;
            background: var(--bg-elevated);
            border-radius: var(--radius-sm);
            border: 1px solid var(--border-subtle);
            height: 35px;
            width: 100%;
        }

        .mr-section {
            display: flex;
            align-items: center;
            gap: 6px;
            white-space: nowrap;
        }

        .mr-label {
            font-size: 11px;
            font-weight: 600;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.3px;
        }

        .mr-value {
            font-size: 14px;
            font-weight: 700;
            color: var(--text-primary);
            min-width: 20px;
            text-align: center;
        }

        .mr-unit {
            font-size: 10px;
            color: var(--text-muted);
        }

        .mr-divider {
            width: 1px;
            height: 18px;
            background: var(--border-subtle);
            flex-shrink: 0;
        }

        .mr-select {
            background: var(--bg-input);
            border: 1px solid var(--border-subtle);
            border-radius: var(--radius-sm);
            color: var(--text-secondary);
            font-size: 11px;
            padding: 3px 24px 3px 8px;
            outline: none;
            cursor: pointer;
            appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='10' height='10' viewBox='0 0 24 24' fill='none' stroke='%23888' stroke-width='2'%3E%3Cpath d='M6 9l6 6 6-6'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 6px center;
        }

        .mr-select:hover {
            border-color: var(--border-hover);
        }

        .mr-select option {
            background: var(--bg-card);
            color: var(--text-primary);
        }

        .mr-bonus {
            font-size: 10px;
            color: var(--text-muted);
            font-style: italic;
        }

        .attribute-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 2px;
            cursor: pointer;
            transition: transform 0.15s;
            padding: 0 var(--gap-sm);
        }

        .attribute-item:hover {
            transform: translateY(-2px);
        }

        .attribute-item:hover .attribute-box {
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
        }

        .attribute-item:hover .attribute-box::before {
            opacity: 1;
        }

        .attribute-box {
            background-color: transparent;
            border: none;
            border-radius: 0;
            padding: var(--gap-lg) var(--gap-xl);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 2px;
            width: 100px;
            min-width: 100px;
            max-width: 100px;
            transition: all 0.2s;
            position: relative;
            z-index: 1;
        }

        .attribute-box::before {
            content: '';
            position: absolute;
            inset: -4px;
            background-image: url('https://res.cloudinary.com/dza4jgreq/image/upload/v1770589273/ohnl9ibnjbbijmxl3oyt.svg');
            background-size: 100% 100%;
            background-repeat: no-repeat;
            opacity: 0.6;
            z-index: -1;
            transition: opacity 0.2s;
            filter: invert(1) brightness(0.553);
        }

        .attribute-box:hover::before {
            opacity: 1;
        }

        .attribute-modifier {
            font-size: 26px;
            font-weight: 700;
            color: var(--text-primary);
            line-height: 1;
            text-align: center;
            width: 100%;
        }

        .attribute-modifier.positive {
            color: var(--color-green);
        }

        .attribute-modifier.negative {
            color: var(--color-health);
        }

        .attribute-modifier input {
            background: transparent;
            border: none;
            width: 100%;
            text-align: center;
            font-size: 26px;
            font-weight: 700;
            color: inherit;
            outline: none;
            -moz-appearance: textfield;
            padding: 0;
            margin: 0;
        }

        .attribute-modifier input::-webkit-outer-spin-button,
        .attribute-modifier input::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }

        .attribute-name {
            font-size: 10px;
            font-weight: 500;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .attribute-base {
            background: var(--bg-card);
            border-radius: var(--radius-sm);
            padding: 2px 8px;
            font-size: 11px;
            font-weight: 600;
            color: var(--text-secondary);
            margin-top: 2px;
        }

        .attr-points-badge {
            font-size: 11px;
            font-weight: 600;
            color: var(--color-green);
            padding: 6px 14px;
            background: rgba(34, 197, 94, 0.15);
            border-radius: 20px;
            transition: all 0.2s;
        }

        /* ===== STATUS CARD ===== */
        .status-layout {
            display: flex;
            flex-direction: column;
            gap: var(--gap-md);
        }

        .status-bars {
            display: flex;
            flex-direction: column;
            gap: var(--gap-md);
        }

        .status-item {
            display: flex;
            align-items: center;
            gap: var(--gap-md);
        }

        .status-values {
            display: flex;
            align-items: baseline;
            gap: 2px;
            min-width: 120px;
            flex-shrink: 0;
        }

        .status-current {
            font-size: 24px;
            font-weight: 700;
            background: transparent;
            border: none;
            color: var(--text-primary);
            width: 55px;
            outline: none;
            text-align: right;
            -moz-appearance: textfield;
        }

        .status-current::-webkit-outer-spin-button,
        .status-current::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }

        .status-current-display {
            font-size: 24px;
            font-weight: 700;
            color: var(--text-primary);
            width: 55px;
            text-align: right;
            display: inline-block;
        }

        .status-separator {
            color: var(--text-muted);
            font-size: 16px;
        }

        .status-max {
            font-size: 14px;
            color: var(--text-muted);
            width: 30px;
        }

        .status-bar-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .status-label {
            font-size: 10px;
            font-weight: 500;
            text-transform: uppercase;
            color: var(--text-muted);
        }

        .status-bar {
            height: 8px;
            background: var(--bg-input);
            border-radius: 4px;
            overflow: hidden;
        }

        .status-bar.draggable {
            cursor: ew-resize;
            transition: transform 0.1s ease;
        }

        .status-bar.draggable:hover {
            transform: scaleY(1.3);
        }

        .status-bar.draggable:active {
            transform: scaleY(1.5);
        }

        .status-bar-fill {
            height: 100%;
            border-radius: 4px;
            transition: width 0.3s ease;
            background-size: 200% 100%;
            animation: gradient-shift 8s ease infinite;
        }

        @keyframes gradient-shift {
            0%, 100% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
        }

        .status-bar-fill.health { background: linear-gradient(90deg, #166534, #22c55e, #166534); background-size: 200% 100%; }
        .status-bar-fill.moral { background: linear-gradient(90deg, #1d4ed8, #60a5fa, #1d4ed8); background-size: 200% 100%; }
        .status-bar-fill.resonanz { background: linear-gradient(90deg, #6d28d9, #a78bfa, #6d28d9); background-size: 200% 100%; }

        /* Critical pulse animations for low HP/Moral */
        @keyframes bar-pulse-red {
            0%, 100% { 
                box-shadow: 0 0 8px rgba(220, 38, 38, 0.6);
                filter: brightness(1);
            }
            50% { 
                box-shadow: 0 0 16px rgba(220, 38, 38, 0.9);
                filter: brightness(1.2);
            }
        }

        @keyframes bar-pulse-blue {
            0%, 100% { 
                box-shadow: 0 0 8px rgba(59, 130, 246, 0.6);
                filter: brightness(1);
            }
            50% { 
                box-shadow: 0 0 16px rgba(59, 130, 246, 0.9);
                filter: brightness(1.2);
            }
        }

        .status-bar-fill.health.critical {
            animation: bar-pulse-red 1.5s ease-in-out infinite;
        }

        .status-bar-fill.moral.critical {
            animation: bar-pulse-blue 1.5s ease-in-out infinite;
        }

        .status-info-box {
            margin-top: var(--gap-md);
            padding-top: var(--gap-md);
            border-top: 1px solid var(--border-subtle);
            display: flex;
            flex-direction: column;
            gap: var(--gap-xs);
        }

        .status-info-item {
            display: flex;
            align-items: center;
            gap: var(--gap-sm);
        }

        .status-info-row {
            display: flex;
            align-items: center;
            gap: var(--gap-sm);
        }

        .status-info-icon {
            font-size: 6px;
            flex-shrink: 0;
        }

        .status-info-text {
            font-size: 9px;
            color: var(--text-muted);
            line-height: 1.4;
        }

        .status-extras {
            display: none;
        }

        /* Dice / Second Chance */
        .dice-section {
            background: var(--bg-elevated);
            border-radius: var(--radius-md);
            padding: var(--gap-md);
        }

        .dice-section-title {
            font-size: 10px;
            font-weight: 500;
            text-transform: uppercase;
            color: var(--text-muted);
            margin-bottom: var(--gap-sm);
        }

        .dice-row {
            display: flex;
            gap: var(--gap-sm);
        }

        .dice-row-large {
            display: flex;
            gap: var(--gap-md);
            justify-content: center;
            padding: var(--gap-sm) 0;
        }

        .dice-check {
            width: 36px;
            height: 36px;
            background: var(--bg-card);
            border: 1px solid var(--border-default);
            border-radius: var(--radius-sm);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.15s;
        }

        .dice-check-large {
            width: 64px;
            height: 64px;
            background: var(--bg-elevated);
            border: 2px solid var(--border-default);
            border-radius: var(--radius-md);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .dice-check:hover, .dice-check-large:hover {
            border-color: var(--accent-primary);
            transform: scale(1.05);
        }

        .dice-check-large:not(.used):active {
            transform: scale(0.95);
        }

        /* Dissolve animation keyframes */
        @keyframes dice-dissolve {
            0% {
                opacity: 1;
                transform: scale(1);
                filter: blur(0) saturate(1);
            }
            30% {
                opacity: 0.8;
                transform: scale(1.1);
                filter: blur(1px) saturate(0.5);
            }
            60% {
                opacity: 0.4;
                transform: scale(0.9);
                filter: blur(3px) saturate(0.2);
            }
            100% {
                opacity: 0.3;
                transform: scale(1);
                filter: blur(0) saturate(0.3);
            }
        }

        @keyframes dice-particles {
            0% {
                box-shadow: 
                    0 0 0 rgba(239, 68, 68, 0),
                    inset 0 0 0 rgba(239, 68, 68, 0);
            }
            50% {
                box-shadow: 
                    0 0 20px rgba(239, 68, 68, 0.6),
                    inset 0 0 15px rgba(239, 68, 68, 0.4);
            }
            100% {
                box-shadow: 
                    0 0 5px rgba(239, 68, 68, 0.2),
                    inset 0 0 5px rgba(239, 68, 68, 0.1);
            }
        }

        .dice-check-large.dissolving {
            animation: dice-dissolve 0.8s ease-out forwards, dice-particles 0.8s ease-out forwards;
            pointer-events: none;
        }

        /* Restore animation for GM reset */
        @keyframes dice-restore {
            0% {
                opacity: 0.35;
                transform: scale(0.9);
                filter: blur(2px);
                box-shadow: 0 0 20px rgba(139, 92, 246, 0);
            }
            50% {
                opacity: 0.7;
                transform: scale(1.1);
                filter: blur(0);
                box-shadow: 0 0 25px rgba(139, 92, 246, 0.8);
            }
            100% {
                opacity: 1;
                transform: scale(1);
                filter: blur(0);
                box-shadow: 0 0 0 rgba(139, 92, 246, 0);
            }
        }

        .dice-check-large.restoring {
            animation: dice-restore 0.4s ease-out forwards;
            pointer-events: none;
        }

        .dice-check.used, .dice-check-large.used {
            background: rgba(239, 68, 68, 0.15);
            border-color: rgba(239, 68, 68, 0.4);
            opacity: 0.35;
            cursor: not-allowed;
        }

        .dice-check-large.used svg {
            fill: rgba(239, 68, 68, 0.5);
        }

        .dice-check svg {
            width: 20px;
            height: 20px;
            fill: var(--text-secondary);
        }

        .dice-check-large svg {
            width: 42px;
            height: 42px;
            fill: var(--text-secondary);
            transition: fill 0.3s ease;
        }

        /* Currency - inline in inventory */
        .currency-row-inline {
            display: flex;
            align-items: center;
            gap: var(--gap-sm);
            padding: var(--gap-sm) var(--gap-md);
            background: var(--bg-elevated);
            border-radius: var(--radius-md);
            margin-bottom: var(--gap-md);
        }

        .currency-label {
            font-size: 10px;
            font-weight: 500;
            text-transform: uppercase;
            color: var(--text-muted);
            min-width: 55px;
        }

        .currency-icon {
            width: 24px;
            height: 24px;
            cursor: pointer;
            transition: opacity 0.15s, filter 0.15s;
            filter: brightness(0) saturate(100%) invert(58%) sepia(6%) saturate(70%) hue-rotate(202deg);
        }

        .currency-icon:hover {
            filter: none;
        }

        .weapon-icon {
            width: 24px;
            height: 24px;
            font-size: 24px;
            color: #868688;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .currency-input-inline {
            flex: 1;
            max-width: 120px;
            background: var(--bg-card);
            border: 1px solid var(--border-subtle);
            border-radius: var(--radius-sm);
            padding: 6px var(--gap-sm);
            font-size: 14px;
            font-weight: 600;
            color: var(--accent-gold);
            outline: none;
            -moz-appearance: textfield;
        }

        .currency-input-inline::-webkit-outer-spin-button,
        .currency-input-inline::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }

        .weapon-input {
            max-width: none;
            flex: 1;
            color: var(--text-primary);
            font-weight: 500;
        }

        /* Text areas row */
        .text-areas-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: var(--gap-md);
        }

        /* Currency Section - old styles kept for compatibility */
        .currency-section {
            background: var(--bg-elevated);
            border-radius: var(--radius-md);
            padding: var(--gap-md);
        }

        .currency-row {
            display: flex;
            align-items: center;
            gap: var(--gap-sm);
        }

        .currency-input {
            flex: 1;
            background: var(--bg-card);
            border: 1px solid var(--border-subtle);
            border-radius: var(--radius-sm);
            padding: 6px var(--gap-sm);
            font-size: 14px;
            font-weight: 600;
            color: var(--accent-gold);
            outline: none;
        }

        /* ===== FOKUS CARD ===== */

        .fokus-layout {
            display: flex;
            flex-direction: column;
            gap: var(--gap-md);
            position: relative;
        }

        .fokus-header {
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
            cursor: pointer;
            padding: 20px 16px 16px;
            border-radius: var(--radius-lg);
            transition: background 0.2s;
            position: relative;
            z-index: 2;
            background: var(--bg-elevated);
            border: 1px solid var(--border-subtle);
            overflow: hidden;
        }

        .fokus-header:hover {
            background: rgba(255,255,255,0.04);
        }

        .fokus-icon {
            width: 64px;
            height: 64px;
            border-radius: 50%;
            background: var(--bg-base);
            display: flex;
            align-items: center;
            justify-content: center;
            border: 2px solid var(--border-default);
            flex-shrink: 0;
            transition: all 0.3s;
            position: relative;
            margin-bottom: 10px;
        }

        .fokus-icon img {
            width: 36px;
            height: 36px;
        }

        .fokus-particles {
            position: absolute;
            top: 0;
            left: 50%;
            transform: translateX(-50%);
            width: 80px;
            height: 80px;
            pointer-events: none;
            z-index: 1;
        }

        .fokus-particle {
            position: absolute;
            bottom: 0;
            width: 4px;
            height: 4px;
            border-radius: 50%;
            opacity: 0;
            animation: particle-float 4s infinite ease-out;
        }

        .fokus-particle:nth-child(1) { left: 10%; animation-delay: 0s; }
        .fokus-particle:nth-child(2) { left: 30%; animation-delay: 0.6s; }
        .fokus-particle:nth-child(3) { left: 50%; animation-delay: 1.2s; }
        .fokus-particle:nth-child(4) { left: 70%; animation-delay: 1.8s; }
        .fokus-particle:nth-child(5) { left: 90%; animation-delay: 2.4s; }
        .fokus-particle:nth-child(6) { left: 20%; animation-delay: 3s; }
        .fokus-particle:nth-child(7) { left: 60%; animation-delay: 3.3s; }
        .fokus-particle:nth-child(8) { left: 40%; animation-delay: 0.3s; }

        @keyframes particle-float {
            0% {
                opacity: 0;
                transform: translateY(0) scale(1);
            }
            10% {
                opacity: 0.9;
            }
            100% {
                opacity: 0;
                transform: translateY(-70px) scale(0.3);
            }
        }

        .fokus-info {
            width: 100%;
        }

        .fokus-name {
            font-size: 20px;
            font-weight: 700;
            color: var(--text-primary);
            letter-spacing: 0.5px;
        }

        .fokus-attr {
            font-size: 12px;
            color: var(--text-secondary);
            margin-top: 4px;
        }

        .fokus-abilities {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: var(--gap-sm);
        }

        .fokus-ability {
            background: var(--bg-elevated);
            border-radius: var(--radius-md);
            padding: var(--gap-md);
            border: 1px solid var(--border-subtle);
            cursor: pointer;
            transition: all 0.15s;
            position: relative;
        }

        .fokus-ability:hover {
            border-color: rgba(255,255,255,0.15);
            background: rgba(255,255,255,0.04);
        }

        .fokus-ability.empty {
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 70px;
        }

        .fokus-ability.empty span {
            color: var(--text-muted);
            font-size: 12px;
        }

        .fokus-ability.no-fokus-message {
            grid-column: 1 / -1;
            background: var(--bg-input);
            text-align: center;
            padding: var(--gap-lg);
        }

        .no-fokus-text {
            color: var(--text-muted);
            font-size: 13px;
            font-style: italic;
        }

        .fokus-ability-type {
            font-size: 9px;
            font-weight: 600;
            text-transform: uppercase;
            color: var(--accent-red);
            margin-bottom: 2px;
            letter-spacing: 0.5px;
        }

        .fokus-ability-name {
            font-size: 14px;
            font-weight: 600;
            margin-bottom: 6px;
        }

        .fokus-ability-tags {
            display: flex;
            gap: 6px;
            margin-bottom: 6px;
        }

        .fokus-ability-tag {
            font-family: var(--font-mono);
            font-size: 12px;
            font-weight: 500;
            padding: 4px 10px;
            border-radius: var(--radius-sm);
            background: rgba(255,255,255,0.06);
            color: var(--text-secondary);
            white-space: nowrap;
            display: flex;
            align-items: center;
        }

        .fokus-ability-tag-status {
            font-size: 11px;
            font-weight: 500;
            padding: 3px 10px;
            border-radius: var(--radius-sm);
            margin-bottom: 6px;
            white-space: nowrap;
            display: inline-block;
        }

        .fokus-ability-desc {
            font-size: 11px;
            color: var(--text-secondary);
            line-height: 1.4;
        }

        .fokus-ability-tooltip {
            display: none;
            position: absolute;
            bottom: calc(100% + 10px);
            left: 50%;
            transform: translateX(-50%);
            background: #111119;
            border: 1px solid rgba(255,255,255,0.08);
            border-radius: 10px;
            padding: 0;
            font-family: var(--font-mono);
            font-size: 11px;
            color: rgba(255,255,255,0.7);
            z-index: 100;
            box-shadow: 0 8px 32px rgba(0,0,0,0.8);
            pointer-events: none;
            min-width: 220px;
            max-width: 260px;
            max-height: 400px;
            overflow-y: auto;
            overflow-x: hidden;
        }

        .fokus-ability:hover .fokus-ability-tooltip,
        .fokus-ability-tooltip.tooltip-active {
            display: block;
        }

        .tt-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 12px;
        }

        .tt-l {
            color: rgba(255,255,255,0.35);
            font-size: 10px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            flex-shrink: 0;
        }

        .tt-v {
            color: rgba(255,255,255,0.85);
            font-weight: 500;
            text-align: right;
        }

        /* Extended tooltip description sections */
        .tt-section {
            padding: 6px 12px;
            border-top: 1px solid rgba(255,255,255,0.06);
        }
        .tt-section-label {
            font-size: 9px;
            text-transform: uppercase;
            letter-spacing: 0.8px;
            color: rgba(255,255,255,0.3);
            margin-bottom: 3px;
            display: flex;
            align-items: center;
            gap: 4px;
        }
        .tt-section-label .material-symbols-rounded {
            font-size: 11px;
        }
        .tt-section-text {
            font-size: 10.5px;
            line-height: 1.5;
            color: rgba(255,255,255,0.65);
            font-family: var(--font-primary);
        }
        .tt-section-gm {
            background: rgba(255, 107, 53, 0.06);
            border-top: 1px solid rgba(255, 107, 53, 0.15);
        }
        .tt-section-gm .tt-section-label {
            color: rgba(255, 107, 53, 0.5);
        }
        /* GM-Hinweis nur für GMs sichtbar */
        .tt-section-gm {
            display: none;
        }
        body.gm-mode .tt-section-gm {
            display: block;
        }
        /* Wider tooltip when descriptions loaded */
        .fokus-ability-tooltip.has-desc {
            min-width: 280px;
            max-width: 340px;
        }

        /* ===== GEFAHRENPROFIL & RAST ===== */
        .main-grid > .card {
            display: flex;
            flex-direction: column;
        }

        .main-grid > .card > .card-body {
            flex: 1;
            display: flex;
            flex-direction: column;
        }

        .schwaeche-display {
            cursor: pointer;
            padding: var(--gap-sm);
            border-radius: var(--radius-md);
            transition: background 0.15s;
            flex: 1;
        }

        .schwaeche-display:hover {
            background: var(--bg-elevated);
        }

        .schwaeche-empty {
            color: var(--text-muted);
            font-size: 13px;
            text-align: center;
            padding: var(--gap-md);
            border: 1px dashed var(--border-subtle);
            border-radius: var(--radius-md);
            display: flex;
            align-items: center;
            justify-content: center;
            flex: 1;
        }

        .schwaeche-selected {
            display: flex;
            flex-direction: column;
            gap: var(--gap-xs);
        }

        .schwaeche-name {
            font-size: 15px;
            font-weight: 600;
            color: var(--text-primary);
        }

        .schwaeche-bedeutung {
            font-size: 11px;
            color: var(--text-secondary);
        }

        .schwaeche-wuerfel {
            font-size: 10px;
            color: #f59e0b;
            font-style: italic;
        }

        .schwaeche-trigger {
            font-size: 10px;
            color: var(--text-muted);
        }

        /* Schwäche card inner layout */
        .schwaeche-inner-layout {
            display: flex;
            gap: var(--gap-lg);
            flex: 1;
            align-items: stretch;
        }

        .schwaeche-inner-layout .schwaeche-display {
            flex: 1;
            min-width: 0;
        }

        .schwaeche-inner-divider {
            width: 1px;
            background: var(--border-subtle);
            align-self: stretch;
        }

        /* ===== ARMOR SHIELD DISPLAY ===== */
        .armor-shield-wrapper {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-width: 120px;
        }

        .armor-shield {
            position: relative;
            width: 110px;
            height: 130px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            background: var(--bg-elevated);
            border-radius: 12px 12px 50% 50% / 12px 12px 35% 35%;
            padding: 12px 12px 24px;
            transition: all 0.3s;
        }

        .armor-shield::before {
            content: '';
            position: absolute;
            inset: 4px;
            border-radius: 10px 10px 50% 50% / 10px 10px 33% 33%;
            border: 2px solid var(--border-subtle);
            pointer-events: none;
            transition: border-color 0.3s;
        }

        .armor-shield::after {
            content: '';
            position: absolute;
            inset: 0;
            border-radius: 12px 12px 50% 50% / 12px 12px 35% 35%;
            padding: 2px;
            background: conic-gradient(
                from var(--angle, 0deg),
                transparent 40%,
                rgba(255,255,255,0.06) 55%,
                rgba(255,255,255,0.18) 65%,
                rgba(255,255,255,0.06) 75%,
                transparent 90%
            );
            -webkit-mask: linear-gradient(#fff 0 0) content-box, linear-gradient(#fff 0 0);
            mask: linear-gradient(#fff 0 0) content-box, linear-gradient(#fff 0 0);
            -webkit-mask-composite: xor;
            mask-composite: exclude;
            opacity: 0;
            transition: opacity 0.3s ease;
            pointer-events: none;
            z-index: 0;
        }

        @property --angle {
            syntax: '<angle>';
            initial-value: 0deg;
            inherits: false;
        }

        @keyframes shield-rotate {
            from { --angle: 0deg; }
            to { --angle: 360deg; }
        }

        .armor-shield:hover::after {
            opacity: 1;
            animation: shield-rotate 4s linear infinite;
        }

        .armor-shield:hover::before {
            border-color: rgba(255,255,255,0.15);
        }

        .armor-shield-label {
            font-size: 9px;
            font-weight: 700;
            text-transform: uppercase;
            color: var(--text-muted);
            letter-spacing: 1px;
            margin-bottom: 4px;
            z-index: 1;
        }

        .armor-shield-total {
            font-size: 42px;
            font-weight: 800;
            color: var(--text-primary);
            line-height: 1;
            z-index: 1;
        }

        .armor-shield-breakdown {
            display: flex;
            align-items: center;
            gap: 4px;
            margin-top: 8px;
            padding: 3px 10px;
            background: rgba(255,255,255,0.05);
            border-radius: 20px;
            z-index: 1;
        }

        .armor-shield-sub {
            font-size: 10px;
            color: var(--text-muted);
            font-weight: 600;
        }

        .armor-shield-sub-val {
            font-size: 12px;
            color: var(--text-secondary);
            font-weight: 700;
        }

        .armor-shield-sub-sep {
            font-size: 10px;
            color: var(--text-muted);
            opacity: 0.4;
        }

        .rast-buttons {
            display: flex;
            gap: var(--gap-md);
            flex: 1;
            align-items: stretch;
        }

        .rast-btn {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: var(--gap-xs);
            padding: var(--gap-md);
            background: var(--bg-elevated);
            border: 1px solid var(--border-subtle);
            border-radius: var(--radius-md);
            cursor: pointer;
            transition: all 0.15s;
        }

        .rast-btn:hover {
            border-color: var(--accent-primary);
            background: var(--accent-primary-dim);
        }

        .rast-btn.lange:hover {
            border-color: #22c55e;
            background: rgba(34, 197, 94, 0.15);
        }

        .rast-btn.kurze:hover {
            border-color: #3b82f6;
            background: rgba(59, 130, 246, 0.15);
        }

        .rast-btn-title {
            font-size: 13px;
            font-weight: 600;
            color: var(--text-primary);
        }

        .rast-btn-info {
            font-size: 10px;
            color: var(--text-muted);
        }

        .rast-btn.lange:hover .rast-btn-info {
            color: #22c55e;
        }

        .rast-btn.kurze:hover .rast-btn-info {
            color: #3b82f6;
        }

        .rast-btn-icon {
            width: 24px;
            height: 24px;
            color: var(--text-secondary);
            transition: color 0.15s, transform 0.3s;
        }

        .rast-btn.lange:hover .rast-btn-icon {
            color: #22c55e;
        }

        .rast-btn.kurze:hover .rast-btn-icon {
            color: #3b82f6;
        }

        /* Rast Animation */
        @keyframes rastSpin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        @keyframes rastPulse {
            0% { box-shadow: 0 0 0 0 var(--rast-color); }
            50% { box-shadow: 0 0 20px 5px var(--rast-color); }
            100% { box-shadow: 0 0 0 0 var(--rast-color); }
        }

        @keyframes rastSuccess {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }

        .rast-btn.animating {
            pointer-events: none;
            animation: rastSuccess 0.8s ease-out, rastPulse 0.8s ease-out;
        }

        .rast-btn.animating.lange {
            --rast-color: rgba(34, 197, 94, 0.5);
            border-color: #22c55e;
            background: rgba(34, 197, 94, 0.15);
        }

        .rast-btn.animating.kurze {
            --rast-color: rgba(59, 130, 246, 0.5);
            border-color: #3b82f6;
            background: rgba(59, 130, 246, 0.15);
        }

        .rast-btn.animating .rast-btn-icon {
            animation: rastSpin 0.8s ease-out;
        }

        .rast-btn.animating.lange .rast-btn-icon {
            color: #22c55e;
        }

        .rast-btn.animating.kurze .rast-btn-icon {
            color: #3b82f6;
        }

        /* Fullscreen Vignette Flash */
        .rast-vignette {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            pointer-events: none;
            z-index: 9999;
            opacity: 0;
            transition: opacity 0.1s;
        }

        .rast-vignette.flash {
            animation: vignetteFlash 0.8s ease-out forwards;
        }

        .rast-vignette.lange {
            background: radial-gradient(ellipse at center, transparent 0%, transparent 40%, rgba(34, 197, 94, 0.4) 100%);
        }

        .rast-vignette.kurze {
            background: radial-gradient(ellipse at center, transparent 0%, transparent 40%, rgba(59, 130, 246, 0.4) 100%);
        }

        @keyframes vignetteFlash {
            0% { opacity: 0; }
            20% { opacity: 1; }
            100% { opacity: 0; }
        }

        /* Schwäche Popup */
        .schwaeche-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: var(--gap-sm);
        }

        .schwaeche-option {
            background: var(--bg-elevated);
            border: 1px solid var(--border-subtle);
            border-radius: var(--radius-md);
            padding: var(--gap-md);
            cursor: pointer;
            transition: all 0.15s;
        }

        .schwaeche-option:hover {
            border-color: #f59e0b;
        }

        .schwaeche-option.selected {
            border-color: #f59e0b;
            background: rgba(245, 158, 11, 0.15);
        }

        .schwaeche-option-name {
            font-size: 13px;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 4px;
        }

        .schwaeche-option-bedeutung {
            font-size: 10px;
            color: var(--text-secondary);
            margin-bottom: 4px;
        }

        .schwaeche-option-wuerfel {
            font-size: 9px;
            color: #f59e0b;
            font-style: italic;
            margin-bottom: 2px;
        }

        .schwaeche-option-trigger {
            font-size: 9px;
            color: var(--text-muted);
        }

        /* Skills */
        .skill-points-badge {
            font-size: 11px;
            font-weight: 600;
            color: var(--color-green);
            padding: 4px 12px;
            background: rgba(34, 197, 94, 0.15);
            border-radius: 20px;
            transition: all 0.2s;
        }

        .skills-tabs {
            display: flex;
            background: var(--bg-dark);
            overflow: hidden;
        }

        .skill-tab {
            flex: 1;
            padding: var(--gap-md);
            background: transparent;
            border: none;
            cursor: pointer;
            text-align: center;
            transition: all 0.15s;
            position: relative;
        }

        .skill-tab::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: transparent;
        }

        .skill-tab:hover {
            background: var(--bg-elevated);
        }

        .skill-tab.active {
            background: var(--bg-card);
        }

        /* Handeln - Rot */
        .skill-tab[data-category="handeln"].active::after {
            background: #dc2626;
        }
        .skill-tab[data-category="handeln"].active .skill-tab-name {
            color: #dc2626;
        }

        /* Wissen - Blau */
        .skill-tab[data-category="wissen"].active::after {
            background: #2563eb;
        }
        .skill-tab[data-category="wissen"].active .skill-tab-name {
            color: #2563eb;
        }

        /* Soziales - Grün */
        .skill-tab[data-category="soziales"].active::after {
            background: #16a34a;
        }
        .skill-tab[data-category="soziales"].active .skill-tab-name {
            color: #16a34a;
        }

        .skill-tab-name {
            font-size: 14px;
            font-weight: 600;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .skill-tab-attrs {
            font-size: 10px;
            color: var(--text-muted);
            margin-top: 2px;
        }

        .skill-panel {
            display: none;
        }

        .skill-panel.active {
            display: block;
        }

        .skills-list-header {
            display: grid;
            grid-template-columns: 24px 1fr 60px 50px 30px;
            gap: var(--gap-sm);
            padding: var(--gap-sm) var(--gap-md);
            font-size: 9px;
            font-weight: 600;
            text-transform: uppercase;
            color: var(--text-muted);
            background: var(--bg-elevated);
        }

        .skill-row {
            display: grid;
            grid-template-columns: 24px 1fr 60px 50px 28px 28px;
            gap: var(--gap-sm);
            padding: var(--gap-sm) var(--gap-md);
            align-items: center;
            border-bottom: 1px solid var(--border-subtle);
        }

        .skill-row:hover {
            background: var(--bg-elevated);
        }

        .skill-roll-btn {
            width: 24px;
            height: 24px;
            background: transparent;
            border: none;
            color: var(--text-muted);
            cursor: pointer;
            border-radius: var(--radius-sm);
            transition: all 0.15s;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0.4;
        }

        .skill-row:hover .skill-roll-btn {
            opacity: 1;
        }

        .skill-roll-btn:hover {
            background: var(--accent-primary-dim);
            color: var(--accent-primary);
        }

        .skill-delete-btn {
            width: 24px;
            height: 24px;
            background: transparent;
            border: none;
            color: var(--text-muted);
            font-size: 18px;
            cursor: pointer;
            border-radius: var(--radius-sm);
            transition: all 0.15s;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .skill-delete-btn:hover {
            background: var(--accent-primary-dim);
            color: var(--accent-primary);
        }

        .skill-prof {
            width: 16px;
            height: 16px;
            border: 2px solid var(--text-muted);
            border-radius: 50%;
            cursor: pointer;
            transition: all 0.15s;
            flex-shrink: 0;
        }

        .skill-prof:hover {
            border-color: var(--text-secondary);
        }

        .skill-prof.active {
            background: var(--accent-primary);
            border-color: var(--accent-primary);
        }

        /* Category-specific colors */
        #panel-handeln .skill-prof.active {
            background: #dc2626;
            border-color: #dc2626;
        }
        #panel-handeln .skill-bonus {
            color: #dc2626;
        }

        #panel-wissen .skill-prof.active {
            background: #2563eb;
            border-color: #2563eb;
        }
        #panel-wissen .skill-bonus {
            color: #2563eb;
        }

        #panel-soziales .skill-prof.active {
            background: #16a34a;
            border-color: #16a34a;
        }
        #panel-soziales .skill-bonus {
            color: #16a34a;
        }

        .skill-name-input {
            background: transparent;
            border: none;
            font-size: 12px;
            color: var(--text-primary);
            outline: none;
        }

        .skill-value-input {
            background: var(--bg-input);
            border: 1px solid var(--border-subtle);
            border-radius: var(--radius-sm);
            padding: 4px;
            font-size: 12px;
            font-weight: 600;
            color: var(--text-primary);
            text-align: center;
            outline: none;
            width: 100%;
        }

        .skill-bonus {
            font-size: 12px;
            font-weight: 600;
            color: var(--accent-primary);
            text-align: center;
        }

        .add-skill-btn {
            flex: 1;
            padding: var(--gap-sm);
            background: transparent;
            border: 1px dashed var(--border-default);
            border-radius: var(--radius-sm);
            color: var(--text-muted);
            font-size: 11px;
            cursor: pointer;
            transition: all 0.15s;
        }

        .add-skill-btn:hover {
            border-color: var(--accent-primary);
            color: var(--accent-primary);
        }

        .skill-btn-row {
            display: flex;
            gap: var(--gap-sm);
            padding: var(--gap-sm) var(--gap-md);
        }

        .catalog-skill-btn {
            padding: var(--gap-sm) var(--gap-md);
            background: var(--bg-elevated);
            border: 1px solid var(--border-subtle);
            border-radius: var(--radius-sm);
            color: var(--text-secondary);
            font-size: 11px;
            cursor: pointer;
            transition: all 0.15s;
            white-space: nowrap;
        }

        .catalog-skill-btn:hover {
            border-color: var(--accent-primary);
            color: var(--accent-primary);
        }

        .skill-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: var(--gap-sm) var(--gap-md);
            background: var(--bg-elevated);
        }

        .skill-footer-label {
            font-size: 10px;
            color: var(--text-muted);
        }

        .skill-footer-value {
            font-size: 16px;
            font-weight: 700;
            color: var(--text-primary);
        }

        .skill-footer-bonus {
            color: var(--accent-primary);
            font-size: 12px;
            font-weight: 600;
        }

        /* Bottom Section - Skills full width, side by side boxes */
        .bottom-section {
            margin-top: var(--gap-lg);
            display: grid;
            grid-template-columns: 1fr;
            gap: var(--gap-lg);
        }

        .bottom-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: var(--gap-lg) 40px;
            position: relative;
        }

        .bottom-row::after {
            content: '';
            position: absolute;
            top: 0;
            left: 50%;
            transform: translateX(-50%);
            width: 2px;
            height: 100%;
            background: rgba(120, 120, 130, 0.6);
            pointer-events: none;
        }

        .bottom-row .card {
            display: flex;
            flex-direction: column;
        }

        .bottom-row .card-body {
            flex: 1;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }

        /* Inventory & Notes */
        .side-card {
            display: flex;
            flex-direction: column;
            gap: var(--gap-md);
        }

        .inventory-textarea, .notes-textarea {
            background: var(--bg-input);
            border: 1px solid var(--border-subtle);
            border-radius: var(--radius-md);
            padding: var(--gap-md);
            font-size: 12px;
            color: var(--text-primary);
            resize: vertical;
            min-height: 160px; /* Doppelte Standardgröße */
            font-family: inherit;
            outline: none;
        }

        .inventory-textarea:focus, .notes-textarea:focus {
            border-color: var(--border-default);
        }

        /* Dice History */
        .dice-history-list {
            display: flex;
            flex-direction: column;
            gap: 6px;
            max-height: 200px;
            overflow-y: auto;
        }

        .dice-history-empty {
            color: var(--text-muted);
            font-size: 12px;
            text-align: center;
            padding: var(--gap-md);
        }

        .dice-history-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 8px 12px;
            background: var(--bg-elevated);
            border-radius: var(--radius-sm);
            border-left: 3px solid var(--border-subtle);
        }

        .dice-history-item.success {
            border-left-color: var(--color-green);
        }

        .dice-history-item.failure {
            border-left-color: var(--color-red);
        }

        .dice-history-item.critical {
            border-left-color: #fbbf24;
        }

        .dice-history-label {
            flex: 1;
            font-size: 12px;
            color: var(--text-primary);
            font-weight: 500;
        }

        .dice-history-result {
            font-family: 'Dharma Gothic', sans-serif;
            font-size: 20px;
            font-weight: 700;
            min-width: 40px;
            text-align: center;
        }

        .dice-history-result.success {
            color: var(--color-green);
        }

        .dice-history-result.failure {
            color: var(--color-red);
        }

        .dice-history-outcome {
            font-size: 10px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            font-weight: 600;
            padding: 2px 6px;
            border-radius: 3px;
        }

        .dice-history-outcome.success {
            background: rgba(34, 197, 94, 0.2);
            color: var(--color-green);
        }

        .dice-history-outcome.failure {
            background: rgba(239, 68, 68, 0.2);
            color: var(--color-red);
        }

        .dice-history-time {
            font-size: 10px;
            color: var(--text-muted);
        }

        .action-buttons {
            display: flex;
            gap: var(--gap-sm);
            margin-top: var(--gap-md);
        }

        .action-btn {
            flex: 1;
            padding: var(--gap-sm);
            background: var(--bg-elevated);
            border: 1px solid var(--border-subtle);
            border-radius: var(--radius-sm);
            color: var(--text-muted);
            font-size: 10px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.15s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 4px;
        }

        .action-btn:hover {
            background: var(--bg-card-hover);
            color: var(--text-secondary);
        }

        .action-btn.danger:hover {
            background: var(--accent-primary-dim);
            border-color: var(--accent-primary);
            color: var(--accent-primary);
        }

        .action-btn.primary {
            background: var(--gold-dim);
            border-color: var(--gold);
            color: var(--gold);
        }

        .action-btn.primary:hover {
            background: var(--gold);
            color: var(--bg-primary);
        }

        .action-btn.primary.active {
            background: var(--gold);
            color: var(--bg-primary);
            cursor: default;
        }

        .action-btn svg {
            width: 12px;
            height: 12px;
        }

        /* Skills */
        .popup-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.85);
            backdrop-filter: blur(8px);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: all 0.25s ease;
        }

        .popup-overlay.active {
            opacity: 1;
            visibility: visible;
        }

        .popup {
            background: var(--bg-card);
            border-radius: var(--radius-lg);
            border: 1px solid var(--accent-primary);
            width: 90%;
            max-width: 650px;
            max-height: 85vh;
            display: flex;
            flex-direction: column;
            transform: scale(0.95);
            transition: transform 0.25s ease;
        }

        .popup.popup-wide {
            max-width: 800px;
        }

        .popup-overlay.active .popup {
            transform: scale(1);
        }

        .catalog-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: var(--gap-xs);
        }

        .catalog-item {
            background: var(--bg-elevated);
            border: 1px solid var(--border-subtle);
            border-radius: var(--radius-sm);
            padding: var(--gap-sm);
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: var(--gap-xs);
        }

        .catalog-item.added {
            border-color: var(--color-green);
            background: rgba(34, 197, 94, 0.1);
        }

        .catalog-item-name {
            font-size: 11px;
            font-weight: 500;
            color: var(--text-primary);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .catalog-item-btn {
            padding: 3px 6px;
            border-radius: var(--radius-sm);
            border: none;
            font-size: 9px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.15s;
            flex-shrink: 0;
        }

        .catalog-item-btn.add {
            background: var(--color-green);
            color: white;
        }

        .catalog-item-btn.add:hover {
            background: #16a34a;
        }

        .catalog-item-btn.remove {
            background: var(--accent-primary);
            color: white;
        }

        .catalog-item-btn.remove:hover {
            background: #b91c1c;
        }

        @media (max-width: 700px) {
            .catalog-grid {
                grid-template-columns: repeat(3, 1fr);
            }
        }

        @media (max-width: 500px) {
            .catalog-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        .popup-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: var(--gap-lg);
            border-bottom: 1px solid var(--border-subtle);
        }

        .popup-title {
            font-size: 16px;
            font-weight: 600;
            color: var(--text-primary);
        }

        .popup-close {
            width: 32px;
            height: 32px;
            border: none;
            background: var(--bg-elevated);
            border-radius: var(--radius-sm);
            color: var(--text-secondary);
            font-size: 18px;
            cursor: pointer;
        }

        .popup-close:hover {
            background: var(--accent-primary);
            color: white;
        }

        .popup-body {
            flex: 1;
            overflow-y: auto;
            padding: var(--gap-lg);
        }

        .popup-footer {
            padding: var(--gap-lg);
            border-top: 1px solid var(--border-subtle);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        /* ===== FOKUS POPUP — MULTI-STEP SELECTION ===== */
        .fokus-type-grid { display: none; } /* legacy — removed */

        /* Fokus popup — cleaner border */
        #fokus-popup .popup {
            border: 1px solid rgba(255,255,255,0.08);
            max-width: 1300px;
            max-height: 800px;
        }
        #fokus-popup .popup-body {
            padding: 12px 16px;
        }

        .fokus-step { display: none; animation: fokusStepIn 0.3s ease; }
        .fokus-step.active { display: block; }
        @keyframes fokusStepIn {
            from { opacity: 0; transform: translateY(12px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Step 1 — Category Cards */
        .fokus-categories {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 14px;
            padding: 8px 0;
        }
        .fokus-cat-card {
            position: relative;
            border-radius: 14px;
            overflow: hidden;
            cursor: pointer;
            border: 2px solid rgba(255,255,255,0.06);
            transition: all 0.25s ease;
            background: var(--bg-elevated);
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 28px 16px 22px;
            gap: 12px;
            min-height: 200px;
        }
        .fokus-cat-card::before {
            content: '';
            position: absolute;
            inset: 0;
            opacity: 0;
            transition: opacity 0.3s;
            z-index: 0;
        }
        .fokus-cat-card:hover::before { opacity: 1; }
        .fokus-cat-card:hover {
            border-color: rgba(255,255,255,0.15);
            transform: translateY(-3px);
            box-shadow: 0 12px 40px rgba(0,0,0,0.5);
        }
        .fokus-cat-card[data-cat="element"]::before {
            background: radial-gradient(ellipse at 50% 80%, rgba(255,107,53,0.15) 0%, transparent 70%);
        }
        .fokus-cat-card[data-cat="weapon"]::before {
            background: radial-gradient(ellipse at 50% 80%, rgba(200,200,210,0.12) 0%, transparent 70%);
        }
        .fokus-cat-card[data-cat="support"]::before {
            background: radial-gradient(ellipse at 50% 80%, rgba(139,92,246,0.15) 0%, transparent 70%);
        }
        .fokus-cat-icon {
            position: relative; z-index: 1;
            width: 64px; height: 64px;
            display: flex; align-items: center; justify-content: center;
            border-radius: 50%;
            background: rgba(255,255,255,0.04);
            border: 1px solid rgba(255,255,255,0.08);
        }
        .fokus-cat-icon .material-symbols-rounded {
            font-size: 32px;
            color: var(--text-secondary);
            transition: color 0.25s;
        }
        .fokus-cat-card[data-cat="element"]:hover .fokus-cat-icon .material-symbols-rounded { color: #ff6b35; }
        .fokus-cat-card[data-cat="weapon"]:hover .fokus-cat-icon .material-symbols-rounded { color: #c8c8d6; }
        .fokus-cat-card[data-cat="support"]:hover .fokus-cat-icon .material-symbols-rounded { color: #8b5cf6; }
        .fokus-cat-card:hover .fokus-cat-icon {
            border-color: rgba(255,255,255,0.15);
            background: rgba(255,255,255,0.06);
        }
        .fokus-cat-name {
            position: relative; z-index: 1;
            font-size: 15px; font-weight: 700;
            color: var(--text-primary);
            letter-spacing: 0.5px;
        }
        .fokus-cat-desc {
            position: relative; z-index: 1;
            font-size: 11px;
            color: var(--text-secondary);
            text-align: center;
            line-height: 1.4;
            opacity: 0.7;
        }
        .fokus-cat-count {
            position: relative; z-index: 1;
            font-size: 10px;
            color: var(--text-secondary);
            opacity: 0.5;
            margin-top: auto;
        }
        .fokus-cat-card.locked {
            opacity: 0.35;
            cursor: not-allowed;
            pointer-events: none;
        }

        /* Step 1 — Ohne Fokus Option */
        .fokus-no-focus-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            margin-top: 14px;
            padding: 10px 16px;
            border-radius: 8px;
            border: 1px solid rgba(255,255,255,0.06);
            background: transparent;
            color: var(--text-secondary);
            font-size: 12px;
            cursor: pointer;
            transition: all 0.2s;
            width: 100%;
        }
        .fokus-no-focus-btn:hover {
            background: rgba(255,255,255,0.04);
            border-color: rgba(255,255,255,0.12);
            color: var(--text-primary);
        }
        .fokus-no-focus-btn .material-symbols-rounded { font-size: 16px; }

        /* Step 2 — Back Button */
        .fokus-back-btn {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            background: none;
            border: none;
            color: var(--text-secondary);
            font-size: 12px;
            cursor: pointer;
            padding: 4px 8px 4px 2px;
            border-radius: 6px;
            transition: all 0.15s;
            margin-bottom: 8px;
        }
        .fokus-back-btn:hover { background: rgba(255,255,255,0.06); color: var(--text-primary); }
        .fokus-back-btn .material-symbols-rounded { font-size: 18px; }

        /* Step 2 — Style Tabs */
        .fokus-style-tabs {
            display: flex;
            gap: 6px;
            overflow-x: auto;
            padding-bottom: 8px;
            margin-bottom: 10px;
            scrollbar-width: none;
            -ms-overflow-style: none;
        }
        .fokus-style-tabs::-webkit-scrollbar { display: none; }
        .fokus-style-tab {
            flex-shrink: 0;
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 14px;
            border-radius: 8px;
            border: 1px solid rgba(255,255,255,0.06);
            background: var(--bg-elevated);
            cursor: pointer;
            transition: all 0.2s;
            white-space: nowrap;
        }
        .fokus-style-tab:hover {
            border-color: rgba(255,255,255,0.15);
            background: rgba(255,255,255,0.04);
        }
        .fokus-style-tab.active {
            /* border/bg set via JS with element color */
        }
        .fokus-style-tab img {
            width: 22px;
            height: 22px;
        }
        .fokus-style-tab-name {
            font-size: 12px;
            font-weight: 600;
            color: var(--text-secondary);
        }
        .fokus-style-tab.active .fokus-style-tab-name {
            color: var(--text-primary);
        }

        /* Style Info Bar */
        .fokus-style-info {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 8px 14px;
            border-radius: 10px;
            background: var(--bg-elevated);
            margin-bottom: 10px;
            border: 1px solid rgba(255,255,255,0.04);
        }
        .fokus-style-info-icon {
            width: 40px; height: 40px;
            display: flex; align-items: center; justify-content: center;
            border-radius: 10px;
            flex-shrink: 0;
        }
        .fokus-style-info-icon img { width: 28px; height: 28px; }
        .fokus-style-info-text { flex: 1; }
        .fokus-style-info-name {
            font-size: 14px; font-weight: 700;
        }
        .fokus-style-info-attr {
            font-size: 11px; color: var(--text-secondary);
        }
        .fokus-style-info-formula {
            font-size: 10px; color: var(--text-secondary); opacity: 0.6;
            font-family: var(--font-mono);
        }

        /* Ability Section Headers */
        .fokus-section-title {
            font-size: 13px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 1.5px;
            margin: 10px 0 6px;
            padding-left: 2px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .fokus-section-title::after {
            content: '';
            flex: 1;
            height: 1px;
            background: rgba(255,255,255,0.06);
        }
        .fokus-attr-info + .fokus-section-title { margin-top: 0; }
        .fokus-attr-info {
            font-size: 11px;
            color: var(--text-secondary);
            text-align: center;
            padding: 8px 12px;
            background: var(--bg-elevated);
            border-radius: 8px;
            margin-bottom: 14px;
            border: 1px solid rgba(255,255,255,0.04);
            font-family: var(--font-mono);
        }

        /* Ability Grid */
        .fokus-ability-grid {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            grid-auto-rows: 1fr;
            gap: 8px;
            margin-bottom: 8px;
        }
        .fokus-ability-option {
            position: relative;
            background: var(--bg-elevated);
            border: 1px solid rgba(255,255,255,0.06);
            border-radius: 10px;
            padding: 8px 10px;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            flex-direction: column;
        }
        .fokus-ability-option:hover:not(.disabled) {
            border-color: rgba(255,255,255,0.15);
            background: rgba(255,255,255,0.03);
        }
        .fokus-ability-option.selected {
            /* border/bg via inline style */
            box-shadow: 0 0 20px rgba(var(--sel-rgb, 255,255,255), 0.08);
        }
        .fokus-ability-option.disabled {
            opacity: 0.3;
            cursor: not-allowed;
        }
        .fokus-ability-option-name {
            font-size: 12px;
            font-weight: 700;
            margin-bottom: 4px;
            padding-right: 28px;
        }
        .fokus-ability-option-picto {
            position: absolute;
            top: 8px;
            right: 8px;
            width: 24px;
            height: 24px;
            border-radius: 4px;
            opacity: 0.6;
        }
        .fokus-ability-option.selected .fokus-ability-option-picto { opacity: 1; }
        .fokus-ability-option-desc {
            font-size: 10px;
            color: var(--text-secondary);
            line-height: 1.45;
            opacity: 0.75;
            flex: 1;
        }

        .popup-btn {
            padding: 10px 20px;
            border: none;
            border-radius: var(--radius-md);
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
        }

        .popup-btn-primary {
            background: var(--accent-primary);
            color: white;
        }

        .popup-btn-primary:hover:not(:disabled) {
            background: var(--accent-primary-light);
        }

        .popup-btn-primary:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .popup-info {
            font-size: 12px;
            color: var(--text-muted);
        }

        /* Save Indicator */
        .save-indicator {
            position: fixed;
            bottom: 90px; /* Über dem Dock */
            right: 24px;
            background: var(--bg-elevated);
            color: var(--text-primary);
            padding: 8px 14px;
            border-radius: var(--radius-md);
            font-size: 12px;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 6px;
            opacity: 0;
            transform: translateY(8px) scale(0.95);
            transition: all 0.25s ease;
            pointer-events: none;
            z-index: 9999;
            border: 1px solid var(--border-subtle);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        }

        .save-indicator.show {
            opacity: 1;
            transform: translateY(0) scale(1);
        }

        .save-indicator svg {
            width: 14px;
            height: 14px;
            color: var(--accent-primary);
        }

        .hidden-input {
            display: none;
        }

        /* ===== RESPONSIVE ===== */
        @media (max-width: 1100px) {
            .main-grid {
                grid-template-columns: 1fr;
            }
            
            .bottom-row {
                grid-template-columns: 1fr;
            }
            
            /* Hide vertical dividers on single column */
            .grid-section::before,
            .grid-section::after,
            .bottom-row::after {
                display: none;
            }
        }

        @media (max-width: 900px) {
            body {
                padding-top: 56px;
            }
            
            .character-layout {
                grid-template-columns: 1fr;
            }
            
            .character-visual {
                flex-direction: row;
                justify-content: center;
            }
            
            .text-areas-row {
                grid-template-columns: 1fr;
            }
        }

        @media (max-width: 650px) {
            .schwaeche-inner-layout {
                flex-direction: column;
                align-items: center;
            }
            
            .schwaeche-inner-divider {
                width: 100%;
                height: 1px;
            }
            
            .attributes-layout {
                flex-direction: column;
                align-items: center;
                gap: var(--gap-md);
            }
            
            .attributes-divider {
                width: 80%;
                height: 1px;
                margin: 0;
            }
            
            .initiative-box {
                height: auto;
                width: 80px;
                min-width: 80px;
                max-width: 80px;
                padding: var(--gap-md) var(--gap-lg);
            }
            
            .initiative-box-wrapper {
                transform: none;
            }
            
            .initiative-value,
            .initiative-value input {
                font-size: 36px;
            }
            
            .attributes-top-row,
            .attributes-bottom-row {
                gap: var(--gap-sm);
            }
            
            .attribute-item {
                padding: 0;
            }
            
            .attribute-box {
                width: 70px;
                min-width: 70px;
                max-width: 70px;
                padding: var(--gap-md) var(--gap-md);
            }
            
            .attribute-modifier {
                font-size: 20px;
            }
            
            .fokus-abilities {
                grid-template-columns: 1fr;
            }
            
            .character-fields {
                grid-template-columns: 1fr;
            }
            
            .dice-row-large {
                gap: var(--gap-sm);
            }
            
            .dice-check-large {
                width: 56px;
                height: 56px;
            }
            
            .dice-check-large svg {
                width: 36px;
                height: 36px;
            }
        }

        /* ===== GM PLAYER SWITCHER BAR ===== */
        .gm-player-bar {
            display: none;
            align-items: center;
            gap: var(--gap-md);
            padding: 10px var(--gap-lg);
            background: var(--bg-elevated);
            border-radius: var(--radius-lg);
            margin-bottom: var(--gap-md);
        }

        .gm-player-bar.visible {
            display: flex;
        }

        .gm-player-bar-label {
            font-size: 13px;
            color: var(--text-secondary);
            font-weight: 500;
            white-space: nowrap;
        }

        .gm-player-list {
            display: flex;
            gap: var(--gap-sm);
            flex-wrap: wrap;
        }

        .gm-player-btn {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 6px 12px;
            background: var(--bg-card);
            border: 1px solid var(--border-subtle);
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.15s ease;
            font-size: 13px;
            color: var(--text-primary);
            font-weight: 500;
        }

        .gm-player-btn:hover {
            background: var(--bg-card-hover);
            border-color: var(--border-default);
        }

        .gm-player-btn.active {
            background: var(--accent-primary-dim);
            border-color: var(--accent-primary);
            color: var(--accent-primary);
        }

        .gm-player-btn .player-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            flex-shrink: 0;
        }

        .gm-player-btn .own-char-badge {
            font-size: 10px;
            opacity: 0.7;
            margin-left: 2px;
        }

        .gm-viewing-badge {
            display: none;
            align-items: center;
            gap: 6px;
            margin-left: auto;
            padding: 6px 12px;
            background: rgba(251, 191, 36, 0.15);
            border: 1px solid rgba(251, 191, 36, 0.3);
            border-radius: 20px;
            font-size: 12px;
            color: #fbbf24;
            font-weight: 500;
        }

        .gm-viewing-badge.visible {
            display: flex;
        }

        .gm-viewing-badge svg {
            width: 14px;
            height: 14px;
            fill: currentColor;
        }

        /* ===== ADVENTURE BAR ===== */
        .adventure-bar {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: var(--gap-lg);
            padding: 12px var(--gap-lg);
            background: var(--bg-elevated);
            border-radius: var(--radius-lg);
            margin-top: 32px; /* Abstand nach MegaNav */
            margin-bottom: var(--gap-lg);
            position: relative;
        }

        .adventure-bar-label {
            font-size: 13px;
            color: var(--text-secondary);
            font-weight: 500;
            white-space: nowrap;
            margin-right: auto;
            padding-left: var(--gap-sm);
        }

        .adventure-bar-icon {
            position: absolute;
            left: 50%;
            top: 50%;
            transform: translate(-50%, -50%);
            width: 36px;
            height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
            text-decoration: none;
            transition: all 0.2s ease;
            border-radius: var(--radius-sm);
            padding: 6px;
        }

        .adventure-bar-icon:hover {
            background: var(--bg-card-hover);
        }

        .adventure-bar-icon img {
            width: 100%;
            height: 100%;
            object-fit: contain;
            filter: brightness(0) invert(1);
            transition: filter 0.2s ease;
        }

        .adventure-bar-icon:hover img {
            filter: invert(48%) sepia(79%) saturate(1000%) hue-rotate(332deg) brightness(90%) contrast(95%);
        }

        .adventure-name-input {
            background: transparent;
            border: none;
            border-bottom: 1px solid transparent;
            color: var(--text-primary);
            font-size: 15px;
            font-weight: 600;
            padding: 4px 8px;
            min-width: 180px;
            max-width: 300px;
            text-align: left;
            margin-left: auto;
            padding-right: var(--gap-sm);
            transition: border-color 0.15s ease;
        }

        .adventure-name-input:hover {
            border-bottom-color: var(--border-default);
        }

        .adventure-name-input:focus {
            outline: none;
            border-bottom-color: var(--border-default);
        }

        .adventure-name-input::placeholder {
            color: var(--text-muted);
            font-weight: 400;
        }

        /* Read-only mode indicator */
        .sheet-readonly-overlay {
            display: none;
            position: fixed;
            top: 70px;
            left: 50%;
            transform: translateX(-50%);
            padding: 8px 16px;
            background: rgba(251, 191, 36, 0.9);
            color: #000;
            font-size: 13px;
            font-weight: 600;
            border-radius: 20px;
            z-index: 1000;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        }

        .sheet-readonly-overlay.visible {
            display: block;
        }

        @media (max-width: 768px) {
            .fokus-categories {
                grid-template-columns: 1fr;
                gap: 10px;
            }
            .fokus-cat-card {
                flex-direction: row;
                min-height: unset;
                padding: 16px 20px;
                gap: 14px;
            }
            .fokus-cat-icon { width: 48px; height: 48px; }
            .fokus-cat-icon .material-symbols-rounded { font-size: 24px; }
            .fokus-cat-desc { text-align: left; }
            .fokus-cat-count { margin-top: 0; margin-left: auto; }
            .fokus-ability-grid { grid-template-columns: repeat(2, 1fr); grid-auto-rows: 1fr; }
            #fokus-popup .popup { max-width: 95%; }

            .gm-player-bar {
                flex-direction: column;
                align-items: flex-start;
            }

            .gm-viewing-badge {
                margin-left: 0;
                margin-top: var(--gap-sm);
            }

            .adventure-bar {
                flex-wrap: wrap;
            }

            .adventure-name-input {
                min-width: 120px;
            }
        }

        /* ═══════════════════════════════════════════════════════════════
           ANIMATIONS & MICRO-INTERACTIONS
           ═══════════════════════════════════════════════════════════════ */

        /* === KEYFRAMES === */
        @keyframes fadeSlideIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes pulseGlow {
            0%, 100% {
                box-shadow: 0 0 5px currentColor;
            }
            50% {
                box-shadow: 0 0 20px currentColor, 0 0 30px currentColor;
            }
        }

        @keyframes criticalPulse {
            0%, 100% {
                opacity: 1;
            }
            50% {
                opacity: 0.6;
            }
        }

        @keyframes diceWobble {
            0%, 100% {
                transform: rotate(0deg) scale(1);
            }
            25% {
                transform: rotate(-8deg) scale(1.1);
            }
            75% {
                transform: rotate(8deg) scale(1.1);
            }
        }

        @keyframes diceClick {
            0% {
                transform: scale(1);
            }
            50% {
                transform: scale(0.85);
            }
            100% {
                transform: scale(1);
            }
        }

        @keyframes checkToggle {
            0% {
                transform: scale(1);
            }
            30% {
                transform: scale(0.8);
            }
            60% {
                transform: scale(1.15);
            }
            100% {
                transform: scale(1);
            }
        }

        @keyframes levelPulse {
            0%, 100% {
                box-shadow: 0 0 0 0 var(--accent-primary-glow);
            }
            50% {
                box-shadow: 0 0 0 8px transparent;
            }
        }

        @keyframes saveFlash {
            0% {
                opacity: 0;
                transform: translateY(10px);
            }
            20% {
                opacity: 1;
                transform: translateY(0);
            }
            80% {
                opacity: 1;
                transform: translateY(0);
            }
            100% {
                opacity: 0;
                transform: translateY(-10px);
            }
        }

        @keyframes valueFlash {
            0%, 100% {
                background: transparent;
            }
            50% {
                background: var(--accent-primary-dim);
            }
        }

        @keyframes barShimmer {
            0% {
                background-position: -200% center;
            }
            100% {
                background-position: 200% center;
            }
        }

        @keyframes slideInLeft {
            from {
                opacity: 0;
                transform: translateX(-10px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        /* === STAGGERED CARD ENTRANCE === */
        .card {
            opacity: 0;
            animation: fadeSlideIn 0.5s ease forwards;
        }

        .main-grid .card:nth-child(1) { animation-delay: 0.05s; }
        .main-grid .card:nth-child(2) { animation-delay: 0.1s; }
        .main-grid .card:nth-child(3) { animation-delay: 0.15s; }
        .main-grid .card:nth-child(4) { animation-delay: 0.2s; }
        .main-grid .card:nth-child(5) { animation-delay: 0.25s; }
        .main-grid .card:nth-child(6) { animation-delay: 0.3s; }

        .bottom-row .card:nth-child(1) { animation-delay: 0.25s; }
        .bottom-row .card:nth-child(2) { animation-delay: 0.3s; }
        .bottom-row .card:nth-child(3) { animation-delay: 0.35s; }

        /* === CARD HOVER STATES === */
        .card {
            transition: transform 0.25s ease, box-shadow 0.25s ease, border-color 0.25s ease;
        }

        .card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 30px rgba(0, 0, 0, 0.3);
            border-color: var(--border-default);
        }

        /* === WÜRFEL-BUTTONS === */
        .dice-btn,
        .roll-btn,
        [class*="dice"],
        button[onclick*="roll"],
        .skill-roll-btn {
            transition: all 0.2s ease;
            position: relative;
        }

        .dice-btn:hover,
        .roll-btn:hover,
        .skill-roll-btn:hover {
            animation: diceWobble 0.5s ease;
        }

        .dice-btn:active,
        .roll-btn:active,
        .skill-roll-btn:active {
            animation: diceClick 0.15s ease;
        }

        /* === STATUS BARS === */
        .stat-bar,
        .status-bar,
        .progress-bar,
        [class*="health"],
        [class*="moral"],
        [class*="resonanz"] {
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .stat-bar-fill,
        .status-fill,
        .bar-fill {
            transition: width 0.5s cubic-bezier(0.4, 0, 0.2, 1), background 0.3s ease;
            background-size: 200% 100%;
            position: relative;
        }

        /* Critical State - Pulsing */
        .stat-bar-fill.critical,
        .status-bar.critical .bar-fill {
            animation: criticalPulse 1s ease-in-out infinite;
        }

        .stat-bar.critical,
        .status-bar.critical {
            box-shadow: 0 0 10px rgba(239, 68, 68, 0.5);
        }

        /* === SKILL ROWS === */
        .skill-row,
        .skill-item,
        [class*="skill-entry"] {
            position: relative;
            transition: all 0.2s ease;
        }

        .skill-row::before,
        .skill-item::before {
            content: '';
            position: absolute;
            left: 0;
            top: 0;
            height: 100%;
            width: 3px;
            background: var(--accent-primary);
            transform: scaleY(0);
            transition: transform 0.2s ease;
            border-radius: 0 2px 2px 0;
        }

        .skill-row:hover,
        .skill-item:hover {
            background: rgba(255, 70, 85, 0.05);
            padding-left: calc(var(--gap-md) + 5px);
        }

        .skill-row:hover::before,
        .skill-item:hover::before {
            transform: scaleY(1);
        }

        .skill-row .roll-btn,
        .skill-row .dice-btn,
        .skill-roll-btn {
            opacity: 0.5;
            transform: scale(0.9);
            transition: all 0.2s ease;
        }

        .skill-row:hover .roll-btn,
        .skill-row:hover .dice-btn,
        .skill-row:hover .skill-roll-btn {
            opacity: 1;
            transform: scale(1);
        }

        /* === ATTRIBUTE INPUTS === */
        .attr-input,
        .attribute-value,
        [class*="attr"] input[type="number"] {
            transition: all 0.2s ease;
            position: relative;
        }

        .attr-input:focus,
        .attribute-value:focus,
        [class*="attr"] input[type="number"]:focus {
            outline: none;
            border-color: var(--border-default);
        }

        .attr-input.value-changed,
        .attribute-value.value-changed {
            animation: valueFlash 0.4s ease;
        }

        /* === PORTRAIT === */
        .portrait,
        #portrait-box {
            position: relative;
            overflow: visible; /* Level-Badge muss rausragen können */
            transition: all 0.3s ease;
        }

        .portrait-container {
            overflow: visible !important;
        }

        .portrait img,
        #portrait-img {
            transition: transform 0.4s ease;
            border-radius: var(--radius-md); /* Bild selbst abrunden da overflow:visible */
        }

        .portrait:hover img,
        #portrait-box:hover #portrait-img {
            transform: scale(1.08);
        }

        /* Portrait Health Vignette */

        /* === ZWEITE CHANCE CHECKBOXES === */
        .chance-checkbox,
        .zweite-chance-btn,
        [class*="chance"] input[type="checkbox"] + label,
        [class*="chance"] .checkbox {
            transition: all 0.2s ease;
            cursor: pointer;
        }

        .chance-checkbox:hover,
        .zweite-chance-btn:hover {
            transform: scale(1.1);
        }

        .chance-checkbox.checked,
        .zweite-chance-btn.used {
            animation: checkToggle 0.3s ease;
        }

        .chance-checkbox.toggle-animation {
            animation: checkToggle 0.3s ease;
        }

        /* === SAVE INDICATOR === */
        /* === GENERAL INPUT FOCUS === */
        input, textarea, select {
            transition: border-color 0.2s ease, box-shadow 0.2s ease, background 0.2s ease;
        }

        input:focus, textarea:focus, select:focus {
            border-color: var(--border-default) !important;
            outline: none;
        }

        /* === BUTTON HOVER POLISH === */
        button, .btn {
            transition: all 0.2s ease;
        }

        button:hover:not(:disabled), .btn:hover:not(:disabled) {
            transform: translateY(-1px);
        }

        button:active:not(:disabled), .btn:active:not(:disabled) {
            transform: translateY(0) scale(0.98);
        }

        /* === REDUCED MOTION === */
        @media (prefers-reduced-motion: reduce) {
            *, *::before, *::after {
                animation-duration: 0.01ms !important;
                animation-iteration-count: 1 !important;
                transition-duration: 0.01ms !important;
            }
        }

        /* ===== PRINT STYLESHEET (A4) ===== */
        @media print {
            @page {
                size: A4;
                margin: 10mm;
            }

            /* Reset dark theme to print-friendly */
            *, *::before, *::after {
                background: transparent !important;
                color: #000 !important;
                box-shadow: none !important;
                text-shadow: none !important;
                animation: none !important;
                transition: none !important;
            }

            body {
                background: #fff !important;
                font-size: 10pt !important;
                line-height: 1.3 !important;
            }

            /* Hide non-essential elements */
            .navigation,
            .nav-bar,
            footer,
            .footer,
            .save-indicator,
            .toast-container,
            .popup,
            .modal,
            .btn,
            .icon-btn,
            .dice-btn,
            .img-control-btn,
            .portrait-controls-row,
            .add-skill-btn,
            .skill-delete,
            .hidden-input,
            #portrait-upload,
            #jolly-upload,
            #import-file,
            .status-bar.draggable::after {
                display: none !important;
            }

            /* Main container */
            .main-content {
                padding: 0 !important;
                max-width: 100% !important;
            }

            .sheet-container {
                padding: 0 !important;
                gap: 8pt !important;
            }

            /* Character header */
            .character-header {
                border: 1px solid #ccc !important;
                padding: 8pt !important;
                page-break-inside: avoid;
            }

            .portrait-container {
                width: 80px !important;
                height: 100px !important;
            }

            .portrait-frame {
                border: 1px solid #000 !important;
            }

            .character-name {
                font-size: 16pt !important;
                border-bottom: 1px solid #000 !important;
            }

            /* Attributes */
            .attributes-section {
                page-break-inside: avoid;
            }

            .attribute-box {
                border: 1px solid #000 !important;
                padding: 4pt !important;
                min-width: 60px !important;
                width: 60px !important;
                max-width: 60px !important;
            }

            .attribute-box::before {
                display: none !important;
            }

            .initiative-box {
                border: 1px solid #000 !important;
                padding: 4pt !important;
                min-width: 60px !important;
                width: 60px !important;
                max-width: 60px !important;
            }

            .initiative-box::before {
                display: none !important;
            }

            .initiative-value,
            .initiative-value input {
                font-size: 14pt !important;
                color: #000 !important;
            }

            .attributes-divider {
                background: #ccc !important;
            }

            .attribute-modifier {
                font-size: 14pt !important;
            }

            .attribute-name {
                font-size: 8pt !important;
            }

            .attribute-abbr {
                font-size: 7pt !important;
                color: #666 !important;
            }

            /* Status bars */
            .status-bars {
                page-break-inside: avoid;
            }

            .status-bar {
                border: 1px solid #000 !important;
                height: 12px !important;
            }

            .status-bar-fill {
                background: #333 !important;
                print-color-adjust: exact;
                -webkit-print-color-adjust: exact;
            }

            .status-bar-fill.health {
                background: #22c55e !important;
            }

            .status-bar-fill.moral {
                background: #3b82f6 !important;
            }

            .status-bar-fill.resonanz {
                background: #8b5cf6 !important;
            }

            /* Skills */
            .skills-grid {
                gap: 8pt !important;
            }

            .skill-category {
                border: 1px solid #ccc !important;
                padding: 6pt !important;
                page-break-inside: avoid;
            }

            .skill-row {
                border-bottom: 1px dotted #ccc !important;
                padding: 2pt 0 !important;
            }

            .skill-name-input,
            .skill-value-input {
                border: none !important;
                background: transparent !important;
                font-size: 9pt !important;
            }

            /* Fokus section */
            .fokus-card {
                border: 1px solid #000 !important;
                padding: 8pt !important;
                page-break-inside: avoid;
            }

            .fokus-element-icon {
                filter: none !important;
                width: 40px !important;
                height: 40px !important;
            }

            .fokus-abilities {
                border: 1px solid #ccc !important;
            }

            /* Inventory & Notes */
            .inventory-section,
            .notes-section {
                page-break-inside: avoid;
            }

            textarea {
                border: 1px solid #ccc !important;
                min-height: 60px !important;
            }

            /* Section headers */
            .section-header,
            .category-header {
                border-bottom: 1px solid #000 !important;
                font-size: 11pt !important;
                font-weight: bold !important;
            }

            /* Page breaks */
            .fokus-card {
                page-break-before: auto;
            }

            .notes-section {
                page-break-before: auto;
            }

            /* Print header */
            .sheet-container::before {
                content: "Worlds Apart - Charakterbogen";
                display: block;
                text-align: center;
                font-size: 8pt;
                color: #999 !important;
                margin-bottom: 8pt;
                border-bottom: 1px solid #ccc;
                padding-bottom: 4pt;
            }
        }
    </style>
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    
    <!-- RIFT Services -->
    <script src="../../assets/js/firebase-config.js"></script>
    <script>
        // Auth Guard - redirect to login if not authenticated
        (function() {
            function waitForAuth() {
                // Wait for Firebase SDK
                if (typeof firebase === 'undefined' || !firebase.auth) {
                    return setTimeout(waitForAuth, 50);
                }
                // Wait for Firebase app initialization
                try {
                    var auth = firebase.auth();
                    auth.onAuthStateChanged(function(user) {
                        if (!user) {
                            window.location.href = '/login';
                        } else {
                            document.body.classList.add('auth-ready');
                        }
                    });
                } catch(e) {
                    // Firebase not initialized yet, retry
                    setTimeout(waitForAuth, 50);
                }
            }
            waitForAuth();
        })();
    </script>

    <script src="../../assets/js/room-service.js"></script>
    <script src="../../assets/js/user-service.js"></script>
    <script src="../../assets/js/pro-status.js"></script>
    
    <script src="../../assets/js/auth.js"></script>

    <!-- Auth Guard: Hide until authenticated -->
    <style>
        body:not(.auth-ready) .app { opacity: 0; pointer-events: none; }
        body:not(.auth-ready) .sheet-container { opacity: 0; pointer-events: none; }
        body:not(.auth-ready) main { opacity: 0; pointer-events: none; }
        body.auth-ready .app { opacity: 1; transition: opacity 0.15s ease; }
        body.auth-ready .sheet-container { opacity: 1; transition: opacity 0.15s ease; }
        body.auth-ready main { opacity: 1; transition: opacity 0.15s ease; }
    </style>
</head>
<body>
    <!-- Unified Layout Placeholders -->
    <div id="topnav-placeholder"></div>
    <div id="meganav-placeholder"></div>
    
    <div class="app">
        <main class="main main--hub">
            <div class="main__content">
                
                <!-- Page Header with Back Button -->
                <div class="page-header">
                    <div class="page-header__icon">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                            <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-1 17.93c-3.95-.49-7-3.85-7-7.93 0-.62.08-1.21.21-1.79L9 15v1c0 1.1.9 2 2 2v1.93zm6.9-2.54c-.26-.81-1-1.39-1.9-1.39h-1v-3c0-.55-.45-1-1-1H8v-2h2c.55 0 1-.45 1-1V7h2c1.1 0 2-.9 2-2v-.41c2.93 1.19 5 4.06 5 7.41 0 2.08-.8 3.97-2.1 5.39z"/>
                        </svg>
                    </div>
                    <div class="page-header__divider"></div>
                    <h1 class="page-header__title">Charakterbogen</h1>
                    <span class="page-header__tagline">Worlds Apart</span>
                    
                    <a href="/sheet" id="backToCharSelect" class="wa-back-btn">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M19 12H5M12 19l-7-7 7-7"/>
                        </svg>
                        Charakterauswahl
                    </a>
                    <a href="/session" id="backToSession" class="wa-back-btn">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M19 12H5M12 19l-7-7 7-7"/>
                        </svg>
                        Session
                    </a>
                </div>

    <!-- Background Image -->
    <div class="bg-container" id="bgContainer"></div>

    <!-- Read-only Mode Overlay -->
    <div class="sheet-readonly-overlay" id="readonlyOverlay">👁 Nur-Lesen-Modus</div>

    <div class="sheet-container">
        <!-- Adventure Bar -->
        <div class="adventure-bar" id="adventureBar">
            <span class="adventure-bar-label">Aktuelles Abenteuer:</span>
            <a href="/worldsapart" class="adventure-bar-icon" id="adventureIcon" title="Worlds Apart Regelwerk">
                <img src="../../assets/img/rulesets/ruleset_worldsapart.svg" alt="Worlds Apart">
            </a>
            <input type="text" class="adventure-name-input" id="adventureName" placeholder="Name des Abenteuers...">
        </div>

        <!-- GRID SECTION WITH VERTICAL DIVIDER -->
        <div class="grid-section">
            <!-- 2x2 MAIN GRID -->
            <div class="main-grid">
            <!-- CHARACTER -->
            <div class="card" id="character-card">
                <div class="card-header">
                    <span class="card-title"><span class="card-title-icon">person</span> Charakter</span>
                </div>
                <div class="card-body">
                    <div class="character-layout">
                        <div class="character-visual">
                            <div class="portrait-container">
                                <div class="portrait" id="portrait-box">
                                    <div class="portrait-health-overlay" id="portrait-health-overlay"></div>
                                    <span class="portrait-placeholder" id="portrait-placeholder">Portrait</span>
                                    <img id="portrait-img" style="display: none;">
                                    <div class="level-badge" id="level-badge" onclick="openLevelPopup()" title="Level">1</div>
                                    <div class="portrait-controls-row">
                                        <button class="img-control-btn" onclick="document.getElementById('portrait-upload').click()" title="Eigenes Bild hochladen">
                                            <span class="card-title-icon">edit</span>
                                        </button>
                                        <button class="img-control-btn gallery" onclick="openPortraitGallery()" title="Aus Galerie wählen">
                                            <span class="card-title-icon">collections</span>
                                        </button>
                                        <button class="img-control-btn delete" onclick="removePortrait()" title="Bild löschen">
                                            <span class="card-title-icon">delete</span>
                                        </button>
                                    </div>
                                </div>
                            </div>
                            <div class="crew-flag-container">
                                <div class="crew-flag" onclick="document.getElementById('jolly-upload').click()" title="Bild zur Zugehörigkeit des Charakters, z. B. Organisation, Fraktion oder Einheit">
                                    <span class="crew-flag-placeholder" id="crew-flag-placeholder">Zugehörigkeit</span>
                                    <img id="crew-flag-img" style="display: none;">
                                </div>
                                <div class="crew-flag-controls" id="crew-flag-controls">
                                    <button class="img-control-btn small" onclick="document.getElementById('jolly-upload').click()" title="Bild ändern">
                                        <span class="card-title-icon">edit</span>
                                    </button>
                                    <button class="img-control-btn small delete" onclick="removeCrewFlag()" title="Bild löschen">
                                        <span class="card-title-icon">delete</span>
                                    </button>
                                </div>
                            </div>
                        </div>
                        <div class="character-info">
                            <input type="text" class="character-name" id="char-name" placeholder="Charaktername">
                            <div class="character-meta">
                                <div class="character-meta-item">
                                    <select id="char-race" title="Rasse des Charakters wählen">
                                        <option value="">Rasse wählen...</option>
                                        <optgroup label="Allgemein">
                                            <option value="Mensch" title="Menschen sind die anpassungsfähigste und vielfältigste Spezies. Sie zeichnen sich durch Erfindungsgeist, Ehrgeiz und ihre Fähigkeit aus, sich jeder Situation anzupassen.">Mensch</option>
                                        </optgroup>
                                        <optgroup label="Rum & Rache">
                                            <option value="Velaryn" title="Velaryn sind bekannt für ihre Arroganz, Disziplin und Perfektionismus. Sie streben nach Meisterschaft in allem und finden sich oft in hohen Positionen oder elitären Orden.">Velaryn</option>
                                            <option value="Brûnk" title="Brûnk sind kräftiger und robuster als Menschen, dabei vollständig in die Gesellschaft integriert. Ihr grimmiges Auftreten täuscht – sie können ebenso ehrenhaft und kultiviert sein.">Brûnk</option>
                                            <option value="Kabat" title="Kabats sind kleine, nomadische Einzelgänger, die Freiheit über alles stellen. Sie gelten als rätselhaft, klug und unberechenbar – respektiert, aber nie ganz verstanden.">Kabat</option>
                                        </optgroup>
                                        <optgroup label="Fantasy">
                                            <option value="Elf">Elf</option>
                                            <option value="Zwerg">Zwerg</option>
                                            <option value="Ork">Ork</option>
                                            <option value="Goblin">Goblin</option>
                                            <option value="Halbling">Halbling</option>
                                            <option value="Troll">Troll</option>
                                            <option value="Oger">Oger</option>
                                        </optgroup>
                                        <optgroup label="Sci-Fi">
                                            <option value="Reptiloid">Reptiloid</option>
                                            <option value="Insektoid">Insektoid</option>
                                            <option value="Android">Android</option>
                                            <option value="Cyborg">Cyborg</option>
                                        </optgroup>
                                        <optgroup label="Post-Apokalypse">
                                            <option value="Infizierter">Infizierter</option>
                                            <option value="Kultist">Kultist</option>
                                        </optgroup>
                                    </select>
                                </div>
                                <div class="character-meta-item">
                                    <select id="char-age">
                                        <option value="">Alter...</option>
                                        <option value="15">15 Jahre</option>
                                        <option value="16">16 Jahre</option>
                                        <option value="17">17 Jahre</option>
                                        <option value="18">18 Jahre</option>
                                        <option value="19">19 Jahre</option>
                                        <option value="20">20 Jahre</option>
                                        <option value="21">21 Jahre</option>
                                        <option value="22">22 Jahre</option>
                                        <option value="23">23 Jahre</option>
                                        <option value="24">24 Jahre</option>
                                        <option value="25">25 Jahre</option>
                                        <option value="26">26 Jahre</option>
                                        <option value="27">27 Jahre</option>
                                        <option value="28">28 Jahre</option>
                                        <option value="29">29 Jahre</option>
                                        <option value="30">30 Jahre</option>
                                        <option value="31">31 Jahre</option>
                                        <option value="32">32 Jahre</option>
                                        <option value="33">33 Jahre</option>
                                        <option value="34">34 Jahre</option>
                                        <option value="35">35 Jahre</option>
                                        <option value="36">36 Jahre</option>
                                        <option value="37">37 Jahre</option>
                                        <option value="38">38 Jahre</option>
                                        <option value="39">39 Jahre</option>
                                        <option value="40">40 Jahre</option>
                                        <option value="41">41 Jahre</option>
                                        <option value="42">42 Jahre</option>
                                        <option value="43">43 Jahre</option>
                                        <option value="44">44 Jahre</option>
                                        <option value="45">45 Jahre</option>
                                        <option value="46">46 Jahre</option>
                                        <option value="47">47 Jahre</option>
                                        <option value="48">48 Jahre</option>
                                        <option value="49">49 Jahre</option>
                                        <option value="50">50 Jahre</option>
                                        <option value="51">51 Jahre</option>
                                        <option value="52">52 Jahre</option>
                                        <option value="53">53 Jahre</option>
                                        <option value="54">54 Jahre</option>
                                        <option value="55">55 Jahre</option>
                                        <option value="56">56 Jahre</option>
                                        <option value="57">57 Jahre</option>
                                        <option value="58">58 Jahre</option>
                                        <option value="59">59 Jahre</option>
                                        <option value="60">60 Jahre</option>
                                        <option value="61">61 Jahre</option>
                                        <option value="62">62 Jahre</option>
                                        <option value="63">63 Jahre</option>
                                        <option value="64">64 Jahre</option>
                                        <option value="65">65 Jahre</option>
                                        <option value="66">66 Jahre</option>
                                        <option value="67">67 Jahre</option>
                                        <option value="68">68 Jahre</option>
                                        <option value="69">69 Jahre</option>
                                        <option value="70">70 Jahre</option>
                                        <option value="71">71 Jahre</option>
                                        <option value="72">72 Jahre</option>
                                        <option value="73">73 Jahre</option>
                                        <option value="74">74 Jahre</option>
                                        <option value="75">75 Jahre</option>
                                        <option value="76">76 Jahre</option>
                                        <option value="77">77 Jahre</option>
                                        <option value="78">78 Jahre</option>
                                        <option value="79">79 Jahre</option>
                                        <option value="80">80 Jahre</option>
                                    </select>
                                </div>
                                <div class="character-meta-item">
                                    <select id="char-gender">
                                        <option value="">Geschlecht...</option>
                                        <option value="Männlich">Männlich</option>
                                        <option value="Weiblich">Weiblich</option>
                                        <option value="Divers">Divers</option>
                                        <option value="Irrelevant">Irrelevant</option>
                                    </select>
                                </div>
                                <div class="character-meta-item">
                                    <select id="char-rang" title="Rang bestimmt die Basis-Lebenspunkte (HP = 100 + Rang-Mod + ZÄH × 5)">
                                        <option value="">Rang...</option>
                                        <option value="lesser">Lesser (-50 HP)</option>
                                        <option value="common">Common (100 HP)</option>
                                        <option value="elite">Elite (+50 HP)</option>
                                        <option value="paragon">Paragon (+100 HP)</option>
                                        <option value="apex">Apex (+200 HP)</option>
                                    </select>
                                </div>
                            </div>
                            <div class="character-fields">
                                <div class="field-group">
                                    <label class="field-label">Zugehörigkeit</label>
                                    <input type="text" class="field-input" id="char-crew" placeholder="Organisation, Fraktion, Einheit...">
                                </div>
                                <div class="field-group">
                                    <label class="field-label">Rolle</label>
                                    <input type="text" class="field-input" id="char-role" placeholder="z.B. Kapitän, Navigator...">
                                </div>
                                <div class="field-group">
                                    <label class="field-label">Rüstung</label>
                                    <select class="field-input" id="armor-type" title="Rüstungstyp wählen">
                                        <option value="0">Ohne Rüstung</option>
                                        <option value="2">Leichte Rüstung</option>
                                        <option value="4">Mittlere Rüstung</option>
                                        <option value="6">Schwere Rüstung</option>
                                    </select>
                                </div>
                                <textarea class="field-textarea" id="char-appearance" placeholder="Kurze Charakterbeschreibung..."></textarea>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ATTRIBUTES -->
            <div class="card">
                <div class="card-header">
                    <span class="card-title"><span class="card-title-icon">fitness_center</span> Attribute & Initiative</span>
                    <button class="card-action-btn" id="initiative-roll-btn" onclick="rollInitiative()" title="Initiative würfeln (W20 + Resonanz/5)">
                        <svg viewBox="0 0 24 24" fill="currentColor" width="16" height="16"><path d="M5 3h14a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2m3 12a2 2 0 0 0-2 2 2 2 0 0 0 2 2 2 2 0 0 0 2-2 2 2 0 0 0-2-2m8-8a2 2 0 0 0-2 2 2 2 0 0 0 2 2 2 2 0 0 0 2-2 2 2 0 0 0-2-2m0 8a2 2 0 0 0-2 2 2 2 0 0 0 2 2 2 2 0 0 0 2-2 2 2 0 0 0-2-2m-4-4a2 2 0 0 0-2 2 2 2 0 0 0 2 2 2 2 0 0 0 2-2 2 2 0 0 0-2-2m-4-4a2 2 0 0 0-2 2 2 2 0 0 0 2 2 2 2 0 0 0 2-2 2 2 0 0 0-2-2Z"/></svg>
                    </button>
                </div>
                <div class="card-body">
                    <div class="attributes-layout">
                        <div class="attributes-left">
                            <div class="attr-points-row">
                                <div class="attr-points-badge" id="attr-points">
                                    <span id="attr-points-text">15 / 15 Attributs-Punkte zu verteilen</span>
                                </div>
                            </div>
                            <div class="attributes-top-row">
                                <div class="attribute-item" title="Kraft - Feuer, Blitz">
                                    <div class="attribute-box">
                                        <div class="attribute-modifier">
                                            <input type="number" id="attr-power" value="0" min="0" max="5" onfocus="this.select()">
                                        </div>
                                        <div class="attribute-name">Kraft</div>
                                    </div>
                                    <div class="attribute-base">KRF</div>
                                </div>
                                <div class="attribute-item" title="Geschick - Wasser, Wind">
                                    <div class="attribute-box">
                                        <div class="attribute-modifier">
                                            <input type="number" id="attr-agility" value="0" min="0" max="5" onfocus="this.select()">
                                        </div>
                                        <div class="attribute-name">Geschick</div>
                                    </div>
                                    <div class="attribute-base">GES</div>
                                </div>
                                <div class="attribute-item" title="Zähigkeit - Erde">
                                    <div class="attribute-box">
                                        <div class="attribute-modifier">
                                            <input type="number" id="attr-endurance" value="0" min="0" max="5" onfocus="this.select()">
                                        </div>
                                        <div class="attribute-name">Zähigkeit</div>
                                    </div>
                                    <div class="attribute-base">ZÄH</div>
                                </div>
                            </div>
                            <div class="attributes-bottom-row">
                                <div class="attribute-item" title="Verstand - Raum">
                                    <div class="attribute-box">
                                        <div class="attribute-modifier">
                                            <input type="number" id="attr-mind" value="0" min="0" max="5" onfocus="this.select()">
                                        </div>
                                        <div class="attribute-name">Verstand</div>
                                    </div>
                                    <div class="attribute-base">VER</div>
                                </div>
                                <div class="attribute-item" title="Präsenz - Illusion">
                                    <div class="attribute-box">
                                        <div class="attribute-modifier">
                                            <input type="number" id="attr-presence" value="0" min="0" max="5" onfocus="this.select()">
                                        </div>
                                        <div class="attribute-name">Präsenz</div>
                                    </div>
                                    <div class="attribute-base">PRÄ</div>
                                </div>
                            </div>
                        </div>
                        <div class="attributes-divider"></div>
                        <div class="initiative-box-wrapper">
                            <div class="initiative-box" title="Initiative = W20 + (Resonanz / 5)">
                                <div class="initiative-value">
                                    <input type="number" id="char-initiative" value="0" min="0" onfocus="this.select()">
                                </div>
                                <div class="initiative-name">Initiative</div>
                            </div>
                            <div class="initiative-base" id="initiative-formula">W20 + RES/5</div>
                        </div>
                    </div>
                    <!-- MOVEMENT & RANGE BAR -->
                    <div class="movement-range-bar">
                        <div class="mr-section" title="Bewegung = 5 + (GES / 2) − Rüstungsmalus">
                            <span class="mr-label">Bewegung</span>
                            <span class="mr-value" id="movement-value">4</span>
                            <span class="mr-unit">Felder</span>
                        </div>
                        <div class="mr-divider"></div>
                        <div class="mr-section">
                            <span class="mr-label">Reichweite</span>
                            <select class="mr-select" id="range-type" title="Standard-Reichweite der Hauptwaffe/Fähigkeit">
                                <option value="1">Nahkampf (1)</option>
                                <option value="2">Erw. Nahkampf (2)</option>
                                <option value="4">Kurzdistanz (4)</option>
                                <option value="8">Mitteldistanz (8)</option>
                                <option value="12">Weitdistanz (12)</option>
                                <option value="16">Extremdistanz (16+)</option>
                            </select>
                            <span class="mr-unit">Felder</span>
                        </div>
                        <div class="mr-divider"></div>
                        <div class="mr-section" title="Reichweitenbonus = Resonanz / 10 (abrunden)">
                            <span class="mr-bonus" id="range-bonus-display">+0 RES-Bonus</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- STATUS -->
            <div class="card">
                <div class="card-header">
                    <span class="card-title"><span class="card-title-icon">favorite</span> Status</span>
                </div>
                <div class="card-body">
                    <div class="status-layout">
                        <div class="status-bars">
                            <div class="status-item">
                                <div class="status-values">
                                    <input type="number" class="status-current" id="health-current" value="100" min="0" onfocus="this.select()">
                                    <span class="status-separator">/</span>
                                    <span class="status-max" id="health-max-display">100</span>
                                </div>
                                <div class="status-bar-container" id="health-container" title="100 + Rang + (ZÄH × 5)">
                                    <span class="status-label" id="health-label">Lebenspunkte (100 + Rang + ZÄH × 5)</span>
                                    <div class="status-bar draggable" data-status="health">
                                        <div class="status-bar-fill health" id="health-bar" style="width: 100%;"></div>
                                    </div>
                                </div>
                            </div>
                            <div class="status-item">
                                <div class="status-values">
                                    <input type="number" class="status-current" id="moral-current" value="100" min="0" onfocus="this.select()">
                                    <span class="status-separator">/</span>
                                    <span class="status-max">100</span>
                                </div>
                                <div class="status-bar-container">
                                    <span class="status-label">Moral</span>
                                    <div class="status-bar draggable" data-status="moral">
                                        <div class="status-bar-fill moral" id="moral-bar" style="width: 100%"></div>
                                    </div>
                                </div>
                            </div>
                            <div class="status-item">
                                <div class="status-values">
                                    <span class="status-current-display" id="resonanz-display">10</span>
                                    <span class="status-separator">/</span>
                                    <span class="status-max">100</span>
                                </div>
                                <div class="status-bar-container" id="resonanz-container" title="10 + (VER × PRÄ) = 10">
                                    <span class="status-label">Resonanz (10 + VER × PRÄ)</span>
                                    <div class="status-bar">
                                        <div class="status-bar-fill resonanz" id="resonanz-bar" style="width: 10%"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="status-info-box">
                            <div class="status-info-row">
                                <span class="status-info-icon" style="color: var(--color-health);">●</span>
                                <span class="status-info-text">0 = Tot | 5 und weniger = Bewusstlos | 20 und weniger = Stark handlungseingeschränkt</span>
                            </div>
                            <div class="status-info-row">
                                <span class="status-info-icon" style="color: var(--color-moral);">●</span>
                                <span class="status-info-text">0 = Handlungsunfähig | 20 und weniger = Würfelproben massiv erschwert | 50 und weniger = Würfelproben leicht erschwert</span>
                            </div>
                            <div class="status-info-row">
                                <span class="status-info-icon" style="color: var(--color-resonanz);">●</span>
                                <span class="status-info-text">Bestimmt Bonus für Fokus-Fähigkeiten Würfelproben</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- FOKUS -->
            <div class="card" id="fokus-card">
                <div class="card-header">
                    <span class="card-title"><span class="card-title-icon">auto_awesome</span> Fokus</span>
                </div>
                <div class="card-body">
                    <div class="fokus-layout">
                        <div class="fokus-header" onclick="openFokusPopup()">
                            <div class="fokus-icon" id="fokus-icon">
                                <span style="color: var(--text-muted); font-size: 24px;">?</span>
                            </div>
                            <div class="fokus-info">
                                <div class="fokus-name" id="fokus-name">Kein Fokus gewählt</div>
                                <div class="fokus-attr" id="fokus-attr">Klicke um zu wählen</div>
                            </div>
                        </div>
                        <div class="fokus-abilities" id="fokus-abilities">
                            <div class="fokus-ability empty" onclick="openFokusPopup()">
                                <span>Fähigkeit 1</span>
                            </div>
                            <div class="fokus-ability empty" onclick="openFokusPopup()">
                                <span>Fähigkeit 2</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- GEFAHRENPROFIL -->
                <div class="card">
                <div class="card-header">
                    <span class="card-title"><span class="card-title-icon">warning</span> Gefahrenprofil</span>
                </div>
                <div class="card-body">
                    <div class="schwaeche-inner-layout">
                        <div class="schwaeche-display" id="schwaeche-display" onclick="openSchwaechePopup()">
                            <div class="schwaeche-empty">Keine Schwäche gewählt</div>
                        </div>
                        <div class="schwaeche-inner-divider"></div>
                        <div class="armor-shield-wrapper">
                            <div class="armor-shield" title="Schadensreduktion = Rüstung DR + Resonanz-Schild (RES/10)">
                                <div class="armor-shield-label">Schutz</div>
                                <div class="armor-shield-total" id="armor-total-display">0</div>
                                <div class="armor-shield-breakdown">
                                    <span class="armor-shield-sub-val" id="armor-dr-display">0</span>
                                    <span class="armor-shield-sub-sep">+</span>
                                    <span class="armor-shield-sub-val" id="armor-res-display">0</span>
                                    <span class="armor-shield-sub">RES</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- RAST -->
            <div class="card">
                <div class="card-header">
                    <span class="card-title"><span class="card-title-icon">hotel</span> Rast</span>
                </div>
                <div class="card-body">
                    <div class="rast-buttons">
                        <button class="rast-btn lange" onclick="langeRast()">
                            <svg class="rast-btn-icon" viewBox="0 0 24 24"><path fill="currentColor" d="M12 22q-2.075 0-3.9-.788t-3.175-2.137T2.788 15.9T2 12t.788-3.9t2.137-3.175T8.1 2.788T12 2t3.9.788t3.175 2.137T21.213 8.1T22 12t-.788 3.9t-2.137 3.175t-3.175 2.138T12 22m0-2q1.6 0 3.075-.6t2.6-1.725L12 12V4Q8.65 4 6.325 6.325T4 12t2.325 5.675T12 20"/></svg>
                            <span class="rast-btn-title">Lange Rast</span>
                            <span class="rast-btn-info">+20 LP, +10 Moral, +1 Zweite Chance</span>
                        </button>
                        <button class="rast-btn kurze" onclick="kurzeRast()">
                            <svg class="rast-btn-icon" viewBox="0 0 24 24"><path fill="currentColor" d="M12 22q-2.075 0-3.9-.788t-3.175-2.137T2.788 15.9T2 12t.788-3.9t2.137-3.175T8.1 2.788T12 2t3.9.788t3.175 2.137T21.213 8.1T22 12t-.788 3.9t-2.137 3.175t-3.175 2.138T12 22m0-2q3.35 0 5.675-2.325T20 12q0-1.6-.6-3.075t-1.725-2.6L12 12V4Q8.65 4 6.325 6.325T4 12t2.325 5.675T12 20"/></svg>
                            <span class="rast-btn-title">Kurze Rast</span>
                            <span class="rast-btn-info">+10 LP, +5 Moral</span>
                        </button>
                    </div>
                </div>
            </div>
        </div>
        </div>
        <!-- END GRID SECTION -->

        <!-- BOTTOM SECTION -->
        <div class="bottom-section">
            <!-- SKILLS - Full Width -->
            <div class="card">
                <div class="card-header">
                    <span class="card-title"><span class="card-title-icon">menu_book</span> Fähigkeiten</span>
                    <div class="skill-points-badge" id="skill-points">
                        <span id="skill-points-text">500 / 500 Punkte verfügbar</span>
                    </div>
                </div>
                <div class="skills-tabs">
                    <button class="skill-tab active" data-category="handeln" onclick="switchSkillTab('handeln')">
                        <div class="skill-tab-name">Handeln</div>
                        <div class="skill-tab-attrs">KRF + GES + ZÄH</div>
                    </button>
                    <button class="skill-tab" data-category="wissen" onclick="switchSkillTab('wissen')">
                        <div class="skill-tab-name">Wissen</div>
                        <div class="skill-tab-attrs">VER + ZÄH</div>
                    </button>
                    <button class="skill-tab" data-category="soziales" onclick="switchSkillTab('soziales')">
                        <div class="skill-tab-name">Soziales</div>
                        <div class="skill-tab-attrs">PRÄ + VER</div>
                    </button>
                </div>
                
                <div class="skill-panel active" id="panel-handeln">
                    <div class="skills-list-header">
                        <span></span><span>Fähigkeit</span><span>Pkt</span><span>Bonus</span><span></span>
                    </div>
                    <div id="skills-handeln"></div>
                    <div class="skill-btn-row">
                        <button class="add-skill-btn" onclick="addSkill('handeln')">+ Hinzufügen</button>
                        <button class="catalog-skill-btn" onclick="openSkillCatalog('handeln')">📖 Katalog</button>
                    </div>
                    <div class="skill-footer">
                        <span class="skill-footer-label">Klassen-Fallback</span>
                        <div>
                            <span class="skill-footer-value" id="handeln-total">0</span>
                            <span class="skill-footer-bonus" id="handeln-bonus">+0</span>
                        </div>
                    </div>
                </div>
                
                <div class="skill-panel" id="panel-wissen">
                    <div class="skills-list-header">
                        <span></span><span>Fähigkeit</span><span>Pkt</span><span>Bonus</span><span></span>
                    </div>
                    <div id="skills-wissen"></div>
                    <div class="skill-btn-row">
                        <button class="add-skill-btn" onclick="addSkill('wissen')">+ Hinzufügen</button>
                        <button class="catalog-skill-btn" onclick="openSkillCatalog('wissen')">📖 Katalog</button>
                    </div>
                    <div class="skill-footer">
                        <span class="skill-footer-label">Klassen-Fallback</span>
                        <div>
                            <span class="skill-footer-value" id="wissen-total">0</span>
                            <span class="skill-footer-bonus" id="wissen-bonus">+0</span>
                        </div>
                    </div>
                </div>
                
                <div class="skill-panel" id="panel-soziales">
                    <div class="skills-list-header">
                        <span></span><span>Fähigkeit</span><span>Pkt</span><span>Bonus</span><span></span>
                    </div>
                    <div id="skills-soziales"></div>
                    <div class="skill-btn-row">
                        <button class="add-skill-btn" onclick="addSkill('soziales')">+ Hinzufügen</button>
                        <button class="catalog-skill-btn" onclick="openSkillCatalog('soziales')">📖 Katalog</button>
                    </div>
                    <div class="skill-footer">
                        <span class="skill-footer-label">Klassen-Fallback</span>
                        <div>
                            <span class="skill-footer-value" id="soziales-total">0</span>
                            <span class="skill-footer-bonus" id="soziales-bonus">+0</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Bottom Row: Zweite Chance + Währung/Waffe -->
            <div class="bottom-row">
                <!-- ZWEITE CHANCE -->
                <div class="card">
                    <div class="card-header">
                        <span class="card-title"><span class="card-title-icon">casino</span> Zweite Chance</span>
                        <button class="card-action-btn gm-only" id="reset-zweite-chance-btn" onclick="resetZweiteChance()" title="Zweite Chance wiederherstellen (GM)">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8"/>
                                <path d="M21 3v5h-5"/>
                                <path d="M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16"/>
                                <path d="M8 16H3v5"/>
                            </svg>
                        </button>
                    </div>
                    <div class="card-body">
                        <div class="dice-row-large">
                            <div class="dice-check-large" id="dice-1" onclick="rollZweiteChance(0)" title="Klicken um Zweite Chance zu nutzen">
                                <svg viewBox="0 0 100 100"><path d="m49.355 99.528c-0.24708-0.25657-1.6214-1.7492-3.0541-3.317-2.3047-2.5219-3.516-3.8292-5.2938-5.7131-0.2773-0.29384-1.5251-1.6542-2.773-3.0229-2.3561-2.5844-5.1488-5.6429-7.9097-8.6624-0.88412-0.96693-2.926-3.1848-4.5376-4.9285-1.6116-1.7438-2.9553-3.2374-2.9861-3.3192-0.03234-0.0858 11.461-0.14867 27.183-0.14867 14.982 0 27.24 0.0489 27.24 0.10862 0 0.0597-0.35576 0.49459-0.79058 0.96634-0.43482 0.47174-1.5941 1.7274-2.5761 2.7904-2.0061 2.1714-6.6115 7.1835-16.129 17.553-7.9441 8.6552-7.4759 8.1604-7.7209 8.1604-0.11174 0-0.40531-0.20993-0.65239-0.46651zm-3.7748-13.817c0.39727-2e-3 0.81169-0.3825 3.5099-3.2228 2.3664-2.491 2.4207-2.5693 2.4207-3.4926 0-0.64199-0.08645-0.869-0.47136-1.2378-0.47061-0.45088-0.47552-0.4516-3.1091-0.4516h-2.6377v-0.58029c0-0.77677-0.29798-1.3867-0.73474-1.5039-0.66048-0.17724-2.2232-0.10269-2.5286 0.12063-0.23999 0.1755-0.29005 0.40128-0.24219 1.0925l0.06032 0.87127-0.72189-1e-4c-0.54246-8e-5-0.82442 0.10243-1.1344 0.4124-0.46236 0.46236-0.49288 0.65126-0.22801 1.4111 0.17624 0.50555 0.22516 0.52926 1.0924 0.52926h0.90788l0.0018 2.0587c0.0024 2.6671 0.10714 3.2727 0.62472 3.6118 0.53088 0.34786 1.4868 0.54218 2.2304 0.45344 0.32351-0.0386 0.75546-0.071 0.95989-0.072zm-0.45571-4.4549v-1.597h2.7298l-0.8107 0.96633c-0.44588 0.53148-1.0601 1.2502-1.3649 1.597l-0.55419 0.6307zm12.321 4.2144c0.8131-0.22371 1.6667-0.53017 1.897-0.68103 0.80329-0.52633 0.85761-1.4792 0.12208-2.1415-0.29264-0.26347-0.39883-0.26725-1.2377-0.044-0.50468 0.1343-0.97433 0.24508-1.0437 0.24618-0.06933 1e-3-0.12605-1.54-0.12605-3.4246 0-4.0332-0.0313-4.1238-1.4718-4.2622-0.4742-0.0456-1.1311-0.0324-1.4598 0.0293l-0.59765 0.11213v4.625c0 4.7022 0.05332 5.1523 0.65475 5.5273 0.78945 0.49217 1.5119 0.49514 3.2628 0.0134zm-15.934 10.222c-1.4789-0.86882-3.3696-1.9615-4.2015-2.4283-0.83189-0.46671-2.231-1.269-3.1091-1.783-0.87811-0.5139-2.1638-1.2552-2.857-1.6474-1.1159-0.63127-6.3995-3.7016-7.0585-4.1017-0.16478-0.10005 0.01413-0.12419 0.51658-0.0697 1.0579 0.11473 2.0979-0.40834 2.2576-1.1355 0.18747-0.85356-0.60997-2.1791-2.2134-3.6793-1.6671-1.5597-2.903-2.2412-3.9281-2.1659-0.87311 0.0642-1.0924 0.35849-0.9267 1.2436 0.09952 0.53145 0.40876 0.93983 1.6115 2.1282 0.85734 0.84704 1.3737 1.4705 1.2179 1.4705-0.53059 0-1.7144-0.8545-2.7635-1.9948-1.1112-1.2078-1.7484-1.5858-1.9198-1.139-0.14181 0.36954 0.20176 0.9087 1.326 2.0809l1.0049 1.0478-3.1753-1.8243c-7.5298-4.3261-9.5448-5.5157-9.5908-5.6619-0.0413-0.13126 11.913-5.2904 12.243-5.2835 0.06231 1e-3 2.5958 2.7035 5.63 6.0049 3.0342 3.3014 7.3653 8.0091 9.6247 10.462 2.2594 2.4525 4.8266 5.2532 5.7049 6.2237 0.87829 0.97054 2.0525 2.2373 2.6094 2.815 0.55691 0.57771 0.93912 1.043 0.84935 1.034-0.08977-9e-3-1.3732-0.72718-2.8521-1.596zm-11.008-11.851c0-0.16876-3.1603-3.806-4.474-5.1492-0.56794-0.58069-1.1402-0.69509-1.6419-0.32824-0.27162 0.19861-0.11049 0.43344 1.8161 2.6469 1.1628 1.3359 2.3223 2.5609 2.5767 2.7222 0.51342 0.32542 1.7231 0.40145 1.7231 0.10829zm27.785 10.48c2.7071-2.9298 5.6036-6.0821 16.292-17.73 2.9473-3.212 5.4213-5.84 5.4977-5.84 0.1134 0 3.2765 1.3251 11.923 4.9947l0.57582 0.24439-0.49178 0.29554c-0.50069 0.30087-2.6666 1.5541-7.6343 4.4173-1.5251 0.87902-4.7393 2.7344-7.1425 4.123-2.4032 1.3886-6.5627 3.789-9.2432 5.3342-6.2842 3.6225-7.7929 4.4953-10.283 5.9487-1.1263 0.6575-2.0933 1.1954-2.1488 1.1954s1.1393-1.3424 2.6553-2.983zm15.411-11.055 0.6075-0.5932 1.5614 0.603c1.3194 0.50957 1.6385 0.57613 2.0591 0.42951 0.62617-0.21829 1.4067-0.85993 2.1111-1.7354l0.54619-0.67886v-2.4934c0-2.486-1e-3-2.4942-0.42777-2.7736-0.78128-0.51191-1.4935-0.12225-3.4114 1.8664l-1.6992 1.7619-0.76243-0.1045c-0.74918-0.10269-0.77844-0.0885-1.6843 0.81741-0.50705 0.50706-0.92192 1.0017-0.92192 1.0991 0 0.0975 0.22688 0.25627 0.50418 0.35295 0.61346 0.21385 0.62719 0.3552 0.084 0.86547-0.40713 0.38248-0.53797 0.8345-0.3081 1.0644 0.31743 0.31743 1.1631 0.0838 1.7417-0.48117zm3.5547-2.4184c-0.3991-0.15832-0.70984-0.35845-0.69053-0.44474 0.0193-0.0863 0.3602-0.52851 0.75753-0.98272 0.69095-0.78986 0.72626-0.80816 0.81051-0.42015 0.17368 0.79996 0.18398 2.1705 0.0162 2.153-0.09239-0.01-0.4946-0.14706-0.8937-0.30538zm-53.622 1.7656c-0.59744-0.44078-1.1959-1.1577-1.1959-1.4326 0-0.30204 0.44464-0.38937 0.86918-0.17069 0.67218 0.34622 1.3156 1.0477 1.3156 1.4344 0 0.53897-0.39574 0.60657-0.98891 0.16895zm-17.324-9.1625c-0.11287-0.2109-0.17397-3.1085-0.17397-8.2498v-7.9247l0.50912 0.4284c1.0142 0.85342 2.3042 0.68805 3.5028-0.44905 1.2455-1.1815 1.6707-3.079 1.1375-5.0753-0.51715-1.936-1.3598-2.941-2.4657-2.941-0.51111 0-0.73028 0.11175-1.1446 0.5836-0.49742 0.56653-0.86402 1.4963-0.86593 2.1961-0.0018 0.67533 0.5256 2.3576 0.93316 2.9763 0.38976 0.59168 0.39529 0.63021 0.09039 0.63021-0.58952 0-0.86637-0.20134-1.2417-0.90303l-0.37097-0.69352-0.04109-11.764-0.04109-11.764 6.3853 19.067c3.5119 10.487 6.3853 19.115 6.3853 19.175 0 0.1797-11.598 5.0334-12.027 5.0334-0.22101 0-0.47476-0.14434-0.57149-0.32507zm4.0067-8.3049c0.32316-0.38938 0.2724-1.0265-0.13421-1.6844-0.3788-0.61291-0.38116-0.63946-0.07596-0.85607 0.17323-0.12294 0.9956-0.74527 1.8275-1.3829 1.2903-0.98907 1.5203-1.2395 1.5657-1.7046 0.07311-0.74938-0.44134-2.26-0.7317-2.1485-0.57858 0.22203-4.7593 3.5317-4.9276 3.9008-0.27481 0.60315 0.01779 1.7125 0.75989 2.881 0.33868 0.53331 0.69792 1.0252 0.79831 1.0931 0.28795 0.19479 0.71242 0.14927 0.91801-0.0985zm79.765 7.5155c-1.2016-0.5139-3.6973-1.5786-5.5459-2.366-1.8486-0.78738-3.3839-1.452-3.4117-1.477-0.0278-0.025 2.8281-8.6566 6.3464-19.182l6.397-19.136-0.06 10.84c-0.033 5.9619-0.12851 11.178-0.21227 11.592l-0.15227 0.75199-1.7414-1.6763c-0.95776-0.92197-1.8841-1.7306-2.0584-1.7968-0.38352-0.1458-0.70716 0.29355-0.98047 1.331l-0.18608 0.7063 1.3908 1.3237c0.76496 0.72806 1.9721 1.8471 2.6826 2.4868l1.2917 1.1631 0.0107 7.9147c0.0101 7.4619-7e-3 7.9306-0.29662 8.1928-0.49632 0.44916-1.1594 0.3216-3.474-0.66831zm1.6041-8.3049c1.0338-1.1067 1.5617-3.5073 1.1101-5.0482-0.34817-1.1879-0.9474-1.8341-1.7007-1.8341-0.54457 0-0.58106-0.0398-0.83396-0.90978-0.33762-1.1613-1.0873-1.8581-1.8377-1.708-0.70051 0.1401-1.0076 0.46438-1.5191 1.6042-1.0771 2.4001-0.96085 4.6927 0.2976 5.8683 0.3466 0.32377 0.55376 0.38448 1.0739 0.31473 0.63184-0.0848 0.64862-0.0729 0.85904 0.60719 0.48345 1.5625 1.6513 2.0687 2.5508 1.1057zm-1.2637-2.6725c-0.3569-0.69018-0.32033-1.1206 0.12173-1.4325 0.35419-0.2499 0.39775-0.24277 0.68804 0.11264 0.47659 0.58351 0.18698 1.8-0.43163 1.8131-0.067 1e-3-0.23712-0.22055-0.37814-0.49325zm-2.3094-1.813c-0.42602-0.48504-0.49804-0.99099-0.23178-1.6282 0.29224-0.69943 0.65516-0.76742 1.0314-0.19324 0.6004 0.91632-0.13107 2.5826-0.79959 1.8215zm-65.842 8.4009c9.25e-4-0.16654 1.2582-2.3568 13.868-24.158 1.9246-3.3276 4.2341-7.3358 5.1322-8.9071s1.7738-3.0986 1.946-3.3939c0.17212-0.2953 1.7499-3.0342 3.5061-6.0865 1.7562-3.0523 3.2309-5.5499 3.2771-5.5504 0.04622-5e-4 0.72189 1.1125 1.5015 2.4732 0.77961 1.3607 2.072 3.6084 2.872 4.9949 0.8 1.3865 2.3457 4.0712 3.435 5.9661 1.0892 1.8948 2.2297 3.8611 2.5343 4.3695 0.30461 0.50839 2.9918 5.1594 5.9715 10.336 2.9797 5.1762 6.7672 11.743 8.4165 14.593 1.6494 2.8498 2.9989 5.251 2.9989 5.3359 0 0.0931-10.996 0.15436-27.73 0.15436-15.251 0-27.729-0.0567-27.729-0.12605zm37.606-8.4356c2.4648-1.3188 3.6068-3.7111 3.6144-7.572 0.0045-2.2651-0.29676-3.6156-1.1483-5.1478-0.6781-1.2201-1.4817-1.9684-2.7557-2.5659-0.80918-0.37954-1.1534-0.43714-2.6126-0.43714-1.495 0-1.785 0.0513-2.6258 0.46421-1.0411 0.51129-2.2839 1.7306-2.805 2.7521-0.73197 1.4348-0.94808 2.5596-0.94808 4.9345 0 3.1865 0.50517 4.7607 2.0617 6.4248 1.3064 1.3966 2.4489 1.8284 4.6533 1.7587 1.3454-0.0426 1.6289-0.11012 2.566-0.61148zm-3.9838-3.2286c-0.72061-0.67135-1.0689-1.7672-1.1531-3.6285-0.12287-2.7142 0.44092-4.7874 1.4237-5.2352 1.1673-0.53187 2.1977 0.0116 2.7626 1.4571 0.31808 0.81391 0.37614 1.2867 0.37614 3.0632 0 1.7765-0.05805 2.2493-0.37616 3.0632-0.20689 0.52938-0.57063 1.1155-0.80832 1.3024-0.5968 0.46945-1.7089 0.4583-2.2248-0.0223zm-7.8519 3.3688c0.76638-0.3492 1.0157-1.6194 0.54091-2.7557l-0.2418-0.57869-5.587-0.0922 1.9373-1.6493c2.1184-1.8035 2.7247-2.4823 3.3773-3.7816 1.2918-2.572 0.24707-5.451-2.4002-6.6139-1.7596-0.77292-5.36-0.53586-6.3971 0.4212-1.0543 0.97293-1.1503 2.2908-0.24282 3.3331 0.22626 0.25984 0.32044 0.24441 1.2809-0.20995 2.2631-1.0706 4.5125-0.29409 4.0847 1.4102-0.18523 0.73803-1.1046 1.7742-3.528 3.9764-1.4466 1.3146-2.5495 2.4567-2.7208 2.8177-0.33213 0.69991-0.36926 2.1791-0.06928 2.7601 0.11165 0.2162 0.35798 0.56327 0.5474 0.77125 0.34015 0.37345 0.39804 0.37813 4.6767 0.37813 2.8171 0 4.4756-0.0653 4.7418-0.18659zm-27.525 6.5688c-0.13758-0.37024-8.3083-24.636-11.307-33.58-2.1982-6.5563-2.5743-7.8215-2.3794-8.0036 0.13592-0.12697 1.9313-0.43792 4.3489-0.75321 2.2646-0.29532 4.9115-0.64726 5.8821-0.78208 5.8415-0.81144 30.822-4.0903 30.861-4.0508 0.02619 0.0262-0.27791 0.61163-0.67577 1.301-0.39786 0.68936-1.6153 2.8037-2.7055 4.6986-1.0901 1.8949-2.7 4.693-3.5774 6.2182-0.87745 1.5251-1.7177 2.9778-1.8672 3.2281-0.37435 0.62667-6.1822 10.663-7.6631 13.242-0.66341 1.1554-1.775 3.0839-2.4701 4.2855-0.69517 1.2016-2.7223 4.7182-4.5047 7.8147-4.0974 7.1182-3.8295 6.6845-3.9418 6.3822zm6.3119-25.215c1.5533-0.79245 3.4705-3.2576 4.1865-5.3831 0.45858-1.3613 0.43758-2.8954-0.05144-3.7588-0.81309-1.4355-2.4884-2.0759-3.9872-1.5241-1.1979 0.44108-1.2065 0.43729-1.4233-0.62702-0.31339-1.5388-1.4533-2.5163-2.9344-2.5163-1.0921 0-1.8935 0.39035-3.0329 1.4772-1.7199 1.6405-2.7727 3.7723-2.7754 5.6201-0.0019 1.323 0.38702 2.189 1.3162 2.9302 0.56334 0.4494 0.77734 0.51484 1.6806 0.51389 0.56928-6.7e-4 1.2325-0.0629 1.4739-0.13841 0.42633-0.13342 0.44219-0.11228 0.55521 0.73971 0.06399 0.48237 0.2578 1.1543 0.43068 1.4932 0.28181 0.55239 1.1741 1.3144 1.8524 1.5819 0.48186 0.19003 1.9782-0.0356 2.7091-0.40844zm-1.2994-3.3412c-0.54897-0.23164-1.0737-1.0079-1.0726-1.5869 2e-3-1.1103 0.31406-1.7664 1.0088-2.1208 1.1097-0.56611 2.2445-0.31639 2.6548 0.58422 0.28411 0.62356 0.25096 1.0554-0.14359 1.8704-0.5158 1.0655-1.5893 1.6152-2.4474 1.2531zm-4.8971-3.4612c-0.62581-0.26313-0.88216-0.69558-0.88216-1.4881 0-0.45709 0.14742-0.74715 0.64621-1.2715 0.66086-0.69471 1.0266-0.80174 1.7716-0.51848 0.98922 0.37611 1.2372 2.3857 0.36495 2.9572-0.6811 0.44628-1.3384 0.55724-1.9007 0.32085zm55.728 27.013c-4.2797-7.4421-9.6077-16.68-10.633-18.435-0.48578-0.83188-2.0813-3.5922-3.5456-6.1341-1.4643-2.5419-4.17-7.2307-6.0128-10.42-4.3995-7.6135-4.1825-7.2265-4.052-7.2265 0.06271 0 3.7527 0.48721 8.1999 1.0827 4.4473 0.59547 13.569 1.8106 20.27 2.7004 9.8763 1.3113 12.241 1.6732 12.484 1.9107 0.28709 0.28062 0.17877 0.65513-2.5609 8.8536-1.5734 4.7083-3.2113 9.5816-3.6398 10.829-0.42849 1.2478-2.2501 6.6551-4.0481 12.016-1.7979 5.3611-3.32 9.8-3.3824 9.8643-0.0624 0.0643-1.4483-2.2045-3.08-5.0418zm-0.6831-18.782c0.20596-0.14426 0.48383-0.47375 0.61748-0.73222 0.23687-0.45804 0.21139-0.51585-1.0084-2.2875-0.68827-0.99968-1.2226-1.8464-1.1875-1.8815 0.0352-0.0352 0.77211 0.2368 1.6376 0.60438 2.3724 1.0075 3.8182 1.1734 4.9388 0.56652 0.60712-0.32878 1.2251-1.1247 1.4069-1.812 0.68407-2.586-2.5419-7.8037-4.827-7.8072-0.77149-1e-3-1.5433 0.77246-1.5371 1.5408 4e-3 0.47233 0.1116 0.62433 0.69441 0.97926 0.7699 0.46887 1.8899 1.8608 2.0524 2.5507 0.0986 0.41846-0.21118 0.98219-0.53653 0.9765-0.38385-7e-3-2.112-0.5896-4.1721-1.4072-1.3076-0.51898-2.5946-0.94359-2.86-0.94359-0.76381 0-1.6638 0.71293-1.856 1.4703-0.0906 0.35691-0.10447 0.81181-0.03083 1.0109 0.1587 0.429 4.4627 6.7054 4.8939 7.1365 0.36801 0.36802 1.2732 0.38611 1.7738 0.0355zm-66.841 11.332c-0.18989-0.31146-0.34554-0.75745-0.34588-0.99108-7.48e-4-0.50612 0.4285-1.1718 0.75564-1.1718 0.36936 0 0.75626 0.69198 0.75626 1.3526 0 0.42478-0.12251 0.72064-0.41038 0.99108l-0.41038 0.38553zm6.1237-34.604c6.481-3.7574 12.198-7.0611 21.932-12.674 5.6139-3.2373 7.522-4.3435 10.197-5.9112 0.84788-0.49697 1.6231-0.90359 1.7226-0.90359 0.12692 0 0.181 2.5498 0.181 8.5332v8.5332l-18.781 2.4947c-10.329 1.3721-19.045 2.531-19.369 2.5754-0.42039 0.0577 0.75433-0.69769 4.1174-2.6474zm17.554-2.361c0.46671-0.1001 0.84856-0.25079 0.84856-0.33488 0-0.0841 0.75626-1.7156 1.6806-3.6255 0.92432-1.9099 1.6806-3.6418 1.6806-3.8486 0-0.71758-0.8024-0.65481-2.6991 0.21112-1.1814 0.53938-1.8385 1.1957-1.8385 1.8364 0 0.46471 0.22903 0.4953 1.0719 0.14314 0.3348-0.13989 0.60873-0.22338 0.60873-0.18554 0 0.0378-0.52777 1.1347-1.1728 2.4375-1.2266 2.4773-1.4521 3.0759-1.2699 3.3707 0.13362 0.21621 0.06014 0.2165 1.09-4e-3zm7.1297-1.2433c2.0115-1.0177 4.2078-4.0854 4.4197-6.1731 0.07545-0.74333 0.03038-0.96402-0.27579-1.3507-0.32344-0.40845-0.47861-0.46216-1.3353-0.46216-0.74049 0-1.2072 0.11886-1.977 0.50353-2.2007 1.0997-4.3741 4.1083-4.5499 6.2983-0.07471 0.93071-0.04058 1.0984 0.29119 1.4301 0.53978 0.53978 2.0946 0.42818 3.4271-0.246zm-1.4509-1.4737c-0.21502-0.63193 1.1111-3.3774 2.0145-4.1706 0.76453-0.67127 1.4482-0.63661 1.5297 0.0776 0.07592 0.66519-1.01 2.8208-1.8383 3.649-0.66814 0.66814-1.5514 0.89804-1.7059 0.44401zm31.975 5.2273c-10.306-1.3797-18.833-2.5412-18.949-2.5812-0.16433-0.0568-0.21007-1.9218-0.21007-8.5648 0-5.1598 0.0617-8.4922 0.15724-8.4922 0.08648 0 2.3364 1.2583 4.9997 2.7962 2.6634 1.5379 5.8635 3.3807 7.1113 4.0951 3.0313 1.7356 13.647 7.8684 15.545 8.9805 0.83189 0.48743 3.5922 2.0802 6.1341 3.5396 2.5419 1.4594 4.6531 2.6802 4.6916 2.7129 0.15612 0.13263-1.4784-0.076-19.481-2.486zm0.12998-2.6748c0.02739-0.14224-0.12571-0.51951-0.34023-0.83836-0.37147-0.55214-0.47575-0.59568-2.1906-0.91456-0.99032-0.18414-1.8005-0.37321-1.8003-0.42014 1.65e-4-0.0469 0.34043-0.30021 0.75615-0.56285 1.456-0.91986 1.7099-1.6077 1.0764-2.9163-0.82295-1.7-3.8199-3.2142-6.0343-3.0488-0.67445 0.0504-0.76181 0.1043-0.8075 0.49854-0.03275 0.28256 0.09793 0.61548 0.36216 0.92267 0.38128 0.44326 0.49163 0.47673 1.4203 0.4307 1.1795-0.0585 2.0663 0.25334 2.4691 0.8682 0.37256 0.56859 0.1918 0.87015-1.1721 1.9554-1.3514 1.0753-1.431 1.5086-0.46535 2.5323 0.62072 0.65803 0.67202 0.67671 3.4032 1.239 3.0193 0.62167 3.2489 0.63923 3.3231 0.25419zm-8.0287-1.0942c0-0.053-0.6824-1.6978-1.5164-3.6553-1.6304-3.8264-1.969-4.3228-3.1697-4.6461-0.37368-0.10063-1.0956-0.13107-1.6452-0.0694-1.5473 0.17368-1.7417 0.5029-0.87785 1.4868 0.45977 0.52365 0.61631 0.59405 1.3209 0.59405h0.79929l1.1389 2.6469c0.6264 1.4558 1.2678 2.784 1.4254 2.9516 0.47308 0.50325 2.5247 1.0651 2.5247 0.69137z"/></svg>
                            </div>
                            <div class="dice-check-large" id="dice-2" onclick="rollZweiteChance(1)" title="Klicken um Zweite Chance zu nutzen">
                                <svg viewBox="0 0 100 100"><path d="m49.355 99.528c-0.24708-0.25657-1.6214-1.7492-3.0541-3.317-2.3047-2.5219-3.516-3.8292-5.2938-5.7131-0.2773-0.29384-1.5251-1.6542-2.773-3.0229-2.3561-2.5844-5.1488-5.6429-7.9097-8.6624-0.88412-0.96693-2.926-3.1848-4.5376-4.9285-1.6116-1.7438-2.9553-3.2374-2.9861-3.3192-0.03234-0.0858 11.461-0.14867 27.183-0.14867 14.982 0 27.24 0.0489 27.24 0.10862 0 0.0597-0.35576 0.49459-0.79058 0.96634-0.43482 0.47174-1.5941 1.7274-2.5761 2.7904-2.0061 2.1714-6.6115 7.1835-16.129 17.553-7.9441 8.6552-7.4759 8.1604-7.7209 8.1604-0.11174 0-0.40531-0.20993-0.65239-0.46651zm-3.7748-13.817c0.39727-2e-3 0.81169-0.3825 3.5099-3.2228 2.3664-2.491 2.4207-2.5693 2.4207-3.4926 0-0.64199-0.08645-0.869-0.47136-1.2378-0.47061-0.45088-0.47552-0.4516-3.1091-0.4516h-2.6377v-0.58029c0-0.77677-0.29798-1.3867-0.73474-1.5039-0.66048-0.17724-2.2232-0.10269-2.5286 0.12063-0.23999 0.1755-0.29005 0.40128-0.24219 1.0925l0.06032 0.87127-0.72189-1e-4c-0.54246-8e-5-0.82442 0.10243-1.1344 0.4124-0.46236 0.46236-0.49288 0.65126-0.22801 1.4111 0.17624 0.50555 0.22516 0.52926 1.0924 0.52926h0.90788l0.0018 2.0587c0.0024 2.6671 0.10714 3.2727 0.62472 3.6118 0.53088 0.34786 1.4868 0.54218 2.2304 0.45344 0.32351-0.0386 0.75546-0.071 0.95989-0.072zm-0.45571-4.4549v-1.597h2.7298l-0.8107 0.96633c-0.44588 0.53148-1.0601 1.2502-1.3649 1.597l-0.55419 0.6307zm12.321 4.2144c0.8131-0.22371 1.6667-0.53017 1.897-0.68103 0.80329-0.52633 0.85761-1.4792 0.12208-2.1415-0.29264-0.26347-0.39883-0.26725-1.2377-0.044-0.50468 0.1343-0.97433 0.24508-1.0437 0.24618-0.06933 1e-3-0.12605-1.54-0.12605-3.4246 0-4.0332-0.0313-4.1238-1.4718-4.2622-0.4742-0.0456-1.1311-0.0324-1.4598 0.0293l-0.59765 0.11213v4.625c0 4.7022 0.05332 5.1523 0.65475 5.5273 0.78945 0.49217 1.5119 0.49514 3.2628 0.0134zm-15.934 10.222c-1.4789-0.86882-3.3696-1.9615-4.2015-2.4283-0.83189-0.46671-2.231-1.269-3.1091-1.783-0.87811-0.5139-2.1638-1.2552-2.857-1.6474-1.1159-0.63127-6.3995-3.7016-7.0585-4.1017-0.16478-0.10005 0.01413-0.12419 0.51658-0.0697 1.0579 0.11473 2.0979-0.40834 2.2576-1.1355 0.18747-0.85356-0.60997-2.1791-2.2134-3.6793-1.6671-1.5597-2.903-2.2412-3.9281-2.1659-0.87311 0.0642-1.0924 0.35849-0.9267 1.2436 0.09952 0.53145 0.40876 0.93983 1.6115 2.1282 0.85734 0.84704 1.3737 1.4705 1.2179 1.4705-0.53059 0-1.7144-0.8545-2.7635-1.9948-1.1112-1.2078-1.7484-1.5858-1.9198-1.139-0.14181 0.36954 0.20176 0.9087 1.326 2.0809l1.0049 1.0478-3.1753-1.8243c-7.5298-4.3261-9.5448-5.5157-9.5908-5.6619-0.0413-0.13126 11.913-5.2904 12.243-5.2835 0.06231 1e-3 2.5958 2.7035 5.63 6.0049 3.0342 3.3014 7.3653 8.0091 9.6247 10.462 2.2594 2.4525 4.8266 5.2532 5.7049 6.2237 0.87829 0.97054 2.0525 2.2373 2.6094 2.815 0.55691 0.57771 0.93912 1.043 0.84935 1.034-0.08977-9e-3-1.3732-0.72718-2.8521-1.596zm-11.008-11.851c0-0.16876-3.1603-3.806-4.474-5.1492-0.56794-0.58069-1.1402-0.69509-1.6419-0.32824-0.27162 0.19861-0.11049 0.43344 1.8161 2.6469 1.1628 1.3359 2.3223 2.5609 2.5767 2.7222 0.51342 0.32542 1.7231 0.40145 1.7231 0.10829zm27.785 10.48c2.7071-2.9298 5.6036-6.0821 16.292-17.73 2.9473-3.212 5.4213-5.84 5.4977-5.84 0.1134 0 3.2765 1.3251 11.923 4.9947l0.57582 0.24439-0.49178 0.29554c-0.50069 0.30087-2.6666 1.5541-7.6343 4.4173-1.5251 0.87902-4.7393 2.7344-7.1425 4.123-2.4032 1.3886-6.5627 3.789-9.2432 5.3342-6.2842 3.6225-7.7929 4.4953-10.283 5.9487-1.1263 0.6575-2.0933 1.1954-2.1488 1.1954s1.1393-1.3424 2.6553-2.983zm15.411-11.055 0.6075-0.5932 1.5614 0.603c1.3194 0.50957 1.6385 0.57613 2.0591 0.42951 0.62617-0.21829 1.4067-0.85993 2.1111-1.7354l0.54619-0.67886v-2.4934c0-2.486-1e-3-2.4942-0.42777-2.7736-0.78128-0.51191-1.4935-0.12225-3.4114 1.8664l-1.6992 1.7619-0.76243-0.1045c-0.74918-0.10269-0.77844-0.0885-1.6843 0.81741-0.50705 0.50706-0.92192 1.0017-0.92192 1.0991 0 0.0975 0.22688 0.25627 0.50418 0.35295 0.61346 0.21385 0.62719 0.3552 0.084 0.86547-0.40713 0.38248-0.53797 0.8345-0.3081 1.0644 0.31743 0.31743 1.1631 0.0838 1.7417-0.48117zm3.5547-2.4184c-0.3991-0.15832-0.70984-0.35845-0.69053-0.44474 0.0193-0.0863 0.3602-0.52851 0.75753-0.98272 0.69095-0.78986 0.72626-0.80816 0.81051-0.42015 0.17368 0.79996 0.18398 2.1705 0.0162 2.153-0.09239-0.01-0.4946-0.14706-0.8937-0.30538zm-53.622 1.7656c-0.59744-0.44078-1.1959-1.1577-1.1959-1.4326 0-0.30204 0.44464-0.38937 0.86918-0.17069 0.67218 0.34622 1.3156 1.0477 1.3156 1.4344 0 0.53897-0.39574 0.60657-0.98891 0.16895zm-17.324-9.1625c-0.11287-0.2109-0.17397-3.1085-0.17397-8.2498v-7.9247l0.50912 0.4284c1.0142 0.85342 2.3042 0.68805 3.5028-0.44905 1.2455-1.1815 1.6707-3.079 1.1375-5.0753-0.51715-1.936-1.3598-2.941-2.4657-2.941-0.51111 0-0.73028 0.11175-1.1446 0.5836-0.49742 0.56653-0.86402 1.4963-0.86593 2.1961-0.0018 0.67533 0.5256 2.3576 0.93316 2.9763 0.38976 0.59168 0.39529 0.63021 0.09039 0.63021-0.58952 0-0.86637-0.20134-1.2417-0.90303l-0.37097-0.69352-0.04109-11.764-0.04109-11.764 6.3853 19.067c3.5119 10.487 6.3853 19.115 6.3853 19.175 0 0.1797-11.598 5.0334-12.027 5.0334-0.22101 0-0.47476-0.14434-0.57149-0.32507zm4.0067-8.3049c0.32316-0.38938 0.2724-1.0265-0.13421-1.6844-0.3788-0.61291-0.38116-0.63946-0.07596-0.85607 0.17323-0.12294 0.9956-0.74527 1.8275-1.3829 1.2903-0.98907 1.5203-1.2395 1.5657-1.7046 0.07311-0.74938-0.44134-2.26-0.7317-2.1485-0.57858 0.22203-4.7593 3.5317-4.9276 3.9008-0.27481 0.60315 0.01779 1.7125 0.75989 2.881 0.33868 0.53331 0.69792 1.0252 0.79831 1.0931 0.28795 0.19479 0.71242 0.14927 0.91801-0.0985zm79.765 7.5155c-1.2016-0.5139-3.6973-1.5786-5.5459-2.366-1.8486-0.78738-3.3839-1.452-3.4117-1.477-0.0278-0.025 2.8281-8.6566 6.3464-19.182l6.397-19.136-0.06 10.84c-0.033 5.9619-0.12851 11.178-0.21227 11.592l-0.15227 0.75199-1.7414-1.6763c-0.95776-0.92197-1.8841-1.7306-2.0584-1.7968-0.38352-0.1458-0.70716 0.29355-0.98047 1.331l-0.18608 0.7063 1.3908 1.3237c0.76496 0.72806 1.9721 1.8471 2.6826 2.4868l1.2917 1.1631 0.0107 7.9147c0.0101 7.4619-7e-3 7.9306-0.29662 8.1928-0.49632 0.44916-1.1594 0.3216-3.474-0.66831zm1.6041-8.3049c1.0338-1.1067 1.5617-3.5073 1.1101-5.0482-0.34817-1.1879-0.9474-1.8341-1.7007-1.8341-0.54457 0-0.58106-0.0398-0.83396-0.90978-0.33762-1.1613-1.0873-1.8581-1.8377-1.708-0.70051 0.1401-1.0076 0.46438-1.5191 1.6042-1.0771 2.4001-0.96085 4.6927 0.2976 5.8683 0.3466 0.32377 0.55376 0.38448 1.0739 0.31473 0.63184-0.0848 0.64862-0.0729 0.85904 0.60719 0.48345 1.5625 1.6513 2.0687 2.5508 1.1057zm-1.2637-2.6725c-0.3569-0.69018-0.32033-1.1206 0.12173-1.4325 0.35419-0.2499 0.39775-0.24277 0.68804 0.11264 0.47659 0.58351 0.18698 1.8-0.43163 1.8131-0.067 1e-3-0.23712-0.22055-0.37814-0.49325zm-2.3094-1.813c-0.42602-0.48504-0.49804-0.99099-0.23178-1.6282 0.29224-0.69943 0.65516-0.76742 1.0314-0.19324 0.6004 0.91632-0.13107 2.5826-0.79959 1.8215zm-65.842 8.4009c9.25e-4-0.16654 1.2582-2.3568 13.868-24.158 1.9246-3.3276 4.2341-7.3358 5.1322-8.9071s1.7738-3.0986 1.946-3.3939c0.17212-0.2953 1.7499-3.0342 3.5061-6.0865 1.7562-3.0523 3.2309-5.5499 3.2771-5.5504 0.04622-5e-4 0.72189 1.1125 1.5015 2.4732 0.77961 1.3607 2.072 3.6084 2.872 4.9949 0.8 1.3865 2.3457 4.0712 3.435 5.9661 1.0892 1.8948 2.2297 3.8611 2.5343 4.3695 0.30461 0.50839 2.9918 5.1594 5.9715 10.336 2.9797 5.1762 6.7672 11.743 8.4165 14.593 1.6494 2.8498 2.9989 5.251 2.9989 5.3359 0 0.0931-10.996 0.15436-27.73 0.15436-15.251 0-27.729-0.0567-27.729-0.12605zm37.606-8.4356c2.4648-1.3188 3.6068-3.7111 3.6144-7.572 0.0045-2.2651-0.29676-3.6156-1.1483-5.1478-0.6781-1.2201-1.4817-1.9684-2.7557-2.5659-0.80918-0.37954-1.1534-0.43714-2.6126-0.43714-1.495 0-1.785 0.0513-2.6258 0.46421-1.0411 0.51129-2.2839 1.7306-2.805 2.7521-0.73197 1.4348-0.94808 2.5596-0.94808 4.9345 0 3.1865 0.50517 4.7607 2.0617 6.4248 1.3064 1.3966 2.4489 1.8284 4.6533 1.7587 1.3454-0.0426 1.6289-0.11012 2.566-0.61148zm-3.9838-3.2286c-0.72061-0.67135-1.0689-1.7672-1.1531-3.6285-0.12287-2.7142 0.44092-4.7874 1.4237-5.2352 1.1673-0.53187 2.1977 0.0116 2.7626 1.4571 0.31808 0.81391 0.37614 1.2867 0.37614 3.0632 0 1.7765-0.05805 2.2493-0.37616 3.0632-0.20689 0.52938-0.57063 1.1155-0.80832 1.3024-0.5968 0.46945-1.7089 0.4583-2.2248-0.0223zm-7.8519 3.3688c0.76638-0.3492 1.0157-1.6194 0.54091-2.7557l-0.2418-0.57869-5.587-0.0922 1.9373-1.6493c2.1184-1.8035 2.7247-2.4823 3.3773-3.7816 1.2918-2.572 0.24707-5.451-2.4002-6.6139-1.7596-0.77292-5.36-0.53586-6.3971 0.4212-1.0543 0.97293-1.1503 2.2908-0.24282 3.3331 0.22626 0.25984 0.32044 0.24441 1.2809-0.20995 2.2631-1.0706 4.5125-0.29409 4.0847 1.4102-0.18523 0.73803-1.1046 1.7742-3.528 3.9764-1.4466 1.3146-2.5495 2.4567-2.7208 2.8177-0.33213 0.69991-0.36926 2.1791-0.06928 2.7601 0.11165 0.2162 0.35798 0.56327 0.5474 0.77125 0.34015 0.37345 0.39804 0.37813 4.6767 0.37813 2.8171 0 4.4756-0.0653 4.7418-0.18659zm-27.525 6.5688c-0.13758-0.37024-8.3083-24.636-11.307-33.58-2.1982-6.5563-2.5743-7.8215-2.3794-8.0036 0.13592-0.12697 1.9313-0.43792 4.3489-0.75321 2.2646-0.29532 4.9115-0.64726 5.8821-0.78208 5.8415-0.81144 30.822-4.0903 30.861-4.0508 0.02619 0.0262-0.27791 0.61163-0.67577 1.301-0.39786 0.68936-1.6153 2.8037-2.7055 4.6986-1.0901 1.8949-2.7 4.693-3.5774 6.2182-0.87745 1.5251-1.7177 2.9778-1.8672 3.2281-0.37435 0.62667-6.1822 10.663-7.6631 13.242-0.66341 1.1554-1.775 3.0839-2.4701 4.2855-0.69517 1.2016-2.7223 4.7182-4.5047 7.8147-4.0974 7.1182-3.8295 6.6845-3.9418 6.3822zm6.3119-25.215c1.5533-0.79245 3.4705-3.2576 4.1865-5.3831 0.45858-1.3613 0.43758-2.8954-0.05144-3.7588-0.81309-1.4355-2.4884-2.0759-3.9872-1.5241-1.1979 0.44108-1.2065 0.43729-1.4233-0.62702-0.31339-1.5388-1.4533-2.5163-2.9344-2.5163-1.0921 0-1.8935 0.39035-3.0329 1.4772-1.7199 1.6405-2.7727 3.7723-2.7754 5.6201-0.0019 1.323 0.38702 2.189 1.3162 2.9302 0.56334 0.4494 0.77734 0.51484 1.6806 0.51389 0.56928-6.7e-4 1.2325-0.0629 1.4739-0.13841 0.42633-0.13342 0.44219-0.11228 0.55521 0.73971 0.06399 0.48237 0.2578 1.1543 0.43068 1.4932 0.28181 0.55239 1.1741 1.3144 1.8524 1.5819 0.48186 0.19003 1.9782-0.0356 2.7091-0.40844zm-1.2994-3.3412c-0.54897-0.23164-1.0737-1.0079-1.0726-1.5869 2e-3-1.1103 0.31406-1.7664 1.0088-2.1208 1.1097-0.56611 2.2445-0.31639 2.6548 0.58422 0.28411 0.62356 0.25096 1.0554-0.14359 1.8704-0.5158 1.0655-1.5893 1.6152-2.4474 1.2531zm-4.8971-3.4612c-0.62581-0.26313-0.88216-0.69558-0.88216-1.4881 0-0.45709 0.14742-0.74715 0.64621-1.2715 0.66086-0.69471 1.0266-0.80174 1.7716-0.51848 0.98922 0.37611 1.2372 2.3857 0.36495 2.9572-0.6811 0.44628-1.3384 0.55724-1.9007 0.32085zm55.728 27.013c-4.2797-7.4421-9.6077-16.68-10.633-18.435-0.48578-0.83188-2.0813-3.5922-3.5456-6.1341-1.4643-2.5419-4.17-7.2307-6.0128-10.42-4.3995-7.6135-4.1825-7.2265-4.052-7.2265 0.06271 0 3.7527 0.48721 8.1999 1.0827 4.4473 0.59547 13.569 1.8106 20.27 2.7004 9.8763 1.3113 12.241 1.6732 12.484 1.9107 0.28709 0.28062 0.17877 0.65513-2.5609 8.8536-1.5734 4.7083-3.2113 9.5816-3.6398 10.829-0.42849 1.2478-2.2501 6.6551-4.0481 12.016-1.7979 5.3611-3.32 9.8-3.3824 9.8643-0.0624 0.0643-1.4483-2.2045-3.08-5.0418zm-0.6831-18.782c0.20596-0.14426 0.48383-0.47375 0.61748-0.73222 0.23687-0.45804 0.21139-0.51585-1.0084-2.2875-0.68827-0.99968-1.2226-1.8464-1.1875-1.8815 0.0352-0.0352 0.77211 0.2368 1.6376 0.60438 2.3724 1.0075 3.8182 1.1734 4.9388 0.56652 0.60712-0.32878 1.2251-1.1247 1.4069-1.812 0.68407-2.586-2.5419-7.8037-4.827-7.8072-0.77149-1e-3-1.5433 0.77246-1.5371 1.5408 4e-3 0.47233 0.1116 0.62433 0.69441 0.97926 0.7699 0.46887 1.8899 1.8608 2.0524 2.5507 0.0986 0.41846-0.21118 0.98219-0.53653 0.9765-0.38385-7e-3-2.112-0.5896-4.1721-1.4072-1.3076-0.51898-2.5946-0.94359-2.86-0.94359-0.76381 0-1.6638 0.71293-1.856 1.4703-0.0906 0.35691-0.10447 0.81181-0.03083 1.0109 0.1587 0.429 4.4627 6.7054 4.8939 7.1365 0.36801 0.36802 1.2732 0.38611 1.7738 0.0355zm-66.841 11.332c-0.18989-0.31146-0.34554-0.75745-0.34588-0.99108-7.48e-4-0.50612 0.4285-1.1718 0.75564-1.1718 0.36936 0 0.75626 0.69198 0.75626 1.3526 0 0.42478-0.12251 0.72064-0.41038 0.99108l-0.41038 0.38553zm6.1237-34.604c6.481-3.7574 12.198-7.0611 21.932-12.674 5.6139-3.2373 7.522-4.3435 10.197-5.9112 0.84788-0.49697 1.6231-0.90359 1.7226-0.90359 0.12692 0 0.181 2.5498 0.181 8.5332v8.5332l-18.781 2.4947c-10.329 1.3721-19.045 2.531-19.369 2.5754-0.42039 0.0577 0.75433-0.69769 4.1174-2.6474zm17.554-2.361c0.46671-0.1001 0.84856-0.25079 0.84856-0.33488 0-0.0841 0.75626-1.7156 1.6806-3.6255 0.92432-1.9099 1.6806-3.6418 1.6806-3.8486 0-0.71758-0.8024-0.65481-2.6991 0.21112-1.1814 0.53938-1.8385 1.1957-1.8385 1.8364 0 0.46471 0.22903 0.4953 1.0719 0.14314 0.3348-0.13989 0.60873-0.22338 0.60873-0.18554 0 0.0378-0.52777 1.1347-1.1728 2.4375-1.2266 2.4773-1.4521 3.0759-1.2699 3.3707 0.13362 0.21621 0.06014 0.2165 1.09-4e-3zm7.1297-1.2433c2.0115-1.0177 4.2078-4.0854 4.4197-6.1731 0.07545-0.74333 0.03038-0.96402-0.27579-1.3507-0.32344-0.40845-0.47861-0.46216-1.3353-0.46216-0.74049 0-1.2072 0.11886-1.977 0.50353-2.2007 1.0997-4.3741 4.1083-4.5499 6.2983-0.07471 0.93071-0.04058 1.0984 0.29119 1.4301 0.53978 0.53978 2.0946 0.42818 3.4271-0.246zm-1.4509-1.4737c-0.21502-0.63193 1.1111-3.3774 2.0145-4.1706 0.76453-0.67127 1.4482-0.63661 1.5297 0.0776 0.07592 0.66519-1.01 2.8208-1.8383 3.649-0.66814 0.66814-1.5514 0.89804-1.7059 0.44401zm31.975 5.2273c-10.306-1.3797-18.833-2.5412-18.949-2.5812-0.16433-0.0568-0.21007-1.9218-0.21007-8.5648 0-5.1598 0.0617-8.4922 0.15724-8.4922 0.08648 0 2.3364 1.2583 4.9997 2.7962 2.6634 1.5379 5.8635 3.3807 7.1113 4.0951 3.0313 1.7356 13.647 7.8684 15.545 8.9805 0.83189 0.48743 3.5922 2.0802 6.1341 3.5396 2.5419 1.4594 4.6531 2.6802 4.6916 2.7129 0.15612 0.13263-1.4784-0.076-19.481-2.486zm0.12998-2.6748c0.02739-0.14224-0.12571-0.51951-0.34023-0.83836-0.37147-0.55214-0.47575-0.59568-2.1906-0.91456-0.99032-0.18414-1.8005-0.37321-1.8003-0.42014 1.65e-4-0.0469 0.34043-0.30021 0.75615-0.56285 1.456-0.91986 1.7099-1.6077 1.0764-2.9163-0.82295-1.7-3.8199-3.2142-6.0343-3.0488-0.67445 0.0504-0.76181 0.1043-0.8075 0.49854-0.03275 0.28256 0.09793 0.61548 0.36216 0.92267 0.38128 0.44326 0.49163 0.47673 1.4203 0.4307 1.1795-0.0585 2.0663 0.25334 2.4691 0.8682 0.37256 0.56859 0.1918 0.87015-1.1721 1.9554-1.3514 1.0753-1.431 1.5086-0.46535 2.5323 0.62072 0.65803 0.67202 0.67671 3.4032 1.239 3.0193 0.62167 3.2489 0.63923 3.3231 0.25419zm-8.0287-1.0942c0-0.053-0.6824-1.6978-1.5164-3.6553-1.6304-3.8264-1.969-4.3228-3.1697-4.6461-0.37368-0.10063-1.0956-0.13107-1.6452-0.0694-1.5473 0.17368-1.7417 0.5029-0.87785 1.4868 0.45977 0.52365 0.61631 0.59405 1.3209 0.59405h0.79929l1.1389 2.6469c0.6264 1.4558 1.2678 2.784 1.4254 2.9516 0.47308 0.50325 2.5247 1.0651 2.5247 0.69137z"/></svg>
                            </div>
                            <div class="dice-check-large" id="dice-3" onclick="rollZweiteChance(2)" title="Klicken um Zweite Chance zu nutzen">
                                <svg viewBox="0 0 100 100"><path d="m49.355 99.528c-0.24708-0.25657-1.6214-1.7492-3.0541-3.317-2.3047-2.5219-3.516-3.8292-5.2938-5.7131-0.2773-0.29384-1.5251-1.6542-2.773-3.0229-2.3561-2.5844-5.1488-5.6429-7.9097-8.6624-0.88412-0.96693-2.926-3.1848-4.5376-4.9285-1.6116-1.7438-2.9553-3.2374-2.9861-3.3192-0.03234-0.0858 11.461-0.14867 27.183-0.14867 14.982 0 27.24 0.0489 27.24 0.10862 0 0.0597-0.35576 0.49459-0.79058 0.96634-0.43482 0.47174-1.5941 1.7274-2.5761 2.7904-2.0061 2.1714-6.6115 7.1835-16.129 17.553-7.9441 8.6552-7.4759 8.1604-7.7209 8.1604-0.11174 0-0.40531-0.20993-0.65239-0.46651zm-3.7748-13.817c0.39727-2e-3 0.81169-0.3825 3.5099-3.2228 2.3664-2.491 2.4207-2.5693 2.4207-3.4926 0-0.64199-0.08645-0.869-0.47136-1.2378-0.47061-0.45088-0.47552-0.4516-3.1091-0.4516h-2.6377v-0.58029c0-0.77677-0.29798-1.3867-0.73474-1.5039-0.66048-0.17724-2.2232-0.10269-2.5286 0.12063-0.23999 0.1755-0.29005 0.40128-0.24219 1.0925l0.06032 0.87127-0.72189-1e-4c-0.54246-8e-5-0.82442 0.10243-1.1344 0.4124-0.46236 0.46236-0.49288 0.65126-0.22801 1.4111 0.17624 0.50555 0.22516 0.52926 1.0924 0.52926h0.90788l0.0018 2.0587c0.0024 2.6671 0.10714 3.2727 0.62472 3.6118 0.53088 0.34786 1.4868 0.54218 2.2304 0.45344 0.32351-0.0386 0.75546-0.071 0.95989-0.072zm-0.45571-4.4549v-1.597h2.7298l-0.8107 0.96633c-0.44588 0.53148-1.0601 1.2502-1.3649 1.597l-0.55419 0.6307zm12.321 4.2144c0.8131-0.22371 1.6667-0.53017 1.897-0.68103 0.80329-0.52633 0.85761-1.4792 0.12208-2.1415-0.29264-0.26347-0.39883-0.26725-1.2377-0.044-0.50468 0.1343-0.97433 0.24508-1.0437 0.24618-0.06933 1e-3-0.12605-1.54-0.12605-3.4246 0-4.0332-0.0313-4.1238-1.4718-4.2622-0.4742-0.0456-1.1311-0.0324-1.4598 0.0293l-0.59765 0.11213v4.625c0 4.7022 0.05332 5.1523 0.65475 5.5273 0.78945 0.49217 1.5119 0.49514 3.2628 0.0134zm-15.934 10.222c-1.4789-0.86882-3.3696-1.9615-4.2015-2.4283-0.83189-0.46671-2.231-1.269-3.1091-1.783-0.87811-0.5139-2.1638-1.2552-2.857-1.6474-1.1159-0.63127-6.3995-3.7016-7.0585-4.1017-0.16478-0.10005 0.01413-0.12419 0.51658-0.0697 1.0579 0.11473 2.0979-0.40834 2.2576-1.1355 0.18747-0.85356-0.60997-2.1791-2.2134-3.6793-1.6671-1.5597-2.903-2.2412-3.9281-2.1659-0.87311 0.0642-1.0924 0.35849-0.9267 1.2436 0.09952 0.53145 0.40876 0.93983 1.6115 2.1282 0.85734 0.84704 1.3737 1.4705 1.2179 1.4705-0.53059 0-1.7144-0.8545-2.7635-1.9948-1.1112-1.2078-1.7484-1.5858-1.9198-1.139-0.14181 0.36954 0.20176 0.9087 1.326 2.0809l1.0049 1.0478-3.1753-1.8243c-7.5298-4.3261-9.5448-5.5157-9.5908-5.6619-0.0413-0.13126 11.913-5.2904 12.243-5.2835 0.06231 1e-3 2.5958 2.7035 5.63 6.0049 3.0342 3.3014 7.3653 8.0091 9.6247 10.462 2.2594 2.4525 4.8266 5.2532 5.7049 6.2237 0.87829 0.97054 2.0525 2.2373 2.6094 2.815 0.55691 0.57771 0.93912 1.043 0.84935 1.034-0.08977-9e-3-1.3732-0.72718-2.8521-1.596zm-11.008-11.851c0-0.16876-3.1603-3.806-4.474-5.1492-0.56794-0.58069-1.1402-0.69509-1.6419-0.32824-0.27162 0.19861-0.11049 0.43344 1.8161 2.6469 1.1628 1.3359 2.3223 2.5609 2.5767 2.7222 0.51342 0.32542 1.7231 0.40145 1.7231 0.10829zm27.785 10.48c2.7071-2.9298 5.6036-6.0821 16.292-17.73 2.9473-3.212 5.4213-5.84 5.4977-5.84 0.1134 0 3.2765 1.3251 11.923 4.9947l0.57582 0.24439-0.49178 0.29554c-0.50069 0.30087-2.6666 1.5541-7.6343 4.4173-1.5251 0.87902-4.7393 2.7344-7.1425 4.123-2.4032 1.3886-6.5627 3.789-9.2432 5.3342-6.2842 3.6225-7.7929 4.4953-10.283 5.9487-1.1263 0.6575-2.0933 1.1954-2.1488 1.1954s1.1393-1.3424 2.6553-2.983zm15.411-11.055 0.6075-0.5932 1.5614 0.603c1.3194 0.50957 1.6385 0.57613 2.0591 0.42951 0.62617-0.21829 1.4067-0.85993 2.1111-1.7354l0.54619-0.67886v-2.4934c0-2.486-1e-3-2.4942-0.42777-2.7736-0.78128-0.51191-1.4935-0.12225-3.4114 1.8664l-1.6992 1.7619-0.76243-0.1045c-0.74918-0.10269-0.77844-0.0885-1.6843 0.81741-0.50705 0.50706-0.92192 1.0017-0.92192 1.0991 0 0.0975 0.22688 0.25627 0.50418 0.35295 0.61346 0.21385 0.62719 0.3552 0.084 0.86547-0.40713 0.38248-0.53797 0.8345-0.3081 1.0644 0.31743 0.31743 1.1631 0.0838 1.7417-0.48117zm3.5547-2.4184c-0.3991-0.15832-0.70984-0.35845-0.69053-0.44474 0.0193-0.0863 0.3602-0.52851 0.75753-0.98272 0.69095-0.78986 0.72626-0.80816 0.81051-0.42015 0.17368 0.79996 0.18398 2.1705 0.0162 2.153-0.09239-0.01-0.4946-0.14706-0.8937-0.30538zm-53.622 1.7656c-0.59744-0.44078-1.1959-1.1577-1.1959-1.4326 0-0.30204 0.44464-0.38937 0.86918-0.17069 0.67218 0.34622 1.3156 1.0477 1.3156 1.4344 0 0.53897-0.39574 0.60657-0.98891 0.16895zm-17.324-9.1625c-0.11287-0.2109-0.17397-3.1085-0.17397-8.2498v-7.9247l0.50912 0.4284c1.0142 0.85342 2.3042 0.68805 3.5028-0.44905 1.2455-1.1815 1.6707-3.079 1.1375-5.0753-0.51715-1.936-1.3598-2.941-2.4657-2.941-0.51111 0-0.73028 0.11175-1.1446 0.5836-0.49742 0.56653-0.86402 1.4963-0.86593 2.1961-0.0018 0.67533 0.5256 2.3576 0.93316 2.9763 0.38976 0.59168 0.39529 0.63021 0.09039 0.63021-0.58952 0-0.86637-0.20134-1.2417-0.90303l-0.37097-0.69352-0.04109-11.764-0.04109-11.764 6.3853 19.067c3.5119 10.487 6.3853 19.115 6.3853 19.175 0 0.1797-11.598 5.0334-12.027 5.0334-0.22101 0-0.47476-0.14434-0.57149-0.32507zm4.0067-8.3049c0.32316-0.38938 0.2724-1.0265-0.13421-1.6844-0.3788-0.61291-0.38116-0.63946-0.07596-0.85607 0.17323-0.12294 0.9956-0.74527 1.8275-1.3829 1.2903-0.98907 1.5203-1.2395 1.5657-1.7046 0.07311-0.74938-0.44134-2.26-0.7317-2.1485-0.57858 0.22203-4.7593 3.5317-4.9276 3.9008-0.27481 0.60315 0.01779 1.7125 0.75989 2.881 0.33868 0.53331 0.69792 1.0252 0.79831 1.0931 0.28795 0.19479 0.71242 0.14927 0.91801-0.0985zm79.765 7.5155c-1.2016-0.5139-3.6973-1.5786-5.5459-2.366-1.8486-0.78738-3.3839-1.452-3.4117-1.477-0.0278-0.025 2.8281-8.6566 6.3464-19.182l6.397-19.136-0.06 10.84c-0.033 5.9619-0.12851 11.178-0.21227 11.592l-0.15227 0.75199-1.7414-1.6763c-0.95776-0.92197-1.8841-1.7306-2.0584-1.7968-0.38352-0.1458-0.70716 0.29355-0.98047 1.331l-0.18608 0.7063 1.3908 1.3237c0.76496 0.72806 1.9721 1.8471 2.6826 2.4868l1.2917 1.1631 0.0107 7.9147c0.0101 7.4619-7e-3 7.9306-0.29662 8.1928-0.49632 0.44916-1.1594 0.3216-3.474-0.66831zm1.6041-8.3049c1.0338-1.1067 1.5617-3.5073 1.1101-5.0482-0.34817-1.1879-0.9474-1.8341-1.7007-1.8341-0.54457 0-0.58106-0.0398-0.83396-0.90978-0.33762-1.1613-1.0873-1.8581-1.8377-1.708-0.70051 0.1401-1.0076 0.46438-1.5191 1.6042-1.0771 2.4001-0.96085 4.6927 0.2976 5.8683 0.3466 0.32377 0.55376 0.38448 1.0739 0.31473 0.63184-0.0848 0.64862-0.0729 0.85904 0.60719 0.48345 1.5625 1.6513 2.0687 2.5508 1.1057zm-1.2637-2.6725c-0.3569-0.69018-0.32033-1.1206 0.12173-1.4325 0.35419-0.2499 0.39775-0.24277 0.68804 0.11264 0.47659 0.58351 0.18698 1.8-0.43163 1.8131-0.067 1e-3-0.23712-0.22055-0.37814-0.49325zm-2.3094-1.813c-0.42602-0.48504-0.49804-0.99099-0.23178-1.6282 0.29224-0.69943 0.65516-0.76742 1.0314-0.19324 0.6004 0.91632-0.13107 2.5826-0.79959 1.8215zm-65.842 8.4009c9.25e-4-0.16654 1.2582-2.3568 13.868-24.158 1.9246-3.3276 4.2341-7.3358 5.1322-8.9071s1.7738-3.0986 1.946-3.3939c0.17212-0.2953 1.7499-3.0342 3.5061-6.0865 1.7562-3.0523 3.2309-5.5499 3.2771-5.5504 0.04622-5e-4 0.72189 1.1125 1.5015 2.4732 0.77961 1.3607 2.072 3.6084 2.872 4.9949 0.8 1.3865 2.3457 4.0712 3.435 5.9661 1.0892 1.8948 2.2297 3.8611 2.5343 4.3695 0.30461 0.50839 2.9918 5.1594 5.9715 10.336 2.9797 5.1762 6.7672 11.743 8.4165 14.593 1.6494 2.8498 2.9989 5.251 2.9989 5.3359 0 0.0931-10.996 0.15436-27.73 0.15436-15.251 0-27.729-0.0567-27.729-0.12605zm37.606-8.4356c2.4648-1.3188 3.6068-3.7111 3.6144-7.572 0.0045-2.2651-0.29676-3.6156-1.1483-5.1478-0.6781-1.2201-1.4817-1.9684-2.7557-2.5659-0.80918-0.37954-1.1534-0.43714-2.6126-0.43714-1.495 0-1.785 0.0513-2.6258 0.46421-1.0411 0.51129-2.2839 1.7306-2.805 2.7521-0.73197 1.4348-0.94808 2.5596-0.94808 4.9345 0 3.1865 0.50517 4.7607 2.0617 6.4248 1.3064 1.3966 2.4489 1.8284 4.6533 1.7587 1.3454-0.0426 1.6289-0.11012 2.566-0.61148zm-3.9838-3.2286c-0.72061-0.67135-1.0689-1.7672-1.1531-3.6285-0.12287-2.7142 0.44092-4.7874 1.4237-5.2352 1.1673-0.53187 2.1977 0.0116 2.7626 1.4571 0.31808 0.81391 0.37614 1.2867 0.37614 3.0632 0 1.7765-0.05805 2.2493-0.37616 3.0632-0.20689 0.52938-0.57063 1.1155-0.80832 1.3024-0.5968 0.46945-1.7089 0.4583-2.2248-0.0223zm-7.8519 3.3688c0.76638-0.3492 1.0157-1.6194 0.54091-2.7557l-0.2418-0.57869-5.587-0.0922 1.9373-1.6493c2.1184-1.8035 2.7247-2.4823 3.3773-3.7816 1.2918-2.572 0.24707-5.451-2.4002-6.6139-1.7596-0.77292-5.36-0.53586-6.3971 0.4212-1.0543 0.97293-1.1503 2.2908-0.24282 3.3331 0.22626 0.25984 0.32044 0.24441 1.2809-0.20995 2.2631-1.0706 4.5125-0.29409 4.0847 1.4102-0.18523 0.73803-1.1046 1.7742-3.528 3.9764-1.4466 1.3146-2.5495 2.4567-2.7208 2.8177-0.33213 0.69991-0.36926 2.1791-0.06928 2.7601 0.11165 0.2162 0.35798 0.56327 0.5474 0.77125 0.34015 0.37345 0.39804 0.37813 4.6767 0.37813 2.8171 0 4.4756-0.0653 4.7418-0.18659zm-27.525 6.5688c-0.13758-0.37024-8.3083-24.636-11.307-33.58-2.1982-6.5563-2.5743-7.8215-2.3794-8.0036 0.13592-0.12697 1.9313-0.43792 4.3489-0.75321 2.2646-0.29532 4.9115-0.64726 5.8821-0.78208 5.8415-0.81144 30.822-4.0903 30.861-4.0508 0.02619 0.0262-0.27791 0.61163-0.67577 1.301-0.39786 0.68936-1.6153 2.8037-2.7055 4.6986-1.0901 1.8949-2.7 4.693-3.5774 6.2182-0.87745 1.5251-1.7177 2.9778-1.8672 3.2281-0.37435 0.62667-6.1822 10.663-7.6631 13.242-0.66341 1.1554-1.775 3.0839-2.4701 4.2855-0.69517 1.2016-2.7223 4.7182-4.5047 7.8147-4.0974 7.1182-3.8295 6.6845-3.9418 6.3822zm6.3119-25.215c1.5533-0.79245 3.4705-3.2576 4.1865-5.3831 0.45858-1.3613 0.43758-2.8954-0.05144-3.7588-0.81309-1.4355-2.4884-2.0759-3.9872-1.5241-1.1979 0.44108-1.2065 0.43729-1.4233-0.62702-0.31339-1.5388-1.4533-2.5163-2.9344-2.5163-1.0921 0-1.8935 0.39035-3.0329 1.4772-1.7199 1.6405-2.7727 3.7723-2.7754 5.6201-0.0019 1.323 0.38702 2.189 1.3162 2.9302 0.56334 0.4494 0.77734 0.51484 1.6806 0.51389 0.56928-6.7e-4 1.2325-0.0629 1.4739-0.13841 0.42633-0.13342 0.44219-0.11228 0.55521 0.73971 0.06399 0.48237 0.2578 1.1543 0.43068 1.4932 0.28181 0.55239 1.1741 1.3144 1.8524 1.5819 0.48186 0.19003 1.9782-0.0356 2.7091-0.40844zm-1.2994-3.3412c-0.54897-0.23164-1.0737-1.0079-1.0726-1.5869 2e-3-1.1103 0.31406-1.7664 1.0088-2.1208 1.1097-0.56611 2.2445-0.31639 2.6548 0.58422 0.28411 0.62356 0.25096 1.0554-0.14359 1.8704-0.5158 1.0655-1.5893 1.6152-2.4474 1.2531zm-4.8971-3.4612c-0.62581-0.26313-0.88216-0.69558-0.88216-1.4881 0-0.45709 0.14742-0.74715 0.64621-1.2715 0.66086-0.69471 1.0266-0.80174 1.7716-0.51848 0.98922 0.37611 1.2372 2.3857 0.36495 2.9572-0.6811 0.44628-1.3384 0.55724-1.9007 0.32085zm55.728 27.013c-4.2797-7.4421-9.6077-16.68-10.633-18.435-0.48578-0.83188-2.0813-3.5922-3.5456-6.1341-1.4643-2.5419-4.17-7.2307-6.0128-10.42-4.3995-7.6135-4.1825-7.2265-4.052-7.2265 0.06271 0 3.7527 0.48721 8.1999 1.0827 4.4473 0.59547 13.569 1.8106 20.27 2.7004 9.8763 1.3113 12.241 1.6732 12.484 1.9107 0.28709 0.28062 0.17877 0.65513-2.5609 8.8536-1.5734 4.7083-3.2113 9.5816-3.6398 10.829-0.42849 1.2478-2.2501 6.6551-4.0481 12.016-1.7979 5.3611-3.32 9.8-3.3824 9.8643-0.0624 0.0643-1.4483-2.2045-3.08-5.0418zm-0.6831-18.782c0.20596-0.14426 0.48383-0.47375 0.61748-0.73222 0.23687-0.45804 0.21139-0.51585-1.0084-2.2875-0.68827-0.99968-1.2226-1.8464-1.1875-1.8815 0.0352-0.0352 0.77211 0.2368 1.6376 0.60438 2.3724 1.0075 3.8182 1.1734 4.9388 0.56652 0.60712-0.32878 1.2251-1.1247 1.4069-1.812 0.68407-2.586-2.5419-7.8037-4.827-7.8072-0.77149-1e-3-1.5433 0.77246-1.5371 1.5408 4e-3 0.47233 0.1116 0.62433 0.69441 0.97926 0.7699 0.46887 1.8899 1.8608 2.0524 2.5507 0.0986 0.41846-0.21118 0.98219-0.53653 0.9765-0.38385-7e-3-2.112-0.5896-4.1721-1.4072-1.3076-0.51898-2.5946-0.94359-2.86-0.94359-0.76381 0-1.6638 0.71293-1.856 1.4703-0.0906 0.35691-0.10447 0.81181-0.03083 1.0109 0.1587 0.429 4.4627 6.7054 4.8939 7.1365 0.36801 0.36802 1.2732 0.38611 1.7738 0.0355zm-66.841 11.332c-0.18989-0.31146-0.34554-0.75745-0.34588-0.99108-7.48e-4-0.50612 0.4285-1.1718 0.75564-1.1718 0.36936 0 0.75626 0.69198 0.75626 1.3526 0 0.42478-0.12251 0.72064-0.41038 0.99108l-0.41038 0.38553zm6.1237-34.604c6.481-3.7574 12.198-7.0611 21.932-12.674 5.6139-3.2373 7.522-4.3435 10.197-5.9112 0.84788-0.49697 1.6231-0.90359 1.7226-0.90359 0.12692 0 0.181 2.5498 0.181 8.5332v8.5332l-18.781 2.4947c-10.329 1.3721-19.045 2.531-19.369 2.5754-0.42039 0.0577 0.75433-0.69769 4.1174-2.6474zm17.554-2.361c0.46671-0.1001 0.84856-0.25079 0.84856-0.33488 0-0.0841 0.75626-1.7156 1.6806-3.6255 0.92432-1.9099 1.6806-3.6418 1.6806-3.8486 0-0.71758-0.8024-0.65481-2.6991 0.21112-1.1814 0.53938-1.8385 1.1957-1.8385 1.8364 0 0.46471 0.22903 0.4953 1.0719 0.14314 0.3348-0.13989 0.60873-0.22338 0.60873-0.18554 0 0.0378-0.52777 1.1347-1.1728 2.4375-1.2266 2.4773-1.4521 3.0759-1.2699 3.3707 0.13362 0.21621 0.06014 0.2165 1.09-4e-3zm7.1297-1.2433c2.0115-1.0177 4.2078-4.0854 4.4197-6.1731 0.07545-0.74333 0.03038-0.96402-0.27579-1.3507-0.32344-0.40845-0.47861-0.46216-1.3353-0.46216-0.74049 0-1.2072 0.11886-1.977 0.50353-2.2007 1.0997-4.3741 4.1083-4.5499 6.2983-0.07471 0.93071-0.04058 1.0984 0.29119 1.4301 0.53978 0.53978 2.0946 0.42818 3.4271-0.246zm-1.4509-1.4737c-0.21502-0.63193 1.1111-3.3774 2.0145-4.1706 0.76453-0.67127 1.4482-0.63661 1.5297 0.0776 0.07592 0.66519-1.01 2.8208-1.8383 3.649-0.66814 0.66814-1.5514 0.89804-1.7059 0.44401zm31.975 5.2273c-10.306-1.3797-18.833-2.5412-18.949-2.5812-0.16433-0.0568-0.21007-1.9218-0.21007-8.5648 0-5.1598 0.0617-8.4922 0.15724-8.4922 0.08648 0 2.3364 1.2583 4.9997 2.7962 2.6634 1.5379 5.8635 3.3807 7.1113 4.0951 3.0313 1.7356 13.647 7.8684 15.545 8.9805 0.83189 0.48743 3.5922 2.0802 6.1341 3.5396 2.5419 1.4594 4.6531 2.6802 4.6916 2.7129 0.15612 0.13263-1.4784-0.076-19.481-2.486zm0.12998-2.6748c0.02739-0.14224-0.12571-0.51951-0.34023-0.83836-0.37147-0.55214-0.47575-0.59568-2.1906-0.91456-0.99032-0.18414-1.8005-0.37321-1.8003-0.42014 1.65e-4-0.0469 0.34043-0.30021 0.75615-0.56285 1.456-0.91986 1.7099-1.6077 1.0764-2.9163-0.82295-1.7-3.8199-3.2142-6.0343-3.0488-0.67445 0.0504-0.76181 0.1043-0.8075 0.49854-0.03275 0.28256 0.09793 0.61548 0.36216 0.92267 0.38128 0.44326 0.49163 0.47673 1.4203 0.4307 1.1795-0.0585 2.0663 0.25334 2.4691 0.8682 0.37256 0.56859 0.1918 0.87015-1.1721 1.9554-1.3514 1.0753-1.431 1.5086-0.46535 2.5323 0.62072 0.65803 0.67202 0.67671 3.4032 1.239 3.0193 0.62167 3.2489 0.63923 3.3231 0.25419zm-8.0287-1.0942c0-0.053-0.6824-1.6978-1.5164-3.6553-1.6304-3.8264-1.969-4.3228-3.1697-4.6461-0.37368-0.10063-1.0956-0.13107-1.6452-0.0694-1.5473 0.17368-1.7417 0.5029-0.87785 1.4868 0.45977 0.52365 0.61631 0.59405 1.3209 0.59405h0.79929l1.1389 2.6469c0.6264 1.4558 1.2678 2.784 1.4254 2.9516 0.47308 0.50325 2.5247 1.0651 2.5247 0.69137z"/></svg>
                            </div>
                        </div>
                        <div class="status-info-box" style="margin-top: var(--gap-sm);">
                            <div class="status-info-row">
                                <span class="status-info-icon" style="color: var(--text-muted);">●</span>
                                <span class="status-info-text">Wenn du eine Probe verfehlst, darfst du einen W20 werfen</span>
                            </div>
                            <div class="status-info-row">
                                <span class="status-info-icon" style="color: var(--accent-primary);">●</span>
                                <span class="status-info-text">1–5 = Der Fehlschlag bleibt bestehen</span>
                            </div>
                            <div class="status-info-row">
                                <span class="status-info-icon" style="color: var(--color-green);">●</span>
                                <span class="status-info-text">6–20 = Du darfst die ursprüngliche Probe einmal wiederholen</span>
                            </div>
                            <div class="status-info-row">
                                <span class="status-info-icon" style="color: var(--text-muted);">●</span>
                                <span class="status-info-text" style="font-style: italic;">Nur unmittelbar nach dem Fehlschlag einsetzbar</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- WÄHRUNG & WAFFE -->
                <div class="card">
                    <div class="card-header">
                        <span class="card-title"><span class="card-title-icon">paid</span> Währung & Waffe</span>
                    </div>
                    <div class="card-body side-card">
                        <div class="currency-row-inline">
                            <span class="currency-label">Währung</span>
                            <img src="../../assets/icons/icon_dollar.png" alt="Currency" class="currency-icon" id="currency-icon" onclick="rotateCurrency()">
                            <input type="text" class="currency-input-inline" id="char-currency" placeholder="0" oninput="formatCurrency(this)">
                        </div>
                        <div class="currency-row-inline">
                            <span class="currency-label">Waffe</span>
                            <span class="card-title-icon weapon-icon">swords</span>
                            <input type="text" class="currency-input-inline weapon-input" id="char-weapon" placeholder="z.B. Schwert, Pistole...">
                        </div>
                    </div>
                </div>
            </div>

            <!-- INVENTAR & NOTIZEN - Full Width -->
            <div class="card">
                <div class="card-header">
                    <span class="card-title"><span class="card-title-icon">backpack</span> Inventar & Notizen</span>
                </div>
                <div class="card-body">
                    <div class="text-areas-row">
                        <textarea class="inventory-textarea" id="char-inventory" placeholder="Inventar..."></textarea>
                        <textarea class="notes-textarea" id="char-notes" placeholder="Notizen..."></textarea>
                    </div>
                    <div class="action-buttons">
                        <button class="action-btn primary" id="mainCharBtn" onclick="toggleMainCharacter()">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/>
                            </svg>
                            <span id="mainCharBtnText">Hauptcharakter</span>
                        </button>
                        <button class="action-btn" onclick="document.getElementById('import-file').click()">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                                <polyline points="17 8 12 3 7 8"/>
                                <line x1="12" y1="3" x2="12" y2="15"/>
                            </svg>
                            Importieren
                        </button>
                        <button class="action-btn" onclick="exportCharacter()">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                                <polyline points="7 10 12 15 17 10"/>
                                <line x1="12" y1="15" x2="12" y2="3"/>
                            </svg>
                            Exportieren
                        </button>
                        <button class="action-btn danger" onclick="resetCharacter()">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <polyline points="3 6 5 6 21 6"/>
                                <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/>
                            </svg>
                            Reset
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- WÜRFEL-VERLAUF -->
            <div class="card">
                <div class="card-header">
                    <span class="card-title"><span class="card-title-icon">casino</span> Würfel-Verlauf</span>
                    <button class="card-action-btn" onclick="clearDiceHistory()" title="Verlauf löschen">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M3 6h18"/>
                            <path d="M8 6V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/>
                            <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6"/>
                            <path d="M10 11v6"/>
                            <path d="M14 11v6"/>
                        </svg>
                    </button>
                </div>
                <div class="card-body">
                    <div class="dice-history-list" id="dice-history-list">
                        <div class="dice-history-empty">Noch keine Würfe in dieser Session</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Fokus Popup -->
    <div class="popup-overlay" id="fokus-popup">
        <div class="popup">
            <div class="popup-header">
                <span class="popup-title" id="fokus-popup-title">Fokus w&auml;hlen</span>
                <button class="popup-close" onclick="closeFokusPopup()">&times;</button>
            </div>
            <div class="popup-body">
                <!-- Step 1: Category Selection -->
                <div class="fokus-step active" id="fokus-step-1">
                    <div class="fokus-categories">
                        <div class="fokus-cat-card" data-cat="element" onclick="selectFokusCategory('element')">
                            <div class="fokus-cat-icon">
                                <span class="material-symbols-rounded">bolt</span>
                            </div>
                            <div class="fokus-cat-name">Element</div>
                            <div class="fokus-cat-desc">Naturgewalten als Waffe &mdash; Feuer, Eis, Blitz, Schatten und mehr</div>
                            <div class="fokus-cat-count" id="fokus-cat-count-element">11 Stile</div>
                        </div>
                        <div class="fokus-cat-card" data-cat="weapon" onclick="selectFokusCategory('weapon')">
                            <div class="fokus-cat-icon">
                                <span class="material-symbols-rounded">swords</span>
                            </div>
                            <div class="fokus-cat-name">Waffen-Spezialist</div>
                            <div class="fokus-cat-desc">Meister der physischen Kriegsf&uuml;hrung &mdash; Schwert, Bogen, Schild</div>
                            <div class="fokus-cat-count" id="fokus-cat-count-weapon">10 Stile</div>
                        </div>
                        <div class="fokus-cat-card" data-cat="support" onclick="selectFokusCategory('support')">
                            <div class="fokus-cat-icon">
                                <span class="material-symbols-rounded">group</span>
                            </div>
                            <div class="fokus-cat-name">Support</div>
                            <div class="fokus-cat-desc">Verst&auml;rkung, Heilung und Kontrolle &mdash; Heiler, Barde, Taktiker</div>
                            <div class="fokus-cat-count" id="fokus-cat-count-support">10 Stile</div>
                        </div>
                    </div>
                    <button class="fokus-no-focus-btn" onclick="selectFokusNone()">
                        <span class="material-symbols-rounded">block</span>
                        Ohne Fokus spielen
                    </button>
                </div>

                <!-- Step 2: Style + Ability Selection -->
                <div class="fokus-step" id="fokus-step-2">
                    <button class="fokus-back-btn" onclick="goFokusStep1()">
                        <span class="material-symbols-rounded">arrow_back</span>
                        Zur&uuml;ck
                    </button>
                    <div class="fokus-style-tabs" id="fokus-style-tabs"></div>
                    <div id="fokus-style-info-bar"></div>
                    <div id="fokus-abilities-container"></div>
                </div>
            </div>
            <div class="popup-footer">
                <span class="popup-info" id="fokus-selection-info">W&auml;hle eine Kategorie</span>
                <button class="popup-btn popup-btn-primary" id="fokus-confirm-btn" onclick="confirmFokusSelection()" disabled>Best&auml;tigen</button>
            </div>
        </div>
    </div>

    <!-- Schwäche Popup -->
    <div class="popup-overlay" id="schwaeche-popup">
        <div class="popup">
            <div class="popup-header">
                <span class="popup-title">Schwäche wählen</span>
                <button class="popup-close" onclick="closeSchwaechePopup()">×</button>
            </div>
            <div class="popup-body">
                <div class="schwaeche-grid" id="schwaeche-grid"></div>
            </div>
            <div class="popup-footer">
                <button class="popup-btn" onclick="clearSchwaeche()">Keine Schwäche</button>
                <button class="popup-btn popup-btn-primary" id="schwaeche-confirm-btn" onclick="confirmSchwaecheSelection()">Bestätigen</button>
            </div>
        </div>
    </div>

    <!-- Skill Catalog Popup -->
    <div class="popup-overlay" id="skill-catalog-popup">
        <div class="popup popup-wide">
            <div class="popup-header">
                <span class="popup-title">Fähigkeiten-Katalog</span>
                <button class="popup-close" onclick="closeSkillCatalog()">×</button>
            </div>
            <div class="popup-body">
                <div class="catalog-grid" id="catalog-grid"></div>
            </div>
        </div>
    </div>

    <!-- Hidden Inputs -->
    <input type="file" id="portrait-upload" class="hidden-input" accept="image/*" onchange="uploadPortrait(event)">
    <input type="file" id="jolly-upload" class="hidden-input" accept="image/*" onchange="uploadJolly(event)">
    <input type="file" id="import-file" class="hidden-input" accept=".json" onchange="importCharacter(event)">

    <!-- Save Indicator -->
    <div class="save-indicator" id="save-indicator">
        <svg viewBox="0 0 24 24" fill="currentColor"><path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/></svg>
        Gespeichert
    </div>

    <script>
        'use strict';
        
        // ===== AUTH & NAVIGATION =====
        if (typeof requireAuth === 'function') {
            requireAuth();
        }
        
        // Initialize RIFT Layout (TopNav, MegaNav, Dock, Footer)
        document.addEventListener('DOMContentLoaded', function() {
            if (typeof initUnifiedLayout === 'function') {
                initUnifiedLayout();
            }
        });

        // ===== BACKGROUND IMAGE =====
        const bgNumber = String(Math.floor(Math.random() * 11) + 1).padStart(3, '0');
        document.getElementById('bgContainer').style.backgroundImage = `url('../../assets/bg/bg_${bgNumber}.webp')`;

        // ===== GM FLY BUTTON VISIBILITY =====
        function updateGMButtonVisibility() {
            const gmBtn = document.getElementById('gmFlyBtn');
            
            // STRICT GM CHECK - Spieler dürfen NIEMALS den GM Button sehen
            let isGM = false;
            try {
                let user = typeof getCurrentUser === 'function' ? getCurrentUser() : null;
                if (!user) {
                    const userData = localStorage.getItem('pnp_companion_user');
                    if (userData) {
                        user = JSON.parse(userData);
                    }
                }
                // Strict boolean check
                isGM = user?.isGM === true || user?.isGM === 'true';
            } catch(e) {
                isGM = false; // Bei Fehler: NIEMALS anzeigen
            }
            
            // Show/hide GM button
            if (gmBtn) {
                gmBtn.style.display = isGM ? 'flex' : 'none';
            }
            
            // Add/remove gm-mode class on body for GM-only elements
            if (isGM) {
                document.body.classList.add('gm-mode');
            } else {
                document.body.classList.remove('gm-mode');
            }
        }
        
        // Check on load and with small delay (auth might load async)
        document.addEventListener('DOMContentLoaded', () => {
            updateGMButtonVisibility();
            setTimeout(updateGMButtonVisibility, 500);
            setTimeout(updateGMButtonVisibility, 1500);
        });
        
        // Also check when auth changes
        if (typeof window !== 'undefined') {
            window.addEventListener('authStateChanged', updateGMButtonVisibility);
        }

        // ===== CONSTANTS =====
        const STORAGE_KEY = 'worldsapart_character_v5';
        const ATTR_TOTAL = 15;
        const SKILL_TOTAL = 500;
        
        // Skill Catalog with example skills
        const SKILL_CATALOG = {
            handeln: [
                // Athletik & Bewegung
                'Klettern', 'Akrobatik', 'Schwimmen', 'Tauchen', 'Springen', 'Balance', 'Ausdauer', 'Sprinten',
                // Kraft & Körper
                'Kraft', 'Ringen', 'Festhalten', 'Einschüchtern',
                // Kampf
                'Nahkampf', 'Fernkampf', 'Waffenhandhabung', 'Ausweichen', 'Blocken', 'Entwaffnen', 'Werfen', 'Improvisierte Waffen',
                // Heimlichkeit
                'Schleichen', 'Verbergen', 'Taschendiebstahl', 'Spuren verwischen', 'Verstecken',
                // Handwerk & Technik
                'Handwerk', 'Mechanik', 'Reparieren', 'Schlösser öffnen', 'Sabotage', 'Feinarbeit', 'Knoten binden', 'Fesseln', 'Entfesseln',
                // Seefahrt
                'Segeln', 'Steuern', 'Rudern', 'Takelage', 'Ankern',
                // Überleben & Wildnis
                'Überleben', 'Jagen', 'Fischen', 'Fallen stellen', 'Feuer machen', 'Spurenlesen', 'Entern',
                // Fortbewegung
                'Reiten', 'Fahren', 'Kutschieren'
            ],
            wissen: [
                // Akademisch & Allgemein
                'Sprachen', 'Geschichte', 'Geographie', 'Philosophie', 'Literatur', 'Mathematik',
                // Naturwissenschaften
                'Naturkunde', 'Chemie', 'Physik',
                // Medizin
                'Heilkunde', 'Erste Hilfe', 'Gifte & Gegenmittel', 'Krankheiten',
                // Navigation & Seefahrt
                'Navigation', 'Astronomie', 'Wetterkunde', 'Kartographie', 'Seefahrt', 'Schiffsbau', 'Gezeitenkunde',
                // Gesellschaft & Recht
                'Politik', 'Recht', 'Religion', 'Mythologie', 'Ehrenkodex', 'Etikette', 'Adelshäuser',
                // Handel & Wirtschaft
                'Handel', 'Schätze bewerten', 'Fälschungen erkennen', 'Schmuggelrouten',
                // Kriegswesen
                'Kriegsführung', 'Belagerung', 'Festungsbau', 'Waffenkunde',
                // Handwerk-Wissen
                'Architektur', 'Metallurgie', 'Bergbau',
                // Spezialwissen
                'Kryptographie', 'Menschenkenntnis', 'Gerüchte & Legenden', 'Hafenstädte', 'Unterwelt', 'Okkultismus',
                'Kunst', 'Musik', 'Glücksspiel', 'Alkoholkunde'
            ],
            soziales: [
                // Überzeugung & Rhetorik
                'Überzeugen', 'Verhandeln', 'Schmeicheln', 'Feilschen', 'Reden halten', 'Auftreten',
                // Führung & Autorität
                'Anführen', 'Motivieren', 'Befehlen', 'Kapitänsautorität', 'Crew zusammenhalten', 'Meuterei anzetteln',
                // Täuschung & Manipulation
                'Lügen', 'Täuschen', 'Bluffen', 'Manipulieren', 'Irreführen', 'Falsche Identität',
                // Einschüchterung & Druck
                'Drohen', 'Provozieren', 'Verhören', 'Foltern', 'Verunsichern',
                // Empathie & Diplomatie
                'Beruhigen', 'Trösten', 'Empathie', 'Schlichten', 'Vermitteln',
                // Soziale Interaktion
                'Flirten', 'Spotten', 'Beleidigen', 'Bestechen', 'Netzwerken', 'Gerüchte verbreiten',
                // Unterhaltung & Kultur
                'Seemannsgarn', 'Shanties singen', 'Geschichten erzählen', 'Witze erzählen', 'Trinkgelage',
                // Informationsbeschaffung
                'Aushorchen', 'Abhören', 'Informanten führen', 'Geheimnisse entlocken',
                // Gruppeninteraktion
                'Vertrauen gewinnen', 'Respekt verschaffen', 'Loyalität sichern'
            ]
        };
        const ATTRIBUTES = ['power', 'agility', 'endurance', 'mind', 'presence'];
        const CURRENCY_TYPES = ['dollar', 'euro', 'yen', 'berry'];
        
        // Rang (Machtstufen-System): HP = 100 + Rang-Modifikator + (ZÄH × 5)
        const RANG_MODIFIERS = {
            lesser:  -50,  // 50 HP
            common:    0,  // 100 HP
            elite:    50,  // 150 HP
            paragon: 100,  // 200 HP
            apex:    200   // 300 HP
        };
        
        function getMaxHealth() {
            const rang = characterData.rang || 'common';
            const mod = RANG_MODIFIERS[rang];
            const zaeh = characterData.attributes.endurance || 0;
            return (mod !== undefined ? 100 + mod : 100) + (zaeh * 5);
        }
        
        const CLASS_ATTRIBUTE_MAP = {
            handeln: ['power', 'agility'],
            wissen: ['mind', 'endurance'],
            soziales: ['presence', 'mind']
        };
        
        // ===== FOKUS DESCRIPTION LOADER =====
        let _fokusDescCache = null;
        let _fokusDescLoading = false;
        
        async function loadFokusDescriptions() {
            if (_fokusDescCache) return _fokusDescCache;
            if (_fokusDescLoading) {
                // Wait for ongoing load
                return new Promise(resolve => {
                    const check = setInterval(() => {
                        if (_fokusDescCache) { clearInterval(check); resolve(_fokusDescCache); }
                    }, 50);
                });
            }
            _fokusDescLoading = true;
            try {
                const res = await fetch('../../assets/js/fokus-descriptions.json');
                if (res.ok) {
                    _fokusDescCache = await res.json();
                    console.log('[WA-Sheet] Fokus descriptions loaded');
                } else {
                    _fokusDescCache = {};
                }
            } catch(e) {
                console.warn('[WA-Sheet] Could not load fokus descriptions:', e);
                _fokusDescCache = {};
            }
            _fokusDescLoading = false;
            return _fokusDescCache;
        }
        
        function getFokusDesc(fokusType, abilityName) {
            if (!_fokusDescCache || !_fokusDescCache[fokusType]) return null;
            const style = _fokusDescCache[fokusType];
            // Descriptions are nested under attacks/defenses
            if (style.attacks && style.attacks[abilityName]) return style.attacks[abilityName];
            if (style.defenses && style.defenses[abilityName]) return style.defenses[abilityName];
            // Fallback: direct lookup (legacy flat format)
            return style[abilityName] || null;
        }
        
        function buildDescTooltipHtml(desc) {
            if (!desc) return '';
            let html = '';
            if (desc.detail) {
                html += `<div class="tt-section"><div class="tt-section-label"><span class="material-symbols-rounded">menu_book</span>Mechanik</div><div class="tt-section-text">${desc.detail}</div></div>`;
            }
            if (desc.battlemap) {
                html += `<div class="tt-section"><div class="tt-section-label"><span class="material-symbols-rounded">grid_on</span>Battlemap</div><div class="tt-section-text">${desc.battlemap}</div></div>`;
            }
            if (desc.gm) {
                html += `<div class="tt-section tt-section-gm"><div class="tt-section-label"><span class="material-symbols-rounded">shield_person</span>GM-Hinweis</div><div class="tt-section-text">${desc.gm}</div></div>`;
            }
            return html;
        }

        const FOKUS_DATA = {
            "fire": {
                        "name": "Feuer",
                        "icon": "icon_focus_fire.png",
                        "mainAttr": "KRF",
                        "color": "#ff6b35",
                        "attacks": [
                                    {
                                                "name": "Explosionsschlag",
                                                "attr": "KRF",
                                                "dice": "d12",
                                                "range": "1",
                                                "status": "Brennend ≥13",
                                                "desc": "Faust-Detonation im Nahkampf"
                                    },
                                    {
                                                "name": "Flammenstrahl",
                                                "attr": "KRF",
                                                "dice": "d8",
                                                "range": "4",
                                                "status": "",
                                                "desc": "Präziser gerichteter Feuerstrahl"
                                    },
                                    {
                                                "name": "Feuerball",
                                                "attr": "KRF",
                                                "dice": "d10",
                                                "range": "8",
                                                "status": "Brennend ≥12",
                                                "desc": "Klassisches Fernkampf-Projektil"
                                    },
                                    {
                                                "name": "Feuerregen",
                                                "attr": "KRF",
                                                "dice": "d8",
                                                "range": "12",
                                                "status": "Brennend ≥10",
                                                "desc": "Taktischer Flächenangriff von oben"
                                    },
                                    {
                                                "name": "Hitzewelle",
                                                "attr": "KRF",
                                                "dice": "d10",
                                                "range": "2",
                                                "status": "Verlangsamt ≥10",
                                                "desc": "Ausdauernde Nahbereichs-Druckwelle"
                                    },
                                    {
                                                "name": "Flammenlanze",
                                                "attr": "KRF",
                                                "dice": "d12",
                                                "range": "8",
                                                "status": "Brennend ≥13",
                                                "desc": "Gebündelter Durchschlag auf Distanz"
                                    },
                                    {
                                                "name": "Lavaausbruch",
                                                "attr": "KRF",
                                                "dice": "d10",
                                                "range": "4",
                                                "status": "Brennend ≥12",
                                                "desc": "Bodeneruption, braucht Standfestigkeit"
                                    },
                                    {
                                                "name": "Feuerwirbel",
                                                "attr": "KRF",
                                                "dice": "d10",
                                                "range": "2",
                                                "status": "",
                                                "desc": "Schneller Spin-Angriff um dich herum"
                                    },
                                    {
                                                "name": "Selbstentzündung",
                                                "attr": "KRF",
                                                "dice": "d20",
                                                "range": "1",
                                                "status": "Brennend ≥10",
                                                "desc": "Eigener Körper explodiert. Riskant."
                                    },
                                    {
                                                "name": "Brandmarke",
                                                "attr": "KRF",
                                                "dice": "d8",
                                                "range": "4",
                                                "status": "Markiert ≥10",
                                                "desc": "Willenskraft-Zeichen, markiert Ziel"
                                    }
                        ],
                        "defenses": [
                                    {
                                                "name": "Flammenhülle",
                                                "attr": "KRF",
                                                "dice": "d10",
                                                "range": "1",
                                                "status": "Brennend ≥12",
                                                "desc": "Feuermantel um den eigenen Körper"
                                    },
                                    {
                                                "name": "Hitzeschild",
                                                "attr": "KRF",
                                                "dice": "d10",
                                                "range": "1",
                                                "status": "",
                                                "desc": "Physische Barriere aus verdichteter Hitze"
                                    },
                                    {
                                                "name": "Explosionsstoß",
                                                "attr": "KRF",
                                                "dice": "d8",
                                                "range": "2",
                                                "status": "",
                                                "desc": "Rückstoß-Detonation gegen Nahkämpfer"
                                    },
                                    {
                                                "name": "Feuerwand",
                                                "attr": "KRF",
                                                "dice": "d8",
                                                "range": "4",
                                                "status": "Brennend ≥10",
                                                "desc": "Taktisch platzierte Flammenwand"
                                    },
                                    {
                                                "name": "Aschevorhang",
                                                "attr": "KRF",
                                                "dice": "d6",
                                                "range": "4",
                                                "status": "Geblendet ≥8",
                                                "desc": "Schnelle Sichtblockade aus Asche"
                                    },
                                    {
                                                "name": "Hitzeresistenz",
                                                "attr": "KRF",
                                                "dice": "d8",
                                                "range": "1",
                                                "status": "",
                                                "desc": "Hitze absorbieren, DR erhöhen"
                                    },
                                    {
                                                "name": "Feuerabsorption",
                                                "attr": "KRF",
                                                "dice": "d8",
                                                "range": "1",
                                                "status": "",
                                                "desc": "Feuer-Angriffe analysieren und umleiten"
                                    },
                                    {
                                                "name": "Flammenausbruch",
                                                "attr": "KRF",
                                                "dice": "d12",
                                                "range": "2",
                                                "status": "",
                                                "desc": "Reaktiver Gegenangriff bei Treffer"
                                    },
                                    {
                                                "name": "Bodenverkohlung",
                                                "attr": "KRF",
                                                "dice": "d6",
                                                "range": "4",
                                                "status": "Verlangsamt ≥8",
                                                "desc": "Boden verbrennen, Terrain verändern"
                                    },
                                    {
                                                "name": "Notzündung",
                                                "attr": "KRF",
                                                "dice": "d6",
                                                "range": "1",
                                                "status": "",
                                                "desc": "Panik-Explosion. Letzter Ausweg."
                                    }
                        ]
            },
            "lightning": {
                        "name": "Blitz",
                        "icon": "icon_focus_lightning.png",
                        "mainAttr": "KRF",
                        "color": "#ffd93d",
                        "attacks": [
                                    {
                                                "name": "Blitzschlag",
                                                "attr": "KRF",
                                                "dice": "d12",
                                                "range": "4",
                                                "status": "Betäubt ≥13",
                                                "desc": "Verheerender Einschlag"
                                    },
                                    {
                                                "name": "Kettenblitz",
                                                "attr": "KRF",
                                                "dice": "d8",
                                                "range": "8",
                                                "status": "",
                                                "desc": "Springt zwischen bis zu 3 Zielen"
                                    },
                                    {
                                                "name": "Elektroschock",
                                                "attr": "KRF",
                                                "dice": "d10",
                                                "range": "1",
                                                "status": "Betäubt ≥12",
                                                "desc": "Touch-Angriff, direkter Stromschlag"
                                    },
                                    {
                                                "name": "Energiehieb",
                                                "attr": "KRF",
                                                "dice": "d10",
                                                "range": "2",
                                                "status": "",
                                                "desc": "Blitzschneller elektrischer Nahkampfschlag"
                                    },
                                    {
                                                "name": "Überladung",
                                                "attr": "KRF",
                                                "dice": "d20",
                                                "range": "2",
                                                "status": "Betäubt ≥14",
                                                "desc": "Körper überladen. Massiv, riskant."
                                    },
                                    {
                                                "name": "Blitzzone",
                                                "attr": "KRF",
                                                "dice": "d8",
                                                "range": "8",
                                                "status": "Verlangsamt ≥10",
                                                "desc": "Elektrifiziertes Gebiet markieren"
                                    },
                                    {
                                                "name": "Impulsstoß",
                                                "attr": "KRF",
                                                "dice": "d8",
                                                "range": "4",
                                                "status": "",
                                                "desc": "Kurzer, harter Energiestoß"
                                    },
                                    {
                                                "name": "Nervenstörung",
                                                "attr": "KRF",
                                                "dice": "d8",
                                                "range": "4",
                                                "status": "Verwirrt ≥10",
                                                "desc": "Elektrische Impulse stören Motorik"
                                    },
                                    {
                                                "name": "Entladungswelle",
                                                "attr": "KRF",
                                                "dice": "d10",
                                                "range": "8",
                                                "status": "",
                                                "desc": "Breite Energiewelle auf Distanz"
                                    },
                                    {
                                                "name": "Präzisionsblitz",
                                                "attr": "KRF",
                                                "dice": "d8",
                                                "range": "12",
                                                "status": "Markiert ≥10",
                                                "desc": "Chirurgisch genauer Fernblitz"
                                    }
                        ],
                        "defenses": [
                                    {
                                                "name": "Blitztempo",
                                                "attr": "KRF",
                                                "dice": "d8",
                                                "range": "1",
                                                "status": "",
                                                "desc": "Blitzschnelles Ausweichen"
                                    },
                                    {
                                                "name": "Energiehülle",
                                                "attr": "KRF",
                                                "dice": "d10",
                                                "range": "1",
                                                "status": "Betäubt ≥12",
                                                "desc": "Elektrisches Schutzfeld am Körper"
                                    },
                                    {
                                                "name": "Reizunterdrückung",
                                                "attr": "KRF",
                                                "dice": "d6",
                                                "range": "1",
                                                "status": "",
                                                "desc": "Schmerz elektrisch unterdrücken"
                                    },
                                    {
                                                "name": "Stromableitung",
                                                "attr": "KRF",
                                                "dice": "d8",
                                                "range": "1",
                                                "status": "",
                                                "desc": "Eingehende Energie ableiten und erden"
                                    },
                                    {
                                                "name": "Kurzteleport",
                                                "attr": "KRF",
                                                "dice": "d6",
                                                "range": "4",
                                                "status": "",
                                                "desc": "Blitzschneller Positionswechsel"
                                    },
                                    {
                                                "name": "Reaktionsboost",
                                                "attr": "KRF",
                                                "dice": "d8",
                                                "range": "1",
                                                "status": "",
                                                "desc": "Reflexe elektrisch beschleunigen"
                                    },
                                    {
                                                "name": "Energieschild",
                                                "attr": "KRF",
                                                "dice": "d10",
                                                "range": "2",
                                                "status": "",
                                                "desc": "Hartes Energiefeld als Blockade"
                                    },
                                    {
                                                "name": "Überladungsstoß",
                                                "attr": "KRF",
                                                "dice": "d12",
                                                "range": "2",
                                                "status": "",
                                                "desc": "Reaktiver Gegenstoß bei Nahkampftreffer"
                                    },
                                    {
                                                "name": "Nervenschild",
                                                "attr": "KRF",
                                                "dice": "d6",
                                                "range": "1",
                                                "status": "",
                                                "desc": "Mentale Abschirmung gegen Status"
                                    },
                                    {
                                                "name": "Energieabsorption",
                                                "attr": "KRF",
                                                "dice": "d8",
                                                "range": "1",
                                                "status": "",
                                                "desc": "Eingehende Energie aufnehmen"
                                    }
                        ]
            },
            "water": {
                        "name": "Wasser",
                        "icon": "icon_focus_water.png",
                        "mainAttr": "GES",
                        "color": "#4dabf7",
                        "attacks": [
                                    {
                                                "name": "Wasserstrahl",
                                                "attr": "GES",
                                                "dice": "d8",
                                                "range": "8",
                                                "status": "",
                                                "desc": "Präziser Hochdruckstrahl"
                                    },
                                    {
                                                "name": "Wasserpeitsche",
                                                "attr": "GES",
                                                "dice": "d10",
                                                "range": "4",
                                                "status": "",
                                                "desc": "Flexible Wasserklinge"
                                    },
                                    {
                                                "name": "Eislanze",
                                                "attr": "GES",
                                                "dice": "d12",
                                                "range": "8",
                                                "status": "Blutend ≥14",
                                                "desc": "Massive Eisnadel, durchschlagend"
                                    },
                                    {
                                                "name": "Eisfläche",
                                                "attr": "GES",
                                                "dice": "d8",
                                                "range": "4",
                                                "status": "Verlangsamt ≥10",
                                                "desc": "Boden einfrieren, Terrain-Kontrolle"
                                    },
                                    {
                                                "name": "Druckstoß",
                                                "attr": "GES",
                                                "dice": "d10",
                                                "range": "2",
                                                "status": "",
                                                "desc": "Komprimierte Wassermasse als Ramme"
                                    },
                                    {
                                                "name": "Wassergefängnis",
                                                "attr": "GES",
                                                "dice": "d8",
                                                "range": "4",
                                                "status": "Verlangsamt ≥10",
                                                "desc": "Ziel in Wassersphäre einschließen"
                                    },
                                    {
                                                "name": "Froststoß",
                                                "attr": "GES",
                                                "dice": "d10",
                                                "range": "2",
                                                "status": "Verlangsamt ≥12",
                                                "desc": "Schockfrost im Nahbereich"
                                    },
                                    {
                                                "name": "Flutwelle",
                                                "attr": "GES",
                                                "dice": "d10",
                                                "range": "8",
                                                "status": "Verlangsamt ≥10",
                                                "desc": "Massive Wasserwand vorwärts"
                                    },
                                    {
                                                "name": "Nebelstoß",
                                                "attr": "GES",
                                                "dice": "d8",
                                                "range": "4",
                                                "status": "Geblendet ≥10",
                                                "desc": "Dichter Nebel blendet und verwirrt"
                                    },
                                    {
                                                "name": "Eissplitter",
                                                "attr": "GES",
                                                "dice": "d8",
                                                "range": "12",
                                                "status": "Blutend ≥10",
                                                "desc": "Hagel aus scharfen Eiskristallen"
                                    }
                        ],
                        "defenses": [
                                    {
                                                "name": "Wasserwand",
                                                "attr": "GES",
                                                "dice": "d8",
                                                "range": "4",
                                                "status": "",
                                                "desc": "Taktische Barriere aus Wasser"
                                    },
                                    {
                                                "name": "Eisblock",
                                                "attr": "GES",
                                                "dice": "d12",
                                                "range": "1",
                                                "status": "",
                                                "desc": "Sofortiger Eisblock als Deckung"
                                    },
                                    {
                                                "name": "Nebelzone",
                                                "attr": "GES",
                                                "dice": "d6",
                                                "range": "4",
                                                "status": "Geblendet ≥8",
                                                "desc": "Dichter Nebel um sich herum"
                                    },
                                    {
                                                "name": "Strömungsumlenkung",
                                                "attr": "GES",
                                                "dice": "d8",
                                                "range": "2",
                                                "status": "",
                                                "desc": "Angriff mit Wasserströmung ablenken"
                                    },
                                    {
                                                "name": "Gleiten",
                                                "attr": "GES",
                                                "dice": "d6",
                                                "range": "1",
                                                "status": "",
                                                "desc": "Auf Wasserfilm ausweichen"
                                    },
                                    {
                                                "name": "Wasserhaut",
                                                "attr": "GES",
                                                "dice": "d8",
                                                "range": "1",
                                                "status": "",
                                                "desc": "Schützende Wasserschicht am Körper"
                                    },
                                    {
                                                "name": "Eisrüstung",
                                                "attr": "GES",
                                                "dice": "d10",
                                                "range": "1",
                                                "status": "",
                                                "desc": "Temporäre Eisschicht als Panzer"
                                    },
                                    {
                                                "name": "Flusslauf",
                                                "attr": "GES",
                                                "dice": "d8",
                                                "range": "1",
                                                "status": "",
                                                "desc": "Sich wie Wasser um Angriffe winden"
                                    },
                                    {
                                                "name": "Untertauchen",
                                                "attr": "GES",
                                                "dice": "d6",
                                                "range": "1",
                                                "status": "",
                                                "desc": "In nahes Wasser abtauchen"
                                    },
                                    {
                                                "name": "Druckentladung",
                                                "attr": "GES",
                                                "dice": "d10",
                                                "range": "2",
                                                "status": "",
                                                "desc": "Reaktive Druckwelle bei Treffer"
                                    }
                        ]
            },
            "wind": {
                        "name": "Wind",
                        "icon": "icon_focus_wind.png",
                        "mainAttr": "GES",
                        "color": "#69db7c",
                        "attacks": [
                                    {
                                                "name": "Windklinge",
                                                "attr": "GES",
                                                "dice": "d10",
                                                "range": "4",
                                                "status": "Blutend ≥12",
                                                "desc": "Scharfer Luftschnitt"
                                    },
                                    {
                                                "name": "Druckstoß",
                                                "attr": "GES",
                                                "dice": "d10",
                                                "range": "4",
                                                "status": "",
                                                "desc": "Komprimierte Luftmasse als Ramme"
                                    },
                                    {
                                                "name": "Tornado",
                                                "attr": "GES",
                                                "dice": "d8",
                                                "range": "8",
                                                "status": "Erschüttert ≥10",
                                                "desc": "Kontrollierter Wirbelsturm"
                                    },
                                    {
                                                "name": "Luftschnitt-Serie",
                                                "attr": "GES",
                                                "dice": "d8",
                                                "range": "4",
                                                "status": "Blutend ≥10",
                                                "desc": "Schnelle Folge dünner Windklingen"
                                    },
                                    {
                                                "name": "Fallwind",
                                                "attr": "GES",
                                                "dice": "d8",
                                                "range": "8",
                                                "status": "",
                                                "desc": "Luftdruck von oben presst Ziel nieder"
                                    },
                                    {
                                                "name": "Wirbelwurf",
                                                "attr": "GES",
                                                "dice": "d12",
                                                "range": "2",
                                                "status": "",
                                                "desc": "Gegner mit Windstoß schleudern"
                                    },
                                    {
                                                "name": "Stoßfront",
                                                "attr": "GES",
                                                "dice": "d10",
                                                "range": "8",
                                                "status": "",
                                                "desc": "Massive Druckwelle über Distanz"
                                    },
                                    {
                                                "name": "Windlanze",
                                                "attr": "GES",
                                                "dice": "d10",
                                                "range": "12",
                                                "status": "",
                                                "desc": "Komprimierter Luftspeer auf Weite"
                                    },
                                    {
                                                "name": "Luftschock",
                                                "attr": "GES",
                                                "dice": "d8",
                                                "range": "2",
                                                "status": "Betäubt ≥10",
                                                "desc": "Plötzlicher Druckwechsel"
                                    },
                                    {
                                                "name": "Überschallstoß",
                                                "attr": "GES",
                                                "dice": "d20",
                                                "range": "4",
                                                "status": "Betäubt ≥16",
                                                "desc": "Schallmauer durchbrechen. Extrem riskant."
                                    }
                        ],
                        "defenses": [
                                    {
                                                "name": "Luftschild",
                                                "attr": "GES",
                                                "dice": "d8",
                                                "range": "1",
                                                "status": "",
                                                "desc": "Rotierender Windschild"
                                    },
                                    {
                                                "name": "Seitenstoß",
                                                "attr": "GES",
                                                "dice": "d6",
                                                "range": "1",
                                                "status": "",
                                                "desc": "Schnelles Ausweichen per Windstoß"
                                    },
                                    {
                                                "name": "Sprungverstärkung",
                                                "attr": "GES",
                                                "dice": "d6",
                                                "range": "1",
                                                "status": "",
                                                "desc": "Windsprung aus der Gefahrenzone"
                                    },
                                    {
                                                "name": "Gleitbewegung",
                                                "attr": "GES",
                                                "dice": "d8",
                                                "range": "2",
                                                "status": "",
                                                "desc": "Auf Luftströmung gleiten"
                                    },
                                    {
                                                "name": "Rückstoß",
                                                "attr": "GES",
                                                "dice": "d10",
                                                "range": "2",
                                                "status": "",
                                                "desc": "Harter Windstoß gegen Angreifer"
                                    },
                                    {
                                                "name": "Windtunnel",
                                                "attr": "GES",
                                                "dice": "d8",
                                                "range": "4",
                                                "status": "",
                                                "desc": "Projektile umleiten durch Windkanal"
                                    },
                                    {
                                                "name": "Luftpolster",
                                                "attr": "GES",
                                                "dice": "d8",
                                                "range": "1",
                                                "status": "",
                                                "desc": "Dämpfendes Luftkissen bei Aufprall"
                                    },
                                    {
                                                "name": "Richtungsbruch",
                                                "attr": "GES",
                                                "dice": "d6",
                                                "range": "2",
                                                "status": "",
                                                "desc": "Angriffe seitlich ablenken"
                                    },
                                    {
                                                "name": "Druckneutralisierung",
                                                "attr": "GES",
                                                "dice": "d6",
                                                "range": "4",
                                                "status": "",
                                                "desc": "Druckwellen auflösen"
                                    },
                                    {
                                                "name": "Schweben",
                                                "attr": "GES",
                                                "dice": "d6",
                                                "range": "1",
                                                "status": "",
                                                "desc": "Sich aus dem Bodenbereich erheben"
                                    }
                        ]
            },
            "shadow": {
                        "name": "Schatten",
                        "icon": "icon_focus_shadow.png",
                        "mainAttr": "GES",
                        "color": "#4a4a6a",
                        "attacks": [
                                    {
                                                "name": "Schattenklinge",
                                                "attr": "GES",
                                                "dice": "d12",
                                                "range": "1",
                                                "status": "Blutend ≥14",
                                                "desc": "Klinge aus reiner Dunkelheit"
                                    },
                                    {
                                                "name": "Schattenpfeil",
                                                "attr": "GES",
                                                "dice": "d8",
                                                "range": "8",
                                                "status": "",
                                                "desc": "Präzises Dunkelheitsprojektil"
                                    },
                                    {
                                                "name": "Dunkler Griff",
                                                "attr": "GES",
                                                "dice": "d10",
                                                "range": "2",
                                                "status": "Verlangsamt ≥10",
                                                "desc": "Schattententakel packen das Ziel"
                                    },
                                    {
                                                "name": "Schattenexplosion",
                                                "attr": "GES",
                                                "dice": "d10",
                                                "range": "4",
                                                "status": "Geblendet ≥12",
                                                "desc": "Dunkelheitsdetonation"
                                    },
                                    {
                                                "name": "Erstickende Finsternis",
                                                "attr": "GES",
                                                "dice": "d8",
                                                "range": "4",
                                                "status": "Vergiftet ≥10",
                                                "desc": "Schatten kriecht in die Lungen"
                                    },
                                    {
                                                "name": "Schattendoppelgänger",
                                                "attr": "GES",
                                                "dice": "d8",
                                                "range": "4",
                                                "status": "Verwirrt ≥10",
                                                "desc": "Kopie aus Schatten greift an"
                                    },
                                    {
                                                "name": "Nachtbiss",
                                                "attr": "GES",
                                                "dice": "d10",
                                                "range": "1",
                                                "status": "Blutend ≥12",
                                                "desc": "Schneller Angriff aus dem Verborgenen"
                                    },
                                    {
                                                "name": "Schattenketten",
                                                "attr": "GES",
                                                "dice": "d8",
                                                "range": "8",
                                                "status": "Verlangsamt ≥10",
                                                "desc": "Ziel mit Schattenfesseln fixieren"
                                    },
                                    {
                                                "name": "Seelenschatten",
                                                "attr": "GES",
                                                "dice": "d8",
                                                "range": "8",
                                                "status": "Erschüttert ≥10",
                                                "desc": "Eigenen Schatten als Angstprojektion senden"
                                    },
                                    {
                                                "name": "Totale Finsternis",
                                                "attr": "GES",
                                                "dice": "d8",
                                                "range": "12",
                                                "status": "Geblendet ≥10",
                                                "desc": "Komplette Dunkelheit in großem Radius"
                                    }
                        ],
                        "defenses": [
                                    {
                                                "name": "Schattenmantel",
                                                "attr": "GES",
                                                "dice": "d8",
                                                "range": "1",
                                                "status": "",
                                                "desc": "In Dunkelheit hüllen"
                                    },
                                    {
                                                "name": "Schattenschritt",
                                                "attr": "GES",
                                                "dice": "d6",
                                                "range": "4",
                                                "status": "",
                                                "desc": "Durch Schatten gleiten"
                                    },
                                    {
                                                "name": "Auflösung",
                                                "attr": "GES",
                                                "dice": "d8",
                                                "range": "1",
                                                "status": "",
                                                "desc": "Kurz unkörperlich werden"
                                    },
                                    {
                                                "name": "Dunkelheitstarnung",
                                                "attr": "GES",
                                                "dice": "d6",
                                                "range": "1",
                                                "status": "",
                                                "desc": "In Schatten verschmelzen"
                                    },
                                    {
                                                "name": "Schattenbarriere",
                                                "attr": "GES",
                                                "dice": "d8",
                                                "range": "2",
                                                "status": "",
                                                "desc": "Wand aus verdichteter Dunkelheit"
                                    },
                                    {
                                                "name": "Dunkle Spiegelung",
                                                "attr": "GES",
                                                "dice": "d8",
                                                "range": "4",
                                                "status": "Verwirrt ≥10",
                                                "desc": "Angreifer sieht eigene Ängste"
                                    },
                                    {
                                                "name": "Schattenflimmern",
                                                "attr": "GES",
                                                "dice": "d6",
                                                "range": "1",
                                                "status": "",
                                                "desc": "Position flimmert, schwer zu zielen"
                                    },
                                    {
                                                "name": "Nachtauge",
                                                "attr": "GES",
                                                "dice": "d6",
                                                "range": "1",
                                                "status": "",
                                                "desc": "Perfekte Sicht in Dunkelheit"
                                    },
                                    {
                                                "name": "Schattenreise",
                                                "attr": "GES",
                                                "dice": "d6",
                                                "range": "8",
                                                "status": "",
                                                "desc": "Durch Schatten teleportieren"
                                    },
                                    {
                                                "name": "Leere Hülle",
                                                "attr": "GES",
                                                "dice": "d10",
                                                "range": "1",
                                                "status": "",
                                                "desc": "Schattenhülle absorbiert vollen Treffer"
                                    }
                        ]
            },
            "earth": {
                        "name": "Erde",
                        "icon": "icon_focus_earth.png",
                        "mainAttr": "ZÄH",
                        "color": "#a9845b",
                        "attacks": [
                                    {
                                                "name": "Erdspieß",
                                                "attr": "ZÄH",
                                                "dice": "d10",
                                                "range": "4",
                                                "status": "Blutend ≥12",
                                                "desc": "Steinspieß aus dem Boden"
                                    },
                                    {
                                                "name": "Felswurf",
                                                "attr": "ZÄH",
                                                "dice": "d12",
                                                "range": "8",
                                                "status": "",
                                                "desc": "Massiven Brocken schleudern"
                                    },
                                    {
                                                "name": "Bodenbruch",
                                                "attr": "ZÄH",
                                                "dice": "d10",
                                                "range": "4",
                                                "status": "Verlangsamt ≥10",
                                                "desc": "Boden unter dem Ziel aufbrechen"
                                    },
                                    {
                                                "name": "Erdstampfer",
                                                "attr": "ZÄH",
                                                "dice": "d12",
                                                "range": "2",
                                                "status": "Betäubt ≥13",
                                                "desc": "Gewaltiger Stampfer, Erde bebt"
                                    },
                                    {
                                                "name": "Steinschlag",
                                                "attr": "ZÄH",
                                                "dice": "d8",
                                                "range": "12",
                                                "status": "",
                                                "desc": "Felsen von oben dirigieren"
                                    },
                                    {
                                                "name": "Metallfaust",
                                                "attr": "ZÄH",
                                                "dice": "d12",
                                                "range": "1",
                                                "status": "",
                                                "desc": "Faust mit Metall ummanteln"
                                    },
                                    {
                                                "name": "Sandlawine",
                                                "attr": "ZÄH",
                                                "dice": "d8",
                                                "range": "8",
                                                "status": "Geblendet ≥10",
                                                "desc": "Sandwelle über das Feld"
                                    },
                                    {
                                                "name": "Felsramme",
                                                "attr": "ZÄH",
                                                "dice": "d10",
                                                "range": "2",
                                                "status": "",
                                                "desc": "Felssäule rammt aus dem Boden"
                                    },
                                    {
                                                "name": "Erdgreifer",
                                                "attr": "ZÄH",
                                                "dice": "d8",
                                                "range": "4",
                                                "status": "Verlangsamt ≥10",
                                                "desc": "Erdhand greift und fixiert"
                                    },
                                    {
                                                "name": "Bebenstoß",
                                                "attr": "ZÄH",
                                                "dice": "d8",
                                                "range": "8",
                                                "status": "Verlangsamt ≥10",
                                                "desc": "Erschütterung über Distanz"
                                    }
                        ],
                        "defenses": [
                                    {
                                                "name": "Steinrüstung",
                                                "attr": "ZÄH",
                                                "dice": "d12",
                                                "range": "1",
                                                "status": "",
                                                "desc": "Steinhaut, massiv erhöhte DR"
                                    },
                                    {
                                                "name": "Felswand",
                                                "attr": "ZÄH",
                                                "dice": "d10",
                                                "range": "4",
                                                "status": "",
                                                "desc": "Steinmauer aus dem Boden"
                                    },
                                    {
                                                "name": "Bodenschild",
                                                "attr": "ZÄH",
                                                "dice": "d10",
                                                "range": "1",
                                                "status": "",
                                                "desc": "Erdplatte als Schild hochreißen"
                                    },
                                    {
                                                "name": "Erdverankerung",
                                                "attr": "ZÄH",
                                                "dice": "d8",
                                                "range": "1",
                                                "status": "",
                                                "desc": "Füße verankern, immun gegen Rückstoß"
                                    },
                                    {
                                                "name": "Sandbarriere",
                                                "attr": "ZÄH",
                                                "dice": "d6",
                                                "range": "4",
                                                "status": "Geblendet ≥8",
                                                "desc": "Schnelle Sandwand"
                                    },
                                    {
                                                "name": "Metallhaut",
                                                "attr": "ZÄH",
                                                "dice": "d10",
                                                "range": "1",
                                                "status": "",
                                                "desc": "Haut mit Metallschicht überziehen"
                                    },
                                    {
                                                "name": "Erdabsorption",
                                                "attr": "ZÄH",
                                                "dice": "d8",
                                                "range": "1",
                                                "status": "",
                                                "desc": "Schaden in den Boden ableiten"
                                    },
                                    {
                                                "name": "Schutzwall",
                                                "attr": "ZÄH",
                                                "dice": "d8",
                                                "range": "4",
                                                "status": "",
                                                "desc": "Befestigungswall um Position bauen"
                                    },
                                    {
                                                "name": "Bodenerhöhung",
                                                "attr": "ZÄH",
                                                "dice": "d6",
                                                "range": "2",
                                                "status": "",
                                                "desc": "Boden anheben, Höhenvorteil"
                                    },
                                    {
                                                "name": "Erdpanzer",
                                                "attr": "ZÄH",
                                                "dice": "d12",
                                                "range": "1",
                                                "status": "",
                                                "desc": "Voller Steinpanzer. Langsamer, enorm hart."
                                    }
                        ]
            },
            "poison": {
                        "name": "Gift",
                        "icon": "icon_focus_poison.png",
                        "mainAttr": "ZÄH",
                        "color": "#7cb342",
                        "attacks": [
                                    {
                                                "name": "Giftspucke",
                                                "attr": "ZÄH",
                                                "dice": "d8",
                                                "range": "4",
                                                "status": "Vergiftet ≥10",
                                                "desc": "Gezieltes Giftprojektil"
                                    },
                                    {
                                                "name": "Giftklinge",
                                                "attr": "ZÄH",
                                                "dice": "d10",
                                                "range": "1",
                                                "status": "Vergiftet ≥10",
                                                "desc": "Vergiftete Waffe im Nahkampf"
                                    },
                                    {
                                                "name": "Sporenwolke",
                                                "attr": "ZÄH",
                                                "dice": "d8",
                                                "range": "4",
                                                "status": "Vergiftet ≥10",
                                                "desc": "Giftige Sporenwolke in Fläche"
                                    },
                                    {
                                                "name": "Säurespritzer",
                                                "attr": "ZÄH",
                                                "dice": "d10",
                                                "range": "4",
                                                "status": "Blutend ≥12",
                                                "desc": "Ätzende Säure schleudern"
                                    },
                                    {
                                                "name": "Lähmsporen",
                                                "attr": "ZÄH",
                                                "dice": "d8",
                                                "range": "8",
                                                "status": "Verlangsamt ≥10",
                                                "desc": "Sporen lähmen auf Distanz"
                                    },
                                    {
                                                "name": "Nekrose",
                                                "attr": "ZÄH",
                                                "dice": "d8",
                                                "range": "4",
                                                "status": "Vergiftet ≥10",
                                                "desc": "Gewebe verfällt. Langsam, tödlich."
                                    },
                                    {
                                                "name": "Toxischer Griff",
                                                "attr": "ZÄH",
                                                "dice": "d10",
                                                "range": "1",
                                                "status": "Vergiftet ≥10",
                                                "desc": "Berührung vergiftet"
                                    },
                                    {
                                                "name": "Blutgift",
                                                "attr": "ZÄH",
                                                "dice": "d8",
                                                "range": "8",
                                                "status": "Vergiftet ≥10",
                                                "desc": "Gift in die Blutbahn injizieren"
                                    },
                                    {
                                                "name": "Giftexplosion",
                                                "attr": "ZÄH",
                                                "dice": "d12",
                                                "range": "2",
                                                "status": "Vergiftet ≥12",
                                                "desc": "Giftblase detoniert im Nahbereich"
                                    },
                                    {
                                                "name": "Seuchenatem",
                                                "attr": "ZÄH",
                                                "dice": "d8",
                                                "range": "4",
                                                "status": "Vergiftet ≥10",
                                                "desc": "Giftiger Atem, Kegelbereich"
                                    }
                        ],
                        "defenses": [
                                    {
                                                "name": "Giftimmunität",
                                                "attr": "ZÄH",
                                                "dice": "d8",
                                                "range": "1",
                                                "status": "",
                                                "desc": "Immun gegen Gift und Krankheit"
                                    },
                                    {
                                                "name": "Gifthaut",
                                                "attr": "ZÄH",
                                                "dice": "d8",
                                                "range": "1",
                                                "status": "Vergiftet ≥10",
                                                "desc": "Wer berührt, vergiftet sich"
                                    },
                                    {
                                                "name": "Säurepanzer",
                                                "attr": "ZÄH",
                                                "dice": "d10",
                                                "range": "1",
                                                "status": "Vergiftet ≥12",
                                                "desc": "Ätzende Schutzschicht"
                                    },
                                    {
                                                "name": "Sporenschild",
                                                "attr": "ZÄH",
                                                "dice": "d6",
                                                "range": "2",
                                                "status": "Vergiftet ≥8",
                                                "desc": "Sporenbarriere um Position"
                                    },
                                    {
                                                "name": "Giftblut",
                                                "attr": "ZÄH",
                                                "dice": "d6",
                                                "range": "1",
                                                "status": "Vergiftet ≥8",
                                                "desc": "Blut ist Gift, Treffer vergiften Angreifer"
                                    },
                                    {
                                                "name": "Reinigung",
                                                "attr": "ZÄH",
                                                "dice": "d8",
                                                "range": "1",
                                                "status": "",
                                                "desc": "Gift/Krankheit aus Körper entfernen"
                                    },
                                    {
                                                "name": "Resistenz",
                                                "attr": "ZÄH",
                                                "dice": "d6",
                                                "range": "1",
                                                "status": "",
                                                "desc": "Statuseffekt-Resistenz erhöhen"
                                    },
                                    {
                                                "name": "Giftschleier",
                                                "attr": "ZÄH",
                                                "dice": "d6",
                                                "range": "4",
                                                "status": "Vergiftet ≥8",
                                                "desc": "Giftige Nebelwand als Deckung"
                                    },
                                    {
                                                "name": "Parasitäre Heilung",
                                                "attr": "ZÄH",
                                                "dice": "d8",
                                                "range": "1",
                                                "status": "",
                                                "desc": "Gift absorbieren, in Heilung umwandeln"
                                    },
                                    {
                                                "name": "Toxische Explosion",
                                                "attr": "ZÄH",
                                                "dice": "d10",
                                                "range": "2",
                                                "status": "Vergiftet ≥10",
                                                "desc": "Giftexplosion als Reaktion"
                                    }
                        ]
            },
            "space": {
                        "name": "Raum",
                        "icon": "icon_focus_space.png",
                        "mainAttr": "VER",
                        "color": "#9775fa",
                        "attacks": [
                                    {
                                                "name": "Kurzteleport-Schlag",
                                                "attr": "VER",
                                                "dice": "d12",
                                                "range": "1",
                                                "status": "",
                                                "desc": "Teleportiere zum Ziel, Sofortangriff"
                                    },
                                    {
                                                "name": "Positionswechsel",
                                                "attr": "VER",
                                                "dice": "d8",
                                                "range": "8",
                                                "status": "Verwirrt ≥10",
                                                "desc": "Zwei Ziele tauschen Position"
                                    },
                                    {
                                                "name": "Raumschnitt",
                                                "attr": "VER",
                                                "dice": "d10",
                                                "range": "8",
                                                "status": "Blutend ≥12",
                                                "desc": "Raum aufreißen, schneidet durch alles"
                                    },
                                    {
                                                "name": "Distanzbruch",
                                                "attr": "VER",
                                                "dice": "d8",
                                                "range": "12",
                                                "status": "",
                                                "desc": "Entfernung komprimieren, Fernschlag"
                                    },
                                    {
                                                "name": "Raumstoß",
                                                "attr": "VER",
                                                "dice": "d10",
                                                "range": "4",
                                                "status": "",
                                                "desc": "Raumverzerrung als physische Kraft"
                                    },
                                    {
                                                "name": "Fixierung",
                                                "attr": "VER",
                                                "dice": "d8",
                                                "range": "8",
                                                "status": "Verlangsamt ≥10",
                                                "desc": "Ziel im Raum fixieren"
                                    },
                                    {
                                                "name": "Umlenkung",
                                                "attr": "VER",
                                                "dice": "d8",
                                                "range": "4",
                                                "status": "",
                                                "desc": "Gegner-Angriff auf anderes Ziel umleiten"
                                    },
                                    {
                                                "name": "Miniportal",
                                                "attr": "VER",
                                                "dice": "d8",
                                                "range": "12",
                                                "status": "",
                                                "desc": "Kleines Portal, Angriff erscheint woanders"
                                    },
                                    {
                                                "name": "Fallverzerrung",
                                                "attr": "VER",
                                                "dice": "d10",
                                                "range": "4",
                                                "status": "Verlangsamt ≥10",
                                                "desc": "Schwerkraft lokal verzerren"
                                    },
                                    {
                                                "name": "Raumkompression",
                                                "attr": "VER",
                                                "dice": "d20",
                                                "range": "2",
                                                "status": "",
                                                "desc": "Raum um Ziel komprimieren. Zerquetschend."
                                    }
                        ],
                        "defenses": [
                                    {
                                                "name": "Sofort-Teleport",
                                                "attr": "VER",
                                                "dice": "d6",
                                                "range": "4",
                                                "status": "",
                                                "desc": "Blitzschnelle Teleportation aus Gefahr"
                                    },
                                    {
                                                "name": "Distanzvergrößerung",
                                                "attr": "VER",
                                                "dice": "d8",
                                                "range": "4",
                                                "status": "",
                                                "desc": "Raum zwischen dir und Angreifer dehnen"
                                    },
                                    {
                                                "name": "Positionsanker",
                                                "attr": "VER",
                                                "dice": "d8",
                                                "range": "1",
                                                "status": "",
                                                "desc": "Position fixieren, immun gegen Verschiebung"
                                    },
                                    {
                                                "name": "Raumverschiebung",
                                                "attr": "VER",
                                                "dice": "d8",
                                                "range": "2",
                                                "status": "",
                                                "desc": "Leicht aus der Realität verschieben"
                                    },
                                    {
                                                "name": "Umlenkfeld",
                                                "attr": "VER",
                                                "dice": "d10",
                                                "range": "2",
                                                "status": "",
                                                "desc": "Eingehende Angriffe umleiten"
                                    },
                                    {
                                                "name": "Phasenversatz",
                                                "attr": "VER",
                                                "dice": "d6",
                                                "range": "1",
                                                "status": "",
                                                "desc": "Teilweise phasenversetzt, Treffer gehen durch"
                                    },
                                    {
                                                "name": "Raumblockade",
                                                "attr": "VER",
                                                "dice": "d8",
                                                "range": "4",
                                                "status": "",
                                                "desc": "Raum härten, unsichtbare Wand"
                                    },
                                    {
                                                "name": "Fallneutralisierung",
                                                "attr": "VER",
                                                "dice": "d6",
                                                "range": "1",
                                                "status": "",
                                                "desc": "Schwerkraft aufheben bei Sturz"
                                    },
                                    {
                                                "name": "Schutzportal",
                                                "attr": "VER",
                                                "dice": "d8",
                                                "range": "4",
                                                "status": "",
                                                "desc": "Angriff in Portal umleiten"
                                    },
                                    {
                                                "name": "Eigenverzerrung",
                                                "attr": "VER",
                                                "dice": "d8",
                                                "range": "1",
                                                "status": "",
                                                "desc": "Eigene Raum-Geometrie verzerren"
                                    }
                        ]
            },
            "time": {
                        "name": "Zeit",
                        "icon": "icon_focus_time.png",
                        "mainAttr": "VER",
                        "color": "#d4a574",
                        "attacks": [
                                    {
                                                "name": "Zeitriss",
                                                "attr": "VER",
                                                "dice": "d10",
                                                "range": "8",
                                                "status": "Blutend ≥12",
                                                "desc": "Riss in der Zeitlinie, schneidet Materie"
                                    },
                                    {
                                                "name": "Alterung",
                                                "attr": "VER",
                                                "dice": "d8",
                                                "range": "4",
                                                "status": "Verlangsamt ≥10",
                                                "desc": "Ziel altert lokal, Muskeln versagen"
                                    },
                                    {
                                                "name": "Stillstand-Schlag",
                                                "attr": "VER",
                                                "dice": "d12",
                                                "range": "1",
                                                "status": "Betäubt ≥13",
                                                "desc": "Zeit anhalten, dann zuschlagen"
                                    },
                                    {
                                                "name": "Beschleunigter Ansturm",
                                                "attr": "VER",
                                                "dice": "d10",
                                                "range": "2",
                                                "status": "",
                                                "desc": "Eigene Zeit beschleunigen, Blitz-Nahkampf"
                                    },
                                    {
                                                "name": "Echo-Schaden",
                                                "attr": "VER",
                                                "dice": "d8",
                                                "range": "8",
                                                "status": "",
                                                "desc": "Vergangenen Schaden erneut auslösen"
                                    },
                                    {
                                                "name": "Zeitschleife-Falle",
                                                "attr": "VER",
                                                "dice": "d8",
                                                "range": "8",
                                                "status": "Verlangsamt ≥10",
                                                "desc": "Ziel in Zeitschleife fangen"
                                    },
                                    {
                                                "name": "Zukunftsvision",
                                                "attr": "VER",
                                                "dice": "d8",
                                                "range": "12",
                                                "status": "Markiert ≥10",
                                                "desc": "Nächsten Zug des Ziels vorhersehen"
                                    },
                                    {
                                                "name": "Verfall",
                                                "attr": "VER",
                                                "dice": "d8",
                                                "range": "4",
                                                "status": "Vergiftet ≥10",
                                                "desc": "Materie beschleunigt zerfallen lassen"
                                    },
                                    {
                                                "name": "Verzögerter Schlag",
                                                "attr": "VER",
                                                "dice": "d10",
                                                "range": "2",
                                                "status": "",
                                                "desc": "Schaden tritt erst nächste Runde ein"
                                    },
                                    {
                                                "name": "Zeitexplosion",
                                                "attr": "VER",
                                                "dice": "d20",
                                                "range": "4",
                                                "status": "Betäubt ≥16",
                                                "desc": "Zeitenergie komprimieren. Devastierend."
                                    }
                        ],
                        "defenses": [
                                    {
                                                "name": "Zeitsprung",
                                                "attr": "VER",
                                                "dice": "d6",
                                                "range": "4",
                                                "status": "",
                                                "desc": "Kurz in die Zukunft springen"
                                    },
                                    {
                                                "name": "Rückspulen",
                                                "attr": "VER",
                                                "dice": "d10",
                                                "range": "1",
                                                "status": "",
                                                "desc": "Letzten Treffer rückgängig machen"
                                    },
                                    {
                                                "name": "Verlangsamungsfeld",
                                                "attr": "VER",
                                                "dice": "d8",
                                                "range": "4",
                                                "status": "Verlangsamt ≥10",
                                                "desc": "Alles in Zone wird langsamer"
                                    },
                                    {
                                                "name": "Zeitblase",
                                                "attr": "VER",
                                                "dice": "d8",
                                                "range": "2",
                                                "status": "",
                                                "desc": "Persönliche Zeitblase"
                                    },
                                    {
                                                "name": "Moment der Klarheit",
                                                "attr": "VER",
                                                "dice": "d6",
                                                "range": "1",
                                                "status": "",
                                                "desc": "Zeit verlangsamen, perfekt reagieren"
                                    },
                                    {
                                                "name": "Reparatur",
                                                "attr": "VER",
                                                "dice": "d8",
                                                "range": "1",
                                                "status": "",
                                                "desc": "Körper zurücksetzen vor dem Treffer"
                                    },
                                    {
                                                "name": "Prophezeiung",
                                                "attr": "VER",
                                                "dice": "d6",
                                                "range": "8",
                                                "status": "",
                                                "desc": "Nächsten Angriff vorhersehen"
                                    },
                                    {
                                                "name": "Zeitanker",
                                                "attr": "VER",
                                                "dice": "d8",
                                                "range": "1",
                                                "status": "",
                                                "desc": "Position in der Zeit speichern"
                                    },
                                    {
                                                "name": "Beschleunigte Heilung",
                                                "attr": "VER",
                                                "dice": "d8",
                                                "range": "1",
                                                "status": "",
                                                "desc": "Heilung zeitlich beschleunigen"
                                    },
                                    {
                                                "name": "Zeitstillstand",
                                                "attr": "VER",
                                                "dice": "d12",
                                                "range": "2",
                                                "status": "Betäubt ≥13",
                                                "desc": "Alles friert ein. Absoluter Notfall."
                                    }
                        ]
            },
            "illusion": {
                        "name": "Illusion",
                        "icon": "icon_focus_illusion.png",
                        "mainAttr": "PRÄ",
                        "color": "#f06595",
                        "attacks": [
                                    {
                                                "name": "Trugbild",
                                                "attr": "PRÄ",
                                                "dice": "d8",
                                                "range": "8",
                                                "status": "Verwirrt ≥10",
                                                "desc": "Falsche Realität projizieren"
                                    },
                                    {
                                                "name": "Doppelgänger",
                                                "attr": "PRÄ",
                                                "dice": "d8",
                                                "range": "4",
                                                "status": "Verwirrt ≥10",
                                                "desc": "Illusionskopie greift an"
                                    },
                                    {
                                                "name": "Blendillusion",
                                                "attr": "PRÄ",
                                                "dice": "d8",
                                                "range": "4",
                                                "status": "Geblendet ≥10",
                                                "desc": "Blendendes Lichtspiel"
                                    },
                                    {
                                                "name": "Geräuschfalle",
                                                "attr": "PRÄ",
                                                "dice": "d8",
                                                "range": "8",
                                                "status": "",
                                                "desc": "Geräusch lenkt ab, öffnet Flanke"
                                    },
                                    {
                                                "name": "Angriffsillusion",
                                                "attr": "PRÄ",
                                                "dice": "d8",
                                                "range": "8",
                                                "status": "",
                                                "desc": "Unsichtbare Kraft trifft"
                                    },
                                    {
                                                "name": "Angstbild",
                                                "attr": "PRÄ",
                                                "dice": "d10",
                                                "range": "4",
                                                "status": "Erschüttert ≥12",
                                                "desc": "Schlimmste Angst des Ziels visualisieren"
                                    },
                                    {
                                                "name": "Verzerrte Umgebung",
                                                "attr": "PRÄ",
                                                "dice": "d8",
                                                "range": "8",
                                                "status": "Verlangsamt ≥10",
                                                "desc": "Terrain erscheint anders als es ist"
                                    },
                                    {
                                                "name": "Unsichtbarer Schlag",
                                                "attr": "PRÄ",
                                                "dice": "d10",
                                                "range": "2",
                                                "status": "",
                                                "desc": "Aus Unsichtbarkeit angreifen"
                                    },
                                    {
                                                "name": "Phantomhieb",
                                                "attr": "PRÄ",
                                                "dice": "d8",
                                                "range": "4",
                                                "status": "",
                                                "desc": "Illusionäre Klinge, fühlt sich real an"
                                    },
                                    {
                                                "name": "Scheinexplosion",
                                                "attr": "PRÄ",
                                                "dice": "d8",
                                                "range": "8",
                                                "status": "Erschüttert ≥10",
                                                "desc": "Fake-Explosion, purer Psychoterror"
                                    }
                        ],
                        "defenses": [
                                    {
                                                "name": "Unsichtbarkeit",
                                                "attr": "PRÄ",
                                                "dice": "d8",
                                                "range": "1",
                                                "status": "",
                                                "desc": "Sich unsichtbar machen"
                                    },
                                    {
                                                "name": "Illusionsschild",
                                                "attr": "PRÄ",
                                                "dice": "d8",
                                                "range": "2",
                                                "status": "",
                                                "desc": "Schild sieht aus wie Luft, blockiert trotzdem"
                                    },
                                    {
                                                "name": "Mehrfachbilder",
                                                "attr": "PRÄ",
                                                "dice": "d6",
                                                "range": "1",
                                                "status": "Verwirrt ≥8",
                                                "desc": "Mehrere Kopien verwirren Angreifer"
                                    },
                                    {
                                                "name": "Verhüllung",
                                                "attr": "PRÄ",
                                                "dice": "d6",
                                                "range": "1",
                                                "status": "",
                                                "desc": "Aussehen verändern, Tarnung"
                                    },
                                    {
                                                "name": "Täuschbewegung",
                                                "attr": "PRÄ",
                                                "dice": "d8",
                                                "range": "1",
                                                "status": "",
                                                "desc": "Illusionäre Ausweichbewegung"
                                    },
                                    {
                                                "name": "Wahrnehmungsbruch",
                                                "attr": "PRÄ",
                                                "dice": "d8",
                                                "range": "4",
                                                "status": "Verwirrt ≥10",
                                                "desc": "Wahrnehmung des Angreifers verzerren"
                                    },
                                    {
                                                "name": "Falsche Trefferanzeige",
                                                "attr": "PRÄ",
                                                "dice": "d6",
                                                "range": "1",
                                                "status": "",
                                                "desc": "Treffer scheint woanders zu landen"
                                    },
                                    {
                                                "name": "Illusionszone",
                                                "attr": "PRÄ",
                                                "dice": "d6",
                                                "range": "4",
                                                "status": "Verwirrt ≥8",
                                                "desc": "Ganzes Gebiet sieht anders aus"
                                    },
                                    {
                                                "name": "Sinnesrauschen",
                                                "attr": "PRÄ",
                                                "dice": "d6",
                                                "range": "4",
                                                "status": "Geblendet ≥8",
                                                "desc": "Alle Sinne des Ziels überfluten"
                                    },
                                    {
                                                "name": "Identitätsverschleierung",
                                                "attr": "PRÄ",
                                                "dice": "d6",
                                                "range": "1",
                                                "status": "",
                                                "desc": "Als jemand anderes erscheinen"
                                    }
                        ]
            },
            "sound": {
                        "name": "Schall",
                        "icon": "icon_focus_sound.png",
                        "mainAttr": "PRÄ",
                        "color": "#26c6da",
                        "attacks": [
                                    {
                                                "name": "Schallwelle",
                                                "attr": "PRÄ",
                                                "dice": "d8",
                                                "range": "8",
                                                "status": "",
                                                "desc": "Breite Druckwelle aus Klang"
                                    },
                                    {
                                                "name": "Donnerschlag",
                                                "attr": "PRÄ",
                                                "dice": "d12",
                                                "range": "4",
                                                "status": "Betäubt ≥13",
                                                "desc": "Ohrenbetäubender Knall"
                                    },
                                    {
                                                "name": "Schrei",
                                                "attr": "PRÄ",
                                                "dice": "d10",
                                                "range": "4",
                                                "status": "Erschüttert ≥12",
                                                "desc": "Fokussierter Kampfschrei"
                                    },
                                    {
                                                "name": "Resonanzbruch",
                                                "attr": "PRÄ",
                                                "dice": "d10",
                                                "range": "8",
                                                "status": "Blutend ≥12",
                                                "desc": "Eigenfrequenz des Ziels finden und brechen"
                                    },
                                    {
                                                "name": "Echoschlag",
                                                "attr": "PRÄ",
                                                "dice": "d8",
                                                "range": "2",
                                                "status": "",
                                                "desc": "Schall trifft, Echo trifft nochmal"
                                    },
                                    {
                                                "name": "Stille",
                                                "attr": "PRÄ",
                                                "dice": "d8",
                                                "range": "8",
                                                "status": "Verwirrt ≥10",
                                                "desc": "Absolute Stille, Orientierung weg"
                                    },
                                    {
                                                "name": "Dissonanz",
                                                "attr": "PRÄ",
                                                "dice": "d8",
                                                "range": "4",
                                                "status": "Erschüttert ≥10",
                                                "desc": "Widerliche Frequenz, Übelkeit"
                                    },
                                    {
                                                "name": "Schallklinge",
                                                "attr": "PRÄ",
                                                "dice": "d10",
                                                "range": "4",
                                                "status": "Blutend ≥12",
                                                "desc": "Fokussierte Schallfrequenz als Schnitt"
                                    },
                                    {
                                                "name": "Infraschall",
                                                "attr": "PRÄ",
                                                "dice": "d8",
                                                "range": "12",
                                                "status": "Erschüttert ≥10",
                                                "desc": "Unhörbar, Organe vibrieren, Panik"
                                    },
                                    {
                                                "name": "Überschallstoß",
                                                "attr": "PRÄ",
                                                "dice": "d20",
                                                "range": "2",
                                                "status": "Betäubt ≥16",
                                                "desc": "Schallmauer brechen, enorme Zerstörung"
                                    }
                        ],
                        "defenses": [
                                    {
                                                "name": "Schallschild",
                                                "attr": "PRÄ",
                                                "dice": "d8",
                                                "range": "1",
                                                "status": "",
                                                "desc": "Klanghülle absorbiert Einschläge"
                                    },
                                    {
                                                "name": "Stille-Zone",
                                                "attr": "PRÄ",
                                                "dice": "d6",
                                                "range": "4",
                                                "status": "",
                                                "desc": "Zone ohne Schall, blockiert Klangangriffe"
                                    },
                                    {
                                                "name": "Echo-Ortung",
                                                "attr": "PRÄ",
                                                "dice": "d6",
                                                "range": "8",
                                                "status": "Markiert ≥8",
                                                "desc": "Sonar, versteckte Feinde finden"
                                    },
                                    {
                                                "name": "Frequenzstörung",
                                                "attr": "PRÄ",
                                                "dice": "d8",
                                                "range": "4",
                                                "status": "Verwirrt ≥10",
                                                "desc": "Frequenz des Angreifers stören"
                                    },
                                    {
                                                "name": "Dämpfungsfeld",
                                                "attr": "PRÄ",
                                                "dice": "d8",
                                                "range": "2",
                                                "status": "",
                                                "desc": "Schall um sich dämpfen, DR erhöhen"
                                    },
                                    {
                                                "name": "Schallreflektion",
                                                "attr": "PRÄ",
                                                "dice": "d8",
                                                "range": "2",
                                                "status": "",
                                                "desc": "Schallangriffe zurückwerfen"
                                    },
                                    {
                                                "name": "Vibrationsresistenz",
                                                "attr": "PRÄ",
                                                "dice": "d6",
                                                "range": "1",
                                                "status": "",
                                                "desc": "Körper gegen Vibrationen abhärten"
                                    },
                                    {
                                                "name": "Harmonie",
                                                "attr": "PRÄ",
                                                "dice": "d6",
                                                "range": "1",
                                                "status": "",
                                                "desc": "Heilende Frequenz, Moral +5"
                                    },
                                    {
                                                "name": "Schalltarnung",
                                                "attr": "PRÄ",
                                                "dice": "d6",
                                                "range": "1",
                                                "status": "",
                                                "desc": "Eigene Geräusche absorbieren, lautlos"
                                    },
                                    {
                                                "name": "Druckausgleich",
                                                "attr": "PRÄ",
                                                "dice": "d6",
                                                "range": "1",
                                                "status": "",
                                                "desc": "Druckwellen neutralisieren"
                                    }
                        ]
            },
            berserker: {
                name: 'Berserker',
                icon: 'icon_focus_berserker.png',
                mainAttr: 'KRF',
                color: '#c62828',
                attacks: [
                    { name: 'Wilder Hieb', attr: 'KRF', dice: 'd8', range: '1', status: '', desc: 'Unkontrollierter Schlag mit voller Wucht' },
                    { name: 'Schädelbrecher', attr: 'KRF', dice: 'd10', range: '1', status: 'Betäubt ≥12', desc: 'Gezielter Schlag gegen den Kopf' },
                    { name: 'Wirbelschlag', attr: 'KRF', dice: 'd8', range: '2', status: '', desc: 'Drehattacke gegen alle in Reichweite' },
                    { name: 'Tobender Ansturm', attr: 'KRF', dice: 'd10', range: '4', status: 'Erschüttert ≥12', desc: 'Sprint in den Feind, alles umreißen' },
                    { name: 'Knochenbrecher', attr: 'KRF', dice: 'd12', range: '1', status: 'Verlangsamt ≥12', desc: 'Gezielte Attacke auf Gliedmaßen' },
                    { name: 'Blutfresser', attr: 'KRF', dice: 'd8', range: '1', status: 'Blutend ≥10', desc: 'Brutale Risswunde' },
                    { name: 'Abrissbirne', attr: 'KRF', dice: 'd12', range: '2', status: 'Erschüttert ≥14', desc: 'Massiver Überkopfschlag' },
                    { name: 'Zermalmen', attr: 'KRF', dice: 'd10', range: '1', status: 'Blutend ≥12', desc: 'Gegner am Boden fertigmachen' },
                    { name: 'Raserei', attr: 'KRF', dice: 'd10', range: '2', status: '', desc: 'Mehrere unkontrollierte Schläge nacheinander' },
                    { name: 'Entfesselung', attr: 'KRF', dice: 'd20', range: '2', status: 'Betäubt ≥16', desc: 'Totale Raserei, Kontrollverlust' }
                ],
                defenses: [
                    { name: 'Schmerzresistenz', attr: 'KRF', dice: 'd6', range: '0', status: '', desc: 'Schaden ignorieren durch Adrenalin' },
                    { name: 'Wutschild', attr: 'KRF', dice: 'd8', range: '0', status: '', desc: 'Mehr Schaden kassiert = mehr Schutz' },
                    { name: 'Trotzreaktion', attr: 'KRF', dice: 'd8', range: '1', status: '', desc: 'Konterangriff nach erlittenem Treffer' },
                    { name: 'Narbenrüstung', attr: 'KRF', dice: 'd6', range: '0', status: '', desc: 'Temporäre DR durch Kampfverhärtung' },
                    { name: 'Blutrausch', attr: 'KRF', dice: 'd10', range: '0', status: '', desc: 'HP-Regeneration bei niedrigen LP' },
                    { name: 'Angsteinflößend', attr: 'KRF', dice: 'd8', range: '3', status: 'Erschüttert ≥10', desc: 'Feinde zögern anzugreifen' },
                    { name: 'Standhalten', attr: 'KRF', dice: 'd8', range: '0', status: '', desc: 'Immun gegen Verlangsamt und Erschüttert' },
                    { name: 'Todesverachtung', attr: 'KRF', dice: 'd12', range: '0', status: '', desc: 'Einmal pro Kampf tödlichen Treffer überleben' },
                    { name: 'Schmerzschrei', attr: 'KRF', dice: 'd8', range: '3', status: 'Betäubt ≥10', desc: 'Feinde in der Nähe erstarren' },
                    { name: 'Unaufhaltsam', attr: 'KRF', dice: 'd10', range: '0', status: '', desc: 'Bewegung kann nicht eingeschränkt werden' }
                ]
            },
            vollstrecker: {
                name: 'Vollstrecker',
                icon: 'icon_focus_vollstrecker.png',
                mainAttr: 'KRF',
                color: '#b71c1c',
                attacks: [
                    { name: 'Durchschlag', attr: 'KRF', dice: 'd10', range: '1', status: '', desc: 'Schlag der Deckung ignoriert' },
                    { name: 'Druckstoß', attr: 'KRF', dice: 'd10', range: '2', status: 'Erschüttert ≥12', desc: 'Körpermasse als Ramme einsetzen' },
                    { name: 'Kettenbrecher', attr: 'KRF', dice: 'd10', range: '1', status: 'Erschüttert ≥12', desc: 'Waffe oder Schild des Gegners treffen' },
                    { name: 'Niederstrecken', attr: 'KRF', dice: 'd12', range: '1', status: 'Betäubt ≥14', desc: 'Gegner zu Boden zwingen' },
                    { name: 'Spalter', attr: 'KRF', dice: 'd10', range: '1', status: 'Blutend ≥12', desc: 'Vertikaler Schlag durch Rüstung' },
                    { name: 'Nachsetzen', attr: 'KRF', dice: 'd8', range: '3', status: '', desc: 'Sofortangriff nach Feind-Rückzug' },
                    { name: 'Erderschütterer', attr: 'KRF', dice: 'd12', range: '2', status: 'Verlangsamt ≥12', desc: 'Boden unter dem Gegner zertrümmern' },
                    { name: 'Überwältigen', attr: 'KRF', dice: 'd10', range: '1', status: 'Verlangsamt ≥12', desc: 'Gegner packen und zu Boden drücken' },
                    { name: 'Urteilsschlag', attr: 'KRF', dice: 'd12', range: '1', status: 'Blutend ≥14', desc: 'Ein berechneter finaler Hieb' },
                    { name: 'Vernichtungsschlag', attr: 'KRF', dice: 'd20', range: '1', status: 'Erschüttert ≥16', desc: 'Alles in einen Schlag, riskant' }
                ],
                defenses: [
                    { name: 'Eiserne Haltung', attr: 'KRF', dice: 'd8', range: '0', status: '', desc: 'Standfest, nicht zu verschieben' },
                    { name: 'Vergeltung', attr: 'KRF', dice: 'd8', range: '1', status: '', desc: 'Automatischer Gegenschlag bei Treffer' },
                    { name: 'Drohgebärde', attr: 'KRF', dice: 'd8', range: '3', status: 'Erschüttert ≥10', desc: 'Feinde überlegen es sich zweimal' },
                    { name: 'Zähigkeit', attr: 'KRF', dice: 'd8', range: '0', status: '', desc: 'Kurzzeitig erhöhte DR' },
                    { name: 'Abfangen', attr: 'KRF', dice: 'd8', range: '2', status: '', desc: 'Angriff auf Verbündeten auf sich umleiten' },
                    { name: 'Durchhalten', attr: 'KRF', dice: 'd10', range: '0', status: '', desc: 'HP-Regeneration durch Willenskraft' },
                    { name: 'Rüstungstrotz', attr: 'KRF', dice: 'd8', range: '0', status: '', desc: 'Nächsten Statuseffekt ignorieren' },
                    { name: 'Kampfnarben', attr: 'KRF', dice: 'd10', range: '0', status: '', desc: 'Erlittener Schaden wird temporäre DR' },
                    { name: 'Einschüchtern', attr: 'KRF', dice: 'd8', range: '4', status: 'Betäubt ≥10', desc: 'Gegner erstarrt durch pure Präsenz' },
                    { name: 'Unnachgiebig', attr: 'KRF', dice: 'd12', range: '0', status: '', desc: 'Unter 25% HP: massiver Schutzboost' }
                ]
            },
            klingenmeister: {
                name: 'Klingenmeister',
                icon: 'icon_focus_klingenmeister.png',
                mainAttr: 'GES',
                color: '#1565c0',
                attacks: [
                    { name: 'Präzisionsschnitt', attr: 'GES', dice: 'd8', range: '1', status: 'Blutend ≥10', desc: 'Chirurgisch genauer Hieb an die Schwachstelle' },
                    { name: 'Doppelklinge', attr: 'GES', dice: 'd8', range: '1', status: '', desc: 'Zwei schnelle Schnitte nacheinander' },
                    { name: 'Finte', attr: 'GES', dice: 'd8', range: '1', status: 'Markiert ≥8', desc: 'Täuschmanöver, Deckung aufbrechen' },
                    { name: 'Wirbelklinge', attr: 'GES', dice: 'd10', range: '2', status: '', desc: 'Drehender Angriff gegen mehrere Ziele' },
                    { name: 'Ausfallschritt', attr: 'GES', dice: 'd10', range: '3', status: '', desc: 'Schneller Vorstoß mit maximaler Reichweite' },
                    { name: 'Sehnenriss', attr: 'GES', dice: 'd8', range: '1', status: 'Verlangsamt ≥10', desc: 'Gezielter Schnitt an Beinen' },
                    { name: 'Konterklinge', attr: 'GES', dice: 'd10', range: '1', status: '', desc: 'Parieren und sofort zurückschlagen' },
                    { name: 'Schnittfolge', attr: 'GES', dice: 'd10', range: '1', status: 'Blutend ≥12', desc: 'Elegante Kombination aus drei Treffern' },
                    { name: 'Herzstich', attr: 'GES', dice: 'd12', range: '1', status: '', desc: 'Alles auf einen perfekten Treffer' },
                    { name: 'Klingentanz', attr: 'GES', dice: 'd20', range: '2', status: 'Blutend ≥13', desc: 'Entfesselte Klingenakrobatik, tödlich und riskant' }
                ],
                defenses: [
                    { name: 'Parade', attr: 'GES', dice: 'd8', range: '0', status: '', desc: 'Klassisches Abwehren mit der Klinge' },
                    { name: 'Riposte', attr: 'GES', dice: 'd8', range: '1', status: '', desc: 'Abwehr die sofort in Angriff übergeht' },
                    { name: 'Klingenschleier', attr: 'GES', dice: 'd8', range: '0', status: '', desc: 'Schnelle Klingenbewegung als Schutzwall' },
                    { name: 'Ausweichrolle', attr: 'GES', dice: 'd8', range: '2', status: '', desc: 'Attacke vermeiden durch Bewegung' },
                    { name: 'Wachposition', attr: 'GES', dice: 'd8', range: '0', status: '', desc: 'Erhöhte Aufmerksamkeit, DR-Boost' },
                    { name: 'Entwaffnen', attr: 'GES', dice: 'd8', range: '1', status: 'Erschüttert ≥10', desc: 'Gegnerische Waffe wegschlagen' },
                    { name: 'Nebelschritt', attr: 'GES', dice: 'd10', range: '3', status: '', desc: 'Blitzschnelle Repositionierung' },
                    { name: 'Ablenkklinge', attr: 'GES', dice: 'd8', range: '2', status: 'Markiert ≥10', desc: 'Verbündeten aus der Schusslinie holen' },
                    { name: 'Schwertgarde', attr: 'GES', dice: 'd10', range: '0', status: '', desc: 'Defensive Haltung, nächste Runde geschützt' },
                    { name: 'Perfekte Form', attr: 'GES', dice: 'd12', range: '0', status: '', desc: 'Kurzzeitig unangreifbar durch makellose Technik' }
                ]
            },
            scharfschuetze: {
                name: 'Scharfschütze',
                icon: 'icon_focus_scharfschuetze.png',
                mainAttr: 'GES',
                color: '#2e7d32',
                attacks: [
                    { name: 'Gezielter Schuss', attr: 'GES', dice: 'd8', range: '8', status: '', desc: 'Ruhig zielen, sauber treffen' },
                    { name: 'Kopfschuss', attr: 'GES', dice: 'd12', range: '8', status: 'Betäubt ≥14', desc: 'Alles auf einen perfekten Treffer' },
                    { name: 'Sperrfeuer', attr: 'GES', dice: 'd8', range: '6', status: '', desc: 'Schnelle Schüsse auf ein Gebiet' },
                    { name: 'Durchschuss', attr: 'GES', dice: 'd10', range: '6', status: '', desc: 'Geschoss durchdringt Deckung' },
                    { name: 'Beinschuss', attr: 'GES', dice: 'd8', range: '8', status: 'Verlangsamt ≥10', desc: 'Mobilität des Ziels einschränken' },
                    { name: 'Markierungsschuss', attr: 'GES', dice: 'd8', range: '12', status: 'Markiert ≥10', desc: 'Ziel für Verbündete sichtbar machen' },
                    { name: 'Explosivgeschoss', attr: 'GES', dice: 'd10', range: '6', status: 'Erschüttert ≥12', desc: 'Flächenwirkung am Einschlagpunkt' },
                    { name: 'Streifschuss', attr: 'GES', dice: 'd8', range: '10', status: 'Blutend ≥10', desc: 'Schneller Schuss auf extreme Distanz' },
                    { name: 'Doppelschuss', attr: 'GES', dice: 'd10', range: '8', status: '', desc: 'Zwei Schüsse in schneller Folge' },
                    { name: 'Todesschuss', attr: 'GES', dice: 'd20', range: '12', status: '', desc: 'Ein Schuss, maximale Distanz, alles oder nichts' }
                ],
                defenses: [
                    { name: 'Deckung suchen', attr: 'GES', dice: 'd8', range: '6', status: '', desc: 'Hinter nächstem Objekt in Sicherheit' },
                    { name: 'Warnschuss', attr: 'GES', dice: 'd8', range: '8', status: 'Erschüttert ≥10', desc: 'Feind vom Vorrücken abhalten' },
                    { name: 'Rückzugsfeuer', attr: 'GES', dice: 'd8', range: '4', status: '', desc: 'Schießend zurückfallen, Distanz halten' },
                    { name: 'Tarnung', attr: 'GES', dice: 'd8', range: '0', status: '', desc: 'Unsichtbar werden, aus dem Fokus verschwinden' },
                    { name: 'Stolperfalle', attr: 'GES', dice: 'd8', range: '3', status: 'Verlangsamt ≥10', desc: 'Vorbereitete Falle am Boden' },
                    { name: 'Ausweichsprung', attr: 'GES', dice: 'd8', range: '4', status: '', desc: 'Schnelle Bewegung aus der Gefahrenzone' },
                    { name: 'Gegenfeuer', attr: 'GES', dice: 'd8', range: '6', status: '', desc: 'Feindlichen Fernkämpfer unterdrücken' },
                    { name: 'Rauchgranate', attr: 'GES', dice: 'd8', range: '4', status: 'Geblendet ≥10', desc: 'Sicht blockieren, Rückzug decken' },
                    { name: 'Überblick', attr: 'GES', dice: 'd8', range: '0', status: '', desc: 'Erhöhte Position, Feinde können nicht überraschen' },
                    { name: 'Totmannstellung', attr: 'GES', dice: 'd12', range: '0', status: '', desc: 'Regungslos, massiver DR-Boost solange nicht bewegt' }
                ]
            },
            assassine: {
                name: 'Assassine',
                icon: 'icon_focus_assassine.png',
                mainAttr: 'GES',
                color: '#4a148c',
                attacks: [
                    { name: 'Hinterhalt', attr: 'GES', dice: 'd10', range: '1', status: '', desc: 'Erster Angriff aus Versteck, Bonusschaden' },
                    { name: 'Giftklinge', attr: 'GES', dice: 'd8', range: '1', status: 'Vergiftet ≥10', desc: 'Beschichtete Waffe, Schaden über Zeit' },
                    { name: 'Kehlengriff', attr: 'GES', dice: 'd10', range: '1', status: 'Betäubt ≥12', desc: 'Lautloser Würgegriff von hinten' },
                    { name: 'Schattenstich', attr: 'GES', dice: 'd8', range: '1', status: '', desc: 'Blitzschneller Dolchstoß, kaum sichtbar' },
                    { name: 'Doppelstich', attr: 'GES', dice: 'd8', range: '1', status: 'Blutend ≥10', desc: 'Zwei schnelle Treffer, beide zählen' },
                    { name: 'Giftwurf', attr: 'GES', dice: 'd8', range: '4', status: 'Vergiftet ≥10', desc: 'Giftfläschchen oder Wurfnadel' },
                    { name: 'Nervenpunkt', attr: 'GES', dice: 'd8', range: '1', status: 'Verlangsamt ≥10', desc: 'Gezielter Treffer auf Druckpunkt' },
                    { name: 'Auslöschen', attr: 'GES', dice: 'd20', range: '1', status: '', desc: 'Alles auf eine Chance, sofort oder nie' },
                    { name: 'Organversagen', attr: 'GES', dice: 'd12', range: '1', status: 'Vergiftet ≥14', desc: 'Tiefes Einstechen mit Gift, verheerend' },
                    { name: 'Rückenstich', attr: 'GES', dice: 'd10', range: '1', status: 'Blutend ≥12', desc: 'Von hinten zustechen, maximale Wirkung' }
                ],
                defenses: [
                    { name: 'Schattensprung', attr: 'GES', dice: 'd8', range: '4', status: '', desc: 'Sofort in den nächsten Schatten verschwinden' },
                    { name: 'Giftnebel', attr: 'GES', dice: 'd8', range: '2', status: 'Vergiftet ≥10', desc: 'Giftwolke um sich herum freisetzen' },
                    { name: 'Rauchbombe', attr: 'GES', dice: 'd8', range: '3', status: 'Geblendet ≥10', desc: 'Sicht blockieren, verschwinden' },
                    { name: 'Kontergriff', attr: 'GES', dice: 'd8', range: '1', status: '', desc: 'Angreifer umdrehen, Position tauschen' },
                    { name: 'Schlüpfrig', attr: 'GES', dice: 'd10', range: '0', status: '', desc: 'Aus Griffen und Festsetzungen entkommen' },
                    { name: 'Giftresistenz', attr: 'GES', dice: 'd8', range: '0', status: '', desc: 'Eigene Gifte haben keine Wirkung auf dich' },
                    { name: 'Ablenkungsdoppel', attr: 'GES', dice: 'd8', range: '1', status: '', desc: 'Attrappe hinterlassen, Angriff geht ins Leere' },
                    { name: 'Fluchtinstinkt', attr: 'GES', dice: 'd10', range: '6', status: '', desc: 'Sofortige Flucht bei erkannter Übermacht' },
                    { name: 'Phantom', attr: 'GES', dice: 'd12', range: '0', status: '', desc: 'Komplett unsichtbar für eine Runde' },
                    { name: 'Abtauchen', attr: 'GES', dice: 'd8', range: '3', status: '', desc: 'In Menschenmenge oder Umgebung verschwinden' }
                ]
            },
            waechter: {
                name: 'Wächter',
                icon: 'icon_focus_waechter.png',
                mainAttr: 'ZÄH',
                color: '#5d4037',
                attacks: [
                    { name: 'Schildstoß', attr: 'ZÄH', dice: 'd8', range: '1', status: 'Erschüttert ≥10', desc: 'Schild als Waffe, Gegner zurückdrängen' },
                    { name: 'Schildkante', attr: 'ZÄH', dice: 'd8', range: '1', status: 'Blutend ≥10', desc: 'Schildrand in den Gegner rammen' },
                    { name: 'Konterstoß', attr: 'ZÄH', dice: 'd10', range: '1', status: '', desc: 'Nach erfolgreicher Abwehr sofort zuschlagen' },
                    { name: 'Festnageln', attr: 'ZÄH', dice: 'd8', range: '1', status: 'Verlangsamt ≥10', desc: 'Gegner mit Schild an Wand oder Boden drücken' },
                    { name: 'Provokation', attr: 'ZÄH', dice: 'd8', range: '4', status: 'Markiert ≥8', desc: 'Gegner zwingen sich auf dich zu fokussieren' },
                    { name: 'Rammbock', attr: 'ZÄH', dice: 'd10', range: '3', status: 'Betäubt ≥12', desc: 'Voller Sprint mit Schild voraus' },
                    { name: 'Überrollen', attr: 'ZÄH', dice: 'd10', range: '2', status: 'Erschüttert ≥12', desc: 'Alles niederwalzen was im Weg steht' },
                    { name: 'Strafschlag', attr: 'ZÄH', dice: 'd8', range: '1', status: '', desc: 'Gegner bestrafen der Verbündete angreift' },
                    { name: 'Brecher', attr: 'ZÄH', dice: 'd12', range: '1', status: 'Betäubt ≥14', desc: 'Massiver Schildhieb von oben' },
                    { name: 'Letzte Bastion', attr: 'ZÄH', dice: 'd20', range: '2', status: 'Erschüttert ≥16', desc: 'Verzweifelter Rundumschlag zum Schutz aller' }
                ],
                defenses: [
                    { name: 'Schildwall', attr: 'ZÄH', dice: 'd8', range: '0', status: '', desc: 'Klassische Schilddeckung, DR-Boost' },
                    { name: 'Abfangen', attr: 'ZÄH', dice: 'd8', range: '2', status: '', desc: 'Angriff auf Verbündeten auf sich umleiten' },
                    { name: 'Deckungsgeber', attr: 'ZÄH', dice: 'd8', range: '2', status: '', desc: 'Verbündetem hinter dir DR verleihen' },
                    { name: 'Standfest', attr: 'ZÄH', dice: 'd10', range: '0', status: '', desc: 'Immun gegen Verschieben und Erschüttert' },
                    { name: 'Schutzformation', attr: 'ZÄH', dice: 'd8', range: '2', status: '', desc: 'Alle angrenzenden Verbündeten geschützt' },
                    { name: 'Aufopferung', attr: 'ZÄH', dice: 'd10', range: '1', status: '', desc: 'Schaden für Verbündeten komplett übernehmen' },
                    { name: 'Trotzdem stehen', attr: 'ZÄH', dice: 'd12', range: '0', status: '', desc: 'Tödlichen Treffer mit 1 HP überleben' },
                    { name: 'Vergeltungsaura', attr: 'ZÄH', dice: 'd8', range: '2', status: 'Markiert ≥10', desc: 'Angreifer werden automatisch markiert' },
                    { name: 'Eiserner Wille', attr: 'ZÄH', dice: 'd8', range: '0', status: '', desc: 'Nächsten Statuseffekt komplett ignorieren' },
                    { name: 'Unbrechbar', attr: 'ZÄH', dice: 'd12', range: '0', status: '', desc: 'Für eine Runde massiv erhöhte DR' }
                ]
            },
            gladiator: {
                name: 'Gladiator',
                icon: 'icon_focus_gladiator.png',
                mainAttr: 'ZÄH',
                color: '#e65100',
                attacks: [
                    { name: 'Schinderhieb', attr: 'ZÄH', dice: 'd8', range: '1', status: 'Blutend ≥10', desc: 'Brutaler Schnitt, Wunde reißt auf' },
                    { name: 'Netzwurf', attr: 'ZÄH', dice: 'd8', range: '3', status: 'Verlangsamt ≥8', desc: 'Ziel einwickeln, Bewegung einschränken' },
                    { name: 'Kniescheibentritt', attr: 'ZÄH', dice: 'd8', range: '1', status: 'Verlangsamt ≥10', desc: 'Gezielter Tritt, Gegner knickt ein' },
                    { name: 'Arenastoß', attr: 'ZÄH', dice: 'd10', range: '1', status: 'Erschüttert ≥12', desc: 'Körper als Waffe, Gegner schleudern' },
                    { name: 'Fleischwunde', attr: 'ZÄH', dice: 'd10', range: '1', status: 'Blutend ≥12', desc: 'Tiefer Schnitt, blutet stark nach' },
                    { name: 'Todesspirale', attr: 'ZÄH', dice: 'd12', range: '2', status: 'Blutend ≥14', desc: 'Wirbelnder Angriff, alles aufreißen' },
                    { name: 'Provokationsschlag', attr: 'ZÄH', dice: 'd8', range: '1', status: 'Markiert ≥8', desc: 'Demütigender Treffer, Gegner fixiert auf dich' },
                    { name: 'Kopfnuss', attr: 'ZÄH', dice: 'd8', range: '1', status: 'Betäubt ≥10', desc: 'Simpel, effektiv, respektlos' },
                    { name: 'Schwachstellenhammer', attr: 'ZÄH', dice: 'd10', range: '1', status: '', desc: 'Auf bereits verletzte Stellen nachsetzen' },
                    { name: 'Publikumsliebling', attr: 'ZÄH', dice: 'd20', range: '2', status: 'Betäubt ≥16', desc: 'Spektakulärer Angriff, alles riskieren' }
                ],
                defenses: [
                    { name: 'Zähne zusammen', attr: 'ZÄH', dice: 'd8', range: '0', status: '', desc: 'Schaden einstecken und weitermachen' },
                    { name: 'Blutige Routine', attr: 'ZÄH', dice: 'd8', range: '0', status: '', desc: 'Je niedriger die HP, desto höher die DR' },
                    { name: 'Konterring', attr: 'ZÄH', dice: 'd8', range: '1', status: '', desc: 'Angriff abfangen und zurückschlagen' },
                    { name: 'Dreckiger Tritt', attr: 'ZÄH', dice: 'd8', range: '1', status: 'Verlangsamt ≥10', desc: 'Gegner wegtreten, Abstand schaffen' },
                    { name: 'Narbengewebe', attr: 'ZÄH', dice: 'd8', range: '0', status: '', desc: 'Dauerhaft erhärtete Haut, passiver Schutz' },
                    { name: 'Adrenalinschub', attr: 'ZÄH', dice: 'd10', range: '0', status: '', desc: 'HP-Regeneration durch puren Kampfwillen' },
                    { name: 'Sandwurf', attr: 'ZÄH', dice: 'd8', range: '2', status: 'Geblendet ≥10', desc: 'Dreckiger Trick, Sicht nehmen' },
                    { name: 'Showkampf', attr: 'ZÄH', dice: 'd8', range: '3', status: 'Markiert ≥10', desc: 'Alle Feinde auf dich lenken, Verbündete entlasten' },
                    { name: 'Überlebenswille', attr: 'ZÄH', dice: 'd12', range: '0', status: '', desc: 'Unter 25% HP: Schaden wird halbiert' },
                    { name: 'Nicht heute', attr: 'ZÄH', dice: 'd10', range: '0', status: '', desc: 'Einmal pro Kampf Statuseffekte abschütteln' }
                ]
            },
            taktiker: {
                name: 'Taktiker',
                icon: 'icon_focus_taktiker.png',
                mainAttr: 'VER',
                color: '#0277bd',
                attacks: [
                    { name: 'Schwachstellentreffer', attr: 'VER', dice: 'd10', range: '1', status: '', desc: 'Lücke in der Deckung erkennen und zuschlagen' },
                    { name: 'Umgebungswaffe', attr: 'VER', dice: 'd8', range: '2', status: 'Erschüttert ≥10', desc: 'Alles in Reichweite als Waffe nutzen' },
                    { name: 'Flankenangriff', attr: 'VER', dice: 'd10', range: '2', status: '', desc: 'Positionsvorteil ausnutzen, erhöhter Schaden' },
                    { name: 'Druckpunktschlag', attr: 'VER', dice: 'd8', range: '1', status: 'Betäubt ≥10', desc: 'Anatomisches Wissen als Waffe' },
                    { name: 'Kettenreaktion', attr: 'VER', dice: 'd10', range: '3', status: 'Erschüttert ≥12', desc: 'Ein Treffer löst Folgeeffekt aus' },
                    { name: 'Strukturangriff', attr: 'VER', dice: 'd10', range: '4', status: 'Verlangsamt ≥12', desc: 'Terrain zum Einsturz bringen' },
                    { name: 'Präzisionsschlag', attr: 'VER', dice: 'd12', range: '1', status: 'Blutend ≥12', desc: 'Perfekt berechneter einzelner Treffer' },
                    { name: 'Gezielter Wurf', attr: 'VER', dice: 'd8', range: '6', status: '', desc: 'Wurfwaffe mit berechnetem Winkel' },
                    { name: 'Druckaufbau', attr: 'VER', dice: 'd8', range: '2', status: 'Markiert ≥8', desc: 'Gegner systematisch in die Enge treiben' },
                    { name: 'Meisterplan', attr: 'VER', dice: 'd20', range: '4', status: 'Betäubt ≥16', desc: 'Alles zusammenführen, ein perfekter Moment' }
                ],
                defenses: [
                    { name: 'Vorausahnung', attr: 'VER', dice: 'd8', range: '0', status: '', desc: 'Angriff kommen sehen bevor er passiert' },
                    { name: 'Ausmanövrieren', attr: 'VER', dice: 'd8', range: '2', status: '', desc: 'Gegner in schlechte Position zwingen' },
                    { name: 'Gegenanweisung', attr: 'VER', dice: 'd8', range: '4', status: '', desc: 'Verbündetem optimale Reaktion zurufen' },
                    { name: 'Fehlleitung', attr: 'VER', dice: 'd8', range: '4', status: 'Verwirrt ≥10', desc: 'Gegner greift falsches Ziel an' },
                    { name: 'Rückzugsplan', attr: 'VER', dice: 'd8', range: '0', status: '', desc: 'Geordneter Rückzug, kein Gelegenheitsangriff' },
                    { name: 'Umleiten', attr: 'VER', dice: 'd8', range: '2', status: '', desc: 'Feindangriff gegen anderen Feind lenken' },
                    { name: 'Terrainvorteil', attr: 'VER', dice: 'd10', range: '0', status: '', desc: 'Umgebung als Deckung nutzen, DR-Boost' },
                    { name: 'Falle auslösen', attr: 'VER', dice: 'd8', range: '3', status: 'Verlangsamt ≥10', desc: 'Vorbereitete Überraschung aktivieren' },
                    { name: 'Kontrollierte Eskalation', attr: 'VER', dice: 'd10', range: '0', status: '', desc: 'Chaos im Kampf zu eigenem Vorteil nutzen' },
                    { name: 'Masterplan', attr: 'VER', dice: 'd12', range: '0', status: '', desc: 'Nächste Runde: alle Verbündeten erhalten Bonus' }
                ]
            },
            jaeger: {
                name: 'Jäger',
                icon: 'icon_focus_jaeger.png',
                mainAttr: 'VER',
                color: '#33691e',
                attacks: [
                    { name: 'Fährtenklinge', attr: 'VER', dice: 'd8', range: '1', status: 'Blutend ≥10', desc: 'Schnitt der Spuren hinterlässt' },
                    { name: 'Fernwurf', attr: 'VER', dice: 'd8', range: '6', status: '', desc: 'Wurfwaffe mit Präzision geschleudert' },
                    { name: 'Fangeisen', attr: 'VER', dice: 'd8', range: '3', status: 'Verlangsamt ≥10', desc: 'Mechanische Falle, hält fest' },
                    { name: 'Giftpfeil', attr: 'VER', dice: 'd8', range: '8', status: 'Vergiftet ≥10', desc: 'Beschichtetes Geschoss auf Distanz' },
                    { name: 'Hetzjagd', attr: 'VER', dice: 'd10', range: '4', status: 'Erschüttert ≥12', desc: 'Ziel verfolgen und unter Druck setzen' },
                    { name: 'Wildtiertaktik', attr: 'VER', dice: 'd10', range: '2', status: '', desc: 'Unberechenbare Angriffsmuster' },
                    { name: 'Tödliche Geduld', attr: 'VER', dice: 'd12', range: '8', status: '', desc: 'Lange warten, ein perfekter Treffer' },
                    { name: 'Pirschangriff', attr: 'VER', dice: 'd10', range: '1', status: '', desc: 'Aus Tarnung heraus zuschlagen' },
                    { name: 'Speerspitze', attr: 'VER', dice: 'd10', range: '4', status: 'Blutend ≥12', desc: 'Wurf- oder Stoßwaffe mit voller Wucht' },
                    { name: 'Revierverteidigung', attr: 'VER', dice: 'd20', range: '3', status: 'Betäubt ≥16', desc: 'Alles auslösen, totale Gebietskontrolle' }
                ],
                defenses: [
                    { name: 'Tarnnetz', attr: 'VER', dice: 'd8', range: '0', status: '', desc: 'Unsichtbar in der Umgebung verschwinden' },
                    { name: 'Stolperdraht', attr: 'VER', dice: 'd8', range: '3', status: 'Verlangsamt ≥10', desc: 'Annähernde Feinde ausbremsen' },
                    { name: 'Spurenverwischen', attr: 'VER', dice: 'd8', range: '0', status: '', desc: 'Nicht verfolgbar, Position unklar' },
                    { name: 'Warnsignal', attr: 'VER', dice: 'd8', range: '6', status: '', desc: 'Verbündete vor Hinterhalt warnen' },
                    { name: 'Geländekenntnis', attr: 'VER', dice: 'd10', range: '0', status: '', desc: 'Umgebung perfekt lesen, DR-Boost' },
                    { name: 'Rückzugspfad', attr: 'VER', dice: 'd8', range: '4', status: '', desc: 'Immer eine Fluchtroute vorbereitet' },
                    { name: 'Ablenkungsfalle', attr: 'VER', dice: 'd8', range: '4', status: 'Geblendet ≥10', desc: 'Blitz- oder Rauchfalle für Verfolger' },
                    { name: 'Wildinstinkt', attr: 'VER', dice: 'd8', range: '0', status: '', desc: 'Gefahren spüren bevor sie passieren' },
                    { name: 'Totstellreflex', attr: 'VER', dice: 'd10', range: '0', status: '', desc: 'Regungslos, Feinde verlieren Interesse' },
                    { name: 'Meisterfallensteller', attr: 'VER', dice: 'd12', range: '3', status: 'Verlangsamt ≥10', desc: 'Komplexe Falle, hält Feind komplett fest' }
                ]
            },
            duellant: {
                name: 'Duellant',
                icon: 'icon_focus_duellant.png',
                mainAttr: 'PRÄ',
                color: '#ad1457',
                attacks: [
                    { name: 'Ehrenhieb', attr: 'PRÄ', dice: 'd8', range: '1', status: '', desc: 'Sauberer, respektvoller Treffer' },
                    { name: 'Herausforderung', attr: 'PRÄ', dice: 'd8', range: '4', status: 'Markiert ≥8', desc: 'Einzelkampf erzwingen' },
                    { name: 'Entwaffnungsschlag', attr: 'PRÄ', dice: 'd8', range: '1', status: 'Erschüttert ≥10', desc: 'Waffe aus der Hand schlagen' },
                    { name: 'Demütigung', attr: 'PRÄ', dice: 'd8', range: '1', status: 'Verwirrt ≥10', desc: 'Absichtlich spielerisch treffen, Moral brechen' },
                    { name: 'Blitzduell', attr: 'PRÄ', dice: 'd10', range: '2', status: '', desc: 'Schneller Vorstoß, sofortiger Klingenwechsel' },
                    { name: 'Schnittfolge', attr: 'PRÄ', dice: 'd10', range: '1', status: 'Blutend ≥12', desc: 'Elegante Kombination aus drei Treffern' },
                    { name: 'Konterfinte', attr: 'PRÄ', dice: 'd10', range: '1', status: '', desc: 'Absichtlich Öffnung lassen, Konter einleiten' },
                    { name: 'Todesstoß', attr: 'PRÄ', dice: 'd12', range: '1', status: '', desc: 'Finaler Stich, sauber und tödlich' },
                    { name: 'Ehrensalve', attr: 'PRÄ', dice: 'd10', range: '1', status: 'Erschüttert ≥12', desc: 'Serie aus schnellen, respektlosen Treffern' },
                    { name: 'Meisterduell', attr: 'PRÄ', dice: 'd20', range: '1', status: 'Betäubt ≥16', desc: 'Perfekter Kampfmoment, völlige Überlegenheit' }
                ],
                defenses: [
                    { name: 'Ehrengarde', attr: 'PRÄ', dice: 'd8', range: '0', status: '', desc: 'Perfekte defensive Haltung' },
                    { name: 'Einschüchternder Blick', attr: 'PRÄ', dice: 'd8', range: '4', status: 'Erschüttert ≥10', desc: 'Feinde zögern anzugreifen' },
                    { name: 'Elegante Parade', attr: 'PRÄ', dice: 'd8', range: '0', status: '', desc: 'Angriff mit minimaler Bewegung ablenken' },
                    { name: 'Ruf der Ehre', attr: 'PRÄ', dice: 'd8', range: '4', status: 'Verwirrt ≥10', desc: 'Feinde zweifeln ob sie angreifen sollen' },
                    { name: 'Konterangriff', attr: 'PRÄ', dice: 'd10', range: '1', status: '', desc: 'Parieren und sofort zurückschlagen' },
                    { name: 'Respektgebietend', attr: 'PRÄ', dice: 'd8', range: '3', status: '', desc: 'Aura die Nahkampf-Angreifer hemmt' },
                    { name: 'Unlesbar', attr: 'PRÄ', dice: 'd10', range: '0', status: '', desc: 'Körpersprache verrät nichts, schwer zu treffen' },
                    { name: 'Standpunkt', attr: 'PRÄ', dice: 'd8', range: '0', status: '', desc: 'Nicht von der Stelle weichen, erhöhte DR' },
                    { name: 'Entwaffnungsparade', attr: 'PRÄ', dice: 'd8', range: '1', status: 'Erschüttert ≥10', desc: 'Konter der Gegner waffenlos lässt' },
                    { name: 'Unantastbar', attr: 'PRÄ', dice: 'd12', range: '0', status: '', desc: 'Für eine Runde absolut in der Zone' }
                ]
            },
            konstrukteur: {
                name: 'Konstrukteur',
                icon: 'icon_focus_konstrukteur.png',
                mainAttr: 'KRF',
                color: '#ff8f00',
                attacks: [
                    { name: 'Hammerschlag', attr: 'KRF', dice: 'd8', range: '1', status: '', desc: 'Schwerer Werkzeugschlag' },
                    { name: 'Überhitzen', attr: 'KRF', dice: 'd8', range: '2', status: 'Brennend ≥10', desc: 'Gegnerische Ausrüstung zum Glühen bringen' },
                    { name: 'Splitterwurf', attr: 'KRF', dice: 'd8', range: '4', status: 'Blutend ≥10', desc: 'Scharfe Materialreste schleudern' },
                    { name: 'Schildbrecher', attr: 'KRF', dice: 'd10', range: '1', status: 'Erschüttert ≥12', desc: 'Gegner-DR temporär senken' },
                    { name: 'Nagelbombe', attr: 'KRF', dice: 'd8', range: '3', status: 'Blutend ≥10', desc: 'Improvisiertes Streugeschoss' },
                    { name: 'Pressschlag', attr: 'KRF', dice: 'd10', range: '1', status: 'Verlangsamt ≥12', desc: 'Gegner-Rüstung verformen und einengen' },
                    { name: 'Kettenklammer', attr: 'KRF', dice: 'd8', range: '3', status: 'Verlangsamt ≥10', desc: 'Mechanische Fessel auf Distanz werfen' },
                    { name: 'Bohrschlag', attr: 'KRF', dice: 'd10', range: '1', status: '', desc: 'Durchbohrt Rüstung gezielt' },
                    { name: 'Schleudergeschoss', attr: 'KRF', dice: 'd10', range: '6', status: 'Erschüttert ≥12', desc: 'Schweres Projektil mit Eigenbau-Werfer' },
                    { name: 'Sprengladung', attr: 'KRF', dice: 'd20', range: '3', status: 'Betäubt ≥16', desc: 'Selbstgebauter Sprengsatz, verheerend' }
                ],
                defenses: [
                    { name: 'Schnellreparatur', attr: 'KRF', dice: 'd8', range: '1', status: '', desc: 'Verbündete Rüstung flicken, DR wiederherstellen' },
                    { name: 'Waffenschmied', attr: 'KRF', dice: 'd8', range: '1', status: '', desc: 'Verbündete Waffe verbessern, Bonusschaden' },
                    { name: 'Barrikade', attr: 'KRF', dice: 'd10', range: '2', status: '', desc: 'Improvisierte Deckung errichten' },
                    { name: 'Feldbefestigung', attr: 'KRF', dice: 'd8', range: '3', status: '', desc: 'Gebiet absichern, Verbündete geschützt' },
                    { name: 'Rüstungsverstärkung', attr: 'KRF', dice: 'd10', range: '1', status: '', desc: 'Temporär höhere DR für Verbündeten' },
                    { name: 'Fallmechanismus', attr: 'KRF', dice: 'd8', range: '3', status: 'Verlangsamt ≥10', desc: 'Mechanische Falle platzieren' },
                    { name: 'Notabschuss', attr: 'KRF', dice: 'd8', range: '4', status: '', desc: 'Improvisiertes Geschoss gegen anrückende Feinde' },
                    { name: 'Stabilisierung', attr: 'KRF', dice: 'd8', range: '1', status: '', desc: 'Beschädigte Ausrüstung eines Verbündeten retten' },
                    { name: 'Prototyp', attr: 'KRF', dice: 'd10', range: '0', status: '', desc: 'Experimentelles Gerät, unvorhersehbarer Buff' },
                    { name: 'Meisterwerk', attr: 'KRF', dice: 'd12', range: '1', status: '', desc: 'Perfekte Verbesserung, massiver Buff für Verbündeten' }
                ]
            },
            leibwaechter: {
                name: 'Leibwächter',
                icon: 'icon_focus_leibwaechter.png',
                mainAttr: 'KRF',
                color: '#4e342e',
                attacks: [
                    { name: 'Abdrängschlag', attr: 'KRF', dice: 'd8', range: '1', status: '', desc: 'Gegner von Schützling wegstoßen' },
                    { name: 'Tacklung', attr: 'KRF', dice: 'd10', range: '2', status: 'Erschüttert ≥12', desc: 'Volles Gewicht in den Angreifer werfen' },
                    { name: 'Strafaktion', attr: 'KRF', dice: 'd8', range: '1', status: '', desc: 'Wer den Schützling angreift wird bestraft' },
                    { name: 'Armbruch', attr: 'KRF', dice: 'd10', range: '1', status: 'Verlangsamt ≥12', desc: 'Angreifer kampfunfähig machen' },
                    { name: 'Warnhieb', attr: 'KRF', dice: 'd8', range: '2', status: 'Markiert ≥8', desc: 'Klares Signal: nicht näherkommen' },
                    { name: 'Schulterramme', attr: 'KRF', dice: 'd10', range: '3', status: 'Erschüttert ≥12', desc: 'Sprinthieb um Schützling freizukämpfen' },
                    { name: 'Kopfstoß', attr: 'KRF', dice: 'd8', range: '1', status: 'Betäubt ≥10', desc: 'Schneller Headbutt im Getümmel' },
                    { name: 'Klammergriff', attr: 'KRF', dice: 'd8', range: '1', status: 'Verlangsamt ≥10', desc: 'Gegner festhalten und blockieren' },
                    { name: 'Würgegriff', attr: 'KRF', dice: 'd10', range: '1', status: 'Betäubt ≥12', desc: 'Angreifer in Schwitzkasten nehmen' },
                    { name: 'Schutzoffensive', attr: 'KRF', dice: 'd20', range: '2', status: 'Betäubt ≥16', desc: 'Alles riskieren um den Schützling zu retten' }
                ],
                defenses: [
                    { name: 'Menschenschild', attr: 'KRF', dice: 'd10', range: '1', status: '', desc: 'Schaden auf sich umleiten, Schützling unverletzt' },
                    { name: 'Evakuierung', attr: 'KRF', dice: 'd8', range: '2', status: '', desc: 'Verbündeten aus der Gefahrenzone ziehen' },
                    { name: 'Flankendeckung', attr: 'KRF', dice: 'd8', range: '1', status: '', desc: 'Offene Seite des Schützlings absichern' },
                    { name: 'Abschirmung', attr: 'KRF', dice: 'd8', range: '0', status: '', desc: 'Eigenen Körper als Deckung anbieten' },
                    { name: 'Gegenangriff', attr: 'KRF', dice: 'd8', range: '1', status: '', desc: 'Angriff auf Schützling mit Konter beantworten' },
                    { name: 'Eisengriff', attr: 'KRF', dice: 'd10', range: '0', status: '', desc: 'Nicht von der Seite des Schützlings zu trennen' },
                    { name: 'Wachsamkeit', attr: 'KRF', dice: 'd8', range: '0', status: '', desc: 'Bedrohungen erkennen bevor sie zuschlagen' },
                    { name: 'Abfangen', attr: 'KRF', dice: 'd8', range: '2', status: '', desc: 'Projektil oder Angriff abfangen' },
                    { name: 'Opferbereitschaft', attr: 'KRF', dice: 'd12', range: '0', status: '', desc: 'Tödlichen Treffer für Verbündeten einstecken' },
                    { name: 'Todeszone', attr: 'KRF', dice: 'd10', range: '2', status: 'Erschüttert ≥10', desc: 'Niemand kommt an dir vorbei zum Schützling' }
                ]
            },
            feldmedikus: {
                name: 'Feldmedikus',
                icon: 'icon_focus_feldmedikus.png',
                mainAttr: 'GES',
                color: '#00838f',
                attacks: [
                    { name: 'Skalpellschnitt', attr: 'GES', dice: 'd8', range: '1', status: 'Blutend ≥10', desc: 'Chirurgisch präziser Schnitt' },
                    { name: 'Adrenalinstoß', attr: 'GES', dice: 'd8', range: '1', status: '', desc: 'Verbündeten aufputschen, Bonusaktion' },
                    { name: 'Nerventreffer', attr: 'GES', dice: 'd8', range: '1', status: 'Betäubt ≥10', desc: 'Gezielter Stich in Nervenpunkt' },
                    { name: 'Giftinjektion', attr: 'GES', dice: 'd8', range: '1', status: 'Vergiftet ≥10', desc: 'Spritze mit Betäubungsmittel' },
                    { name: 'Knochensäge', attr: 'GES', dice: 'd10', range: '1', status: 'Blutend ≥12', desc: 'Medizinisches Werkzeug als Waffe' },
                    { name: 'Blutdruckschock', attr: 'GES', dice: 'd10', range: '1', status: 'Erschüttert ≥12', desc: 'Kreislauf des Gegners destabilisieren' },
                    { name: 'Sehnengriff', attr: 'GES', dice: 'd8', range: '1', status: 'Verlangsamt ≥10', desc: 'Anatomisches Wissen, Mobilität nehmen' },
                    { name: 'Druckpunktnadel', attr: 'GES', dice: 'd8', range: '3', status: 'Betäubt ≥10', desc: 'Wurfnadel auf Nervenzentrum' },
                    { name: 'Organschock', attr: 'GES', dice: 'd12', range: '1', status: 'Vergiftet ≥14', desc: 'Innere Organe gezielt angreifen' },
                    { name: 'Todesdiagnose', attr: 'GES', dice: 'd20', range: '1', status: 'Betäubt ≥16', desc: 'Perfektes anatomisches Wissen, tödlicher Treffer' }
                ],
                defenses: [
                    { name: 'Schnellverband', attr: 'GES', dice: 'd8', range: '1', status: '', desc: 'Sofortige HP-Heilung im Kampf' },
                    { name: 'Triage', attr: 'GES', dice: 'd8', range: '2', status: '', desc: 'Zwei Verbündete gleichzeitig minimal heilen' },
                    { name: 'Notevakuierung', attr: 'GES', dice: 'd8', range: '3', status: '', desc: 'Verbündeten aus Gefahrenzone ziehen' },
                    { name: 'Stimulanz', attr: 'GES', dice: 'd8', range: '1', status: '', desc: 'Verbündeten Statuseffekt entfernen' },
                    { name: 'Schmerzunterdrückung', attr: 'GES', dice: 'd10', range: '1', status: '', desc: 'Verbündeter ignoriert Wunden kurzzeitig' },
                    { name: 'Gegengift', attr: 'GES', dice: 'd8', range: '2', status: '', desc: 'Vergiftung oder Blutung stoppen' },
                    { name: 'Kampfspritze', attr: 'GES', dice: 'd10', range: '1', status: '', desc: 'Temporärer Boost auf Attribut' },
                    { name: 'Schockreaktion', attr: 'GES', dice: 'd8', range: '0', status: '', desc: 'Eigenen Körper stabilisieren nach Treffer' },
                    { name: 'Wiederbelebung', attr: 'GES', dice: 'd12', range: '1', status: '', desc: 'Bewusstlosen Verbündeten zurückholen' },
                    { name: 'Wunderheilung', attr: 'GES', dice: 'd12', range: '1', status: '', desc: 'Massive Sofort-Heilung, einmal pro Kampf' }
                ]
            },
            saboteur: {
                name: 'Saboteur',
                icon: 'icon_focus_saboteur.png',
                mainAttr: 'GES',
                color: '#37474f',
                attacks: [
                    { name: 'Hinterrücks', attr: 'GES', dice: 'd10', range: '1', status: '', desc: 'Angriff aus dem Verborgenen' },
                    { name: 'Rüstungspfusch', attr: 'GES', dice: 'd8', range: '1', status: 'Markiert ≥8', desc: 'Gegner-Ausrüstung manipulieren, DR senken' },
                    { name: 'Brandsatz', attr: 'GES', dice: 'd8', range: '4', status: 'Brennend ≥10', desc: 'Improvisierter Feuerwurf' },
                    { name: 'Stolperdraht', attr: 'GES', dice: 'd8', range: '3', status: 'Verlangsamt ≥10', desc: 'Falle die Annäherung bestraft' },
                    { name: 'Blendladung', attr: 'GES', dice: 'd8', range: '3', status: 'Geblendet ≥10', desc: 'Lichtblitz aus Eigenproduktion' },
                    { name: 'Taschendiebstahl', attr: 'GES', dice: 'd8', range: '1', status: 'Verwirrt ≥10', desc: 'Ausrüstung im Kampf entwenden' },
                    { name: 'Sprengfalle', attr: 'GES', dice: 'd10', range: '3', status: 'Erschüttert ≥12', desc: 'Platzierte Detonation' },
                    { name: 'Querschläger', attr: 'GES', dice: 'd10', range: '6', status: '', desc: 'Abgelenktes Geschoss um Deckung herum' },
                    { name: 'Kettensprengung', attr: 'GES', dice: 'd12', range: '4', status: 'Verlangsamt ≥14', desc: 'Mehrere Fallen gleichzeitig auslösen' },
                    { name: 'Totaler Sabotageakt', attr: 'GES', dice: 'd20', range: '4', status: 'Betäubt ≥16', desc: 'Alles fliegt in die Luft' }
                ],
                defenses: [
                    { name: 'Nebelwand', attr: 'GES', dice: 'd8', range: '3', status: 'Geblendet ≥10', desc: 'Sichtblocker aufstellen' },
                    { name: 'Fluchtsprung', attr: 'GES', dice: 'd8', range: '4', status: '', desc: 'Schnell raus aus der Gefahrenzone' },
                    { name: 'Köder', attr: 'GES', dice: 'd8', range: '3', status: '', desc: 'Attrappe die Feinde ablenkt' },
                    { name: 'Ausrüstungssabotage', attr: 'GES', dice: 'd8', range: '1', status: 'Verlangsamt ≥10', desc: 'Feindliche Waffe im Kampf manipulieren' },
                    { name: 'Ablenkungszünder', attr: 'GES', dice: 'd8', range: '4', status: 'Erschüttert ≥10', desc: 'Kleine Explosion um Aufmerksamkeit umzulenken' },
                    { name: 'Improvisation', attr: 'GES', dice: 'd10', range: '0', status: '', desc: 'Umgebung als Schutz zweckentfremden' },
                    { name: 'Geheimversteck', attr: 'GES', dice: 'd8', range: '0', status: '', desc: 'Vorbereitete Position, unsichtbar' },
                    { name: 'Konterfalle', attr: 'GES', dice: 'd10', range: '2', status: 'Verlangsamt ≥10', desc: 'Angreifer tritt in vorbereitete Falle' },
                    { name: 'Notfallplan', attr: 'GES', dice: 'd10', range: '0', status: '', desc: 'Immer einen Ausweg vorbereitet' },
                    { name: 'Meistersabotage', attr: 'GES', dice: 'd12', range: '3', status: 'Betäubt ≥12', desc: 'Komplexe Falle die alles lahmlegt' }
                ]
            },
            bastion: {
                name: 'Bastion',
                icon: 'icon_focus_bastion.png',
                mainAttr: 'ZÄH',
                color: '#546e7a',
                attacks: [
                    { name: 'Bodenstampfer', attr: 'ZÄH', dice: 'd8', range: '2', status: 'Erschüttert ≥10', desc: 'Boden erzittern lassen, Nahbereich' },
                    { name: 'Greifattacke', attr: 'ZÄH', dice: 'd8', range: '1', status: 'Verlangsamt ≥10', desc: 'Gegner packen und festhalten' },
                    { name: 'Schulterblock', attr: 'ZÄH', dice: 'd10', range: '1', status: 'Erschüttert ≥12', desc: 'Volles Gewicht in den Gegner' },
                    { name: 'Schockwelle', attr: 'ZÄH', dice: 'd8', range: '3', status: '', desc: 'Druckwelle durch Aufprall' },
                    { name: 'Ankerschlag', attr: 'ZÄH', dice: 'd10', range: '1', status: 'Verlangsamt ≥12', desc: 'Gegner am Boden fixieren' },
                    { name: 'Erdgriff', attr: 'ZÄH', dice: 'd8', range: '1', status: 'Verlangsamt ≥10', desc: 'Gegner am Fuß packen, Flucht verhindern' },
                    { name: 'Konterstoß', attr: 'ZÄH', dice: 'd10', range: '1', status: '', desc: 'Nach Treffer sofort zurückschlagen' },
                    { name: 'Zerdrücken', attr: 'ZÄH', dice: 'd10', range: '1', status: 'Betäubt ≥12', desc: 'Gegner im Griff zusammenpressen' },
                    { name: 'Donnerschritt', attr: 'ZÄH', dice: 'd12', range: '2', status: 'Erschüttert ≥14', desc: 'Massiver Stampfer, Flächenwirkung' },
                    { name: 'Unaufhaltbar', attr: 'ZÄH', dice: 'd20', range: '2', status: 'Betäubt ≥16', desc: 'Voller Ansturm, nichts hält dich auf' }
                ],
                defenses: [
                    { name: 'Schutzaura', attr: 'ZÄH', dice: 'd8', range: '2', status: '', desc: 'Verbündete in Nähe erhalten DR-Bonus' },
                    { name: 'Aggro ziehen', attr: 'ZÄH', dice: 'd8', range: '4', status: 'Markiert ≥8', desc: 'Alle Feinde fokussieren dich' },
                    { name: 'Verankerung', attr: 'ZÄH', dice: 'd10', range: '0', status: '', desc: 'Nicht zu bewegen, immun gegen Verschieben' },
                    { name: 'Schadensabsorption', attr: 'ZÄH', dice: 'd8', range: '1', status: '', desc: 'Treffer auf Verbündeten abfangen' },
                    { name: 'Erdung', attr: 'ZÄH', dice: 'd8', range: '0', status: '', desc: 'Statuseffekte schneller abschütteln' },
                    { name: 'Schutzwall', attr: 'ZÄH', dice: 'd10', range: '2', status: '', desc: 'Lebende Mauer zwischen Feind und Team' },
                    { name: 'Standhaft', attr: 'ZÄH', dice: 'd8', range: '0', status: '', desc: 'Nächsten kritischen Treffer halbieren' },
                    { name: 'Massepanzer', attr: 'ZÄH', dice: 'd10', range: '0', status: '', desc: 'Eigene Masse als Rüstung, DR-Boost' },
                    { name: 'Gravitätsfeld', attr: 'ZÄH', dice: 'd8', range: '3', status: 'Verlangsamt ≥10', desc: 'Feinde in deiner Nähe werden langsamer' },
                    { name: 'Unzerstörbar', attr: 'ZÄH', dice: 'd12', range: '0', status: '', desc: 'Für eine Runde nahezu immun gegen alles' }
                ]
            },
            heiler: {
                name: 'Heiler',
                icon: 'icon_focus_heiler.png',
                mainAttr: 'ZÄH',
                color: '#00c853',
                attacks: [
                    { name: 'Lebensmark', attr: 'ZÄH', dice: 'd8', range: '1', status: '', desc: 'Feind HP entziehen, selbst heilen' },
                    { name: 'Schmerzübertragung', attr: 'ZÄH', dice: 'd8', range: '2', status: '', desc: 'Eigenen erlittenen Schaden zurückwerfen' },
                    { name: 'Schwächepuls', attr: 'ZÄH', dice: 'd8', range: '3', status: 'Markiert ≥8', desc: 'Feindliche Resistenz senken' },
                    { name: 'Entzug', attr: 'ZÄH', dice: 'd10', range: '1', status: 'Verlangsamt ≥10', desc: 'Lebensenergie des Gegners absaugen' },
                    { name: 'Nekrose', attr: 'ZÄH', dice: 'd10', range: '1', status: 'Vergiftet ≥12', desc: 'Gewebe des Gegners zersetzen' },
                    { name: 'Blutkochen', attr: 'ZÄH', dice: 'd8', range: '2', status: 'Brennend ≥10', desc: 'Körperflüssigkeiten des Gegners erhitzen' },
                    { name: 'Immunschock', attr: 'ZÄH', dice: 'd10', range: '1', status: 'Betäubt ≥12', desc: 'Immunsystem des Gegners überlasten' },
                    { name: 'Toxischer Puls', attr: 'ZÄH', dice: 'd8', range: '3', status: 'Vergiftet ≥10', desc: 'Wellenstoß der Organismus schwächt' },
                    { name: 'Zellzerfall', attr: 'ZÄH', dice: 'd12', range: '1', status: 'Vergiftet ≥14', desc: 'Körper des Gegners zersetzt sich' },
                    { name: 'Lebensurteil', attr: 'ZÄH', dice: 'd20', range: '2', status: 'Betäubt ≥16', desc: 'Totale Kontrolle über Biologie des Ziels' }
                ],
                defenses: [
                    { name: 'Regenerationsfeld', attr: 'ZÄH', dice: 'd8', range: '3', status: '', desc: 'Flächenheilung über mehrere Runden' },
                    { name: 'Reinigung', attr: 'ZÄH', dice: 'd8', range: '2', status: '', desc: 'Statuseffekte von Verbündeten entfernen' },
                    { name: 'Lebensband', attr: 'ZÄH', dice: 'd10', range: '2', status: '', desc: 'HP mit Verbündetem teilen' },
                    { name: 'Vitalitätsschub', attr: 'ZÄH', dice: 'd8', range: '1', status: '', desc: 'Sofortige HP-Heilung' },
                    { name: 'Schmerzlinderung', attr: 'ZÄH', dice: 'd8', range: '2', status: '', desc: 'Verbündeter ignoriert nächsten Statuseffekt' },
                    { name: 'Immunisierung', attr: 'ZÄH', dice: 'd10', range: '1', status: '', desc: 'Verbündeter resistent gegen Gift und Blutung' },
                    { name: 'Zellerneuerung', attr: 'ZÄH', dice: 'd10', range: '1', status: '', desc: 'Langsame aber starke Heilung über Zeit' },
                    { name: 'Schutzkokon', attr: 'ZÄH', dice: 'd8', range: '1', status: '', desc: 'Verbündeten einhüllen, heilt und schützt' },
                    { name: 'Lebensanker', attr: 'ZÄH', dice: 'd12', range: '2', status: '', desc: 'Verbündeter kann nicht unter 1 HP fallen' },
                    { name: 'Massenregeneration', attr: 'ZÄH', dice: 'd12', range: '4', status: '', desc: 'Alle Verbündeten in Reichweite heilen' }
                ]
            },
            stratege: {
                name: 'Stratege',
                icon: 'icon_focus_stratege.png',
                mainAttr: 'VER',
                color: '#1a237e',
                attacks: [
                    { name: 'Schwachstellenanalyse', attr: 'VER', dice: 'd8', range: '4', status: 'Markiert ≥8', desc: 'Feindliche Schwachstelle für Team aufdecken' },
                    { name: 'Berechneter Wurf', attr: 'VER', dice: 'd8', range: '6', status: '', desc: 'Wurfgeschoss mit perfektem Winkel' },
                    { name: 'Kommandoschlag', attr: 'VER', dice: 'd8', range: '1', status: '', desc: 'Präziser Treffer basierend auf Analyse' },
                    { name: 'Druckaufbau', attr: 'VER', dice: 'd10', range: '3', status: 'Erschüttert ≥12', desc: 'Gegner systematisch einengen' },
                    { name: 'Koordinierter Angriff', attr: 'VER', dice: 'd10', range: '4', status: '', desc: 'Verbündeten perfekten Moment zum Zuschlagen geben' },
                    { name: 'Ressourcenschlag', attr: 'VER', dice: 'd8', range: '1', status: 'Verlangsamt ≥10', desc: 'Versorgung oder Ausrüstung des Gegners treffen' },
                    { name: 'Ablenkungsfeuer', attr: 'VER', dice: 'd8', range: '4', status: '', desc: 'Gegner aus Position zwingen' },
                    { name: 'Dominoeffekt', attr: 'VER', dice: 'd10', range: '3', status: 'Erschüttert ≥12', desc: 'Ein Treffer löst Kettenreaktion aus' },
                    { name: 'Entscheidungsschlag', attr: 'VER', dice: 'd12', range: '2', status: 'Betäubt ≥14', desc: 'Der perfekt geplante Moment' },
                    { name: 'Schachmatt', attr: 'VER', dice: 'd20', range: '4', status: 'Betäubt ≥16', desc: 'Absolut berechneter finaler Zug' }
                ],
                defenses: [
                    { name: 'Taktischer Rückzug', attr: 'VER', dice: 'd8', range: '0', status: '', desc: 'Geordnetes Zurückfallen, kein Nachteil' },
                    { name: 'Formationsbefehl', attr: 'VER', dice: 'd8', range: '4', status: '', desc: 'Team in optimale Position dirigieren' },
                    { name: 'Umgruppierung', attr: 'VER', dice: 'd8', range: '3', status: '', desc: 'Verbündete repositionieren' },
                    { name: 'Deckungsanalyse', attr: 'VER', dice: 'd10', range: '0', status: '', desc: 'Beste verfügbare Deckung nutzen, DR-Boost' },
                    { name: 'Feindlesung', attr: 'VER', dice: 'd8', range: '4', status: '', desc: 'Nächsten gegnerischen Angriff vorhersagen' },
                    { name: 'Konterplan', attr: 'VER', dice: 'd10', range: '2', status: '', desc: 'Team auf Gegenschlag vorbereiten' },
                    { name: 'Befehlskette', attr: 'VER', dice: 'd8', range: '4', status: '', desc: 'Verbündetem Bonusaktion ermöglichen' },
                    { name: 'Prioritätswechsel', attr: 'VER', dice: 'd8', range: '4', status: 'Markiert ≥10', desc: 'Feind als Hauptziel für Team markieren' },
                    { name: 'Notfallprotokoll', attr: 'VER', dice: 'd10', range: '0', status: '', desc: 'Alle Statuseffekte im Team abschwächen' },
                    { name: 'Meisterstrategie', attr: 'VER', dice: 'd12', range: '4', status: '', desc: 'Team erhält massiven Bonus nächste Runde' }
                ]
            },
            mentor: {
                name: 'Mentor',
                icon: 'icon_focus_mentor.png',
                mainAttr: 'VER',
                color: '#006064',
                attacks: [
                    { name: 'Lehrschlag', attr: 'VER', dice: 'd8', range: '1', status: '', desc: 'Gezielte Demonstration am Gegner' },
                    { name: 'Aufdecken', attr: 'VER', dice: 'd8', range: '4', status: 'Markiert ≥8', desc: 'Feindliche Technik analysieren und bloßstellen' },
                    { name: 'Gezielter Hinweis', attr: 'VER', dice: 'd8', range: '4', status: '', desc: 'Verbündetem Schwachstelle zeigen, der trifft härter' },
                    { name: 'Testschlag', attr: 'VER', dice: 'd8', range: '2', status: '', desc: 'Gegner austesten, Daten sammeln' },
                    { name: 'Lektionsschmerz', attr: 'VER', dice: 'd10', range: '1', status: 'Erschüttert ≥12', desc: 'Gegner eine schmerzhafte Lektion erteilen' },
                    { name: 'Musterunterbrechung', attr: 'VER', dice: 'd10', range: '1', status: 'Verwirrt ≥12', desc: 'Gegnerisches Kampfmuster durchbrechen' },
                    { name: 'Lernkurve', attr: 'VER', dice: 'd10', range: '2', status: '', desc: 'Jeder Angriff auf denselben Feind wird stärker' },
                    { name: 'Erfahrungstreffer', attr: 'VER', dice: 'd10', range: '1', status: '', desc: 'Wissen über den Feind in Schaden umsetzen' },
                    { name: 'Meisterschlag', attr: 'VER', dice: 'd12', range: '1', status: 'Betäubt ≥14', desc: 'Perfekt ausgeführte Technik, lehrbuchmäßig' },
                    { name: 'Ultimative Lektion', attr: 'VER', dice: 'd20', range: '2', status: 'Betäubt ≥16', desc: 'Absolutes Können demonstrieren' }
                ],
                defenses: [
                    { name: 'Unterweisung', attr: 'VER', dice: 'd8', range: '2', status: '', desc: 'Verbündetem bessere Technik beibringen, Buff' },
                    { name: 'Korrektur', attr: 'VER', dice: 'd8', range: '2', status: '', desc: 'Fehlhaltung eines Verbündeten korrigieren, DR-Boost' },
                    { name: 'Ermutigung', attr: 'VER', dice: 'd8', range: '4', status: '', desc: 'Verbündeter erhält Selbstvertrauen-Buff' },
                    { name: 'Erfahrungsschild', attr: 'VER', dice: 'd10', range: '0', status: '', desc: 'Aus Fehlern gelernt, Angriff voraussehen' },
                    { name: 'Vorbild', attr: 'VER', dice: 'd8', range: '3', status: '', desc: 'Verbündete in Nähe kämpfen besser' },
                    { name: 'Wissenstransfer', attr: 'VER', dice: 'd10', range: '2', status: '', desc: 'Verbündetem temporären Skill-Bonus geben' },
                    { name: 'Ruhe bewahren', attr: 'VER', dice: 'd8', range: '0', status: '', desc: 'Statuseffekte durch mentale Stärke abschütteln' },
                    { name: 'Anpassung', attr: 'VER', dice: 'd8', range: '0', status: '', desc: 'Nach erlittenem Angriff gegen selbe Art resistent' },
                    { name: 'Schutzmantra', attr: 'VER', dice: 'd10', range: '3', status: '', desc: 'Verbündete werden fokussierter, Resistenz steigt' },
                    { name: 'Meisterlehre', attr: 'VER', dice: 'd12', range: '4', status: '', desc: 'Alle Verbündeten erhalten massiven Technik-Buff' }
                ]
            },
            kommandant: {
                name: 'Kommandant',
                icon: 'icon_focus_kommandant.png',
                mainAttr: 'PRÄ',
                color: '#bf360c',
                attacks: [
                    { name: 'Kampfbefehl', attr: 'PRÄ', dice: 'd8', range: '4', status: '', desc: 'Verbündetem Bonusangriff ermöglichen' },
                    { name: 'Einschüchterung', attr: 'PRÄ', dice: 'd8', range: '3', status: 'Erschüttert ≥10', desc: 'Gegner durch Autorität einschüchtern' },
                    { name: 'Schlachtruf', attr: 'PRÄ', dice: 'd8', range: '4', status: '', desc: 'Team pushen, kollektiver Schadenboost' },
                    { name: 'Drohbefehl', attr: 'PRÄ', dice: 'd10', range: '4', status: 'Verwirrt ≥12', desc: 'Gegner durch Kommandostimme verunsichern' },
                    { name: 'Zielzuweisung', attr: 'PRÄ', dice: 'd8', range: '6', status: 'Markiert ≥8', desc: 'Feind als Prioritätsziel ausrufen' },
                    { name: 'Druckkommando', attr: 'PRÄ', dice: 'd10', range: '3', status: 'Erschüttert ≥12', desc: 'Koordinierter Vorstoß, Gegner überrumpeln' },
                    { name: 'Exekutionsbefehl', attr: 'PRÄ', dice: 'd10', range: '4', status: '', desc: 'Verbündete fokussieren einzelnes Ziel' },
                    { name: 'Donnerwort', attr: 'PRÄ', dice: 'd10', range: '3', status: 'Betäubt ≥12', desc: 'Einzelnes Befehlswort das Feinde lähmt' },
                    { name: 'Bannrede', attr: 'PRÄ', dice: 'd12', range: '4', status: 'Verwirrt ≥14', desc: 'Feindliche Moral komplett brechen' },
                    { name: 'Absolute Autorität', attr: 'PRÄ', dice: 'd20', range: '4', status: 'Betäubt ≥16', desc: 'Kommando das Freund und Feind erstarren lässt' }
                ],
                defenses: [
                    { name: 'Haltung bewahren', attr: 'PRÄ', dice: 'd8', range: '4', status: '', desc: 'Teamweiter Befehl, Statuseffekte widerstehen' },
                    { name: 'Rückzugsbefehl', attr: 'PRÄ', dice: 'd8', range: '4', status: '', desc: 'Geordneter Teamrückzug ohne Nachteil' },
                    { name: 'Rallye', attr: 'PRÄ', dice: 'd10', range: '4', status: '', desc: 'Gebrochene Moral wiederherstellen, HP-Boost' },
                    { name: 'Formationsruf', attr: 'PRÄ', dice: 'd8', range: '4', status: '', desc: 'Team in Verteidigungsformation bringen' },
                    { name: 'Fokusbefehl', attr: 'PRÄ', dice: 'd8', range: '4', status: '', desc: 'Verbündeter erhält Konzentrations-Buff' },
                    { name: 'Schutzkommando', attr: 'PRÄ', dice: 'd10', range: '3', status: '', desc: 'Verbündeter erhält temporäre DR' },
                    { name: 'Standbefehl', attr: 'PRÄ', dice: 'd8', range: '0', status: '', desc: 'Eigene Position halten, erhöhte DR' },
                    { name: 'Inspiration', attr: 'PRÄ', dice: 'd10', range: '4', status: '', desc: 'Verbündete kämpfen über ihre Grenzen hinaus' },
                    { name: 'Letzte Ansprache', attr: 'PRÄ', dice: 'd12', range: '4', status: '', desc: 'Team erhält massiven Schutzboost' },
                    { name: 'Unerschütterlich', attr: 'PRÄ', dice: 'd12', range: '0', status: '', desc: 'Komplett immun gegen mentale Effekte' }
                ]
            },
            provokateur: {
                name: 'Provokateur',
                icon: 'icon_focus_provokateur.png',
                mainAttr: 'PRÄ',
                color: '#880e4f',
                attacks: [
                    { name: 'Spottschlag', attr: 'PRÄ', dice: 'd8', range: '1', status: 'Verwirrt ≥10', desc: 'Demütigender Treffer, Gegner wird wütend' },
                    { name: 'Verhöhnung', attr: 'PRÄ', dice: 'd8', range: '4', status: 'Markiert ≥8', desc: 'Gegner auf sich ziehen durch Beleidigung' },
                    { name: 'Psychospiel', attr: 'PRÄ', dice: 'd8', range: '3', status: 'Verwirrt ≥10', desc: 'Gegner an sich selbst zweifeln lassen' },
                    { name: 'Provokationshieb', attr: 'PRÄ', dice: 'd10', range: '1', status: 'Erschüttert ≥12', desc: 'Angriff der Wut statt Schmerz auslöst' },
                    { name: 'Nervensäge', attr: 'PRÄ', dice: 'd8', range: '4', status: 'Verwirrt ≥10', desc: 'Ständiges Stören bis der Gegner Fehler macht' },
                    { name: 'Bloßstellung', attr: 'PRÄ', dice: 'd10', range: '4', status: 'Markiert ≥10', desc: 'Schwäche des Gegners für alle sichtbar machen' },
                    { name: 'Zerrbild', attr: 'PRÄ', dice: 'd10', range: '3', status: 'Verwirrt ≥12', desc: 'Gegner sieht sich verzerrt, Verunsicherung' },
                    { name: 'Drohkulisse', attr: 'PRÄ', dice: 'd10', range: '3', status: 'Erschüttert ≥12', desc: 'Einschüchternde Inszenierung' },
                    { name: 'Panikattacke', attr: 'PRÄ', dice: 'd12', range: '3', status: 'Betäubt ≥14', desc: 'Gegner in pure Panik versetzen' },
                    { name: 'Totale Demontage', attr: 'PRÄ', dice: 'd20', range: '4', status: 'Verwirrt ≥16', desc: 'Gegnerisches Selbstbild komplett zerstören' }
                ],
                defenses: [
                    { name: 'Ablenkung', attr: 'PRÄ', dice: 'd8', range: '4', status: '', desc: 'Feinde fokussieren dich statt Verbündete' },
                    { name: 'Spiegelspiel', attr: 'PRÄ', dice: 'd8', range: '1', status: 'Verwirrt ≥10', desc: 'Angreifer verunsichern durch Nachäffen' },
                    { name: 'Schutzprovokation', attr: 'PRÄ', dice: 'd8', range: '3', status: 'Markiert ≥10', desc: 'Feinde von verletztem Verbündeten weglocken' },
                    { name: 'Verwirrungstaktik', attr: 'PRÄ', dice: 'd10', range: '3', status: 'Verwirrt ≥10', desc: 'Feindliche Koordination stören' },
                    { name: 'Spot des Kampfes', attr: 'PRÄ', dice: 'd8', range: '0', status: '', desc: 'Eigener Humor als Schutzschild, DR-Boost' },
                    { name: 'Frustration', attr: 'PRÄ', dice: 'd8', range: '3', status: '', desc: 'Feinde machen Fehler aus Wut' },
                    { name: 'Ansteckende Panik', attr: 'PRÄ', dice: 'd10', range: '4', status: 'Erschüttert ≥10', desc: 'Ein panischer Feind steckt andere an' },
                    { name: 'Unberechenbar', attr: 'PRÄ', dice: 'd10', range: '0', status: '', desc: 'Verhalten nicht vorhersehbar, schwer zu treffen' },
                    { name: 'Selbstinszenierung', attr: 'PRÄ', dice: 'd8', range: '0', status: '', desc: 'Dramatischer Auftritt, Aufmerksamkeit magnetisch' },
                    { name: 'Meistermanipulator', attr: 'PRÄ', dice: 'd12', range: '4', status: 'Verwirrt ≥12', desc: 'Feinde greifen sich gegenseitig an' }
                ]
            },
};

        // Auto-generated from mainAttr - maps to characterData.attributes keys
        const FOKUS_ATTRIBUTE_MAP = {
            fire: 'power', lightning: 'power',
            water: 'agility', wind: 'agility', shadow: 'agility',
            earth: 'endurance', poison: 'endurance',
            space: 'mind', time: 'mind',
            illusion: 'presence', sound: 'presence',
            berserker: 'power',
            vollstrecker: 'power',
            klingenmeister: 'agility',
            scharfschuetze: 'agility',
            assassine: 'agility',
            waechter: 'endurance',
            gladiator: 'endurance',
            taktiker: 'mind',
            jaeger: 'mind',
            duellant: 'presence',
            konstrukteur: 'power',
            leibwaechter: 'power',
            feldmedikus: 'agility',
            saboteur: 'agility',
            bastion: 'endurance',
            heiler: 'endurance',
            stratege: 'mind',
            mentor: 'mind',
            kommandant: 'presence',
            provokateur: 'presence',
        };

        // German display labels for attributes
        const ATTR_DISPLAY = { power: 'KRF', agility: 'GES', endurance: 'ZÄH', mind: 'VER', presence: 'PRÄ' };
        const ATTR_FROM_LABEL = { 'KRF': 'power', 'GES': 'agility', 'ZÄH': 'endurance', 'VER': 'mind', 'PRÄ': 'presence' };

        const FOKUS_FALLBACK_ICONS = {
            berserker: 'destruction',
            vollstrecker: 'gavel',
            klingenmeister: 'swords',
            scharfschuetze: 'target',
            assassine: 'visibility_off',
            waechter: 'shield',
            gladiator: 'stadium',
            taktiker: 'strategy',
            jaeger: 'track_changes',
            duellant: 'swords',
            konstrukteur: 'construction',
            leibwaechter: 'shield_person',
            feldmedikus: 'medical_services',
            saboteur: 'bomb',
            bastion: 'fortress',
            heiler: 'healing',
            stratege: 'assignment',
            mentor: 'school',
            kommandant: 'military_tech',
            provokateur: 'record_voice_over',
        };

        const SCHWAECHE_DATA = [
            { id: 'hoehenangst', name: 'Höhenangst', bedeutung: 'Probleme mit exponierten Höhen, Abgründen, Seilwegen.', wuerfel: 'Erschwerte Proben bei Klettern, Balancieren, Abseilen.', trigger: 'Brücken, Masten, Klippen, Luftschiffe, Dächer.' },
            { id: 'platzangst', name: 'Platzangst', bedeutung: 'Enge, schlecht einsehbare Räume beeinträchtigen Handlungen.', wuerfel: 'Erschwerte Proben in Schächten, Tunneln, Wracks.', trigger: 'Höhlen, Gefängnisse, Geheimgänge, Trümmer.' },
            { id: 'seekrank', name: 'Seekrank', bedeutung: 'Instabil auf schwankendem Untergrund.', wuerfel: 'Erschwerte Proben auf Schiffen oder Plattformen bei Wellengang.', trigger: 'Seereisen, Sturm, Gefechte auf Deck.' },
            { id: 'schlechte-sicht', name: 'Schlechte Sicht', bedeutung: 'Eingeschränkte Wahrnehmung von Details und Entfernungen.', wuerfel: 'Erschwertes Zielen, Entdecken, präzise Aktionen.', trigger: 'Dämmerung, Rauch, Nebel, Regen, Dunkelheit.' },
            { id: 'gleichgewicht', name: 'Schlechter Gleichgewichtssinn', bedeutung: 'Instabil auf unebenem oder schmalem Untergrund.', wuerfel: 'Erschwerte Balance- und Akrobatikproben.', trigger: 'Seile, schmale Stege, vereiste Flächen, Decks.' },
            { id: 'ausdauer', name: 'Geringe Ausdauer', bedeutung: 'Erschöpfung tritt schneller ein als bei anderen.', wuerfel: 'Nach längeren Aktionen zusätzliche Erschwernisse.', trigger: 'Verfolgungen, Märsche, Dauerbelastung, Hitze.' },
            { id: 'reaktion', name: 'Langsame Reaktion', bedeutung: 'Verzögertes Handeln in plötzlichen Situationen.', wuerfel: 'Nachteil bei Reaktionen auf überraschende Ereignisse.', trigger: 'Hinterhalte, einstürzende Gebäude, plötzliche Angriffe.' },
            { id: 'feinmotorik', name: 'Ungeschickte Feinmotorik', bedeutung: 'Probleme bei sehr präzisen, filigranen Tätigkeiten.', wuerfel: 'Erschwerte Proben bei Schlössern, Fallen, Mechanik.', trigger: 'Zeitkritische Infiltration, Sabotage, Entschärfen.' },
            { id: 'zittrig', name: 'Zittrige Hände unter Stress', bedeutung: 'Präzision leidet bei Gefahr oder Zeitdruck.', wuerfel: 'Erschwertes Zielen oder Arbeiten unter Bedrohung.', trigger: 'Gefechte, Tickende Fallen, Countdown-Situationen.' },
            { id: 'verletzungen', name: 'Anfällig für Verletzungen', bedeutung: 'Treffer oder Stürze haben stärkere Folgen.', wuerfel: 'Zusätzliche Konsequenzen bei Fehlschlägen.', trigger: 'Kämpfe, Stürze, Explosionen, schwere Treffer.' },
            { id: 'hitze', name: 'Hitzeempfindlich', bedeutung: 'Leistung sinkt bei hohen Temperaturen.', wuerfel: 'Erschwerte körperliche Proben bei Hitze.', trigger: 'Wüsten, Maschinenräume, Feuer, Tropen.' },
            { id: 'kaelte', name: 'Kälteempfindlich', bedeutung: 'Steife Bewegungen und schnellere Erschöpfung.', wuerfel: 'Erschwerte Proben bei Kälte oder Nässe.', trigger: 'Schnee, Eis, Regen, Nachtwachen.' },
            { id: 'reizueberflutung', name: 'Reizüberflutung', bedeutung: 'Viele Eindrücke gleichzeitig überfordern.', wuerfel: 'Erschwerte Wahrnehmungs- und Reaktionsproben bei Chaos.', trigger: 'Schlachten, Märkte, Explosionen, Panik.' },
            { id: 'orientierung', name: 'Schlechte Orientierung', bedeutung: 'Schwierigkeiten, Wege und Richtungen zu behalten.', wuerfel: 'Erschwerte Orientierung und Navigation.', trigger: 'Dschungel, Städte, Nebel, unbekanntes Terrain.' },
            { id: 'geraeusch', name: 'Geräuschempfindlich', bedeutung: 'Lärm stört Konzentration massiv.', wuerfel: 'Erschwerte Proben bei Krach oder Echo.', trigger: 'Maschinen, Schlachten/Kämpfe, Gewitter, Werkstätten.' },
            { id: 'griff', name: 'Schwacher Griff', bedeutung: 'Probleme, Halt zu bewahren oder etwas festzuhalten.', wuerfel: 'Erschwerte Proben bei Klettern, Festhalten, Abfangen.', trigger: 'Stürze, Seilaktionen, Kämpfe an Abgründen.' }
        ];

        // ===== STATE =====
        let characterData = {};
        let currencyIndex = 0;
        let selectedFokusType = null;
        let selectedFokusAbilities = [];
        let selectedSchwaeche = null;
        let saveTimeout = null;
        let _lastLocalSaveTime = 0;

        // ===== INIT =====
        const EMPTY_SKILL = () => ({ name: '', value: 0, proficient: true });
        const DEFAULT_SKILLS_COUNT = 8;
        
        function getDefaultCharacter() {
            return {
                name: '', race: '', age: '', gender: '', rang: 'common', role: '', crew: '',
                portrait: null, jollyRoger: null,
                initiative: 0,
                rangeType: '1',
                armorType: '0',
                attributes: { power: 0, agility: 0, endurance: 0, mind: 0, presence: 0 },
                health: { current: 100, max: 100 },
                moral: { current: 100, max: 100 },
                secondChance: [false, false, false],
                skills: { 
                    handeln: Array(DEFAULT_SKILLS_COUNT).fill(null).map(EMPTY_SKILL),
                    wissen: Array(DEFAULT_SKILLS_COUNT).fill(null).map(EMPTY_SKILL),
                    soziales: Array(DEFAULT_SKILLS_COUNT).fill(null).map(EMPTY_SKILL)
                },
                fokus: { type: null, abilities: [] },
                schwaeche: null,
                appearance: '', inventory: '', currency: '', currencyType: 'dollar', weapon: '', notes: ''
            };
        }

        function init() {
            loadCharacter();
            populateFields();
            initializeSkills();
            updateAllCalculations();
            
            // Update main character button state
            setTimeout(() => updateMainCharButton(), 100);
            
            // Initialize Firestore sync AFTER loading character
            setTimeout(() => {
                initializeFirestoreSync();
            }, 1000);
        }
        
        // Global variable for Firestore unsubscribe
        let firestoreCharListener = null;
        
        async function initializeFirestoreSync() {
            // Get room code from URL or localStorage
            const urlParams = new URLSearchParams(window.location.search);
            let roomCode = urlParams.get('room') || localStorage.getItem('rift_current_room');
            const charId = urlParams.get('id') || window.currentCharId;
            
            // Save roomCode to localStorage if from URL
            if (urlParams.get('room')) {
                localStorage.setItem('rift_current_room', urlParams.get('room'));
                console.log('[WA-Sheet] Saved roomCode to localStorage:', urlParams.get('room'));
            }
            
            console.log('[WA-Sheet] initializeFirestoreSync - roomCode:', roomCode, 'charId:', charId);
            
            if (!roomCode) {
                console.log('[WA-Sheet] No roomCode, Firestore sync disabled');
                return;
            }
            
            if (!charId) {
                console.log('[WA-Sheet] No charId yet, will retry...');
                setTimeout(() => initializeFirestoreSync(), 500);
                return;
            }
            
            // Initialize Firebase via RIFT if available
            if (window.RIFT?.firebase?.init) {
                try {
                    await window.RIFT.firebase.init();
                    console.log('[WA-Sheet] Firebase initialized via RIFT');
                } catch (e) {
                    console.warn('[WA-Sheet] RIFT.firebase.init failed:', e);
                }
            }
            
            // Wait for Firebase to be FULLY initialized (not just loaded)
            if (typeof firebase === 'undefined' || !firebase.apps || firebase.apps.length === 0) {
                console.log('[WA-Sheet] Firebase not initialized yet, retrying in 500ms...');
                setTimeout(() => initializeFirestoreSync(), 500);
                return;
            }
            
            // Now we can safely use firestore
            try {
                const db = firebase.firestore();
                
                // Check auth state
                const user = firebase.auth().currentUser;
                if (user) {
                    setupCharacterListener(roomCode, charId);
                } else {
                    // Wait for auth
                    console.log('[WA-Sheet] Waiting for auth...');
                    const unsubAuth = firebase.auth().onAuthStateChanged(authUser => {
                        if (authUser && !firestoreCharListener) {
                            setupCharacterListener(roomCode, charId);
                            unsubAuth(); // Unsubscribe after first auth
                        }
                    });
                }
            } catch (e) {
                console.error('[WA-Sheet] Firebase error, retrying...', e);
                setTimeout(() => initializeFirestoreSync(), 1000);
            }
        }
        
        function setupCharacterListener(roomCode, charId) {
            const normalizedCode = roomCode.replace(/-/g, '').toUpperCase();
            const db = firebase.firestore();
            
            console.log('[WA-Sheet] Setting up Firestore listener:', normalizedCode, charId);
            
            // Unsubscribe from previous
            if (firestoreCharListener) {
                firestoreCharListener();
            }
            
            // Listen to character document in room
            firestoreCharListener = db.collection('rooms').doc(normalizedCode)
                .collection('characters').doc(charId)
                .onSnapshot(doc => {
                    if (!doc.exists) {
                        console.log('[WA-Sheet] Character doc does not exist in room');
                        return;
                    }
                    
                    const serverData = doc.data();
                    
                    // Skip echo of our own saves (within 2s window)
                    if (Date.now() - _lastLocalSaveTime < 2000) {
                        // Still process if GM sent changes from a different client
                        const isRemoteGM = serverData.lastModifiedBy === 'gm' && !window.isGMViewMode;
                        if (!isRemoteGM) {
                            return;
                        }
                    }
                    
                    handleServerUpdate(serverData);
                    
                }, error => {
                    console.error('[WA-Sheet] Firestore listener error:', error);
                });
            
            console.log('[WA-Sheet] Firestore listener active');
        }
        
        // Track if this is the first update (to skip initial sync)
        let isFirstUpdate = true;
        let lastServerHealth = null;
        let lastServerMoral = null;
        let gmModeListener = null;
        
        // Setup GM Mode bidirectional listener
        function setupGMModeBidirectionalListener() {
            if (!window.isGMViewMode) return;
            
            const roomCode = window.gmViewRoomCode;
            const charId = window.gmViewCharId;
            
            if (!roomCode || !charId) return;
            
            console.log('[WA-Sheet GM] Setting up bidirectional listener');
            
            const db = firebase.firestore();
            
            // Listen for player changes
            gmModeListener = db.collection('rooms').doc(roomCode)
                .collection('characters').doc(charId)
                .onSnapshot(doc => {
                    if (!doc.exists) return;
                    
                    const serverData = doc.data();
                    
                    // Only update if change was from player, not GM
                    if (serverData.lastModifiedBy !== 'gm') {
                        console.log('[WA-Sheet GM] Player made change - updating view');
                        handleGMViewUpdate(serverData);
                    }
                }, err => {
                    console.error('[WA-Sheet GM] Listener error:', err);
                });
        }
        
        // Handle updates when GM is viewing player sheet
        function handleGMViewUpdate(serverData) {
            const d = serverData.data || {};
            let updated = false;
            
            // Update health
            if (d.status?.health !== undefined && d.status.health !== characterData.health.current) {
                characterData.health.current = d.status.health;
                const healthInput = document.getElementById('health-current');
                const healthBar = document.getElementById('health-bar');
                if (healthInput) healthInput.value = d.status.health;
                if (healthBar) {
                    const maxHP = getMaxHealth();
                    const pct = maxHP > 0 ? (d.status.health / maxHP) * 100 : 0;
                    healthBar.style.width = `${Math.min(100, Math.max(0, pct))}%`;
                }
                updated = true;
            }
            
            // Update moral
            if (d.status?.moral !== undefined && d.status.moral !== characterData.moral.current) {
                characterData.moral.current = d.status.moral;
                const moralInput = document.getElementById('moral-current');
                const moralBar = document.getElementById('moral-bar');
                if (moralInput) moralInput.value = d.status.moral;
                if (moralBar) moralBar.style.width = `${Math.min(100, Math.max(0, d.status.moral))}%`;
                updated = true;
            }
            
            // Update rang
            if (d.rang !== undefined && d.rang !== characterData.rang) {
                characterData.rang = d.rang;
                const rangSelect = document.getElementById('char-rang');
                if (rangSelect) rangSelect.value = d.rang;
                updateHealthDisplay();
                updated = true;
            }
            
            // Update initiative
            if (d.initiative !== undefined && d.initiative !== characterData.initiative) {
                characterData.initiative = d.initiative;
                const initInput = document.getElementById('char-initiative');
                if (initInput) initInput.value = d.initiative;
                updated = true;
            }
            
            // Update rangeType
            if (d.rangeType !== undefined && d.rangeType !== characterData.rangeType) {
                characterData.rangeType = d.rangeType;
                const rangeSelect = document.getElementById('range-type');
                if (rangeSelect) rangeSelect.value = d.rangeType;
                updated = true;
            }
            
            // Update armorType
            if (d.armorType !== undefined && d.armorType !== characterData.armorType) {
                characterData.armorType = d.armorType;
                const armorSelect = document.getElementById('armor-type');
                if (armorSelect) armorSelect.value = d.armorType;
                updateArmorDisplay();
                updated = true;
            }
            
            // Update attributes
            if (d.attributes) {
                ['power', 'agility', 'endurance', 'mind', 'presence'].forEach(attr => {
                    if (d.attributes[attr] !== undefined && d.attributes[attr] !== characterData.attributes[attr]) {
                        characterData.attributes[attr] = d.attributes[attr];
                        const input = document.getElementById(`attr-${attr}`);
                        if (input) input.value = d.attributes[attr];
                        updated = true;
                    }
                });
            }
            
            // Update other fields
            if (d.currency !== undefined && d.currency !== characterData.currency) {
                characterData.currency = d.currency;
                const currInput = document.getElementById('char-currency');
                if (currInput) currInput.value = d.currency;
                updated = true;
            }
            
            if (d.inventory !== undefined && d.inventory !== characterData.inventory) {
                characterData.inventory = d.inventory;
                const invInput = document.getElementById('char-inventory');
                if (invInput) invInput.value = d.inventory;
                updated = true;
            }
            
            if (d.notes !== undefined && d.notes !== characterData.notes) {
                characterData.notes = d.notes;
                const notesInput = document.getElementById('char-notes');
                if (notesInput) notesInput.value = d.notes;
                updated = true;
            }
            
            if (d.weapon !== undefined && d.weapon !== characterData.weapon) {
                characterData.weapon = d.weapon;
                const weaponInput = document.getElementById('char-weapon');
                if (weaponInput) weaponInput.value = d.weapon;
                updated = true;
            }
            
            if (updated) {
                console.log('[WA-Sheet GM] View updated with player changes');
                if (typeof updateAllCalculations === 'function') {
                    updateAllCalculations();
                }
                
                // Flash the banner to show update
                const banner = document.querySelector('[style*="GM-Ansicht"]');
                if (banner) {
                    banner.style.background = 'rgba(59, 130, 246, 0.9)';
                    banner.innerHTML = '🔄 Spieler hat geändert!';
                    setTimeout(() => {
                        banner.style.background = 'rgba(139,92,246,0.9)';
                        banner.innerHTML = '👑 GM-Ansicht (Live-Sync aktiv)';
                    }, 2000);
                }
            }
        }
        
        function handleServerUpdate(serverData) {
            const d = serverData.data || {};
            
            // Get HP/Health from multiple possible locations
            let serverHealth = null;
            if (d.status?.health !== undefined) {
                serverHealth = parseInt(d.status.health);
            } else if (serverData.hp !== undefined) {
                serverHealth = parseInt(serverData.hp);
            }
            
            // Get Moral from multiple possible locations  
            let serverMoral = null;
            if (d.status?.moral !== undefined) {
                serverMoral = parseInt(d.status.moral);
            } else if (serverData.moral !== undefined) {
                serverMoral = parseInt(serverData.moral);
            }
            
            console.log('[WA-Sheet] handleServerUpdate:', {
                isFirstUpdate,
                serverHealth,
                serverMoral,
                lastServerHealth,
                lastServerMoral,
                localHealth: characterData.health.current,
                localMoral: characterData.moral.current
            });
            
            // On first update, just record the values
            if (isFirstUpdate) {
                console.log('[WA-Sheet] First update - recording baseline');
                lastServerHealth = serverHealth;
                lastServerMoral = serverMoral;
                isFirstUpdate = false;
                return;
            }
            
            let updated = false;
            let changes = [];
            
            // Update health if server value differs from local OR from last server value
            const localHealth = characterData.health.current;
            if (serverHealth !== null && (serverHealth !== lastServerHealth || serverHealth !== localHealth)) {
                console.log('[WA-Sheet] ⚡ Health update:', { lastServer: lastServerHealth, server: serverHealth, local: localHealth });
                characterData.health.current = serverHealth;
                
                const healthInput = document.getElementById('health-current');
                const healthBar = document.getElementById('health-bar');
                console.log('[WA-Sheet] Health elements:', { input: !!healthInput, bar: !!healthBar });
                if (healthInput) {
                    healthInput.value = serverHealth;
                    console.log('[WA-Sheet] Set health input to:', serverHealth);
                }
                if (healthBar) {
                    const maxHP = getMaxHealth();
                    const pct = maxHP > 0 ? (serverHealth / maxHP) * 100 : 0;
                    healthBar.style.width = `${Math.min(100, Math.max(0, pct))}%`;
                }
                
                lastServerHealth = serverHealth;
                updated = true;
                changes.push('LP');
            }
            
            // Update moral if server value differs from local OR from last server value
            const localMoral = characterData.moral.current;
            if (serverMoral !== null && (serverMoral !== lastServerMoral || serverMoral !== localMoral)) {
                console.log('[WA-Sheet] ⚡ Moral update:', { lastServer: lastServerMoral, server: serverMoral, local: localMoral });
                characterData.moral.current = serverMoral;
                
                const moralInput = document.getElementById('moral-current');
                const moralBar = document.getElementById('moral-bar');
                console.log('[WA-Sheet] Moral elements:', { input: !!moralInput, bar: !!moralBar });
                if (moralInput) {
                    moralInput.value = serverMoral;
                    console.log('[WA-Sheet] Set moral input to:', serverMoral);
                }
                if (moralBar) moralBar.style.width = `${Math.min(100, Math.max(0, serverMoral))}%`;
                
                lastServerMoral = serverMoral;
                updated = true;
                changes.push('Moral');
            }
            
            // Check if this update was from GM (full sync)
            if (serverData.lastModifiedBy === 'gm') {
                console.log('[WA-Sheet] ⚡ GM modification detected - full sync');
                
                // Always update health/moral from GM regardless of comparison
                if (d.status?.health !== undefined) {
                    const gmHealth = parseInt(d.status.health);
                    if (gmHealth !== characterData.health.current) {
                        console.log('[WA-Sheet] GM Health force update:', characterData.health.current, '->', gmHealth);
                        characterData.health.current = gmHealth;
                        const healthInput = document.getElementById('health-current');
                        const healthBar = document.getElementById('health-bar');
                        if (healthInput) healthInput.value = gmHealth;
                        if (healthBar) {
                            const maxHP = getMaxHealth();
                            const pct = maxHP > 0 ? (gmHealth / maxHP) * 100 : 0;
                            healthBar.style.width = `${Math.min(100, Math.max(0, pct))}%`;
                        }
                        lastServerHealth = gmHealth;
                        if (!changes.includes('LP')) changes.push('LP');
                        updated = true;
                    }
                }
                
                if (d.status?.moral !== undefined) {
                    const gmMoral = parseInt(d.status.moral);
                    if (gmMoral !== characterData.moral.current) {
                        console.log('[WA-Sheet] GM Moral force update:', characterData.moral.current, '->', gmMoral);
                        characterData.moral.current = gmMoral;
                        const moralInput = document.getElementById('moral-current');
                        const moralBar = document.getElementById('moral-bar');
                        if (moralInput) moralInput.value = gmMoral;
                        if (moralBar) moralBar.style.width = `${Math.min(100, Math.max(0, gmMoral))}%`;
                        lastServerMoral = gmMoral;
                        if (!changes.includes('Moral')) changes.push('Moral');
                        updated = true;
                    }
                }
                
                // Sync attributes
                if (d.attributes) {
                    const attrChanged = JSON.stringify(d.attributes) !== JSON.stringify(characterData.attributes);
                    if (attrChanged) {
                        characterData.attributes = { ...d.attributes };
                        changes.push('Attribute');
                        updated = true;
                        
                        // Update attribute inputs
                        ['power', 'agility', 'endurance', 'mind', 'presence'].forEach(attr => {
                            const input = document.getElementById(`attr-${attr}`);
                            if (input && d.attributes[attr] !== undefined) {
                                input.value = d.attributes[attr];
                            }
                        });
                    }
                }
                
                // Sync rang
                if (d.rang !== undefined && d.rang !== characterData.rang) {
                    characterData.rang = d.rang;
                    const rangSelect = document.getElementById('char-rang');
                    if (rangSelect) rangSelect.value = d.rang;
                    updateHealthDisplay();
                    changes.push('Rang');
                    updated = true;
                }
                
                // Sync initiative
                if (d.initiative !== undefined && d.initiative !== characterData.initiative) {
                    characterData.initiative = d.initiative;
                    const initInput = document.getElementById('char-initiative');
                    if (initInput) initInput.value = d.initiative;
                    changes.push('Initiative');
                    updated = true;
                }
                
                // Sync rangeType
                if (d.rangeType !== undefined && d.rangeType !== characterData.rangeType) {
                    characterData.rangeType = d.rangeType;
                    const rangeSelect = document.getElementById('range-type');
                    if (rangeSelect) rangeSelect.value = d.rangeType;
                    changes.push('Reichweite');
                    updated = true;
                }
                
                // Sync armorType
                if (d.armorType !== undefined && d.armorType !== characterData.armorType) {
                    characterData.armorType = d.armorType;
                    const armorSelect = document.getElementById('armor-type');
                    if (armorSelect) armorSelect.value = d.armorType;
                    updateArmorDisplay();
                    changes.push('Rüstung');
                    updated = true;
                }
                
                // Sync currency
                if (d.currency !== undefined && d.currency !== characterData.currency) {
                    characterData.currency = d.currency;
                    const currInput = document.getElementById('currency-amount');
                    if (currInput) currInput.value = d.currency;
                    changes.push('Währung');
                    updated = true;
                }
                
                // Sync inventory
                if (d.inventory && JSON.stringify(d.inventory) !== JSON.stringify(characterData.inventory)) {
                    characterData.inventory = [...d.inventory];
                    if (typeof renderInventory === 'function') renderInventory();
                    changes.push('Inventar');
                    updated = true;
                }
                
                // Sync notes
                if (d.notes !== undefined && d.notes !== characterData.notes) {
                    characterData.notes = d.notes;
                    const notesEl = document.getElementById('notes');
                    if (notesEl) notesEl.value = d.notes;
                    changes.push('Notizen');
                    updated = true;
                }
                
                // Sync Second Chance
                if (d.secondChance && JSON.stringify(d.secondChance) !== JSON.stringify(characterData.secondChance)) {
                    characterData.secondChance = [...d.secondChance];
                    if (typeof updateSecondChanceUI === 'function') updateSecondChanceUI();
                    changes.push('Zweite Chance');
                    updated = true;
                }
            }
            
            // Track if this was a GM change for the notification
            const isGMChange = serverData.lastModifiedBy === 'gm';
            
            if (updated) {
                console.log('[WA-Sheet] ✅ UI updated! Changes:', changes.join(', '), 'From GM:', isGMChange);
                
                // Update calculations
                if (typeof updateAllCalculations === 'function') {
                    updateAllCalculations();
                }
                
                // Update visual status bars
                if (typeof updateStatusBars === 'function') {
                    updateStatusBars();
                }
                
                // Only show flash effect and toast if change was from GM
                if (isGMChange) {
                    // Flash effect to show update - find the status section
                    const statusSection = document.querySelector('.status-section') || document.querySelector('.status-bars') || document.querySelector('[class*="status"]');
                    if (statusSection) {
                        statusSection.style.transition = 'box-shadow 0.3s, transform 0.3s';
                        statusSection.style.boxShadow = '0 0 30px rgba(139,92,246,0.9)';
                        statusSection.style.transform = 'scale(1.02)';
                        setTimeout(() => {
                            statusSection.style.boxShadow = '';
                            statusSection.style.transform = '';
                        }, 1500);
                    }
                    
                    // Toast notification - more specific message
                    const changeMsg = changes.length > 0 ? ` (${changes.join(', ')})` : '';
                    if (window.RIFT?.ui?.Toast) {
                        RIFT.ui.Toast.info(`👑 GM hat geändert:${changeMsg}`);
                    } else {
                        // Fallback: create a simple toast
                        const toast = document.createElement('div');
                        toast.style.cssText = 'position:fixed;bottom:20px;left:50%;transform:translateX(-50%);background:#8b5cf6;color:white;padding:12px 24px;border-radius:8px;font-size:14px;z-index:100000;box-shadow:0 4px 12px rgba(0,0,0,0.3);';
                        toast.textContent = `👑 GM hat geändert:${changeMsg}`;
                        document.body.appendChild(toast);
                        setTimeout(() => toast.remove(), 3000);
                    }
                }
                
                // Save to localStorage
                localStorage.setItem(STORAGE_KEY, JSON.stringify(characterData));
            }
        }

        function loadCharacter() {
            // URL-Parameter auslesen
            const urlParams = new URLSearchParams(window.location.search);
            const paramId = urlParams.get('id');
            const isNew = urlParams.get('new') === 'true';
            const isGM = urlParams.get('gm') === 'true';
            const roomCode = urlParams.get('room') || localStorage.getItem('rift_current_room');
            
            if (isNew) {
                // Neuer Charakter - leerer Bogen
                console.log('[WA-Sheet] Creating new character');
                characterData = getDefaultCharacter();
                // Alten localStorage löschen
                localStorage.removeItem(STORAGE_KEY);
                
                if (window.RIFT?.ui?.Toast) {
                    setTimeout(() => RIFT.ui.Toast.info('Neuer Worlds Apart Charakter'), 500);
                }
                return;
            }
            
            if (paramId) {
                // Erst aus CharacterStorage laden versuchen
                console.log('[WA-Sheet] Loading character from storage:', paramId);
                const char = CharacterStorage.getById(paramId);
                
                if (char && char.data) {
                    // Daten aus CharacterStorage in characterData konvertieren
                    loadCharacterFromData(char);
                    return;
                } else if (roomCode) {
                    // Nicht in localStorage gefunden - versuche aus Firestore zu laden (für GM-Ansicht)
                    console.log('[WA-Sheet] Character not in localStorage, trying Firestore...', paramId, roomCode);
                    loadCharacterFromFirestore(paramId, roomCode, isGM);
                    return;
                } else {
                    console.error('[WA-Sheet] Character not found:', paramId);
                    if (window.RIFT?.ui?.Toast) {
                        setTimeout(() => RIFT.ui.Toast.error('Charakter nicht gefunden'), 500);
                    }
                    // Zurück zur Übersicht
                    setTimeout(() => window.location.href = 'sheet.html', 2000);
                    characterData = getDefaultCharacter();
                    return;
                }
            }
            
            // Fallback: Altes localStorage System (für Kompatibilität)
            const saved = localStorage.getItem(STORAGE_KEY);
            characterData = saved ? { ...getDefaultCharacter(), ...JSON.parse(saved) } : getDefaultCharacter();
            
            // Try to find/set character ID for consistency with CharacterStorage
            if (typeof CharacterStorage !== 'undefined' && characterData.name) {
                // First check if we have a stored ID in the legacy data
                if (characterData._charId) {
                    window.currentCharId = characterData._charId;
                    console.log('[WA-Sheet] Using stored legacy char ID:', window.currentCharId);
                } else {
                    // Try to find existing character by name in CharacterStorage
                    const all = CharacterStorage.getAll();
                    const existing = Object.values(all).find(c => 
                        c.name === characterData.name && c.ruleset === 'worldsapart'
                    );
                    if (existing) {
                        window.currentCharId = existing.id;
                        // Store ID in legacy data for future loads
                        characterData._charId = existing.id;
                        localStorage.setItem(STORAGE_KEY, JSON.stringify(characterData));
                        console.log('[WA-Sheet] Found existing char in storage:', window.currentCharId);
                    } else {
                        console.log('[WA-Sheet] No existing char found, will create new on save');
                    }
                }
            }
            
            // Ensure minimum skills exist
            ['handeln', 'wissen', 'soziales'].forEach(cat => {
                if (!characterData.skills[cat]) characterData.skills[cat] = [];
                while (characterData.skills[cat].length < DEFAULT_SKILLS_COUNT) {
                    characterData.skills[cat].push(EMPTY_SKILL());
                }
            });
        }
        
        function loadCharacterFromData(char) {
            // Daten aus CharacterStorage in characterData konvertieren
            characterData = getDefaultCharacter();
            characterData.name = char.name || '';
            
            // data-Felder übernehmen
            const d = char.data;
            characterData.race = d.race || char.race || '';
            characterData.age = d.age || '';
            characterData.gender = d.gender || '';
            characterData.rang = d.rang || 'common';
            characterData.initiative = d.initiative || 0;
            characterData.rangeType = d.rangeType || '1';
            characterData.armorType = d.armorType || '0';
            characterData.role = d.role || char.class || '';
            characterData.crew = d.crew || '';
            characterData.appearance = d.appearance || '';
            characterData.inventory = d.inventory || '';
            characterData.currency = d.currency || '';
            characterData.weapon = d.weapon || '';
            characterData.notes = d.notes || '';
            
            if (d.attributes) {
                characterData.attributes = { ...characterData.attributes, ...d.attributes };
            }
            if (d.status) {
                characterData.health.current = d.status.health || 100;
                characterData.moral.current = d.status.moral || 100;
            }
            if (d.skills) {
                characterData.skills = d.skills;
            }
            if (d.fokus) {
                characterData.fokus = d.fokus;
            }
            if (d.schwaeche) {
                characterData.schwaeche = d.schwaeche;
            }
            if (d.portrait) {
                characterData.portrait = d.portrait;
            }
            if (d.jollyRoger) {
                characterData.jollyRoger = d.jollyRoger;
            }
            if (d.secondChance) {
                characterData.secondChance = d.secondChance;
            }
            
            // Charakter-ID merken für späteren Save
            window.currentCharId = char.id;
            CharacterStorage.updateLastPlayed(char.id);
            
            if (window.RIFT?.ui?.Toast) {
                setTimeout(() => RIFT.ui.Toast.success(`${char.name} geladen`), 500);
            }
        }
        
        async function loadCharacterFromFirestore(charId, roomCode, isGM) {
            console.log('[WA-Sheet] Loading from Firestore:', charId, roomCode, 'isGM:', isGM);
            
            // Set GM view mode globally
            if (isGM) {
                window.isGMViewMode = true;
                window.gmViewRoomCode = roomCode;
                window.gmViewCharId = charId;
                console.log('[WA-Sheet] GM View Mode enabled');
            }
            
            // Wait for Firebase to be ready
            if (window.RIFT?.firebase?.init) {
                try {
                    await window.RIFT.firebase.init();
                } catch (e) {
                    console.warn('[WA-Sheet] Firebase init error:', e);
                }
            }
            
            // Check if Firebase is available
            if (typeof firebase === 'undefined' || !firebase.apps || firebase.apps.length === 0) {
                console.error('[WA-Sheet] Firebase not available');
                if (window.RIFT?.ui?.Toast) {
                    RIFT.ui.Toast.error('Firebase nicht verfügbar');
                }
                characterData = getDefaultCharacter();
                populateFields();
                return;
            }
            
            try {
                const db = firebase.firestore();
                const normalizedCode = roomCode.replace(/-/g, '').toUpperCase();
                window.gmViewRoomCode = normalizedCode; // Store normalized version
                
                const charDoc = await db.collection('rooms').doc(normalizedCode)
                    .collection('characters').doc(charId).get();
                
                if (charDoc.exists) {
                    const charData = charDoc.data();
                    console.log('[WA-Sheet] Loaded from Firestore:', charData);
                    
                    // Store original ownerId for GM mode
                    if (isGM) {
                        window.gmViewOwnerId = charData.ownerId;
                    }
                    
                    // Convert to expected format and load
                    loadCharacterFromData({
                        id: charId,
                        name: charData.name,
                        data: charData.data || charData,
                        class: charData.class
                    });
                    
                    // Re-populate fields after async load
                    populateFields();
                    initializeSkills();
                    updateAllCalculations();
                    
                    // GM mode indicator and listener
                    if (isGM) {
                        // Add GM popup mode class to hide navigation/footer
                        document.body.classList.add('gm-popup-mode');
                        
                        // Add CSS to hide sidebar, topbar, footer, page-header
                        const gmStyle = document.createElement('style');
                        gmStyle.textContent = `
                            .gm-popup-mode .nav-sidebar,
                            .gm-popup-mode .topbar,
                            .gm-popup-mode .site-footer,
                            .gm-popup-mode footer,
                            .gm-popup-mode #gmPlayerBar,
                            .gm-popup-mode .adventure-bar,
                            .gm-popup-mode .page-header,
                            .gm-popup-mode [class*="sidebar"],
                            .gm-popup-mode [class*="topbar"],
                            .gm-popup-mode [class*="footer"]:not(.card-footer) {
                                display: none !important;
                            }
                            .gm-popup-mode .main-content,
                            .gm-popup-mode .sheet-container,
                            .gm-popup-mode .main,
                            .gm-popup-mode .main__content,
                            .gm-popup-mode main {
                                margin-left: 0 !important;
                                padding-left: 16px !important;
                                padding-right: 16px !important;
                                padding-top: 16px !important;
                                margin-top: 0 !important;
                                max-width: 100% !important;
                                width: 100% !important;
                            }
                            .gm-popup-mode .app {
                                padding-left: 0 !important;
                            }
                            .gm-popup-mode body,
                            .gm-popup-mode {
                                padding-top: 0 !important;
                                overflow-x: hidden;
                            }
                            /* Banner oben links statt oben rechts */
                            .gm-popup-mode .gm-banner {
                                position: fixed;
                                top: 8px;
                                left: 8px;
                                right: auto;
                            }
                        `;
                        document.head.appendChild(gmStyle);
                        
                        const gmBanner = document.createElement('div');
                        gmBanner.className = 'gm-banner';
                        gmBanner.style.cssText = 'position:fixed;top:10px;right:10px;background:rgba(139,92,246,0.9);color:white;padding:8px 16px;border-radius:8px;font-size:13px;z-index:1000;pointer-events:none;';
                        gmBanner.innerHTML = '👑 GM-Ansicht';
                        document.body.appendChild(gmBanner);
                        
                        // Start bidirectional listener for GM
                        setupGMModeBidirectionalListener();
                    }
                } else {
                    console.error('[WA-Sheet] Character not found in Firestore:', charId);
                    if (window.RIFT?.ui?.Toast) {
                        RIFT.ui.Toast.error('Charakter nicht gefunden');
                    }
                    characterData = getDefaultCharacter();
                    populateFields();
                }
            } catch (e) {
                console.error('[WA-Sheet] Firestore error:', e);
                if (window.RIFT?.ui?.Toast) {
                    RIFT.ui.Toast.error('Fehler beim Laden');
                }
                characterData = getDefaultCharacter();
                populateFields();
            }
        }

        function saveCharacter() {
            _lastLocalSaveTime = Date.now();
            // Legacy: Speichere auch ins alte localStorage für Kompatibilität
            localStorage.setItem(STORAGE_KEY, JSON.stringify(characterData));
            
            // GM View Mode: Speichere direkt nach Firestore
            if (window.isGMViewMode && window.gmViewRoomCode && window.gmViewCharId) {
                console.log('[WA-Sheet] GM Mode - saving to Firestore');
                saveCharacterToFirestore();
                // NICHT returnen - auch lokal speichern für Fallback
            }
            
            // Ins neue CharacterStorage System speichern (falls vorhanden)
            if (typeof CharacterStorage !== 'undefined' && !window.isGMViewMode) {
                // Check if portrait is custom (base64) or use a preset
                let portraitValue = characterData.portrait;
                if (!portraitValue) {
                    // No custom portrait - use random preset
                    portraitValue = 'char_worldsapart_0' + (Math.floor(Math.random() * 7) + 1);
                }
                
                const charForStorage = {
                    id: window.currentCharId || null,
                    ruleset: 'worldsapart',
                    name: characterData.name || 'Unbenannt',
                    class: characterData.role || 'Pirat',
                    race: characterData.race || '',
                    level: 1,
                    portrait: portraitValue,
                    data: {
                        race: characterData.race,
                        age: characterData.age,
                        gender: characterData.gender,
                        rang: characterData.rang,
                        initiative: characterData.initiative,
                        rangeType: characterData.rangeType,
                        armorType: characterData.armorType,
                        crew: characterData.crew,
                        role: characterData.role,
                        appearance: characterData.appearance,
                        attributes: characterData.attributes,
                        status: {
                            health: characterData.health.current,
                            moral: characterData.moral.current
                        },
                        currency: characterData.currency,
                        weapon: characterData.weapon,
                        inventory: characterData.inventory,
                        notes: characterData.notes,
                        skills: characterData.skills,
                        fokus: characterData.fokus,
                        schwaeche: characterData.schwaeche,
                        portrait: characterData.portrait || null,
                        jollyRoger: characterData.jollyRoger || null,
                        secondChance: characterData.secondChance || [false, false, false]
                    }
                };
                
                // Nur speichern wenn Name vorhanden
                if (characterData.name && characterData.name.trim() !== '') {
                    const saved = CharacterStorage.save(charForStorage);
                    if (saved && !window.currentCharId) {
                        window.currentCharId = saved.id;
                        // URL aktualisieren
                        const newUrl = `sheet-worldsapart.html?id=${saved.id}`;
                        window.history.replaceState({}, '', newUrl);
                    }
                    // Note: CharacterStorage.save() already calls syncToRoom() automatically
                    // for Multi-Character Support via Firestore
                }
            }
            
            // Dispatch custom event for real-time updates (e.g. Dock)
            window.dispatchEvent(new CustomEvent('rift-character-saved', {
                detail: { characterData, charId: window.currentCharId }
            }));
        }
        
        // GM Mode: Speichere Änderungen direkt nach Firestore
        async function saveCharacterToFirestore() {
            if (!window.isGMViewMode) {
                console.log('[WA-Sheet GM] Not in GM mode, skipping');
                return;
            }
            
            const roomCode = window.gmViewRoomCode;
            const charId = window.gmViewCharId;
            
            console.log('[WA-Sheet GM] Saving to Firestore:', roomCode, charId);
            
            // Ensure Firebase is initialized
            if (typeof firebase === 'undefined') {
                console.error('[WA-Sheet GM] Firebase SDK not loaded');
                return;
            }
            
            // Initialize Firebase if needed
            if (!firebase.apps || firebase.apps.length === 0) {
                console.log('[WA-Sheet GM] Initializing Firebase...');
                if (window.RIFT?.firebase?.init) {
                    try {
                        await window.RIFT.firebase.init();
                    } catch (e) {
                        console.error('[WA-Sheet GM] Firebase init failed:', e);
                        return;
                    }
                } else {
                    console.error('[WA-Sheet GM] No Firebase init function');
                    return;
                }
            }
            
            try {
                const db = firebase.firestore();
                const charRef = db.collection('rooms').doc(roomCode)
                                 .collection('characters').doc(charId);
                
                // Build complete data object with ALL fields
                const updateData = {
                    name: characterData.name || 'Unbenannt',
                    class: characterData.role || 'Pirat',
                    data: {
                        age: characterData.age,
                        gender: characterData.gender,
                        rang: characterData.rang,
                        initiative: characterData.initiative,
                        rangeType: characterData.rangeType,
                        armorType: characterData.armorType,
                        crew: characterData.crew,
                        role: characterData.role,
                        appearance: characterData.appearance,
                        attributes: characterData.attributes,
                        status: {
                            health: characterData.health.current,
                            moral: characterData.moral.current
                        },
                        currency: characterData.currency,
                        weapon: characterData.weapon,
                        inventory: characterData.inventory,
                        notes: characterData.notes,
                        skills: characterData.skills,
                        fokus: characterData.fokus,
                        schwaeche: characterData.schwaeche,
                        portrait: characterData.portrait || null,
                        jollyRoger: characterData.jollyRoger || null,
                        secondChance: characterData.secondChance || [false, false, false]
                    },
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp(),
                    lastModifiedBy: 'gm'
                };
                
                await charRef.update(updateData);
                console.log('[WA-Sheet GM] ✅ Saved to Firestore successfully');
                
                // Visual feedback
                const banner = document.querySelector('[style*="GM-Ansicht"]');
                if (banner) {
                    banner.style.background = 'rgba(34, 197, 94, 0.9)';
                    banner.innerHTML = '👑 Gespeichert!';
                    setTimeout(() => {
                        banner.style.background = 'rgba(139,92,246,0.9)';
                        banner.innerHTML = '👑 GM-Ansicht (Live-Sync aktiv)';
                    }, 1000);
                }
                
            } catch (e) {
                console.error('[WA-Sheet GM] Firestore save error:', e);
                // Show error
                const banner = document.querySelector('[style*="GM-Ansicht"]');
                if (banner) {
                    banner.style.background = 'rgba(239, 68, 68, 0.9)';
                    banner.innerHTML = '❌ Speicherfehler!';
                    setTimeout(() => {
                        banner.style.background = 'rgba(139,92,246,0.9)';
                        banner.innerHTML = '👑 GM-Ansicht (Live-Sync aktiv)';
                    }, 2000);
                }
            }
        }

        function autoSave() {
            if (saveTimeout) clearTimeout(saveTimeout);
            saveTimeout = setTimeout(() => {
                saveCharacter();
                showSaveIndicator();
            }, 500);
        }

        function showSaveIndicator() {
            const indicator = document.getElementById('save-indicator');
            indicator.classList.add('show');
            setTimeout(() => indicator.classList.remove('show'), 1500);
        }

        function populateFields() {
            document.getElementById('char-name').value = characterData.name || '';
            document.getElementById('char-race').value = characterData.race || '';
            document.getElementById('char-age').value = characterData.age || '';
            document.getElementById('char-gender').value = characterData.gender || '';
            document.getElementById('char-rang').value = characterData.rang || 'common';
            document.getElementById('char-initiative').value = characterData.initiative || 0;
            document.getElementById('range-type').value = characterData.rangeType || '1';
            document.getElementById('armor-type').value = characterData.armorType || '0';
            document.getElementById('char-role').value = characterData.role || '';
            document.getElementById('char-crew').value = characterData.crew || '';
            document.getElementById('char-appearance').value = characterData.appearance || '';
            document.getElementById('char-inventory').value = characterData.inventory || '';
            document.getElementById('char-currency').value = characterData.currency || '';
            document.getElementById('char-weapon').value = characterData.weapon || '';
            document.getElementById('char-notes').value = characterData.notes || '';
            
            ATTRIBUTES.forEach(attr => {
                document.getElementById(`attr-${attr}`).value = characterData.attributes[attr] || 0;
            });
            
            document.getElementById('health-current').value = characterData.health.current;
            document.getElementById('moral-current').value = characterData.moral.current;
            
            characterData.secondChance.forEach((used, i) => {
                if (used) document.getElementById(`dice-${i+1}`).classList.add('used');
            });
            
            if (characterData.portrait) {
                document.getElementById('portrait-img').src = characterData.portrait;
                document.getElementById('portrait-img').style.display = 'block';
                document.getElementById('portrait-placeholder').style.display = 'none';
            }
            
            if (characterData.jollyRoger) {
                document.getElementById('crew-flag-img').src = characterData.jollyRoger;
                document.getElementById('crew-flag-img').style.display = 'block';
                document.getElementById('crew-flag-placeholder').style.display = 'none';
            }
            
            updateFokusDisplay();
            updateSchwaecheDisplay();
            
            if (characterData.currencyType) {
                currencyIndex = CURRENCY_TYPES.indexOf(characterData.currencyType);
                if (currencyIndex === -1) currencyIndex = 0;
                document.getElementById('currency-icon').src = `assets/icons/icon_${CURRENCY_TYPES[currencyIndex]}.png`;
            }
        }

        // ===== EVENT LISTENERS =====
        document.addEventListener('DOMContentLoaded', function() {
            init();
            
            // Preload fokus descriptions (async, non-blocking)
            loadFokusDescriptions().then(() => {
                // Re-render fokus display if descriptions loaded after initial render
                if (characterData.fokus?.type) updateFokusDisplay();
            });
            
            // Text inputs
            ['char-name', 'char-role', 'char-crew', 'char-appearance', 'char-inventory', 'char-weapon', 'char-notes'].forEach(id => {
                document.getElementById(id).addEventListener('input', (e) => {
                    const key = id.replace('char-', '');
                    characterData[key] = e.target.value;
                    autoSave();
                });
            });
            
            // Select dropdowns
            ['char-race', 'char-age', 'char-gender'].forEach(id => {
                document.getElementById(id).addEventListener('change', (e) => {
                    const key = id.replace('char-', '');
                    characterData[key] = e.target.value;
                    autoSave();
                });
            });
            
            // Rang dropdown - triggers HP recalculation
            document.getElementById('char-rang').addEventListener('change', (e) => {
                const oldMax = getMaxHealth();
                characterData.rang = e.target.value;
                const newMax = getMaxHealth();
                
                // Scale current HP proportionally to new max
                if (oldMax > 0) {
                    const ratio = characterData.health.current / oldMax;
                    characterData.health.current = Math.round(ratio * newMax);
                } else {
                    characterData.health.current = newMax;
                }
                
                // Clamp to new max
                characterData.health.current = Math.max(0, Math.min(newMax, characterData.health.current));
                document.getElementById('health-current').value = characterData.health.current;
                
                // Sync tracked max
                _prevMaxHP = newMax;
                
                updateHealthDisplay();
                updateStatBars();
                updateMovementAndRange();
                autoSave();
            });
            
            ATTRIBUTES.forEach(attr => {
                document.getElementById(`attr-${attr}`).addEventListener('input', (e) => {
                    let value = parseInt(e.target.value) || 0;
                    value = Math.max(0, Math.min(5, value));
                    if (value === characterData.attributes[attr]) {
                        e.target.value = value;
                        return; // No change, skip all recalculations
                    }
                    e.target.value = value;
                    characterData.attributes[attr] = value;
                    updateAllCalculations();
                    autoSave();
                });
            });
            
            // Initiative manual edit
            document.getElementById('char-initiative').addEventListener('input', (e) => {
                let value = parseInt(e.target.value) || 0;
                value = Math.max(0, value);
                e.target.value = value;
                characterData.initiative = value;
                autoSave();
            });
            
            // Range type selector
            document.getElementById('range-type').addEventListener('change', (e) => {
                characterData.rangeType = e.target.value;
                autoSave();
            });
            
            // Armor type selector
            document.getElementById('armor-type').addEventListener('change', (e) => {
                characterData.armorType = e.target.value;
                updateArmorDisplay();
                updateMovementAndRange();
                autoSave();
            });
            
            document.getElementById('health-current').addEventListener('input', (e) => {
                const maxHP = getMaxHealth();
                let value = parseInt(e.target.value) || 0;
                value = Math.max(0, Math.min(maxHP, value));
                e.target.value = value;
                characterData.health.current = value;
                updateStatBars();
                autoSave();
            });
            
            document.getElementById('moral-current').addEventListener('input', (e) => {
                let value = parseInt(e.target.value) || 0;
                value = Math.max(0, Math.min(100, value));
                e.target.value = value;
                characterData.moral.current = value;
                updateStatBars();
                autoSave();
            });
            
            // ===== STATUS BAR DRAG FUNCTIONALITY =====
            const draggableBars = document.querySelectorAll('.status-bar.draggable');
            let isDragging = false;
            let currentBar = null;
            
            function updateStatusFromPosition(bar, clientX) {
                const rect = bar.getBoundingClientRect();
                let percent = ((clientX - rect.left) / rect.width) * 100;
                percent = Math.max(0, Math.min(100, Math.round(percent)));
                
                const statusType = bar.dataset.status;
                if (statusType === 'health') {
                    const maxHP = getMaxHealth();
                    const value = Math.round((percent / 100) * maxHP);
                    characterData.health.current = value;
                    document.getElementById('health-current').value = value;
                    document.getElementById('health-bar').style.width = `${percent}%`;
                } else if (statusType === 'moral') {
                    characterData.moral.current = percent;
                    document.getElementById('moral-current').value = percent;
                    document.getElementById('moral-bar').style.width = `${percent}%`;
                }
                updateStatBars();
            }
            
            draggableBars.forEach(bar => {
                // Mouse events
                bar.addEventListener('mousedown', (e) => {
                    isDragging = true;
                    currentBar = bar;
                    updateStatusFromPosition(bar, e.clientX);
                    e.preventDefault();
                });
                
                // Touch events
                bar.addEventListener('touchstart', (e) => {
                    isDragging = true;
                    currentBar = bar;
                    updateStatusFromPosition(bar, e.touches[0].clientX);
                    e.preventDefault();
                }, { passive: false });
            });
            
            document.addEventListener('mousemove', (e) => {
                if (isDragging && currentBar) {
                    updateStatusFromPosition(currentBar, e.clientX);
                }
            });
            
            document.addEventListener('touchmove', (e) => {
                if (isDragging && currentBar) {
                    updateStatusFromPosition(currentBar, e.touches[0].clientX);
                }
            }, { passive: true });
            
            document.addEventListener('mouseup', () => {
                if (isDragging) {
                    isDragging = false;
                    currentBar = null;
                    autoSave();
                }
            });
            
            document.addEventListener('touchend', () => {
                if (isDragging) {
                    isDragging = false;
                    currentBar = null;
                    autoSave();
                }
            });
            
            // Initialize dice history
            setTimeout(() => {
                checkForDiceResult();
                renderDiceHistory();
            }, 100);
        }); // End DOMContentLoaded

        // ===== CALCULATIONS =====
        // Track previous max HP for auto-scaling
        let _prevMaxHP = null;
        
        let _calcRAF = null;
        function updateAllCalculations() {
            const newMax = getMaxHealth();
            if (_prevMaxHP !== null && characterData.health.current >= _prevMaxHP && newMax !== _prevMaxHP) {
                characterData.health.current = newMax;
                const healthInput = document.getElementById('health-current');
                if (healthInput) healthInput.value = newMax;
            }
            _prevMaxHP = newMax;
            
            updateAttributePoints();
            updateResonanz();
            updateStatBars();
            updateSkillBonuses();
            updateMovementAndRange();
            updateArmorDisplay();
            
            // Lightweight fokus number patch instead of full DOM rebuild
            if (_calcRAF) cancelAnimationFrame(_calcRAF);
            _calcRAF = requestAnimationFrame(() => {
                _calcRAF = null;
                updateFokusValues();
            });
        }
        
        // Lightweight: only update numeric values in existing fokus ability cards
        function updateFokusValues() {
            const fokusType = characterData.fokus?.type;
            if (!fokusType || fokusType === 'none' || !FOKUS_DATA[fokusType]) return;
            
            const data = FOKUS_DATA[fokusType];
            const attrKey = FOKUS_ATTRIBUTE_MAP[fokusType];
            const attrValue = characterData.attributes[attrKey] || 0;
            const resonanz = 10 + ((characterData.attributes.mind || 0) * (characterData.attributes.presence || 0));
            const resonanzBonus = Math.floor(resonanz / 10);
            
            // Update header RES text
            const attrEl = document.getElementById('fokus-attr');
            if (attrEl) attrEl.innerHTML = `Haupt-Attribut: ${data.mainAttr} &middot; RES-Bonus: +${resonanzBonus}`;
            
            // Update each ability card's tags and tooltip in-place
            const cards = document.querySelectorAll('#fokus-abilities .fokus-ability:not(.empty):not(.no-fokus-message)');
            const allAbilities = [...data.attacks, ...data.defenses];
            
            cards.forEach(card => {
                const nameEl = card.querySelector('.fokus-ability-name');
                if (!nameEl) return;
                const name = nameEl.textContent;
                const ab = allAbilities.find(a => a.name === name);
                if (!ab) return;
                
                const abAttrKey = ATTR_FROM_LABEL[ab.attr] || '';
                const abAttrVal = characterData.attributes[abAttrKey] || 0;
                const totalMod = abAttrVal + resonanzBonus;
                
                // Patch tag text
                const tags = card.querySelectorAll('.fokus-ability-tag');
                if (tags[0]) tags[0].textContent = `${ab.dice} + ${totalMod}`;
                
                // Rebuild tooltip (cheaper than full card rebuild)
                const tooltipEl = card.querySelector('.fokus-ability-tooltip');
                if (tooltipEl) {
                    const iconColor = data.color || 'var(--text-secondary)';
                    const diceNum = parseInt((ab.dice || 'd6').replace('d',''));
                    const minDmg = 1 + totalMod;
                    const maxDmg = diceNum + totalMod;
                    const avgDmg = ((diceNum + 1) / 2 + totalMod).toFixed(1);
                    const diceTier = {6:'Basis',8:'Standard',10:'Stark',12:'Schwer',20:'Verzweiflung'}[diceNum] || '';
                    const rng = parseInt(ab.range || 0);
                    const rangeLabel = rng <= 1 ? 'Nahkampf' : rng <= 2 ? 'Nahbereich' : rng <= 4 ? 'Mittel' : rng <= 8 ? 'Fern' : 'Scharfsch\u00fctze';
                    const avgNet4 = Math.max(0, parseFloat(avgDmg) - 4).toFixed(1);
                    const avgNet8 = Math.max(0, parseFloat(avgDmg) - 8).toFixed(1);
                    
                    let statusTooltip = '';
                    if (ab.status) {
                        const threshold = parseInt(ab.status.match(/\d+/)?.[0] || 0);
                        if (threshold > 0) {
                            const hitChance = Math.max(0, Math.min(100, ((maxDmg - threshold + 1) / diceNum * 100))).toFixed(0);
                            const warn = parseInt(hitChance) === 0 ? `<div style="color:#e03131;font-size:10px;margin-top:2px;">\u26a0 Unerreichbar mit diesem Build</div>` : '';
                            statusTooltip = `<div class="tt-row"><span class="tt-l">Status</span><span class="tt-v">${hitChance}%  (\u2265${threshold})</span></div>${warn}`;
                        }
                    }
                    
                    const descData = getFokusDesc(fokusType, name);
                    const descHtml = buildDescTooltipHtml(descData);
                    
                    tooltipEl.innerHTML = `<div style="display:flex;align-items:center;gap:6px;padding:8px 12px;background:${iconColor}10;border-bottom:1px solid ${iconColor}25;font-size:11px;"><span style="color:${iconColor};font-weight:600;">${ab.dice}</span><span style="opacity:0.3;">\u2022</span><span>${diceTier}</span><span style="opacity:0.3;">\u2022</span><span>${rangeLabel}</span></div><div style="padding:8px 12px;display:flex;flex-direction:column;gap:3px;font-size:11px;"><div class="tt-row"><span class="tt-l">Formel</span><span class="tt-v">${ab.attr} ${abAttrVal} + RES ${resonanzBonus}</span></div><div class="tt-row"><span class="tt-l">Schaden</span><span class="tt-v">${minDmg}\u2013${maxDmg} (\u00d8 ${avgDmg})</span></div><div style="height:1px;background:rgba(255,255,255,0.06);margin:3px 0;"></div><div class="tt-row"><span class="tt-l">vs DR 4</span><span class="tt-v">\u00d8 ${avgNet4}</span></div><div class="tt-row"><span class="tt-l">vs DR 8</span><span class="tt-v">\u00d8 ${avgNet8}</span></div>${statusTooltip}</div>${descHtml}`;
                }
            });
        }
        
        // ===== DICE HISTORY =====
        const DICE_HISTORY_KEY = 'rift_dice_history';
        const MAX_HISTORY_ITEMS = 10;
        
        function getDiceHistory() {
            const charId = window.currentCharId;
            if (!charId) return [];
            const key = `${DICE_HISTORY_KEY}_${charId}`;
            const stored = localStorage.getItem(key);
            return stored ? JSON.parse(stored) : [];
        }
        
        function saveDiceHistory(history) {
            const charId = window.currentCharId;
            if (!charId) return;
            const key = `${DICE_HISTORY_KEY}_${charId}`;
            localStorage.setItem(key, JSON.stringify(history.slice(0, MAX_HISTORY_ITEMS)));
        }
        
        function addDiceHistoryEntry(entry) {
            const history = getDiceHistory();
            history.unshift({
                ...entry,
                timestamp: Date.now()
            });
            saveDiceHistory(history);
            renderDiceHistory();
        }
        window.addDiceHistoryEntry = addDiceHistoryEntry;
        
        function clearDiceHistory() {
            const charId = window.currentCharId;
            if (!charId) return;
            const key = `${DICE_HISTORY_KEY}_${charId}`;
            localStorage.removeItem(key);
            renderDiceHistory();
            if (window.RIFT?.ui?.Toast) {
                RIFT.ui.Toast.info('Würfel-Verlauf gelöscht');
            }
        }
        window.clearDiceHistory = clearDiceHistory;
        
        function renderDiceHistory() {
            const container = document.getElementById('dice-history-list');
            if (!container) return;
            
            const history = getDiceHistory();
            
            if (history.length === 0) {
                container.innerHTML = '<div class="dice-history-empty">Noch keine Würfe in dieser Session</div>';
                return;
            }
            
            container.innerHTML = history.map(entry => {
                const timeAgo = getTimeAgo(entry.timestamp);
                const resultClass = entry.success ? 'success' : 'failure';
                const itemClass = entry.critical ? 'critical' : resultClass;
                
                return `
                    <div class="dice-history-item ${itemClass}">
                        <span class="dice-history-label">${entry.label}</span>
                        <span class="dice-history-result ${resultClass}">${entry.result}</span>
                        <span class="dice-history-outcome ${resultClass}">${entry.outcome}</span>
                        <span class="dice-history-time">${timeAgo}</span>
                    </div>
                `;
            }).join('');
        }
        
        function getTimeAgo(timestamp) {
            const diff = Date.now() - timestamp;
            const mins = Math.floor(diff / 60000);
            const hours = Math.floor(diff / 3600000);
            
            if (mins < 1) return 'gerade';
            if (mins < 60) return `${mins}m`;
            if (hours < 24) return `${hours}h`;
            return new Date(timestamp).toLocaleDateString('de-DE');
        }
        
        // Check for returning dice result
        function checkForDiceResult() {
            const params = new URLSearchParams(window.location.search);
            const zweiteChance = params.get('zweiteChance');
            const diceIndex = params.get('diceIndex');
            const success = params.get('success');
            const diceLabel = params.get('label');
            const diceResult = params.get('result');
            
            // Handle Initiative result
            if (diceLabel === 'Initiative' && diceResult !== null) {
                const total = parseInt(diceResult) || 0;
                characterData.initiative = total;
                document.getElementById('char-initiative').value = total;
                autoSave();
                
                if (window.RIFT?.ui?.Toast) {
                    RIFT.ui.Toast.success(`Initiative: ${total}`);
                }
                
                // Clean URL
                const cleanParams = new URLSearchParams();
                if (params.get('roomCode')) cleanParams.set('roomCode', params.get('roomCode'));
                if (params.get('id')) cleanParams.set('id', params.get('id'));
                const cleanUrl = window.location.pathname + (cleanParams.toString() ? '?' + cleanParams.toString() : '');
                window.history.replaceState({}, document.title, cleanUrl);
                return;
            }
            
            // Handle Zweite Chance result - mark dice as used
            if (zweiteChance === 'true' && diceIndex !== null) {
                const idx = parseInt(diceIndex);
                markDiceAsUsed(idx);
                
                // Show toast with result
                if (window.RIFT?.ui?.Toast) {
                    if (success === 'true') {
                        RIFT.ui.Toast.success('Zweite Chance: Wiederholen erlaubt!');
                    } else {
                        RIFT.ui.Toast.error('Zweite Chance: Fehlschlag bleibt!');
                    }
                }
                
                // Clean URL - keep only essential params
                const cleanParams = new URLSearchParams();
                if (params.get('roomCode')) cleanParams.set('roomCode', params.get('roomCode'));
                if (params.get('id')) cleanParams.set('id', params.get('id'));
                const cleanUrl = window.location.pathname + (cleanParams.toString() ? '?' + cleanParams.toString() : '');
                window.history.replaceState({}, document.title, cleanUrl);
            }
        }
        
        // Mark a Zweite Chance dice as used with dissolve animation
        function markDiceAsUsed(index) {
            const diceEl = document.getElementById(`dice-${index + 1}`);
            if (!diceEl || diceEl.classList.contains('used')) return;
            
            // Add dissolving animation
            diceEl.classList.add('dissolving');
            
            // After animation, add used class
            setTimeout(() => {
                diceEl.classList.remove('dissolving');
                diceEl.classList.add('used');
                
                // Update characterData
                characterData.secondChance[index] = true;
                autoSave();
            }, 800);
        }
        window.markDiceAsUsed = markDiceAsUsed;
        
        // GM Function: Reset all Zweite Chance dice
        function resetZweiteChance() {
            // Check if user is GM
            let isGM = false;
            try {
                let user = typeof getCurrentUser === 'function' ? getCurrentUser() : null;
                if (!user) {
                    const userData = localStorage.getItem('pnp_companion_user');
                    if (userData) user = JSON.parse(userData);
                }
                isGM = user?.isGM === true || user?.isGM === 'true';
            } catch(e) {
                isGM = false;
            }
            
            if (!isGM) {
                if (window.RIFT?.ui?.Toast) {
                    RIFT.ui.Toast.error('Nur der GM kann Zweite Chance wiederherstellen');
                }
                return;
            }
            
            // Reset all dice with restore animation
            for (let i = 0; i < 3; i++) {
                const diceEl = document.getElementById(`dice-${i + 1}`);
                if (diceEl && diceEl.classList.contains('used')) {
                    // Add restore animation
                    diceEl.classList.add('restoring');
                    
                    setTimeout(() => {
                        diceEl.classList.remove('used', 'restoring');
                    }, 400);
                }
            }
            
            // Update characterData
            characterData.secondChance = [false, false, false];
            autoSave();
            
            if (window.RIFT?.ui?.Toast) {
                RIFT.ui.Toast.success('Zweite Chance wiederhergestellt!');
            }
        }
        window.resetZweiteChance = resetZweiteChance;
        
        function updateAttributePoints() {
            let total = ATTRIBUTES.reduce((sum, attr) => sum + (characterData.attributes[attr] || 0), 0);
            const remaining = ATTR_TOTAL - total;
            const el = document.getElementById('attr-points');
            const textEl = document.getElementById('attr-points-text');
            
            if (remaining === 0) {
                textEl.textContent = 'Alle Attributs-Punkte verteilt';
                el.style.background = 'var(--accent-primary-dim)';
                el.style.color = 'var(--accent-primary)';
            } else if (remaining < 0) {
                textEl.textContent = `${Math.abs(remaining)} Punkte zu viel vergeben!`;
                el.style.background = 'var(--accent-primary-dim)';
                el.style.color = 'var(--accent-primary)';
            } else {
                textEl.textContent = `${remaining} / ${ATTR_TOTAL} Attributs-Punkte zu verteilen`;
                el.style.background = 'rgba(34, 197, 94, 0.15)';
                el.style.color = 'var(--color-green)';
            }
        }
        
        function updateResonanz() {
            const mind = characterData.attributes.mind || 0;
            const presence = characterData.attributes.presence || 0;
            const resonanz = 10 + (mind * presence);
            document.getElementById('resonanz-display').textContent = resonanz;
            document.getElementById('resonanz-bar').style.width = `${Math.min(resonanz, 100)}%`;
            
            // Update tooltip with formula
            const container = document.getElementById('resonanz-container');
            if (container) {
                container.title = `10 + (${mind} × ${presence}) = ${resonanz}`;
            }
            
            // Update initiative formula display (Resonanz / 5, abgerundet)
            updateInitiativeFormula();
        }
        
        // ===== INITIATIVE =====
        function getResonanzBonus() {
            const mind = characterData.attributes.mind || 0;
            const presence = characterData.attributes.presence || 0;
            const resonanz = 10 + (mind * presence);
            return Math.floor(resonanz / 5);
        }
        
        function updateInitiativeFormula() {
            const bonus = getResonanzBonus();
            const mind = characterData.attributes.mind || 0;
            const presence = characterData.attributes.presence || 0;
            const resonanz = 10 + (mind * presence);
            const formulaEl = document.getElementById('initiative-formula');
            if (formulaEl) {
                formulaEl.title = `Resonanz(${resonanz}) / 5 = +${bonus}`;
            }
        }
        
        function rollInitiative() {
            const bonus = getResonanzBonus();
            const currentVal = characterData.initiative || 0;
            
            // If no value set yet, roll inline and fill the field
            if (currentVal === 0) {
                const roll = Math.floor(Math.random() * 20) + 1;
                const total = roll + bonus;
                characterData.initiative = total;
                document.getElementById('char-initiative').value = total;
                autoSave();
                
                if (window.RIFT?.ui?.Toast) {
                    RIFT.ui.Toast.success(`Initiative: ${roll} + ${bonus} = ${total}`);
                }
                
                // Add to dice history
                addDiceHistoryEntry({
                    label: 'Initiative',
                    dice: 'W20',
                    roll: roll,
                    mod: bonus,
                    result: total,
                    outcome: `W20(${roll}) + ${bonus}`,
                    success: true
                });
                return;
            }
            
            // If value already set, navigate to dice.html for full roll
            const params = new URLSearchParams({
                dice: 'd20',
                mod: bonus,
                label: 'Initiative',
                roll: '1',
                return: buildReturnUrl()
            });
            
            window.location.href = `dice.html?${params.toString()}`;
        }
        window.rollInitiative = rollInitiative;
        
        // ===== MOVEMENT & RANGE =====
        function calculateMovement() {
            const ges = characterData.attributes.agility || 0;
            const armorMalus = { '0': 0, '2': 1, '4': 2, '6': 4 };
            const malus = armorMalus[characterData.armorType] || 0;
            return Math.max(1, 5 + Math.floor(ges / 2) - malus);
        }
        
        function calculateRangeBonus() {
            const mind = characterData.attributes.mind || 0;
            const presence = characterData.attributes.presence || 0;
            const resonanz = 10 + (mind * presence);
            return Math.floor(resonanz / 10);
        }
        
        function updateMovementAndRange() {
            const movement = calculateMovement();
            const movEl = document.getElementById('movement-value');
            if (movEl) movEl.textContent = movement;
            
            const bonus = calculateRangeBonus();
            const bonusEl = document.getElementById('range-bonus-display');
            if (bonusEl) bonusEl.textContent = `+${bonus} RES-Bonus`;
        }
        
        // ===== ARMOR =====
        function getResonanceShield() {
            const mind = characterData.attributes.mind || 0;
            const presence = characterData.attributes.presence || 0;
            const resonanz = 10 + (mind * presence);
            return Math.floor(resonanz / 10);
        }
        
        function updateArmorDisplay() {
            const armorDR = parseInt(characterData.armorType) || 0;
            const resShield = getResonanceShield();
            const totalDR = armorDR + resShield;
            
            const drEl = document.getElementById('armor-dr-display');
            const resEl = document.getElementById('armor-res-display');
            const totalEl = document.getElementById('armor-total-display');
            
            if (drEl) drEl.textContent = armorDR;
            if (resEl) resEl.textContent = resShield;
            if (totalEl) totalEl.textContent = totalDR;
        }
        
        function updateHealthDisplay() {
            const maxHP = getMaxHealth();
            const maxEl = document.getElementById('health-max-display');
            if (maxEl) maxEl.textContent = maxHP;
            
            // Update input max attribute
            const healthInput = document.getElementById('health-current');
            if (healthInput) healthInput.max = maxHP;
            
            // Update formula tooltip
            const rang = characterData.rang || 'common';
            const rangMod = RANG_MODIFIERS[rang] || 0;
            const zaeh = characterData.attributes.endurance || 0;
            const container = document.getElementById('health-container');
            if (container) {
                container.title = `100 + ${rangMod} (Rang) + ${zaeh} × 5 (ZÄH) = ${maxHP}`;
            }
        }
        
        function updateStatBars() {
            const maxHP = getMaxHealth();
            const healthPercent = maxHP > 0 ? (characterData.health.current / maxHP) * 100 : 0;
            const healthBar = document.getElementById('health-bar');
            healthBar.style.width = `${Math.min(100, Math.max(0, healthPercent))}%`;
            
            // Update max display
            updateHealthDisplay();
            
            // Dynamic health bar color: 100-51% Green, 50-16% Orange, 15-1% Red, 0 Black
            if (characterData.health.current === 0) {
                healthBar.style.background = '#1a1a1a';
                healthBar.style.backgroundSize = '100% 100%';
            } else if (healthPercent <= 15) {
                healthBar.style.background = 'linear-gradient(90deg, #8b0000, #dc2626, #8b0000)';
                healthBar.style.backgroundSize = '200% 100%';
            } else if (healthPercent <= 50) {
                healthBar.style.background = 'linear-gradient(90deg, #b45309, #f59e0b, #b45309)';
                healthBar.style.backgroundSize = '200% 100%';
            } else {
                healthBar.style.background = 'linear-gradient(90deg, #166534, #22c55e, #166534)';
                healthBar.style.backgroundSize = '200% 100%';
            }
            
            // Update portrait health overlay
            const overlay = document.getElementById('portrait-health-overlay');
            overlay.classList.remove('dead', 'critical', 'low', 'healthy');
            if (characterData.health.current === 0) {
                overlay.classList.add('dead');
            } else if (healthPercent <= 15) {
                overlay.classList.add('critical');
            } else if (healthPercent <= 50) {
                overlay.classList.add('low');
            } else {
                overlay.classList.add('healthy');
            }
            
            // Update status bar critical states
            if (healthBar) {
                healthBar.classList.toggle('critical', healthPercent <= 20 && characterData.health.current > 0);
            }
            
            const moralPercent = characterData.moral.current;
            const moralBar = document.getElementById('moral-bar');
            moralBar.style.width = `${moralPercent}%`;
            
            // Add critical pulse for low moral
            if (moralBar) {
                moralBar.classList.toggle('critical', moralPercent <= 20 && moralPercent > 0);
            }
        }
        
        function calculateClassBonus(category) {
            return (CLASS_ATTRIBUTE_MAP[category] || []).reduce((sum, attr) => sum + (characterData.attributes[attr] || 0), 0);
        }
        
        function updateSkillBonuses() {
            let totalSkillPoints = 0;
            
            ['handeln', 'wissen', 'soziales'].forEach(category => {
                const skills = characterData.skills[category] || [];
                const categorySpent = skills.reduce((sum, s) => sum + (parseInt(s.value) || 0), 0);
                totalSkillPoints += categorySpent;
                const classBonus = calculateClassBonus(category);
                const classTotal = Math.min(Math.floor(categorySpent / 10) + classBonus, 95);
                
                document.getElementById(`${category}-total`).textContent = classTotal;
                document.getElementById(`${category}-bonus`).textContent = `+${classBonus}`;
                
                document.querySelectorAll(`#skills-${category} .skill-bonus`).forEach(el => {
                    el.textContent = `+${classBonus}`;
                });
            });
            
            // Update total skill points display
            const remaining = SKILL_TOTAL - totalSkillPoints;
            const el = document.getElementById('skill-points');
            const textEl = document.getElementById('skill-points-text');
            
            if (remaining <= 0) {
                textEl.textContent = remaining === 0 ? 'Alle Punkte verteilt' : `${Math.abs(remaining)} Punkte zu viel!`;
                el.style.background = 'var(--accent-primary-dim)';
                el.style.color = 'var(--accent-primary)';
            } else {
                textEl.textContent = `${remaining} / ${SKILL_TOTAL} Punkte verfügbar`;
                el.style.background = 'rgba(34, 197, 94, 0.15)';
                el.style.color = 'var(--color-green)';
            }
        }

        // ===== SKILLS =====
        function initializeSkills() {
            ['handeln', 'wissen', 'soziales'].forEach(renderSkills);
        }
        
        function renderSkills(category) {
            const container = document.getElementById(`skills-${category}`);
            const skills = characterData.skills[category] || [];
            const bonus = calculateClassBonus(category);
            
            container.innerHTML = skills.map((skill, i) => `
                <div class="skill-row">
                    <div class="skill-prof ${skill.proficient ? 'active' : ''}" onclick="toggleSkillProf('${category}', ${i})"></div>
                    <input type="text" class="skill-name-input" value="${skill.name}" placeholder="Fähigkeit..." onchange="updateSkillName('${category}', ${i}, this.value)">
                    <input type="number" class="skill-value-input" value="${skill.value}" min="0" max="100" onchange="updateSkillValue('${category}', ${i}, this.value)" onfocus="this.select()">
                    <span class="skill-bonus">+${bonus}</span>
                    <button class="skill-roll-btn" onclick="rollSkill('${category}', ${i})" title="Würfeln">
                        <svg viewBox="0 0 24 24" fill="currentColor" width="14" height="14"><path d="M5 3h14a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2m3 12a2 2 0 0 0-2 2 2 2 0 0 0 2 2 2 2 0 0 0 2-2 2 2 0 0 0-2-2m8-8a2 2 0 0 0-2 2 2 2 0 0 0 2 2 2 2 0 0 0 2-2 2 2 0 0 0-2-2m0 8a2 2 0 0 0-2 2 2 2 0 0 0 2 2 2 2 0 0 0 2-2 2 2 0 0 0-2-2m-4-4a2 2 0 0 0-2 2 2 2 0 0 0 2 2 2 2 0 0 0 2-2 2 2 0 0 0-2-2m-4-4a2 2 0 0 0-2 2 2 2 0 0 0 2 2 2 2 0 0 0 2-2 2 2 0 0 0-2-2Z"/></svg>
                    </button>
                    <button class="skill-delete-btn" onclick="deleteSkill('${category}', ${i})" title="Löschen">×</button>
                </div>
            `).join('');
        }
        
        // Helper: Build clean return URL for dice page
        function buildReturnUrl() {
            const currentParams = new URLSearchParams(window.location.search);
            const returnParams = new URLSearchParams();
            if (currentParams.get('roomCode')) returnParams.set('roomCode', currentParams.get('roomCode'));
            if (currentParams.get('id')) returnParams.set('id', currentParams.get('id'));
            return 'sheet-worldsapart.html' + (returnParams.toString() ? '?' + returnParams.toString() : '');
        }
        
        function rollSkill(category, index) {
            const skill = characterData.skills[category][index];
            const bonus = calculateClassBonus(category);
            const totalValue = (parseInt(skill.value) || 0) + bonus;
            const skillName = skill.name || 'Skill';
            
            // Navigate to dice.html with parameters for d100 roll
            const params = new URLSearchParams({
                dice: 'd100',
                mod: totalValue,
                label: skillName,
                roll: '1',
                return: buildReturnUrl()
            });
            
            window.location.href = `dice.html?${params.toString()}`;
        }
        window.rollSkill = rollSkill;
        
        function rollZweiteChance(diceIndex) {
            // Check if this die is already used
            if (characterData.secondChance[diceIndex]) {
                if (window.RIFT?.ui?.Toast) {
                    RIFT.ui.Toast.warning('Diese Zweite Chance wurde bereits genutzt');
                }
                return;
            }
            
            // Check if any dice left
            const remaining = characterData.secondChance.filter(used => !used).length;
            if (remaining === 0) {
                if (window.RIFT?.ui?.Toast) {
                    RIFT.ui.Toast.error('Alle Zweite Chance Versuche aufgebraucht');
                }
                return;
            }
            
            // Navigate to dice.html for d20 roll
            const params = new URLSearchParams({
                dice: 'd20',
                mod: 0,
                label: 'Zweite Chance',
                check: 'zweitechance',
                diceIndex: diceIndex,
                roll: '1',
                return: buildReturnUrl()
            });
            
            window.location.href = `dice.html?${params.toString()}`;
        }
        window.rollZweiteChance = rollZweiteChance;
        
        function rollFokus(abilityName) {
            const fokusType = characterData.fokus?.type;
            if (!fokusType || fokusType === 'none') {
                if (window.RIFT?.ui?.Toast) {
                    RIFT.ui.Toast.warning('Kein Fokus gew\u00e4hlt');
                }
                return;
            }
            
            const fokusData = FOKUS_DATA[fokusType];
            const allAbilities = [...fokusData.attacks, ...fokusData.defenses];
            
            // If no specific ability, use first selected
            if (!abilityName) {
                const selected = characterData.fokus?.abilities || [];
                if (selected.length === 0) {
                    if (window.RIFT?.ui?.Toast) RIFT.ui.Toast.warning('Keine F\u00e4higkeit gew\u00e4hlt');
                    return;
                }
                abilityName = selected[0];
            }
            
            const ab = allAbilities.find(a => a.name === abilityName);
            if (!ab) return;
            
            // Map attr string to characterData key
            const attrValue = characterData.attributes[ATTR_FROM_LABEL[ab.attr] || ''] || 0;
            const resonanz = 10 + ((characterData.attributes.mind || 0) * (characterData.attributes.presence || 0));
            const resonanzBonus = Math.floor(resonanz / 10);
            const totalMod = attrValue + resonanzBonus;
            
            const params = new URLSearchParams({
                dice: ab.dice,
                mod: totalMod,
                label: `${ab.name} (${ab.attr})`,
                check: 'fokus',
                roll: '1',
                return: buildReturnUrl()
            });
            
            window.location.href = `dice.html?${params.toString()}`;
        }
        window.rollFokus = rollFokus;
        
        function deleteSkill(category, index) {
            characterData.skills[category].splice(index, 1);
            renderSkills(category);
            updateSkillBonuses();
            autoSave();
        }
        
        function toggleSkillProf(category, index) {
            characterData.skills[category][index].proficient = !characterData.skills[category][index].proficient;
            renderSkills(category);
            autoSave();
        }
        
        function addSkill(category) {
            characterData.skills[category].push({ name: '', value: 0, proficient: true });
            renderSkills(category);
            autoSave();
        }
        
        // Skill Catalog Functions
        let currentCatalogCategory = null;
        
        function openSkillCatalog(category) {
            currentCatalogCategory = category;
            renderSkillCatalog();
            document.getElementById('skill-catalog-popup').classList.add('active');
        }
        
        function closeSkillCatalog() {
            document.getElementById('skill-catalog-popup').classList.remove('active');
            currentCatalogCategory = null;
        }
        
        function renderSkillCatalog() {
            const container = document.getElementById('catalog-grid');
            const catalogSkills = SKILL_CATALOG[currentCatalogCategory] || [];
            const existingSkills = characterData.skills[currentCatalogCategory].map(s => s.name);
            
            container.innerHTML = catalogSkills.map(skill => {
                const isAdded = existingSkills.includes(skill);
                return `
                    <div class="catalog-item ${isAdded ? 'added' : ''}">
                        <span class="catalog-item-name">${skill}</span>
                        ${isAdded 
                            ? `<button class="catalog-item-btn remove" onclick="removeSkillFromCatalog('${skill}')">Entfernen</button>`
                            : `<button class="catalog-item-btn add" onclick="addSkillFromCatalog('${skill}')">Übernehmen</button>`
                        }
                    </div>
                `;
            }).join('');
        }
        
        function addSkillFromCatalog(skillName) {
            // Find first empty slot
            const emptyIndex = characterData.skills[currentCatalogCategory].findIndex(s => !s.name || s.name.trim() === '');
            
            if (emptyIndex !== -1) {
                // Fill empty slot
                characterData.skills[currentCatalogCategory][emptyIndex] = { name: skillName, value: 0, proficient: true };
            } else {
                // No empty slot, add new
                characterData.skills[currentCatalogCategory].push({ name: skillName, value: 0, proficient: true });
            }
            
            renderSkills(currentCatalogCategory);
            renderSkillCatalog();
            updateSkillBonuses();
            autoSave();
        }
        
        function removeSkillFromCatalog(skillName) {
            const index = characterData.skills[currentCatalogCategory].findIndex(s => s.name === skillName);
            if (index !== -1) {
                characterData.skills[currentCatalogCategory].splice(index, 1);
                renderSkills(currentCatalogCategory);
                renderSkillCatalog();
                updateSkillBonuses();
                autoSave();
            }
        }
        
        function updateSkillName(category, index, value) {
            characterData.skills[category][index].name = value;
            autoSave();
        }
        
        function updateSkillValue(category, index, value) {
            let val = parseInt(value) || 0;
            val = Math.max(0, Math.min(100, val)); // Cap at 100
            characterData.skills[category][index].value = val;
            // Update input if capped
            const inputs = document.querySelectorAll(`#skills-${category} .skill-value-input`);
            if (inputs[index]) inputs[index].value = val;
            updateSkillBonuses();
            autoSave();
        }
        
        function switchSkillTab(category) {
            document.querySelectorAll('.skill-tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.skill-panel').forEach(p => p.classList.remove('active'));
            document.querySelector(`.skill-tab[data-category="${category}"]`).classList.add('active');
            document.getElementById(`panel-${category}`).classList.add('active');
        }

        // ===== FOKUS =====
        function updateFokusDisplay() {
            const fokusType = characterData.fokus?.type;
            const iconEl = document.getElementById('fokus-icon');
            const nameEl = document.getElementById('fokus-name');
            const attrEl = document.getElementById('fokus-attr');
            const abilitiesEl = document.getElementById('fokus-abilities');
            const layoutEl = document.querySelector('.fokus-layout');
            
            // Remove existing particles
            const existingParticles = layoutEl.querySelector('.fokus-particles');
            if (existingParticles) existingParticles.remove();
            
            // Reset header styles
            const headerEl = layoutEl.querySelector('.fokus-header');
            headerEl.style.background = '';
            headerEl.style.borderColor = '';
            
            if (fokusType && fokusType !== 'none' && FOKUS_DATA[fokusType]) {
                const data = FOKUS_DATA[fokusType];
                const iconColor = data.color || 'var(--text-secondary)';
                
                // Style header with element color gradient
                const headerEl = layoutEl.querySelector('.fokus-header');
                headerEl.style.background = `linear-gradient(180deg, ${iconColor}12 0%, transparent 100%)`;
                headerEl.style.borderColor = `${iconColor}30`;
                
                // Colored icon
                const fbIcon = FOKUS_FALLBACK_ICONS[fokusType];
                if (fbIcon) {
                    iconEl.innerHTML = `<img src="../../assets/icons/${data.icon}" alt="${data.name}" style="filter: drop-shadow(0 0 8px ${iconColor});" onerror="this.style.display='none';this.nextElementSibling.style.display='flex';">
                    <span class="material-symbols-rounded" style="display:none;width:100%;height:100%;align-items:center;justify-content:center;font-size:32px;color:${iconColor};">${fbIcon}</span>`;
                } else {
                    iconEl.innerHTML = `<img src="../../assets/icons/${data.icon}" alt="${data.name}" style="filter: drop-shadow(0 0 8px ${iconColor});">`;
                }
                iconEl.style.borderColor = iconColor;
                iconEl.style.boxShadow = `0 0 20px ${iconColor}40`;
                iconEl.style.background = `${iconColor}10`;
                
                // Add particles
                const particlesHtml = `<div class="fokus-particles">
                    <div class="fokus-particle" style="background: ${iconColor}; box-shadow: 0 0 6px ${iconColor};"></div>
                    <div class="fokus-particle" style="background: ${iconColor}; box-shadow: 0 0 6px ${iconColor};"></div>
                    <div class="fokus-particle" style="background: ${iconColor}; box-shadow: 0 0 6px ${iconColor};"></div>
                    <div class="fokus-particle" style="background: ${iconColor}; box-shadow: 0 0 6px ${iconColor};"></div>
                    <div class="fokus-particle" style="background: ${iconColor}; box-shadow: 0 0 6px ${iconColor};"></div>
                    <div class="fokus-particle" style="background: ${iconColor}; box-shadow: 0 0 6px ${iconColor};"></div>
                    <div class="fokus-particle" style="background: ${iconColor}; box-shadow: 0 0 6px ${iconColor};"></div>
                    <div class="fokus-particle" style="background: ${iconColor}; box-shadow: 0 0 6px ${iconColor};"></div>
                </div>`;
                headerEl.insertAdjacentHTML('afterbegin', particlesHtml);
                
                nameEl.textContent = data.name;
                nameEl.style.color = iconColor;
                
                // Calculate resonanz bonus
                const attrKey = FOKUS_ATTRIBUTE_MAP[fokusType];
                const attrValue = characterData.attributes[attrKey] || 0;
                const resonanz = 10 + ((characterData.attributes.mind || 0) * (characterData.attributes.presence || 0));
                const resonanzBonus = Math.floor(resonanz / 10);
                const totalBonus = attrValue + resonanzBonus;
                attrEl.innerHTML = `Haupt-Attribut: ${data.mainAttr} &middot; RES-Bonus: +${resonanzBonus}`;
                
                const abilities = characterData.fokus.abilities || [];
                const allAbilities = [...data.attacks, ...data.defenses];
                
                const STATUS_COLORS = {
                    'Brennend': '#ff6b35', 'Vergiftet': '#7cb342', 'Bet\u00e4ubt': '#ffd93d',
                    'Verlangsamt': '#4dabf7', 'Geblendet': '#f06595', 'Eingefroren': '#74c0fc',
                    'Blutend': '#e03131', 'Ersch\u00fcttert': '#9775fa', 'Markiert': '#ff922b', 'Verwirrt': '#cc5de8'
                };
                
                abilitiesEl.innerHTML = abilities.length > 0 
                    ? abilities.map(name => {
                        const ab = allAbilities.find(a => a.name === name);
                        const isAttack = data.attacks.some(a => a.name === name);
                        const escapedName = name.replace(/'/g, "\\'");
                        
                        // Pre-calculate total modifier
                        const abAttrKey = ATTR_FROM_LABEL[ab?.attr] || '';
                        const abAttrVal = characterData.attributes[abAttrKey] || 0;
                        const totalMod = abAttrVal + resonanzBonus;
                        
                        // Status styling — only show if exists
                        let statusHtml = '';
                        if (ab?.status) {
                            const statusName = ab.status.split(' ')[0];
                            const statusColor = STATUS_COLORS[statusName] || 'var(--accent-red)';
                            statusHtml = `<div class="fokus-ability-tag-status" style="background: ${statusColor}18; color: ${statusColor};">${ab.status}</div>`;
                        }
                        
                        // Dice info for tooltip
                        const diceNum = parseInt((ab?.dice || 'd6').replace('d',''));
                        const minDmg = 1 + totalMod;
                        const maxDmg = diceNum + totalMod;
                        const avgDmg = ((diceNum + 1) / 2 + totalMod).toFixed(1);
                        const diceTier = {6:'Basis',8:'Standard',10:'Stark',12:'Schwer',20:'Verzweiflung'}[diceNum] || '';
                        const rng = parseInt(ab?.range || 0);
                        const rangeLabel = rng <= 1 ? 'Nahkampf' : rng <= 2 ? 'Nahbereich' : rng <= 4 ? 'Mittel' : rng <= 8 ? 'Fern' : 'Scharfsch\u00fctze';
                        const avgNet4 = Math.max(0, parseFloat(avgDmg) - 4).toFixed(1);
                        const avgNet8 = Math.max(0, parseFloat(avgDmg) - 8).toFixed(1);
                        
                        let statusTooltip = '';
                        if (ab?.status) {
                            const threshold = parseInt(ab.status.match(/\d+/)?.[0] || 0);
                            if (threshold > 0) {
                                const hitChance = Math.max(0, Math.min(100, ((maxDmg - threshold + 1) / diceNum * 100))).toFixed(0);
                                const warn = parseInt(hitChance) === 0 ? `<div style="color:#e03131;font-size:10px;margin-top:2px;">\u26a0 Unerreichbar mit diesem Build</div>` : '';
                                statusTooltip = `<div class="tt-row"><span class="tt-l">Status</span><span class="tt-v">${hitChance}%  (\u2265${threshold})</span></div>${warn}`;
                            }
                        }
                        
                        const descData = getFokusDesc(fokusType, name);
                        const descHtml = buildDescTooltipHtml(descData);
                        const hasDescClass = descData ? ' has-desc' : '';
                        
                        const tooltip = `<div style="display:flex;align-items:center;gap:6px;padding:8px 12px;background:${iconColor}10;border-bottom:1px solid ${iconColor}25;font-size:11px;"><span style="color:${iconColor};font-weight:600;">${ab?.dice}</span><span style="opacity:0.3;">\u2022</span><span>${diceTier}</span><span style="opacity:0.3;">\u2022</span><span>${rangeLabel}</span></div><div style="padding:8px 12px;display:flex;flex-direction:column;gap:3px;font-size:11px;"><div class="tt-row"><span class="tt-l">Formel</span><span class="tt-v">${ab?.attr} ${abAttrVal} + RES ${resonanzBonus}</span></div><div class="tt-row"><span class="tt-l">Schaden</span><span class="tt-v">${minDmg}\u2013${maxDmg} (\u00d8 ${avgDmg})</span></div><div style="height:1px;background:rgba(255,255,255,0.06);margin:3px 0;"></div><div class="tt-row"><span class="tt-l">vs DR 4</span><span class="tt-v">\u00d8 ${avgNet4}</span></div><div class="tt-row"><span class="tt-l">vs DR 8</span><span class="tt-v">\u00d8 ${avgNet8}</span></div>${statusTooltip}</div>${descHtml}`;
                        
                        return `<div class="fokus-ability" onclick="rollFokus('${escapedName}')">
                            <div class="fokus-ability-type">${isAttack ? 'ANGRIFF' : 'VERTEIDIGUNG'}</div>
                            <div class="fokus-ability-name" style="color: ${iconColor};">${name}</div>
                            <div class="fokus-ability-tags">
                                <div class="fokus-ability-tag">${ab?.dice || '?'} + ${totalMod}</div>
                                <div class="fokus-ability-tag">Reichweite: ${ab?.range || '?'} Felder</div>
                            </div>
                            ${statusHtml}
                            <div class="fokus-ability-desc">${ab?.desc || ''}</div>
                            <div class="fokus-ability-tooltip${hasDescClass}">${tooltip}</div>
                        </div>`;
                    }).join('') + (abilities.length < 2 ? `<div class="fokus-ability empty" onclick="openFokusPopup()"><span>+ F\u00e4higkeit</span></div>` : '')
                    : `<div class="fokus-ability empty" onclick="openFokusPopup()"><span>Fähigkeit 1</span></div><div class="fokus-ability empty" onclick="openFokusPopup()"><span>Fähigkeit 2</span></div>`;
            } else if (fokusType === 'none') {
                iconEl.innerHTML = `<img src="../../assets/icons/icon_nofocus.png" style="opacity: 0.5;">`;
                iconEl.style.borderColor = 'var(--border-default)';
                iconEl.style.boxShadow = 'none';
                iconEl.style.background = '';
                nameEl.textContent = 'Ohne Fokus';
                nameEl.style.color = '';
                attrEl.textContent = 'Keine magischen Fähigkeiten';
                abilitiesEl.innerHTML = `<div class="fokus-ability no-fokus-message" onclick="openFokusPopup()">
                    <div class="no-fokus-text">Du hast dich entschieden, das Abenteuer ohne Fokus-F\u00e4higkeiten zu spielen.</div>
                </div>`;
            } else {
                iconEl.innerHTML = '<span style="color: var(--text-muted); font-size: 24px;">?</span>';
                iconEl.style.borderColor = 'var(--border-default)';
                iconEl.style.boxShadow = 'none';
                iconEl.style.background = '';
                nameEl.textContent = 'Kein Fokus gew\u00e4hlt';
                nameEl.style.color = '';
                attrEl.textContent = 'Klicke um zu wählen';
                abilitiesEl.innerHTML = `<div class="fokus-ability empty" onclick="openFokusPopup()"><span>Fähigkeit 1</span></div><div class="fokus-ability empty" onclick="openFokusPopup()"><span>Fähigkeit 2</span></div>`;
            }
        }
        
        
        // ===== FOKUS POPUP — MULTI-STEP =====
        let selectedFokusCategory = null; // 'element', 'weapon', 'support'
        
        const FOKUS_CATEGORIES = {
            element: { 
                label: 'Element', 
                keys: ['fire','lightning','water','wind','shadow','earth','poison','space','time','illusion','sound']
            },
            weapon: { label: 'Kampfstil', keys: ['berserker','vollstrecker','klingenmeister','scharfschuetze','assassine','waechter','gladiator','taktiker','jaeger','duellant'] },
            support: { label: 'Support', keys: ['konstrukteur','leibwaechter','feldmedikus','saboteur','bastion','heiler','stratege','mentor','kommandant','provokateur'] }
        };

        function openFokusPopup() {
            selectedFokusType = characterData.fokus?.type || null;
            selectedFokusAbilities = [...(characterData.fokus?.abilities || [])];
            
            // If already has a type, jump to step 2
            if (selectedFokusType && selectedFokusType !== 'none' && FOKUS_DATA[selectedFokusType]) {
                // Find which category this type belongs to
                for (const [cat, info] of Object.entries(FOKUS_CATEGORIES)) {
                    if (info.keys.includes(selectedFokusType)) {
                        selectedFokusCategory = cat;
                        break;
                    }
                }
                goFokusStep2(false);
            } else {
                goFokusStep1();
            }
            
            updateFokusPopupInfo();
            document.getElementById('fokus-popup').classList.add('active');
        }
        
        function closeFokusPopup() {
            document.getElementById('fokus-popup').classList.remove('active');
        }
        
        function goFokusStep1() {
            document.getElementById('fokus-step-1').classList.add('active');
            document.getElementById('fokus-step-2').classList.remove('active');
            document.getElementById('fokus-popup-title').textContent = 'Fokus wählen';
            
            // Update counts — show locked state for empty categories
            for (const [cat, info] of Object.entries(FOKUS_CATEGORIES)) {
                const countEl = document.getElementById(`fokus-cat-count-${cat}`);
                const cardEl = document.querySelector(`.fokus-cat-card[data-cat="${cat}"]`);
                if (countEl) countEl.textContent = info.keys.length > 0 ? `${info.keys.length} Stile` : 'Bald verfügbar';
                if (cardEl) {
                    if (info.keys.length === 0) cardEl.classList.add('locked');
                    else cardEl.classList.remove('locked');
                }
            }
            updateFokusPopupInfo();
        }
        
        function selectFokusCategory(cat) {
            const info = FOKUS_CATEGORIES[cat];
            if (!info || info.keys.length === 0) return;
            selectedFokusCategory = cat;
            
            // If switching category, reset selection
            if (selectedFokusType) {
                const currentCatKeys = info.keys;
                if (!currentCatKeys.includes(selectedFokusType)) {
                    selectedFokusType = null;
                    selectedFokusAbilities = [];
                }
            }
            
            goFokusStep2(true);
        }
        
        function selectFokusNone() {
            selectedFokusType = 'none';
            selectedFokusAbilities = [];
            updateFokusPopupInfo();
            confirmFokusSelection();
        }
        
        function goFokusStep2(animate) {
            document.getElementById('fokus-step-1').classList.remove('active');
            const step2 = document.getElementById('fokus-step-2');
            step2.classList.add('active');
            if (animate) step2.style.animation = 'none', step2.offsetHeight, step2.style.animation = '';
            
            const catInfo = FOKUS_CATEGORIES[selectedFokusCategory];
            document.getElementById('fokus-popup-title').textContent = catInfo?.label || 'Fokus wählen';
            
            renderFokusStyleTabs();
            
            // Auto-select first if none selected
            if (!selectedFokusType || !catInfo.keys.includes(selectedFokusType)) {
                selectFokusType(catInfo.keys[0]);
            } else {
                renderFokusStyleInfo();
                renderFokusAbilities();
            }
            updateFokusPopupInfo();
        }
        
        function renderFokusStyleTabs() {
            const catInfo = FOKUS_CATEGORIES[selectedFokusCategory];
            if (!catInfo) return;
            
            const tabsEl = document.getElementById('fokus-style-tabs');
            tabsEl.innerHTML = catInfo.keys.map(key => {
                const data = FOKUS_DATA[key];
                if (!data) return '';
                const isActive = selectedFokusType === key;
                const c = data.color || 'var(--accent-primary)';
                const activeStyle = isActive ? `style="border-color: ${c}; background: ${c}15;"` : '';
                const fbIcon = FOKUS_FALLBACK_ICONS[key] || 'star';
                return `<button class="fokus-style-tab ${isActive ? 'active' : ''}" ${activeStyle} onclick="selectFokusType('${key}')">
                    <img src="../../assets/icons/${data.icon}" alt="${data.name}" onerror="this.style.display='none';this.nextElementSibling.style.display='flex';">
                    <span class="material-symbols-rounded" style="display:none;width:28px;height:28px;align-items:center;justify-content:center;font-size:20px;color:${c};">${fbIcon}</span>
                    <span class="fokus-style-tab-name" ${isActive ? `style="color:${c};"` : ''}>${data.name}</span>
                </button>`;
            }).join('');
            
            // Scroll active tab into view
            requestAnimationFrame(() => {
                const activeTab = tabsEl.querySelector('.active');
                if (activeTab) activeTab.scrollIntoView({ behavior: 'smooth', block: 'nearest', inline: 'center' });
            });
        }
        
        function renderFokusStyleInfo() {
            const data = FOKUS_DATA[selectedFokusType];
            if (!data) { document.getElementById('fokus-style-info-bar').innerHTML = ''; return; }
            const c = data.color || 'var(--accent-primary)';
            const resonanz = 10 + ((characterData.attributes.mind || 0) * (characterData.attributes.presence || 0));
            const resonanzBonus = Math.floor(resonanz / 10);
            
            document.getElementById('fokus-style-info-bar').innerHTML = `
                <div class="fokus-style-info" style="border-color: ${c}15;">
                    <div class="fokus-style-info-icon" style="background: ${c}15;">
                        <img src="../../assets/icons/${data.icon}" alt="${data.name}">
                    </div>
                    <div class="fokus-style-info-text">
                        <div class="fokus-style-info-name" style="color: ${c};">${data.name}</div>
                        <div class="fokus-style-info-attr">Haupt-Attribut: ${data.mainAttr}</div>
                    </div>
                    <div class="fokus-style-info-formula">W&uuml;rfel + Attr + ${resonanzBonus} RES</div>
                </div>`;
        }
        
        // Legacy compat — renderFokusTypeGrid is no longer used but keep stub
        function renderFokusTypeGrid() {}
        
        function selectFokusType(type) {
            if (selectedFokusType !== type) {
                selectedFokusType = type;
                selectedFokusAbilities = [];
            }
            renderFokusStyleTabs();
            renderFokusStyleInfo();
            renderFokusAbilities();
            updateFokusPopupInfo();
        }
        
        function renderFokusAbilities() {
            const container = document.getElementById('fokus-abilities-container');
            if (!selectedFokusType || selectedFokusType === 'none') {
                container.innerHTML = selectedFokusType === 'none' ? '<p style="color: var(--text-muted); text-align: center; padding: 20px;">Ohne magische F&auml;higkeiten spielen.</p>' : '';
                return;
            }
            
            const data = FOKUS_DATA[selectedFokusType];
            const elementColor = data.color || 'var(--accent-primary)';
            
            const resonanz = 10 + ((characterData.attributes.mind || 0) * (characterData.attributes.presence || 0));
            const resonanzBonus = Math.floor(resonanz / 10);
            
            const STATUS_COLORS = {
                'Brennend': '#ff6b35', 'Vergiftet': '#7cb342', 'Bet\u00e4ubt': '#ffd93d',
                'Verlangsamt': '#4dabf7', 'Geblendet': '#f06595', 'Eingefroren': '#74c0fc',
                'Blutend': '#e03131', 'Ersch\u00fcttert': '#9775fa', 'Markiert': '#ff922b', 'Verwirrt': '#cc5de8'
            };
            
            const renderAbility = (ab) => {
                const sel = selectedFokusAbilities.includes(ab.name);
                const dis = !sel && selectedFokusAbilities.length >= 2;
                const selStyle = sel ? `style="border-color: ${elementColor}; background: ${elementColor}12;"` : '';
                
                const abAttrKey = ATTR_FROM_LABEL[ab.attr] || '';
                const abAttrVal = characterData.attributes[abAttrKey] || 0;
                const totalMod = abAttrVal + resonanzBonus;
                
                let statusTag = '';
                if (ab.status) {
                    const statusName = ab.status.split(' ')[0];
                    const sColor = STATUS_COLORS[statusName] || 'var(--accent-red)';
                    statusTag = `<span style="display:inline-block; font-size:10px; padding:2px 8px; border-radius:4px; background:${sColor}18; color:${sColor}; margin-left:6px;">${ab.status}</span>`;
                }
                
                return `<div class="fokus-ability-option ${sel ? 'selected' : ''} ${dis ? 'disabled' : ''}" ${selStyle} onclick="toggleFokusAbility('${ab.name.replace(/'/g, "\\'")}', ${dis})">
                    ${ab.pictogram ? `<img class="fokus-ability-option-picto" src="${ab.pictogram}" alt="">` : ''}
                    <div class="fokus-ability-option-name" style="color: ${sel ? elementColor : 'var(--text-primary)'};">${ab.name}</div>
                    <div style="display:flex; flex-wrap:wrap; gap:4px; margin-bottom:6px;">
                        <span style="font-family:var(--font-mono); font-size:10px; padding:2px 7px; background:rgba(255,255,255,0.06); border-radius:4px; color:var(--text-secondary);">${ab.dice}+${totalMod}</span>
                        <span style="font-family:var(--font-mono); font-size:10px; padding:2px 7px; background:rgba(255,255,255,0.06); border-radius:4px; color:var(--text-secondary);">RW ${ab.range}</span>
                        ${statusTag}
                    </div>
                    <div class="fokus-ability-option-desc">${(() => {
                        const d = getFokusDesc(selectedFokusType, ab.name);
                        return d?.detail || ab.desc;
                    })()}</div>
                </div>`;
            };
            
            container.innerHTML = `
                <div class="fokus-section-title" style="color: ${elementColor};">
                    <span>Angriffe</span>
                </div>
                <div class="fokus-ability-grid">
                    ${data.attacks.map(renderAbility).join('')}
                </div>
                <div class="fokus-section-title" style="color: ${elementColor};">
                    <span>Verteidigung</span>
                </div>
                <div class="fokus-ability-grid">
                    ${data.defenses.map(renderAbility).join('')}
                </div>
            `;
        }
        
        function toggleFokusAbility(name, disabled) {
            if (disabled) return;
            const idx = selectedFokusAbilities.indexOf(name);
            if (idx > -1) selectedFokusAbilities.splice(idx, 1);
            else if (selectedFokusAbilities.length < 2) selectedFokusAbilities.push(name);
            renderFokusAbilities();
            updateFokusPopupInfo();
        }
        
        function updateFokusPopupInfo() {
            const info = document.getElementById('fokus-selection-info');
            const btn = document.getElementById('fokus-confirm-btn');
            if (!selectedFokusType) { info.textContent = 'Wähle eine Kategorie'; btn.disabled = true; }
            else if (selectedFokusType === 'none') { info.textContent = 'Ohne Fokus spielen'; btn.disabled = false; }
            else { info.textContent = `${selectedFokusAbilities.length} / 2 Fähigkeiten`; btn.disabled = selectedFokusAbilities.length === 0; }
        }
        
        function confirmFokusSelection() {
            characterData.fokus = { type: selectedFokusType, abilities: selectedFokusType === 'none' ? [] : selectedFokusAbilities };
            updateFokusDisplay();
            closeFokusPopup();
            autoSave();
        }

        // ===== SCHWÄCHE =====
        function openSchwaechePopup() {
            selectedSchwaeche = characterData.schwaeche || null;
            renderSchwaecheGrid();
            document.getElementById('schwaeche-popup').classList.add('active');
        }

        function closeSchwaechePopup() {
            document.getElementById('schwaeche-popup').classList.remove('active');
        }

        function renderSchwaecheGrid() {
            const grid = document.getElementById('schwaeche-grid');
            grid.innerHTML = SCHWAECHE_DATA.map(s => `
                <div class="schwaeche-option ${selectedSchwaeche === s.id ? 'selected' : ''}" onclick="selectSchwaeche('${s.id}')">
                    <div class="schwaeche-option-name">${s.name}</div>
                    <div class="schwaeche-option-bedeutung">${s.bedeutung}</div>
                    <div class="schwaeche-option-wuerfel">${s.wuerfel}</div>
                    <div class="schwaeche-option-trigger">Trigger: ${s.trigger}</div>
                </div>
            `).join('');
        }

        function selectSchwaeche(id) {
            selectedSchwaeche = selectedSchwaeche === id ? null : id;
            renderSchwaecheGrid();
        }

        function clearSchwaeche() {
            selectedSchwaeche = null;
            characterData.schwaeche = null;
            updateSchwaecheDisplay();
            closeSchwaechePopup();
            autoSave();
        }

        function confirmSchwaecheSelection() {
            characterData.schwaeche = selectedSchwaeche;
            updateSchwaecheDisplay();
            closeSchwaechePopup();
            autoSave();
        }

        function updateSchwaecheDisplay() {
            const display = document.getElementById('schwaeche-display');
            const schwaeche = SCHWAECHE_DATA.find(s => s.id === characterData.schwaeche);
            
            if (schwaeche) {
                display.innerHTML = `
                    <div class="schwaeche-selected">
                        <div class="schwaeche-name">${schwaeche.name}</div>
                        <div class="schwaeche-bedeutung">${schwaeche.bedeutung}</div>
                        <div class="schwaeche-wuerfel">${schwaeche.wuerfel}</div>
                        <div class="schwaeche-trigger">Trigger: ${schwaeche.trigger}</div>
                    </div>
                `;
            } else {
                display.innerHTML = '<div class="schwaeche-empty">Keine Schwäche gewählt</div>';
            }
        }

        // ===== RAST =====
        function langeRast() {
            const btn = document.querySelector('.rast-btn.lange');
            const vignette = document.getElementById('vignette-lange');
            btn.classList.add('animating');
            vignette.classList.add('flash');
            setTimeout(() => {
                btn.classList.remove('animating');
                vignette.classList.remove('flash');
            }, 800);
            
            characterData.health.current = Math.min(getMaxHealth(), characterData.health.current + 20);
            characterData.moral.current = Math.min(100, characterData.moral.current + 10);
            document.getElementById('health-current').value = characterData.health.current;
            document.getElementById('moral-current').value = characterData.moral.current;
            updateStatBars();
            
            // Restore 1 Zweite Chance (first used one)
            let restoredChance = false;
            for (let i = 0; i < characterData.secondChance.length; i++) {
                if (characterData.secondChance[i] === true) {
                    characterData.secondChance[i] = false;
                    document.getElementById(`dice-${i+1}`).classList.remove('used');
                    restoredChance = true;
                    break;
                }
            }
            
            autoSave();
            const msg = restoredChance 
                ? 'Lange Rast: +20 LP, +10 Moral, +1 Zweite Chance'
                : 'Lange Rast: +20 LP, +10 Moral';
            showRastNotification(msg);
        }

        function kurzeRast() {
            const btn = document.querySelector('.rast-btn.kurze');
            const vignette = document.getElementById('vignette-kurze');
            btn.classList.add('animating');
            vignette.classList.add('flash');
            setTimeout(() => {
                btn.classList.remove('animating');
                vignette.classList.remove('flash');
            }, 800);
            
            characterData.health.current = Math.min(getMaxHealth(), characterData.health.current + 10);
            characterData.moral.current = Math.min(100, characterData.moral.current + 5);
            document.getElementById('health-current').value = characterData.health.current;
            document.getElementById('moral-current').value = characterData.moral.current;
            updateStatBars();
            autoSave();
            showRastNotification('Kurze Rast: +10 LP, +5 Moral');
        }

        function showRastNotification(message) {
            const indicator = document.getElementById('save-indicator');
            indicator.textContent = message;
            indicator.classList.add('active');
            setTimeout(() => indicator.classList.remove('active'), 2000);
            setTimeout(() => indicator.textContent = '✓ Gespeichert', 2500);
        }

        // ===== DICE =====
        function toggleDice(index) {
            characterData.secondChance[index] = !characterData.secondChance[index];
            document.getElementById(`dice-${index+1}`).classList.toggle('used');
            autoSave();
        }

        // ===== CURRENCY =====
        function rotateCurrency() {
            currencyIndex = (currencyIndex + 1) % CURRENCY_TYPES.length;
            characterData.currencyType = CURRENCY_TYPES[currencyIndex];
            document.getElementById('currency-icon').src = `assets/icons/icon_${CURRENCY_TYPES[currencyIndex]}.png`;
            autoSave();
        }
        
        function formatCurrency(input) {
            // Remove all non-digits
            let value = input.value.replace(/\D/g, '');
            // Format with thousands separator (dots)
            if (value) {
                value = parseInt(value, 10).toLocaleString('de-DE');
            }
            input.value = value;
            // Store raw number in characterData
            characterData.currency = value;
            autoSave();
        }

        // ===== FILE UPLOADS =====
        function compressImage(dataUrl, maxWidth, maxHeight, quality) {
            return new Promise((resolve) => {
                const img = new Image();
                img.onload = () => {
                    const canvas = document.createElement('canvas');
                    let width = img.width;
                    let height = img.height;
                    
                    // Calculate new dimensions
                    if (width > maxWidth) {
                        height = (height * maxWidth) / width;
                        width = maxWidth;
                    }
                    if (height > maxHeight) {
                        width = (width * maxHeight) / height;
                        height = maxHeight;
                    }
                    
                    canvas.width = width;
                    canvas.height = height;
                    const ctx = canvas.getContext('2d');
                    ctx.drawImage(img, 0, 0, width, height);
                    resolve(canvas.toDataURL('image/jpeg', quality));
                };
                img.src = dataUrl;
            });
        }
        
        function uploadPortrait(event) {
            const file = event.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = async (e) => {
                // Compress image to max 200x250, 70% quality
                const compressed = await compressImage(e.target.result, 200, 250, 0.85);
                characterData.portrait = compressed;
                document.getElementById('portrait-img').src = compressed;
                document.getElementById('portrait-img').style.display = 'block';
                document.getElementById('portrait-placeholder').style.display = 'none';
                autoSave();
            };
            reader.readAsDataURL(file);
        }
        
        function uploadJolly(event) {
            const file = event.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = async (e) => {
                // Compress image to max 60x60, 70% quality
                const compressed = await compressImage(e.target.result, 150, 150, 0.85);
                characterData.jollyRoger = compressed;
                document.getElementById('crew-flag-img').src = compressed;
                document.getElementById('crew-flag-img').style.display = 'block';
                document.getElementById('crew-flag-placeholder').style.display = 'none';
                autoSave();
            };
            reader.readAsDataURL(file);
        }
        
        function removePortrait() {
            event.stopPropagation();
            characterData.portrait = null;
            document.getElementById('portrait-img').src = '';
            document.getElementById('portrait-img').style.display = 'none';
            document.getElementById('portrait-placeholder').style.display = 'block';
            autoSave();
        }
        
        function removeCrewFlag() {
            event.stopPropagation();
            characterData.jollyRoger = null;
            document.getElementById('crew-flag-img').src = '';
            document.getElementById('crew-flag-img').style.display = 'none';
            document.getElementById('crew-flag-placeholder').style.display = 'block';
            autoSave();
        }

        // ===== PORTRAIT GALERIE =====
        async function openPortraitGallery() {
            // Modal erstellen
            const modal = document.createElement('div');
            modal.id = 'portrait-gallery-modal';
            modal.className = 'popup-overlay active';
            modal.onclick = (e) => { if (e.target === modal) closePortraitGallery(); };
            
            modal.innerHTML = `
                <div class="popup" style="max-width: 700px; max-height: 80vh; overflow: hidden; display: flex; flex-direction: column;">
                    <div class="popup-header">
                        <h3>Portrait aus Galerie wählen</h3>
                        <button class="popup-close" onclick="closePortraitGallery()" style="font-size: 24px; line-height: 1;">×</button>
                    </div>
                    <div class="popup-body" style="flex: 1; overflow-y: auto; padding: 16px;">
                        <div id="portrait-gallery-loading" style="text-align: center; padding: 40px; color: var(--text-muted);">
                            <div class="loading-spinner" style="margin: 0 auto 16px;"></div>
                            Lade Portraits...
                        </div>
                        <div id="portrait-gallery-grid" style="display: none; grid-template-columns: repeat(auto-fill, minmax(90px, 1fr)); gap: 12px;"></div>
                        <div id="portrait-gallery-empty" style="display: none; text-align: center; padding: 40px; color: var(--text-muted);">
                            <span class="card-title-icon" style="font-size: 48px; margin-bottom: 16px; display: block;">collections</span>
                            <p>Keine Portraits in der Galerie vorhanden.</p>
                            <p style="font-size: 13px; margin-top: 8px;">Portraits können im Admin-Bereich hochgeladen werden.</p>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            // Portraits laden
            try {
                const db = firebase.firestore();
                const snapshot = await db.collection('assets')
                    .where('type', '==', 'portrait-worldsapart')
                    .orderBy('createdAt', 'desc')
                    .get();
                
                const portraits = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                
                const loading = document.getElementById('portrait-gallery-loading');
                const grid = document.getElementById('portrait-gallery-grid');
                const empty = document.getElementById('portrait-gallery-empty');
                
                loading.style.display = 'none';
                
                if (portraits.length === 0) {
                    empty.style.display = 'block';
                    return;
                }
                
                grid.style.display = 'grid';
                grid.innerHTML = portraits.map(p => `
                    <div class="portrait-gallery-item" onclick="selectPortraitFromGallery('${p.url}')" title="${p.name || 'Portrait'}">
                        <img src="${p.url}" alt="${p.name || 'Portrait'}" loading="lazy">
                    </div>
                `).join('');
                
            } catch (err) {
                console.error('[Portrait Gallery] Error loading:', err);
                document.getElementById('portrait-gallery-loading').innerHTML = `
                    <span class="material-icons-outlined" style="font-size: 48px; margin-bottom: 16px; display: block; color: #dc2626;">error</span>
                    <p>Fehler beim Laden der Galerie</p>
                    <p style="font-size: 13px; margin-top: 8px;">${err.message}</p>
                `;
            }
        }
        
        function selectPortraitFromGallery(url) {
            characterData.portrait = url;
            document.getElementById('portrait-img').src = url;
            document.getElementById('portrait-img').style.display = 'block';
            document.getElementById('portrait-placeholder').style.display = 'none';
            autoSave();
            closePortraitGallery();
            
            // Toast wenn verfügbar
            if (window.RIFT?.ui?.Toast) {
                RIFT.ui.Toast.success('Portrait ausgewählt');
            }
        }
        
        function closePortraitGallery() {
            const modal = document.getElementById('portrait-gallery-modal');
            if (modal) modal.remove();
        }

        // ===== HAUPTCHARAKTER =====
        function toggleMainCharacter() {
            if (!window.currentCharId) {
                // Character not saved yet - save first
                saveCharacter();
                if (!window.currentCharId) {
                    alert('Bitte speichere zuerst den Charakter (gib ihm einen Namen).');
                    return;
                }
            }
            
            if (typeof CharacterStorage === 'undefined') {
                console.error('[WA-Sheet] CharacterStorage not available');
                return;
            }
            
            const isMain = CharacterStorage.isMainCharacter(window.currentCharId);
            
            if (!isMain) {
                // Set as main
                CharacterStorage.setMainCharacter(window.currentCharId, 'worldsapart');
                updateMainCharButton(true);
                
                // Show toast if available
                if (window.RIFT?.ui?.Toast) {
                    RIFT.ui.Toast.success('Als Hauptcharakter gesetzt!');
                }
            }
            // Already main - do nothing (can't "unset" main, only set another)
        }
        
        function updateMainCharButton(isMain = null) {
            const btn = document.getElementById('mainCharBtn');
            const text = document.getElementById('mainCharBtnText');
            if (!btn || !text) return;
            
            // Check if main
            if (isMain === null && window.currentCharId && typeof CharacterStorage !== 'undefined') {
                isMain = CharacterStorage.isMainCharacter(window.currentCharId);
            }
            
            if (isMain) {
                btn.classList.add('active');
                text.textContent = '★ Hauptcharakter';
            } else {
                btn.classList.remove('active');
                text.textContent = 'Hauptcharakter';
            }
        }

        // ===== EXPORT / IMPORT / RESET =====
        function exportCharacter() {
            const blob = new Blob([JSON.stringify(characterData, null, 2)], { type: 'application/json' });
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = `${characterData.name || 'charakter'}_worldsapart.json`;
            a.click();
        }
        
        function importCharacter(event) {
            const file = event.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    characterData = { ...getDefaultCharacter(), ...JSON.parse(e.target.result) };
                    saveCharacter();
                    populateFields();
                    initializeSkills();
                    updateAllCalculations();
                    showSaveIndicator();
                } catch(err) { alert('Fehler beim Import'); }
            };
            reader.readAsText(file);
            event.target.value = '';
        }
        
        function resetCharacter() {
            if (confirm('Charakter wirklich zurücksetzen? Alle Daten werden gelöscht.')) {
                // Delete from CharacterStorage if we have an ID
                if (window.currentCharId && typeof CharacterStorage !== 'undefined') {
                    CharacterStorage.delete(window.currentCharId);
                    console.log('[WA-Sheet] Deleted from CharacterStorage:', window.currentCharId);
                }
                
                // Clear legacy localStorage
                localStorage.removeItem(STORAGE_KEY);
                
                // Reset character data
                characterData = getDefaultCharacter();
                window.currentCharId = null;
                
                // Update UI
                populateFields();
                initializeSkills();
                updateAllCalculations();
                document.getElementById('portrait-img').style.display = 'none';
                document.getElementById('portrait-placeholder').style.display = 'block';
                document.getElementById('crew-flag-img').style.display = 'none';
                document.getElementById('crew-flag-placeholder').style.display = 'block';
                document.querySelectorAll('.dice-check-large').forEach(d => d.classList.remove('used'));
                
                if (window.RIFT?.ui?.Toast) {
                    RIFT.ui.Toast.info('Charakter zurückgesetzt');
                }
            }
        }

        // ===== GM PLAYER SWITCHER & ADVENTURE BAR =====
        
        let isViewingOther = false;
        let currentViewingPlayer = null;
        let originalCharacterData = null;
        
        // Initialize GM Player Bar and Adventure Bar
        document.addEventListener('DOMContentLoaded', function() {
            // Delay initialization to ensure Firebase and auth are ready
            setTimeout(() => {
                initGMPlayerBar();
                initAdventureBar();
            }, 1500);
            
            const zweiteChanceRollBtn = document.getElementById('zweite-chance-roll-btn');
            if (zweiteChanceRollBtn) {
                zweiteChanceRollBtn.addEventListener('click', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    rollZweiteChance();
                });
            }
        });
        
        function initGMPlayerBar() {
            const gmPlayerBar = document.getElementById('gmPlayerBar');
            if (!gmPlayerBar) return;
            
            // Check for GM status
            let user = null;
            try {
                user = typeof getCurrentUser === 'function' ? getCurrentUser() : null;
                if (!user) {
                    const userData = localStorage.getItem('pnp_companion_user');
                    if (userData) user = JSON.parse(userData);
                }
            } catch(e) {
                console.log('[GM Bar] Could not get user:', e);
            }
            
            console.log('[GM Bar] User check:', user);
            
            if (!user?.isGM) {
                console.log('[GM Bar] Not a GM, hiding bar');
                return;
            }
            
            // Show GM bar
            gmPlayerBar.classList.add('visible');
            
            // Get room code (try multiple sources)
            const roomCode = localStorage.getItem('rift_current_room')?.replace(/-/g, '').toUpperCase();
            
            if (!roomCode) {
                console.log('[GM Bar] No room code');
                renderPlayerButtons([], user.username, firebase?.auth?.()?.currentUser?.uid);
                return;
            }
            
            // Check for Firestore availability
            if (typeof RIFT === 'undefined' || !RIFT.rooms) {
                console.log('[GM Bar] RIFT.rooms not ready, trying Firestore directly...');
                
                // Fallback to direct Firestore
                if (typeof firebase !== 'undefined' && firebase.firestore) {
                    const db = firebase.firestore();
                    db.collection('rooms').doc(roomCode).collection('characters')
                        .onSnapshot(snapshot => {
                            const characters = snapshot.docs.map(doc => ({
                                characterId: doc.id,
                                ...doc.data()
                            }));
                            console.log('[GM Bar] Characters from Firestore:', characters.length);
                            renderPlayerButtons(characters, user.username, firebase?.auth?.()?.currentUser?.uid);
                        }, err => {
                            console.warn('[GM Bar] Firestore error:', err);
                            renderPlayerButtons([], user.username, firebase?.auth?.()?.currentUser?.uid);
                        });
                } else {
                    renderPlayerButtons([], user.username, null);
                }
                return;
            }
            
            // Use RIFT.rooms subscription (Firestore-based, Multi-Character Support)
            RIFT.rooms.subscribeToCharacters(roomCode, (characters) => {
                console.log('[GM Bar] Characters update:', characters.length, 'characters');
                const charsWithId = characters.map(c => ({ ...c, characterId: c.id }));
                renderPlayerButtons(charsWithId, user.username, firebase?.auth?.()?.currentUser?.uid);
            });
        }
        
        function renderPlayerButtons(characters, currentUsername, currentUserId) {
            const container = document.getElementById('gmPlayerList');
            if (!container) return;
            
            container.innerHTML = '';
            
            // Add "Eigener Charakter" button first
            const ownBtn = document.createElement('button');
            ownBtn.className = 'gm-player-btn' + (!isViewingOther ? ' active' : '');
            ownBtn.innerHTML = `
                <span class="player-dot" style="background: var(--accent-primary);"></span>
                Eigener Charakter
            `;
            ownBtn.onclick = () => switchToOwnCharacter();
            container.appendChild(ownBtn);
            
            // Add other players' characters (Multi-Character Support)
            characters.forEach(char => {
                // Skip own characters
                if (char.ownerId === currentUserId) return;
                
                const charName = char.name || char.data?.name || 'Unbenannt';
                const ownerName = char.ownerName || 'Spieler';
                
                const btn = document.createElement('button');
                btn.className = 'gm-player-btn' + (currentViewingCharId === char.characterId ? ' active' : '');
                btn.innerHTML = `
                    <span class="player-dot" style="background: ${char.color || '#888'};"></span>
                    ${charName} <span style="opacity: 0.6; font-size: 11px;">(${ownerName})</span>
                `;
                btn.onclick = () => switchToCharacter(char.characterId, charName, ownerName, char);
                container.appendChild(btn);
            });
        }
        
        // Track current viewing character ID for multi-char support
        let currentViewingCharId = null;
        
        function switchToCharacter(characterId, charName, ownerName, charData) {
            if (!characterId) return;
            
            // Save original data if first switch
            if (!isViewingOther) {
                originalCharacterData = JSON.parse(JSON.stringify(characterData));
            }
            
            isViewingOther = true;
            currentViewingPlayer = ownerName;
            currentViewingCharId = characterId;
            
            // Show viewing badge
            const badge = document.getElementById('gmViewingBadge');
            const nameSpan = document.getElementById('viewingPlayerName');
            if (badge && nameSpan) {
                badge.classList.add('visible');
                nameSpan.textContent = `Ansicht: ${charName} (${ownerName})`;
            }
            
            // Show readonly overlay
            const overlay = document.getElementById('readonlyOverlay');
            if (overlay) overlay.classList.add('visible');
            
            // Make all inputs readonly
            setSheetReadonly(true);
            
            // Load character data from charData (already have it from Firestore)
            if (charData && charData.data) {
                const data = charData.data;
                // Merge into characterData format
                if (data.health || data.status?.health) {
                    characterData.health = data.health || { current: data.status.health, max: 100 };
                }
                if (data.moral || data.status?.moral) {
                    characterData.moral = data.moral || { current: data.status.moral, max: 100 };
                }
                if (data.name) characterData.name = data.name;
                if (data.role) characterData.role = data.role;
                if (data.attributes) characterData.attributes = data.attributes;
                if (data.skills) characterData.skills = data.skills;
                if (data.fokus) characterData.fokus = data.fokus;
                if (data.schwaeche) characterData.schwaeche = data.schwaeche;
                if (data.age) characterData.age = data.age;
                if (data.gender) characterData.gender = data.gender;
                if (data.crew) characterData.crew = data.crew;
                if (data.appearance) characterData.appearance = data.appearance;
                if (data.inventory) characterData.inventory = data.inventory;
                if (data.currency) characterData.currency = data.currency;
                if (data.weapon) characterData.weapon = data.weapon;
                if (data.notes) characterData.notes = data.notes;
                if (data.portrait) characterData.portrait = data.portrait;
                if (data.jollyRoger) characterData.jollyRoger = data.jollyRoger;
                if (data.secondChance) characterData.secondChance = data.secondChance;
                
                populateFields();
                initializeSkills();
                updateAllCalculations();
            }
            
            // Update button states
            updatePlayerButtonStates();
        }
        
        // Legacy function for backwards compatibility
        function switchToPlayerCharacter(username, color) {
            console.log('[GM Bar] Legacy switchToPlayerCharacter called, searching by username:', username);
            // This function searches by ownerName in the existing character list
            const container = document.getElementById('gmPlayerList');
            if (!container) return;
            
            // Find matching button and click it
            const buttons = container.querySelectorAll('.gm-player-btn');
            buttons.forEach(btn => {
                if (btn.textContent.includes(username)) {
                    btn.click();
                }
            });
        }
        
        function switchToOwnCharacter() {
            if (!isViewingOther) return;
            
            isViewingOther = false;
            currentViewingPlayer = null;
            currentViewingCharId = null;
            
            // Hide viewing badge
            const badge = document.getElementById('gmViewingBadge');
            if (badge) badge.classList.remove('visible');
            
            // Hide readonly overlay
            const overlay = document.getElementById('readonlyOverlay');
            if (overlay) overlay.classList.remove('visible');
            
            // Make inputs editable again
            setSheetReadonly(false);
            
            // Restore original data
            if (originalCharacterData) {
                characterData = originalCharacterData;
                populateFields();
                initializeSkills();
                updateAllCalculations();
                originalCharacterData = null;
            }
            
            // Update button states
            updatePlayerButtonStates();
        }
        
        function setSheetReadonly(readonly) {
            const inputs = document.querySelectorAll('input, textarea, select');
            inputs.forEach(input => {
                if (input.id === 'adventureName') return; // Adventure name stays editable
                if (readonly) {
                    input.setAttribute('readonly', true);
                    input.setAttribute('disabled', true);
                    input.style.pointerEvents = 'none';
                } else {
                    input.removeAttribute('readonly');
                    input.removeAttribute('disabled');
                    input.style.pointerEvents = '';
                }
            });
            
            // Disable buttons too
            const buttons = document.querySelectorAll('.card-action-btn, .img-control-btn, .dice-check-large');
            buttons.forEach(btn => {
                if (readonly) {
                    btn.style.pointerEvents = 'none';
                    btn.style.opacity = '0.5';
                } else {
                    btn.style.pointerEvents = '';
                    btn.style.opacity = '';
                }
            });
        }
        
        function updatePlayerButtonStates() {
            const buttons = document.querySelectorAll('.gm-player-btn');
            buttons.forEach(btn => {
                const isOwn = btn.textContent.includes('Eigener Charakter');
                const isCurrentViewing = btn.textContent.includes(currentViewingPlayer);
                
                btn.classList.remove('active');
                if ((!isViewingOther && isOwn) || (isViewingOther && isCurrentViewing)) {
                    btn.classList.add('active');
                }
            });
        }
        
        // ===== ADVENTURE BAR =====
        
        function initAdventureBar() {
            const sessionId = localStorage.getItem('pnp_session_id');
            const adventureInput = document.getElementById('adventureName');
            
            if (!sessionId || !adventureInput || typeof firebase === 'undefined') return;
            
            // Check if user is GM
            let isGM = false;
            try {
                const user = typeof getCurrentUser === 'function' ? getCurrentUser() : null;
                if (!user) {
                    const userData = localStorage.getItem('pnp_companion_user');
                    if (userData) {
                        const parsed = JSON.parse(userData);
                        isGM = parsed.isGM === true || parsed.isGM === 'true';
                    }
                } else {
                    isGM = user.isGM === true || user.isGM === 'true';
                }
            } catch(e) {
                console.log('[Adventure Bar] Could not check GM status:', e);
            }
            
            // If not GM, make input readonly
            if (!isGM) {
                adventureInput.setAttribute('readonly', true);
                adventureInput.style.cursor = 'default';
                adventureInput.style.borderBottom = 'none';
                adventureInput.title = 'Nur der GM kann den Abenteuernamen ändern';
            }
            
            const adventureRef = firebase.database().ref(`sessions/${sessionId}/adventure`);
            
            // Load current adventure name and listen for changes (for ALL users)
            adventureRef.child('name').on('value', (snapshot) => {
                const name = snapshot.val();
                if (document.activeElement !== adventureInput) {
                    adventureInput.value = name || '';
                }
            });
            
            // Only GMs can save changes
            if (isGM) {
                let saveTimeout;
                adventureInput.addEventListener('input', () => {
                    clearTimeout(saveTimeout);
                    saveTimeout = setTimeout(() => {
                        adventureRef.child('name').set(adventureInput.value);
                    }, 500);
                });
                
                // Save on blur immediately
                adventureInput.addEventListener('blur', () => {
                    clearTimeout(saveTimeout);
                    adventureRef.child('name').set(adventureInput.value);
                });
            }
        }
    </script>
    
    <!-- RIFT Layout Script -->
    <script src="../../assets/js/layout-unified.js"></script>
    <script src="../../assets/js/character-storage.js"></script>
    
    <!-- Animation & Micro-Interaction Script -->
    <script>
    (function() {
        'use strict';
        
        // === ATTRIBUTE VALUE CHANGE ANIMATION ===
        document.querySelectorAll('[id^="attr-"]').forEach(input => {
            if (input.type === 'number') {
                let lastValue = input.value;
                input.addEventListener('change', function() {
                    if (this.value !== lastValue) {
                        this.classList.add('value-changed');
                        setTimeout(() => this.classList.remove('value-changed'), 400);
                        lastValue = this.value;
                    }
                });
            }
        });
        
        // === ZWEITE CHANCE TOGGLE ANIMATION ===
        document.querySelectorAll('[id^="dice-"]').forEach(checkbox => {
            checkbox.addEventListener('click', function() {
                this.classList.add('toggle-animation');
                setTimeout(() => this.classList.remove('toggle-animation'), 300);
            });
        });
        
        // === SKILL ROW HOVER ENHANCEMENT ===
        document.querySelectorAll('.skill-item, .skill-row').forEach(row => {
            const rollBtn = row.querySelector('.roll-btn, .dice-btn, .skill-roll-btn');
            if (rollBtn) {
                row.addEventListener('mouseenter', () => {
                    rollBtn.style.opacity = '1';
                    rollBtn.style.transform = 'scale(1)';
                });
                row.addEventListener('mouseleave', () => {
                    rollBtn.style.opacity = '0.5';
                    rollBtn.style.transform = 'scale(0.9)';
                });
            }
        });
        
        // === DICE BUTTON CLICK FEEDBACK ===
        document.querySelectorAll('.dice-btn, .roll-btn, [onclick*="roll"]').forEach(btn => {
            btn.addEventListener('click', function() {
                this.style.animation = 'none';
                this.offsetHeight; // Trigger reflow
                this.style.animation = 'diceClick 0.15s ease';
            });
        });
        
        // === LEVEL BADGE HOVER ===
        const levelBadge = document.querySelector('.level-badge');
        if (levelBadge) {
            levelBadge.addEventListener('mouseenter', function() {
                this.style.animation = 'none';
            });
            levelBadge.addEventListener('mouseleave', function() {
                this.style.animation = 'levelPulse 3s ease-in-out infinite';
            });
        }
        
        // === ENHANCED SAVE INDICATOR ===
        const originalSaveIndicator = window.showSaveIndicator;
        window.showSaveIndicator = function() {
            const indicator = document.getElementById('save-indicator');
            if (indicator) {
                indicator.classList.remove('show');
                void indicator.offsetWidth; // Trigger reflow
                indicator.classList.add('show');
                setTimeout(() => indicator.classList.remove('show'), 2000);
            }
        };
        
        // === STATUS BAR SHIMMER ON CHANGE ===
        const healthInput = document.getElementById('health-current');
        const moralInput = document.getElementById('moral-current');
        
        [healthInput, moralInput].forEach(input => {
            if (input) {
                input.addEventListener('change', function() {
                    const bar = this.id.includes('health') 
                        ? document.getElementById('health-bar')
                        : document.getElementById('moral-bar');
                    if (bar) {
                        bar.style.animation = 'none';
                        void bar.offsetWidth;
                        bar.style.animation = 'barShimmer 1s ease';
                    }
                });
            }
        });
        
        console.log('🎨 RIFT Animations loaded');
    })();
    </script>
    
            </div><!-- end main__content -->
        </main><!-- end main -->
    </div><!-- end app -->
    
    <!-- Dock Placeholder -->
    <div id="dock-placeholder"></div>
    
    <!-- Footer Placeholder -->
    <div id="footer-placeholder"></div>
    
    <!-- Rast Vignette Overlays (außerhalb app für fullscreen) -->
    <div class="rast-vignette lange" id="vignette-lange"></div>
    <div class="rast-vignette kurze" id="vignette-kurze"></div>
    <script src="../../assets/js/broadcast.js"></script>
</body>
</html>
