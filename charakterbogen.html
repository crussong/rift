<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Charakterbogen - PnP Companion</title>
    <script>(function(){var t=localStorage.getItem('pnp_theme')||'dark';document.documentElement.setAttribute('data-theme',t)})();</script>
    <link rel="icon" type="image/png" href="assets/images/logo_rift_emblem_white.png">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;600;700;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="assets/css/global.css">
    <style>
        /* Module-specific styles only */

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Roboto', sans-serif;
            background: var(--md-background);
            color: var(--md-on-background);
            min-height: 100vh;
        }

        /* ===== MAIN LAYOUT ===== */
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 24px;
        }

        /* ===== PORTRAIT UPLOAD - TOP SECTION ===== */
        .portrait-upload-section {
            background: var(--md-surface-container);
            border-radius: var(--shape-lg);
            padding: 24px;
            margin-bottom: 24px;
            box-shadow: var(--elevation-2);
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .portrait-container {
            position: relative;
            width: 200px;
            height: 200px;
        }

        .portrait-preview {
            width: 100%;
            height: 100%;
            border-radius: var(--shape-lg);
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
            background: var(--md-surface-container-high);
            cursor: pointer;
            transition: all 200ms cubic-bezier(0.4, 0, 0.2, 1);
        }

        .portrait-preview:hover {
            transform: scale(1.02);
        }

        .portrait-preview img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .portrait-placeholder {
            text-align: center;
            color: var(--md-on-surface-variant);
            font-size: 12px;
            padding: 10px;
            white-space: nowrap;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 4px;
        }

        .portrait-upload-input {
            display: none;
        }

        /* Portrait Controls - Only visible when active */
        .portrait-controls {
            position: absolute;
            bottom: 8px;
            left: 50%;
            transform: translateX(-50%);
            display: none;
            gap: 8px;
        }

        .portrait-container.show-controls .portrait-controls {
            display: flex;
        }

        .portrait-btn {
            width: 40px;
            height: 40px;
            background: var(--md-surface-container-highest);
            backdrop-filter: blur(10px);
            border: none;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: var(--elevation-2);
            transition: all 200ms cubic-bezier(0.4, 0, 0.2, 1);
        }

        .portrait-btn:hover {
            transform: scale(1.1);
        }

        .portrait-btn img {
            width: 20px;
            height: 20px;
            object-fit: contain;
        }

        .portrait-btn.change {
            background: var(--md-primary);
        }

        .portrait-btn.remove {
            background: var(--md-error);
        }

        /* Portrait Divider */
        .portrait-divider {
            width: 1px;
            height: 160px;
            background: var(--md-outline-variant);
            opacity: 0.5;
            margin: 0 24px;
        }

        /* Jolly Roger Container */
        .jolly-container {
            position: relative;
            width: 200px;
            height: 115px;
        }

        .jolly-preview {
            width: 100%;
            height: 100%;
            border-radius: var(--shape-lg);
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
            background: var(--md-surface-container-high);
            cursor: pointer;
            transition: all 200ms cubic-bezier(0.4, 0, 0.2, 1);
        }

        .jolly-preview:hover {
            transform: scale(1.02);
        }

        .jolly-preview img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .jolly-placeholder {
            text-align: center;
            color: var(--md-on-surface-variant);
            font-size: 12px;
            padding: 12px;
        }

        .jolly-controls {
            position: absolute;
            bottom: 6px;
            left: 50%;
            transform: translateX(-50%);
            display: none;
            gap: 6px;
        }

        .jolly-container.show-controls .jolly-controls {
            display: flex;
        }

        .jolly-controls .portrait-btn {
            width: 32px;
            height: 32px;
        }

        .jolly-controls .portrait-btn img {
            width: 16px;
            height: 16px;
        }

        /* Crew Input */
        .jolly-wrapper {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
        }

        .crew-input-container {
            width: 200px;
        }

        .crew-input {
            width: 100%;
            background: var(--md-surface-container-high);
            border: none;
            border-radius: var(--shape-sm);
            padding: 8px 12px;
            color: var(--md-on-surface);
            font-size: 13px;
            font-family: 'Roboto', sans-serif;
            text-align: center;
        }

        .crew-input:focus {
            outline: none;
            box-shadow: 0 0 0 2px var(--md-primary);
        }

        .crew-input::placeholder {
            color: var(--md-on-surface-variant);
            opacity: 0.6;
        }

        /* Ruleset Box */
        .ruleset-box {
            background: var(--md-surface-container);
            border-radius: var(--shape-lg);
            padding: 16px 24px;
            margin-bottom: 24px;
            box-shadow: var(--elevation-2);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
        }

        .ruleset-label {
            font-size: 14px;
            color: var(--md-on-surface-variant);
        }

        .ruleset-icon {
            width: 32px;
            height: 32px;
            object-fit: contain;
        }

        .ruleset-name {
            font-size: 16px;
            font-weight: 600;
            color: var(--md-on-surface);
        }

        /* ===== HEADER SECTION ===== */
        .character-header {
            background: var(--md-surface-container);
            border-radius: var(--shape-lg);
            padding: 24px;
            margin-bottom: 24px;
            box-shadow: var(--elevation-2);
        }

        .header-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 16px;
        }

        .input-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .input-group label {
            font-size: 12px;
            font-weight: 600;
            color: var(--md-on-surface-variant);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .input-field {
            background: var(--md-surface-container-high);
            border: 1px solid var(--md-outline-variant);
            border-radius: var(--shape-md);
            padding: 12px 16px;
            color: var(--md-on-surface);
            font-size: 16px;
            font-family: 'Roboto', sans-serif;
            transition: all 200ms cubic-bezier(0.4, 0, 0.2, 1);
            width: 100%;
        }

        .input-field:focus {
            outline: none;
            border-color: var(--md-primary);
            box-shadow: 0 0 0 3px rgba(103, 80, 164, 0.1);
        }

        textarea.input-field {
            resize: vertical;
            min-height: 80px;
            font-size: 14px;
        }

        .input-row {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 16px;
        }

        /* ===== STATS SECTION ===== */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 16px;
            margin-bottom: 24px;
        }

        .stat-card {
            background: var(--md-surface-container-high);
            border-radius: var(--shape-lg);
            padding: 16px;
            position: relative;
            overflow: hidden;
        }

        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 60%;
            pointer-events: none;
            opacity: 0.12;
        }

        .stat-card.leben::before {
            background: linear-gradient(to bottom, var(--stat-leben), transparent);
        }

        .stat-card.moral::before {
            background: linear-gradient(to bottom, var(--stat-moral), transparent);
        }

        .stat-card.resonanz::before {
            background: linear-gradient(to bottom, var(--stat-resonanz), transparent);
        }

        .stat-label {
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 8px;
            color: var(--md-on-surface-variant);
        }

        .stat-input-group {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .stat-input {
            background: var(--md-surface-container-lowest);
            border: 1px solid var(--md-outline-variant);
            border-radius: var(--shape-sm);
            padding: 8px 12px;
            color: var(--md-on-surface);
            font-size: 20px;
            font-weight: 600;
            text-align: center;
            width: 90px;
            transition: all 200ms cubic-bezier(0.4, 0, 0.2, 1);
        }

        .stat-input:focus {
            outline: none;
            border-color: var(--md-primary);
        }

        .stat-separator {
            font-size: 20px;
            font-weight: 300;
            color: var(--md-on-surface-variant);
        }

        .stat-max {
            font-size: 16px;
            color: var(--md-on-surface-variant);
        }

        /* ===== PROGRESS BAR ===== */
        .progress-bar {
            height: 6px;
            background: var(--md-surface-container-lowest);
            border-radius: 3px;
            overflow: hidden;
            margin-top: 8px;
        }

        .progress-fill {
            height: 100%;
            transition: width 300ms cubic-bezier(0.4, 0, 0.2, 1);
            border-radius: 3px;
        }

        .progress-fill.leben {
            background: var(--stat-leben);
            transition: background 300ms ease, width 300ms cubic-bezier(0.4, 0, 0.2, 1);
        }

        .progress-fill.leben.warning {
            background: #f57c00;
        }

        .progress-fill.leben.critical {
            background: #b71c1c;
        }

        .progress-fill.moral {
            background: var(--stat-moral);
        }

        .progress-fill.resonanz {
            background: var(--stat-resonanz);
        }

        /* Dead Overlay - inside Leben card only */
        .stat-card.leben {
            position: relative;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        /* ===== FOKUS SYSTEM ===== */
        .fokus-section {
            background: var(--md-surface-container);
            border-radius: var(--shape-lg);
            padding: 20px;
            margin-bottom: 24px;
            box-shadow: var(--elevation-1);
        }

        .fokus-header {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 16px;
        }

        .fokus-header label {
            font-size: 14px;
            font-weight: 600;
            color: var(--md-on-surface);
        }

        .fokus-grid {
            display: grid;
            grid-template-columns: 70px 1fr 1fr 1fr;
            gap: 12px;
            align-items: stretch;
        }

        /* Desktop: Hide mobile-only elements */
        .fokus-top-row {
            display: none;
        }
        
        .fokus-type-name-mobile {
            display: none;
        }
        
        /* Desktop: Show desktop icon */
        .fokus-desktop-only {
            display: flex;
        }

        @media (max-width: 600px) {
            .fokus-grid {
                display: flex;
                flex-direction: column;
                gap: 8px;
            }
            
            .fokus-top-row {
                display: flex;
                gap: 8px;
            }
            
            /* Hide the desktop type card on mobile */
            .fokus-desktop-only {
                display: none !important;
            }
            
            .fokus-type-card {
                width: 60px;
                height: 60px;
                flex-shrink: 0;
            }
            
            .fokus-type-name-mobile {
                flex: 1;
                display: flex;
                align-items: center;
                justify-content: center;
                background: var(--md-surface-container-high);
                border-radius: var(--shape-md);
                font-size: 16px;
                font-weight: 600;
                color: var(--md-on-surface);
            }
            
            .fokus-ability-card {
                width: 100%;
            }
        }

        /* Element gradients - from top 25% fading down */
        .fokus-type-card.fire { background: linear-gradient(180deg, rgba(255, 107, 53, 0.25) 0%, var(--md-surface-container-high) 100%); }
        .fokus-type-card.water { background: linear-gradient(180deg, rgba(79, 195, 247, 0.25) 0%, var(--md-surface-container-high) 100%); }
        .fokus-type-card.wind { background: linear-gradient(180deg, rgba(178, 235, 242, 0.25) 0%, var(--md-surface-container-high) 100%); }
        .fokus-type-card.earth { background: linear-gradient(180deg, rgba(141, 110, 99, 0.25) 0%, var(--md-surface-container-high) 100%); }
        .fokus-type-card.lightning { background: linear-gradient(180deg, rgba(255, 235, 59, 0.25) 0%, var(--md-surface-container-high) 100%); }
        .fokus-type-card.room { background: linear-gradient(180deg, rgba(206, 147, 216, 0.25) 0%, var(--md-surface-container-high) 100%); }
        .fokus-type-card.illusion { background: linear-gradient(180deg, rgba(179, 157, 219, 0.25) 0%, var(--md-surface-container-high) 100%); }

        .fokus-type-card {
            aspect-ratio: 1;
            background: var(--md-surface-container-high);
            border-radius: var(--shape-md);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s;
            border: none;
            overflow: hidden;
        }

        @media (max-width: 600px) {
            .fokus-type-card {
                aspect-ratio: auto;
            }
        }

        .fokus-type-card:hover {
            transform: scale(1.05);
            box-shadow: 0 2px 8px rgba(0,0,0,0.3);
        }

        .fokus-type-card img {
            width: 44px;
            height: 44px;
        }

        .fokus-type-placeholder {
            font-size: 24px;
            color: var(--md-on-surface-variant);
        }

        .fokus-ability-card {
            background: var(--md-surface-container-high);
            border-radius: var(--shape-md);
            padding: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            text-align: center;
            min-height: 70px;
            cursor: pointer;
            transition: all 0.2s;
            border: none;
        }

        @media (max-width: 600px) {
            .fokus-ability-card {
                min-height: 50px;
                padding: 10px;
            }
        }

        .fokus-ability-card:hover:not(.locked):not(.empty) {
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
        }

        .fokus-ability-card.locked {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .fokus-ability-card.unlocked {
            opacity: 1;
            cursor: pointer;
        }

        .fokus-ability-content {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 2px;
        }

        .fokus-ability-card .fokus-ability-placeholder {
            font-size: 11px;
            color: var(--md-on-surface-variant);
        }

        .fokus-ability-card .fokus-ability-name {
            font-size: 14px;
            font-weight: 600;
            color: var(--md-on-surface);
            word-break: break-word;
            display: none;
        }

        .fokus-ability-card .fokus-ability-desc-small {
            font-size: 10px;
            color: var(--md-on-surface-variant);
            line-height: 1.3;
            display: none;
            max-width: 100%;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        @media (max-width: 600px) {
            .fokus-ability-card .fokus-ability-name {
                font-size: 13px;
            }
            .fokus-ability-card .fokus-ability-desc-small {
                font-size: 9px;
            }
        }

        .fokus-ability-card.selected {
            border: none;
            background: var(--md-surface-container-high);
        }

        /* Element-specific colors for ability cards - subtle gradient */
        .fokus-ability-card.selected.fire { background: linear-gradient(180deg, rgba(255, 107, 53, 0.25) 0%, var(--md-surface-container-high) 100%); }
        .fokus-ability-card.selected.water { background: linear-gradient(180deg, rgba(79, 195, 247, 0.25) 0%, var(--md-surface-container-high) 100%); }
        .fokus-ability-card.selected.wind { background: linear-gradient(180deg, rgba(178, 235, 242, 0.25) 0%, var(--md-surface-container-high) 100%); }
        .fokus-ability-card.selected.earth { background: linear-gradient(180deg, rgba(141, 110, 99, 0.25) 0%, var(--md-surface-container-high) 100%); }
        .fokus-ability-card.selected.lightning { background: linear-gradient(180deg, rgba(255, 235, 59, 0.25) 0%, var(--md-surface-container-high) 100%); }
        .fokus-ability-card.selected.room { background: linear-gradient(180deg, rgba(206, 147, 216, 0.25) 0%, var(--md-surface-container-high) 100%); }
        .fokus-ability-card.selected.illusion { background: linear-gradient(180deg, rgba(179, 157, 219, 0.25) 0%, var(--md-surface-container-high) 100%); }

        /* Fokus Popup */
        .fokus-popup-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.8);
            z-index: 10000;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .fokus-popup {
            background: var(--md-surface-container);
            border-radius: 16px;
            max-width: 700px;
            width: 100%;
            max-height: 85vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        .fokus-popup-header {
            padding: 20px;
            border-bottom: 1px solid var(--md-outline-variant);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .fokus-popup-title {
            font-size: 20px;
            font-weight: 600;
            color: var(--md-on-surface);
        }

        .fokus-popup-close {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            border: none;
            background: var(--md-surface-container-high);
            color: var(--md-on-surface);
            font-size: 20px;
            cursor: pointer;
        }

        .fokus-categories {
            display: flex;
            gap: 8px;
            padding: 16px 20px;
            justify-content: center;
            border-bottom: 1px solid var(--md-outline-variant);
        }

        .fokus-category-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 50px;
            height: 50px;
            padding: 8px;
            border-radius: 12px;
            border: 2px solid transparent;
            background: var(--md-surface-container-high);
            cursor: pointer;
            transition: all 0.2s;
        }

        .fokus-category-btn img {
            width: 32px;
            height: 32px;
        }

        .fokus-category-btn.active {
            border-color: var(--md-primary);
            background: color-mix(in srgb, var(--md-primary) 20%, var(--md-surface-container-high));
        }

        .fokus-popup-content {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
        }

        .fokus-category-title {
            font-size: 20px;
            font-weight: 600;
            color: var(--md-on-surface);
            text-align: center;
            padding: 16px;
            background: var(--md-surface-container-high);
            border-radius: 12px;
            margin-bottom: 20px;
        }

        .fokus-abilities-section {
            margin-bottom: 24px;
        }

        .fokus-abilities-title {
            font-size: 14px;
            font-weight: 600;
            color: var(--md-on-surface);
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .fokus-abilities-title::before {
            content: '';
            width: 4px;
            height: 16px;
            background: var(--md-primary);
            border-radius: 2px;
        }

        .fokus-abilities-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .fokus-ability-row {
            display: flex;
            gap: 12px;
            align-items: flex-start;
            padding: 12px;
            background: var(--md-surface-container-high);
            border: 2px solid transparent;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .fokus-ability-row:hover {
            border-color: var(--md-outline);
        }

        .fokus-ability-row.selected {
            border: 2px solid transparent;
            background: var(--md-surface-container-high);
        }

        /* Element-specific colors for ability rows in popup */
        .fokus-ability-row.selected.fire { background: linear-gradient(90deg, rgba(255, 107, 53, 0.25) 0%, var(--md-surface-container-high) 100%); }
        .fokus-ability-row.selected.water { background: linear-gradient(90deg, rgba(79, 195, 247, 0.25) 0%, var(--md-surface-container-high) 100%); }
        .fokus-ability-row.selected.wind { background: linear-gradient(90deg, rgba(178, 235, 242, 0.25) 0%, var(--md-surface-container-high) 100%); }
        .fokus-ability-row.selected.earth { background: linear-gradient(90deg, rgba(141, 110, 99, 0.25) 0%, var(--md-surface-container-high) 100%); }
        .fokus-ability-row.selected.lightning { background: linear-gradient(90deg, rgba(255, 235, 59, 0.25) 0%, var(--md-surface-container-high) 100%); }
        .fokus-ability-row.selected.room { background: linear-gradient(90deg, rgba(206, 147, 216, 0.25) 0%, var(--md-surface-container-high) 100%); }
        .fokus-ability-row.selected.illusion { background: linear-gradient(90deg, rgba(179, 157, 219, 0.25) 0%, var(--md-surface-container-high) 100%); }

        .fokus-ability-row.disabled {
            opacity: 0.4;
            cursor: not-allowed;
        }

        .fokus-ability-name {
            font-size: 13px;
            font-weight: 600;
            color: var(--md-on-surface);
            min-width: 140px;
            flex-shrink: 0;
        }

        .fokus-ability-desc {
            font-size: 12px;
            color: var(--md-on-surface-variant);
            line-height: 1.4;
        }

        .fokus-popup-footer {
            padding: 16px 20px;
            border-top: 1px solid var(--md-outline-variant);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .fokus-selection-info {
            font-size: 12px;
            color: var(--md-on-surface-variant);
        }

        .fokus-confirm-btn {
            padding: 10px 24px;
            background: var(--md-primary);
            color: white;
            border: none;
            border-radius: 20px;
            font-weight: 500;
            cursor: pointer;
        }

        .fokus-confirm-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* ===== TABS SYSTEM ===== */
        .tabs-container {
            background: var(--md-surface-container);
            border-radius: var(--shape-lg);
            padding: 24px;
            box-shadow: var(--elevation-2);
            margin-bottom: 24px;
        }

        .tabs-header {
            display: flex;
            gap: 8px;
            margin-bottom: 24px;
            border-bottom: 1px solid var(--md-outline-variant);
        }

        .tab-btn {
            background: transparent;
            border: none;
            padding: 12px 24px;
            color: var(--md-on-surface-variant);
            font-size: 14px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            cursor: pointer;
            position: relative;
            transition: all 200ms cubic-bezier(0.4, 0, 0.2, 1);
            font-family: 'Roboto', sans-serif;
        }

        .tab-btn:hover {
            background: rgba(103, 80, 164, 0.08);
        }

        .tab-btn.active {
            color: var(--md-primary);
        }

        .tab-btn.active::after {
            content: '';
            position: absolute;
            bottom: -1px;
            left: 0;
            right: 0;
            height: 2px;
            background: var(--md-primary);
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        /* ===== GLOBAL POINTS HEADER - SINGLE LINE ===== */
        .global-points-header {
            background: #6750A4;
            color: var(--md-on-primary);
            padding: 12px 24px;
            border-radius: var(--shape-lg);
            margin-bottom: 24px;
            box-shadow: var(--elevation-2);
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 24px;
            flex-wrap: wrap;
        }

        .global-points-title {
            font-weight: 600;
            font-size: 14px;
        }

        .global-points-info {
            display: flex;
            gap: 32px;
            align-items: center;
        }

        .global-counter {
            font-size: 13px;
            font-weight: 500;
        }

        .global-counter strong {
            font-size: 18px;
            font-weight: 700;
            margin-left: 6px;
        }

        .global-points-remaining.warning {
            color: #ffcdd2;
            animation: pulse 1s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }

        /* ===== SKILLS HEADER ===== */
        .skills-header {
            display: flex;
            justify-content: flex-end;
            align-items: center;
            margin-bottom: 16px;
        }

        .category-final-value {
            background: var(--md-primary);
            color: var(--md-on-primary);
            width: 80px;
            height: 42px;
            border-radius: var(--shape-sm);
            font-weight: 700;
            font-size: 20px;
            box-shadow: var(--elevation-2);
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 40px; /* Align with skill-value (32px delete btn + 8px gap) */
        }

        /* ===== SKILLS LIST ===== */
        .skills-grid {
            display: grid;
            gap: 12px;
        }

        .add-skill-btn {
            width: 100%;
            padding: 8px;
            margin-top: 12px;
            background: var(--md-surface-container-high);
            border: 1px dashed var(--md-outline-variant);
            border-radius: var(--shape-sm);
            color: var(--md-on-surface-variant);
            font-size: 18px;
            cursor: pointer;
            transition: all 200ms ease;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .add-skill-btn:hover {
            background: var(--md-surface-container-highest);
            border-color: var(--md-primary);
            color: var(--md-primary);
        }

        .skill-row {
            display: grid;
            grid-template-columns: 1fr 80px 32px;
            gap: 8px;
            align-items: center;
        }

        .skill-delete-btn {
            width: 28px;
            height: 28px;
            border: none;
            background: transparent;
            color: var(--md-on-surface-variant);
            cursor: pointer;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0.4;
            transition: all 150ms ease;
            font-size: 16px;
        }

        .skill-delete-btn:hover {
            opacity: 1;
            background: var(--md-error-container);
            color: var(--md-error);
        }

        .skill-name {
            background: var(--md-surface-container-high);
            border: 1px solid var(--md-outline-variant);
            border-radius: var(--shape-sm);
            padding: 12px 16px;
            color: var(--md-on-surface);
            font-size: 14px;
            font-family: 'Roboto', sans-serif;
            transition: all 200ms cubic-bezier(0.4, 0, 0.2, 1);
        }

        .skill-name:focus {
            outline: none;
            border-color: var(--md-primary);
        }

        .skill-value {
            background: var(--md-surface-container-high);
            border: 1px solid var(--md-outline-variant);
            border-radius: var(--shape-sm);
            padding: 12px 16px;
            color: var(--md-on-surface);
            font-size: 14px;
            font-weight: 600;
            text-align: center;
            font-family: 'Roboto', sans-serif;
            transition: all 200ms cubic-bezier(0.4, 0, 0.2, 1);
        }

        .skill-value:focus {
            outline: none;
            border-color: var(--md-primary);
        }

        /* ===== ZWEITE CHANCE ===== */
        .zweite-chance {
            background: var(--md-surface-container);
            border-radius: var(--shape-lg);
            padding: 24px;
            box-shadow: var(--elevation-2);
            margin-bottom: 24px;
        }

        .zweite-chance h3 {
            font-size: 14px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 16px;
            color: var(--md-on-surface-variant);
        }

        .dice-checks {
            display: flex;
            gap: 24px;
            justify-content: center;
        }

        .dice-check {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 12px;
        }

        .dice-icon {
            width: 80px;
            height: 80px;
            cursor: pointer;
            transition: all 200ms cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
        }

        .dice-icon img {
            width: 100%;
            height: 100%;
            object-fit: contain;
            transition: all 200ms cubic-bezier(0.4, 0, 0.2, 1);
        }

        .dice-icon:hover {
            transform: scale(1.05);
        }

        .dice-icon.used img {
            opacity: 0.2;
        }

        /* Dice Click Animation */
        .dice-icon.clicking {
            animation: diceUseEffect 0.5s ease-out;
        }

        @keyframes diceUseEffect {
            0% { transform: scale(1); }
            20% { transform: scale(1.2) rotate(10deg); }
            40% { transform: scale(0.8) rotate(-5deg); }
            60% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }

        .dice-icon::after {
            content: '';
            position: absolute;
            inset: -10px;
            border-radius: 50%;
            background: var(--md-primary);
            opacity: 0;
            transform: scale(0);
            pointer-events: none;
        }

        .dice-icon.clicking::after {
            animation: diceRipple 0.5s ease-out;
        }

        @keyframes diceRipple {
            0% { transform: scale(0); opacity: 0.4; }
            100% { transform: scale(2); opacity: 0; }
        }

        /* ===== INVENTAR ===== */
        .inventar-section {
            background: var(--md-surface-container);
            border-radius: var(--shape-lg);
            padding: 24px;
            box-shadow: var(--elevation-2);
            margin-bottom: 24px;
        }

        .inventar-section h3 {
            font-size: 14px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 16px;
            color: var(--md-on-surface-variant);
        }

        .inventar-textarea {
            min-height: 300px;
            width: 100%;
        }

        .currency-field {
            margin-bottom: 16px;
        }

        .currency-label {
            display: block;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 8px;
            color: var(--md-on-surface-variant);
        }

        .currency-input-group {
            display: flex;
            gap: 8px;
            align-items: center;
        }

        .currency-input {
            flex: 1;
            max-width: 200px;
        }

        .currency-type-btn {
            width: 48px;
            height: 48px;
            background: var(--md-primary);
            border: none;
            border-radius: var(--shape-md);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 200ms cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: var(--elevation-1);
        }

        .currency-type-btn:hover {
            background: color-mix(in srgb, var(--md-primary) 85%, white);
            transform: scale(1.05);
        }

        .currency-type-btn:active {
            transform: scale(0.95);
        }

        .currency-type-btn img {
            width: 28px;
            height: 28px;
            filter: brightness(0) invert(1);
            transition: transform 200ms ease;
        }

        .currency-type-btn:active img {
            transform: rotate(15deg);
        }

        /* ===== CHARACTER FILE ACTIONS ===== */
        .character-file-actions {
            background: var(--md-surface-container);
            border-radius: var(--shape-lg);
            padding: 24px;
            box-shadow: var(--elevation-2);
            margin-bottom: 24px;
        }

        .character-file-actions h3 {
            font-size: 14px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 16px;
            color: var(--md-on-surface-variant);
            text-align: center;
        }

        .file-action-buttons {
            display: flex;
            gap: 16px;
            justify-content: center;
            align-items: center;
        }

        .file-action-btn {
            background: var(--md-primary);
            color: var(--md-on-primary);
            border: none;
            padding: 12px 24px;
            border-radius: var(--shape-md);
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 200ms cubic-bezier(0.4, 0, 0.2, 1);
            font-family: 'Roboto', sans-serif;
            box-shadow: var(--elevation-2);
        }

        .file-action-btn:hover {
            background: #7c70a0;
            transform: translateY(-2px);
            box-shadow: var(--elevation-3);
        }

        .file-action-btn.danger {
            background: #d32f2f;
        }

        .file-action-btn.danger:hover {
            background: #b71c1c;
        }

        .file-action-btn img {
            width: 20px;
            height: 20px;
        }

        .char-upload-input {
            display: none;
        }

        /* ===== SAVE INDICATOR ===== */
        .save-indicator {
            position: fixed;
            bottom: 24px;
            right: 24px;
            background: var(--md-primary);
            color: var(--md-on-primary);
            padding: 12px 24px;
            border-radius: var(--shape-full);
            font-size: 14px;
            font-weight: 600;
            box-shadow: var(--elevation-3);
            opacity: 0;
            transform: translateY(20px);
            transition: all 300ms cubic-bezier(0.4, 0, 0.2, 1);
            pointer-events: none;
            z-index: 1000;
        }

        .save-indicator.show {
            opacity: 1;
            transform: translateY(0);
        }

        /* ===== POWERED BY FOOTER ===== */
        .powered-by-footer {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: var(--space-sm);
            padding: var(--space-xl) 0;
            margin-top: var(--space-xl);
            border-top: 1px solid var(--md-outline-variant);
        }

        .powered-by-footer span {
            font-size: var(--label-small);
            color: var(--md-on-surface-variant);
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .powered-by-footer a {
            transition: opacity 200ms ease, transform 200ms ease;
        }

        .powered-by-footer a:hover {
            opacity: 0.8;
            transform: scale(1.05);
        }

        .htbah-logo {
            height: 40px;
            width: auto;
        }

        /* ===== HILFE BUTTON ===== */
        .help-btn-container {
            display: flex;
            justify-content: center;
            margin: 24px 0;
        }

        .help-btn {
            background: #2b2930;
            color: var(--md-on-surface);
            border: none;
            padding: 12px 20px;
            border-radius: var(--shape-md);
            cursor: pointer;
            box-shadow: var(--elevation-2);
            transition: all 200ms cubic-bezier(0.4, 0, 0.2, 1);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .help-btn:hover {
            transform: scale(1.02);
            box-shadow: var(--elevation-3);
            background: #3a3840;
        }

        .help-btn img {
            width: 20px;
            height: 20px;
        }

        /* ===== HELP DIALOG ===== */
        .help-dialog-scrim {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.6);
            z-index: 2000;
            align-items: center;
            justify-content: center;
            padding: 24px;
        }

        .help-dialog-scrim.active {
            display: flex;
        }

        .help-dialog {
            background: var(--md-surface-container-high);
            border-radius: var(--shape-xl);
            box-shadow: var(--elevation-3);
            width: 100%;
            max-width: 900px;
            max-height: 90vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        .help-dialog-head {
            padding: 24px;
            border-bottom: 1px solid var(--md-outline-variant);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .help-dialog-title {
            font-size: 24px;
            font-weight: 500;
            color: var(--md-on-surface);
        }

        .help-close-btn {
            background: transparent;
            border: none;
            cursor: pointer;
            padding: 8px;
            border-radius: 8px;
            transition: background 0.2s;
            color: var(--md-on-surface);
            font-size: 24px;
        }

        .help-close-btn:hover {
            background: rgba(103, 80, 164, 0.1);
        }

        .help-dialog-content {
            padding: 24px;
            overflow-y: auto;
            flex: 1;
        }

        .help-tabs {
            display: flex;
            gap: 8px;
            margin-bottom: 24px;
            border-bottom: 1px solid var(--md-outline-variant);
        }

        .help-tab-btn {
            background: transparent;
            border: none;
            padding: 12px 24px;
            color: var(--md-on-surface-variant);
            font-size: 14px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            cursor: pointer;
            position: relative;
            transition: all 200ms cubic-bezier(0.4, 0, 0.2, 1);
            font-family: 'Roboto', sans-serif;
        }

        .help-tab-btn:hover {
            background: rgba(103, 80, 164, 0.08);
        }

        .help-tab-btn.active {
            color: var(--md-primary);
        }

        .help-tab-btn.active::after {
            content: '';
            position: absolute;
            bottom: -1px;
            left: 0;
            right: 0;
            height: 2px;
            background: var(--md-primary);
        }

        .help-category {
            display: none;
        }

        .help-category.active {
            display: block;
        }

        .help-skills-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 12px;
        }

        .help-skill-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 16px;
            background: var(--md-surface-container);
            border-radius: var(--shape-md);
            gap: 12px;
        }

        .help-skill-name {
            font-size: 14px;
            color: var(--md-on-surface);
            flex: 1;
        }

        .help-transfer-btn {
            background: var(--md-primary);
            color: var(--md-on-primary);
            border: none;
            padding: 6px 12px;
            border-radius: var(--shape-sm);
            font-size: 12px;
            font-weight: 500;
            cursor: pointer;
            transition: all 200ms cubic-bezier(0.4, 0, 0.2, 1);
            white-space: nowrap;
            font-family: 'Roboto', sans-serif;
        }

        .help-transfer-btn:hover {
            background: #7c70a0;
        }

        .help-transfer-btn.remove {
            background: var(--md-error);
        }

        .help-transfer-btn.remove:hover {
            background: #d32f2f;
        }

        /* ===== RESPONSIVE ===== */
        @media (max-width: 1024px) {
            .input-row {
                grid-template-columns: 1fr;
            }

            .portrait-container {
                width: 160px;
                height: 160px;
            }
        }

        @media (max-width: 768px) {
            .container {
                padding: 16px;
            }

            .portrait-container {
                width: 140px;
                height: 140px;
            }

            .stats-grid {
                grid-template-columns: repeat(3, 1fr);
                gap: 8px;
            }

            .stat-card {
                padding: 12px 8px;
            }

            .stat-label {
                font-size: 10px;
            }

            .stat-input {
                width: 60px;
                font-size: 16px;
                padding: 6px 8px;
            }

            .stat-separator {
                font-size: 14px;
            }

            .stat-max {
                font-size: 12px;
            }

            .tabs-header {
                flex-wrap: wrap;
            }

            .tab-btn {
                flex: 1;
                min-width: 100px;
            }

            .skill-row {
                grid-template-columns: 1fr 70px 28px;
                gap: 6px;
            }

            .skill-delete-btn {
                width: 24px;
                height: 24px;
                font-size: 14px;
            }

            .dice-checks {
                gap: 16px;
            }

            .dice-icon {
                width: 64px;
                height: 64px;
            }

            .global-points-info {
                flex-direction: row;
                gap: 16px;
                flex-wrap: wrap;
            }

            .global-counter strong {
                font-size: 16px;
            }

            .category-final-value {
                width: 70px;
                height: 38px;
                font-size: 16px;
                margin-right: 34px;
            }

            .help-skills-grid {
                grid-template-columns: 1fr;
            }

            .help-dialog {
                max-width: 100%;
            }

            .file-action-buttons {
                flex-direction: column;
            }

            .file-action-btn {
                width: 100%;
                justify-content: center;
            }
        }

        @media (max-width: 480px) {
            .stat-input {
                width: 50px;
                font-size: 14px;
            }
        }

        /* Print Styles */
        @media print {
            body {
                background: white !important;
                color: black !important;
            }
            
            .container {
                max-width: 100% !important;
                padding: 0 !important;
            }
            
            .nav-container,
            .fly-btn-container,
            .character-file-actions,
            .help-btn-container,
            .powered-by-footer,
            .add-skill-btn,
            .skill-delete-btn,
            .help-dialog-scrim {
                display: none !important;
            }
            
            .portrait-upload-section,
            .character-header,
            .fokus-section,
            .stats-grid,
            .tabs-container,
            .zweite-chance,
            .inventar-section {
                break-inside: avoid;
                page-break-inside: avoid;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- RULESET BOX -->
        <div class="ruleset-box">
            <span class="ruleset-label">Aktuelles Abenteuer:</span>
            <img src="assets/icons/icon_ruleset_rumundrache.svg" alt="Regelwerk" class="ruleset-icon" id="ruleset-icon">
            <span class="ruleset-name" id="ruleset-name">Rum & Rache</span>
        </div>

        <!-- PORTRAIT UPLOAD - GANZ OBEN -->
        <div class="portrait-upload-section">
            <div class="portrait-container" id="portrait-container">
                <div class="portrait-preview" id="portrait-preview" onclick="togglePortraitControls()">
                    <div class="portrait-placeholder" id="portrait-placeholder">
                        <img src="assets/icons/icon_fileupload.png" alt="Upload" style="width: 32px; height: 32px; opacity: 0.7;">
                        <div>Portrait hochladen</div>
                        <div style="font-size: 12px; margin-top: 8px;">Max. 400x400px</div>
                    </div>
                </div>
                <div class="portrait-controls" id="portrait-controls">
                    <button class="portrait-btn change" onclick="openFileDialog(event)" title="Bild ändern">
                        <img src="assets/icons/icon_image.png" alt="Ändern">
                    </button>
                    <button class="portrait-btn remove" id="portrait-remove" onclick="removePortrait(event)" title="Bild entfernen">
                        <img src="assets/icons/icon_delete.png" alt="Löschen">
                    </button>
                </div>
                <input type="file" id="portrait-input" class="portrait-upload-input" accept="image/*" onchange="handlePortraitUpload(event)">
            </div>
            
            <!-- Trennlinie -->
            <div class="portrait-divider"></div>
            
            <!-- Jolly Roger Upload + Crew -->
            <div class="jolly-wrapper">
                <div class="jolly-container" id="jolly-container">
                    <div class="jolly-preview" id="jolly-preview" onclick="toggleJollyControls()">
                        <div class="jolly-placeholder" id="jolly-placeholder">
                            <img src="assets/icons/icon_fileupload.png" alt="Upload" style="width: 24px; height: 24px; opacity: 0.7;">
                            <div>Jolly Roger</div>
                            <div style="font-size: 11px; margin-top: 4px;">Max. 400x230px</div>
                        </div>
                    </div>
                    <div class="jolly-controls" id="jolly-controls">
                        <button class="portrait-btn change" onclick="openJollyDialog(event)" title="Bild ändern">
                            <img src="assets/icons/icon_image.png" alt="Ändern">
                        </button>
                        <button class="portrait-btn remove" id="jolly-remove" onclick="removeJolly(event)" title="Bild entfernen">
                            <img src="assets/icons/icon_delete.png" alt="Löschen">
                        </button>
                    </div>
                    <input type="file" id="jolly-input" class="portrait-upload-input" accept="image/*" onchange="handleJollyUpload(event)">
                </div>
                
                <!-- Crew Input -->
                <div class="crew-input-container">
                    <input type="text" class="crew-input" id="char-crew" placeholder="Name der Piraten-Crew...">
                </div>
            </div>
        </div>

        <!-- CHARACTER HEADER -->
        <div class="character-header">
            <div class="header-grid">
                <div class="input-row">
                    <div class="input-group">
                        <label>Name</label>
                        <input type="text" class="input-field" id="char-name" placeholder="Dein Charaktername...">
                    </div>
                    <div class="input-group">
                        <label>Geschlecht</label>
                        <input type="text" class="input-field" id="char-gender" placeholder="z.B. Männlich, Weiblich...">
                    </div>
                </div>
                <div class="input-row">
                    <div class="input-group">
                        <label>Alter</label>
                        <input type="text" class="input-field" id="char-age" placeholder="z.B. 25 Jahre">
                    </div>
                    <div class="input-group">
                        <label>Rolle in der Crew</label>
                        <input type="text" class="input-field" id="char-role" placeholder="z.B. Kapitän, Navigator...">
                    </div>
                </div>
                <div class="input-group">
                    <label>Aussehen</label>
                    <input type="text" class="input-field" id="char-aussehen" placeholder="z.B. 1.80m, athletisch, blaue Augen...">
                </div>
            </div>
        </div>

        <!-- FOKUS SYSTEM -->
        <div class="fokus-section">
            <div class="fokus-header">
                <label>Fokus</label>
            </div>
            <div class="fokus-grid" id="fokusGrid">
                <!-- Desktop: Icon card (hidden on mobile) -->
                <div class="fokus-type-card fokus-desktop-only" id="fokusTypeCardDesktop" onclick="openFokusPopup()">
                    <img src="assets/icons/icon_focus_fire.png" alt="Fokus" id="fokusTypeIconDesktop" style="display: none;">
                    <span class="fokus-type-placeholder" id="fokusTypePlaceholderDesktop">?</span>
                </div>
                <!-- Mobile: Top row with icon + name -->
                <div class="fokus-top-row" id="fokusTopRow">
                    <div class="fokus-type-card" id="fokusTypeCard" onclick="openFokusPopup()">
                        <img src="assets/icons/icon_focus_fire.png" alt="Fokus" id="fokusTypeIcon" style="display: none;">
                        <span class="fokus-type-placeholder" id="fokusTypePlaceholder">?</span>
                    </div>
                    <div class="fokus-type-name-mobile" id="fokusTypeNameMobile">-</div>
                </div>
                <div class="fokus-ability-card" id="fokusAbility1">
                    <div class="fokus-ability-content">
                        <span class="fokus-ability-placeholder">Fähigkeit 1</span>
                        <span class="fokus-ability-name"></span>
                        <span class="fokus-ability-desc-small"></span>
                    </div>
                </div>
                <div class="fokus-ability-card" id="fokusAbility2">
                    <div class="fokus-ability-content">
                        <span class="fokus-ability-placeholder">Fähigkeit 2</span>
                        <span class="fokus-ability-name"></span>
                        <span class="fokus-ability-desc-small"></span>
                    </div>
                </div>
                <div class="fokus-ability-card locked" id="fokusAbility3">
                    <div class="fokus-ability-content">
                        <span class="fokus-ability-placeholder">🔒</span>
                        <span class="fokus-ability-name"></span>
                        <span class="fokus-ability-desc-small"></span>
                    </div>
                </div>
            </div>
        </div>

        <!-- STATS -->
        <div class="stats-grid" id="statsGrid">
            <div class="stat-card leben" id="lebenCard">
                <div class="stat-label">Lebenspunkte</div>
                <div class="stat-input-group">
                    <input type="number" class="stat-input" id="leben-current" value="100" min="0" max="100">
                    <span class="stat-separator">/</span>
                    <span class="stat-max">100</span>
                </div>
                <div class="progress-bar">
                    <div class="progress-fill leben" id="leben-bar" style="width: 100%"></div>
                </div>
            </div>

            <div class="stat-card moral" id="moralCard">
                <div class="stat-label">Moral</div>
                <div class="stat-input-group">
                    <input type="number" class="stat-input" id="moral-current" value="100" min="0" max="100">
                    <span class="stat-separator">/</span>
                    <span class="stat-max">100</span>
                </div>
                <div class="progress-bar">
                    <div class="progress-fill moral" id="moral-bar" style="width: 100%"></div>
                </div>
            </div>

            <div class="stat-card resonanz" id="resonanzCard">
                <div class="stat-label">Resonanz</div>
                <div class="stat-input-group">
                    <input type="number" class="stat-input" id="resonanz-value" value="0" min="0" max="100">
                    <span class="stat-separator">%</span>
                </div>
                <div class="progress-bar">
                    <div class="progress-fill resonanz" id="resonanz-bar" style="width: 0%"></div>
                </div>
            </div>
        </div>

        <!-- GLOBAL POINTS COUNTER - SINGLE LINE -->
        <div class="global-points-header" id="global-points-header">
            <div class="global-points-title">Punkteübersicht</div>
            <div class="global-points-info">
                <div class="global-counter">
                    Vergeben: <strong id="global-used">0</strong>
                </div>
                <div class="global-counter global-points-remaining" id="global-remaining-container">
                    Verbleibend: <strong id="global-remaining">500</strong>
                </div>
            </div>
        </div>

        <!-- TABS: BEGABUNGEN WERTE -->
        <div class="tabs-container">
            <div class="tabs-header">
                <button class="tab-btn active" data-tab="handeln">Handeln</button>
                <button class="tab-btn" data-tab="wissen">Wissen</button>
                <button class="tab-btn" data-tab="soziales">Soziales</button>
            </div>

            <!-- HANDELN TAB -->
            <div class="tab-content active" id="tab-handeln">
                <div class="skills-header">
                    <div class="category-final-value" id="handeln-final">0</div>
                </div>
                <div class="skills-grid" id="skills-handeln"></div>
                <button class="add-skill-btn" onclick="addSkillRow('handeln')" title="Weitere Begabung hinzufügen">
                    <span>+</span>
                </button>
            </div>

            <!-- WISSEN TAB -->
            <div class="tab-content" id="tab-wissen">
                <div class="skills-header">
                    <div class="category-final-value" id="wissen-final">0</div>
                </div>
                <div class="skills-grid" id="skills-wissen"></div>
                <button class="add-skill-btn" onclick="addSkillRow('wissen')" title="Weitere Begabung hinzufügen">
                    <span>+</span>
                </button>
            </div>

            <!-- SOZIALES TAB -->
            <div class="tab-content" id="tab-soziales">
                <div class="skills-header">
                    <div class="category-final-value" id="soziales-final">0</div>
                </div>
                <div class="skills-grid" id="skills-soziales"></div>
                <button class="add-skill-btn" onclick="addSkillRow('soziales')" title="Weitere Begabung hinzufügen">
                    <span>+</span>
                </button>
            </div>
        </div>

        <!-- HILFE BUTTON -->
        <div class="help-btn-container">
            <button class="help-btn" onclick="toggleHelpDialog()" title="Begabungen-Hilfe">
                <img src="assets/icons/icon_help.png" alt="Hilfe">
                <span>Begabungen-Hilfe</span>
            </button>
        </div>

        <!-- ZWEITE CHANCE -->
        <div class="zweite-chance">
            <h3>Zweite Chance</h3>
            <div class="dice-checks">
                <div class="dice-check">
                    <div class="dice-icon" data-dice="1">
                        <img src="assets/icons/icon_dice20.png" alt="W20">
                    </div>
                </div>
                <div class="dice-check">
                    <div class="dice-icon" data-dice="2">
                        <img src="assets/icons/icon_dice20.png" alt="W20">
                    </div>
                </div>
                <div class="dice-check">
                    <div class="dice-icon" data-dice="3">
                        <img src="assets/icons/icon_dice20.png" alt="W20">
                    </div>
                </div>
            </div>
        </div>

        <!-- INVENTAR -->
        <div class="inventar-section">
            <h3>Inventar</h3>
            <div class="currency-field">
                <label class="currency-label">Währung</label>
                <div class="currency-input-group">
                    <input type="text" inputmode="numeric" pattern="[0-9.]*" class="input-field currency-input" id="char-currency" placeholder="Menge eingeben" oninput="formatCurrency(this)">
                    <button class="currency-type-btn" id="currency-type-btn" onclick="rotateCurrencyType()" title="Währungstyp wechseln">
                        <img src="assets/icons/icon_dollar.png" alt="Währung" id="currency-icon">
                    </button>
                </div>
            </div>
            <textarea class="input-field inventar-textarea" id="char-inventar" placeholder="Trage hier dein Inventar ein..."></textarea>
        </div>

        <!-- CHARACTER FILE DOWNLOAD/UPLOAD -->
        <div class="character-file-actions">
            <h3>Charakterbogen verwalten</h3>
            <div class="file-action-buttons">
                <button class="file-action-btn" onclick="downloadCharacter()">
                    <img src="assets/icons/icon_filedownload.png" alt="Download">
                    <span>JSON herunterladen</span>
                </button>
                <button class="file-action-btn" onclick="document.getElementById('char-upload-input').click()">
                    <img src="assets/icons/icon_fileupload.png" alt="Upload">
                    <span>JSON hochladen</span>
                </button>
                <button class="file-action-btn" onclick="exportAsPDF()">
                    <img src="assets/icons/icon_filedownload.png" alt="PDF">
                    <span>Als PDF drucken</span>
                </button>
                <button class="file-action-btn danger" onclick="resetCharacter()">
                    <img src="assets/icons/icon_delete.png" alt="Reset">
                    <span>Zurücksetzen</span>
                </button>
            </div>
            <input type="file" id="char-upload-input" class="char-upload-input" accept=".json" onchange="uploadCharacter(event)">
        </div>

        <!-- POWERED BY FOOTER -->
        <div class="powered-by-footer">
            <span>Powered by</span>
            <a href="https://howtobeahero.de/index.php/Hauptseite" target="_blank" rel="noopener noreferrer">
                <img src="assets/images/logo_htbah_light.png" alt="How To Be A Hero" class="htbah-logo">
            </a>
        </div>
    </div>

    <!-- SAVE INDICATOR -->
    <div class="save-indicator" id="save-indicator">
        <img src="assets/icons/icon_save.png" alt="" style="width:16px;height:16px;vertical-align:middle;margin-right:6px;filter:brightness(0) invert(1);"> Gespeichert
    </div>

    <!-- HELP DIALOG -->
    <div class="help-dialog-scrim" id="helpDialog" onclick="if(event.target === this) toggleHelpDialog()">
        <div class="help-dialog" onclick="event.stopPropagation()">
            <div class="help-dialog-head">
                <h2 class="help-dialog-title">Begabungen - Beispiele</h2>
                <button class="help-close-btn" onclick="toggleHelpDialog()">×</button>
            </div>
            <div class="help-dialog-content">
                <div class="help-tabs">
                    <button class="help-tab-btn active" data-help-tab="handeln">Handeln</button>
                    <button class="help-tab-btn" data-help-tab="wissen">Wissen</button>
                    <button class="help-tab-btn" data-help-tab="soziales">Soziales</button>
                </div>

                <!-- HANDELN EXAMPLES -->
                <div class="help-category active" id="help-handeln">
                    <div class="help-skills-grid" id="help-handeln-grid">
                        <!-- Dynamically populated -->
                    </div>
                </div>

                <!-- WISSEN EXAMPLES -->
                <div class="help-category" id="help-wissen">
                    <div class="help-skills-grid" id="help-wissen-grid">
                        <!-- Dynamically populated -->
                    </div>
                </div>

                <!-- SOZIALES EXAMPLES -->
                <div class="help-category" id="help-soziales">
                    <div class="help-skills-grid" id="help-soziales-grid">
                        <!-- Dynamically populated -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

    <!-- AUTH & NAVIGATION -->
    <script src="assets/js/auth.js"></script>
    <script src="assets/js/firebase-sync.js"></script>
    <script src="assets/js/nav.js"></script>

    <script>
        'use strict';

        requireAuth();

        const moduleTools = ``;
        createNavigationBar('Charakterbogen', moduleTools);
        
        // ===== GM VIEW SYSTEM =====
        let isGM = false;
        let allPlayers = {};
        let viewingPlayer = null; // null = own character, string = other player's name
        let unsubscribePlayers = null;
        let unsubscribeCharacters = null;

        async function initGMView() {
            const user = getCurrentUser();
            isGM = user?.isGM || false;
            
            await initFirebase();
            
            if (isGM && isFirebaseOnline()) {
                // Create player selector bar
                createPlayerBar();
                
                // Listen for players
                unsubscribePlayers = onPlayersChange(updatePlayerBar);
                
                // Check URL parameter for direct character view
                const urlParams = new URLSearchParams(window.location.search);
                const viewParam = urlParams.get('view');
                if (viewParam) {
                    console.log('[Charakter] GM view requested for:', viewParam);
                    
                    // Wait for players to load, then switch
                    const waitForPlayers = () => {
                        if (Object.keys(allPlayers).length === 0) {
                            setTimeout(waitForPlayers, 100);
                            return;
                        }
                        
                        // Load the character directly using the key
                        viewingPlayer = viewParam;
                        document.body.classList.add('gm-readonly');
                        
                        // Update player bar to reflect current selection
                        updatePlayerBar(allPlayers);
                        
                        // Add banner
                        const existingBanner = document.querySelector('.gm-viewing-banner');
                        if (!existingBanner) {
                            const banner = document.createElement('div');
                            banner.className = 'gm-viewing-banner';
                            banner.innerHTML = `
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/>
                                    <circle cx="12" cy="12" r="3"/>
                                </svg>
                                Du siehst den Charakterbogen von <strong>${viewParam}</strong> (Nur Ansicht)
                            `;
                            const container = document.querySelector('.container');
                            const playerBar = document.getElementById('playerBar');
                            if (playerBar) {
                                container.insertBefore(banner, playerBar.nextSibling);
                            } else {
                                container.insertBefore(banner, container.firstChild);
                            }
                        }
                        
                        // Load the character - viewParam is already the sanitized key
                        getRef(`characters/${viewParam}`).once('value').then(snapshot => {
                            const data = snapshot.val();
                            console.log('[Charakter] Loaded character data:', data ? 'found' : 'not found');
                            if (data) {
                                applyCharacterData(data);
                            }
                        });
                    };
                    
                    setTimeout(waitForPlayers, 200);
                }
            }
            
            // Listen for character updates (both GM and players)
            if (isFirebaseOnline()) {
                listenToAllCharacters();
            }
            
            // Sync own character to Firebase
            if (isFirebaseOnline() && !isGM) {
                syncCharacterToFirebase();
            }
            
            // Init dice popups
            initDicePopupListener();
        }

        function createPlayerBar() {
            const bar = document.createElement('div');
            bar.id = 'playerBar';
            bar.className = 'player-bar';
            bar.innerHTML = `
                <div class="player-bar-inner" id="playerBarInner">
                    <div class="player-bar-label">Spieler:</div>
                </div>
            `;
            
            // Insert after nav
            const container = document.querySelector('.container');
            container.insertBefore(bar, container.firstChild);
            
            // Add styles
            if (!document.getElementById('playerBarStyles')) {
                const style = document.createElement('style');
                style.id = 'playerBarStyles';
                style.textContent = `
                    .player-bar {
                        background: var(--md-surface-container);
                        border-radius: var(--shape-lg);
                        padding: 8px 16px;
                        margin-bottom: 16px;
                        overflow-x: auto;
                        box-shadow: var(--elevation-1);
                    }
                    
                    .player-bar-inner {
                        display: flex;
                        align-items: center;
                        gap: 8px;
                        min-width: max-content;
                    }
                    
                    .player-bar-label {
                        font-size: 12px;
                        color: var(--md-on-surface-variant);
                        font-weight: 500;
                    }
                    
                    .player-tab {
                        display: flex;
                        align-items: center;
                        gap: 6px;
                        padding: 6px 12px;
                        background: var(--md-surface-container-high);
                        border: 2px solid transparent;
                        border-radius: var(--shape-full);
                        font-size: 13px;
                        font-weight: 500;
                        color: var(--md-on-surface);
                        cursor: pointer;
                        transition: all 200ms ease;
                        white-space: nowrap;
                    }
                    
                    .player-tab:hover {
                        background: var(--md-surface-container-highest);
                    }
                    
                    .player-tab.active {
                        border-color: var(--md-primary);
                        background: color-mix(in srgb, var(--md-primary) 15%, var(--md-surface-container));
                    }
                    
                    .player-tab-dot {
                        width: 10px;
                        height: 10px;
                        border-radius: 50%;
                    }
                    
                    .player-tab.own {
                        font-style: italic;
                    }
                    
                    .gm-viewing-banner {
                        background: color-mix(in srgb, var(--md-primary) 10%, var(--md-surface-container));
                        border: 1px solid var(--md-primary);
                        border-radius: var(--shape-md);
                        padding: 8px 16px;
                        margin-bottom: 16px;
                        font-size: 13px;
                        color: var(--md-on-surface);
                        display: flex;
                        align-items: center;
                        gap: 8px;
                    }
                    
                    .gm-viewing-banner svg {
                        width: 18px;
                        height: 18px;
                        color: var(--md-primary);
                    }
                    
                    /* Read-only mode for GM viewing others */
                    .gm-readonly .input-field,
                    .gm-readonly .skill-value,
                    .gm-readonly .stat-input,
                    .gm-readonly .skill-name,
                    .gm-readonly textarea,
                    .gm-readonly select {
                        pointer-events: none;
                        opacity: 0.8;
                    }
                    
                    .gm-readonly .portrait-btn,
                    .gm-readonly .currency-type-btn,
                    .gm-readonly .skill-btn,
                    .gm-readonly .add-skill-btn,
                    .gm-readonly .dice-icon {
                        pointer-events: none;
                        opacity: 0.6;
                    }
                `;
                document.head.appendChild(style);
            }
        }

        function updatePlayerBar(players) {
            allPlayers = players;
            const container = document.getElementById('playerBarInner');
            if (!container) return;
            
            const user = getCurrentUser();
            
            // Clear existing tabs (keep label)
            container.innerHTML = `<div class="player-bar-label">Spieler:</div>`;
            
            // Add "Eigener Charakter" tab
            const ownTab = document.createElement('button');
            ownTab.className = `player-tab own ${!viewingPlayer ? 'active' : ''}`;
            ownTab.innerHTML = `
                <span class="player-tab-dot" style="background: ${user?.color || '#6750a4'}"></span>
                Eigener Charakter
            `;
            ownTab.onclick = () => switchToPlayer(null);
            container.appendChild(ownTab);
            
            // Add other players
            Object.values(players).forEach(player => {
                if (player.username === user?.username) return; // Skip self
                if (player.isGM) return; // Skip other GMs
                
                const sanitizedName = sanitizeKey(player.username);
                const tab = document.createElement('button');
                tab.className = `player-tab ${viewingPlayer === player.username || viewingPlayer === sanitizedName ? 'active' : ''}`;
                tab.dataset.player = player.username;
                tab.dataset.playerKey = sanitizedName;
                tab.innerHTML = `
                    <span class="player-tab-dot" style="background: ${player.color}"></span>
                    ${player.username}
                `;
                tab.onclick = () => switchToPlayer(player.username);
                container.appendChild(tab);
            });
        }

        function switchToPlayer(playerName) {
            viewingPlayer = playerName;
            console.log('[Charakter] switchToPlayer:', playerName);
            
            // Update tabs
            document.querySelectorAll('.player-tab').forEach(tab => {
                tab.classList.remove('active');
                // Activate correct tab based on playerName (can be username or sanitized key)
                if (playerName === null && tab.classList.contains('own')) {
                    tab.classList.add('active');
                } else if (tab.dataset.player === playerName || tab.dataset.playerKey === playerName) {
                    tab.classList.add('active');
                    // Use the actual username for loading
                    if (tab.dataset.player) {
                        viewingPlayer = tab.dataset.player;
                    }
                }
            });
            
            // Remove existing banner
            const existingBanner = document.querySelector('.gm-viewing-banner');
            if (existingBanner) existingBanner.remove();
            
            if (playerName) {
                // Viewing another player
                document.body.classList.add('gm-readonly');
                
                // Add banner
                const banner = document.createElement('div');
                banner.className = 'gm-viewing-banner';
                banner.innerHTML = `
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/>
                        <circle cx="12" cy="12" r="3"/>
                    </svg>
                    Du siehst den Charakterbogen von <strong>${playerName}</strong> (Nur Ansicht)
                `;
                const container = document.querySelector('.container');
                const playerBar = document.getElementById('playerBar');
                container.insertBefore(banner, playerBar.nextSibling);
                
                // Load their character
                loadPlayerCharacter(playerName);
            } else {
                // Viewing own character
                document.body.classList.remove('gm-readonly');
                
                // Reload own character from localStorage
                characterData = loadCharacter();
                renderAllFields();
            }
        }

        function listenToAllCharacters() {
            // Listen for character updates from all players
            if (!database) return;
            
            const user = getCurrentUser();
            
            unsubscribeCharacters = getRef('characters').on('value', (snapshot) => {
                const characters = snapshot.val() || {};
                
                // If we're viewing another player (GM mode), update their data
                if (viewingPlayer) {
                    const playerChar = characters[sanitizeKey(viewingPlayer)];
                    if (playerChar) {
                        applyCharacterData(playerChar);
                    }
                }
                // If we're a regular player, listen for GM changes to our own character
                else if (user && !user.isGM) {
                    const myChar = characters[sanitizeKey(user.username)];
                    if (myChar && myChar.updatedAt) {
                        // Check if this is a remote update (not from us)
                        const lastLocalSave = characterData._lastLocalSave || 0;
                        if (myChar.updatedAt > lastLocalSave) {
                            console.log('[Charakter] Remote update detected, applying...');
                            applyCharacterData(myChar);
                        }
                    }
                }
            });
        }

        function loadPlayerCharacter(playerName) {
            if (!database) return;
            
            getRef(`characters/${sanitizeKey(playerName)}`).once('value').then(snapshot => {
                const data = snapshot.val();
                if (data) {
                    applyCharacterData(data);
                } else {
                    // No data - show empty
                    applyCharacterData(getDefaultCharacterData());
                }
            });
        }

        function syncCharacterToFirebase() {
            const user = getCurrentUser();
            if (!user || user.isGM) return; // GMs don't sync their character
            
            // Hook into existing save function
            const originalSaveCharacter = window.saveCharacter;
            if (typeof originalSaveCharacter === 'function') {
                window.saveCharacter = function(showIndicator = false) {
                    originalSaveCharacter(showIndicator);
                    syncCharacterToFirebase_inner();
                };
            }
            
            // Initial sync
            syncCharacterToFirebase_inner();
        }
        
        function syncCharacterToFirebase_inner() {
            if (!isFirebaseOnline()) return;
            const user = getCurrentUser();
            if (!user || user.isGM) return;
            
            // Mark this as a local save to avoid triggering our own listener
            const timestamp = Date.now();
            characterData._lastLocalSave = timestamp;
            
            console.log('[Charakter] Syncing to Firebase...');
            getRef(`characters/${sanitizeKey(user.username)}`).set({
                ...characterData,
                updatedAt: timestamp
            });
        }

        function debounce(fn, delay) {
            let timeout;
            return function(...args) {
                clearTimeout(timeout);
                timeout = setTimeout(() => fn.apply(this, args), delay);
            };
        }

        function sanitizeKey(str) {
            return str.replace(/[.#$\/\[\]]/g, '_');
        }

        function applyCharacterData(data) {
            characterData = { ...loadCharacter(), ...data };
            renderAllFields();
        }

        function renderAllFields() {
            // Re-render all form fields from characterData
            console.log('[Charakter] Rendering fields:', characterData);
            
            // Basic fields - ID → data key mapping
            const fieldMapping = {
                'char-name': 'name',
                'char-gender': 'gender',
                'char-age': 'age',
                'char-role': 'role',
                'char-crew': 'crew',
                'char-aussehen': 'aussehen',
                'char-inventar': 'inventar',
                'char-currency': 'currency'
            };
            
            Object.entries(fieldMapping).forEach(([id, key]) => {
                const el = document.getElementById(id);
                if (el) {
                    el.value = characterData[key] || '';
                }
            });
            
            // Update Fokus display
            updateFokusDisplay();
            
            // Portrait & Jolly
            updatePortraitDisplay();
            updateJollyDisplay();
            
            // Leben/Moral - korrigierte IDs
            if (characterData.leben) {
                const lebenCurrent = document.getElementById('leben-current');
                const lebenMax = document.getElementById('leben-max');
                if (lebenCurrent) lebenCurrent.value = characterData.leben.current || 100;
                if (lebenMax) lebenMax.value = characterData.leben.max || 100;
            }
            if (characterData.moral) {
                const moralCurrent = document.getElementById('moral-current');
                const moralMax = document.getElementById('moral-max');
                if (moralCurrent) moralCurrent.value = characterData.moral.current || 100;
                if (moralMax) moralMax.value = characterData.moral.max || 100;
            }
            
            // Resonanz
            const resonanzEl = document.getElementById('resonanz-value');
            if (resonanzEl) resonanzEl.value = characterData.resonanz || 0;
            const resonanzBar = document.getElementById('resonanz-bar');
            if (resonanzBar) resonanzBar.style.width = `${characterData.resonanz || 0}%`;
            
            // Zweite Chance checkboxes
            if (characterData.zweiteChance && Array.isArray(characterData.zweiteChance)) {
                characterData.zweiteChance.forEach((checked, i) => {
                    const cb = document.getElementById(`zweiteChance${i + 1}`);
                    if (cb) cb.checked = checked;
                });
            }
            
            // Currency Type (Icon)
            if (characterData.currencyType) {
                const CURRENCY_TYPES_MAP = {
                    'dollar': 'icon_dollar.png',
                    'gold': 'icon_gold.png', 
                    'silver': 'icon_silver.png',
                    'copper': 'icon_copper.png',
                    'gem': 'icon_gem.png'
                };
                const iconFile = CURRENCY_TYPES_MAP[characterData.currencyType] || 'icon_dollar.png';
                const currencyIcon = document.getElementById('currency-icon');
                if (currencyIcon) {
                    currencyIcon.src = `assets/icons/${iconFile}`;
                }
            }
            
            // Skills - Re-render from characterData
            if (characterData.skills) {
                ['handeln', 'wissen', 'soziales'].forEach(category => {
                    const container = document.getElementById(`skills-${category}`);
                    if (!container || !characterData.skills[category]) return;
                    
                    const skills = characterData.skills[category];
                    
                    // Update existing inputs or recreate
                    const rows = container.querySelectorAll('.skill-row');
                    skills.forEach((skill, index) => {
                        if (rows[index]) {
                            const nameInput = rows[index].querySelector('.skill-name');
                            const valueInput = rows[index].querySelector('.skill-value');
                            if (nameInput) nameInput.value = skill.name || '';
                            if (valueInput) valueInput.value = skill.value || 0;
                        }
                    });
                });
            }
            
            // Update point counters
            updatePointCounters();
            
            // Update progress bars and check death
            updateProgressBars();
        }
        
        function updatePortraitDisplay() {
            const preview = document.getElementById('portrait-preview');
            const placeholder = document.getElementById('portrait-placeholder');
            const removeBtn = document.getElementById('portrait-remove');
            
            if (characterData.portrait) {
                preview.style.backgroundImage = `url(${characterData.portrait})`;
                preview.style.backgroundSize = 'cover';
                preview.style.backgroundPosition = 'center';
                if (placeholder) placeholder.style.display = 'none';
                if (removeBtn) removeBtn.style.display = 'flex';
            } else {
                preview.style.backgroundImage = '';
                if (placeholder) placeholder.style.display = 'flex';
                if (removeBtn) removeBtn.style.display = 'none';
            }
        }
        
        function updateJollyDisplay() {
            const preview = document.getElementById('jolly-preview');
            const placeholder = document.getElementById('jolly-placeholder');
            const removeBtn = document.getElementById('jolly-remove');
            
            if (characterData.jollyRoger) {
                preview.style.backgroundImage = `url(${characterData.jollyRoger})`;
                preview.style.backgroundSize = 'cover';
                preview.style.backgroundPosition = 'center';
                if (placeholder) placeholder.style.display = 'none';
                if (removeBtn) removeBtn.style.display = 'flex';
            } else {
                preview.style.backgroundImage = '';
                if (placeholder) placeholder.style.display = 'flex';
                if (removeBtn) removeBtn.style.display = 'none';
            }
        }

        // Initialize GM view after page loads
        setTimeout(initGMView, 100);

        const STORAGE_KEY_PREFIX = 'rumRache_character_';

        function getStorageKey() {
            const user = getCurrentUser();
            const username = user && user.username
                ? user.username
                : localStorage.getItem('rumRache_currentUser');

            return STORAGE_KEY_PREFIX + (username || 'unknown');
        }
        const TOTAL_POINTS = 500;
        const SKILLS_PER_CATEGORY = 10;

        // Example Skills Database
        const EXAMPLE_SKILLS = {
            handeln: [
                'Klettern', 'Akrobatik', 'Kraft', 'Ausdauer', 'Balance', 'Sprinten', 'Springen', 'Schwimmen', 
                'Tauchen', 'Tragen', 'Ziehen', 'Drücken', 'Heben', 'Werfen', 'Fangen', 'Präzision', 
                'Feinarbeit', 'Handwerk', 'Reparieren', 'Mechanik', 'Bauen', 'Abbauen', 'Sabotage', 
                'Schlösser öffnen', 'Sicherungen umgehen', 'Werkzeuge nutzen', 'Waffenhandhabung', 
                'Nahkampf', 'Fernkampf', 'Ausweichen', 'Blocken', 'Entwaffnen', 'Ringen', 'Festsetzen', 
                'Sichern', 'Schleichen', 'Verbergen', 'Anschleichen', 'Spuren verwischen', 'Orientierung', 
                'Navigation', 'Steuern', 'Segeln', 'Reiten', 'Fahren', 'Überleben', 'Jagen', 'Lagern', 
                'Durchhalten', 'Erste Hilfe', 'Heilen'
            ],
            wissen: [
                'Sprachen', 'Geschichte', 'Geographie', 'Politik', 'Religion', 'Philosophie', 'Mathematik', 
                'Physik', 'Chemie', 'Biologie', 'Medizin', 'Anatomie', 'Technik', 'Mechanik', 'Architektur', 
                'Bauwesen', 'Seefahrt', 'Navigation', 'Astronomie', 'Wetterkunde', 'Naturkunde', 'Flora', 
                'Fauna', 'Landwirtschaft', 'Bergbau', 'Metallurgie', 'Recht', 'Verwaltung', 'Bürokratie', 
                'Militärwesen', 'Taktik', 'Strategie', 'Handel', 'Wirtschaft', 'Buchhaltung', 'Logistik', 
                'Literatur', 'Kunst', 'Musiktheorie', 'Symbolkunde', 'Mythenkunde', 'Kryptographie', 
                'Codes & Zeichen', 'Spurenlesen', 'Kartographie', 'Informatik', 'Programmieren', 
                'Datenanalyse', 'Psychologie', 'Soziologie', 'Wahrnehmung'
            ],
            soziales: [
                'Überreden', 'Überzeugen', 'Verhandeln', 'Argumentieren', 'Diskutieren', 'Debattieren', 
                'Schmeicheln', 'Einschmeicheln', 'Bitten', 'Betteln', 'Fordern', 'Befehlen', 'Einschüchtern', 
                'Drohen', 'Provozieren', 'Beschwichtigen', 'Beruhigen', 'Trösten', 'Motivieren', 'Anführen', 
                'Führen', 'Autorität zeigen', 'Respekt einfordern', 'Lügen', 'Täuschen', 'Bluffen', 
                'Irreführen', 'Verschweigen', 'Manipulieren', 'Verunsichern', 'Verhören', 'Befragen', 
                'Ausfragen', 'Zuhören', 'Beobachten (Sozial)', 'Menschenkenntnis', 'Stimmungen lesen', 
                'Empathie zeigen', 'Vertrauen aufbauen', 'Vertrauen brechen', 'Kontakte knüpfen', 
                'Netzwerken', 'Gerüchte streuen', 'Gerüchte nutzen', 'Auftreten', 'Reden halten', 
                'Vermitteln', 'Schlichten', 'Überzeugen durch Beispiel', 'Loyalität einfordern'
            ]
        };

        // Track transferred skills per category
        let transferredSkills = {
            handeln: new Set(),
            wissen: new Set(),
            soziales: new Set()
        };

        let characterData = loadCharacter();
        let saveTimeout = null;

        // Initialize Help Dialog with skills
        function initializeHelpDialog() {
            Object.keys(EXAMPLE_SKILLS).forEach(category => {
                const grid = document.getElementById(`help-${category}-grid`);
                grid.innerHTML = '';

                EXAMPLE_SKILLS[category].forEach(skill => {
                    const item = document.createElement('div');
                    item.className = 'help-skill-item';
                    item.dataset.skillName = skill;
                    item.dataset.category = category;

                    const isTransferred = transferredSkills[category].has(skill);

                    item.innerHTML = `
                        <span class="help-skill-name">${skill}</span>
                        <button class="help-transfer-btn ${isTransferred ? 'remove' : ''}" 
                                onclick="handleSkillTransfer('${category}', '${skill}', this)">
                            ${isTransferred ? 'Löschen' : 'Übertragen'}
                        </button>
                    `;
                    grid.appendChild(item);
                });
            });
        }

        // Handle skill transfer or removal
        function handleSkillTransfer(category, skillName, btnElement) {
            const skills = characterData.skills[category];
            const isCurrentlyTransferred = transferredSkills[category].has(skillName);

            if (isCurrentlyTransferred) {
                // Remove skill
                const skillIndex = skills.findIndex(s => s.name === skillName);
                if (skillIndex !== -1) {
                    skills[skillIndex].name = '';
                    skills[skillIndex].value = 0;
                }
                transferredSkills[category].delete(skillName);

                btnElement.textContent = 'Übertragen';
                btnElement.classList.remove('remove');
            } else {
                // Transfer skill
                const emptyIndex = skills.findIndex(s => !s.name || s.name.trim() === '');

                if (emptyIndex === -1) {
                    alert('Keine freien Plätze in dieser Kategorie!');
                    return;
                }

                skills[emptyIndex].name = skillName;
                transferredSkills[category].add(skillName);

                btnElement.textContent = 'Löschen';
                btnElement.classList.add('remove');
            }

            saveCharacter();
            initializeSkills();
            updatePointCounters();
        }

        // Load transferred skills from character data
        function loadTransferredSkills() {
            Object.keys(characterData.skills).forEach(category => {
                characterData.skills[category].forEach(skill => {
                    if (skill.name && EXAMPLE_SKILLS[category].includes(skill.name)) {
                        transferredSkills[category].add(skill.name);
                    }
                });
            });
        }

        // Portrait Controls Toggle
        function togglePortraitControls() {
            const container = document.getElementById('portrait-container');
            container.classList.toggle('show-controls');
        }

        // Close controls when clicking outside
        document.addEventListener('click', function(e) {
            const container = document.getElementById('portrait-container');
            if (!container.contains(e.target)) {
                container.classList.remove('show-controls');
            }
        });

        function openFileDialog(event) {
            event.stopPropagation();
            document.getElementById('portrait-input').click();
        }

        function handlePortraitUpload(event) {
            const file = event.target.files[0];
            if (!file) return;

            if (!file.type.startsWith('image/')) {
                alert('Bitte wähle eine Bilddatei aus.');
                return;
            }

            const reader = new FileReader();
            reader.onload = function(e) {
                const img = new Image();
                img.onload = function() {
                    if (this.width > 400 || this.height > 400) {
                        alert('Bild ist zu groß! Maximal 400x400px erlaubt.');
                        return;
                    }

                    characterData.portrait = e.target.result;
                    displayPortrait(e.target.result);
                    autoSave();
                };
                img.src = e.target.result;
            };
            reader.readAsDataURL(file);
        }

        function displayPortrait(imageData) {
            const preview = document.getElementById('portrait-preview');
            const placeholder = document.getElementById('portrait-placeholder');

            placeholder.style.display = 'none';
            preview.style.backgroundImage = `url(${imageData})`;
            preview.style.backgroundSize = 'cover';
            preview.style.backgroundPosition = 'center';
        }

        function removePortrait(event) {
            event.stopPropagation();

            const preview = document.getElementById('portrait-preview');
            const placeholder = document.getElementById('portrait-placeholder');
            const container = document.getElementById('portrait-container');

            characterData.portrait = null;
            preview.style.backgroundImage = 'none';
            placeholder.style.display = 'block';
            document.getElementById('portrait-input').value = '';
            container.classList.remove('show-controls');

            autoSave();
        }

        // Jolly Roger Functions
        function toggleJollyControls() {
            const container = document.getElementById('jolly-container');
            container.classList.toggle('show-controls');
        }

        document.addEventListener('click', function(e) {
            const jollyContainer = document.getElementById('jolly-container');
            if (jollyContainer && !jollyContainer.contains(e.target)) {
                jollyContainer.classList.remove('show-controls');
            }
        });

        function openJollyDialog(event) {
            event.stopPropagation();
            document.getElementById('jolly-input').click();
        }

        function handleJollyUpload(event) {
            const file = event.target.files[0];
            if (!file) return;

            if (!file.type.startsWith('image/')) {
                alert('Bitte wähle eine Bilddatei aus.');
                return;
            }

            const reader = new FileReader();
            reader.onload = function(e) {
                const img = new Image();
                img.onload = function() {
                    if (this.width > 400 || this.height > 230) {
                        alert('Bild ist zu groß! Maximal 400x230px erlaubt.');
                        return;
                    }

                    characterData.jollyRoger = e.target.result;
                    displayJolly(e.target.result);
                    autoSave();
                };
                img.src = e.target.result;
            };
            reader.readAsDataURL(file);
        }

        function displayJolly(imageData) {
            const preview = document.getElementById('jolly-preview');
            const placeholder = document.getElementById('jolly-placeholder');

            placeholder.style.display = 'none';
            preview.style.backgroundImage = `url(${imageData})`;
            preview.style.backgroundSize = 'cover';
            preview.style.backgroundPosition = 'center';
        }

        function removeJolly(event) {
            event.stopPropagation();

            const preview = document.getElementById('jolly-preview');
            const placeholder = document.getElementById('jolly-placeholder');
            const container = document.getElementById('jolly-container');

            characterData.jollyRoger = null;
            preview.style.backgroundImage = 'none';
            placeholder.style.display = 'block';
            document.getElementById('jolly-input').value = '';
            container.classList.remove('show-controls');

            autoSave();
        }

        function initializeSkills() {
            ['handeln', 'wissen', 'soziales'].forEach(category => {
                const container = document.getElementById(`skills-${category}`);
                const skills = characterData.skills[category];

                container.innerHTML = '';

                skills.forEach((skill, index) => {
                    const row = document.createElement('div');
                    row.className = 'skill-row';
                    row.innerHTML = `
                        <input type="text" 
                               class="skill-name" 
                               value="${skill.name}" 
                               data-category="${category}" 
                               data-index="${index}" 
                               placeholder="Begabung Name...">
                        <input type="number" 
                               class="skill-value" 
                               value="${skill.value}" 
                               data-category="${category}" 
                               data-index="${index}" 
                               placeholder="0" 
                               min="0" 
                               max="100">
                        <button class="skill-delete-btn" onclick="deleteSkillRow('${category}', ${index})" title="Zeile löschen">✕</button>
                    `;
                    container.appendChild(row);
                });
            });

            document.querySelectorAll('.skill-name, .skill-value').forEach(input => {
                input.addEventListener('input', handleSkillChange);
            });

            updatePointCounters();
        }

        function loadCharacter() {
            // 1) Neuer, nutzerspezifischer Speicherstand
            let saved = localStorage.getItem(getStorageKey());

            // 2) Migration: alter globaler Key (falls vorhanden)
            if (!saved) {
                const legacy = localStorage.getItem('rumRache_character');
                if (legacy) {
                    localStorage.setItem(getStorageKey(), legacy);
                    localStorage.removeItem('rumRache_character');
                    saved = legacy;
                }
            }

            if (saved) {
                try {
                    return JSON.parse(saved);
                } catch (e) {
                    console.warn('Charakterbogen: Speicherstand beschädigt, lade Standardwerte.', e);
                }
            }

            return {
                name: '',
                gender: '',
                age: '',
                role: '',
                crew: '',
                aussehen: '',
                currency: '',
                currencyType: 'dollar',
                inventar: '',
                portrait: null,
                jollyRoger: null,
                leben: { current: 100, max: 100 },
                moral: { current: 100, max: 100 },
                resonanz: 0,
                zweiteChance: [false, false, false],
                fokus: { type: null, abilities: [], slot3Unlocked: false },
                skills: {
                    handeln: Array(SKILLS_PER_CATEGORY).fill(null).map(() => ({ name: '', value: 0 })),
                    wissen: Array(SKILLS_PER_CATEGORY).fill(null).map(() => ({ name: '', value: 0 })),
                    soziales: Array(SKILLS_PER_CATEGORY).fill(null).map(() => ({ name: '', value: 0 }))
                }
            };
        }

        function saveCharacter(showIndicator = false) {
            localStorage.setItem(getStorageKey(), JSON.stringify(characterData));
            if (showIndicator) {
                showSaveIndicator();
            }
        }

        function autoSave() {
            clearTimeout(saveTimeout);
            saveTimeout = setTimeout(() => saveCharacter(true), 500);
        }

        function showSaveIndicator() {
            const indicator = document.getElementById('save-indicator');
            indicator.classList.add('show');
            setTimeout(() => indicator.classList.remove('show'), 2000);
        }

        // Download character as JSON
        function downloadCharacter() {
            const dataStr = JSON.stringify(characterData, null, 2);
            const dataBlob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(dataBlob);

            const link = document.createElement('a');
            link.href = url;
            const fileName = characterData.name ? `${characterData.name}_Charakterbogen.json` : 'Charakterbogen.json';
            link.download = fileName;

            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);

            showSaveIndicator();
        }

        // Upload character from JSON
        function uploadCharacter(event) {
            const file = event.target.files[0];
            if (!file) return;

            if (!file.name.endsWith('.json')) {
                alert('Bitte wähle eine JSON-Datei aus.');
                return;
            }

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const uploadedData = JSON.parse(e.target.result);

                    // Validate structure
                    if (!uploadedData.skills || !uploadedData.leben || !uploadedData.moral) {
                        throw new Error('Ungültiges Charakterbogen-Format');
                    }

                    characterData = uploadedData;
                    saveCharacter(true);

                    // Reload transferred skills
                    transferredSkills = {
                        handeln: new Set(),
                        wissen: new Set(),
                        soziales: new Set()
                    };
                    loadTransferredSkills();

                    populateFields();
                    initializeSkills();
                    initializeHelpDialog();

                    alert('Charakterbogen erfolgreich geladen!');
                    showSaveIndicator();
                } catch (error) {
                    alert('Fehler beim Laden der Datei: ' + error.message);
                }
            };
            reader.readAsText(file);

            // Reset input
            event.target.value = '';
        }

        function populateFields() {
            document.getElementById('char-name').value = characterData.name;
            document.getElementById('char-gender').value = characterData.gender;
            document.getElementById('char-age').value = characterData.age;
            document.getElementById('char-role').value = characterData.role;
            document.getElementById('char-crew').value = characterData.crew || '';
            document.getElementById('char-aussehen').value = characterData.aussehen;
            document.getElementById('char-currency').value = characterData.currency || '';
            document.getElementById('char-inventar').value = characterData.inventar;

            if (characterData.portrait) {
                displayPortrait(characterData.portrait);
            }

            if (characterData.jollyRoger) {
                displayJolly(characterData.jollyRoger);
            }

            document.getElementById('leben-current').value = characterData.leben.current;
            document.getElementById('moral-current').value = characterData.moral.current;
            document.getElementById('resonanz-value').value = characterData.resonanz;

            updateProgressBars();

            characterData.zweiteChance.forEach((used, index) => {
                const dice = document.querySelector(`[data-dice="${index + 1}"]`);
                if (used) dice.classList.add('used');
            });
        }

        function updateProgressBars() {
            const lebenPercent = (characterData.leben.current / characterData.leben.max) * 100;
            const moralPercent = (characterData.moral.current / characterData.moral.max) * 100;

            const lebenBar = document.getElementById('leben-bar');
            lebenBar.style.width = `${lebenPercent}%`;
            
            // Update Leben color based on percentage
            lebenBar.classList.remove('warning', 'critical');
            if (lebenPercent <= 20 && lebenPercent > 0) {
                lebenBar.classList.add('critical');
            } else if (lebenPercent <= 50) {
                lebenBar.classList.add('warning');
            }
            
            document.getElementById('moral-bar').style.width = `${moralPercent}%`;
            document.getElementById('resonanz-bar').style.width = `${characterData.resonanz}%`;
        }

        function updatePointCounters() {
            let globalTotal = 0;

            ['handeln', 'wissen', 'soziales'].forEach(category => {
                const skills = characterData.skills[category];
                const categoryTotal = skills.reduce((sum, skill) => {
                    const value = parseInt(skill.value) || 0;
                    return sum + value;
                }, 0);

                const finalValue = Math.round(categoryTotal / 10);
                document.getElementById(`${category}-final`).textContent = finalValue;

                globalTotal += categoryTotal;
            });

            const remaining = TOTAL_POINTS - globalTotal;
            document.getElementById('global-used').textContent = globalTotal;
            document.getElementById('global-remaining').textContent = remaining;

            const remainingContainer = document.getElementById('global-remaining-container');
            if (remaining < 0) {
                remainingContainer.classList.add('warning');
            } else {
                remainingContainer.classList.remove('warning');
            }
        }

        document.getElementById('char-name').addEventListener('input', (e) => {
            characterData.name = e.target.value;
            autoSave();
        });

        document.getElementById('char-gender').addEventListener('input', (e) => {
            characterData.gender = e.target.value;
            autoSave();
        });

        document.getElementById('char-age').addEventListener('input', (e) => {
            characterData.age = e.target.value;
            autoSave();
        });

        document.getElementById('char-role').addEventListener('input', (e) => {
            characterData.role = e.target.value;
            autoSave();
        });

        document.getElementById('char-crew').addEventListener('input', (e) => {
            characterData.crew = e.target.value;
            autoSave();
        });

        document.getElementById('char-aussehen').addEventListener('input', (e) => {
            characterData.aussehen = e.target.value;
            autoSave();
        });

        document.getElementById('char-currency').addEventListener('input', (e) => {
            characterData.currency = e.target.value;
            autoSave();
        });

        document.getElementById('char-inventar').addEventListener('input', (e) => {
            characterData.inventar = e.target.value;
            autoSave();
        });

        document.getElementById('leben-current').addEventListener('input', (e) => {
            let value = parseInt(e.target.value) || 0;
            value = Math.max(0, Math.min(characterData.leben.max, value));
            e.target.value = value;
            characterData.leben.current = value;
            updateProgressBars();
            autoSave();
        });

        document.getElementById('moral-current').addEventListener('input', (e) => {
            let value = parseInt(e.target.value) || 0;
            value = Math.max(0, Math.min(characterData.moral.max, value));
            e.target.value = value;
            characterData.moral.current = value;
            updateProgressBars();
            autoSave();
        });

        document.getElementById('resonanz-value').addEventListener('input', (e) => {
            let value = parseInt(e.target.value) || 0;
            value = Math.max(0, Math.min(100, value));
            e.target.value = value;
            characterData.resonanz = value;
            updateProgressBars();
            autoSave();
        });

        function handleSkillChange(e) {
            const category = e.target.dataset.category;
            const index = parseInt(e.target.dataset.index);
            const isName = e.target.classList.contains('skill-name');

            if (isName) {
                const oldName = characterData.skills[category][index].name;
                const newName = e.target.value;

                // Update transferred skills tracking
                if (oldName && EXAMPLE_SKILLS[category].includes(oldName)) {
                    transferredSkills[category].delete(oldName);
                }
                if (newName && EXAMPLE_SKILLS[category].includes(newName)) {
                    transferredSkills[category].add(newName);
                }

                characterData.skills[category][index].name = newName;
                initializeHelpDialog(); // Update button states
            } else {
                let value = e.target.value;
                if (value !== '') {
                    value = Math.max(0, Math.min(100, parseInt(value) || 0));
                    e.target.value = value;
                }
                characterData.skills[category][index].value = value;
                updatePointCounters();
            }

            autoSave();
        }

        function addSkillRow(category) {
            // Add new skill to data
            characterData.skills[category].push({ name: '', value: 0 });
            
            // Re-render the skills grid for this category
            const container = document.getElementById(`skills-${category}`);
            const skills = characterData.skills[category];
            const newIndex = skills.length - 1;
            
            const row = document.createElement('div');
            row.className = 'skill-row';
            row.innerHTML = `
                <input type="text" 
                       class="skill-name" 
                       value="" 
                       data-category="${category}" 
                       data-index="${newIndex}" 
                       placeholder="Begabung Name...">
                <input type="number" 
                       class="skill-value" 
                       value="0" 
                       data-category="${category}" 
                       data-index="${newIndex}" 
                       placeholder="0" 
                       min="0" 
                       max="100">
                <button class="skill-delete-btn" onclick="deleteSkillRow('${category}', ${newIndex})" title="Zeile löschen">✕</button>
            `;
            container.appendChild(row);
            
            // Add event listeners to new inputs
            row.querySelectorAll('.skill-name, .skill-value').forEach(input => {
                input.addEventListener('input', handleSkillChange);
            });
            
            // Focus the new name input
            row.querySelector('.skill-name').focus();
            
            autoSave();
        }

        function deleteSkillRow(category, index) {
            // Minimum 1 Zeile behalten
            if (characterData.skills[category].length <= 1) {
                return;
            }
            
            // Remove from data
            characterData.skills[category].splice(index, 1);
            
            // Re-render all skills (to fix indices)
            initializeSkills();
            updatePointCounters();
            autoSave();
        }

        document.querySelectorAll('.dice-icon').forEach(dice => {
            dice.addEventListener('click', () => {
                const index = parseInt(dice.dataset.dice) - 1;
                
                // Wenn noch nicht used, Effekt abspielen
                if (!characterData.zweiteChance[index]) {
                    dice.classList.add('clicking');
                    setTimeout(() => dice.classList.remove('clicking'), 500);
                }
                
                characterData.zweiteChance[index] = !characterData.zweiteChance[index];
                dice.classList.toggle('used');
                autoSave();
            });
        });

        document.querySelectorAll('.tab-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                const tabName = btn.dataset.tab;

                document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
                document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));

                btn.classList.add('active');
                document.getElementById(`tab-${tabName}`).classList.add('active');
            });
        });

        function exportAsPDF() {
            // Hide elements that shouldn't be printed
            const elementsToHide = [
                '.nav-container',
                '.fly-btn-container', 
                '.character-file-actions',
                '.help-btn-container',
                '.powered-by-footer',
                '.add-skill-btn',
                '.skill-delete-btn'
            ];
            
            elementsToHide.forEach(selector => {
                document.querySelectorAll(selector).forEach(el => {
                    el.dataset.wasVisible = el.style.display;
                    el.style.display = 'none';
                });
            });
            
            // Trigger print
            window.print();
            
            // Restore elements after print
            setTimeout(() => {
                elementsToHide.forEach(selector => {
                    document.querySelectorAll(selector).forEach(el => {
                        el.style.display = el.dataset.wasVisible || '';
                        delete el.dataset.wasVisible;
                    });
                });
            }, 1000);
        }

        function resetCharacter() {
            if (confirm('Möchtest du wirklich alle Charakterdaten zurücksetzen?')) {
                localStorage.removeItem(getStorageKey());
                // falls noch Altlasten existieren
                localStorage.removeItem('rumRache_character');
                location.reload();
            }
        }

        function toggleHelpDialog() {
            document.getElementById('helpDialog').classList.toggle('active');
        }

        document.addEventListener('DOMContentLoaded', function() {
            document.querySelectorAll('.help-tab-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    document.querySelectorAll('.help-tab-btn').forEach(b => b.classList.remove('active'));
                    this.classList.add('active');

                    document.querySelectorAll('.help-category').forEach(c => c.classList.remove('active'));
                    document.getElementById('help-' + this.dataset.helpTab).classList.add('active');
                });
            });
        });

        // Currency type rotation
        const CURRENCY_TYPES = [
            { id: 'dollar', icon: 'icon_dollar.png', name: 'Dollar' },
            { id: 'euro', icon: 'icon_euro.png', name: 'Euro' },
            { id: 'yen', icon: 'icon_yen.png', name: 'Yen' },
            { id: 'berry', icon: 'icon_berry.png', name: 'Berry' },
            { id: 'skull', icon: 'icon_skull.png', name: 'Skull' }
        ];
        let currentCurrencyIndex = 0;

        function rotateCurrencyType() {
            currentCurrencyIndex = (currentCurrencyIndex + 1) % CURRENCY_TYPES.length;
            const currency = CURRENCY_TYPES[currentCurrencyIndex];
            document.getElementById('currency-icon').src = `assets/icons/${currency.icon}`;
            document.getElementById('currency-type-btn').title = currency.name;
            characterData.currencyType = currency.id;
            autoSave();
        }

        function formatCurrency(input) {
            // Get cursor position before change
            const cursorPos = input.selectionStart;
            const oldLength = input.value.length;
            
            // Remove all non-digit characters except dots (thousand separators)
            let value = input.value.replace(/[^\d]/g, '');
            
            // Convert to number and back to add thousand separators
            if (value) {
                const num = parseInt(value, 10);
                input.value = num.toLocaleString('de-DE');
            } else {
                input.value = '';
            }
            
            // Restore cursor position
            const newLength = input.value.length;
            const diff = newLength - oldLength;
            input.setSelectionRange(cursorPos + diff, cursorPos + diff);
        }

        function loadCurrencyType() {
            if (characterData.currencyType) {
                const index = CURRENCY_TYPES.findIndex(c => c.id === characterData.currencyType);
                if (index !== -1) {
                    currentCurrencyIndex = index;
                    const currency = CURRENCY_TYPES[currentCurrencyIndex];
                    document.getElementById('currency-icon').src = `assets/icons/${currency.icon}`;
                    document.getElementById('currency-type-btn').title = currency.name;
                }
            }
        }

        // ===== FOKUS SYSTEM =====
        const FOKUS_DATA = {
            fire: {
                name: 'Feuer',
                icon: 'icon_focus_fire.png',
                attacks: [
                    { name: 'Feuerball', desc: 'Eine kompakte Flammenkugel explodiert beim Aufprall.' },
                    { name: 'Flammenstrahl', desc: 'Dauerhafter Feuerstoß mit hoher Durchschlagskraft.' },
                    { name: 'Explosionsschlag', desc: 'Ein Nahkampftreffer mit detonierender Hitze.' },
                    { name: 'Feuerregen', desc: 'Mehrere Flammen fallen großflächig vom Himmel.' },
                    { name: 'Hitzewelle', desc: 'Verbrennt alles in einem Bereich ohne direkten Treffer.' },
                    { name: 'Flammenlanze', desc: 'Ein gebündelter Feuerstoß mit hoher Reichweite.' },
                    { name: 'Lavaausbruch', desc: 'Der Boden bricht auf und speit Feuer.' },
                    { name: 'Feuerwirbel', desc: 'Rotierende Flammen reißen Gegner mit.' },
                    { name: 'Selbstentzündung', desc: 'Kurzzeitige massive Angriffsstärkung.' },
                    { name: 'Brandmarke', desc: 'Gegner erleidet anhaltenden Feuerschaden.' }
                ],
                defenses: [
                    { name: 'Flammenhülle', desc: 'Feuer umgibt den Körper und schreckt Angriffe ab.' },
                    { name: 'Hitzeschild', desc: 'Verdampft Projektile durch extreme Hitze.' },
                    { name: 'Explosionsstoß', desc: 'Gegner werden durch Druckwelle zurückgedrängt.' },
                    { name: 'Feuerwand', desc: 'Eine brennende Barriere blockiert den Weg.' },
                    { name: 'Aschevorhang', desc: 'Rauch erschwert Sicht und Zielerfassung.' },
                    { name: 'Hitzeresistenz', desc: 'Stark verringerter Feuerschaden.' },
                    { name: 'Feuerabsorption', desc: 'Eigene Flammen werden zur Energiequelle.' },
                    { name: 'Flammenausbruch', desc: 'Defensiver Ausbruch bei Bedrohung.' },
                    { name: 'Bodenverkohlung', desc: 'Gegner verlieren Halt.' },
                    { name: 'Notzündung', desc: 'Schneller Flammenschub zum Ausweichen.' }
                ]
            },
            water: {
                name: 'Wasser',
                icon: 'icon_focus_water.png',
                attacks: [
                    { name: 'Wasserstrahl', desc: 'Schneidender Hochdruckangriff.' },
                    { name: 'Wasserpeitsche', desc: 'Flexibler Angriff auf mittlere Distanz.' },
                    { name: 'Eislanze', desc: 'Gefrierender Durchstoßangriff.' },
                    { name: 'Eisfläche', desc: 'Gegner rutschen unkontrolliert.' },
                    { name: 'Druckstoß', desc: 'Wasserwelle schleudert Gegner zurück.' },
                    { name: 'Wassergefängnis', desc: 'Gegner wird fest eingeschlossen.' },
                    { name: 'Froststoß', desc: 'Friert getroffene Ziele ein.' },
                    { name: 'Flutwelle', desc: 'Großflächiger Angriff mit Verdrängung.' },
                    { name: 'Nebelstoß', desc: 'Angriff aus verdeckter Position.' },
                    { name: 'Wasserprojektil', desc: 'Präziser Fernangriff.' }
                ],
                defenses: [
                    { name: 'Wasserwand', desc: 'Massive flüssige Schutzbarriere.' },
                    { name: 'Eisblock', desc: 'Kurzzeitige vollständige Abschirmung.' },
                    { name: 'Nebelzone', desc: 'Starke Sichtbehinderung.' },
                    { name: 'Strömungsumlenkung', desc: 'Lenkt Angriffe ab.' },
                    { name: 'Gleiten', desc: 'Flüssige Ausweichbewegung.' },
                    { name: 'Wasserhaut', desc: 'Reduziert physischen Schaden.' },
                    { name: 'Eisrüstung', desc: 'Erhöhte Verteidigung.' },
                    { name: 'Flusslauf', desc: 'Schnelle Positionsverlagerung.' },
                    { name: 'Untertauchen', desc: 'Kurzzeitiges Entziehen aus Gefahren.' },
                    { name: 'Druckentladung', desc: 'Gegner werden weggestoßen.' }
                ]
            },
            wind: {
                name: 'Wind',
                icon: 'icon_focus_wind.png',
                attacks: [
                    { name: 'Windklinge', desc: 'Scharfer Luftschnitt.' },
                    { name: 'Druckstoß', desc: 'Unsichtbarer Schlag aus der Distanz.' },
                    { name: 'Tornado', desc: 'Gegner werden hochgerissen.' },
                    { name: 'Luftschnitt-Serie', desc: 'Mehrere schnelle Schnitte.' },
                    { name: 'Fallwind', desc: 'Gegner werden zu Boden gedrückt.' },
                    { name: 'Wirbelwurf', desc: 'Gegner rotieren unkontrolliert.' },
                    { name: 'Stoßfront', desc: 'Breiter Luftangriff.' },
                    { name: 'Windlanze', desc: 'Gebündelter Durchstoß.' },
                    { name: 'Luftschock', desc: 'Plötzlicher Druckimpuls.' },
                    { name: 'Überschallstoß', desc: 'Extrem schneller Angriff.' }
                ],
                defenses: [
                    { name: 'Luftschild', desc: 'Abprallende Luftbarriere.' },
                    { name: 'Seitenstoß', desc: 'Umlenken von Angriffen.' },
                    { name: 'Sprungverstärkung', desc: 'Schnelles Ausweichen.' },
                    { name: 'Gleitbewegung', desc: 'Reduziert Fallschaden.' },
                    { name: 'Rückstoß', desc: 'Gegner werden ferngehalten.' },
                    { name: 'Windtunnel', desc: 'Projektile verlieren Kraft.' },
                    { name: 'Luftpolster', desc: 'Sanftes Abfedern.' },
                    { name: 'Richtungsbruch', desc: 'Sofortige Bewegungsänderung.' },
                    { name: 'Druckneutralisierung', desc: 'Abschwächen von Einschlägen.' },
                    { name: 'Schweben', desc: 'Entzug aus Bodengefahren.' }
                ]
            },
            earth: {
                name: 'Erde',
                icon: 'icon_focus_earth.png',
                attacks: [
                    { name: 'Erdspieß', desc: 'Stein bricht aus dem Boden.' },
                    { name: 'Felswurf', desc: 'Massive Projektilattacke.' },
                    { name: 'Bodenbruch', desc: 'Gegner verlieren Halt.' },
                    { name: 'Erdstampfer', desc: 'Stoßwelle aus dem Boden.' },
                    { name: 'Steinschlag', desc: 'Herabfallende Brocken.' },
                    { name: 'Metallfaust', desc: 'Verstärkter Nahkampfangriff.' },
                    { name: 'Sandlawine', desc: 'Begräbt Gegner.' },
                    { name: 'Felsramme', desc: 'Durchbruchangriff.' },
                    { name: 'Erdgreifer', desc: 'Boden hält Gegner fest.' },
                    { name: 'Bebenstoß', desc: 'Weiträumiger Erschütterungsangriff.' }
                ],
                defenses: [
                    { name: 'Steinrüstung', desc: 'Stark erhöhte Abwehr.' },
                    { name: 'Felswand', desc: 'Massive Deckung.' },
                    { name: 'Bodenschild', desc: 'Schutz aus dem Untergrund.' },
                    { name: 'Erdverankerung', desc: 'Immun gegen Wegstoßen.' },
                    { name: 'Sandbarriere', desc: 'Dämpft Angriffe.' },
                    { name: 'Metallhaut', desc: 'Kurzzeitige Unverwundbarkeit.' },
                    { name: 'Erdabsorption', desc: 'Reduziert Schaden.' },
                    { name: 'Schutzwall', desc: 'Halbkreisförmige Deckung.' },
                    { name: 'Bodenerhöhung', desc: 'Höhenvorteil.' },
                    { name: 'Erdpanzer', desc: 'Bewegliche Verteidigung.' }
                ]
            },
            lightning: {
                name: 'Blitz',
                icon: 'icon_focus_lightning.png',
                attacks: [
                    { name: 'Blitzschlag', desc: 'Direkter Energiestoß.' },
                    { name: 'Kettenblitz', desc: 'Springt zwischen Zielen.' },
                    { name: 'Elektroschock', desc: 'Lähmt Gegner.' },
                    { name: 'Energiehieb', desc: 'Verstärkter Nahkampf.' },
                    { name: 'Überladung', desc: 'Erhöhter Schaden für kurze Zeit.' },
                    { name: 'Blitzzone', desc: 'Elektrisiertes Gebiet.' },
                    { name: 'Impulsstoß', desc: 'Schneller Energieschub.' },
                    { name: 'Nervenstörung', desc: 'Verlangsamt Gegner.' },
                    { name: 'Entladungswelle', desc: 'Rundumangriff.' },
                    { name: 'Präzisionsblitz', desc: 'Zielgenauer Treffer.' }
                ],
                defenses: [
                    { name: 'Blitztempo', desc: 'Extrem schnelles Ausweichen.' },
                    { name: 'Energiehülle', desc: 'Elektrische Schutzschicht.' },
                    { name: 'Reizunterdrückung', desc: 'Immun gegen Lähmung.' },
                    { name: 'Stromableitung', desc: 'Leitet Angriffe ab.' },
                    { name: 'Kurzteleport', desc: 'Blitzartige Bewegung.' },
                    { name: 'Reaktionsboost', desc: 'Verbesserte Reflexe.' },
                    { name: 'Energieschild', desc: 'Elektrische Barriere.' },
                    { name: 'Überladungsstoß', desc: 'Gegner zurückdrängen.' },
                    { name: 'Nervenschild', desc: 'Schutz vor Kontrollverlust.' },
                    { name: 'Energieabsorption', desc: 'Blitz stärkt den Nutzer.' }
                ]
            },
            room: {
                name: 'Raum',
                icon: 'icon_focus_room.png',
                attacks: [
                    { name: 'Kurzteleport-Schlag', desc: 'Angriff aus dem Nichts.' },
                    { name: 'Positionswechsel', desc: 'Tauscht Plätze mit Gegner.' },
                    { name: 'Raumschnitt', desc: 'Schneidet durch Distanz.' },
                    { name: 'Distanzbruch', desc: 'Verkürzt oder verlängert Wege.' },
                    { name: 'Raumstoß', desc: 'Unsichtbarer Druckangriff.' },
                    { name: 'Fixierung', desc: 'Gegner kann sich nicht bewegen.' },
                    { name: 'Umlenkung', desc: 'Angriffe treffen andere Ziele.' },
                    { name: 'Miniportal', desc: 'Angriff aus ungewöhnlichem Winkel.' },
                    { name: 'Fallverzerrung', desc: 'Gegner stürzt unkontrolliert.' },
                    { name: 'Raumkompression', desc: 'Erhöhter Schaden im Nahbereich.' }
                ],
                defenses: [
                    { name: 'Sofort-Teleport', desc: 'Ausweichen ohne Bewegung.' },
                    { name: 'Distanzvergrößerung', desc: 'Gegner kommen nicht heran.' },
                    { name: 'Positionsanker', desc: 'Eigene Position bleibt stabil.' },
                    { name: 'Raumverschiebung', desc: 'Treffer gehen ins Leere.' },
                    { name: 'Umlenkfeld', desc: 'Projektile ändern Richtung.' },
                    { name: 'Phasenversatz', desc: 'Kurzzeitige Unangreifbarkeit.' },
                    { name: 'Raumblockade', desc: 'Bereich ist unpassierbar.' },
                    { name: 'Fallneutralisierung', desc: 'Kein Sturzschaden.' },
                    { name: 'Schutzportal', desc: 'Angriffe verschwinden.' },
                    { name: 'Eigenverzerrung', desc: 'Körper weicht Treffern aus.' }
                ]
            },
            illusion: {
                name: 'Illusion',
                icon: 'icon_focus_illusion.png',
                attacks: [
                    { name: 'Trugbild', desc: 'Gegner greift falsches Ziel an.' },
                    { name: 'Doppelgänger', desc: 'Verwirrt Gegner.' },
                    { name: 'Blendillusion', desc: 'Sicht wird blockiert.' },
                    { name: 'Geräuschfalle', desc: 'Falsche Positionshinweise.' },
                    { name: 'Angriffsillusion', desc: 'Gegner reagiert zu früh.' },
                    { name: 'Angstbild', desc: 'Gegner verliert Kontrolle.' },
                    { name: 'Verzerrte Umgebung', desc: 'Orientierung bricht zusammen.' },
                    { name: 'Unsichtbarer Schlag', desc: 'Angriff bleibt unbemerkt.' },
                    { name: 'Phantomhieb', desc: 'Psychischer Schaden.' },
                    { name: 'Scheinexplosion', desc: 'Gegner weicht falsch aus.' }
                ],
                defenses: [
                    { name: 'Unsichtbarkeit', desc: 'Gegner verlieren Ziel.' },
                    { name: 'Illusionsschild', desc: 'Treffer gehen ins Leere.' },
                    { name: 'Mehrfachbilder', desc: 'Gegner verfehlt Angriffe.' },
                    { name: 'Verhüllung', desc: 'Verbündete werden verborgen.' },
                    { name: 'Täuschbewegung', desc: 'Schein-Ausweichen.' },
                    { name: 'Wahrnehmungsbruch', desc: 'Gegner reagiert zu spät.' },
                    { name: 'Falsche Trefferanzeige', desc: 'Gegner glaubt zu treffen.' },
                    { name: 'Illusionszone', desc: 'Kontrolle über Sichtbereich.' },
                    { name: 'Sinnesrauschen', desc: 'Gegner verliert Fokus.' },
                    { name: 'Identitätsverschleierung', desc: 'Nutzer wird nicht erkannt.' }
                ]
            }
        };

        let selectedFokusCategory = null;
        let selectedFokusAbilities = [];
        let fokusPopupOpen = false;

        function openFokusPopup() {
            if (fokusPopupOpen) return;
            fokusPopupOpen = true;

            // Pre-select current fokus if exists
            if (characterData.fokus?.type) {
                selectedFokusCategory = characterData.fokus.type;
                selectedFokusAbilities = [...(characterData.fokus.abilities || [])];
            } else {
                selectedFokusCategory = null;
                selectedFokusAbilities = [];
            }

            const popup = document.createElement('div');
            popup.className = 'fokus-popup-overlay';
            popup.id = 'fokusPopup';
            popup.onclick = (e) => { if (e.target === popup) closeFokusPopup(); };

            const maxAbilities = characterData.fokus?.slot3Unlocked ? 3 : 2;

            popup.innerHTML = `
                <div class="fokus-popup">
                    <div class="fokus-popup-header">
                        <span class="fokus-popup-title">Fokus wählen</span>
                        <button class="fokus-popup-close" onclick="closeFokusPopup()">×</button>
                    </div>
                    
                    <div class="fokus-categories" id="fokusCategories">
                        ${Object.entries(FOKUS_DATA).map(([key, data]) => `
                            <button class="fokus-category-btn ${selectedFokusCategory === key ? 'active' : ''}" 
                                    onclick="selectFokusCategory('${key}')" title="${data.name}">
                                <img src="assets/icons/${data.icon}" alt="${data.name}">
                            </button>
                        `).join('')}
                    </div>
                    
                    <div class="fokus-popup-content" id="fokusAbilitiesContent">
                        <div style="text-align: center; color: var(--md-on-surface-variant); padding: 40px;">
                            Wähle zuerst einen Fokus-Typ aus
                        </div>
                    </div>
                    
                    <div class="fokus-popup-footer">
                        <span class="fokus-selection-info" id="fokusSelectionInfo">
                            ${selectedFokusAbilities.length}/${maxAbilities} Fähigkeiten gewählt
                        </span>
                        <button class="fokus-confirm-btn" onclick="confirmFokusSelection()" id="fokusConfirmBtn">
                            Bestätigen
                        </button>
                    </div>
                </div>
            `;

            document.body.appendChild(popup);

            // Show abilities if category already selected
            if (selectedFokusCategory) {
                renderFokusAbilities();
            }
        }

        function closeFokusPopup() {
            const popup = document.getElementById('fokusPopup');
            if (popup) popup.remove();
            fokusPopupOpen = false;
        }

        function selectFokusCategory(category) {
            // If switching category, reset abilities
            if (selectedFokusCategory !== category) {
                selectedFokusAbilities = [];
            }
            selectedFokusCategory = category;

            // Update category buttons
            document.querySelectorAll('.fokus-category-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event.currentTarget.classList.add('active');

            renderFokusAbilities();
            updateFokusSelectionInfo();
        }

        function renderFokusAbilities() {
            const content = document.getElementById('fokusAbilitiesContent');
            if (!selectedFokusCategory) return;

            const data = FOKUS_DATA[selectedFokusCategory];
            const maxAbilities = characterData.fokus?.slot3Unlocked ? 3 : 2;
            const elementClass = selectedFokusCategory || '';

            content.innerHTML = `
                <div class="fokus-category-title">${data.name}</div>
                
                <div class="fokus-abilities-section">
                    <div class="fokus-abilities-title">⚔️ Angriffe</div>
                    <div class="fokus-abilities-list">
                        ${data.attacks.map(ability => {
                            const isSelected = selectedFokusAbilities.includes(ability.name);
                            const isDisabled = !isSelected && selectedFokusAbilities.length >= maxAbilities;
                            return `
                                <div class="fokus-ability-row ${isSelected ? 'selected ' + elementClass : ''} ${isDisabled ? 'disabled' : ''}"
                                     onclick="toggleFokusAbility('${ability.name}', ${isDisabled})">
                                    <span class="fokus-ability-name">${ability.name}</span>
                                    <span class="fokus-ability-desc">${ability.desc}</span>
                                </div>
                            `;
                        }).join('')}
                    </div>
                </div>
                
                <div class="fokus-abilities-section">
                    <div class="fokus-abilities-title">🛡️ Verteidigungen</div>
                    <div class="fokus-abilities-list">
                        ${data.defenses.map(ability => {
                            const isSelected = selectedFokusAbilities.includes(ability.name);
                            const isDisabled = !isSelected && selectedFokusAbilities.length >= maxAbilities;
                            return `
                                <div class="fokus-ability-row ${isSelected ? 'selected ' + elementClass : ''} ${isDisabled ? 'disabled' : ''}"
                                     onclick="toggleFokusAbility('${ability.name}', ${isDisabled})">
                                    <span class="fokus-ability-name">${ability.name}</span>
                                    <span class="fokus-ability-desc">${ability.desc}</span>
                                </div>
                            `;
                        }).join('')}
                    </div>
                </div>
            `;
        }

        function toggleFokusAbility(ability, isDisabled) {
            if (isDisabled) return;

            const index = selectedFokusAbilities.indexOf(ability);
            if (index > -1) {
                selectedFokusAbilities.splice(index, 1);
            } else {
                const maxAbilities = characterData.fokus?.slot3Unlocked ? 3 : 2;
                if (selectedFokusAbilities.length < maxAbilities) {
                    selectedFokusAbilities.push(ability);
                }
            }

            renderFokusAbilities();
            updateFokusSelectionInfo();
        }

        function updateFokusSelectionInfo() {
            const maxAbilities = characterData.fokus?.slot3Unlocked ? 3 : 2;
            const info = document.getElementById('fokusSelectionInfo');
            if (info) {
                info.textContent = `${selectedFokusAbilities.length}/${maxAbilities} Fähigkeiten gewählt`;
            }
        }

        function confirmFokusSelection() {
            if (!selectedFokusCategory) {
                alert('Bitte wähle einen Fokus-Typ aus.');
                return;
            }

            // Save to characterData
            characterData.fokus = {
                type: selectedFokusCategory,
                abilities: selectedFokusAbilities,
                slot3Unlocked: characterData.fokus?.slot3Unlocked || false
            };

            // Update UI
            updateFokusDisplay();
            autoSave();
            closeFokusPopup();
        }

        function updateFokusDisplay() {
            // Mobile elements
            const typeCard = document.getElementById('fokusTypeCard');
            const typeIcon = document.getElementById('fokusTypeIcon');
            const typePlaceholder = document.getElementById('fokusTypePlaceholder');
            const typeNameMobile = document.getElementById('fokusTypeNameMobile');
            
            // Desktop elements
            const typeCardDesktop = document.getElementById('fokusTypeCardDesktop');
            const typeIconDesktop = document.getElementById('fokusTypeIconDesktop');
            const typePlaceholderDesktop = document.getElementById('fokusTypePlaceholderDesktop');
            
            // GM viewing other player - no access to fokus (except slot 3)
            const isViewingOther = isGM && viewingPlayer;
            
            if (isViewingOther) {
                typeCard?.style && (typeCard.style.pointerEvents = 'none');
                typeCardDesktop?.style && (typeCardDesktop.style.pointerEvents = 'none');
            } else {
                typeCard?.style && (typeCard.style.pointerEvents = 'auto');
                typeCardDesktop?.style && (typeCardDesktop.style.pointerEvents = 'auto');
            }

            // Remove all gradient classes from both
            const gradientClasses = ['fire', 'water', 'wind', 'earth', 'lightning', 'room', 'illusion'];
            gradientClasses.forEach(c => {
                typeCard?.classList.remove(c);
                typeCardDesktop?.classList.remove(c);
            });

            if (characterData.fokus?.type) {
                const data = FOKUS_DATA[characterData.fokus.type];
                
                // Mobile
                if (typeIcon) {
                    typeIcon.src = `assets/icons/${data.icon}`;
                    typeIcon.style.display = 'block';
                }
                if (typePlaceholder) typePlaceholder.style.display = 'none';
                typeCard?.classList.add(characterData.fokus.type);
                
                // Desktop
                if (typeIconDesktop) {
                    typeIconDesktop.src = `assets/icons/${data.icon}`;
                    typeIconDesktop.style.display = 'block';
                }
                if (typePlaceholderDesktop) typePlaceholderDesktop.style.display = 'none';
                typeCardDesktop?.classList.add(characterData.fokus.type);
                
                // Update mobile name
                if (typeNameMobile) {
                    typeNameMobile.textContent = data.name;
                }
            } else {
                // Mobile
                if (typeIcon) typeIcon.style.display = 'none';
                if (typePlaceholder) typePlaceholder.style.display = 'block';
                
                // Desktop
                if (typeIconDesktop) typeIconDesktop.style.display = 'none';
                if (typePlaceholderDesktop) typePlaceholderDesktop.style.display = 'block';
                
                if (typeNameMobile) typeNameMobile.textContent = '-';
            }

            // Get ability descriptions from FOKUS_DATA
            const fokusType = characterData.fokus?.type;
            const fokusData = fokusType ? FOKUS_DATA[fokusType] : null;

            // Update ability cards
            for (let i = 1; i <= 3; i++) {
                const card = document.getElementById(`fokusAbility${i}`);
                const placeholder = card.querySelector('.fokus-ability-placeholder');
                const nameSpan = card.querySelector('.fokus-ability-name');
                const descSpan = card.querySelector('.fokus-ability-desc-small');
                const abilityName = characterData.fokus?.abilities?.[i - 1];
                
                // Find ability description
                let abilityDesc = '';
                if (abilityName && fokusData) {
                    const foundAttack = fokusData.attacks.find(a => a.name === abilityName);
                    const foundDefense = fokusData.defenses.find(d => d.name === abilityName);
                    abilityDesc = foundAttack?.desc || foundDefense?.desc || '';
                }

                if (i === 3) {
                    // Third slot - check if unlocked
                    if (characterData.fokus?.slot3Unlocked) {
                        card.classList.remove('locked');
                        card.classList.add('unlocked');
                        placeholder.textContent = 'Fähigkeit 3';
                        // GM can lock it again (own or others)
                        if (isGM) {
                            card.style.cursor = 'pointer';
                            card.onclick = () => lockFokusSlot3();
                        } else {
                            card.onclick = () => openFokusPopup();
                        }
                    } else {
                        card.classList.add('locked');
                        card.classList.remove('unlocked');
                        // GM can unlock slot 3 (own or others)
                        if (isGM) {
                            placeholder.innerHTML = '🔒';
                            card.style.cursor = 'pointer';
                            card.onclick = () => unlockFokusSlot3();
                        } else {
                            placeholder.textContent = '🔒';
                            card.onclick = null;
                        }
                    }
                } else {
                    // GM viewing other player - no access
                    if (isViewingOther) {
                        card.style.pointerEvents = 'none';
                    } else {
                        card.style.pointerEvents = 'auto';
                        card.onclick = () => openFokusPopup();
                    }
                }

                // Remove element classes first
                gradientClasses.forEach(c => card.classList.remove(c));

                if (abilityName) {
                    placeholder.style.display = 'none';
                    nameSpan.textContent = abilityName;
                    nameSpan.style.display = 'block';
                    descSpan.textContent = abilityDesc;
                    descSpan.style.display = 'block';
                    card.classList.add('selected');
                    // Add element class for color
                    if (characterData.fokus?.type) {
                        card.classList.add(characterData.fokus.type);
                    }
                } else {
                    placeholder.style.display = 'block';
                    nameSpan.style.display = 'none';
                    descSpan.style.display = 'none';
                    card.classList.remove('selected');
                }
            }
        }

        // GM can unlock slot 3 (own or other player)
        async function unlockFokusSlot3() {
            if (!isGM) return;
            
            const targetName = viewingPlayer || 'dich selbst';
            if (!confirm(`Slot 3 für ${targetName} freischalten?`)) return;
            
            characterData.fokus = characterData.fokus || { type: null, abilities: [] };
            characterData.fokus.slot3Unlocked = true;
            updateFokusDisplay();
            
            // Sync to Firebase
            if (isFirebaseOnline()) {
                try {
                    const targetUser = viewingPlayer || getCurrentUser()?.username;
                    if (targetUser) {
                        await getRef(`characters/${sanitizeKey(targetUser)}`).update({
                            fokus: characterData.fokus,
                            updatedAt: Date.now()
                        });
                        console.log('[GM] Unlocked Fokus slot 3 for:', targetUser);
                    }
                } catch (e) {
                    console.error('[GM] Unlock slot 3 failed:', e);
                }
            }
            
            // Save locally for own character
            if (!viewingPlayer) {
                autoSave();
            }
        }
        
        // GM can lock slot 3 (own or other player)
        async function lockFokusSlot3() {
            if (!isGM) return;
            
            const targetName = viewingPlayer || 'dich selbst';
            if (!confirm(`Slot 3 für ${targetName} wieder sperren? (Fähigkeit wird entfernt)`)) return;
            
            characterData.fokus = characterData.fokus || { type: null, abilities: [] };
            characterData.fokus.slot3Unlocked = false;
            // Remove ability from slot 3 if exists
            if (characterData.fokus.abilities && characterData.fokus.abilities.length > 2) {
                characterData.fokus.abilities = characterData.fokus.abilities.slice(0, 2);
            }
            updateFokusDisplay();
            
            // Sync to Firebase
            if (isFirebaseOnline()) {
                try {
                    const targetUser = viewingPlayer || getCurrentUser()?.username;
                    if (targetUser) {
                        await getRef(`characters/${sanitizeKey(targetUser)}`).update({
                            fokus: characterData.fokus,
                            updatedAt: Date.now()
                        });
                        console.log('[GM] Locked Fokus slot 3 for:', targetUser);
                    }
                } catch (e) {
                    console.error('[GM] Lock slot 3 failed:', e);
                }
            }
            
            // Save locally for own character
            if (!viewingPlayer) {
                autoSave();
            }
        }

        // Initialize everything
        loadTransferredSkills();
        initializeHelpDialog();
        initializeSkills();
        populateFields();
        loadCurrencyType();
        updateFokusDisplay();
        
        // Scroll to fokus if coming from other modules
        if (window.location.hash === '#fokus') {
            setTimeout(() => {
                const fokusGrid = document.getElementById('fokusGrid');
                if (fokusGrid) {
                    const topBarHeight = 100; // Top bar height offset
                    const elementPosition = fokusGrid.getBoundingClientRect().top + window.pageYOffset;
                    window.scrollTo({
                        top: elementPosition - topBarHeight,
                        behavior: 'smooth'
                    });
                }
            }, 100);
        }
        
        // Create footer
        createFooter();
        
        // ===== CATALOG DISPLAY =====
        const CATALOG_INFO = {
            'rum-und-rache': { name: 'Rum & Rache', icon: 'assets/icons/icon_ruleset_rumundrache.svg' },
            'fantasy-classic': { name: 'Fantasy Classic', icon: 'assets/icons/icon_ruleset_fantasy.svg' },
            'neon-abyss': { name: 'Neon Abyss', icon: 'assets/icons/icon_ruleset_neon.svg' },
            'basis': { name: 'Basis', icon: 'assets/icons/icon_ruleset_basis.svg' }
        };
        
        function updateRulesetDisplay() {
            const catalogId = localStorage.getItem('rift_active_catalog') || 'rum-und-rache';
            const catalog = CATALOG_INFO[catalogId] || CATALOG_INFO['rum-und-rache'];
            
            const nameEl = document.getElementById('ruleset-name');
            const iconEl = document.getElementById('ruleset-icon');
            
            if (nameEl) nameEl.textContent = catalog.name;
            if (iconEl) {
                iconEl.src = catalog.icon;
                iconEl.onerror = () => { iconEl.src = 'assets/icons/icon_hub.png'; };
            }
        }
        
        // Listen for catalog changes from Firebase
        function listenForCatalogChanges() {
            if (typeof getRef === 'function' && typeof isFirebaseOnline === 'function' && isFirebaseOnline()) {
                const ref = getRef('settings/catalog');
                if (ref) {
                    ref.on('value', (snapshot) => {
                        const catalogId = snapshot.val();
                        if (catalogId) {
                            localStorage.setItem('rift_active_catalog', catalogId);
                            updateRulesetDisplay();
                        }
                    });
                }
            }
        }
        
        // Initial display update
        updateRulesetDisplay();
        
        // Try to sync with Firebase if available
        if (typeof initFirebase === 'function') {
            initFirebase().then(() => {
                listenForCatalogChanges();
            }).catch(() => {});
        }
    </script>
</body>
</html>
