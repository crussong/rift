<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>D&D 5e W√ºrfel - RIFT</title>
    <link rel="icon" type="image/png" href="assets/icons/icon_favicon.png">
    <link rel="manifest" href="manifest.json">
    <script>(function(){var t=localStorage.getItem('pnp_theme')||'dark';document.documentElement.setAttribute('data-theme',t)})();</script>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;600;700;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="assets/css/global.css">
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
    <style>
        :root { --5e-crit: #fbbf24; --5e-on-crit: #1c1b1f; }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Roboto', sans-serif; background: var(--md-background); color: var(--md-on-background); line-height: 1.5; min-height: 100vh; padding: 16px; padding-top: 80px; padding-bottom: 120px; }
        body.shake { animation: screenShake 0.6s; }
        @keyframes screenShake { 0%, 100% { transform: translate(0, 0); } 10%, 30%, 50%, 70%, 90% { transform: translate(-5px, 5px); } 20%, 40%, 60%, 80% { transform: translate(5px, -5px); } }
        body.crit-success-flash::before { content: ''; position: fixed; inset: 0; background: radial-gradient(circle at center, rgba(255, 215, 0, 0.4) 0%, transparent 70%); z-index: 9998; animation: goldFlash 0.8s ease-out forwards; pointer-events: none; }
        @keyframes goldFlash { 0% { opacity: 0; transform: scale(0.5); } 30% { opacity: 1; transform: scale(1.2); } 100% { opacity: 0; transform: scale(2); } }
        body.crit-fail-flash::before { content: ''; position: fixed; inset: 0; background: radial-gradient(circle at center, rgba(244, 67, 54, 0.5) 0%, transparent 60%); z-index: 9998; animation: redPulse 0.6s ease-out forwards; pointer-events: none; }
        @keyframes redPulse { 0% { opacity: 0; } 20% { opacity: 1; } 40% { opacity: 0.3; } 60% { opacity: 0.8; } 100% { opacity: 0; } }
        .confetti-container { position: fixed; inset: 0; pointer-events: none; z-index: 9999; overflow: hidden; }
        .confetti { position: absolute; width: 10px; height: 10px; top: -20px; animation: confettiFall linear forwards; }
        .confetti.gold { background: #FFD700; } .confetti.yellow { background: #FFC107; } .confetti.orange { background: #FF9800; } .confetti.white { background: #FFFFFF; }
        @keyframes confettiFall { 0% { transform: translateY(0) rotate(0deg); opacity: 1; } 100% { transform: translateY(100vh) rotate(720deg); opacity: 0; } }
        .pill { height: 40px; padding: 0 24px; border: none; border-radius: var(--shape-full); font-family: inherit; font-size: 14px; font-weight: 500; cursor: pointer; display: inline-flex; align-items: center; justify-content: center; gap: 8px; transition: all 200ms; }
        .pill-filled { background: var(--md-primary); color: var(--md-on-primary); box-shadow: var(--elevation-1); }
        .pill-filled:hover { box-shadow: var(--elevation-2); }
        .pill-tonal { background: var(--md-secondary-container); color: var(--md-on-secondary-container); border: 2px solid transparent; }
        .pill-tonal:hover { box-shadow: var(--elevation-1); }
        .pill-tonal.selected { background: var(--md-primary); color: var(--md-on-primary); box-shadow: var(--elevation-2); }
        .pill-tonal.selected::after { content: '‚úì'; margin-left: 4px; font-weight: 700; }
        .pill-outlined { background: transparent; color: var(--md-primary); border: 1px solid var(--md-outline); }
        .pill-error { background: var(--delete-bg); color: var(--delete-icon); padding: 0 20px; }
        .card { background: var(--md-surface-container); border-radius: var(--shape-lg); overflow: hidden; box-shadow: var(--elevation-1); }
        .card.dice-card { background: rgba(33, 31, 38, 0.5); }
        .layout { display: grid; grid-template-columns: 1fr 340px; gap: 16px; max-width: 1400px; margin: 0 auto; margin-top: 80px; }
        .main { display: flex; flex-direction: column; gap: 16px; }
        .dice-display { padding: 64px 24px; height: 520px; min-height: 520px; max-height: 520px; display: flex; flex-direction: column; align-items: center; justify-content: center; background: transparent; position: relative; overflow: hidden; }
        .dice-display.crit-success { animation: critSuccessFlash 0.8s; }
        .dice-display.crit-fail { animation: critFailFlash 0.8s; }
        @keyframes critSuccessFlash { 0%, 100% { background: transparent; } 50% { background: linear-gradient(135deg, #1b5e20 0%, #2e7d32 100%); } }
        @keyframes critFailFlash { 0%, 100% { background: transparent; } 50% { background: linear-gradient(135deg, #b71c1c 0%, #c62828 100%); } }
        .player-badge { padding: 6px 14px; border-radius: 20px; font-weight: 500; font-size: 13px; color: white; margin-bottom: 16px; }
        .roll-type-label { font-size: 14px; color: var(--md-on-surface-variant); font-weight: 500; margin-bottom: 8px; }
        .calc-expr { display: flex; align-items: center; gap: 8px; font-size: 18px; font-weight: 500; color: var(--md-on-surface-variant); margin-bottom: 16px; }
        .calc-val { padding: 6px 12px; background: var(--md-surface-container-high); border-radius: var(--shape-md); min-width: 50px; text-align: center; }
        .calc-mod { background: var(--md-tertiary-container); color: var(--md-on-tertiary-container); font-weight: 700; }
        .dice-num { font-size: 288px; font-weight: 900; background: linear-gradient(135deg, var(--md-primary) 0%, #9575cd 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; line-height: 1; user-select: none; filter: drop-shadow(0 0 40px rgba(103, 80, 164, 0.6)); cursor: pointer; transition: all 150ms; }
        .dice-num.rolling { font-size: 96px; opacity: 0.6; }
        .dice-num.crit-success { animation: critPulse 0.8s; background: linear-gradient(135deg, #4caf50 0%, #81c784 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; filter: drop-shadow(0 0 60px rgba(76, 175, 80, 0.9)); }
        .dice-num.crit-fail { animation: critPulse 0.8s; background: linear-gradient(135deg, #f44336 0%, #e57373 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; filter: drop-shadow(0 0 60px rgba(244, 67, 54, 0.9)); }
        @keyframes critPulse { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.1); } }
        .dice-num.anim-spin { animation: rollSpin 100ms infinite; }
        @keyframes rollSpin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .result-breakdown { font-size: 14px; color: var(--md-on-surface-variant); margin-top: 8px; }
        .result-breakdown .kept { color: var(--md-primary); font-weight: 700; }
        .result-breakdown .dropped { color: var(--md-outline); text-decoration: line-through; }
        .roll-tabs { display: flex; gap: 8px; padding: 16px; overflow-x: auto; background: var(--md-surface-container-high); border-bottom: 1px solid var(--md-outline-variant); }
        .roll-tabs::-webkit-scrollbar { display: none; }
        .roll-tab { padding: 10px 18px; background: var(--md-surface-container); border: none; border-radius: 20px; color: var(--md-on-surface-variant); font-size: 13px; font-weight: 600; cursor: pointer; white-space: nowrap; transition: all 0.2s; font-family: inherit; }
        .roll-tab:hover { background: var(--md-surface-container-highest); }
        .roll-tab.active { background: var(--md-primary); color: var(--md-on-primary); }
        .controls { padding: 24px; display: flex; flex-direction: column; gap: 24px; }
        .roll-panel { display: none; }
        .roll-panel.active { display: flex; flex-direction: column; gap: 20px; }
        .ctrl-group { display: flex; flex-direction: column; gap: 12px; }
        .ctrl-label { font-size: 14px; font-weight: 500; color: var(--md-on-surface-variant); letter-spacing: 0.1px; display: flex; align-items: center; }
        .mod-value { font-size: 18px; font-weight: 700; color: var(--md-primary); margin-left: 8px; }
        .pill-group { display: flex; gap: 8px; flex-wrap: wrap; }
        .adv-toggle { display: flex; gap: 8px; }
        .adv-btn { flex: 1; padding: 12px; background: var(--md-surface-container-high); border: 2px solid transparent; border-radius: 12px; color: var(--md-on-surface-variant); font-size: 13px; font-weight: 600; cursor: pointer; transition: all 0.2s; font-family: inherit; }
        .adv-btn:hover { border-color: var(--md-outline-variant); }
        .adv-btn.active { border-color: var(--md-primary); color: var(--md-primary); background: rgba(103, 80, 164, 0.1); }
        .adv-btn.adv.active { border-color: var(--md-success); color: var(--md-success); background: rgba(76, 175, 80, 0.1); }
        .adv-btn.dis.active { border-color: var(--md-error); color: #E57373; background: rgba(244, 67, 54, 0.1); }
        .select-input { width: 100%; padding: 12px 14px; background: var(--md-surface-container-high); border: 1px solid var(--md-outline-variant); border-radius: 12px; color: var(--md-on-surface); font-size: 14px; font-weight: 500; font-family: inherit; cursor: pointer; appearance: none; background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' viewBox='0 0 24 24' fill='none' stroke='%23cac4d0' stroke-width='2'%3E%3Cpolyline points='6 9 12 15 18 9'/%3E%3C/svg%3E"); background-repeat: no-repeat; background-position: right 12px center; }
        .select-input:focus { outline: none; border-color: var(--md-primary); }
        .modifier-input { width: 80px; padding: 12px; background: var(--md-surface-container-high); border: 1px solid var(--md-outline-variant); border-radius: 12px; color: var(--md-on-surface); font-size: 20px; font-weight: 700; text-align: center; font-family: inherit; }
        .modifier-input:focus { outline: none; border-color: var(--md-primary); }
        .dice-input { padding: 12px; background: var(--md-surface-container-high); border: 1px solid var(--md-outline-variant); border-radius: 12px; color: var(--md-on-surface); font-size: 16px; font-weight: 600; text-align: center; font-family: inherit; }
        .dice-input:focus { outline: none; border-color: var(--md-primary); }
        .roll-btn { width: 100%; height: 56px; font-size: 16px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; }
        .dice-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px; }
        .dice-btn { padding: 14px 8px; background: var(--md-surface-container-high); border: 1px solid var(--md-outline-variant); border-radius: 12px; color: var(--md-on-surface); font-size: 14px; font-weight: 600; cursor: pointer; transition: all 0.2s; font-family: inherit; }
        .dice-btn:hover { border-color: var(--md-primary); background: var(--md-surface-container-highest); }
        .dice-btn:active { transform: scale(0.95); }
        .crit-toggle { display: flex; align-items: center; gap: 10px; padding: 12px 16px; background: var(--md-surface-container-high); border: 1px solid var(--md-outline-variant); border-radius: 12px; cursor: pointer; }
        .crit-toggle:hover { border-color: var(--5e-crit); }
        .crit-toggle input { width: 18px; height: 18px; accent-color: var(--5e-crit); cursor: pointer; }
        .crit-toggle span { font-size: 13px; color: var(--md-on-surface-variant); }
        .char-link-box { display: flex; align-items: center; gap: 12px; padding: 12px 16px; background: var(--md-surface-container-high); border-radius: 12px; border: 1px dashed var(--md-outline-variant); cursor: pointer; transition: all 0.2s; }
        .char-link-box:hover { border-color: var(--md-primary); background: rgba(103, 80, 164, 0.05); }
        .char-link-box.linked { border-style: solid; border-color: var(--md-success); background: rgba(76, 175, 80, 0.08); }
        .char-link-dot { width: 10px; height: 10px; border-radius: 50%; background: var(--md-outline); }
        .char-link-box.linked .char-link-dot { background: var(--md-success); }
        .char-link-text { font-size: 14px; color: var(--md-on-surface-variant); }
        .char-link-box.linked .char-link-text { color: var(--md-success); }
        .char-link-portrait { width: 40px; height: 40px; border-radius: 8px; object-fit: cover; }
        .char-link-avatar { width: 40px; height: 40px; border-radius: 8px; background: var(--md-primary); color: var(--md-on-primary); display: flex; align-items: center; justify-content: center; font-size: 14px; font-weight: 700; }
        .char-link-info { flex: 1; }
        .char-link-name { font-size: 14px; font-weight: 600; color: var(--md-on-surface); }
        .char-link-details { font-size: 12px; color: var(--md-on-surface-variant); }

        /* Character Modal */
        .char-modal-overlay { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.6); z-index: 10000; align-items: center; justify-content: center; padding: 16px; }
        .char-modal-overlay.active { display: flex; }
        .char-modal { background: var(--md-surface-container); border-radius: var(--shape-xl); max-width: 480px; width: 100%; max-height: 80vh; overflow: hidden; box-shadow: var(--elevation-3); animation: modalIn 200ms ease-out; }
        @keyframes modalIn { from { opacity: 0; transform: scale(0.95); } to { opacity: 1; transform: scale(1); } }
        .char-modal-header { display: flex; align-items: center; justify-content: space-between; padding: 20px 24px; border-bottom: 1px solid var(--md-outline-variant); }
        .char-modal-title { font-size: 20px; font-weight: 600; }
        .char-modal-close { width: 40px; height: 40px; border: none; background: transparent; color: var(--md-on-surface-variant); cursor: pointer; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 24px; }
        .char-modal-close:hover { background: var(--md-surface-container-highest); }
        .char-modal-body { padding: 24px; overflow-y: auto; max-height: 60vh; }
        .char-modal-empty { text-align: center; color: var(--md-on-surface-variant); padding: 32px; }
        .char-modal-empty svg { width: 48px; height: 48px; margin-bottom: 16px; opacity: 0.5; }
        .char-list { display: flex; flex-direction: column; gap: 12px; }
        .char-card { display: flex; align-items: center; gap: 16px; padding: 16px; background: var(--md-surface-container-high); border-radius: 12px; cursor: pointer; border: 2px solid transparent; transition: all 0.2s; }
        .char-card:hover { border-color: var(--md-outline-variant); }
        .char-card.selected { border-color: var(--md-primary); background: rgba(103, 80, 164, 0.1); }
        .char-card-avatar { width: 48px; height: 48px; border-radius: 50%; background: var(--md-primary); display: flex; align-items: center; justify-content: center; font-size: 20px; font-weight: 700; color: var(--md-on-primary); }
        .char-card-info { flex: 1; }
        .char-card-name { font-size: 16px; font-weight: 600; margin-bottom: 2px; }
        .char-card-details { font-size: 13px; color: var(--md-on-surface-variant); }
        .char-card-check { width: 24px; height: 24px; border-radius: 50%; border: 2px solid var(--md-outline); display: flex; align-items: center; justify-content: center; }
        .char-card.selected .char-card-check { background: var(--md-primary); border-color: var(--md-primary); color: var(--md-on-primary); }
        .char-stats-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; margin-top: 20px; padding-top: 20px; border-top: 1px solid var(--md-outline-variant); }
        .char-stat { text-align: center; padding: 12px; background: var(--md-surface-container-high); border-radius: 8px; }
        .char-stat-label { font-size: 11px; text-transform: uppercase; letter-spacing: 0.5px; color: var(--md-on-surface-variant); margin-bottom: 4px; }
        .char-stat-value { font-size: 20px; font-weight: 700; color: var(--md-primary); }

        /* Extended Character Modal Styles */
        .char-header-row { display: flex; align-items: center; gap: 16px; margin-bottom: 20px; }
        .char-portrait { width: 72px; height: 72px; border-radius: 12px; object-fit: cover; border: 2px solid var(--md-outline-variant); }
        .char-portrait-placeholder { width: 72px; height: 72px; border-radius: 12px; background: var(--md-surface-container-high); border: 2px dashed var(--md-outline-variant); display: flex; align-items: center; justify-content: center; }
        .char-portrait-placeholder svg { width: 32px; height: 32px; color: var(--md-outline); }
        .char-header-info { flex: 1; }
        .char-header-name { font-size: 20px; font-weight: 700; color: var(--md-on-surface); }
        .char-header-subtitle { font-size: 14px; color: var(--md-on-surface-variant); margin-top: 2px; }
        .char-header-bg { font-size: 12px; color: var(--md-outline); margin-top: 2px; }
        .char-info-row { display: flex; gap: 12px; margin-bottom: 16px; }
        .char-info-box { flex: 1; text-align: center; padding: 12px; background: var(--md-surface-container-high); border-radius: 12px; }
        .char-info-label { display: block; font-size: 11px; text-transform: uppercase; letter-spacing: 0.5px; color: var(--md-on-surface-variant); margin-bottom: 4px; }
        .char-info-value { font-size: 20px; font-weight: 700; color: var(--md-primary); }
        .char-section-title { font-size: 12px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; color: var(--md-on-surface-variant); margin: 16px 0 8px; padding-bottom: 4px; border-bottom: 1px solid var(--md-outline-variant); }
        .char-abilities-grid { display: grid; grid-template-columns: repeat(6, 1fr); gap: 8px; }
        .char-ability { text-align: center; padding: 8px 4px; background: var(--md-surface-container-high); border-radius: 8px; }
        .char-ability-label { font-size: 10px; font-weight: 600; color: var(--md-on-surface-variant); }
        .char-ability-score { font-size: 18px; font-weight: 700; color: var(--md-on-surface); }
        .char-ability-mod { font-size: 12px; color: var(--md-primary); font-weight: 600; }
        .char-saves-row { display: flex; gap: 8px; flex-wrap: wrap; }
        .char-save { padding: 6px 12px; background: var(--md-surface-container-high); border-radius: 20px; font-size: 12px; display: flex; gap: 6px; align-items: center; }
        .char-save.prof { background: var(--md-primary-container); color: var(--md-on-primary-container); }
        .char-save-label { font-weight: 500; }
        .char-save-value { font-weight: 700; }
        .char-skills-list { display: flex; flex-wrap: wrap; gap: 8px; }
        .char-skill { padding: 6px 12px; background: var(--md-surface-container-high); border-radius: 20px; font-size: 12px; display: flex; gap: 8px; align-items: center; }
        .char-skill.exp { background: var(--md-tertiary-container); color: var(--md-on-tertiary-container); }
        .char-skill-name { font-weight: 500; }
        .char-skill-mod { font-weight: 700; color: var(--md-primary); }
        .char-skill.exp .char-skill-mod { color: var(--md-on-tertiary-container); }
        .char-weapons-list { display: flex; flex-direction: column; gap: 8px; }
        .char-weapon { display: flex; justify-content: space-between; align-items: center; padding: 10px 14px; background: var(--md-surface-container-high); border-radius: 10px; }
        .char-weapon-name { font-weight: 600; font-size: 14px; }
        .char-weapon-stats { font-size: 13px; color: var(--md-primary); font-weight: 600; }
        .death-saves-grid { display: flex; justify-content: center; gap: 48px; padding: 20px; background: var(--md-surface-container-high); border-radius: 12px; }
        .death-save-col { text-align: center; }
        .death-save-label { font-size: 11px; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 10px; font-weight: 600; }
        .death-save-col.success .death-save-label { color: var(--md-success); }
        .death-save-col.fail .death-save-label { color: var(--md-error); }
        .death-pips { display: flex; gap: 8px; }
        .death-pip { width: 28px; height: 28px; border-radius: 50%; border: 2px solid var(--md-outline-variant); background: transparent; cursor: pointer; transition: all 0.2s; }
        .death-pip:hover { transform: scale(1.1); border-color: var(--md-outline); }
        .death-save-col.success .death-pip.active { background: var(--md-success); border-color: var(--md-success); }
        .death-save-col.fail .death-pip.active { background: var(--md-error); border-color: var(--md-error); }
        .death-result { font-size: 14px; color: var(--md-on-surface-variant); margin-top: 16px; text-align: center; font-weight: 600; min-height: 24px; }
        .death-reset-row { display: flex; justify-content: center; margin-top: 12px; }
        .sidebar { position: sticky; top: 80px; height: fit-content; }
        .sidebar-card { display: flex; flex-direction: column; height: 600px; min-height: 600px; max-height: 600px; }
        .card-head { display: flex; align-items: center; justify-content: space-between; padding: 16px; background: var(--md-surface-container-high); border-bottom: 1px solid var(--md-outline-variant); }
        .card-title { font-size: 14px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; }
        .history { flex: 1; overflow-y: auto; padding: 12px; display: flex; flex-direction: column; gap: 8px; }
        .history-item { display: flex; align-items: center; gap: 12px; padding: 12px; background: var(--md-surface-container-high); border-radius: 10px; animation: slideIn 200ms ease-out; }
        @keyframes slideIn { from { opacity: 0; transform: translateX(-10px); } to { opacity: 1; transform: translateX(0); } }
        .history-player { width: 8px; height: 8px; border-radius: 50%; flex-shrink: 0; }
        .history-info { flex: 1; min-width: 0; }
        .history-name { font-size: 12px; font-weight: 600; color: var(--md-primary); }
        .history-type { font-size: 11px; color: var(--md-on-surface-variant); text-transform: uppercase; }
        .history-total { font-size: 24px; font-weight: 700; color: var(--md-primary); }
        .history-total.crit { color: var(--5e-crit); }
        .history-total.nat1 { color: var(--md-error); }
        .history-empty { text-align: center; color: var(--md-on-surface-variant); padding: 24px; font-size: 14px; }
        .cheer-bar { display: flex; justify-content: center; align-items: center; gap: 8px; padding: 12px 16px; background: var(--md-surface-container); border-radius: var(--shape-lg); box-shadow: var(--elevation-1); }
        .cheer-bar-label { font-size: 12px; color: var(--md-on-surface-variant); margin-right: 8px; font-weight: 500; text-transform: uppercase; letter-spacing: 0.5px; }
        .cheer-btn { width: 40px; height: 40px; border: none; border-radius: 50%; background: var(--md-surface-container-high); cursor: pointer; font-size: 18px; transition: all 200ms; display: flex; align-items: center; justify-content: center; }
        .cheer-btn:hover { background: var(--md-surface-container-highest); transform: scale(1.1); }
        .cheer-btn:active { transform: scale(0.95); }
        .sound-menu { display: none; position: fixed; top: 80px; right: 16px; width: 200px; z-index: 1000; }
        .sound-menu.active { display: block; }
        .sound-menu-content { padding: 8px; }
        .sound-option { padding: 12px 16px; background: transparent; border: none; width: 100%; text-align: left; color: var(--md-on-surface); cursor: pointer; border-radius: var(--shape-md); font-family: inherit; font-size: 14px; display: flex; align-items: center; gap: 12px; }
        .sound-option:hover { background: var(--md-surface-container-highest); }
        .sound-option.selected { background: var(--md-primary-container); color: var(--md-on-primary-container); font-weight: 500; }
        .sound-option img { width: 18px; height: 18px; object-fit: contain; }
        @media (max-width: 1024px) { .layout { grid-template-columns: 1fr; } .sidebar { position: relative; top: 0; } }
        @media (max-width: 768px) { body { padding: 8px; padding-top: 20px; padding-bottom: 140px; } .layout { margin-top: 20px; } .dice-num { font-size: 128px; } .dice-display { padding: 40px 16px; min-height: 400px; height: auto; max-height: none; } .sidebar-card { height: auto; min-height: auto; max-height: 300px; } .controls { padding: 16px; } .cheer-bar { flex-wrap: wrap; } .cheer-bar-label { width: 100%; text-align: center; margin-right: 0; margin-bottom: 4px; } .cheer-btn { width: 36px; height: 36px; font-size: 16px; } .death-saves-grid { gap: 24px; } }
    </style>
</head>
<body>
    <!-- Character Modal -->
    <div class="char-modal-overlay" id="charModal" onclick="closeCharModalOutside(event)">
        <div class="char-modal">
            <div class="char-modal-header">
                <span class="char-modal-title" id="charModalTitle">Charakter</span>
                <button class="char-modal-close" onclick="closeCharacterModal()">&times;</button>
            </div>
            <div class="char-modal-body" id="charModalBody">
                <!-- Dynamic content -->
            </div>
        </div>
    </div>

    <div class="sound-menu card" id="soundMenu">
        <div class="sound-menu-content">
            <button class="sound-option selected" data-theme="default" onclick="setSoundTheme('default')"><img src="assets/icons/icon_sound_default.png" alt="Default"><span>Default</span></button>
            <button class="sound-option" data-theme="epic" onclick="setSoundTheme('epic')"><img src="assets/icons/icon_sound_epic.png" alt="Epic"><span>Epic</span></button>
            <button class="sound-option" data-theme="battle" onclick="setSoundTheme('battle')"><img src="assets/icons/icon_sound_battle.png" alt="Battle"><span>Battle</span></button>
        </div>
    </div>

    <div class="layout">
        <div class="main">
            <div class="card dice-card">
                <div class="dice-display" id="diceDisplay">
                    <div class="player-badge" id="playerBadge" style="display:none;"></div>
                    <div class="roll-type-label" id="rollTypeLabel"></div>
                    <div class="calc-expr" id="calcExpr" style="display:none;">
                        <span class="calc-val" id="calcRoll">20</span>
                        <span>+</span>
                        <span class="calc-val calc-mod" id="calcMod">0</span>
                        <span>=</span>
                    </div>
                    <div class="dice-num" id="diceNum" onclick="rollCurrentType()">20</div>
                    <div class="result-breakdown" id="resultBreakdown"></div>
                </div>
                <div class="roll-tabs">
                    <button class="roll-tab active" data-tab="check" data-i18n="dice5e.skill_check">Fertigkeitsprobe</button>
                    <button class="roll-tab" data-tab="save" data-i18n="dice5e.saving_throw">Rettungswurf</button>
                    <button class="roll-tab" data-tab="attack" data-i18n="dice5e.attack">Angriff</button>
                    <button class="roll-tab" data-tab="damage" data-i18n="dice5e.damage">Schaden</button>
                    <button class="roll-tab" data-tab="death" data-i18n="dice5e.death_save">Todesrettung</button>
                    <button class="roll-tab" data-tab="custom" data-i18n="dice5e.custom">Frei</button>
                </div>
                <div class="controls">
                    <div class="char-link-box" id="charLinkBox" onclick="openCharacterModal()">
                        <span class="char-link-dot"></span>
                        <span class="char-link-text" id="charLinkText" data-i18n="dice5e.link_character">Mit Charakterbogen verkn√ºpfen</span>
                    </div>

                    <!-- Skill Check Panel -->
                    <div class="roll-panel active" id="panel-check">
                        <div class="ctrl-group">
                            <span class="ctrl-label" data-i18n="dice5e.advantage_disadvantage">Vorteil / Nachteil</span>
                            <div class="adv-toggle">
                                <button class="adv-btn adv" data-mode="advantage" data-i18n="dice5e.advantage">Vorteil</button>
                                <button class="adv-btn active" data-mode="normal" data-i18n="dice5e.normal">Normal</button>
                                <button class="adv-btn dis" data-mode="disadvantage" data-i18n="dice5e.disadvantage">Nachteil</button>
                            </div>
                        </div>
                        <div class="ctrl-group">
                            <span class="ctrl-label" data-i18n="dice5e.skill">Fertigkeit</span>
                            <select class="select-input" id="skillSelect" onchange="updateModifierFromSkill()"></select>
                        </div>
                        <div class="ctrl-group">
                            <span class="ctrl-label" data-i18n="dice.modifier">Modifikator</span> <span class="mod-value" id="checkModDisplay">+0</span>
                            <div class="pill-group">
                                <button class="pill pill-tonal" onclick="adjustMod('check',-5)">-5</button>
                                <button class="pill pill-tonal" onclick="adjustMod('check',-1)">-1</button>
                                <button class="pill pill-tonal" onclick="adjustMod('check',1)">+1</button>
                                <button class="pill pill-tonal" onclick="adjustMod('check',5)">+5</button>
                                <button class="pill pill-error" onclick="resetMod('check')">‚Üª</button>
                            </div>
                        </div>
                        <button class="pill pill-filled roll-btn" onclick="rollCheck()" data-i18n="dice.roll">W√ºrfeln</button>
                    </div>
                    <!-- Saving Throw Panel -->
                    <div class="roll-panel" id="panel-save">
                        <div class="ctrl-group">
                            <span class="ctrl-label" data-i18n="dice5e.advantage_disadvantage">Vorteil / Nachteil</span>
                            <div class="adv-toggle">
                                <button class="adv-btn adv" data-mode="advantage" data-i18n="dice5e.advantage">Vorteil</button>
                                <button class="adv-btn active" data-mode="normal" data-i18n="dice5e.normal">Normal</button>
                                <button class="adv-btn dis" data-mode="disadvantage" data-i18n="dice5e.disadvantage">Nachteil</button>
                            </div>
                        </div>
                        <div class="ctrl-group">
                            <span class="ctrl-label" data-i18n="dice5e.ability">Attribut</span>
                            <select class="select-input" id="saveSelect" onchange="updateModifierFromSave()"></select>
                        </div>
                        <div class="ctrl-group">
                            <span class="ctrl-label" data-i18n="dice.modifier">Modifikator</span> <span class="mod-value" id="saveModDisplay">+0</span>
                            <div class="pill-group">
                                <button class="pill pill-tonal" onclick="adjustMod('save',-5)">-5</button>
                                <button class="pill pill-tonal" onclick="adjustMod('save',-1)">-1</button>
                                <button class="pill pill-tonal" onclick="adjustMod('save',1)">+1</button>
                                <button class="pill pill-tonal" onclick="adjustMod('save',5)">+5</button>
                                <button class="pill pill-error" onclick="resetMod('save')">‚Üª</button>
                            </div>
                        </div>
                        <button class="pill pill-filled roll-btn" onclick="rollSave()" data-i18n="dice.roll">W√ºrfeln</button>
                    </div>

                    <!-- Attack Panel -->
                    <div class="roll-panel" id="panel-attack">
                        <div class="ctrl-group">
                            <span class="ctrl-label" data-i18n="dice5e.advantage_disadvantage">Vorteil / Nachteil</span>
                            <div class="adv-toggle">
                                <button class="adv-btn adv" data-mode="advantage" data-i18n="dice5e.advantage">Vorteil</button>
                                <button class="adv-btn active" data-mode="normal" data-i18n="dice5e.normal">Normal</button>
                                <button class="adv-btn dis" data-mode="disadvantage" data-i18n="dice5e.disadvantage">Nachteil</button>
                            </div>
                        </div>
                        <div class="ctrl-group">
                            <span class="ctrl-label" data-i18n="dice5e.weapon">Waffe</span>
                            <select class="select-input" id="attackSelect" onchange="updateModifierFromAttack()"></select>
                        </div>
                        <div class="ctrl-group">
                            <span class="ctrl-label" data-i18n="dice5e.attack_bonus">Angriffsbonus</span> <span class="mod-value" id="attackModDisplay">+0</span>
                            <div class="pill-group">
                                <button class="pill pill-tonal" onclick="adjustMod('attack',-5)">-5</button>
                                <button class="pill pill-tonal" onclick="adjustMod('attack',-1)">-1</button>
                                <button class="pill pill-tonal" onclick="adjustMod('attack',1)">+1</button>
                                <button class="pill pill-tonal" onclick="adjustMod('attack',5)">+5</button>
                                <button class="pill pill-error" onclick="resetMod('attack')">‚Üª</button>
                            </div>
                        </div>
                        <button class="pill pill-filled roll-btn" onclick="rollAttack()" data-i18n="dice.roll">W√ºrfeln</button>
                    </div>

                    <!-- Damage Panel -->
                    <div class="roll-panel" id="panel-damage">
                        <div class="ctrl-group">
                            <span class="ctrl-label" data-i18n="dice5e.weapon">Waffe</span>
                            <select class="select-input" id="damageWeaponSelect" onchange="updateDamageFromWeapon()"></select>
                        </div>
                        <div class="ctrl-group">
                            <span class="ctrl-label" data-i18n="dice5e.damage_dice">Schadensw√ºrfel</span>
                            <div style="display: flex; gap: 12px; align-items: center;">
                                <input type="text" class="dice-input" id="damageDice" value="1d6" placeholder="1d6" style="width: 100px;">
                                <span style="color: var(--md-on-surface-variant);">+</span>
                                <input type="text" class="modifier-input" id="damageModifier" value="0" placeholder="0">
                            </div>
                        </div>
                        <div class="ctrl-group">
                            <label class="crit-toggle">
                                <input type="checkbox" id="critToggle">
                                <span data-i18n="dice5e.critical_hit">Kritischer Treffer (W√ºrfel verdoppeln)</span>
                            </label>
                        </div>
                        <button class="pill pill-filled roll-btn" onclick="rollDamage()" data-i18n="dice5e.roll_damage">Schaden w√ºrfeln</button>
                    </div>
                    <!-- Death Save Panel -->
                    <div class="roll-panel" id="panel-death">
                        <div class="ctrl-group">
                            <div class="death-saves-grid">
                                <div class="death-save-col success" id="deathSuccess">
                                    <div class="death-save-label" data-i18n="dice5e.successes">Erfolge</div>
                                    <div class="death-pips">
                                        <div class="death-pip" onclick="toggleDeathPip('success', 0)"></div>
                                        <div class="death-pip" onclick="toggleDeathPip('success', 1)"></div>
                                        <div class="death-pip" onclick="toggleDeathPip('success', 2)"></div>
                                    </div>
                                </div>
                                <div class="death-save-col fail" id="deathFail">
                                    <div class="death-save-label" data-i18n="dice5e.failures">Fehlschl√§ge</div>
                                    <div class="death-pips">
                                        <div class="death-pip" onclick="toggleDeathPip('fail', 0)"></div>
                                        <div class="death-pip" onclick="toggleDeathPip('fail', 1)"></div>
                                        <div class="death-pip" onclick="toggleDeathPip('fail', 2)"></div>
                                    </div>
                                </div>
                            </div>
                            <div class="death-result" id="deathResult"></div>
                            <div class="death-reset-row">
                                <button class="pill pill-outlined" onclick="resetDeathSaves()" data-i18n="dice5e.reset">Zur√ºcksetzen</button>
                            </div>
                        </div>
                        <button class="pill pill-filled roll-btn" onclick="rollDeathSave()" data-i18n="dice5e.roll_death_save">Todesrettung w√ºrfeln</button>
                    </div>

                    <!-- Custom Panel -->
                    <div class="roll-panel" id="panel-custom">
                        <div class="ctrl-group">
                            <span class="ctrl-label" data-i18n="dice5e.quick_roll">Schnellwurf</span>
                            <div class="dice-grid">
                                <button class="dice-btn" onclick="rollCustom(4)">d4</button>
                                <button class="dice-btn" onclick="rollCustom(6)">d6</button>
                                <button class="dice-btn" onclick="rollCustom(8)">d8</button>
                                <button class="dice-btn" onclick="rollCustom(10)">d10</button>
                                <button class="dice-btn" onclick="rollCustom(12)">d12</button>
                                <button class="dice-btn" onclick="rollCustom(20)">d20</button>
                                <button class="dice-btn" onclick="rollCustom(100)">d100</button>
                                <button class="dice-btn" onclick="rollCustomMulti(6, 4)">4d6</button>
                            </div>
                        </div>
                        <div class="ctrl-group">
                            <span class="ctrl-label" data-i18n="dice5e.custom_dice">Eigene Formel</span>
                            <input type="text" class="dice-input" id="customDice" placeholder="2d6+3" style="width: 100%;">
                        </div>
                        <button class="pill pill-filled roll-btn" onclick="rollCustomFromInput()" data-i18n="dice.roll">W√ºrfeln</button>
                    </div>
                </div>
            </div>

            <div class="cheer-bar" id="cheerBar">
                <span class="cheer-bar-label" data-i18n="dice.react">Reagieren</span>
                <button class="cheer-btn" onclick="sendCheer('üéâ')">üéâ</button>
                <button class="cheer-btn" onclick="sendCheer('üòÇ')">üòÇ</button>
                <button class="cheer-btn" onclick="sendCheer('üëè')">üëè</button>
                <button class="cheer-btn" onclick="sendCheer('üî•')">üî•</button>
                <button class="cheer-btn" onclick="sendCheer('üíÄ')">üíÄ</button>
                <button class="cheer-btn" onclick="sendCheer('üò±')">üò±</button>
                <button class="cheer-btn" onclick="sendCheer('ü§Ø')">ü§Ø</button>
                <button class="cheer-btn" onclick="sendCheer('‚öîÔ∏è')">‚öîÔ∏è</button>
            </div>
        </div>

        <div class="sidebar">
            <div class="card sidebar-card">
                <div class="card-head">
                    <span class="card-title">‚â° <span data-i18n="dice.history">Historie</span></span>
                    <button class="pill pill-error" style="height: 32px; padding: 0 16px; font-size: 16px;" onclick="clearHistory()">‚Üª</button>
                </div>
                <div class="history" id="historyList">
                    <div class="history-empty" data-i18n="dice5e.no_rolls">Noch keine W√ºrfe</div>
                </div>
            </div>
        </div>
    </div>
    <script src="assets/js/lang.js"></script>
    <script src="assets/js/i18n.js"></script>
    <script src="assets/js/auth.js"></script>
    <script src="assets/js/firebase-sync.js"></script>
    <script src="assets/js/nav.js"></script>

    <script>
        // ===== CONSTANTS =====
        const SKILL_ABILITIES = { acrobatics:'dex', animalHandling:'wis', arcana:'int', athletics:'str', deception:'cha', history:'int', insight:'wis', intimidation:'cha', investigation:'int', medicine:'wis', nature:'int', perception:'wis', performance:'cha', persuasion:'cha', religion:'int', sleightOfHand:'dex', stealth:'dex', survival:'wis' };
        const SKILL_NAMES_DE = { acrobatics:'Akrobatik', animalHandling:'Tierumgang', arcana:'Arkane Kunde', athletics:'Athletik', deception:'T√§uschung', history:'Geschichte', insight:'Motiv erkennen', intimidation:'Einsch√ºchtern', investigation:'Nachforschen', medicine:'Heilkunde', nature:'Naturkunde', perception:'Wahrnehmung', performance:'Auftreten', persuasion:'√úberreden', religion:'Religion', sleightOfHand:'Fingerfertigkeit', stealth:'Heimlichkeit', survival:'√úberleben' };
        const SKILL_NAMES_EN = { acrobatics:'Acrobatics', animalHandling:'Animal Handling', arcana:'Arcana', athletics:'Athletics', deception:'Deception', history:'History', insight:'Insight', intimidation:'Intimidation', investigation:'Investigation', medicine:'Medicine', nature:'Nature', perception:'Perception', performance:'Performance', persuasion:'Persuasion', religion:'Religion', sleightOfHand:'Sleight of Hand', stealth:'Stealth', survival:'Survival' };
        const ABILITY_NAMES_DE = { str:'St√§rke', dex:'Geschicklichkeit', con:'Konstitution', int:'Intelligenz', wis:'Weisheit', cha:'Charisma' };
        const ABILITY_NAMES_EN = { str:'Strength', dex:'Dexterity', con:'Constitution', int:'Intelligence', wis:'Wisdom', cha:'Charisma' };

        // ===== STATE =====
        let currentTab = 'check';
        let charData = null;
        let playerData = null;
        let rollHistory = [];
        let deathSaves = { success: [false, false, false], fail: [false, false, false] };
        let isRolling = false;
        let mods = { check: 0, save: 0, attack: 0 };
        let baseMods = { check: 0, save: 0, attack: 0 };

        // ===== AUDIO =====
        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        const soundThemes = {
            default: { tick: { base: 350, range: 150, type: 'triangle', dur: 0.04 }, revealNormal: [{ freq: 600, sweepTo: 800, dur: 0.15, type: 'sine' }, { freq: 900, dur: 0.08, type: 'sine', delay: 100 }], critSuccess: [{ freq: 800, dur: 0.12, type: 'sine' }, { freq: 1000, dur: 0.12, type: 'sine', delay: 80 }, { freq: 1200, dur: 0.15, type: 'sine', delay: 160 }], critFail: [{ freq: 400, sweepTo: 200, dur: 0.2, type: 'sawtooth' }, { freq: 100, dur: 0.3, type: 'sine', delay: 150 }] },
            epic: { tick: { base: 400, range: 200, type: 'sawtooth', dur: 0.035 }, revealNormal: [{ freq: 200, sweepTo: 400, dur: 0.18, type: 'sawtooth' }, { freq: 600, dur: 0.12, type: 'triangle', delay: 100 }], critSuccess: [{ freq: 261.63, dur: 0.15, type: 'sawtooth' }, { freq: 392, dur: 0.15, type: 'sawtooth', delay: 140 }, { freq: 523.25, dur: 0.2, type: 'triangle', delay: 210 }], critFail: [{ freq: 220, sweepTo: 110, dur: 0.25, type: 'sawtooth' }, { freq: 80, dur: 0.35, type: 'sine', delay: 180 }] },
            battle: { tick: { base: 600, range: 250, type: 'square', dur: 0.03 }, revealNormal: [{ freq: 300, sweepTo: 500, dur: 0.12, type: 'sawtooth' }, { freq: 700, dur: 0.1, type: 'square', delay: 80 }], critSuccess: [{ freq: 329.63, dur: 0.12, type: 'sawtooth' }, { freq: 493.88, dur: 0.12, type: 'sawtooth', delay: 120 }, { freq: 659.25, dur: 0.15, type: 'triangle', delay: 180 }], critFail: [{ freq: 440, sweepTo: 220, dur: 0.18, type: 'sawtooth' }, { freq: 150, dur: 0.25, type: 'sine', delay: 120 }] }
        };
        let currentSoundTheme = 'default';

        function playTone(freq, dur, type, sweepTo) {
            if (isSoundMuted()) return;
            const osc = audioCtx.createOscillator(), gain = audioCtx.createGain();
            osc.connect(gain); gain.connect(audioCtx.destination);
            osc.frequency.value = freq; osc.type = type || 'sine';
            if (sweepTo) osc.frequency.exponentialRampToValueAtTime(sweepTo, audioCtx.currentTime + dur);
            gain.gain.setValueAtTime(0.15, audioCtx.currentTime);
            gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + dur);
            osc.start(audioCtx.currentTime); osc.stop(audioCtx.currentTime + dur);
        }
        function playThemeTick() { const t = soundThemes[currentSoundTheme].tick; playTone(t.base + Math.random() * t.range, t.dur, t.type); }
        function playRevealSound(isCrit, isFail) {
            const config = isCrit ? soundThemes[currentSoundTheme].critSuccess : (isFail ? soundThemes[currentSoundTheme].critFail : soundThemes[currentSoundTheme].revealNormal);
            config.forEach(s => setTimeout(() => playTone(s.freq, s.dur, s.type, s.sweepTo), s.delay || 0));
        }
        function setSoundTheme(theme) {
            currentSoundTheme = theme;
            document.querySelectorAll('.sound-option').forEach(o => o.classList.remove('selected'));
            document.querySelector('[data-theme="'+theme+'"]')?.classList.add('selected');
            document.getElementById('soundMenu').classList.remove('active');
            localStorage.setItem('rift_sound_theme', theme);
        }
        function isSoundMuted() { return localStorage.getItem('pnp_sound_muted') === 'true'; }
        // ===== INIT =====
        function init() {
            // Restore selected character
            var savedCharId = localStorage.getItem('rift_5e_selected_char');
            if (savedCharId) selectedCharId = savedCharId;
            populateSelects();
            setupTabs();
            setupAdvToggles();
            loadDeathSaves();
            loadHistory();
            var savedTheme = localStorage.getItem('rift_sound_theme');
            if (savedTheme) setSoundTheme(savedTheme);
            if (typeof updatePageTranslations === 'function') setTimeout(updatePageTranslations, 100);
            updatePlayerBadge();
            
            // Init Firebase THEN load character data
            if (typeof initFirebase === 'function') {
                initFirebase().then(function() {
                    console.log('[5e Dice] Firebase ready, loading characters...');
                    loadPlayerData();
                    loadCharacterData();
                    loadAllCharacters();
                    initRollListener();
                    initCheerListener();
                });
            }
        }

        function loadPlayerData() {
            const roomCode = localStorage.getItem('pnp_room');
            const odlayerId = localStorage.getItem('odlayerId');
            if (!roomCode || !odlayerId) return;
            firebase.database().ref('rooms/'+roomCode+'/players/'+odlayerId).on('value', function(snap) {
                playerData = snap.val();
                updatePlayerBadge();
            });
        }

        function loadCharacterData() {
            var roomObj = typeof getRoom === 'function' ? getRoom() : null;
            var roomCode = roomObj ? roomObj.id : null;
            var user = typeof getCurrentUser === 'function' ? getCurrentUser() : null;
            var username = user ? user.username : null;
            if (!roomCode || !username) return;
            // Sanitize username for Firebase path (no #, ., $, etc.)
            var safeUsername = typeof sanitizeKey === 'function' ? sanitizeKey(username) : username.replace(/[.#$\/\[\]]/g, '_');
            // 5e character sheets save to sessions/{roomCode}/characters/{username}
            firebase.database().ref('sessions/'+roomCode+'/characters/'+safeUsername).on('value', function(snap) {
                charData = snap.val();
                if (!selectedCharId && charData) {
                    selectedCharId = safeUsername;
                }
                updateCharLink();
                populateWeaponSelects();
            });
        }

        function updatePlayerBadge() {
            const badge = document.getElementById('playerBadge');
            if (playerData && playerData.name) {
                badge.textContent = playerData.name;
                badge.style.background = playerData.color || 'var(--md-primary)';
                badge.style.display = 'block';
            } else {
                badge.style.display = 'none';
            }
        }

        function updateCharLink() {
            var box = document.getElementById('charLinkBox');
            // Try selectedCharId first, then fall back to charData
            var char = null;
            if (selectedCharId && allCharacters[selectedCharId]) {
                char = allCharacters[selectedCharId];
            } else if (charData) {
                char = charData;
            }
            console.log('[5e Dice] updateCharLink - char:', char);
            
            if (char && char.header && char.header.name) {
                box.classList.add('linked');
                var header = char.header || {};
                var portrait = (char.narrative && char.narrative.portrait) ? char.narrative.portrait : '';
                var level = header.level || 1;
                var charClass = header.charClass || '';
                
                // Build rich display
                var html = '';
                if (portrait) {
                    html += '<img src="'+portrait+'" class="char-link-portrait">';
                } else {
                    html += '<div class="char-link-avatar">'+header.name.substring(0,2).toUpperCase()+'</div>';
                }
                html += '<div class="char-link-info">';
                html += '<div class="char-link-name">'+header.name+'</div>';
                html += '<div class="char-link-details">Level '+level+' '+charClass+'</div>';
                html += '</div>';
                
                box.innerHTML = html;
            } else {
                box.classList.remove('linked');
                box.innerHTML = '<span class="char-link-dot"></span><span class="char-link-text">'+(getLang() === 'de' ? 'Charakter w√§hlen' : 'Select Character')+'</span>';
            }
        }

        // ===== CHARACTER MODAL =====
        var allCharacters = {};
        var selectedCharId = null;

        function loadAllCharacters() {
            // Use getRoom() from auth.js - returns object with id and name
            var roomObj = typeof getRoom === 'function' ? getRoom() : null;
            var roomCode = roomObj ? roomObj.id : null;
            console.log('[5e Dice] loadAllCharacters - roomObj:', roomObj, 'roomCode:', roomCode);
            if (!roomCode) return;
            // 5e character sheets save to sessions/{roomCode}/characters/{username}
            var refPath = 'sessions/'+roomCode+'/characters';
            console.log('[5e Dice] Loading from:', refPath);
            firebase.database().ref(refPath).on('value', function(snap) {
                allCharacters = snap.val() || {};
                console.log('[5e Dice] All characters loaded:', allCharacters);
                console.log('[5e Dice] Character keys:', Object.keys(allCharacters));
                // Auto-select own character if not selected
                var user = typeof getCurrentUser === 'function' ? getCurrentUser() : null;
                console.log('[5e Dice] Current user:', user);
                var username = user ? user.username : null;
                // Sanitize username for Firebase key matching
                var safeUsername = username ? (typeof sanitizeKey === 'function' ? sanitizeKey(username) : username.replace(/[.#$\/\[\]]/g, '_')) : null;
                if (!selectedCharId && safeUsername && allCharacters[safeUsername]) {
                    selectedCharId = safeUsername;
                    charData = allCharacters[safeUsername];
                    updateCharLink();
                    populateWeaponSelects();
                }
            });
        }

        function openCharacterModal() {
            var modal = document.getElementById('charModal');
            var body = document.getElementById('charModalBody');
            var title = document.getElementById('charModalTitle');
            var lang = getLang();
            
            // Get own character only (based on sanitized username)
            var user = typeof getCurrentUser === 'function' ? getCurrentUser() : null;
            var username = user ? user.username : null;
            var safeUsername = username ? (typeof sanitizeKey === 'function' ? sanitizeKey(username) : username.replace(/[.#$\/\[\]]/g, '_')) : null;
            
            console.log('[5e Dice] Opening modal - safeUsername:', safeUsername);
            console.log('[5e Dice] Own character data (charData):', charData);
            
            // Use charData (own character) directly
            if (!charData || !charData.header) {
                title.textContent = lang === 'de' ? 'Kein Charakter' : 'No Character';
                body.innerHTML = '<div class="char-modal-empty">' +
                    '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="8" r="4"/><path d="M4 20c0-4 4-6 8-6s8 2 8 6"/></svg>' +
                    '<p>' + (lang === 'de' ? 'Erstelle einen Charakter im Charakterbogen.' : 'Create a character in the character sheet.') + '</p>' +
                    '<button class="pill pill-filled" style="margin-top:16px" onclick="window.location.href=\'charakterbogen_5e_2024.html\'">' +
                    (lang === 'de' ? 'Zum Charakterbogen' : 'Go to Character Sheet') + '</button></div>';
            } else {
                // Show own character details
                var header = charData.header || {};
                var charName = header.name || (lang === 'de' ? 'Unbenannt' : 'Unnamed');
                title.textContent = lang === 'de' ? 'Dein Charakter' : 'Your Character';
                
                body.innerHTML = renderFullCharacterSheet(charData, lang);
            }
            
            modal.classList.add('active');
        }

        function renderFullCharacterSheet(char, lang) {
            if (!char) return '';
            var header = char.header || {};
            var abilities = char.abilities || {};
            var hp = char.hp || {};
            var skillsProf = char.skillsProf || {};
            var skillsExp = char.skillsExp || {};
            var savesProf = char.savesProf || {};
            var weapons = char.weapons || [];
            var narrative = char.narrative || {};
            var portrait = narrative.portrait || '';
            
            var level = parseInt(header.level) || 1;
            var profBonus = Math.floor((level - 1) / 4) + 2;
            
            function getMod(score) {
                var val = parseInt(score) || 10;
                return Math.floor((val - 10) / 2);
            }
            function formatMod(m) { return m >= 0 ? '+'+m : ''+m; }
            
            var html = '';
            
            // Header with portrait
            html += '<div class="char-header-row">';
            if (portrait) {
                html += '<img class="char-portrait" src="'+portrait+'" alt="Portrait">';
            } else {
                html += '<div class="char-portrait-placeholder"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg></div>';
            }
            html += '<div class="char-header-info">';
            html += '<div class="char-header-name">'+(header.name || 'Unnamed')+'</div>';
            html += '<div class="char-header-subtitle">'+(header.species || '')+' '+(header.charClass || '')+' Level '+level+'</div>';
            if (header.background) html += '<div class="char-header-bg">'+header.background+'</div>';
            html += '</div></div>';
            
            // HP & AC Row
            html += '<div class="char-info-row">';
            html += '<div class="char-info-box"><span class="char-info-label">'+(lang === 'de' ? 'TP' : 'HP')+'</span><span class="char-info-value">'+(hp.current || 0)+' / '+(hp.max || 0)+'</span></div>';
            html += '<div class="char-info-box"><span class="char-info-label">'+(lang === 'de' ? '√úbung' : 'Prof')+'</span><span class="char-info-value">+'+profBonus+'</span></div>';
            html += '</div>';
            
            // Abilities
            html += '<div class="char-section-title">'+(lang === 'de' ? 'Attribute' : 'Abilities')+'</div>';
            html += '<div class="char-abilities-grid">';
            var abilityIds = ['str', 'dex', 'con', 'int', 'wis', 'cha'];
            var abilityLabels = lang === 'de' ? ['STR', 'GES', 'KON', 'INT', 'WEI', 'CHA'] : ['STR', 'DEX', 'CON', 'INT', 'WIS', 'CHA'];
            abilityIds.forEach(function(id, i) {
                var score = parseInt(abilities[id]) || 10;
                var mod = getMod(score);
                html += '<div class="char-ability"><div class="char-ability-label">'+abilityLabels[i]+'</div><div class="char-ability-score">'+score+'</div><div class="char-ability-mod">'+formatMod(mod)+'</div></div>';
            });
            html += '</div>';
            
            // Saving Throws
            html += '<div class="char-section-title">'+(lang === 'de' ? 'Rettungsw√ºrfe' : 'Saving Throws')+'</div>';
            html += '<div class="char-saves-row">';
            abilityIds.forEach(function(id, i) {
                var score = parseInt(abilities[id]) || 10;
                var mod = getMod(score);
                var isProf = savesProf[id];
                var total = mod + (isProf ? profBonus : 0);
                html += '<div class="char-save'+(isProf ? ' prof' : '')+'"><span class="char-save-label">'+abilityLabels[i]+'</span><span class="char-save-value">'+formatMod(total)+'</span></div>';
            });
            html += '</div>';
            
            // Skills (only proficient ones)
            var profSkills = [];
            var skillNames = lang === 'de' ? SKILL_NAMES_DE : SKILL_NAMES_EN;
            Object.keys(skillsProf).forEach(function(skillId) {
                if (skillsProf[skillId]) {
                    var abilityId = SKILL_ABILITIES[skillId];
                    var abilityScore = parseInt(abilities[abilityId]) || 10;
                    var mod = getMod(abilityScore);
                    var isExp = skillsExp && skillsExp[skillId];
                    var total = mod + profBonus + (isExp ? profBonus : 0);
                    profSkills.push({ name: skillNames[skillId] || skillId, total: total, isExp: isExp });
                }
            });
            
            if (profSkills.length > 0) {
                html += '<div class="char-section-title">'+(lang === 'de' ? 'Ge√ºbte Fertigkeiten' : 'Proficient Skills')+'</div>';
                html += '<div class="char-skills-list">';
                profSkills.forEach(function(s) {
                    html += '<div class="char-skill'+(s.isExp ? ' exp' : '')+'"><span class="char-skill-name">'+s.name+(s.isExp ? ' ‚òÖ' : '')+'</span><span class="char-skill-mod">'+formatMod(s.total)+'</span></div>';
                });
                html += '</div>';
            }
            
            // Weapons
            var validWeapons = weapons.filter(function(w) { return w && w.name; });
            if (validWeapons.length > 0) {
                html += '<div class="char-section-title">'+(lang === 'de' ? 'Waffen' : 'Weapons')+'</div>';
                html += '<div class="char-weapons-list">';
                validWeapons.forEach(function(w) {
                    html += '<div class="char-weapon"><span class="char-weapon-name">'+w.name+'</span><span class="char-weapon-stats">'+(w.bonus ? formatMod(parseInt(w.bonus)) : '+0')+' | '+(w.damage || '1d6')+'</span></div>';
                });
                html += '</div>';
            }
            
            // Link to full sheet
            html += '<div style="text-align:center; margin-top:20px;">';
            html += '<button class="pill pill-outlined" onclick="window.location.href=\'charakterbogen_5e_2024.html\'">'+(lang === 'de' ? 'Zum Charakterbogen' : 'Open Character Sheet')+'</button>';
            html += '</div>';
            
            return html;
        }

        function renderCharacterDetails(char, lang) {
            if (!char) return '';
            var abilities = char.abilities || {};
            var hp = char.hp || {};
            var header = char.header || {};
            var level = parseInt(header.level) || 1;
            var profBonus = Math.floor((level - 1) / 4) + 2;
            
            function getMod(score) {
                var val = parseInt(score) || 10;
                var m = Math.floor((val - 10) / 2);
                return m >= 0 ? '+'+m : ''+m;
            }
            
            return '<div class="char-stats-grid">' +
                '<div class="char-stat"><div class="char-stat-label">'+(lang === 'de' ? 'STR' : 'STR')+'</div><div class="char-stat-value">'+(abilities.str || 10)+' ('+getMod(abilities.str)+')</div></div>' +
                '<div class="char-stat"><div class="char-stat-label">'+(lang === 'de' ? 'GES' : 'DEX')+'</div><div class="char-stat-value">'+(abilities.dex || 10)+' ('+getMod(abilities.dex)+')</div></div>' +
                '<div class="char-stat"><div class="char-stat-label">'+(lang === 'de' ? 'KON' : 'CON')+'</div><div class="char-stat-value">'+(abilities.con || 10)+' ('+getMod(abilities.con)+')</div></div>' +
                '<div class="char-stat"><div class="char-stat-label">'+(lang === 'de' ? 'INT' : 'INT')+'</div><div class="char-stat-value">'+(abilities.int || 10)+' ('+getMod(abilities.int)+')</div></div>' +
                '<div class="char-stat"><div class="char-stat-label">'+(lang === 'de' ? 'WEI' : 'WIS')+'</div><div class="char-stat-value">'+(abilities.wis || 10)+' ('+getMod(abilities.wis)+')</div></div>' +
                '<div class="char-stat"><div class="char-stat-label">'+(lang === 'de' ? 'CHA' : 'CHA')+'</div><div class="char-stat-value">'+(abilities.cha || 10)+' ('+getMod(abilities.cha)+')</div></div>' +
                '</div>' +
                '<div class="char-stats-grid" style="grid-template-columns: repeat(2, 1fr); margin-top: 12px; padding-top: 12px;">' +
                '<div class="char-stat"><div class="char-stat-label">'+(lang === 'de' ? 'Trefferpunkte' : 'Hit Points')+'</div><div class="char-stat-value">'+(hp.current || 0)+' / '+(hp.max || 0)+'</div></div>' +
                '<div class="char-stat"><div class="char-stat-label">'+(lang === 'de' ? '√úbungsbonus' : 'Prof. Bonus')+'</div><div class="char-stat-value">+'+profBonus+'</div></div>' +
                '</div>';
        }

        function selectCharacter(charId) {
            selectedCharId = charId;
            charData = allCharacters[charId];
            localStorage.setItem('rift_5e_selected_char', charId);
            updateCharLink();
            populateWeaponSelects();
            closeCharacterModal();
        }

        function closeCharacterModal() {
            document.getElementById('charModal').classList.remove('active');
        }

        function closeCharModalOutside(e) {
            if (e.target.id === 'charModal') closeCharacterModal();
        }
        function getLang() { return localStorage.getItem('pnp_language') || 'de'; }

        function populateSelects() {
            const lang = getLang();
            const skillNames = lang === 'de' ? SKILL_NAMES_DE : SKILL_NAMES_EN;
            const abilityNames = lang === 'de' ? ABILITY_NAMES_DE : ABILITY_NAMES_EN;
            const selectSkill = lang === 'de' ? '‚Äî Fertigkeit w√§hlen ‚Äî' : '‚Äî Select Skill ‚Äî';
            const selectAbility = lang === 'de' ? '‚Äî Attribut w√§hlen ‚Äî' : '‚Äî Select Ability ‚Äî';
            const selectWeapon = lang === 'de' ? '‚Äî Waffe w√§hlen ‚Äî' : '‚Äî Select Weapon ‚Äî';

            var skillSelect = document.getElementById('skillSelect');
            skillSelect.innerHTML = '<option value="">'+selectSkill+'</option>';
            Object.keys(skillNames).forEach(function(id) {
                skillSelect.innerHTML += '<option value="'+id+'">'+skillNames[id]+'</option>';
            });

            var saveSelect = document.getElementById('saveSelect');
            saveSelect.innerHTML = '<option value="">'+selectAbility+'</option>';
            Object.keys(abilityNames).forEach(function(id) {
                saveSelect.innerHTML += '<option value="'+id+'">'+abilityNames[id]+'</option>';
            });

            ['attackSelect', 'damageWeaponSelect'].forEach(function(id) {
                document.getElementById(id).innerHTML = '<option value="">'+selectWeapon+'</option>';
            });
        }

        function populateWeaponSelects() {
            var weapons = (charData && charData.weapons) ? charData.weapons : [];
            var lang = getLang();
            var selectWeapon = lang === 'de' ? '‚Äî Waffe w√§hlen ‚Äî' : '‚Äî Select Weapon ‚Äî';
            ['attackSelect', 'damageWeaponSelect'].forEach(function(selectId) {
                var select = document.getElementById(selectId);
                select.innerHTML = '<option value="">'+selectWeapon+'</option>';
                weapons.forEach(function(w, i) {
                    if (w && w.name) select.innerHTML += '<option value="'+i+'">'+w.name+'</option>';
                });
            });
        }

        function setupTabs() {
            document.querySelectorAll('.roll-tab').forEach(function(tab) {
                tab.addEventListener('click', function() {
                    var tabId = tab.dataset.tab;
                    currentTab = tabId;
                    document.querySelectorAll('.roll-tab').forEach(function(t) { t.classList.remove('active'); });
                    document.querySelectorAll('.roll-panel').forEach(function(p) { p.classList.remove('active'); });
                    tab.classList.add('active');
                    document.getElementById('panel-' + tabId).classList.add('active');
                });
            });
        }

        function setupAdvToggles() {
            document.querySelectorAll('.adv-toggle').forEach(function(toggle) {
                toggle.querySelectorAll('.adv-btn').forEach(function(btn) {
                    btn.addEventListener('click', function() {
                        toggle.querySelectorAll('.adv-btn').forEach(function(b) { b.classList.remove('active'); });
                        btn.classList.add('active');
                    });
                });
            });
        }

        function getAdvMode(panel) {
            var activeBtn = document.querySelector('#panel-'+panel+' .adv-btn.active');
            return activeBtn ? activeBtn.dataset.mode : 'normal';
        }

        function adjustMod(type, amount) { mods[type] += amount; updateModDisplay(type); }
        function resetMod(type) { mods[type] = baseMods[type]; updateModDisplay(type); }
        function updateModDisplay(type) {
            var display = document.getElementById(type + 'ModDisplay');
            display.textContent = mods[type] >= 0 ? '+'+mods[type] : ''+mods[type];
        }
        // ===== CHARACTER DATA HELPERS =====
        function getSkillModifier(skillId) {
            if (!charData) return 0;
            var abilityId = SKILL_ABILITIES[skillId];
            var abilityScore = parseInt(charData.abilities && charData.abilities[abilityId]) || 10;
            var abilityMod = Math.floor((abilityScore - 10) / 2);
            var level = parseInt(charData.header && charData.header.level) || 1;
            var profBonus = Math.floor((level - 1) / 4) + 2;
            var mod = abilityMod;
            if (charData.skillsProf && charData.skillsProf[skillId]) mod += profBonus;
            if (charData.skillsExp && charData.skillsExp[skillId]) mod += profBonus;
            return mod;
        }

        function getSaveModifier(abilityId) {
            if (!charData) return 0;
            var abilityScore = parseInt(charData.abilities && charData.abilities[abilityId]) || 10;
            var abilityMod = Math.floor((abilityScore - 10) / 2);
            var level = parseInt(charData.header && charData.header.level) || 1;
            var profBonus = Math.floor((level - 1) / 4) + 2;
            var mod = abilityMod;
            if (charData.savesProf && charData.savesProf[abilityId]) mod += profBonus;
            return mod;
        }

        function updateModifierFromSkill() {
            var skillId = document.getElementById('skillSelect').value;
            if (skillId) {
                baseMods.check = getSkillModifier(skillId);
                mods.check = baseMods.check;
                updateModDisplay('check');
            }
        }

        function updateModifierFromSave() {
            var abilityId = document.getElementById('saveSelect').value;
            if (abilityId) {
                baseMods.save = getSaveModifier(abilityId);
                mods.save = baseMods.save;
                updateModDisplay('save');
            }
        }

        function updateModifierFromAttack() {
            var idx = document.getElementById('attackSelect').value;
            if (idx !== '' && charData && charData.weapons && charData.weapons[idx]) {
                var bonus = parseInt(charData.weapons[idx].bonus) || 0;
                baseMods.attack = bonus;
                mods.attack = bonus;
                updateModDisplay('attack');
            }
        }

        function updateDamageFromWeapon() {
            var idx = document.getElementById('damageWeaponSelect').value;
            if (idx !== '' && charData && charData.weapons && charData.weapons[idx]) {
                var weapon = charData.weapons[idx];
                var match = (weapon.damage || '1d6').match(/(\d+d\d+)([+-]?\d+)?/);
                if (match) {
                    document.getElementById('damageDice').value = match[1];
                    document.getElementById('damageModifier').value = match[2] ? match[2].replace('+', '') : '0';
                }
            }
        }

        // ===== DICE ROLLING =====
        function rollDie(sides) { return Math.floor(Math.random() * sides) + 1; }

        function rollD20WithAdvantage(mode) {
            var r1 = rollDie(20), r2 = rollDie(20);
            if (mode === 'advantage') return { result: Math.max(r1, r2), rolls: [r1, r2], kept: Math.max(r1, r2), dropped: Math.min(r1, r2) };
            if (mode === 'disadvantage') return { result: Math.min(r1, r2), rolls: [r1, r2], kept: Math.min(r1, r2), dropped: Math.max(r1, r2) };
            return { result: r1, rolls: [r1], kept: r1, dropped: null };
        }

        function parseDice(str) {
            var m = str.match(/(\d+)?d(\d+)([+-]?\d+)?/i);
            return m ? { count: parseInt(m[1]) || 1, sides: parseInt(m[2]), modifier: parseInt(m[3]) || 0 } : null;
        }

        function rollDicePool(count, sides) {
            var r = [];
            for (var i = 0; i < count; i++) r.push(rollDie(sides));
            return r;
        }

        // ===== ANIMATIONS =====
        async function animateRoll(finalValue, isCrit, isFail) {
            if (isRolling) return;
            isRolling = true;
            var diceNum = document.getElementById('diceNum');
            var diceDisplay = document.getElementById('diceDisplay');
            diceNum.classList.add('rolling', 'anim-spin');
            diceNum.classList.remove('crit-success', 'crit-fail');
            diceDisplay.classList.remove('crit-success', 'crit-fail');
            var duration = 1500, startTime = Date.now();
            while (Date.now() - startTime < duration) {
                diceNum.textContent = rollDie(20);
                playThemeTick();
                await new Promise(function(r) { setTimeout(r, 80); });
            }
            diceNum.classList.remove('rolling', 'anim-spin');
            diceNum.textContent = finalValue;
            playRevealSound(isCrit, isFail);
            if (isCrit) {
                diceNum.classList.add('crit-success');
                diceDisplay.classList.add('crit-success');
                document.body.classList.add('crit-success-flash');
                createConfetti();
                setTimeout(function() { document.body.classList.remove('crit-success-flash'); }, 800);
            } else if (isFail) {
                diceNum.classList.add('crit-fail');
                diceDisplay.classList.add('crit-fail');
                document.body.classList.add('crit-fail-flash', 'shake');
                setTimeout(function() { document.body.classList.remove('crit-fail-flash', 'shake'); }, 600);
            }
            isRolling = false;
        }

        function createConfetti() {
            var c = document.createElement('div');
            c.className = 'confetti-container';
            document.body.appendChild(c);
            var colors = ['gold', 'yellow', 'orange', 'white'];
            for (var i = 0; i < 50; i++) {
                var cf = document.createElement('div');
                cf.className = 'confetti ' + colors[Math.floor(Math.random() * colors.length)];
                cf.style.left = Math.random() * 100 + '%';
                cf.style.animationDuration = (2 + Math.random() * 2) + 's';
                cf.style.animationDelay = Math.random() * 0.5 + 's';
                c.appendChild(cf);
            }
            setTimeout(function() { c.remove(); }, 4000);
        }

        function rollCurrentType() {
            switch(currentTab) {
                case 'check': rollCheck(); break;
                case 'save': rollSave(); break;
                case 'attack': rollAttack(); break;
                case 'damage': rollDamage(); break;
                case 'death': rollDeathSave(); break;
                case 'custom': rollCustomFromInput(); break;
            }
        }
        // ===== ROLL HANDLERS =====
        async function rollCheck() {
            var skillId = document.getElementById('skillSelect').value;
            var lang = getLang();
            var skillNames = lang === 'de' ? SKILL_NAMES_DE : SKILL_NAMES_EN;
            var skillName = skillId ? skillNames[skillId] : (lang === 'de' ? 'Probe' : 'Check');
            var advMode = getAdvMode('check');
            var roll = rollD20WithAdvantage(advMode);
            var total = roll.result + mods.check;
            var isCrit = roll.result === 20, isFail = roll.result === 1;

            showCalcExpr(roll.result, mods.check);
            await animateRoll(total, isCrit, isFail);
            showResultBreakdown(roll, mods.check, advMode);
            document.getElementById('rollTypeLabel').textContent = skillName;
            addToHistory(skillName, roll, mods.check, total, isCrit, isFail);
            broadcastRoll(skillName, total, roll.result, mods.check, isCrit, isFail);
        }

        async function rollSave() {
            var abilityId = document.getElementById('saveSelect').value;
            var lang = getLang();
            var abilityNames = lang === 'de' ? ABILITY_NAMES_DE : ABILITY_NAMES_EN;
            var saveName = abilityId ? (abilityNames[abilityId] + (lang === 'de' ? ' RW' : ' Save')) : (lang === 'de' ? 'Rettungswurf' : 'Saving Throw');
            var advMode = getAdvMode('save');
            var roll = rollD20WithAdvantage(advMode);
            var total = roll.result + mods.save;
            var isCrit = roll.result === 20, isFail = roll.result === 1;

            showCalcExpr(roll.result, mods.save);
            await animateRoll(total, isCrit, isFail);
            showResultBreakdown(roll, mods.save, advMode);
            document.getElementById('rollTypeLabel').textContent = saveName;
            addToHistory(saveName, roll, mods.save, total, isCrit, isFail);
            broadcastRoll(saveName, total, roll.result, mods.save, isCrit, isFail);
        }

        async function rollAttack() {
            var idx = document.getElementById('attackSelect').value;
            var weaponName = (idx !== '' && charData && charData.weapons && charData.weapons[idx] && charData.weapons[idx].name) ? charData.weapons[idx].name : (getLang() === 'de' ? 'Angriff' : 'Attack');
            var advMode = getAdvMode('attack');
            var roll = rollD20WithAdvantage(advMode);
            var total = roll.result + mods.attack;
            var isCrit = roll.result === 20, isFail = roll.result === 1;

            showCalcExpr(roll.result, mods.attack);
            await animateRoll(total, isCrit, isFail);
            showResultBreakdown(roll, mods.attack, advMode);
            document.getElementById('rollTypeLabel').textContent = weaponName;
            addToHistory(weaponName, roll, mods.attack, total, isCrit, isFail);
            broadcastRoll(weaponName, total, roll.result, mods.attack, isCrit, isFail);
        }

        async function rollDamage() {
            var diceStr = document.getElementById('damageDice').value || '1d6';
            var mod = parseInt(document.getElementById('damageModifier').value) || 0;
            var isCrit = document.getElementById('critToggle').checked;
            var dice = parseDice(diceStr);
            if (!dice) { alert(getLang() === 'de' ? 'Ung√ºltiges Format' : 'Invalid format'); return; }

            var diceCount = isCrit ? dice.count * 2 : dice.count;
            var rolls = rollDicePool(diceCount, dice.sides);
            var diceTotal = rolls.reduce(function(a, b) { return a + b; }, 0);
            var total = diceTotal + mod;

            var label = getLang() === 'de' ? (isCrit ? 'Krit. Schaden' : 'Schaden') : (isCrit ? 'Crit. Damage' : 'Damage');
            document.getElementById('calcExpr').style.display = 'none';
            document.getElementById('diceNum').textContent = total;
            document.getElementById('rollTypeLabel').textContent = label;
            document.getElementById('resultBreakdown').innerHTML = '['+rolls.join(' + ')+'] '+(mod >= 0 ? '+' : '')+mod;

            addToHistory(label, { rolls: rolls }, mod, total, isCrit, false);
            broadcastRoll(label, total, diceTotal, mod, isCrit, false);
        }

        async function rollDeathSave() {
            var roll = rollDie(20);
            var resultText = '', isCrit = false, isFail = false;
            var lang = getLang();

            if (roll === 20) {
                resultText = lang === 'de' ? 'Nat 20: Du erh√§ltst 1 TP und bist nicht mehr sterbend.' : 'Nat 20: You regain 1 HP and are no longer dying.';
                isCrit = true;
                resetDeathSaves();
            } else if (roll === 1) {
                resultText = lang === 'de' ? 'Nat 1: Zwei Fehlschl√§ge!' : 'Nat 1: Two failures!';
                isFail = true;
                markDeathSave('fail');
                markDeathSave('fail');
            } else if (roll >= 10) {
                resultText = roll + ': ' + (lang === 'de' ? 'Erfolg!' : 'Success!');
                markDeathSave('success');
            } else {
                resultText = roll + ': ' + (lang === 'de' ? 'Fehlschlag.' : 'Failure.');
                isFail = true;
                markDeathSave('fail');
            }

            document.getElementById('calcExpr').style.display = 'none';
            document.getElementById('rollTypeLabel').textContent = lang === 'de' ? 'Todesrettung' : 'Death Save';
            await animateRoll(roll, isCrit, isFail);
            document.getElementById('resultBreakdown').textContent = resultText;
            checkDeathSaveOutcome();

            addToHistory(lang === 'de' ? 'Todesrettung' : 'Death Save', { rolls: [roll] }, 0, roll, isCrit, isFail);
            broadcastRoll(lang === 'de' ? 'Todesrettung' : 'Death Save', roll, roll, 0, isCrit, isFail);
        }
        // ===== DEATH SAVES =====
        function markDeathSave(type) {
            var pips = document.querySelectorAll('#death'+(type === 'success' ? 'Success' : 'Fail')+' .death-pip');
            for (var i = 0; i < 3; i++) {
                if (!deathSaves[type][i]) {
                    deathSaves[type][i] = true;
                    pips[i].classList.add('active');
                    saveDeathSaves();
                    break;
                }
            }
        }

        function toggleDeathPip(type, index) {
            deathSaves[type][index] = !deathSaves[type][index];
            document.querySelectorAll('#death'+(type === 'success' ? 'Success' : 'Fail')+' .death-pip')[index].classList.toggle('active', deathSaves[type][index]);
            saveDeathSaves();
            checkDeathSaveOutcome();
        }

        function checkDeathSaveOutcome() {
            var s = deathSaves.success.filter(Boolean).length;
            var f = deathSaves.fail.filter(Boolean).length;
            var el = document.getElementById('deathResult');
            var lang = getLang();
            if (s >= 3) el.innerHTML = '<span style="color: var(--md-success);">üéâ '+(lang === 'de' ? 'Stabilisiert!' : 'Stabilized!')+'</span>';
            else if (f >= 3) el.innerHTML = '<span style="color: var(--md-error);">üíÄ '+(lang === 'de' ? 'Tot.' : 'Dead.')+'</span>';
            else el.textContent = '';
        }

        function resetDeathSaves() {
            deathSaves = { success: [false, false, false], fail: [false, false, false] };
            document.querySelectorAll('.death-pip').forEach(function(p) { p.classList.remove('active'); });
            document.getElementById('deathResult').textContent = '';
            saveDeathSaves();
        }

        function saveDeathSaves() { localStorage.setItem('rift_death_saves', JSON.stringify(deathSaves)); }
        function loadDeathSaves() {
            try {
                var stored = localStorage.getItem('rift_death_saves');
                if (stored) {
                    deathSaves = JSON.parse(stored);
                    ['success', 'fail'].forEach(function(type) {
                        var pips = document.querySelectorAll('#death'+(type === 'success' ? 'Success' : 'Fail')+' .death-pip');
                        deathSaves[type].forEach(function(active, i) { if (active && pips[i]) pips[i].classList.add('active'); });
                    });
                    checkDeathSaveOutcome();
                }
            } catch (e) {}
        }

        // ===== CUSTOM ROLLS =====
        async function rollCustom(sides) {
            var roll = rollDie(sides);
            var isCrit = sides === 20 && roll === 20;
            var isFail = sides === 20 && roll === 1;
            document.getElementById('calcExpr').style.display = 'none';
            document.getElementById('rollTypeLabel').textContent = 'd'+sides;
            await animateRoll(roll, isCrit, isFail);
            document.getElementById('resultBreakdown').textContent = '1d'+sides;
            addToHistory('d'+sides, { rolls: [roll] }, 0, roll, isCrit, isFail);
            broadcastRoll('d'+sides, roll, roll, 0, isCrit, isFail);
        }

        async function rollCustomMulti(sides, count) {
            var rolls = rollDicePool(count, sides);
            var total = rolls.reduce(function(a, b) { return a + b; }, 0);
            document.getElementById('calcExpr').style.display = 'none';
            document.getElementById('rollTypeLabel').textContent = count+'d'+sides;
            document.getElementById('diceNum').textContent = total;
            document.getElementById('resultBreakdown').innerHTML = '['+rolls.join(' + ')+'] = '+total;
            addToHistory(count+'d'+sides, { rolls: rolls }, 0, total, false, false);
            broadcastRoll(count+'d'+sides, total, total, 0, false, false);
        }

        async function rollCustomFromInput() {
            var input = document.getElementById('customDice').value.trim();
            if (!input) return;
            var dice = parseDice(input);
            if (!dice) { alert(getLang() === 'de' ? 'Ung√ºltiges Format' : 'Invalid format'); return; }
            var rolls = rollDicePool(dice.count, dice.sides);
            var diceTotal = rolls.reduce(function(a, b) { return a + b; }, 0);
            var total = diceTotal + dice.modifier;
            var isCrit = dice.sides === 20 && dice.count === 1 && rolls[0] === 20;
            var isFail = dice.sides === 20 && dice.count === 1 && rolls[0] === 1;

            document.getElementById('calcExpr').style.display = 'none';
            document.getElementById('rollTypeLabel').textContent = input;
            if (dice.count === 1 && dice.sides === 20) {
                await animateRoll(total, isCrit, isFail);
            } else {
                document.getElementById('diceNum').textContent = total;
            }
            var modStr = dice.modifier !== 0 ? (dice.modifier > 0 ? ' + '+dice.modifier : ' - '+Math.abs(dice.modifier)) : '';
            document.getElementById('resultBreakdown').innerHTML = '['+rolls.join(' + ')+']'+modStr;
            addToHistory(input, { rolls: rolls }, dice.modifier, total, isCrit, isFail);
            broadcastRoll(input, total, diceTotal, dice.modifier, isCrit, isFail);
        }
        // ===== DISPLAY HELPERS =====
        function showCalcExpr(roll, mod) {
            var expr = document.getElementById('calcExpr');
            document.getElementById('calcRoll').textContent = roll;
            document.getElementById('calcMod').textContent = mod >= 0 ? mod : mod;
            expr.style.display = 'flex';
        }

        function showResultBreakdown(roll, mod, advMode) {
            var breakdown = document.getElementById('resultBreakdown');
            if (roll.dropped !== null) {
                var r1Class = roll.rolls[0] === roll.kept ? 'kept' : 'dropped';
                var r2Class = roll.rolls[1] === roll.kept ? 'kept' : 'dropped';
                breakdown.innerHTML = '[<span class="'+r1Class+'">'+roll.rolls[0]+'</span>, <span class="'+r2Class+'">'+roll.rolls[1]+'</span>] '+(mod >= 0 ? '+' : '')+mod;
            } else {
                breakdown.innerHTML = '['+roll.result+'] '+(mod >= 0 ? '+' : '')+mod;
            }
        }

        // ===== HISTORY =====
        function addToHistory(type, roll, mod, total, isCrit, isFail) {
            var playerName = (playerData && playerData.name) ? playerData.name : 'Spieler';
            var playerColor = (playerData && playerData.color) ? playerData.color : '#6750A4';
            rollHistory.unshift({ type: type, roll: roll, modifier: mod, total: total, isCrit: isCrit, isFail: isFail, playerName: playerName, playerColor: playerColor, time: new Date() });
            if (rollHistory.length > 50) rollHistory.pop();
            renderHistory();
            saveHistory();
        }

        function renderHistory() {
            var c = document.getElementById('historyList');
            if (rollHistory.length === 0) {
                c.innerHTML = '<div class="history-empty">'+(getLang() === 'de' ? 'Noch keine W√ºrfe' : 'No rolls yet')+'</div>';
                return;
            }
            c.innerHTML = rollHistory.map(function(h) {
                var rollStr = h.roll.rolls ? h.roll.rolls.join(', ') : '?';
                var totalClass = h.isCrit ? 'crit' : (h.isFail ? 'nat1' : '');
                return '<div class="history-item"><div class="history-player" style="background:'+h.playerColor+'"></div><div class="history-info"><div class="history-name">'+h.playerName+'</div><div class="history-type">'+h.type+'</div></div><div class="history-total '+totalClass+'">'+h.total+'</div></div>';
            }).join('');
        }

        function clearHistory() { rollHistory = []; renderHistory(); saveHistory(); }
        function saveHistory() { localStorage.setItem('rift_5e_history', JSON.stringify(rollHistory)); }
        function loadHistory() {
            try {
                var s = localStorage.getItem('rift_5e_history');
                if (s) { rollHistory = JSON.parse(s); renderHistory(); }
            } catch (e) {}
        }

        // ===== FIREBASE SYNC =====
        function broadcastRoll(type, total, diceRoll, mod, isCrit, isFail) {
            var roomCode = localStorage.getItem('pnp_room');
            var playerId = localStorage.getItem('odlayerId');
            if (!roomCode || !playerId) return;
            var rollRef = firebase.database().ref('rooms/'+roomCode+'/dice5e').push();
            rollRef.set({
                playerId: playerId,
                playerName: (playerData && playerData.name) ? playerData.name : 'Spieler',
                playerColor: (playerData && playerData.color) ? playerData.color : '#6750A4',
                type: type, total: total, diceRoll: diceRoll, mod: mod, isCrit: isCrit, isFail: isFail,
                timestamp: firebase.database.ServerValue.TIMESTAMP
            });
            setTimeout(function() { rollRef.remove(); }, 10000);
        }

        function initRollListener() {
            var roomCode = localStorage.getItem('pnp_room');
            if (!roomCode) return;
            firebase.database().ref('rooms/'+roomCode+'/dice5e').on('child_added', function(snap) {
                var roll = snap.val();
                var myId = localStorage.getItem('odlayerId');
                if (roll.playerId !== myId) {
                    rollHistory.unshift({
                        type: roll.type, roll: { rolls: [roll.diceRoll] }, modifier: roll.mod,
                        total: roll.total, isCrit: roll.isCrit, isFail: roll.isFail,
                        playerName: roll.playerName, playerColor: roll.playerColor, time: new Date()
                    });
                    if (rollHistory.length > 50) rollHistory.pop();
                    renderHistory();
                }
            });
        }

        // ===== CHEER SYSTEM =====
        function sendCheer(emoji) {
            var roomCode = localStorage.getItem('pnp_room');
            var playerId = localStorage.getItem('odlayerId');
            if (!roomCode || !playerId) return;
            var cheerRef = firebase.database().ref('rooms/'+roomCode+'/cheers').push();
            cheerRef.set({ playerId: playerId, emoji: emoji, timestamp: firebase.database.ServerValue.TIMESTAMP });
            setTimeout(function() { cheerRef.remove(); }, 5000);
            displayCheer(emoji);
        }

        function initCheerListener() {
            var roomCode = localStorage.getItem('pnp_room');
            if (!roomCode) return;
            firebase.database().ref('rooms/'+roomCode+'/cheers').on('child_added', function(snap) {
                var cheer = snap.val();
                if (cheer.playerId !== localStorage.getItem('odlayerId')) displayCheer(cheer.emoji);
            });
        }

        function displayCheer(emoji) {
            var c = document.createElement('div');
            c.style.cssText = 'position:fixed;inset:0;pointer-events:none;z-index:9999;';
            document.body.appendChild(c);
            for (var i = 0; i < 8; i++) {
                var el = document.createElement('div');
                el.textContent = emoji;
                el.style.cssText = 'position:absolute;font-size:'+(30 + Math.random() * 20)+'px;left:'+(10 + Math.random() * 80)+'%;bottom:-50px;animation:cheerFloat '+(2 + Math.random())+'s ease-out forwards;';
                c.appendChild(el);
            }
            setTimeout(function() { c.remove(); }, 3000);
        }

        var cheerStyle = document.createElement('style');
        cheerStyle.textContent = '@keyframes cheerFloat { 0% { transform: translateY(0) rotate(0deg); opacity: 1; } 100% { transform: translateY(-100vh) rotate(360deg); opacity: 0; } }';
        document.head.appendChild(cheerStyle);

        // ===== MODULE TOOLS =====
        var moduleTools = '\
            <button class="icon-btn" onclick="toggleSoundMenu()" title="Sound">\
                <img src="assets/icons/icon_sound.png" alt="Sound">\
            </button>\
        ';

        function toggleSoundMenu() {
            var menu = document.getElementById('soundMenu');
            menu.classList.toggle('active');
        }

        // Close sound menu on outside click
        document.addEventListener('click', function(e) {
            var menu = document.getElementById('soundMenu');
            if (menu && !menu.contains(e.target) && !e.target.closest('.icon-btn')) {
                menu.classList.remove('active');
            }
        });

        // ===== INIT =====
        document.addEventListener('DOMContentLoaded', function() {
            // Auth check
            if (typeof requireAuth === 'function' && !requireAuth()) {
                return; // Redirect to login
            }
            
            // Create navigation bar
            if (typeof createNavigationBar === 'function') {
                var moduleName = typeof t === 'function' ? t('module.dice') : 'W√ºrfel';
                createNavigationBar(moduleName + ' 5e', moduleTools);
            }
            
            // Init dice functionality (Firebase init happens inside)
            init();
            
            // Create footer
            if (typeof createFooter === 'function') createFooter();
        });
    </script>
</body>
</html>
