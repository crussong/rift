<!DOCTYPE html>
<!-- RIFT D&D 5e Character Sheet - English Version -->
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title>RIFT – D&D 5e Character Sheet</title>
    
    <!-- V2 Layout (variables + structure) -->
    <link rel="stylesheet" href="assets/css/sheet-layout.css">
    <link rel="stylesheet" href="assets/css/sidebar.css">
    <link rel="stylesheet" href="assets/css/topbar.css">
    <link rel="stylesheet" href="assets/css/footer.css">
    <link rel="stylesheet" href="assets/css/settings.css">
    
    <!-- External -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;600;700;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.6.1/cropper.min.css">
    
    <style>
            transition: box-shadow 0.3s ease;
        }
        .text-area:hover,
        .field-input:hover,
        .phys-input:hover {
            box-shadow: 0 0 0 2px rgba(255,255,255,0.12);
        }
        
        /* AC-Shield uses ::after because ::before is used for the inner static border */
        .ac-shield::after {
            content: '';
            position: absolute;
            inset: 0;
            border-radius: 12px 12px 50% 50% / 12px 12px 30% 30%;
            padding: 2px;
            background: conic-gradient(
                from var(--angle),
                transparent 40%,
                rgba(255,255,255,0.06) 55%,
                rgba(255,255,255,0.18) 65%,
                rgba(255,255,255,0.06) 75%,
                transparent 90%
            );
            -webkit-mask: linear-gradient(#fff 0 0) content-box, linear-gradient(#fff 0 0);
            mask: linear-gradient(#fff 0 0) content-box, linear-gradient(#fff 0 0);
            -webkit-mask-composite: xor;
            mask-composite: exclude;
            opacity: 0;
            transition: opacity 0.3s ease;
            pointer-events: none;
            z-index: 0;
        }
        
        .ac-shield:hover::after {
            opacity: 1;
            animation: rotate-border 4s linear infinite;
        }

        body {
            font-family: 'Roboto', sans-serif;
            background: var(--bg, #161616);
            color: var(--md-on-background, #dedede);
            min-height: 100vh;
            line-height: 1.4;
        }

        .sheet {
            max-width: 1400px;
            margin: 0 auto;
            padding: 24px;
            padding-bottom: 40px;
        }

        @media (max-width: 600px) {
            .sheet {
                padding: 16px;
                padding-bottom: 40px;
            }
        }

        /* ===== SECTION STYLING (1:1 wie Worlds Apart) ===== */
        .section {
            background: #2a2a2a;
            border-radius: 8px;
            border: 1px solid rgba(255, 255, 255, 0.06);
            margin-bottom: 24px;
            overflow: hidden;
        }

        .section-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px 16px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.06);
            background: #1e1e1e;
            cursor: pointer;
            user-select: none;
            -webkit-tap-highlight-color: transparent;
        }

        .section-title {
            font-family: 'Dharma Gothic', sans-serif;
            font-size: 16px;
            font-weight: 700;
            font-style: italic;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: rgba(255, 255, 255, 0.5);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .section-title svg {
            width: 20px;
            height: 20px;
            flex-shrink: 0;
            fill: currentColor;
            opacity: 0.5;
        }

        .section-toggle {
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: rgba(255, 255, 255, 0.4);
            transition: transform 0.2s;
        }

        .section.collapsed .section-toggle {
            transform: rotate(-90deg);
        }

        .section-content {
            padding: 16px;
        }

        @media (max-width: 600px) {
            .section-content {
                padding: 16px;
            }
        }

        .section.collapsed .section-content {
            display: none;
        }

        /* ===== HEADER SECTION ===== */
        .header-section {
            background: #2a2a2a;
            border-radius: 8px;
            border: 1px solid rgba(255, 255, 255, 0.06);
            padding: 16px;
            margin-bottom: 24px;
        }

        /* Desktop Layout */
        .header-layout {
            display: flex;
            gap: 20px;
            align-items: flex-start;
        }
        
        .header-right {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 12px;
        }
        

        .portrait-box {
            width: 120px;
            height: 205px;
            min-width: 120px;
            flex-shrink: 0;
            border-radius: 12px;
            background: var(--md-surface-container-high);
            overflow: hidden;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
        }

        .portrait-box:hover .portrait-overlay {
            opacity: 1;
        }

        .portrait-box svg {
            width: 48px;
            height: 48px;
            color: var(--md-on-surface-variant);
            opacity: 0.3;
        }

        .portrait-box img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .portrait-overlay {
            position: absolute;
            inset: 0;
            background: rgba(0,0,0,0.6);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 4px;
            opacity: 0;
            transition: opacity 0.2s;
        }

        .portrait-overlay-btn {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: transform 0.2s;
        }

        .portrait-overlay-btn:hover {
            transform: scale(1.1);
        }

        .portrait-overlay-btn img {
            width: 16px;
            height: 16px;
            object-fit: contain;
        }

        .portrait-overlay-btn.change {
            background: var(--md-primary);
        }

        .portrait-overlay-btn.delete {
            background: var(--md-error);
        }

        .header-info {
            display: flex;
            flex-direction: column;
            gap: 16px;
        }

        .char-name-input {
            width: 100%;
            font-size: 28px;
            font-weight: 700;
            background: transparent;
            border: none;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            color: var(--md-on-surface);
            padding: 0 0 8px 0;
        }

        .char-name-input:focus {
            outline: none;
        }

        .char-name-input::placeholder {
            color: var(--md-on-surface-variant);
            opacity: 0.3;
        }

        .header-meta {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }
        
        .header-stats {
            display: flex;
            gap: 8px;
            flex-wrap: nowrap;
        }
        
        .header-stats .stat-box {
            width: 140px;
            height: 95px;
            min-width: 100px;
            flex: 1 1 140px;
        }

        .meta-chip {
            display: flex;
            align-items: center;
            gap: 8px;
            background: var(--md-surface-container-high);
            padding: 10px 16px;
            border-radius: 100px;
            font-size: 13px;
            min-height: 40px;
        }

        .meta-chip label {
            font-size: 10px;
            text-transform: uppercase;
            color: var(--md-primary);
            font-weight: 600;
            white-space: nowrap;
        }

        .meta-chip input {
            background: transparent;
            border: none;
            color: var(--md-on-surface);
            font-size: 13px;
            font-weight: 500;
            width: 90px;
            padding: 0;
            min-height: 24px;
        }

        .meta-chip input::placeholder {
            color: var(--md-on-surface-variant);
            opacity: 0.3;
        }

        .meta-chip input:focus {
            outline: none;
        }

        .meta-chip input[type="number"] {
            width: 45px;
            text-align: center;
        }

        .meta-chip select {
            background: transparent;
            border: none;
            color: var(--md-on-surface);
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            padding: 0;
            min-height: 24px;
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
        }

        .meta-chip select:focus {
            outline: none;
        }

        .meta-chip select option {
            background: var(--md-surface-container);
            color: var(--md-on-surface);
        }

        .meta-chip .custom-input {
            width: 80px;
            margin-left: 6px;
            padding-left: 6px;
            border-left: 1px solid var(--md-outline-variant);
        }

        @media (max-width: 600px) {
            .header-meta {
                gap: 6px;
            }
            .meta-chip {
                padding: 8px 12px;
                font-size: 12px;
                min-height: 36px;
            }
            .meta-chip label {
                font-size: 9px;
            }
            .meta-chip input,
            .meta-chip select {
                font-size: 12px;
                width: 70px;
            }
            .meta-chip input[type="number"] {
                width: 40px;
            }
        }

        .subclass-chip {
            transition: opacity 0.2s, transform 0.2s;
        }

        .subclass-chip select {
            min-width: 100px;
        }

        @media (max-width: 800px) {
            .header-layout {
                gap: 16px;
            }
            
            .portrait-box {
                width: 140px;
                height: 140px;
            }
            
            .header-stats {
                flex-wrap: wrap;
            }
            
            .header-stats .stat-box {
                min-width: 90px;
            }
        }

        @media (max-width: 550px) {
            /* Hauptcontainer: column statt row */
            .header-layout {
                flex-direction: column;
                align-items: center;
            }
            
            /* Portrait: zentriert, quadratisch */
            .portrait-box {
                width: 140px !important;
                height: 140px !important;
                margin-bottom: 8px;
            }
            
            /* Rechte Spalte: volle Breite, zentriert */
            .header-right {
                width: 100%;
                align-items: center;
            }
            
            /* Character Name: zentriert, größer */
            .char-name-input {
                text-align: center;
                font-size: 24px !important;
            }
            
            /* Meta Chips: 2-Spalten Grid */
            .header-meta {
                display: grid !important;
                grid-template-columns: 1fr 1fr;
                gap: 8px;
                width: 100%;
            }
            
            /* Alle Meta-Chips: Box-Style */
            .header-meta .meta-chip {
                width: 100%;
                border-radius: 12px;
                padding: 12px 14px;
                flex-direction: column;
                align-items: flex-start;
                gap: 4px;
                box-sizing: border-box;
            }
            
            .header-meta .meta-chip label {
                font-size: 10px;
            }
            
            .header-meta .meta-chip input,
            .header-meta .meta-chip select {
                width: 100%;
                font-size: 14px;
            }
            
            /* Reihenfolge: Species/Class, Background/Subclass, Level/XP */
            .header-meta .meta-chip:nth-child(1) { order: 1; } /* Species */
            .header-meta .meta-chip:nth-child(2) { order: 2; } /* Class */
            .header-meta .meta-chip:nth-child(3) { order: 5; } /* Level */
            .header-meta .meta-chip:nth-child(4) { order: 6; } /* XP */
            .header-meta .meta-chip:nth-child(5) { order: 3; } /* Background */
            .header-meta .meta-chip:nth-child(6) { order: 4; } /* Subclass */
            
            /* Level und XP: kompakte Pill-Form */
            .header-meta .meta-chip:nth-child(3),
            .header-meta .meta-chip:nth-child(4) {
                flex-direction: row;
                align-items: center;
                padding: 10px 16px;
                border-radius: 100px;
                gap: 8px;
                width: auto;
            }
            
            .header-meta .meta-chip:nth-child(3) input,
            .header-meta .meta-chip:nth-child(4) input {
                width: 40px;
                text-align: center;
            }
            
            /* Stats: 2-Spalten Grid */
            .header-stats {
                display: grid;
                grid-template-columns: 1fr 1fr;
                gap: 10px;
                width: 100%;
            }
            
            .header-stats .stat-box {
                min-width: unset;
                flex: unset;
            }
        }

        .stat-box {
            background: var(--md-surface-container-high);
            border-radius: 12px;
            padding: 12px 10px;
            text-align: center;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
        }

        .stat-label {
            font-size: 9px;
            text-transform: uppercase;
            letter-spacing: 0.3px;
            color: var(--md-on-surface-variant);
            font-weight: 600;
        }

        .stat-value {
            font-size: 18px;
            font-weight: 700;
            background: var(--md-surface-container);
            border: none;
            border-radius: 8px;
            color: var(--md-on-surface);
            width: 100%;
            max-width: 80px;
            text-align: center;
            padding: 8px 4px;
        }

        .stat-value.stat-computed {
            background: transparent;
            display: block;
            margin: 0 auto;
        }

        .stat-value:focus {
            outline: 2px solid var(--md-primary);
        }

        .stat-value::placeholder {
            color: var(--md-on-surface-variant);
            opacity: 0.3;
        }

        .stat-hint {
            font-size: 8px;
            text-transform: uppercase;
            letter-spacing: 0.3px;
            color: var(--md-primary);
            opacity: 0.7;
            margin-top: 2px;
        }

        .heroic-btn {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            border: 3px solid var(--md-outline-variant);
            background: transparent;
            cursor: pointer;
            margin: 8px auto 0 auto;
            transition: all 0.2s;
        }

        .heroic-btn:hover,
        .heroic-btn:active {
            border-color: var(--md-primary);
            transform: scale(1.1);
        }

        .heroic-btn.active {
            background: var(--md-primary);
            border-color: var(--md-primary);
            animation: heroic-pulse 3s ease-in-out infinite;
        }

        @keyframes heroic-pulse {
            0%, 100% {
                box-shadow: 0 0 0 0 rgba(138, 120, 180, 0.4);
            }
            50% {
                box-shadow: 0 0 12px 4px rgba(138, 120, 180, 0.3);
            }
        }

        /* ===== ABILITIES GRID ===== */
        .abilities-grid {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr 1fr 1fr;
            grid-template-rows: auto auto;
            gap: 12px;
        }

        .ability-card {
            background: var(--md-surface-container-high);
            border-radius: 12px;
            padding: 12px;
        }

        /* STR in erste Spalte, erste Reihe */
        .ability-card[data-ability="str"] {
            grid-column: 1;
            grid-row: 1;
        }

        /* CON in erste Spalte, zweite Reihe */
        .ability-card[data-ability="con"] {
            grid-column: 1;
            grid-row: 2;
        }

        /* WIS, CHA, INT, DEX in Spalten 2-5, spannen beide Reihen */
        .ability-card[data-ability="wis"] {
            grid-column: 2;
            grid-row: 1 / 3;
        }
        .ability-card[data-ability="cha"] {
            grid-column: 3;
            grid-row: 1 / 3;
        }
        .ability-card[data-ability="int"] {
            grid-column: 4;
            grid-row: 1 / 3;
        }
        .ability-card[data-ability="dex"] {
            grid-column: 5;
            grid-row: 1 / 3;
        }

        @media (max-width: 1100px) {
            .abilities-grid {
                grid-template-columns: repeat(3, 1fr);
                grid-template-rows: auto;
            }
            .ability-card[data-ability="str"],
            .ability-card[data-ability="con"],
            .ability-card[data-ability="wis"],
            .ability-card[data-ability="cha"],
            .ability-card[data-ability="int"],
            .ability-card[data-ability="dex"] {
                grid-column: auto;
                grid-row: auto;
            }
        }

        @media (max-width: 700px) {
            .abilities-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        @media (max-width: 480px) {
            .abilities-grid {
                grid-template-columns: 1fr;
            }
        }

        .ability-top {
            display: flex;
            flex-direction: column;
            align-items: center;
            margin-bottom: 10px;
            padding-bottom: 10px;
            border-bottom: 1px solid var(--md-outline-variant);
        }

        .ability-name {
            font-size: 10px;
            font-weight: 600;
            color: var(--md-on-surface-variant);
            text-transform: uppercase;
            margin-bottom: 8px;
            text-align: center;
        }

        .ability-mod-wrapper {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .ability-mod {
            width: 56px;
            height: 56px;
            background: var(--md-primary);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 2;
            flex-shrink: 0;
            position: relative;
        }

        .ability-mod-value {
            font-size: 24px;
            font-weight: 700;
            color: var(--md-on-primary);
            text-align: center;
        }

        .ability-score-box {
            background: var(--md-surface-container);
            border-radius: 0 8px 8px 0;
            padding: 6px 10px 6px 22px;
            margin-left: -16px;
            display: flex;
            align-items: center;
            gap: 6px;
            z-index: 1;
        }

        .ability-score-input {
            font-size: 14px;
            font-weight: 600;
            background: var(--md-surface-container-high);
            border: none;
            border-radius: 4px;
            color: var(--md-on-surface);
            width: 32px;
            text-align: center;
            padding: 4px 2px;
            cursor: text;
        }

        .ability-score-input:focus {
            outline: 2px solid var(--md-primary);
        }

        .ability-score-input::placeholder {
            color: var(--md-on-surface-variant);
            opacity: 0.4;
        }

        .ability-score-label {
            font-size: 7px;
            color: var(--md-on-surface-variant);
            text-transform: uppercase;
            opacity: 0.7;
        }

        .save-row {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 8px;
            margin: 0 -12px 8px -12px;
            min-height: 36px;
            background: rgba(0, 0, 0, 0.1);
            border-radius: 0;
        }

        .prof-check {
            width: 18px;
            height: 18px;
            cursor: pointer;
            appearance: none;
            -webkit-appearance: none;
            background: var(--md-surface-container);
            border: 2px solid var(--md-outline-variant);
            border-radius: 4px;
            flex-shrink: 0;
        }

        .prof-check:checked {
            background: var(--md-primary);
            border-color: var(--md-primary);
        }

        .prof-check:checked::after {
            content: '✓';
            color: var(--md-on-primary);
            font-size: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .prof-check:hover {
            border-color: var(--md-primary);
        }

        .save-val {
            font-size: 13px;
            font-weight: 600;
            width: 36px;
            text-align: center;
            background: var(--md-surface-container);
            border: none;
            border-radius: 6px;
            color: var(--md-on-surface);
            min-height: 26px;
            padding: 4px 2px;
        }

        .save-val.save-computed {
            background: transparent;
            display: inline-block;
            line-height: 26px;
        }

        .save-val:focus {
            outline: 2px solid var(--md-primary);
        }

        .save-val::placeholder {
            color: var(--md-on-surface-variant);
            opacity: 0.3;
        }

        .save-label {
            font-size: 11px;
            color: var(--md-on-surface-variant);
            white-space: nowrap;
        }

        .skills-list {
            display: flex;
            flex-direction: column;
            gap: 2px;
        }

        .skill-item {
            display: flex;
            align-items: center;
            gap: 4px;
            padding: 4px 0;
            min-height: 32px;
        }

        .skill-item input[type="checkbox"] {
            width: 18px;
            height: 18px;
            cursor: pointer;
            appearance: none;
            -webkit-appearance: none;
            background: var(--md-surface-container);
            border: 2px solid var(--md-outline-variant);
            border-radius: 4px;
            flex-shrink: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 9px;
            font-weight: 700;
            color: var(--md-on-surface-variant);
            opacity: 0.4;
        }

        /* Proficiency Checkbox - shows P */
        .skill-item input[type="checkbox"].prof-check-skill::after {
            content: 'P';
        }

        .skill-item input[type="checkbox"].prof-check-skill:checked {
            background: var(--md-primary);
            border-color: var(--md-primary);
            color: var(--md-on-primary);
            opacity: 0.7;
        }

        .skill-item input[type="checkbox"]:hover {
            border-color: var(--md-primary);
            opacity: 0.6;
        }

        /* Expertise Checkbox - shows E, also purple */
        .skill-item .expertise-check {
            margin-left: -2px;
        }

        .skill-item .expertise-check::after {
            content: 'E';
        }

        .skill-item .expertise-check:checked {
            background: var(--md-primary);
            border-color: var(--md-primary);
            color: var(--md-on-primary);
            opacity: 1;
        }

        .skill-item .expertise-check:disabled {
            opacity: 0.2;
            cursor: not-allowed;
        }

        .skill-item .expertise-check:disabled:hover {
            border-color: var(--md-outline-variant);
            opacity: 0.2;
        }

        .skill-val {
            font-size: 12px;
            font-weight: 600;
            width: 32px;
            text-align: center;
            background: var(--md-surface-container);
            border: none;
            border-radius: 6px;
            color: var(--md-on-surface);
            min-height: 22px;
            padding: 3px 2px;
        }

        .skill-val.skill-computed {
            background: transparent;
            display: inline-block;
            line-height: 22px;
        }

        .skill-val:focus {
            outline: 2px solid var(--md-primary);
        }

        .skill-val::placeholder {
            color: var(--md-on-surface-variant);
            opacity: 0.3;
        }

        .skill-name {
            font-size: 11px;
            color: var(--md-on-surface-variant);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        /* ===== COMBAT SECTION ===== */
        .armor-hp-layout {
            display: grid;
            grid-template-columns: 140px 1fr 1fr 1fr;
            grid-template-rows: 1fr 1fr;
            gap: 12px;
        }

        /* Shield Shape for AC - spans 2 rows */
        .ac-shield {
            grid-row: 1 / 3;
            position: relative;
            background: var(--md-surface-container-high);
            border-radius: 12px 12px 50% 50% / 12px 12px 30% 30%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 16px 12px 28px;
        }

        .ac-shield::before {
            content: '';
            position: absolute;
            inset: 4px;
            border-radius: 10px 10px 50% 50% / 10px 10px 28% 28%;
            border: 2px solid var(--md-outline-variant);
            pointer-events: none;
        }

        .ac-shield-label {
            font-size: 10px;
            font-weight: 700;
            text-transform: uppercase;
            color: var(--md-on-surface-variant);
            letter-spacing: 1px;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 4px;
        }

        .ac-shield-value {
            font-size: 48px;
            font-weight: 700;
            background: transparent;
            border: none;
            width: 90px;
            text-align: center;
            color: var(--md-on-surface);
            line-height: 1;
        }

        .ac-shield-value:focus {
            outline: none;
        }

        .ac-shield-value::placeholder {
            color: var(--md-on-surface-variant);
            opacity: 0.4;
        }

        .ac-shield-sub {
            display: flex;
            align-items: center;
            gap: 6px;
            margin-top: 12px;
            background: var(--md-surface-container);
            padding: 4px 10px;
            border-radius: 20px;
        }

        .ac-shield-sub-label {
            font-size: 9px;
            text-transform: uppercase;
            color: var(--md-on-surface-variant);
            font-weight: 600;
        }

        .ac-shield-sub-input {
            font-size: 16px;
            font-weight: 700;
            background: transparent;
            border: none;
            width: 32px;
            text-align: center;
            color: var(--md-on-surface);
        }

        .ac-shield-sub-input:focus {
            outline: none;
        }

        /* Armor Stat Boxes - fill the grid */
        .armor-stat-box {
            background: var(--md-surface-container-high);
            border-radius: 12px;
            padding: 12px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        .armor-stat-label {
            font-size: 9px;
            font-weight: 600;
            text-transform: uppercase;
            color: var(--md-on-surface-variant);
            margin-bottom: 8px;
            letter-spacing: 0.5px;
        }

        .armor-stat-value {
            font-size: 28px;
            font-weight: 700;
            background: var(--md-surface-container);
            border: none;
            border-radius: 8px;
            width: 100%;
            max-width: 100px;
            text-align: center;
            padding: 8px;
            color: var(--md-on-surface);
        }

        .armor-stat-value:focus {
            outline: 2px solid var(--md-primary);
        }

        .armor-stat-value::placeholder {
            color: var(--md-on-surface-variant);
            opacity: 0.3;
        }

        .armor-stat-row {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
        }

        .armor-stat-input {
            font-size: 20px;
            font-weight: 600;
            background: var(--md-surface-container);
            border: none;
            border-radius: 6px;
            width: 50px;
            text-align: center;
            padding: 8px;
            color: var(--md-on-surface);
        }

        .armor-stat-input:focus {
            outline: 2px solid var(--md-primary);
        }

        .armor-stat-slash {
            color: var(--md-on-surface-variant);
            font-size: 18px;
        }

        /* Death Saves */
        .death-saves-box {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        .death-row-box {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .death-row-box .death-label {
            font-size: 11px;
            font-weight: 600;
            color: var(--md-on-surface-variant);
            width: 14px;
        }

        /* Exhaustion */
        .exhaustion-box {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .exhaustion-input-box {
            font-size: 20px;
            font-weight: 600;
            background: var(--md-surface-container);
            border: none;
            border-radius: 6px;
            width: 50px;
            text-align: center;
            padding: 8px;
            color: var(--md-on-surface);
        }

        .exhaustion-input-box:focus {
            outline: 2px solid var(--md-primary);
        }

        .exhaustion-penalty-box {
            font-size: 18px;
            font-weight: 700;
            color: var(--md-error);
        }

        .armor-stat-hint {
            font-size: 8px;
            color: var(--md-on-surface-variant);
            margin-top: 6px;
            text-transform: uppercase;
        }

        @media (max-width: 800px) {
            .armor-hp-layout {
                grid-template-columns: 120px 1fr 1fr;
                grid-template-rows: auto auto auto;
            }
            
            .ac-shield {
                grid-row: 1 / 3;
            }
        }

        @media (max-width: 550px) {
            .armor-hp-layout {
                grid-template-columns: 1fr 1fr;
                grid-template-rows: auto;
                gap: 10px;
            }
            
            .ac-shield {
                grid-column: 1 / 3;
                grid-row: auto;
                max-width: 140px;
                margin: 0 auto;
                padding: 12px 10px 20px;
            }
            
            .ac-shield-value {
                font-size: 36px;
            }
        }

        .defenses-row {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 12px;
            margin-top: 16px;
            width: 100%;
        }

        @media (max-width: 600px) {
            .defenses-row {
                grid-template-columns: 1fr;
            }
        }

        .defense-item {
            background: var(--md-surface-container-high);
            border-radius: 10px;
            padding: 12px;
        }

        .defense-item input {
            width: 100%;
            box-sizing: border-box;
            background: var(--md-surface-container);
            border: none;
            border-radius: 8px;
            padding: 10px 12px;
            font-size: 14px;
            color: var(--md-on-surface);
            margin-top: 6px;
        }

        .defense-item input:focus {
            outline: 2px solid var(--md-primary);
        }

        .defense-item input::placeholder {
            color: var(--md-on-surface-variant);
            opacity: 0.3;
        }

        .defense-label {
            font-size: 10px;
            text-transform: uppercase;
            color: var(--md-on-surface-variant);
            font-weight: 600;
            margin-bottom: 6px;
        }

        .ac-block {
            background: var(--md-surface-container-high);
            border-radius: 12px;
            padding: 16px;
            text-align: center;
        }

        .ac-main {
            margin-bottom: 12px;
        }

        .ac-value {
            font-size: 36px;
            font-weight: 700;
            background: var(--md-surface-container);
            border: none;
            border-radius: 10px;
            color: var(--md-on-surface);
            width: 80px;
            text-align: center;
            padding: 8px;
        }

        .ac-value:focus {
            outline: 2px solid var(--md-primary);
        }

        .ac-value::placeholder {
            color: var(--md-on-surface-variant);
            opacity: 0.3;
        }

        .ac-label {
            font-size: 10px;
            text-transform: uppercase;
            color: var(--md-on-surface-variant);
            font-weight: 600;
            margin-top: 8px;
        }

        .shield-row {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            padding-top: 12px;
        }

        .shield-input {
            width: 40px;
            font-size: 16px;
            font-weight: 600;
            text-align: center;
            background: var(--md-surface-container);
            border: none;
            border-radius: 6px;
            padding: 6px;
            color: var(--md-on-surface);
        }

        .shield-input:focus {
            outline: 2px solid var(--md-primary);
        }

        .hp-block {
            background: var(--md-surface-container-high);
            border-radius: 12px;
            padding: 16px;
        }

        .hp-row {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 12px;
        }

        .hp-item {
            text-align: center;
        }

        .hp-input {
            font-size: 24px;
            font-weight: 700;
            background: var(--md-surface-container);
            border: none;
            border-radius: 8px;
            width: 100%;
            text-align: center;
            padding: 10px;
            color: var(--md-on-surface);
        }

        .hp-input:focus {
            outline: 2px solid var(--md-primary);
        }

        .hp-input::placeholder {
            color: var(--md-on-surface-variant);
            opacity: 0.3;
        }

        .hp-label {
            font-size: 10px;
            text-transform: uppercase;
            color: var(--md-on-surface-variant);
            font-weight: 600;
            margin-top: 6px;
        }

        .dice-death-block {
            background: var(--md-surface-container-high);
            border-radius: 12px;
            padding: 12px;
        }

        .dice-section {
            margin-bottom: 12px;
        }

        .mini-label {
            font-size: 11px;
            text-transform: uppercase;
            color: var(--md-on-surface-variant);
            font-weight: 600;
            margin-bottom: 8px;
        }

        .dice-inputs {
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .dice-inputs span {
            color: var(--md-on-surface-variant);
            font-size: 14px;
        }

        .dice-input {
            width: 40px;
            height: 32px;
            background: var(--md-surface-container);
            border: none;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 600;
            text-align: center;
            color: var(--md-on-surface);
        }

        .dice-input:focus {
            outline: 2px solid var(--md-primary);
        }

        .dice-input::placeholder {
            color: var(--md-on-surface-variant);
            opacity: 0.3;
        }

        .death-section {
            padding-top: 14px;
            
        }

        .death-row {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 8px;
        }

        .death-label {
            font-size: 11px;
            color: var(--md-on-surface-variant);
        }

        .death-pips {
            display: flex;
            gap: 4px;
        }

        .death-pip {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            border: 2px solid var(--md-outline-variant);
            background: transparent;
            cursor: pointer;
            transition: all 0.15s;
        }

        .death-pip:hover,
        .death-pip:active {
            border-color: var(--md-primary);
            transform: scale(1.1);
        }

        .death-pip.success.active {
            background: #4caf50;
            border-color: #4caf50;
        }

        .death-pip.fail.active {
            background: #f44336;
            border-color: #f44336;
        }

        .exhaustion-section {
            padding-top: 14px;
            
            margin-top: 8px;
        }

        .exhaustion-row {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .exhaustion-input {
            width: 50px;
            height: 36px;
            background: var(--md-surface-container);
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 700;
            text-align: center;
            color: var(--md-on-surface);
        }

        .exhaustion-input:focus {
            outline: 2px solid var(--md-primary);
        }

        .exhaustion-penalty {
            font-size: 18px;
            font-weight: 700;
            color: var(--md-error);
            min-width: 40px;
        }

        .exhaustion-hint {
            font-size: 9px;
            color: var(--md-on-surface-variant);
            margin-top: 4px;
        }

        /* ===== WEAPONS TABLE ===== */
        .weapons-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .weapon-row {
            display: grid;
            grid-template-columns: 2fr 80px 1fr 1fr 40px;
            gap: 10px;
            align-items: center;
        }

        @media (max-width: 600px) {
            .weapon-row {
                grid-template-columns: 1fr 1fr;
            }
            .weapon-row > *:nth-child(5) {
                grid-column: 2;
                justify-self: end;
            }
        }

        .weapon-input {
            background: var(--md-surface-container-high);
            border: none;
            border-radius: 8px;
            padding: 10px 12px;
            font-size: 13px;
            color: var(--md-on-surface);
        }

        .weapon-input:focus {
            outline: 2px solid var(--md-primary);
        }

        .weapon-delete {
            width: 44px;
            height: 44px;
            border-radius: 8px;
            background: transparent;
            border: none;
            color: var(--md-error);
            cursor: pointer;
            font-size: 20px;
            opacity: 0.3;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .weapon-delete:hover,
        .weapon-delete:active {
            opacity: 1;
            background: var(--md-error-container);
        }

        /* ===== CLASS RESOURCES ===== */
        .resources-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .resource-row {
            display: flex;
            align-items: center;
            gap: 10px;
            background: var(--md-surface-container-high);
            border-radius: 10px;
            padding: 10px 12px;
        }

        .resource-name {
            flex: 1;
            min-width: 100px;
            background: transparent;
            border: none;
            color: var(--md-on-surface);
            font-size: 14px;
            font-weight: 500;
        }

        .resource-name::placeholder {
            color: var(--md-on-surface-variant);
            opacity: 0.3;
        }

        .resource-name:focus {
            outline: none;
        }

        .resource-tracker {
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .resource-input {
            width: 40px;
            height: 32px;
            background: var(--md-surface-container);
            border: none;
            border-radius: 6px;
            text-align: center;
            font-size: 14px;
            font-weight: 600;
            color: var(--md-on-surface);
        }

        .resource-input:focus {
            outline: 2px solid var(--md-primary);
        }

        .resource-slash {
            color: var(--md-on-surface-variant);
            font-size: 14px;
        }

        .resource-delete {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            border: none;
            background: transparent;
            color: var(--md-error);
            cursor: pointer;
            opacity: 0.3;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .resource-delete:hover {
            opacity: 1;
            background: var(--md-error-container);
        }

        .add-btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
            padding: 10px 16px;
            min-height: 40px;
            background: var(--md-surface-container);
            border: 1px solid var(--md-outline-variant);
            border-radius: 8px;
            color: var(--md-on-surface-variant);
            cursor: pointer;
            font-size: 13px;
            font-weight: 500;
            margin-top: 8px;
            transition: all 0.2s;
        }

        .add-btn svg {
            width: 16px;
            height: 16px;
            flex-shrink: 0;
        }

        .add-btn:hover {
            border-color: var(--md-primary);
            color: var(--md-primary);
            background: var(--md-surface-container-high);
        }

        .add-btn:active {
            transform: scale(0.98);
        }

        /* Dashed variant for "Add Custom" buttons */
        .add-btn.dashed {
            border-style: dashed;
            border-width: 2px;
            background: transparent;
        }

        /* Compact variant - smaller, less prominent */
        .add-btn.compact {
            flex: 0 0 auto;
            min-width: auto;
            padding: 8px 12px;
            font-size: 12px;
        }

        /* ===== LARGE TEXT AREAS ===== */
        .text-area {
            width: 100%;
            min-height: 120px;
            background: var(--md-surface-container-high);
            border: none;
            border-radius: 10px;
            padding: 14px;
            font-size: 13px;
            color: var(--md-on-surface);
            resize: vertical;
            font-family: inherit;
            line-height: 1.6;
            box-sizing: border-box;
        }

        .text-area:focus {
            outline: 2px solid var(--md-primary);
            outline-offset: -2px;
        }

        .text-area::placeholder {
            color: var(--md-on-surface-variant);
            opacity: 0.3;
        }

        /* ===== TRAINING CHECKBOXES ===== */
        .training-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px;
        }

        @media (max-width: 500px) {
            .training-grid {
                grid-template-columns: 1fr;
            }
        }

        .training-group {
            background: var(--md-surface-container-high);
            border-radius: 10px;
            padding: 14px;
        }

        .training-label {
            font-size: 11px;
            text-transform: uppercase;
            color: var(--md-on-surface-variant);
            font-weight: 600;
            margin-bottom: 10px;
        }

        .training-checks {
            display: flex;
            flex-wrap: wrap;
            gap: 12px;
        }

        .training-item {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 13px;
            color: var(--md-on-surface);
            cursor: pointer;
        }

        .training-item input {
            width: 20px;
            height: 20px;
            cursor: pointer;
            /* Custom checkbox styling */
            appearance: none;
            -webkit-appearance: none;
            background: var(--md-surface-container);
            border: 2px solid var(--md-outline-variant);
            border-radius: 4px;
            flex-shrink: 0;
        }

        .training-item input:checked {
            background: var(--md-primary);
            border-color: var(--md-primary);
        }

        .training-item input:checked::after {
            content: '✓';
            color: var(--md-on-primary);
            font-size: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .training-item input:hover {
            border-color: var(--md-primary);
        }

        /* ===== SPELLCASTING ===== */
        .spell-stats {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 10px;
            margin-bottom: 16px;
        }

        @media (max-width: 600px) {
            .spell-stats {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        .spell-stat {
            background: var(--md-surface-container-high);
            border-radius: 10px;
            padding: 12px;
            text-align: center;
        }

        .spell-stat-label {
            font-size: 9px;
            text-transform: uppercase;
            color: var(--md-on-surface-variant);
            font-weight: 600;
            margin-bottom: 6px;
        }

        .spell-stat-select {
            font-size: 16px;
            font-weight: 700;
            background: var(--md-surface-container);
            border: none;
            border-radius: 6px;
            color: var(--md-on-surface);
            padding: 8px 12px;
            text-align: center;
            cursor: pointer;
        }

        .spell-stat-select:focus {
            outline: 2px solid var(--md-primary);
        }

        .spell-stat-value {
            font-size: 22px;
            font-weight: 700;
            color: var(--md-on-surface);
            display: block;
        }

        .spell-stat-input {
            font-size: 18px;
            font-weight: 700;
            background: transparent;
            border: none;
            color: var(--md-on-surface);
            width: 100%;
            text-align: center;
        }

        .spell-stat-input:focus {
            outline: none;
        }

        .spell-stat-input::placeholder {
            color: var(--md-on-surface-variant);
            opacity: 0.3;
        }

        .pact-slots-section {
            background: var(--md-surface-container-high);
            border-radius: 10px;
            padding: 12px 14px;
            margin-bottom: 16px;
            transition: opacity 0.3s;
        }

        .pact-slots-section.dimmed {
            opacity: 0.35;
        }

        .pact-slots-row {
            display: flex;
            gap: 12px;
            margin-top: 8px;
        }

        .pact-slot-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
        }

        .pact-label {
            font-size: 10px;
            text-transform: uppercase;
            color: var(--md-on-surface-variant);
        }

        .pact-input {
            width: 50px;
            height: 36px;
            background: var(--md-surface-container);
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            text-align: center;
            color: var(--md-on-surface);
        }

        .pact-input:focus {
            outline: 2px solid var(--md-primary);
        }

        .pact-hint {
            font-size: 9px;
            color: var(--md-on-surface-variant);
            margin-top: 6px;
        }

        .slots-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            margin-bottom: 16px;
        }

        @media (max-width: 600px) {
            .slots-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        .slot-card {
            background: var(--md-surface-container-high);
            border-radius: 10px;
            padding: 12px;
            transition: opacity 0.2s;
        }

        .slot-card.slot-empty {
            opacity: 0.4;
        }

        .slot-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .slot-level {
            font-size: 13px;
            font-weight: 700;
            color: var(--md-on-surface);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .slot-total-edit {
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .slot-total-label {
            font-size: 10px;
            color: var(--md-on-surface-variant);
            text-transform: uppercase;
        }

        .slot-total-input {
            width: 36px;
            height: 26px;
            background: var(--md-surface-container);
            border: 1px solid var(--md-outline-variant);
            border-radius: 6px;
            padding: 4px;
            text-align: center;
            font-size: 13px;
            font-weight: 600;
            color: var(--md-on-surface);
        }

        .slot-total-input:focus {
            outline: none;
            border-color: var(--md-primary);
            box-shadow: 0 0 0 2px color-mix(in srgb, var(--md-primary) 30%, transparent);
        }

        .slot-pips {
            display: flex;
            gap: 6px;
            flex-wrap: wrap;
            min-height: 32px;
        }

        .slot-pip {
            width: 28px;
            height: 28px;
            border-radius: 50%;
            border: 2px solid var(--md-outline-variant);
            background: transparent;
            cursor: pointer;
            transition: all 0.15s;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 4px;
        }

        .slot-pip svg {
            width: 100%;
            height: 100%;
        }

        .slot-pip:hover {
            transform: scale(1.1);
            border-color: var(--md-primary);
        }

        .slot-pip.available {
            border-color: var(--md-primary);
            color: var(--md-primary);
        }

        .slot-pip.available:hover {
            background: color-mix(in srgb, var(--md-primary) 15%, transparent);
        }

        .slot-pip.expended {
            border-color: var(--md-outline);
            background: var(--md-surface-container);
            color: var(--md-outline);
        }

        .slot-pip.expended:hover {
            border-color: var(--md-primary);
            color: var(--md-primary);
        }

        .slot-status {
            margin-top: 8px;
            font-size: 11px;
            color: var(--md-on-surface-variant);
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .slot-available {
            font-weight: 700;
            color: var(--md-primary);
            font-size: 14px;
        }

        .slot-max {
            font-weight: 600;
            color: var(--md-on-surface);
        }

        .slot-avail-label {
            margin-left: 4px;
            font-size: 10px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .slot-restore-btn {
            background: transparent;
            border: none;
            color: var(--md-primary);
            cursor: pointer;
            padding: 4px;
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.15s;
        }

        .slot-restore-btn:hover {
            background: color-mix(in srgb, var(--md-primary) 15%, transparent);
        }

        .slot-restore-btn:active {
            transform: scale(0.95);
        }

        /* Legacy compatibility */
        .slot-counts {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 12px;
            color: var(--md-on-surface-variant);
        }

        .slot-num {
            width: 44px;
            height: 32px;
            background: var(--md-surface-container);
            border: none;
            border-radius: 6px;
            padding: 6px 8px;
            text-align: center;
            font-size: 14px;
            font-weight: 600;
            color: var(--md-on-surface);
        }

        .slot-num:focus {
            outline: none;
            border-color: var(--md-primary);
            box-shadow: 0 0 0 2px color-mix(in srgb, var(--md-primary) 30%, transparent);
        }

        /* Spells Table */
        .spells-list,
        .cantrips-list {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        /* Cantrips Section */
        .cantrips-section {
            margin-bottom: 20px;
            padding: 12px;
            background: var(--md-surface-container);
            border-radius: 12px;
        }

        .at-will-badge {
            display: inline-flex;
            align-items: center;
            padding: 2px 8px;
            background: var(--md-tertiary);
            color: var(--md-on-tertiary);
            border-radius: 10px;
            font-size: 10px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .spell-level-hint {
            font-size: 11px;
            font-weight: 400;
            color: var(--md-on-surface-variant);
            opacity: 0.7;
        }

        /* Cantrip Row - simplified version */
        .cantrip-row {
            display: grid;
            grid-template-columns: 28px minmax(150px, 1fr) 72px 58px 72px minmax(100px, 150px) 70px 32px;
            gap: 8px;
            align-items: center;
            background: var(--md-surface-container-high);
            border-radius: 8px;
            padding: 6px 10px;
            min-height: 38px;
        }

        @media (max-width: 900px) {
            .cantrip-row {
                grid-template-columns: 24px 1fr 1fr 28px;
                grid-template-rows: auto auto;
                gap: 6px;
                padding: 8px;
            }
            .cantrip-row .spell-school-icon { grid-column: 1; grid-row: 1; }
            .cantrip-row .spell-name-display { grid-column: 2 / 4; grid-row: 1; }
            .cantrip-row .spell-delete-btn { grid-column: 4; grid-row: 1; }
            .cantrip-row .spell-time-badge { grid-column: 1 / 2; grid-row: 2; }
            .cantrip-row .spell-components { grid-column: 2; grid-row: 2; }
            .cantrip-row .spell-effect-summary { grid-column: 3 / 5; grid-row: 2; }
        }

        .spell-row {
            display: grid;
            grid-template-columns: 36px 28px minmax(180px, 1fr) 72px 58px 72px minmax(140px, 180px) 90px 32px;
            gap: 8px;
            align-items: center;
            background: var(--md-surface-container-high);
            border-radius: 10px;
            padding: 8px 12px;
            min-height: 44px;
        }

        @media (max-width: 1200px) {
            .spell-row {
                grid-template-columns: 32px 24px minmax(140px, 1fr) 64px 52px 64px minmax(100px, 140px) 80px 28px;
                gap: 6px;
                padding: 6px 10px;
            }
        }

        @media (max-width: 900px) {
            .spell-row {
                display: grid;
                grid-template-columns: 32px 24px 1fr 28px;
                grid-template-rows: auto auto auto;
                gap: 6px;
                padding: 10px;
            }
            .spell-row .spell-level-badge { grid-column: 1; grid-row: 1; }
            .spell-row .spell-school-icon { grid-column: 2; grid-row: 1; }
            .spell-row .spell-name-display { grid-column: 3; grid-row: 1; }
            .spell-row .spell-delete-btn { grid-column: 4; grid-row: 1; }
            .spell-row .spell-time-badge { grid-column: 1 / 2; grid-row: 2; }
            .spell-row .spell-components { grid-column: 2; grid-row: 2; }
            .spell-row .spell-category { grid-column: 3; grid-row: 2; justify-self: start; }
            .spell-row .spell-effect-summary { grid-column: 1 / 4; grid-row: 3; }
            .spell-row .spell-flags { grid-column: 4; grid-row: 2 / 4; align-self: center; flex-direction: column; }
        }

        /* Spell Level Badge */
        .spell-level-badge {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 32px;
            height: 32px;
            background: var(--md-primary);
            color: var(--md-on-primary);
            border-radius: 6px;
            font-size: 13px;
            font-weight: 700;
            flex-shrink: 0;
        }

        .spell-level-badge.cantrip {
            background: var(--md-tertiary);
            color: var(--md-on-tertiary);
        }

        /* Spell School Icon */
        .spell-school-icon {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 24px;
            height: 24px;
            flex-shrink: 0;
        }

        .spell-school-icon svg {
            width: 20px;
            height: 20px;
        }

        /* Spell Name */
        .spell-name-display {
            font-size: 13px;
            font-weight: 600;
            color: var(--md-on-surface);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            cursor: pointer;
            padding: 4px 6px;
            border-radius: 4px;
            transition: background 0.15s;
        }

        .spell-name-display:hover {
            background: var(--md-surface-container);
        }

        /* Casting Time Badge */
        .spell-time-badge {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            padding: 4px 8px;
            background: var(--md-surface-container);
            border-radius: 6px;
            font-size: 10px;
            font-weight: 600;
            color: var(--md-on-surface-variant);
            white-space: nowrap;
            width: 100%;
            box-sizing: border-box;
        }

        .spell-time-badge.action { background: #2e7d32; color: #fff; }
        .spell-time-badge.bonus { background: #f57c00; color: #fff; }
        .spell-time-badge.reaction { background: #7b1fa2; color: #fff; }
        .spell-time-badge.ritual { background: #1565c0; color: #fff; }

        /* Components Display */
        .spell-components {
            display: flex;
            gap: 2px;
            align-items: center;
            justify-content: center;
        }

        .spell-comp {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 18px;
            height: 18px;
            background: var(--md-surface-container);
            border-radius: 4px;
            font-size: 10px;
            font-weight: 700;
            color: var(--md-on-surface-variant);
            opacity: 0.4;
        }

        .spell-comp.active {
            background: var(--md-secondary-container);
            color: var(--md-on-secondary-container);
            opacity: 1;
        }

        /* Effect Category */
        .spell-category {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            padding: 4px 10px;
            background: var(--md-tertiary-container);
            color: var(--md-on-tertiary-container);
            border-radius: 10px;
            font-size: 9px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.3px;
            white-space: nowrap;
            width: 100%;
            box-sizing: border-box;
        }

        .spell-category.damage { background: #c62828; color: #fff; }
        .spell-category.control { background: #6a1b9a; color: #fff; }
        .spell-category.buff { background: #2e7d32; color: #fff; }
        .spell-category.debuff { background: #d84315; color: #fff; }
        .spell-category.utility { background: #0277bd; color: #fff; }
        .spell-category.healing { background: #00897b; color: #fff; }
        .spell-category.summon { background: #5d4037; color: #fff; }
        .spell-category.teleport { background: #4527a0; color: #fff; }

        /* Effect Summary */
        .spell-effect-summary {
            font-size: 11px;
            color: var(--md-on-surface-variant);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            padding: 4px 8px;
            background: var(--md-surface-container);
            border-radius: 4px;
        }

        /* Mechanical Flags */
        .spell-flags {
            display: flex;
            gap: 4px;
            align-items: center;
            justify-content: flex-end;
            flex-wrap: nowrap;
        }

        .spell-flag {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 24px;
            height: 24px;
            background: var(--md-surface-container);
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.15s;
            flex-shrink: 0;
        }

        .spell-flag:hover {
            background: var(--md-surface-container-highest);
        }

        .spell-flag.active {
            background: var(--md-primary);
            color: var(--md-on-primary);
        }

        .spell-flag.conc-active {
            background: #e65100;
            color: #fff;
            animation: pulse-conc 2s infinite;
        }

        .spell-flag svg {
            width: 14px;
            height: 14px;
        }

        /* Delete Button */
        .spell-delete-btn {
            width: 28px;
            height: 28px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: transparent;
            border: none;
            border-radius: 6px;
            color: var(--md-on-surface-variant);
            cursor: pointer;
            font-size: 16px;
            opacity: 0.5;
            transition: all 0.15s;
            flex-shrink: 0;
        }

        .spell-delete-btn:hover {
            background: var(--md-error-container);
            color: var(--md-on-error-container);
            opacity: 1;
        }

        .spell-cast-toast {
            position: fixed;
            bottom: 80px;
            left: 50%;
            transform: translateX(-50%) translateY(20px);
            background: linear-gradient(135deg, var(--md-primary), var(--md-tertiary));
            color: #fff;
            padding: 12px 24px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 14px;
            font-weight: 500;
            z-index: 9999;
            opacity: 0;
            transition: all 0.3s ease;
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
        }

        .spell-cast-toast.active {
            opacity: 1;
            transform: translateX(-50%) translateY(0);
        }

        .spell-cast-icon {
            font-size: 20px;
        }

        .spell-cast-level {
            opacity: 0.8;
            font-size: 12px;
        }

        .spell-input {
            background: var(--md-surface-container);
            border: none;
            border-radius: 6px;
            padding: 8px 10px;
            font-size: 12px;
            color: var(--md-on-surface);
            min-width: 0; /* Prevent overflow */
        }

        .spell-input:focus {
            outline: 2px solid var(--md-primary);
        }

        .spell-time-select {
            cursor: pointer;
        }

        .spell-time-select option {
            background: var(--md-surface-container);
            color: var(--md-on-surface);
        }

        /* Legacy spell-check (kept for compatibility) */
        .spell-check {
            display: none;
        }

        .spell-input {
            background: var(--md-surface-container);
            border: none;
            border-radius: 6px;
            padding: 8px 10px;
            font-size: 12px;
            color: var(--md-on-surface);
            min-width: 0;
        }

        .spell-input:focus {
            outline: 2px solid var(--md-primary);
        }

        /* ===== NARRATIVE / EQUIPMENT ===== */
        .narrative-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px;
            align-items: start;
        }

        .narrative-grid > div,
        .equip-col {
            display: flex;
            flex-direction: column;
            gap: 14px;
        }

        .physical-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 8px;
            background: var(--md-surface-container-high);
            border-radius: 10px;
            padding: 12px;
            box-sizing: border-box;
        }

        @media (max-width: 500px) {
            .physical-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        .phys-input {
            background: var(--md-surface-container);
            border: none;
            border-radius: 8px;
            padding: 10px 12px;
            font-size: 13px;
            color: var(--md-on-surface);
            box-sizing: border-box;
        }

        .phys-input.phys-dimmed {
            opacity: 0.5;
        }

        .phys-input.phys-dimmed:focus {
            opacity: 1;
        }

        .phys-input::placeholder {
            color: var(--md-on-surface-variant);
            opacity: 0.3;
        }

        .phys-input:focus {
            outline: 2px solid var(--md-primary);
            outline-offset: -2px;
        }

        .equip-area {
            min-height: 150px;
            height: 150px;
            white-space: pre-wrap;
            line-height: 1.8;
        }

        @media (max-width: 600px) {
            .narrative-grid {
                grid-template-columns: 1fr;
            }
        }

        .coins-row {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
            margin-bottom: 20px;
            align-items: center;
        }

        .coin {
            display: flex;
            align-items: center;
            gap: 8px;
            background: var(--md-surface-container-high);
            padding: 10px 14px;
            border-radius: 12px;
        }

        /* GP hervorgehoben */
        .coin.coin-primary {
            background: var(--md-surface-container-highest);
            padding: 12px 16px;
        }

        .coin.coin-primary .coin-input {
            width: 70px;
            height: 40px;
            font-size: 16px;
        }

        .coin-label {
            font-size: 12px;
            font-weight: 700;
            color: var(--md-on-surface-variant);
        }

        /* Coin Colors */
        .coin-cp .coin-label { color: #B87333; }
        .coin-sp .coin-label { color: #C0C0C0; }
        .coin-ep .coin-label { color: #B8B08D; }
        .coin-gp .coin-label { color: #e2c984; font-size: 14px; }
        .coin-pp .coin-label { color: #C9CED6; }

        .coin-input {
            width: 60px;
            height: 36px;
            background: var(--md-surface-container);
            border: none;
            border-radius: 8px;
            padding: 8px;
            font-size: 14px;
            font-weight: 600;
            color: var(--md-on-surface);
            text-align: center;
        }

        .coin-input:focus {
            outline: 2px solid var(--md-primary);
        }

        .coin-input::placeholder {
            color: var(--md-on-surface-variant);
            opacity: 0.3;
        }

        .field-group {
            margin-bottom: 14px;
        }

        .field-label {
            font-size: 11px;
            text-transform: uppercase;
            color: var(--md-on-surface-variant);
            font-weight: 600;
            margin-bottom: 6px;
        }

        .field-input {
            width: 100%;
            background: var(--md-surface-container-high);
            border: none;
            border-radius: 8px;
            padding: 10px 12px;
            font-size: 13px;
            color: var(--md-on-surface);
            box-sizing: border-box;
        }

        .field-input:focus {
            outline: 2px solid var(--md-primary);
            outline-offset: -2px;
        }

        .field-input::placeholder {
            color: var(--md-on-surface-variant);
            opacity: 0.3;
        }

        /* Magic Item Attunement */
        .attunement-slots {
            display: flex;
            gap: 10px;
            margin-top: 8px;
            background: var(--md-surface-container-high);
            border-radius: 10px;
            padding: 12px;
            min-height: 60px;
            align-items: center;
            box-sizing: border-box;
        }

        .attunement-slot {
            width: 36px;
            height: 36px;
            min-width: 36px;
            min-height: 36px;
            border-radius: 8px;
            border: 2px solid #666;
            background: #2a2a2a;
            cursor: pointer;
            transition: all 0.15s;
            display: inline-block;
            flex-shrink: 0;
        }

        .attunement-slot:hover,
        .attunement-slot:active {
            border-color: var(--md-primary);
            transform: scale(1.05);
        }

        .attunement-slot.active {
            background: var(--md-tertiary);
            border-color: var(--md-tertiary);
        }

        /* ===== QUICK REFERENCE ===== */
        .reference-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 16px;
        }

        @media (max-width: 600px) {
            .reference-grid {
                grid-template-columns: 1fr;
            }
        }

        .ref-card {
            background: var(--md-surface-container-high);
            border-radius: 12px;
            padding: 16px;
        }

        .ref-title {
            font-size: 12px;
            font-weight: 600;
            color: var(--md-primary);
            margin-bottom: 6px;
            text-transform: uppercase;
            letter-spacing: 0.3px;
        }

        .ref-formula {
            font-size: 14px;
            font-weight: 500;
            color: var(--md-on-surface);
            margin-bottom: 10px;
            padding: 6px 10px;
            background: var(--md-surface-container);
            border-radius: 6px;
            display: inline-block;
        }

        .ref-table {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
        }

        .ref-table span {
            font-size: 11px;
            color: var(--md-on-surface-variant);
            background: var(--md-surface-container);
            padding: 4px 8px;
            border-radius: 4px;
        }

        .ref-list {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .ref-list div {
            font-size: 12px;
            color: var(--md-on-surface-variant);
        }

        .ref-label {
            font-weight: 600;
            color: var(--md-on-surface);
        }

        /* ===== MANAGE SECTION ===== */
        .manage-btns {
            display: flex;
            flex-wrap: wrap;
            gap: 16px;
        }

        .manage-btn {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 14px 24px;
            min-height: 48px;
            background: var(--md-primary);
            color: var(--md-on-primary);
            border: none;
            border-radius: 12px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }

        .manage-btn:hover,
        .manage-btn:active {
            background: #7c70a0;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.3);
        }

        .manage-btn svg {
            width: 20px;
            height: 20px;
        }

        .manage-btn.danger {
            background: #d32f2f;
            color: white;
        }

        .manage-btn.danger:hover,
        .manage-btn.danger:active {
            background: #b71c1c;
        }

        @media (max-width: 600px) {
            .manage-btns {
                gap: 8px;
            }
            .manage-btn {
                flex: 1 1 calc(50% - 8px);
                min-width: 140px;
                justify-content: center;
                padding: 12px 16px;
            }
        }

        /* ===== RULES NOTICE ===== */
        .rules-notice {
            background: var(--md-surface-container);
            border: none;
            border-radius: 12px;
            padding: 16px 20px;
        }

        .rules-notice p {
            font-size: 13px;
            line-height: 1.6;
            color: var(--md-on-surface-variant);
            margin: 0 0 12px 0;
        }

        .rules-notice p:last-child {
            margin-bottom: 0;
        }

        .rules-notice a {
            color: var(--md-primary);
            text-decoration: none;
        }

        .rules-notice a:hover {
            text-decoration: underline;
        }

        /* ===== CROP MODAL ===== */
        .crop-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.9);
            z-index: 10000;
            display: none;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .crop-overlay.active {
            display: flex;
        }

        .crop-modal {
            background: var(--md-surface-container);
            border-radius: 16px;
            max-width: 450px;
            width: 100%;
            overflow: hidden;
        }

        .crop-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px 20px;
            
        }

        .crop-title {
            font-weight: 600;
            font-size: 16px;
        }

        .crop-close {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: transparent;
            border: none;
            color: var(--md-on-surface-variant);
            font-size: 20px;
            cursor: pointer;
        }

        .crop-body {
            padding: 16px;
            max-height: 50vh;
            overflow: hidden;
        }

        .crop-body img {
            max-width: 100%;
        }

        .crop-footer {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            padding: 16px 20px;
            
        }

        .crop-btn {
            padding: 10px 20px;
            border-radius: 8px;
            font-size: 14px;
            cursor: pointer;
        }

        .crop-btn-cancel {
            background: var(--md-surface-container-high);
            border: none;
            color: var(--md-on-surface);
        }

        .crop-btn-ok {
            background: var(--md-primary);
            border: none;
            color: var(--md-on-primary);
        }

        /* GM Player Bar - nicht fixed, scrollt mit */
        .player-bar {
            background: var(--md-surface-container);
            border-radius: 16px;
            padding: 12px 20px;
            margin-bottom: 24px;
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
            box-shadow: 0 1px 3px rgba(0,0,0,0.2);
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .gm-banner {
            background: color-mix(in srgb, var(--md-primary) 10%, var(--md-surface-container));
            border: 1px solid var(--md-primary);
            border-radius: 12px;
            padding: 12px 20px;
            margin-bottom: 24px;
            font-size: 13px;
            color: var(--md-on-surface);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .gm-banner svg {
            width: 18px;
            height: 18px;
            color: var(--md-primary);
        }

        @media (max-width: 600px) {
            .player-bar {
                padding: 8px 12px;
            }
        }

        .player-bar-label {
            font-size: 12px;
            color: var(--md-on-surface-variant);
            font-weight: 500;
            white-space: nowrap;
        }

        .player-tab {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 8px 14px;
            background: var(--md-surface-container-high);
            border: 2px solid transparent;
            border-radius: 100px;
            font-size: 13px;
            font-weight: 500;
            color: var(--md-on-surface);
            cursor: pointer;
            white-space: nowrap;
            transition: all 0.2s;
        }

        .player-tab:hover {
            background: var(--md-surface-container-highest);
        }

        .player-tab.active {
            border-color: var(--md-primary);
            background: color-mix(in srgb, var(--md-primary) 15%, var(--md-surface-container));
        }

        .player-tab.own {
            font-style: italic;
        }

        .player-tab-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            flex-shrink: 0;
        }

        @media print {
            body { background: white !important; color: black !important; }
            .nav-container, .fly-btn-container, .player-bar, .gm-banner, .section:last-child { display: none !important; }
            .section.collapsed .section-content { display: block !important; }
        }

        /* ===== TOOLTIP SYSTEM ===== */
        .help-icon {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 14px;
            height: 14px;
            border-radius: 50%;
            background: var(--md-surface-container-highest);
            color: var(--md-on-surface-variant);
            font-size: 9px;
            font-weight: 700;
            cursor: help;
            margin-left: 4px;
            transition: all 0.2s ease;
            vertical-align: middle;
            flex-shrink: 0;
            opacity: 0.6;
        }
        .help-icon:hover {
            background: var(--md-primary);
            color: var(--md-on-primary);
            opacity: 1;
        }
        
        /* Hide help icons when disabled */
        body.hide-help-icons .help-icon {
            display: none !important;
        }
        
        .tooltip-popup {
            position: fixed;
            z-index: 9999;
            background: var(--md-surface-container-high);
            border: 1px solid var(--md-outline-variant);
            border-radius: 12px;
            padding: 14px 16px;
            max-width: 320px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.4);
            opacity: 0;
            visibility: hidden;
            transform: translateY(8px);
            transition: all 0.2s ease;
        }
        .tooltip-popup.visible {
            opacity: 1;
            visibility: visible;
            transform: translateY(0);
        }
        .tooltip-popup h4 {
            font-size: 13px;
            font-weight: 700;
            color: var(--md-primary);
            margin-bottom: 8px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        .tooltip-popup p {
            font-size: 13px;
            line-height: 1.5;
            color: var(--md-on-surface);
            margin: 0;
        }
        .tooltip-popup .tip-example {
            margin-top: 10px;
            padding: 10px;
            background: var(--md-surface-container);
            border-radius: 8px;
            font-size: 12px;
            color: var(--md-on-surface-variant);
        }
        .tooltip-popup .tip-example strong {
            color: var(--md-primary);
        }

        /* ===== CHARACTER WIZARD ===== */
        .wizard-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.85);
            z-index: 10001;
            display: none;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }
        .wizard-overlay.active {
            display: flex;
        }
        .wizard-modal {
            background: var(--md-surface-container);
            border-radius: 20px;
            max-width: 600px;
            width: 100%;
            max-height: 85vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }
        .wizard-header {
            padding: 24px 28px 20px;
            border-bottom: 1px solid var(--md-outline-variant);
        }
        .wizard-header h2 {
            font-size: 22px;
            font-weight: 700;
            margin-bottom: 8px;
        }
        .wizard-progress {
            display: flex;
            gap: 8px;
        }
        .wizard-progress-step {
            flex: 1;
            height: 4px;
            border-radius: 2px;
            background: var(--md-surface-container-highest);
            transition: background 0.3s ease;
        }
        .wizard-progress-step.done {
            background: var(--md-primary);
        }
        .wizard-progress-step.active {
            background: linear-gradient(90deg, var(--md-primary), var(--md-surface-container-highest));
        }
        .wizard-body {
            flex: 1;
            overflow-y: auto;
            padding: 24px 28px;
        }
        .wizard-step {
            display: none;
        }
        .wizard-step.active {
            display: block;
            animation: fadeIn 0.3s ease;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateX(20px); }
            to { opacity: 1; transform: translateX(0); }
        }
        .wizard-step h3 {
            font-size: 18px;
            margin-bottom: 8px;
        }
        .wizard-step p {
            color: var(--md-on-surface-variant);
            margin-bottom: 20px;
            line-height: 1.5;
        }
        .wizard-options {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
            gap: 12px;
        }
        .wizard-option {
            background: var(--md-surface-container-high);
            border: 2px solid transparent;
            border-radius: 12px;
            padding: 16px;
            cursor: pointer;
            transition: all 0.2s ease;
            text-align: center;
        }
        .wizard-option:hover {
            border-color: var(--md-outline);
            transform: translateY(-2px);
        }
        .wizard-option.selected {
            border-color: var(--md-primary);
            background: color-mix(in srgb, var(--md-primary) 10%, var(--md-surface-container-high));
        }
        .wizard-option-icon {
            font-size: 32px;
            margin-bottom: 8px;
        }
        .wizard-option-name {
            font-weight: 600;
            font-size: 14px;
            margin-bottom: 4px;
        }
        .wizard-option-desc {
            font-size: 11px;
            color: var(--md-on-surface-variant);
        }
        .wizard-input-group {
            margin-bottom: 20px;
        }
        .wizard-input-group label {
            display: block;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
            color: var(--md-on-surface-variant);
            margin-bottom: 8px;
        }
        .wizard-input-group input,
        .wizard-input-group select {
            width: 100%;
            background: var(--md-surface-container-high);
            border: 1px solid var(--md-outline-variant);
            border-radius: 10px;
            padding: 14px 16px;
            font-size: 15px;
            color: var(--md-on-surface);
        }
        .wizard-input-group input:focus,
        .wizard-input-group select:focus {
            outline: none;
            border-color: var(--md-primary);
        }
        .wizard-ability-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 12px;
        }
        .wizard-ability-item {
            background: var(--md-surface-container-high);
            border-radius: 10px;
            padding: 12px;
            text-align: center;
        }
        .wizard-ability-item label {
            font-size: 11px;
            font-weight: 600;
            color: var(--md-on-surface-variant);
            display: block;
            margin-bottom: 6px;
        }
        .wizard-ability-item input {
            width: 60px;
            background: var(--md-surface-container);
            border: 1px solid var(--md-outline-variant);
            border-radius: 8px;
            padding: 10px;
            font-size: 18px;
            font-weight: 700;
            text-align: center;
            color: var(--md-on-surface);
        }
        .wizard-footer {
            padding: 20px 28px;
            border-top: 1px solid var(--md-outline-variant);
            display: flex;
            justify-content: space-between;
            gap: 12px;
        }
        .wizard-btn {
            padding: 12px 28px;
            border-radius: 10px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            border: none;
        }
        .wizard-btn-back {
            background: var(--md-surface-container-high);
            color: var(--md-on-surface);
        }
        .wizard-btn-back:hover {
            background: var(--md-surface-container-highest);
        }
        .wizard-btn-next {
            background: var(--md-primary);
            color: var(--md-on-primary);
            margin-left: auto;
        }
        .wizard-btn-next:hover {
            filter: brightness(1.1);
        }
        .wizard-btn-next:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        .wizard-close {
            position: absolute;
            top: 20px;
            right: 20px;
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background: var(--md-surface-container-high);
            border: none;
            color: var(--md-on-surface);
            font-size: 20px;
            cursor: pointer;
        }

        /* ===== QUICK START TEMPLATES ===== */
        .quickstart-btn {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            background: linear-gradient(135deg, var(--md-primary), color-mix(in srgb, var(--md-primary) 70%, purple));
            color: var(--md-on-primary);
            border: none;
            border-radius: 10px;
            padding: 12px 20px;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        .quickstart-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 20px rgba(var(--md-primary-rgb), 0.4);
        }
        .quickstart-btn svg {
            width: 18px;
            height: 18px;
        }

        .template-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 16px;
            margin-top: 20px;
        }
        .template-card {
            background: var(--md-surface-container-high);
            border: 2px solid transparent;
            border-radius: 14px;
            padding: 20px;
            cursor: pointer;
            transition: all 0.2s ease;
            position: relative;
        }
        .template-card:hover {
            border-color: var(--md-outline);
            transform: translateY(-3px);
            box-shadow: 0 8px 24px rgba(0,0,0,0.2);
        }
        .template-card.selected {
            border-color: var(--md-primary);
        }
        /* GM-only Templates - grüner Rahmen */
        .template-card.gm-only {
            border-color: #4caf50;
            background: linear-gradient(135deg, var(--md-surface-container-high) 0%, rgba(76, 175, 80, 0.08) 100%);
        }
        .template-card.gm-only:hover {
            border-color: #66bb6a;
            box-shadow: 0 8px 24px rgba(76, 175, 80, 0.3);
        }
        .template-card.gm-only.selected {
            border-color: #81c784;
            box-shadow: 0 0 0 3px rgba(76, 175, 80, 0.3);
        }
        .gm-badge {
            position: absolute;
            top: 8px;
            right: 8px;
            background: linear-gradient(135deg, #4caf50 0%, #2e7d32 100%);
            color: white;
            font-size: 9px;
            font-weight: 700;
            padding: 3px 8px;
            border-radius: 6px;
            letter-spacing: 0.5px;
            box-shadow: 0 2px 6px rgba(76, 175, 80, 0.4);
        }
        .template-portrait {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: var(--md-surface-container);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 28px;
            margin-bottom: 12px;
        }
        .template-name {
            font-size: 16px;
            font-weight: 700;
            margin-bottom: 4px;
        }
        .template-info {
            font-size: 12px;
            color: var(--md-on-surface-variant);
            margin-bottom: 12px;
        }
        .template-desc {
            font-size: 12px;
            color: var(--md-on-surface-variant);
            line-height: 1.5;
        }

        /* ===== RULES REFERENCE POPUP ===== */
        .rules-popup {
            position: fixed;
            z-index: 10000;
            background: var(--md-surface-container);
            border: 1px solid var(--md-outline-variant);
            border-radius: 16px;
            width: 380px;
            max-height: 450px;
            overflow: hidden;
            box-shadow: 0 12px 48px rgba(0,0,0,0.5);
            opacity: 0;
            visibility: hidden;
            transform: scale(0.95);
            transition: all 0.2s ease;
        }
        .rules-popup.visible {
            opacity: 1;
            visibility: visible;
            transform: scale(1);
        }
        .rules-popup-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px 20px;
            background: var(--md-surface-container-high);
            border-bottom: 1px solid var(--md-outline-variant);
        }
        .rules-popup-header h3 {
            font-size: 15px;
            font-weight: 700;
        }
        .rules-popup-close {
            width: 28px;
            height: 28px;
            border-radius: 50%;
            background: transparent;
            border: none;
            color: var(--md-on-surface-variant);
            font-size: 18px;
            cursor: pointer;
        }
        .rules-popup-close:hover {
            background: var(--md-surface-container-highest);
        }
        .rules-popup-body {
            padding: 20px;
            max-height: 350px;
            overflow-y: auto;
        }
        .rules-popup-body p {
            font-size: 13px;
            line-height: 1.6;
            color: var(--md-on-surface);
            margin-bottom: 12px;
        }
        .rules-popup-body p:last-child {
            margin-bottom: 0;
        }
        .rules-popup-body strong {
            color: var(--md-primary);
        }
        .rules-popup-example {
            background: var(--md-surface-container-high);
            border-radius: 10px;
            padding: 14px;
            margin-top: 12px;
        }
        .rules-popup-example h4 {
            font-size: 11px;
            font-weight: 700;
            text-transform: uppercase;
            color: var(--md-on-surface-variant);
            margin-bottom: 8px;
        }
        .rules-link {
            color: var(--md-primary);
            text-decoration: underline;
            cursor: pointer;
            font-size: inherit;
        }
        .rules-link:hover {
            text-decoration: none;
        }

        /* New Character Buttons Row */
        .new-char-actions {
            display: flex;
            gap: 12px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        .new-char-btn {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            background: var(--md-surface-container-high);
            color: var(--md-on-surface);
            border: 1px solid var(--md-outline-variant);
            border-radius: 10px;
            padding: 10px 18px;
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        .new-char-btn:hover {
            background: var(--md-surface-container-highest);
            border-color: var(--md-outline);
        }
        .new-char-btn svg {
            width: 18px;
            height: 18px;
        }
        .new-char-btn.primary {
            background: var(--md-primary);
            color: var(--md-on-primary);
            border-color: var(--md-primary);
        }
        .new-char-btn.primary:hover {
            filter: brightness(1.1);
        }

        .section-hide-btn {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background: transparent;
            border: 1px solid var(--md-outline-variant);
            color: var(--md-on-surface-variant);
            font-size: 16px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
            line-height: 1;
        }
        .section-hide-btn:hover {
            background: var(--md-error-container);
            border-color: var(--md-error);
            color: var(--md-on-error-container);
        }

        /* Settings Options */
        .settings-option {
            display: flex;
            align-items: flex-start;
            gap: 14px;
            padding: 16px 0;
            border-bottom: 1px solid var(--md-outline-variant);
        }
        .settings-option:last-child {
            border-bottom: none;
        }
        .settings-option-text {
            flex: 1;
        }
        .settings-option-title {
            font-size: 14px;
            font-weight: 600;
            margin-bottom: 4px;
        }
        .settings-option-desc {
            font-size: 12px;
            color: var(--md-on-surface-variant);
            line-height: 1.4;
        }
        .settings-toggle {
            position: relative;
            width: 48px;
            height: 26px;
            flex-shrink: 0;
        }
        .settings-toggle input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        .settings-toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: var(--md-surface-container-highest);
            transition: 0.3s;
            border-radius: 26px;
        }
        .settings-toggle-slider::before {
            position: absolute;
            content: "";
            height: 20px;
            width: 20px;
            left: 3px;
            bottom: 3px;
            background: var(--md-on-surface-variant);
            transition: 0.3s;
            border-radius: 50%;
        }
        .settings-toggle input:checked + .settings-toggle-slider {
            background: var(--md-primary);
        }
        .settings-toggle input:checked + .settings-toggle-slider::before {
            transform: translateX(22px);
            background: var(--md-on-primary);
        }

        /* ===== VETERAN FEATURES ===== */
        
        /* Rest Buttons */
        .rest-buttons {
            display: flex;
            gap: 10px;
            margin-top: 16px;
            flex-wrap: wrap;
        }
        .rest-btn {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 10px 16px;
            border-radius: 10px;
            border: 1px solid var(--md-outline-variant);
            background: var(--md-surface-container-high);
            color: var(--md-on-surface);
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        .rest-btn:hover {
            background: var(--md-surface-container-highest);
            border-color: var(--md-primary);
        }
        .rest-btn svg {
            width: 18px;
            height: 18px;
        }
        .rest-btn.short-rest {
            border-color: var(--md-tertiary);
        }
        .rest-btn.short-rest:hover {
            background: color-mix(in srgb, var(--md-tertiary) 15%, var(--md-surface-container));
        }
        .rest-btn.long-rest {
            border-color: var(--md-primary);
        }
        .rest-btn.long-rest:hover {
            background: color-mix(in srgb, var(--md-primary) 15%, var(--md-surface-container));
        }

        /* Conditions Tracker */
        .conditions-section {
            margin-top: 16px;
            padding-top: 16px;
            border-top: 1px solid var(--md-outline-variant);
        }
        .conditions-label {
            font-size: 11px;
            text-transform: uppercase;
            color: var(--md-on-surface-variant);
            font-weight: 600;
            margin-bottom: 10px;
        }
        .conditions-grid {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }
        .condition-chip {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 6px 12px;
            border-radius: 16px;
            background: var(--md-surface-container-high);
            border: 1px solid transparent;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.2s ease;
            user-select: none;
        }
        .condition-chip:hover {
            border-color: var(--md-outline);
        }
        .condition-chip.active {
            background: var(--md-error-container);
            border-color: var(--md-error);
            color: var(--md-on-error-container);
        }
        .condition-chip .condition-icon {
            font-size: 14px;
        }

        /* Action Buttons (Worlds Apart Style) */
        .action-buttons {
            display: flex;
            gap: 8px;
            margin-top: 16px;
            padding-top: 16px;
            border-top: 1px solid rgba(255, 255, 255, 0.06);
        }

        .action-btn {
            flex: 1;
            padding: 8px;
            background: #1e1e1e;
            border: 1px solid rgba(255, 255, 255, 0.06);
            border-radius: 6px;
            color: rgba(255, 255, 255, 0.5);
            font-size: 10px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.15s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 4px;
        }

        .action-btn:hover {
            background: #252525;
            color: rgba(255, 255, 255, 0.7);
        }

        .action-btn.danger:hover {
            background: rgba(255, 70, 85, 0.12);
            border-color: #FF4655;
            color: #FF4655;
        }

        .action-btn svg {
            width: 12px;
            height: 12px;
        }

        /* GM Coins Box */
        .gm-coins-box {
            margin-top: 12px;
            padding: 12px;
            background: rgba(139, 92, 246, 0.08);
            border: 1px solid rgba(139, 92, 246, 0.2);
            border-radius: 8px;
        }

        .gm-coins-box .coins-row {
            opacity: 0.8;
        }

        .gm-coins-box .coin-input {
            cursor: default;
        }

        .gm-coins-hint {
            font-size: 10px;
            color: rgba(139, 92, 246, 0.7);
            margin-top: 8px;
            text-align: center;
        }

        /* Concentration Active Indicator */
        .spell-row.concentrating {
            background: color-mix(in srgb, var(--md-tertiary) 15%, var(--md-surface-container-high));
            border: 1px solid var(--md-tertiary);
        }
        .concentration-banner {
            display: none;
            align-items: center;
            gap: 10px;
            padding: 10px 14px;
            background: color-mix(in srgb, var(--md-tertiary) 20%, var(--md-surface-container));
            border: 1px solid var(--md-tertiary);
            border-radius: 10px;
            margin-bottom: 12px;
            font-size: 13px;
        }
        .concentration-banner.visible {
            display: flex;
        }
        .concentration-banner .conc-icon {
            font-size: 18px;
        }
        .concentration-banner .conc-spell {
            font-weight: 600;
            color: var(--md-tertiary);
        }
        .concentration-banner .conc-break {
            margin-left: auto;
            padding: 4px 10px;
            border-radius: 6px;
            background: var(--md-error);
            color: var(--md-on-error);
            border: none;
            font-size: 11px;
            cursor: pointer;
        }

        /* Multiclass Support */
        .multiclass-section {
            margin-top: 12px;
            padding-top: 12px;
            border-top: 1px solid var(--md-outline-variant);
        }
        .multiclass-row {
            display: flex;
            gap: 10px;
            align-items: center;
            margin-bottom: 8px;
        }
        .multiclass-row select,
        .multiclass-row input {
            background: var(--md-surface-container-high);
            border: 1px solid var(--md-outline-variant);
            border-radius: 8px;
            padding: 8px 10px;
            font-size: 13px;
            color: var(--md-on-surface);
        }
        .multiclass-row select {
            flex: 2;
        }
        .multiclass-row input[type="number"] {
            width: 60px;
            text-align: center;
        }
        .multiclass-remove {
            width: 28px;
            height: 28px;
            border-radius: 50%;
            background: var(--md-surface-container-highest);
            border: none;
            color: var(--md-on-surface-variant);
            cursor: pointer;
            font-size: 16px;
        }
        .multiclass-remove:hover {
            background: var(--md-error-container);
            color: var(--md-error);
        }
        .add-multiclass-btn {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 6px 12px;
            border-radius: 8px;
            background: transparent;
            border: 1px dashed var(--md-outline-variant);
            color: var(--md-on-surface-variant);
            font-size: 12px;
            cursor: pointer;
        }
        .add-multiclass-btn:hover {
            border-color: var(--md-primary);
            color: var(--md-primary);
        }

        /* Dice Roll Clickable */
        .rollable {
            cursor: pointer;
            transition: all 0.15s ease;
            position: relative;
        }
        .rollable:hover {
            color: var(--md-primary);
            text-shadow: 0 0 8px rgba(var(--md-primary-rgb), 0.5);
        }
        .rollable::after {
            content: '🎲';
            position: absolute;
            right: -20px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 12px;
            opacity: 0;
            transition: opacity 0.2s ease;
        }
        .rollable:hover::after {
            opacity: 0.7;
        }
        
        .rollable-field {
            cursor: pointer !important;
        }
        .rollable-field:hover {
            background: color-mix(in srgb, var(--md-primary) 10%, var(--md-surface-container-high)) !important;
            border-color: var(--md-primary) !important;
        }
        
        /* Clickable computed values */
        .stat-computed.clickable,
        .skill-computed.clickable,
        .save-computed.clickable {
            cursor: pointer;
            border-radius: 4px;
            padding: 2px 4px;
            margin: -2px -4px;
            transition: all 0.15s ease;
        }
        .stat-computed.clickable:hover,
        .skill-computed.clickable:hover,
        .save-computed.clickable:hover {
            background: var(--md-primary);
            color: var(--md-on-primary);
        }

        /* Rest Effect Overlay */
        .rest-effect-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            z-index: 10000;
            pointer-events: none;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
        }
        .rest-effect-overlay.active {
            animation: restEffectFade 2s ease-out forwards;
        }
        .rest-effect-overlay.short-rest {
            background: radial-gradient(circle, rgba(255,200,50,0.4) 0%, rgba(255,150,0,0.1) 50%, transparent 70%);
        }
        .rest-effect-overlay.long-rest {
            background: radial-gradient(circle, rgba(100,150,255,0.4) 0%, rgba(50,50,150,0.2) 50%, transparent 70%);
        }
        .rest-effect-icon {
            font-size: 120px;
            animation: restIconPulse 2s ease-out forwards;
            filter: drop-shadow(0 0 30px currentColor);
        }
        .rest-effect-overlay.short-rest .rest-effect-icon {
            color: #ffcc00;
            text-shadow: 0 0 40px #ff9900, 0 0 80px #ff6600;
        }
        .rest-effect-overlay.long-rest .rest-effect-icon {
            color: #aaccff;
            text-shadow: 0 0 40px #6699ff, 0 0 80px #3366cc;
        }
        .rest-effect-text {
            position: absolute;
            bottom: 35%;
            font-size: 28px;
            font-weight: 700;
            letter-spacing: 4px;
            text-transform: uppercase;
            animation: restTextSlide 2s ease-out forwards;
        }
        .rest-effect-overlay.short-rest .rest-effect-text {
            color: #ffdd44;
            text-shadow: 0 0 20px #ff9900;
        }
        .rest-effect-overlay.long-rest .rest-effect-text {
            color: #aaddff;
            text-shadow: 0 0 20px #6699ff;
        }
        @keyframes restEffectFade {
            0% { opacity: 0; }
            15% { opacity: 1; }
            70% { opacity: 1; }
            100% { opacity: 0; }
        }
        @keyframes restIconPulse {
            0% { transform: scale(0.5); opacity: 0; }
            20% { transform: scale(1.2); opacity: 1; }
            40% { transform: scale(1); }
            70% { transform: scale(1.1); opacity: 1; }
            100% { transform: scale(1.5); opacity: 0; }
        }
        @keyframes restTextSlide {
            0% { transform: translateY(20px); opacity: 0; }
            20% { transform: translateY(0); opacity: 1; }
            70% { transform: translateY(0); opacity: 1; }
            100% { transform: translateY(-20px); opacity: 0; }
        }

        /* ===== INTEGRATED DICE ROLLER POPUP ===== */
        .dice-popup-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.7);
            backdrop-filter: blur(4px);
            z-index: 10000;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.25s ease;
        }
        .dice-popup-overlay.active {
            opacity: 1;
            pointer-events: auto;
        }
        .dice-popup {
            background: var(--md-surface-container);
            border-radius: 20px;
            padding: 24px;
            min-width: 320px;
            max-width: 400px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.5);
            transform: scale(0.9) translateY(20px);
            transition: transform 0.3s ease;
            border: 1px solid var(--md-outline-variant);
        }
        .dice-popup-overlay.active .dice-popup {
            transform: scale(1) translateY(0);
        }
        .dice-popup-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }
        .dice-popup-title {
            font-size: 16px;
            font-weight: 600;
            color: var(--md-on-surface);
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .dice-popup-title .roll-type {
            color: var(--md-primary);
        }
        .dice-popup-close {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            border: none;
            background: var(--md-surface-container-highest);
            color: var(--md-on-surface-variant);
            font-size: 20px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .dice-popup-close:hover {
            background: var(--md-error-container);
            color: var(--md-error);
        }
        
        /* Dice Display */
        .dice-display-area {
            background: var(--md-surface-container-high);
            border-radius: 16px;
            padding: 24px;
            text-align: center;
            margin-bottom: 16px;
            position: relative;
            overflow: hidden;
        }
        .dice-formula {
            font-size: 14px;
            color: var(--md-on-surface-variant);
            margin-bottom: 12px;
            font-family: 'JetBrains Mono', monospace;
        }
        .dice-result {
            font-size: 64px;
            font-weight: 800;
            color: var(--md-on-surface);
            line-height: 1;
            margin-bottom: 8px;
            transition: all 0.3s ease;
        }
        .dice-result.rolling {
            animation: diceRoll 0.1s infinite;
        }
        .dice-result.crit {
            color: #ffd700;
            text-shadow: 0 0 30px rgba(255,215,0,0.8);
        }
        .dice-result.fail {
            color: #ff4444;
            text-shadow: 0 0 30px rgba(255,68,68,0.8);
        }
        .dice-breakdown {
            font-size: 13px;
            color: var(--md-on-surface-variant);
            font-family: 'JetBrains Mono', monospace;
        }
        .dice-breakdown .roll-value {
            color: var(--md-tertiary);
            font-weight: 600;
        }
        .dice-breakdown .mod-value {
            color: var(--md-primary);
        }
        
        @keyframes diceRoll {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }
        
        /* Advantage/Disadvantage Toggle */
        .dice-adv-row {
            display: flex;
            gap: 8px;
            margin-bottom: 16px;
        }
        .dice-adv-btn {
            flex: 1;
            padding: 10px;
            border-radius: 10px;
            border: 1px solid var(--md-outline-variant);
            background: var(--md-surface-container-high);
            color: var(--md-on-surface);
            font-size: 12px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        .dice-adv-btn:hover {
            border-color: var(--md-primary);
        }
        .dice-adv-btn.active {
            background: var(--md-primary);
            color: var(--md-on-primary);
            border-color: var(--md-primary);
        }
        .dice-adv-btn.adv.active {
            background: #22aa44;
            border-color: #22aa44;
        }
        .dice-adv-btn.dis.active {
            background: #cc4444;
            border-color: #cc4444;
        }
        
        /* Roll Button */
        .dice-roll-btn {
            width: 100%;
            padding: 14px;
            border-radius: 12px;
            border: none;
            background: linear-gradient(135deg, var(--md-primary), var(--md-tertiary));
            color: white;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            transition: all 0.2s ease;
        }
        .dice-roll-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(var(--md-primary-rgb), 0.4);
        }
        .dice-roll-btn:active {
            transform: translateY(0);
        }
        .dice-roll-btn svg {
            width: 20px;
            height: 20px;
        }
        
        /* Confetti for crits */
        .dice-confetti {
            position: absolute;
            width: 10px;
            height: 10px;
            border-radius: 2px;
            animation: confettiFall 2s ease-out forwards;
        }
        @keyframes confettiFall {
            0% { transform: translateY(-20px) rotate(0deg); opacity: 1; }
            100% { transform: translateY(200px) rotate(720deg); opacity: 0; }
        }

        /* ===== WEAPON/CANTRIP PICKER ===== */
        .weapon-add-buttons {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            margin-top: 12px;
        }

        .weapon-add-buttons .add-btn {
            margin-top: 0;
            flex: 1;
            min-width: 120px;
        }

        /* Compact buttons don't grow */
        .weapon-add-buttons .add-btn.compact {
            flex: 0 0 auto;
            min-width: auto;
        }

        /* Primary picker buttons with icons */
        .add-btn.picker-btn {
            background: var(--md-primary-container);
            color: var(--md-on-primary-container);
            border: 1px solid var(--md-primary);
            font-weight: 600;
        }

        .add-btn.picker-btn:hover {
            background: var(--md-primary);
            color: var(--md-on-primary);
        }

        /* Secondary/tertiary picker buttons */
        .add-btn.picker-btn.secondary {
            background: var(--md-tertiary-container);
            color: var(--md-on-tertiary-container);
            border-color: var(--md-tertiary);
        }

        .add-btn.picker-btn.secondary:hover {
            background: var(--md-tertiary);
            color: var(--md-on-tertiary);
        }
        
        .picker-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.7);
            backdrop-filter: blur(4px);
            z-index: 10000;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.25s ease;
        }
        .picker-overlay.active {
            opacity: 1;
            pointer-events: auto;
        }
        .picker-modal {
            background: var(--md-surface-container);
            border-radius: 20px;
            width: 90%;
            max-width: 600px;
            max-height: 80vh;
            display: flex;
            flex-direction: column;
            box-shadow: 0 20px 60px rgba(0,0,0,0.5);
            transform: scale(0.9) translateY(20px);
            transition: transform 0.3s ease;
            border: 1px solid var(--md-outline-variant);
        }
        .picker-overlay.active .picker-modal {
            transform: scale(1) translateY(0);
        }
        .picker-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px 24px;
            border-bottom: 1px solid var(--md-outline-variant);
        }
        .picker-header h2 {
            margin: 0;
            font-size: 18px;
            font-weight: 600;
        }
        .picker-close {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            border: none;
            background: var(--md-surface-container-highest);
            color: var(--md-on-surface-variant);
            font-size: 22px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .picker-close:hover {
            background: var(--md-error-container);
            color: var(--md-error);
        }
        .picker-search {
            padding: 16px 24px;
            border-bottom: 1px solid var(--md-outline-variant);
        }
        .picker-search input {
            width: 100%;
            padding: 12px 16px;
            border-radius: 12px;
            border: 1px solid var(--md-outline-variant);
            background: var(--md-surface-container-high);
            color: var(--md-on-surface);
            font-size: 14px;
            box-sizing: border-box;
        }
        .picker-search input:focus {
            outline: none;
            border-color: var(--md-primary);
        }
        .picker-filters {
            display: flex;
            gap: 8px;
            margin-top: 12px;
            flex-wrap: wrap;
        }
        .picker-filter-btn {
            padding: 6px 12px;
            border-radius: 16px;
            border: 1px solid var(--md-outline-variant);
            background: transparent;
            color: var(--md-on-surface-variant);
            font-size: 12px;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        .picker-filter-btn:hover,
        .picker-filter-btn.active {
            background: var(--md-primary);
            color: var(--md-on-primary);
            border-color: var(--md-primary);
        }
        .picker-list {
            flex: 1;
            overflow-y: auto;
            padding: 12px;
        }
        .picker-item {
            display: flex;
            align-items: center;
            padding: 12px 16px;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.15s ease;
            margin-bottom: 4px;
        }
        .picker-item:hover {
            background: var(--md-surface-container-high);
        }
        .picker-item-icon {
            font-size: 24px;
            margin-right: 14px;
            width: 32px;
            text-align: center;
        }
        .picker-svg-icon {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 32px;
            height: 32px;
            margin-right: 14px;
        }
        .picker-svg-icon svg {
            width: 24px;
            height: 24px;
        }
        .picker-item-info {
            flex: 1;
        }
        .picker-item-name {
            font-weight: 600;
            font-size: 14px;
            margin-bottom: 2px;
        }
        .picker-item-details {
            font-size: 12px;
            color: var(--md-on-surface-variant);
        }
        .picker-item-tags {
            display: flex;
            gap: 6px;
            margin-left: auto;
            flex-wrap: wrap;
            justify-content: flex-end;
        }
        .picker-tag {
            padding: 3px 8px;
            border-radius: 10px;
            font-size: 10px;
            font-weight: 600;
            background: var(--md-surface-container-highest);
            color: var(--md-on-surface-variant);
        }
        .picker-tag.damage {
            color: #fff;
            text-shadow: 0 1px 2px rgba(0,0,0,0.3);
        }
        .picker-tag.type, .picker-tag.school {
            background: transparent;
            border: 1.5px solid;
        }
        .picker-tag.conc {
            background: #ffcc00;
            color: #333;
            font-weight: 700;
        }
        .picker-tag.ritual {
            background: #cc88ff;
            color: #fff;
        }
        .picker-category {
            font-size: 11px;
            text-transform: uppercase;
            font-weight: 600;
            color: var(--md-primary);
            padding: 12px 16px 6px;
            letter-spacing: 1px;
        }
        
        /* ===== LANGUAGE TOGGLE ===== */
        .lang-toggle {
            position: absolute;
            left: 50%;
            transform: translateX(calc(-50% + 140px));
            display: flex;
            gap: 2px;
            background: rgba(255, 255, 255, 0.06);
            border-radius: 6px;
            padding: 2px;
            z-index: 10;
        }
        
        .lang-btn {
            padding: 4px 10px;
            border: none;
            background: transparent;
            color: rgba(255, 255, 255, 0.5);
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
            border-radius: 4px;
            transition: all 0.2s ease;
        }
        
        .lang-btn:hover {
            color: rgba(255, 255, 255, 0.8);
        }
        
        .lang-btn.active {
            background: var(--md-primary);
            color: #fff;
        }
        
        @media (max-width: 600px) {
            .lang-toggle {
                transform: translateX(calc(-50% + 120px));
            }
            .lang-btn {
                padding: 4px 8px;
                font-size: 11px;
            }
        }
    </style>
</head>
<body>
    <div class="app">
        <main class="main">
            <div class="main__content">
    
    <!-- Crop Modal -->
    <div class="crop-overlay" id="cropModal">
        <div class="crop-modal">
            <div class="crop-header"><span class="crop-title">Crop Portrait</span><button class="crop-close" onclick="closeCrop()">×</button></div>
            <div class="crop-body"><img id="cropImage" src=""></div>
            <div class="crop-footer"><button class="crop-btn crop-btn-cancel" onclick="closeCrop()">Cancel</button><button class="crop-btn crop-btn-ok" onclick="confirmCrop()">OK</button></div>
        </div>
    </div>

    <!-- Character Creation Wizard -->
    <div class="wizard-overlay" id="wizardModal">
        <div class="wizard-modal">
            <div class="wizard-header">
                <h2 id="wizardTitle">Create Your Character</h2>
                <div class="wizard-progress">
                    <div class="wizard-progress-step active" data-step="1"></div>
                    <div class="wizard-progress-step" data-step="2"></div>
                    <div class="wizard-progress-step" data-step="3"></div>
                    <div class="wizard-progress-step" data-step="4"></div>
                    <div class="wizard-progress-step" data-step="5"></div>
                </div>
            </div>
            <div class="wizard-body">
                <!-- Step 1: Name & Basics -->
                <div class="wizard-step active" data-step="1">
                    <h3>Who is your character?</h3>
                    <p>Every hero needs a name. What shall we call you?</p>
                    <div class="wizard-input-group">
                        <label>Character Name</label>
                        <input type="text" id="wizardName" placeholder="Enter your character's name...">
                    </div>
                    <div class="wizard-input-group">
                        <label>Level (1-20)</label>
                        <input type="number" id="wizardLevel" value="1" min="1" max="20">
                    </div>
                </div>

                <!-- Step 2: Species -->
                <div class="wizard-step" data-step="2">
                    <h3>Choose Your Species</h3>
                    <p>Your species determines your physical traits and some abilities.</p>
                    <div class="wizard-options" id="wizardSpeciesOptions">
                        <div class="wizard-option" data-value="Human" onclick="selectWizardOption(this, 'species')">
                            <div class="wizard-option-icon">👤</div>
                            <div class="wizard-option-name">Human</div>
                            <div class="wizard-option-desc">Versatile & adaptable</div>
                        </div>
                        <div class="wizard-option" data-value="Elf" onclick="selectWizardOption(this, 'species')">
                            <div class="wizard-option-icon">🧝</div>
                            <div class="wizard-option-name">Elf</div>
                            <div class="wizard-option-desc">Graceful & perceptive</div>
                        </div>
                        <div class="wizard-option" data-value="Dwarf" onclick="selectWizardOption(this, 'species')">
                            <div class="wizard-option-icon">⛏️</div>
                            <div class="wizard-option-name">Dwarf</div>
                            <div class="wizard-option-desc">Tough & resilient</div>
                        </div>
                        <div class="wizard-option" data-value="Halfling" onclick="selectWizardOption(this, 'species')">
                            <div class="wizard-option-icon">🍀</div>
                            <div class="wizard-option-name">Halfling</div>
                            <div class="wizard-option-desc">Lucky & nimble</div>
                        </div>
                        <div class="wizard-option" data-value="Dragonborn" onclick="selectWizardOption(this, 'species')">
                            <div class="wizard-option-icon">🐉</div>
                            <div class="wizard-option-name">Dragonborn</div>
                            <div class="wizard-option-desc">Proud & powerful</div>
                        </div>
                        <div class="wizard-option" data-value="Tiefling" onclick="selectWizardOption(this, 'species')">
                            <div class="wizard-option-icon">😈</div>
                            <div class="wizard-option-name">Tiefling</div>
                            <div class="wizard-option-desc">Charismatic & fiendish</div>
                        </div>
                        <div class="wizard-option" data-value="Gnome" onclick="selectWizardOption(this, 'species')">
                            <div class="wizard-option-icon">🔧</div>
                            <div class="wizard-option-name">Gnome</div>
                            <div class="wizard-option-desc">Clever & inventive</div>
                        </div>
                        <div class="wizard-option" data-value="Half-Orc" onclick="selectWizardOption(this, 'species')">
                            <div class="wizard-option-icon">💪</div>
                            <div class="wizard-option-name">Half-Orc</div>
                            <div class="wizard-option-desc">Strong & fierce</div>
                        </div>
                    </div>
                </div>

                <!-- Step 3: Class -->
                <div class="wizard-step" data-step="3">
                    <h3>Choose Your Class</h3>
                    <p>Your class defines your abilities and role in the party.</p>
                    <div class="wizard-options" id="wizardClassOptions">
                        <div class="wizard-option" data-value="Fighter" onclick="selectWizardOption(this, 'class')">
                            <div class="wizard-option-icon">⚔️</div>
                            <div class="wizard-option-name">Fighter</div>
                            <div class="wizard-option-desc">Master of combat</div>
                        </div>
                        <div class="wizard-option" data-value="Wizard" onclick="selectWizardOption(this, 'class')">
                            <div class="wizard-option-icon">🔮</div>
                            <div class="wizard-option-name">Wizard</div>
                            <div class="wizard-option-desc">Arcane scholar</div>
                        </div>
                        <div class="wizard-option" data-value="Rogue" onclick="selectWizardOption(this, 'class')">
                            <div class="wizard-option-icon">🗡️</div>
                            <div class="wizard-option-name">Rogue</div>
                            <div class="wizard-option-desc">Stealthy & skilled</div>
                        </div>
                        <div class="wizard-option" data-value="Cleric" onclick="selectWizardOption(this, 'class')">
                            <div class="wizard-option-icon">✨</div>
                            <div class="wizard-option-name">Cleric</div>
                            <div class="wizard-option-desc">Divine healer</div>
                        </div>
                        <div class="wizard-option" data-value="Barbarian" onclick="selectWizardOption(this, 'class')">
                            <div class="wizard-option-icon">🪓</div>
                            <div class="wizard-option-name">Barbarian</div>
                            <div class="wizard-option-desc">Raging warrior</div>
                        </div>
                        <div class="wizard-option" data-value="Bard" onclick="selectWizardOption(this, 'class')">
                            <div class="wizard-option-icon">🎵</div>
                            <div class="wizard-option-name">Bard</div>
                            <div class="wizard-option-desc">Musical magic</div>
                        </div>
                        <div class="wizard-option" data-value="Paladin" onclick="selectWizardOption(this, 'class')">
                            <div class="wizard-option-icon">🛡️</div>
                            <div class="wizard-option-name">Paladin</div>
                            <div class="wizard-option-desc">Holy knight</div>
                        </div>
                        <div class="wizard-option" data-value="Ranger" onclick="selectWizardOption(this, 'class')">
                            <div class="wizard-option-icon">🏹</div>
                            <div class="wizard-option-name">Ranger</div>
                            <div class="wizard-option-desc">Wilderness hunter</div>
                        </div>
                        <div class="wizard-option" data-value="Sorcerer" onclick="selectWizardOption(this, 'class')">
                            <div class="wizard-option-icon">⚡</div>
                            <div class="wizard-option-name">Sorcerer</div>
                            <div class="wizard-option-desc">Innate magic</div>
                        </div>
                        <div class="wizard-option" data-value="Warlock" onclick="selectWizardOption(this, 'class')">
                            <div class="wizard-option-icon">👁️</div>
                            <div class="wizard-option-name">Warlock</div>
                            <div class="wizard-option-desc">Pact magic</div>
                        </div>
                        <div class="wizard-option" data-value="Druid" onclick="selectWizardOption(this, 'class')">
                            <div class="wizard-option-icon">🌿</div>
                            <div class="wizard-option-name">Druid</div>
                            <div class="wizard-option-desc">Nature's guardian</div>
                        </div>
                        <div class="wizard-option" data-value="Monk" onclick="selectWizardOption(this, 'class')">
                            <div class="wizard-option-icon">👊</div>
                            <div class="wizard-option-name">Monk</div>
                            <div class="wizard-option-desc">Martial artist</div>
                        </div>
                    </div>
                </div>

                <!-- Step 4: Background -->
                <div class="wizard-step" data-step="4">
                    <h3>Choose Your Background</h3>
                    <p>What did your character do before becoming an adventurer?</p>
                    <div class="wizard-options" id="wizardBackgroundOptions">
                        <div class="wizard-option" data-value="Soldier" onclick="selectWizardOption(this, 'background')">
                            <div class="wizard-option-icon">🎖️</div>
                            <div class="wizard-option-name">Soldier</div>
                            <div class="wizard-option-desc">Military training</div>
                        </div>
                        <div class="wizard-option" data-value="Criminal" onclick="selectWizardOption(this, 'background')">
                            <div class="wizard-option-icon">🔓</div>
                            <div class="wizard-option-name">Criminal</div>
                            <div class="wizard-option-desc">Shady past</div>
                        </div>
                        <div class="wizard-option" data-value="Sage" onclick="selectWizardOption(this, 'background')">
                            <div class="wizard-option-icon">📚</div>
                            <div class="wizard-option-name">Sage</div>
                            <div class="wizard-option-desc">Scholar & researcher</div>
                        </div>
                        <div class="wizard-option" data-value="Acolyte" onclick="selectWizardOption(this, 'background')">
                            <div class="wizard-option-icon">🙏</div>
                            <div class="wizard-option-name">Acolyte</div>
                            <div class="wizard-option-desc">Temple servant</div>
                        </div>
                        <div class="wizard-option" data-value="Noble" onclick="selectWizardOption(this, 'background')">
                            <div class="wizard-option-icon">👑</div>
                            <div class="wizard-option-name">Noble</div>
                            <div class="wizard-option-desc">Wealthy & privileged</div>
                        </div>
                        <div class="wizard-option" data-value="Folk Hero" onclick="selectWizardOption(this, 'background')">
                            <div class="wizard-option-icon">🌾</div>
                            <div class="wizard-option-name">Folk Hero</div>
                            <div class="wizard-option-desc">Common champion</div>
                        </div>
                        <div class="wizard-option" data-value="Entertainer" onclick="selectWizardOption(this, 'background')">
                            <div class="wizard-option-icon">🎭</div>
                            <div class="wizard-option-name">Entertainer</div>
                            <div class="wizard-option-desc">Performer & artist</div>
                        </div>
                        <div class="wizard-option" data-value="Hermit" onclick="selectWizardOption(this, 'background')">
                            <div class="wizard-option-icon">🏔️</div>
                            <div class="wizard-option-name">Hermit</div>
                            <div class="wizard-option-desc">Reclusive seeker</div>
                        </div>
                    </div>
                </div>

                <!-- Step 5: Ability Scores -->
                <div class="wizard-step" data-step="5">
                    <h3>Set Your Abilities</h3>
                    <p>Distribute your ability scores. Standard array: 15, 14, 13, 12, 10, 8</p>
                    <div class="wizard-ability-grid">
                        <div class="wizard-ability-item">
                            <label>Strength</label>
                            <input type="number" id="wizardStr" value="10" min="1" max="20">
                        </div>
                        <div class="wizard-ability-item">
                            <label>Dexterity</label>
                            <input type="number" id="wizardDex" value="10" min="1" max="20">
                        </div>
                        <div class="wizard-ability-item">
                            <label>Constitution</label>
                            <input type="number" id="wizardCon" value="10" min="1" max="20">
                        </div>
                        <div class="wizard-ability-item">
                            <label>Intelligence</label>
                            <input type="number" id="wizardInt" value="10" min="1" max="20">
                        </div>
                        <div class="wizard-ability-item">
                            <label>Wisdom</label>
                            <input type="number" id="wizardWis" value="10" min="1" max="20">
                        </div>
                        <div class="wizard-ability-item">
                            <label>Charisma</label>
                            <input type="number" id="wizardCha" value="10" min="1" max="20">
                        </div>
                    </div>
                    <div style="margin-top: 16px; text-align: center;">
                        <button class="new-char-btn" onclick="applyStandardArray()" style="font-size: 12px;">Apply Standard Array</button>
                    </div>
                </div>
            </div>
            <div class="wizard-footer">
                <button class="wizard-btn wizard-btn-back" id="wizardBack" onclick="wizardPrev()" style="display:none;">Back</button>
                <button class="wizard-btn wizard-btn-next" id="wizardNext" onclick="wizardNext()">Next</button>
            </div>
        </div>
    </div>

    <!-- Quick Start Templates Modal -->
    <div class="wizard-overlay" id="templatesModal">
        <div class="wizard-modal" style="max-width: 700px;">
            <div class="wizard-header">
                <h2>⚡ Schnellstart-Vorlagen</h2>
            </div>
            <div class="wizard-body">
                <p style="color: var(--md-on-surface-variant); margin-bottom: 16px;">Choose a pre-made character to get started immediately. Perfect for new players or one-shots!</p>
                <div class="template-grid" id="templateGrid">
                    <!-- Templates will be inserted by JS -->
                </div>
            </div>
            <div class="wizard-footer">
                <button class="wizard-btn wizard-btn-back" onclick="closeTemplates()">Cancel</button>
                <button class="wizard-btn wizard-btn-next" id="templateLoadBtn" onclick="loadSelectedTemplate()" disabled>Load Character</button>
            </div>
        </div>
    </div>

    <!-- Tooltip Popup Container -->
    <div class="tooltip-popup" id="tooltipPopup">
        <h4 id="tooltipTitle">Title</h4>
        <p id="tooltipText">Description</p>
        <div class="tip-example" id="tooltipExample" style="display:none;"></div>
    </div>

    <!-- Rules Reference Popup -->
    <div class="rules-popup" id="rulesPopup">
        <div class="rules-popup-header">
            <h3 id="rulesTitle">Rule Reference</h3>
            <button class="rules-popup-close" onclick="closeRulesPopup()">×</button>
        </div>
        <div class="rules-popup-body" id="rulesBody">
            <p>Loading...</p>
        </div>
    </div>

    <!-- Sheet Settings Popup -->
    <!-- Integrated Dice Roller Popup -->
    <div class="dice-popup-overlay" id="dicePopup" onclick="if(event.target===this)closeDicePopup()">
        <div class="dice-popup">
            <div class="dice-popup-header">
                <div class="dice-popup-title">
                    🎲 <span class="roll-type" id="diceRollType">Roll</span>
                </div>
                <button class="dice-popup-close" onclick="closeDicePopup()">×</button>
            </div>
            <div class="dice-display-area">
                <div class="dice-formula" id="diceFormula">1d20+0</div>
                <div class="dice-result" id="diceResult">–</div>
                <div class="dice-breakdown" id="diceBreakdown"></div>
            </div>
            <div class="dice-adv-row" id="diceAdvRow">
                <button class="dice-adv-btn dis" onclick="setAdvantage('disadvantage')">Disadvantage</button>
                <button class="dice-adv-btn active" onclick="setAdvantage('normal')">Normal</button>
                <button class="dice-adv-btn adv" onclick="setAdvantage('advantage')">Advantage</button>
            </div>
            <button class="dice-roll-btn" onclick="executeRoll()">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="2" y="2" width="20" height="20" rx="4"/><circle cx="8" cy="8" r="1.5" fill="currentColor"/><circle cx="16" cy="8" r="1.5" fill="currentColor"/><circle cx="8" cy="16" r="1.5" fill="currentColor"/><circle cx="16" cy="16" r="1.5" fill="currentColor"/><circle cx="12" cy="12" r="1.5" fill="currentColor"/></svg>
                <span id="diceRollBtnText">Roll!</span>
            </button>
        </div>
    </div>

    <!-- Weapon/Cantrip Picker Modal -->
    <div class="picker-overlay" id="pickerModal" onclick="if(event.target===this)closePickerModal()">
        <div class="picker-modal">
            <div class="picker-header">
                <h2 id="pickerTitle">⚔️ Select Weapon</h2>
                <button class="picker-close" onclick="closePickerModal()">×</button>
            </div>
            <div class="picker-search">
                <input type="text" id="pickerSearch" placeholder="Search..." oninput="filterPickerItems()">
                <div class="picker-filters" id="pickerFilters"></div>
            </div>
            <div class="picker-list" id="pickerList"></div>
        </div>
    </div>

    <!-- Sheet Settings Popup -->
    <div class="wizard-overlay" id="sheetSettingsModal">
        <div class="wizard-modal" style="max-width: 400px;">
            <div class="wizard-header">
                <h2 id="settingsTitle">⚙️ Settings</h2>
            </div>
            <div class="wizard-body">
                <div class="settings-option">
                    <label class="settings-toggle">
                        <input type="checkbox" id="settingGettingStarted" onchange="toggleGettingStartedSetting()">
                        <span class="settings-toggle-slider"></span>
                    </label>
                    <div class="settings-option-text">
                        <div class="settings-option-title">Show "Getting Started"</div>
                        <div class="settings-option-desc">Show the beginner section with character wizard</div>
                    </div>
                </div>
                <div class="settings-option">
                    <label class="settings-toggle">
                        <input type="checkbox" id="settingHelpIcons" onchange="toggleHelpIconsSetting()">
                        <span class="settings-toggle-slider"></span>
                    </label>
                    <div class="settings-option-text">
                        <div class="settings-option-title">Show Help Icons</div>
                        <div class="settings-option-desc">Show ? icons with rule explanations</div>
                    </div>
                </div>
            </div>
            <div class="wizard-footer">
                <button class="wizard-btn wizard-btn-next" onclick="closeSheetSettings()">OK</button>
            </div>
        </div>
    </div>

    <!-- Page Header with Back Button -->
    <div class="page-header">
        <a href="sheet.html" class="page-header__back">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M19 12H5M12 19l-7-7 7-7"/>
            </svg>
            <span>Character Selection</span>
        </a>
        <div class="page-header__icon">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/>
            </svg>
        </div>
        <div class="page-header__divider"></div>
        <h1 class="page-header__title">Character Sheet</h1>
        <span class="page-header__tagline">D&D 5e</span>
    </div>

    <div class="sheet">
        <!-- GETTING STARTED -->
        <div class="section" id="gettingStartedSection">
            <div class="section-header" onclick="toggleSection(this)">
                <div class="section-title"><svg viewBox="0 0 24 24" fill="currentColor"><path d="M11 21h-1l1-7H7.5c-.58 0-.57-.32-.38-.66.19-.34.05-.08.07-.12C8.48 10.94 10.42 7.54 13 3h1l-1 7h3.5c.49 0 .56.33.47.51l-.07.15C12.96 17.55 11 21 11 21z"/></svg><span>Getting Started</span></div>
                <div style="display:flex;align-items:center;gap:8px;">
                    <button class="section-hide-btn" onclick="event.stopPropagation();hideGettingStarted()" title="Hide permanently">×</button>
                    <div class="section-toggle"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="6 9 12 15 18 9"/></svg></div>
                </div>
            </div>
            <div class="section-content">
                <p style="color: var(--md-on-surface-variant); margin-bottom: 16px; font-size: 14px;">New to D&D? Start here! Create a character step-by-step or pick a ready-made template.</p>
                <div class="new-char-actions">
                    <button class="new-char-btn primary" onclick="openWizard()">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 5v14M5 12h14"/></svg>
                        <span>New Character</span>
                    </button>
                    <button class="new-char-btn" onclick="openTemplates()">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M13 2L3 14h9l-1 8 10-12h-9l1-8z"/></svg>
                        <span>Quick Start Templates</span>
                    </button>
                    <button class="new-char-btn" onclick="toggleHelpIcons()" id="helpIconsToggle">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg>
                        <span id="helpIconsLabel">Help Icons</span>
                    </button>
                    <button class="new-char-btn" onclick="showGettingStarted()" id="restoreGettingStartedBtn" style="display:none;">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M1 4v6h6"/><path d="M23 20v-6h-6"/><path d="M20.49 9A9 9 0 0 0 5.64 5.64L1 10m22 4l-4.64 4.36A9 9 0 0 1 3.51 15"/></svg>
                        <span>Restore</span>
                    </button>
                </div>
            </div>
        </div>

        <!-- HEADER -->
        <div class="section">
            <div class="section-header" onclick="toggleSection(this)">
                <div class="section-title"><svg viewBox="0 0 24 24" fill="currentColor"><path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/></svg><span>Your Character</span></div>
                <div class="section-toggle"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="6 9 12 15 18 9"/></svg></div>
            </div>
            <div class="section-content">
                <!-- ZWEI-SPALTEN LAYOUT: Portrait links, Rest rechts -->
                <div class="header-layout">
                    
                    <!-- LINKE SPALTE: Portrait -->
                    <div class="portrait-box" id="portraitBox" onclick="document.getElementById('portraitInput').click()">
                        <svg id="portraitPlaceholder" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" style="width: 36px; height: 36px; color: var(--md-on-surface-variant); opacity: 0.3;"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>
                        <img id="portraitImage" src="" style="display:none;">
                        <div class="portrait-overlay" id="portraitOverlay">
                            <button class="portrait-overlay-btn change" onclick="event.stopPropagation(); document.getElementById('portraitInput').click();" title="Change"><img src="assets/icons/icon_image.png" alt="Change"></button>
                            <button class="portrait-overlay-btn delete" onclick="event.stopPropagation(); deletePortrait();" title="Delete"><img src="assets/icons/icon_delete.png" alt="Delete"></button>
                        </div>
                        <input type="file" id="portraitInput" accept="image/*" style="display:none;" onchange="handlePortrait(event)">
                    </div>
                    
                    <!-- RECHTE SPALTE: Name + Meta + Stats -->
                    <div class="header-right">
                        <!-- Character Name -->
                        <input type="text" class="char-name-input" id="charName" placeholder="Character Name" oninput="autoSave()">
                        
                        <!-- Meta Chips -->
                        <div class="header-meta">
                            <div class="meta-chip">
                                <label>Species</label>
                                <select id="species" onchange="handleSpeciesChange(); autoSave()">
                                    <option value="" disabled selected>Select</option>
                                    <option value="Human">Human</option>
                                    <option value="Elf">Elf</option>
                                    <option value="Dwarf">Dwarf</option>
                                    <option value="Halfling">Halfling</option>
                                    <option value="Gnome">Gnome</option>
                                    <option value="Half-Elf">Half-Elf</option>
                                    <option value="Half-Orc">Half-Orc</option>
                                    <option value="Dragonborn">Dragonborn</option>
                                    <option value="Tiefling">Tiefling</option>
                                    <option value="custom">Custom / Other</option>
                                </select>
                                <input type="text" id="speciesCustom" class="custom-input" placeholder="Enter species..." style="display:none;" oninput="autoSave()">
                            </div>
                            <div class="meta-chip">
                                <label>Class</label>
                                <select id="charClass" onchange="handleClassChange(); autoSave()">
                                    <option value="" disabled selected>Select</option>
                                    <option value="Artificer">Artificer</option>
                                    <option value="Barbarian">Barbarian</option>
                                    <option value="Bard">Bard</option>
                                    <option value="Cleric">Cleric</option>
                                    <option value="Druid">Druid</option>
                                    <option value="Fighter">Fighter</option>
                                    <option value="Monk">Monk</option>
                                    <option value="Paladin">Paladin</option>
                                    <option value="Ranger">Ranger</option>
                                    <option value="Rogue">Rogue</option>
                                    <option value="Sorcerer">Sorcerer</option>
                                    <option value="Warlock">Warlock</option>
                                    <option value="Wizard">Wizard</option>
                                    <option value="custom">Custom / Homebrew</option>
                                </select>
                                <input type="text" id="classCustom" class="custom-input" placeholder="Enter class..." style="display:none;" oninput="autoSave()">
                            </div>
                            <div class="meta-chip">
                                <label>Level</label>
                                <input type="number" id="level" value="1" min="1" max="20" step="1" oninput="updateProfBonus(); autoSave()">
                            </div>
                            <div class="meta-chip">
                                <label>XP</label>
                                <input type="number" id="xp" placeholder="0" min="0" oninput="autoSave()">
                            </div>
                            <div class="meta-chip">
                                <label>Background</label>
                                <select id="background" onchange="handleBackgroundChange(); autoSave()">
                                    <option value="" disabled selected>Select</option>
                                    <option value="Acolyte">Acolyte</option>
                                    <option value="Charlatan">Charlatan</option>
                                    <option value="Criminal">Criminal</option>
                                    <option value="Entertainer">Entertainer</option>
                                    <option value="Folk Hero">Folk Hero</option>
                                    <option value="Hermit">Hermit</option>
                                    <option value="Noble">Noble</option>
                                    <option value="Outlander">Outlander</option>
                                    <option value="Sage">Sage</option>
                                    <option value="Sailor">Sailor</option>
                                    <option value="Soldier">Soldier</option>
                                    <option value="Urchin">Urchin</option>
                                    <option value="custom">Custom / Other</option>
                                </select>
                                <input type="text" id="backgroundCustom" class="custom-input" placeholder="Enter background..." style="display:none;" oninput="autoSave()">
                            </div>
                            <div class="meta-chip subclass-chip" id="subclassChip" style="display:none;">
                                <label>Subclass</label>
                                <select id="subclass" onchange="handleSubclassChange(); autoSave()">
                                    <option value="" disabled selected>Select</option>
                                </select>
                                <input type="text" id="subclassCustom" class="custom-input" placeholder="Enter subclass..." style="display:none;" oninput="autoSave()">
                            </div>
                        </div>
                        
                        <!-- Multiclass Section -->
                        <div class="multiclass-section" id="multiclassSection" style="display:none;">
                            <div class="conditions-label">Multiclass</div>
                            <div id="multiclassRows"></div>
                            <button class="add-multiclass-btn" onclick="addMulticlass()">+ Add Class</button>
                        </div>
                        
                        <!-- Stats: alle in einer Reihe -->
                        <div class="header-stats">
                            <div class="stat-box"><div class="stat-label">Heroic Insp.</div><div class="heroic-btn" id="heroicBtn" onclick="toggleHeroic()"></div></div>
                            <div class="stat-box"><div class="stat-label">Prof. Bonus</div><span class="stat-value stat-computed" id="profBonus">+2</span><div class="stat-hint">by Level</div></div>
                            <div class="stat-box"><div class="stat-label">Initiative</div><span class="stat-value stat-computed clickable" id="initiative" onclick="rollInitiative()">+0</span><div class="stat-hint">DEX Mod</div></div>
                            <div class="stat-box"><div class="stat-label">Speed</div><input type="text" class="stat-value" id="speed" placeholder="–" oninput="autoSave()"><div class="stat-hint">Species</div></div>
                            <div class="stat-box"><div class="stat-label">Size</div><input type="text" class="stat-value" id="size" placeholder="–" oninput="autoSave()"><div class="stat-hint">Species</div></div>
                            <div class="stat-box"><div class="stat-label">Passive Perc.</div><span class="stat-value stat-computed" id="passivePerc">10</span><div class="stat-hint">10 + WIS + Prof</div></div>
                            <div class="stat-box"><div class="stat-label">Passive Inv.</div><span class="stat-value stat-computed" id="passiveInv">10</span><div class="stat-hint">10 + INT + Prof</div></div>
                            <div class="stat-box"><div class="stat-label">Passive Ins.</div><span class="stat-value stat-computed" id="passiveIns">10</span><div class="stat-hint">10 + WIS + Prof</div></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- COMBAT -->
        <div class="section">
            <div class="section-header" onclick="toggleSection(this)">
                <div class="section-title"><svg viewBox="0 0 24 24" fill="currentColor"><path d="M12 1L3 5v6c0 5.55 3.84 10.74 9 12 5.16-1.26 9-6.45 9-12V5l-9-4z"/></svg><span>Armor & Hit Points</span></div>
                <div class="section-toggle"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="6 9 12 15 18 9"/></svg></div>
            </div>
            <div class="section-content">
                <div class="armor-hp-layout">
                    <!-- AC Shield - spans 2 rows -->
                    <div class="ac-shield">
                        <div class="ac-shield-label">Armor Class</div>
                        <input type="text" class="ac-shield-value" id="ac" placeholder="–" oninput="autoSave()">
                        <div class="ac-shield-sub">
                            <span class="ac-shield-sub-label">Shield</span>
                            <input type="text" class="ac-shield-sub-input" id="shield" placeholder="–" oninput="autoSave()">
                        </div>
                    </div>
                    <!-- Row 1: HP -->
                    <div class="armor-stat-box">
                        <div class="armor-stat-label">Current</div>
                        <input type="number" class="armor-stat-value" id="hpCurrent" placeholder="–" oninput="autoSave()">
                    </div>
                    <div class="armor-stat-box">
                        <div class="armor-stat-label">Maximum</div>
                        <input type="number" class="armor-stat-value" id="hpMax" placeholder="–" oninput="autoSave()">
                    </div>
                    <div class="armor-stat-box">
                        <div class="armor-stat-label">Temp</div>
                        <input type="number" class="armor-stat-value" id="hpTemp" placeholder="0" value="0" oninput="autoSave()">
                    </div>
                    <!-- Row 2: Secondary -->
                    <div class="armor-stat-box">
                        <div class="armor-stat-label">Hit Dice</div>
                        <div class="armor-stat-row">
                            <input type="text" class="armor-stat-input" id="hdCurrent" placeholder="–" oninput="autoSave()">
                            <span class="armor-stat-slash">/</span>
                            <input type="text" class="armor-stat-input" id="hdMax" placeholder="–" oninput="autoSave()">
                        </div>
                    </div>
                    <div class="armor-stat-box">
                        <div class="armor-stat-label">Death Saves</div>
                        <div class="death-saves-box">
                            <div class="death-row-box"><span class="death-label">E</span><div class="death-pips" id="deathSuccess"></div></div>
                            <div class="death-row-box"><span class="death-label">M</span><div class="death-pips" id="deathFail"></div></div>
                        </div>
                    </div>
                    <div class="armor-stat-box">
                        <div class="armor-stat-label">Exhaustion</div>
                        <div class="exhaustion-box">
                            <input type="number" class="exhaustion-input-box" id="exhaustion" value="0" min="0" max="10" oninput="updateExhaustion(); autoSave()">
                            <span class="exhaustion-penalty-box" id="exhaustionPenalty">−0</span>
                        </div>
                        <div class="armor-stat-hint">−2 per level</div>
                    </div>
                </div>
                <div class="defenses-row">
                    <div class="defense-item"><div class="defense-label">Resistances</div><input type="text" id="resistances" placeholder="Fire, Poison, ..." oninput="autoSave()" style="width:100%;box-sizing:border-box;"></div>
                    <div class="defense-item"><div class="defense-label">Immunities</div><input type="text" id="immunities" placeholder="Poison, Disease, ..." oninput="autoSave()" style="width:100%;box-sizing:border-box;"></div>
                    <div class="defense-item"><div class="defense-label">Vulnerabilities</div><input type="text" id="vulnerabilities" placeholder="Radiant, ..." oninput="autoSave()" style="width:100%;box-sizing:border-box;"></div>
                </div>
                
                <!-- Conditions Tracker -->
                <div class="conditions-section">
                    <div class="conditions-label">Conditions</div>
                    <div class="conditions-grid" id="conditionsGrid"></div>
                </div>
                
                <!-- Rest Buttons -->
                <div class="rest-buttons">
                    <button class="rest-btn short-rest" onclick="shortRest()">
                        <svg viewBox="0 0 100 100" fill="currentColor" width="18" height="18"><path d="m90.123 28c-13.16 0.41602-13.176 19.369 0 19.774 13.181-0.40549 13.16-19.358 0-19.774zm-44.401 17.202c-2.2753 0.10336-3.8862 2.9801-2.3303 4.8843 0.44762 0.67406 1.1428 1.1006 1.9748 1.2586l30.212 5.3188c0.57928-2.2223 1.8063-4.2392 3.4809-5.7243l-32.613-5.6769c-0.24685-0.05282-0.48872-0.07125-0.7241-0.06056zm41.839 5.9507c-3.7511-0.13775-7.578 2.2421-8.6128 6.0218-1.0585 3.2493-2.0328 6.6038-3.4125 9.8108-2.8858 6.2351-9.7683 10.222-16.699 10.143h-54.067c-6.286 0.12109-6.4297 9.395-0.0053 9.5633h60.445c-1.3849-4.1234 2.1432-8.4468 6.4668-8.0572 8.1256 0 14.793-6.5305 14.882-14.587l0.06846-5.7032c0.02107-2.8753 1.9327-5.3188 4.5552-6.1719-1.127-0.64642-2.3701-0.97308-3.6205-1.019zm-46.029 1.9195c-0.80572 0.37916-1.5271 0.94267-2.1538 1.6167l-18.068 19.079h14.835l7.0724-7.2251-0.0053-0.0053c0.70039-0.75832 2.0485-0.6214 2.6015 0.24751l4.6711 6.9829c3.8917-0.15794 10.875 0.61091 14.435-1.2112l-12.681-16.588-7.4516-1.3007c-1.2323-0.20012-2.3592-0.76359-3.2545-1.5956zm51.861 2.1328c-1.7136-0.05306-3.4427 1.31-3.4072 3.186l-0.0685 5.7032c-0.11058 9.8739-8.305 17.91-18.247 17.91-1.7379-0.21065-3.4072 1.0059-3.3914 2.8068 0 1.5641 1.2691 2.8174 2.8279 2.8069h4.8238c11.333 0 20.538-9.137 20.538-20.38v-8.7997c0.0105-1.0848-0.54769-2.0959-1.4376-2.6699l5e-3 -0.0053c-0.5016-0.36599-1.0718-0.54053-1.643-0.55822z"/></svg>
                        <span class="rest-btn-text">Short Rest</span>
                    </button>
                    <button class="rest-btn long-rest" onclick="longRest()">
                        <svg viewBox="0 0 100 100" fill="currentColor" width="18" height="18"><path d="m90.123 28c-13.16 0.41602-13.176 19.369 0 19.774 13.181-0.40549 13.16-19.358 0-19.774zm-44.401 17.202c-2.2753 0.10336-3.8862 2.9801-2.3303 4.8843 0.44762 0.67406 1.1428 1.1006 1.9748 1.2586l30.212 5.3188c0.57928-2.2223 1.8063-4.2392 3.4809-5.7243l-32.613-5.6769c-0.24685-0.05282-0.48872-0.07125-0.7241-0.06056zm41.839 5.9507c-3.7511-0.13775-7.578 2.2421-8.6128 6.0218-1.0585 3.2493-2.0328 6.6038-3.4125 9.8108-2.8858 6.2351-9.7683 10.222-16.699 10.143h-54.067c-6.286 0.12109-6.4297 9.395-0.0053 9.5633h60.445c-1.3849-4.1234 2.1432-8.4468 6.4668-8.0572 8.1256 0 14.793-6.5305 14.882-14.587l0.06846-5.7032c0.02107-2.8753 1.9327-5.3188 4.5552-6.1719-1.127-0.64642-2.3701-0.97308-3.6205-1.019zm-46.029 1.9195c-0.80572 0.37916-1.5271 0.94267-2.1538 1.6167l-18.068 19.079h14.835l7.0724-7.2251-0.0053-0.0053c0.70039-0.75832 2.0485-0.6214 2.6015 0.24751l4.6711 6.9829c3.8917-0.15794 10.875 0.61091 14.435-1.2112l-12.681-16.588-7.4516-1.3007c-1.2323-0.20012-2.3592-0.76359-3.2545-1.5956zm51.861 2.1328c-1.7136-0.05306-3.4427 1.31-3.4072 3.186l-0.0685 5.7032c-0.11058 9.8739-8.305 17.91-18.247 17.91-1.7379-0.21065-3.4072 1.0059-3.3914 2.8068 0 1.5641 1.2691 2.8174 2.8279 2.8069h4.8238c11.333 0 20.538-9.137 20.538-20.38v-8.7997c0.0105-1.0848-0.54769-2.0959-1.4376-2.6699l5e-3 -0.0053c-0.5016-0.36599-1.0718-0.54053-1.643-0.55822z"/></svg>
                        <span class="rest-btn-text">Long Rest</span>
                    </button>
                </div>
            </div>
        </div>

        <!-- ABILITIES -->
        <div class="section">
            <div class="section-header" onclick="toggleSection(this)">
                <div class="section-title"><svg viewBox="0 0 24 24" fill="currentColor"><path d="M12 3L1 9l4 2.18v6L12 21l7-3.82v-6l2-1.09V17h2V9L12 3zm6.82 6L12 12.72 5.18 9 12 5.28 18.82 9zM17 15.99l-5 2.73-5-2.73v-3.72L12 15l5-2.73v3.72z"/></svg><span>Abilities & Skills</span></div>
                <div class="section-toggle"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="6 9 12 15 18 9"/></svg></div>
            </div>
            <div class="section-content">
                <div class="abilities-grid" id="abilitiesGrid"></div>
            </div>
        </div>

        <!-- WEAPONS -->
        <div class="section">
            <div class="section-header" onclick="toggleSection(this)">
                <div class="section-title"><svg viewBox="0 0 24 24" fill="currentColor"><path d="M6.92 5H5L14 14l-1.5 1.5 1.42 1.42 1.5-1.5L19 19l-2.5 2.5L14 19l-6.5 6.5-3-3L11 16l-1.5-1.5L3 21 1 19l8-8L2 4l2-2 7 7 5-5H14L12 2l2.5-2.5L17 2l-5 5 7 7-2 2L10 9l-3.08-4z"/></svg><span>Weapons & Cantrips</span></div>
                <div class="section-toggle"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="6 9 12 15 18 9"/></svg></div>
            </div>
            <div class="section-content">
                <div class="weapons-list" id="weaponsList"></div>
                <div class="weapon-add-buttons">
                    <button class="add-btn picker-btn" onclick="openWeaponPicker()">
                        <svg viewBox="0 0 100 100" fill="currentColor" width="16" height="16"><path d="m1.7145 1.1695c-0.5645-0.0035307-1.118 0.27296-1.452 0.78783-0.29678 0.45766-0.33378 1.0376-0.15158 1.5516l5.5141 15.569 5.4842 15.483v6.66e-4l0.54647 1.5444c0.22983 0.64952 0.82733 1.0972 1.5151 1.1365l1.6355 0.09433 15.819 0.90819 7.0885 10.853c0.92032 1.4093 2.8663 1.6989 4.1577 0.61933 0.09826-0.08193 0.1646-0.13988 0.19191-0.16719l47.843 47.843c0.87135 0.87102 2.0131 1.307 3.1552 1.307 1.1422 0 2.2839-0.43563 3.1552-1.307 1.7427-1.7427 1.7427-4.5677 0-6.3104l-47.842-47.843c6.67e-4 -9.99e-4 2e-3 -0.0013 0.0033-0.0027 1.2737-1.2674 1.0564-3.3874-0.45344-4.3614l-10.851-6.9993-1.0071-17.53c-0.03964-0.68782-0.48734-1.2843-1.1365-1.5145l-1.5444-0.54712h-6.66e-4l-31.11-11.018c-0.18286-0.064786-0.37196-0.097065-0.56013-0.098234zm68.871 0.54517c-5.8708-0.17989-12.507 2.512-17.778 7.7833-6.4212 6.4212-9.0112 14.866-7.2492 21.487l3.5455 2.2926c1.4699-2.2717 3.8244-3.8607 6.5283-4.3477 3.1333-0.56425 6.3409 0.422 8.6192 2.638l-9.9997 9.9926 5.9006 5.883 9.9874-9.9881c2.217 2.2786 3.2062 5.4862 2.6419 8.6206-0.48764 2.708-2.4524 5.5648-5.1401 7.2219-0.61254 0.37772-0.61001 1.267 0.0052 1.6401v6.66e-4c6.8892 3.7169 17.095 1.4293 24.563-6.0385 7.6666-7.6673 9.8764-18.223 5.7301-25.11-0.14456-0.24016-0.4098-0.38127-0.68959-0.36562-0.28012 0.01565-0.52812 0.18529-0.6447 0.44043l-0.01692 0.03578c-1.1028 2.2623-2.966 4.1026-5.3073 5.0269-3.6849 1.4549-7.7743 0.5693-10.516-2.0981l2.5235-2.8716c0.442-0.44167 0.74886-1.0003 0.88476-1.6101l1.2224-5.4829c0.05629-0.25248-0.02075-0.51617-0.20362-0.6987-0.18286-0.18286-0.4459-0.25926-0.69805-0.20298l-5.4829 1.2224c-0.60988 0.1359-1.1688 0.44309-1.6108 0.88476l-2.5229 2.8709c-2.2167-2.2786-3.2058-5.4862-2.6413-8.6206 0.57224-3.1793 2.6664-5.8766 5.6046-7.2193 3.33e-4 -3.331e-4 9.99e-4 -3.174e-4 0.0013-6.662e-4 0.25483-0.11658 0.42415-0.36426 0.4398-0.64405 0.015655-0.27979-0.12481-0.54569-0.36496-0.69024-2.1521-1.2957-4.6626-1.9707-7.3312-2.0525zm-30.226 53.738-5.7691 5.775c-2.6157-0.62887-5.4993 0.05518-7.5276 2.1104-2.2433 2.2731-6.8218 6.8198-6.8218 6.8198l0.0013 2e-3 -15.025 15.024c-3.1217 3.122-3.1217 8.1834 0 11.305 1.5608 1.5612 3.6072 2.3414 5.6533 2.3414 2.0461 0 4.0915-0.78052 5.6527-2.3414l21.844-21.846c2.0383-2.0453 2.7393-4.9119 2.1104-7.5276l5.788-5.788z"/></svg>
                        <span>Add Weapon</span>
                    </button>
                    <button class="add-btn dashed compact" onclick="addWeapon()">
                        <svg viewBox="0 0 100 100" fill="currentColor" width="14" height="14"><path d="m49.914 0-43.258 25.075 0.0863 50 43.345 24.925 43.258-25.075-0.08682-50zm-4.5548 24.535h9.2821v20.785h20.359v9.3607h-20.359v20.785h-9.2821v-20.785h-20.359v-9.3607h20.359z"/></svg>
                        <span>Custom</span>
                    </button>
                </div>
            </div>
        </div>

        <!-- FEATURES -->
        <div class="section">
            <div class="section-header" onclick="toggleSection(this)">
                <div class="section-title"><svg viewBox="0 0 24 24" fill="currentColor"><path d="M12 17.27L18.18 21l-1.64-7.03L22 9.24l-7.19-.61L12 2 9.19 8.63 2 9.24l5.46 4.73L5.82 21z"/></svg><span>Class Features</span></div>
                <div class="section-toggle"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="6 9 12 15 18 9"/></svg></div>
            </div>
            <div class="section-content">
                <textarea class="text-area" id="classFeatures" placeholder="Class features, abilities, actions..." oninput="autoSave()"></textarea>
                <div class="field-label" style="margin-top:16px;">Class Resources</div>
                <div class="resources-list" id="resourcesList"></div>
                <button class="add-btn dashed compact" onclick="addResource()">
                    <svg viewBox="0 0 100 100" fill="currentColor" width="14" height="14"><path d="m49.914 0-43.258 25.075 0.0863 50 43.345 24.925 43.258-25.075-0.08682-50zm-4.5548 24.535h9.2821v20.785h20.359v9.3607h-20.359v20.785h-9.2821v-20.785h-20.359v-9.3607h20.359z"/></svg>
                    <span>Add Resource</span>
                </button>
            </div>
        </div>

        <!-- TRAINING -->
        <div class="section">
            <div class="section-header" onclick="toggleSection(this)">
                <div class="section-title"><svg viewBox="0 0 24 24" fill="currentColor"><path d="M18 2H6c-1.1 0-2 .9-2 2v16c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zM6 4h5v8l-2.5-1.5L6 12V4z"/></svg><span>Training & Proficiencies</span></div>
                <div class="section-toggle"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="6 9 12 15 18 9"/></svg></div>
            </div>
            <div class="section-content">
                <div class="training-grid">
                    <div class="training-group"><div class="training-label">Armor</div><div class="training-checks"><label class="training-item"><input type="checkbox" id="armorLight" onchange="autoSave()"><span>Light</span></label><label class="training-item"><input type="checkbox" id="armorMedium" onchange="autoSave()"><span>Medium</span></label><label class="training-item"><input type="checkbox" id="armorHeavy" onchange="autoSave()"><span>Heavy</span></label><label class="training-item"><input type="checkbox" id="armorShields" onchange="autoSave()"><span>Shields</span></label></div></div>
                    <div class="training-group"><div class="training-label">Weapons</div><div class="training-checks"><label class="training-item"><input type="checkbox" id="weaponSimple" onchange="autoSave()"><span>Simple</span></label><label class="training-item"><input type="checkbox" id="weaponMartial" onchange="autoSave()"><span>Martial</span></label><label class="training-item"><input type="checkbox" id="weaponFirearms" onchange="autoSave()"><span>Firearms</span></label></div></div>
                </div>
                <div class="field-group" style="margin-top:14px;"><div class="field-label">Specific Weapons</div><textarea class="text-area" id="weaponsText" style="min-height:60px;" placeholder="Specific weapons (e.g. Longsword, Rapier, Hand Crossbow)" oninput="autoSave()"></textarea></div>
                <div class="field-group" style="margin-top:14px;"><div class="field-label">Tools & Other Training</div><textarea class="text-area" id="tools" style="min-height:80px;" oninput="autoSave()"></textarea></div>
            </div>
        </div>

        <!-- SPECIES & FEATS -->
        <div class="section">
            <div class="section-header" onclick="toggleSection(this)">
                <div class="section-title"><svg viewBox="0 0 24 24" fill="currentColor"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-2h2v2zm0-4h-2V7h2v6z"/></svg>Species Traits &amp; Feats</div>
                <div class="section-toggle"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="6 9 12 15 18 9"/></svg></div>
            </div>
            <div class="section-content">
                <div class="field-group"><div class="field-label">Senses</div><input type="text" class="field-input" id="senses" placeholder="Darkvision 60 ft., ..." oninput="autoSave()"></div>
                <div class="narrative-grid">
                    <div><div class="field-label">Species Traits</div><textarea class="text-area" id="speciesTraits" placeholder="Racial abilities, features..." oninput="autoSave()"></textarea></div>
                    <div><div class="field-label">Feats</div><textarea class="text-area" id="feats" placeholder="Selected feats..." oninput="autoSave()"></textarea></div>
                </div>
            </div>
        </div>

        <!-- SPELLCASTING -->
        <div class="section">
            <div class="section-header" onclick="toggleSection(this)">
                <div class="section-title"><svg viewBox="0 0 24 24" fill="currentColor"><path d="M12 3v1.27c0 .6.4 1.13.98 1.3l.02.01c.88.26 1.52 1.09 1.52 2.02 0 .93-.64 1.76-1.52 2.02l-.02.01c-.58.17-.98.7-.98 1.3V12l3.3 3.3c.17.17.3.39.3.63v4.07c0 .55-.45 1-1 1h-4.6c-.55 0-1-.45-1-1v-4.07c0-.24.13-.46.3-.63L12 12v-.87c0-.6-.4-1.13-.98-1.3l-.02-.01c-.88-.26-1.52-1.09-1.52-2.02 0-.93.64-1.76 1.52-2.02l.02-.01c.58-.17.98-.7.98-1.3V3h2z"/></svg><span>Spellcasting</span></div>
                <div class="section-toggle"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="6 9 12 15 18 9"/></svg></div>
            </div>
            <div class="section-content">
                <div class="spell-stats">
                    <div class="spell-stat">
                        <div class="spell-stat-label">Spellcasting Ability</div>
                        <select class="spell-stat-select" id="spellAbility" onchange="updateSpellStats(); autoSave()">
                            <option value="" disabled selected>Select</option>
                            <option value="int">INT</option>
                            <option value="wis">WIS</option>
                            <option value="cha">CHA</option>
                        </select>
                    </div>
                    <div class="spell-stat">
                        <div class="spell-stat-label">Spell Modifier</div>
                        <span class="spell-stat-value" id="spellMod">+0</span>
                        <div class="stat-hint">Attributsmod.</div>
                    </div>
                    <div class="spell-stat" title="8 + Proficiency Bonus + Spellcasting Modifier">
                        <div class="spell-stat-label">Spell Save DC</div>
                        <span class="spell-stat-value" id="spellDC">10</span>
                        <div class="stat-hint" id="spellDCHint">8 + Prof + Mod</div>
                    </div>
                    <div class="spell-stat" title="Proficiency Bonus + Spellcasting Modifier">
                        <div class="spell-stat-label">Spell Attack</div>
                        <span class="spell-stat-value" id="spellAttack">+2</span>
                        <div class="stat-hint" id="spellAttackHint">Prof + Mod</div>
                    </div>
                </div>
                <div class="pact-slots-section" id="pactSlotsSection">
                    <div class="field-label">Pact Slots (Warlock)</div>
                    <div class="pact-slots-row">
                        <div class="pact-slot-item">
                            <span class="pact-label" title="Spell slot level for Pact Magic">Level</span>
                            <input type="number" class="pact-input" id="pactLevel" min="1" max="5" placeholder="–" oninput="autoSave()">
                        </div>
                        <div class="pact-slot-item">
                            <span class="pact-label">Total</span>
                            <input type="number" class="pact-input" id="pactTotal" min="0" max="4" placeholder="–" oninput="autoSave()">
                        </div>
                        <div class="pact-slot-item">
                            <span class="pact-label">Expended</span>
                            <input type="number" class="pact-input" id="pactExpended" min="0" max="4" placeholder="0" oninput="autoSave()">
                        </div>
                    </div>
                    <div class="pact-hint">Short Rest Recovery • Level = Spell Level when cast</div>
                </div>
                <div class="field-label" style="display:flex;justify-content:space-between;align-items:center;">
                    <span>Spell Slots</span>
                    <button class="slot-restore-btn" onclick="restoreAllSlots()" title="Restore all spell slots (Long Rest)">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="14" height="14"><path d="M1 4v6h6M23 20v-6h-6"/><path d="M20.49 9A9 9 0 0 0 5.64 5.64L1 10m22 4l-4.64 4.36A9 9 0 0 1 3.51 15"/></svg>
                    </button>
                </div>
                <div class="slots-grid" id="slotsGrid"></div>
                
                <!-- Concentration Banner -->
                <div class="concentration-banner" id="concentrationBanner">
                    <span class="conc-icon">🎯</span>
                    <span>Concentrating on: <span class="conc-spell" id="concSpellName">-</span></span>
                    <button class="conc-break" onclick="breakConcentration()">Break</button>
                </div>
                
                <!-- Prepared Spells Section (Level 1-9 only) -->
                <div class="field-label">Prepared Spells <span class="spell-level-hint">(Level 1-9)</span></div>
                <div class="spells-list" id="spellsList"></div>
                <div class="weapon-add-buttons">
                    <button class="add-btn picker-btn" onclick="openSpellPicker()">
                        <svg viewBox="0 0 100 100" fill="currentColor" width="16" height="16"><path d="m61.185 0c-0.02192 1.49e-4 -0.04016 0.03243-0.05448 0.09686-0.06118 0.2753-0.29878 1.417-0.52817 2.5379-0.70496 3.4443-1.662 5.9093-2.6378 6.7981-1.147 1.0446-4.199 2.1202-7.977 2.8088l-1.9023 0.34656 1.9023 0.35262c3.7743 0.70039 6.4876 1.6164 7.6698 2.5909 1.2875 1.0611 2.3823 3.8181 3.1342 7.8878 0.12206 0.66064 0.27224 1.4258 0.33446 1.701h0.0015c0.07654 0.33869 0.29228-0.37317 0.66736-2.202 0.64933-3.1658 1.3888-5.3875 2.1657-6.506 0.98158-1.4131 3.5667-2.4969 8.0754-3.3839l2.2746-0.44796-1.3-0.23912c-2.8033-0.5159-5.7617-1.3635-7.1023-2.034-1.2044-0.60237-1.4996-0.8586-2.0643-1.8024-0.79407-1.3273-1.5074-3.5412-2.1354-6.6211-0.26024-1.2764-0.42866-1.8848-0.52363-1.8842z"/></svg>
                        <span>Add Spell</span>
                    </button>
                    <button class="add-btn dashed compact" onclick="addSpell()">
                        <svg viewBox="0 0 100 100" fill="currentColor" width="14" height="14"><path d="m49.914 0-43.258 25.075 0.0863 50 43.345 24.925 43.258-25.075-0.08682-50zm-4.5548 24.535h9.2821v20.785h20.359v9.3607h-20.359v20.785h-9.2821v-20.785h-20.359v-9.3607h20.359z"/></svg>
                        <span>Custom</span>
                    </button>
                </div>
            </div>
        </div>

        <!-- EQUIPMENT & BACKSTORY -->
        <div class="section">
            <div class="section-header" onclick="toggleSection(this)">
                <div class="section-title"><svg viewBox="0 0 24 24" fill="currentColor"><path d="M19 7h-3V6a4 4 0 0 0-8 0v1H5a1 1 0 0 0-1 1v12a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8a1 1 0 0 0-1-1zm-9-1a2 2 0 0 1 4 0v1h-4V6zm9 14H5V9h14v11z"/></svg><span>Equipment & Notes</span></div>
                <div class="section-toggle"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="6 9 12 15 18 9"/></svg></div>
            </div>
            <div class="section-content">
                <div class="field-label" style="margin-bottom:8px;">Coins</div>
                <div class="coins-row">
                    <div class="coin coin-cp"><span class="coin-label">CP</span><input type="number" class="coin-input" id="cp" placeholder="0" oninput="autoSave()"></div>
                    <div class="coin coin-sp"><span class="coin-label">SP</span><input type="number" class="coin-input" id="sp" placeholder="0" oninput="autoSave()"></div>
                    <div class="coin coin-primary coin-gp"><span class="coin-label">GP</span><input type="number" class="coin-input" id="gp" placeholder="0" oninput="autoSave()"></div>
                    <div class="coin coin-ep"><span class="coin-label">EP</span><input type="number" class="coin-input" id="ep" placeholder="0" oninput="autoSave()"></div>
                    <div class="coin coin-pp"><span class="coin-label">PP</span><input type="number" class="coin-input" id="pp" placeholder="0" oninput="autoSave()"></div>
                </div>
                
                <!-- GM Coins Box -->
                <div class="gm-coins-box" id="gmCoinsBox" style="display:none;">
                    <div class="field-label" style="margin-bottom:8px;display:flex;align-items:center;gap:6px;">
                        <svg viewBox="0 0 24 24" width="14" height="14" fill="currentColor" style="opacity:0.6;"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 3c1.66 0 3 1.34 3 3s-1.34 3-3 3-3-1.34-3-3 1.34-3 3-3zm0 14.2c-2.5 0-4.71-1.28-6-3.22.03-1.99 4-3.08 6-3.08 1.99 0 5.97 1.09 6 3.08-1.29 1.94-3.5 3.22-6 3.22z"/></svg>
                        GM Coins
                    </div>
                    <div class="coins-row gm-coins">
                        <div class="coin coin-cp"><span class="coin-label">CP</span><input type="number" class="coin-input" id="gm-cp" placeholder="0" oninput="autoSave()" readonly></div>
                        <div class="coin coin-sp"><span class="coin-label">SP</span><input type="number" class="coin-input" id="gm-sp" placeholder="0" oninput="autoSave()" readonly></div>
                        <div class="coin coin-primary coin-gp"><span class="coin-label">GP</span><input type="number" class="coin-input" id="gm-gp" placeholder="0" oninput="autoSave()" readonly></div>
                        <div class="coin coin-ep"><span class="coin-label">EP</span><input type="number" class="coin-input" id="gm-ep" placeholder="0" oninput="autoSave()" readonly></div>
                        <div class="coin coin-pp"><span class="coin-label">PP</span><input type="number" class="coin-input" id="gm-pp" placeholder="0" oninput="autoSave()" readonly></div>
                    </div>
                    <div class="gm-coins-hint">Assigned by GM • Read only</div>
                </div>
                
                <div class="narrative-grid equip-grid">
                    <div class="equip-col">
                        <div class="field-group"><div class="field-label">Languages</div><input type="text" class="field-input" id="languages" placeholder="Common, Elvish, ..." oninput="autoSave()"></div>
                        <div class="field-group"><div class="field-label">Equipment</div><textarea class="text-area equip-area" id="equipment" placeholder="Items, gear, supplies..." oninput="autoSave()"></textarea></div>
                        <div class="field-group">
                            <div class="field-label">Attunement Slots (0-3)</div>
                            <div class="attunement-slots" id="attunementSlots">
                                <div class="attunement-slot" id="attune0" onclick="toggleAttunement(0)"></div>
                                <div class="attunement-slot" id="attune1" onclick="toggleAttunement(1)"></div>
                                <div class="attunement-slot" id="attune2" onclick="toggleAttunement(2)"></div>
                            </div>
                        </div>
                    </div>
                    <div class="equip-col">
                        <div class="field-group"><div class="field-label">Alignment</div><input type="text" class="field-input" id="alignment" oninput="autoSave()"></div>
                        <div class="field-group"><div class="field-label">Physical Characteristics</div><div class="physical-grid"><input type="text" class="phys-input" id="physAge" placeholder="Age" oninput="autoSave()"><input type="text" class="phys-input" id="physHeight" placeholder="Height" oninput="autoSave()"><input type="text" class="phys-input phys-dimmed" id="physWeight" placeholder="Weight" oninput="autoSave()"><input type="text" class="phys-input" id="physEyes" placeholder="Eyes" oninput="autoSave()"><input type="text" class="phys-input" id="physHair" placeholder="Hair" oninput="autoSave()"><input type="text" class="phys-input" id="physSkin" placeholder="Skin" oninput="autoSave()"></div></div>
                        <div class="field-group"><div class="field-label">Appearance</div><textarea class="text-area equip-area" id="appearance" placeholder="Physical description..." oninput="autoSave()"></textarea></div>
                        <div class="field-group"><div class="field-label">Background &amp; Personality</div><textarea class="text-area" id="backstory" placeholder="History, traits, ideals, bonds, flaws..." oninput="autoSave()"></textarea></div>
                    </div>
                </div>
                
                <!-- Action Buttons (wie bei Worlds Apart) -->
                <div class="action-buttons">
                    <button class="action-btn" onclick="document.getElementById('jsonUpload').click()">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                            <polyline points="17 8 12 3 7 8"/>
                            <line x1="12" y1="3" x2="12" y2="15"/>
                        </svg>
                        Import
                    </button>
                    <button class="action-btn" onclick="downloadJSON()">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                            <polyline points="7 10 12 15 17 10"/>
                            <line x1="12" y1="15" x2="12" y2="3"/>
                        </svg>
                        Export
                    </button>
                    <button class="action-btn danger" onclick="resetSheet()">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <polyline points="3 6 5 6 21 6"/>
                            <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/>
                        </svg>
                        Reset
                    </button>
                </div>
                <input type="file" id="jsonUpload" accept=".json" style="display:none;" onchange="uploadJSON(event)">
            </div>
        </div>

        <!-- QUICK REFERENCE -->
        <div class="section collapsed">
            <div class="section-header" onclick="toggleSection(this)">
                <div class="section-title"><svg viewBox="0 0 24 24" fill="currentColor"><path d="M11 18h2v-2h-2v2zm1-16C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8zm0-14c-2.21 0-4 1.79-4 4h2c0-1.1.9-2 2-2s2 .9 2 2c0 2-3 1.75-3 5h2c0-2.25 3-2.5 3-5 0-2.21-1.79-4-4-4z"/></svg>Quick Reference</div>
                <div class="section-toggle"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="6 9 12 15 18 9"/></svg></div>
            </div>
            <div class="section-content">
                <div class="reference-grid" id="quickRefGrid"></div>
            </div>
        </div>

        <!-- RULES COMPATIBILITY NOTICE -->
        <div class="section collapsed">
            <div class="section-header" onclick="toggleSection(this)">
                <div class="section-title"><svg viewBox="0 0 24 24" fill="currentColor"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-6h2v6zm0-8h-2V7h2v2z"/></svg><span>Rules Compatibility & Licensing</span></div>
                <div class="section-toggle"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="6 9 12 15 18 9"/></svg></div>
            </div>
            <div class="section-content">
                <div class="rules-notice" id="rulesNoticeContent">
                    <p><strong>Rules Compatibility & Licensing Notice</strong></p>
                    <p>This character sheet makes use of game mechanics, rules terminology, and other content derived from the System Reference Document 5.2.1 (SRD), published by Wizards of the Coast LLC and licensed under the Creative Commons Attribution 4.0 International License (CC-BY-4.0).</p>
                    <p>The System Reference Document is made available by Wizards of the Coast under an open license to allow the use, modification, and redistribution of the covered material, provided that proper attribution is given. This application complies with the attribution requirements of the CC-BY-4.0 license.</p>
                    <p>Dungeons & Dragons, D&D, and all related trademarks, product names, and brand identifiers are trademarks or registered trademarks of Wizards of the Coast LLC.</p>
                    <p>RIFT is an independent project and is not affiliated with, endorsed by, sponsored by, or approved by Wizards of the Coast LLC in any way. The use of SRD content does not imply any partnership, endorsement, or official status.</p>
                    <p>Any content not explicitly derived from the System Reference Document remains the intellectual property of its respective creators.</p>
                    <hr style="border:none;border-top:1px solid var(--md-outline-variant);margin:16px 0;">
                    <p><strong>Note on Terminology</strong></p>
                    <p>Terms and labels in this character sheet follow the official System Reference Document (SRD 5.2.1) where applicable translations exist.</p>
                    <p>Terms without inherent game mechanics (e.g., section or UI labels) have been translated for clarity.</p>
                    <p>Certain technical terms that are not clearly defined in the SRD or serve as standalone rule terms (e.g., "Feat") are intentionally kept in their original English form.</p>
                    <hr style="border:none;border-top:1px solid var(--md-outline-variant);margin:16px 0;">
                    <p><a href="https://www.dndbeyond.com/srd" target="_blank" rel="noopener">System Reference Document (SRD 5.2.1) ↗</a><br>
                    <a href="https://creativecommons.org/licenses/by/4.0/" target="_blank" rel="noopener">Creative Commons Attribution 4.0 International License ↗</a></p>
                </div>
            </div>
        </div>
    </div>
    
            </div><!-- .main__content -->
        </main>
    </div><!-- .app -->

    <!-- External Libraries -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.6.1/cropper.min.js"></script>
    
    <!-- V2 Layout Scripts -->
    <script src="assets/js/ui.js"></script>
    <script src="assets/js/layout.js"></script>
    <script src="assets/js/settings.js"></script>
    <script src="assets/js/transitions.js"></script>
    <script src="assets/js/character-storage.js"></script>
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    
    <!-- RIFT Services -->
    <script src="assets/js/firebase-config.js"></script>
    <script src="assets/js/room-service.js"></script>
    <script src="assets/js/user-service.js"></script>
    
    <script src="assets/js/auth.js"></script>
    <script src="assets/js/app.js"></script>

    <script>
        'use strict';

        // SRD_TERMS_DE dictionary removed - language fixed

        // UI_TEXTS dictionary removed - language fixed

        // Get current language
        function getLang() { return 'en'; }
        
        // Set language and update UI
        function setLanguage(lang) { /* Language fixed */ }
        
        // Get translated text
        function t(key) { return key; }

        // Translate term (SRD terms only - for backward compatibility)
        function term(en) { return en; }
        
        // Apply language to all UI elements
        function applyLanguage() {
            const lang = getLang();
            
            // Update all elements with data-i18n-text attribute
            document.querySelectorAll('[data-i18n-text]').forEach(el => {
                const key = el.dataset.i18nText;
                if (UI_TEXTS[key]) {
                    el.textContent = UI_TEXTS[key][lang] || UI_TEXTS[key].en;
                }
            });
            
            // Update all elements with data-i18n-placeholder attribute
            document.querySelectorAll('[data-i18n-placeholder]').forEach(el => {
                const key = el.dataset.i18nPlaceholder;
                if (UI_TEXTS[key]) {
                    el.placeholder = UI_TEXTS[key][lang] || UI_TEXTS[key].en;
                }
            });
            
            // Update all elements with data-i18n-title attribute
            document.querySelectorAll('[data-i18n-title]').forEach(el => {
                const key = el.dataset.i18nTitle;
                if (UI_TEXTS[key]) {
                    el.title = UI_TEXTS[key][lang] || UI_TEXTS[key].en;
                }
            });
            
            // Rebuild dynamic content
            rebuildAbilitiesGrid();
            rebuildConditions();
            updateHelpIconsButton();
            applySettingsI18n();
            applyWizardI18n();
            applyTemplatesI18n();
            applyDropdownI18n();
        }
        
        // Initialize language on page load
        function initLanguage() { /* Fixed */ }
        
        // Apply language to Wizard Modal
        function applyWizardI18n() {
            const lang = getLang();
            
            // Wizard Title
            const wizardTitle = document.querySelector('#wizardModal .wizard-header h2');
            if (wizardTitle) wizardTitle.textContent = t('wizard-title');
            
            // Step 1
            const step1 = document.querySelector('.wizard-step[data-step="1"]');
            if (step1) {
                const h3 = step1.querySelector('h3');
                const p = step1.querySelector('p');
                const labels = step1.querySelectorAll('label');
                const nameInput = step1.querySelector('#wizardName');
                if (h3) h3.textContent = t('wizard-step1-title');
                if (p) p.textContent = t('wizard-step1-desc');
                if (labels[0]) labels[0].textContent = t('wizard-label-name');
                if (labels[1]) labels[1].textContent = t('wizard-label-level');
                if (nameInput) nameInput.placeholder = t('wizard-name-placeholder');
            }
            
            // Step 2: Species
            const step2 = document.querySelector('.wizard-step[data-step="2"]');
            if (step2) {
                const h3 = step2.querySelector('h3');
                const p = step2.querySelector('p');
                if (h3) h3.textContent = t('wizard-step2-title');
                if (p) p.textContent = t('wizard-step2-desc');
                
                // Species names and descriptions
                const speciesMap = {
                    'Human': { name: term('Human'), desc: 'species-human-desc' },
                    'Elf': { name: term('Elf'), desc: 'species-elf-desc' },
                    'Dwarf': { name: term('Dwarf'), desc: 'species-dwarf-desc' },
                    'Halfling': { name: term('Halfling'), desc: 'species-halfling-desc' },
                    'Dragonborn': { name: term('Dragonborn'), desc: 'species-dragonborn-desc' },
                    'Tiefling': { name: term('Tiefling'), desc: 'species-tiefling-desc' },
                    'Gnome': { name: term('Gnome'), desc: 'species-gnome-desc' },
                    'Half-Orc': { name: 'Half-Orc', desc: 'species-halforc-desc' }
                };
                step2.querySelectorAll('.wizard-option').forEach(opt => {
                    const val = opt.dataset.value;
                    if (speciesMap[val]) {
                        const nameEl = opt.querySelector('.wizard-option-name');
                        const descEl = opt.querySelector('.wizard-option-desc');
                        if (nameEl) nameEl.textContent = speciesMap[val].name;
                        if (descEl) descEl.textContent = t(speciesMap[val].desc);
                    }
                });
            }
            
            // Step 3: Class
            const step3 = document.querySelector('.wizard-step[data-step="3"]');
            if (step3) {
                const h3 = step3.querySelector('h3');
                const p = step3.querySelector('p');
                if (h3) h3.textContent = t('wizard-step3-title');
                if (p) p.textContent = t('wizard-step3-desc');
                
                const classMap = {
                    'Fighter': { name: term('Fighter'), desc: 'class-fighter-desc' },
                    'Wizard': { name: term('Wizard'), desc: 'class-wizard-desc' },
                    'Rogue': { name: term('Rogue'), desc: 'class-rogue-desc' },
                    'Cleric': { name: term('Cleric'), desc: 'class-cleric-desc' },
                    'Barbarian': { name: term('Barbarian'), desc: 'class-barbarian-desc' },
                    'Bard': { name: term('Bard'), desc: 'class-bard-desc' },
                    'Paladin': { name: term('Paladin'), desc: 'class-paladin-desc' },
                    'Ranger': { name: term('Ranger'), desc: 'class-ranger-desc' },
                    'Sorcerer': { name: term('Sorcerer'), desc: 'class-sorcerer-desc' },
                    'Warlock': { name: term('Warlock'), desc: 'class-warlock-desc' },
                    'Druid': { name: term('Druid'), desc: 'class-druid-desc' },
                    'Monk': { name: term('Monk'), desc: 'class-monk-desc' }
                };
                step3.querySelectorAll('.wizard-option').forEach(opt => {
                    const val = opt.dataset.value;
                    if (classMap[val]) {
                        const nameEl = opt.querySelector('.wizard-option-name');
                        const descEl = opt.querySelector('.wizard-option-desc');
                        if (nameEl) nameEl.textContent = classMap[val].name;
                        if (descEl) descEl.textContent = t(classMap[val].desc);
                    }
                });
            }
            
            // Step 4: Background
            const step4 = document.querySelector('.wizard-step[data-step="4"]');
            if (step4) {
                const h3 = step4.querySelector('h3');
                const p = step4.querySelector('p');
                if (h3) h3.textContent = t('wizard-step4-title');
                if (p) p.textContent = t('wizard-step4-desc');
                
                const bgMap = {
                    'Soldier': { name: term('Soldier'), desc: 'bg-soldier-desc' },
                    'Criminal': { name: term('Criminal'), desc: 'bg-criminal-desc' },
                    'Sage': { name: term('Sage'), desc: 'bg-sage-desc' },
                    'Acolyte': { name: term('Acolyte'), desc: 'bg-acolyte-desc' },
                    'Noble': { name: term('Noble'), desc: 'bg-noble-desc' },
                    'Folk Hero': { name: term('Folk Hero'), desc: 'bg-folkhero-desc' },
                    'Entertainer': { name: term('Entertainer'), desc: 'bg-entertainer-desc' },
                    'Hermit': { name: term('Hermit'), desc: 'bg-hermit-desc' }
                };
                step4.querySelectorAll('.wizard-option').forEach(opt => {
                    const val = opt.dataset.value;
                    if (bgMap[val]) {
                        const nameEl = opt.querySelector('.wizard-option-name');
                        const descEl = opt.querySelector('.wizard-option-desc');
                        if (nameEl) nameEl.textContent = bgMap[val].name;
                        if (descEl) descEl.textContent = t(bgMap[val].desc);
                    }
                });
            }
            
            // Step 5: Abilities
            const step5 = document.querySelector('.wizard-step[data-step="5"]');
            if (step5) {
                const h3 = step5.querySelector('h3');
                const p = step5.querySelector('p');
                if (h3) h3.textContent = t('wizard-step5-title');
                if (p) p.textContent = t('wizard-step5-desc');
                
                const labels = step5.querySelectorAll('.wizard-ability-item label');
                const abilityNames = ['Strength', 'Dexterity', 'Constitution', 'Intelligence', 'Wisdom', 'Charisma'];
                labels.forEach((lbl, i) => {
                    if (abilityNames[i]) lbl.textContent = term(abilityNames[i]);
                });
                
                const stdArrayBtn = step5.querySelector('.new-char-btn');
                if (stdArrayBtn) stdArrayBtn.textContent = t('wizard-apply-standard');
            }
            
            // Wizard Buttons
            const backBtn = document.getElementById('wizardBack');
            const nextBtn = document.getElementById('wizardNext');
            if (backBtn) backBtn.textContent = t('wizard-back');
            if (nextBtn && !nextBtn.textContent.includes('Create') && !nextBtn.textContent.includes('erstellen')) {
                nextBtn.textContent = t('wizard-next');
            }
        }
        
        // Apply language to Templates Modal
        function applyTemplatesI18n() {
            const lang = getLang();
            
            const modal = document.getElementById('templatesModal');
            if (!modal) return;
            
            const title = modal.querySelector('.wizard-header h2');
            const desc = modal.querySelector('.wizard-body > p');
            const cancelBtn = modal.querySelector('.wizard-btn-back');
            const loadBtn = document.getElementById('templateLoadBtn');
            
            if (title) title.textContent = t('templates-title');
            if (desc) desc.textContent = t('templates-desc');
            if (cancelBtn) cancelBtn.textContent = t('templates-cancel');
            if (loadBtn) loadBtn.textContent = t('templates-load');
        }
        
        // Apply language to Dropdowns in main form
        function applyDropdownI18n() {
            const lang = getLang();
            
            // Species dropdown
            const speciesSelect = document.getElementById('species');
            if (speciesSelect) {
                speciesSelect.querySelectorAll('option').forEach(opt => {
                    if (opt.value === '') {
                        opt.textContent = lang === 'de' ? 'Wählen' : 'Select';
                    } else if (opt.value === 'custom') {
                        opt.textContent = lang === 'de' ? 'Eigene / Andere' : 'Custom / Other';
                    } else {
                        // Use value as key, translate if German
                        opt.textContent = lang === 'de' ? (SRD_TERMS_DE[opt.value] || opt.value) : opt.value;
                    }
                });
            }
            
            // Class dropdown
            const classSelect = document.getElementById('charClass');
            if (classSelect) {
                classSelect.querySelectorAll('option').forEach(opt => {
                    if (opt.value === '') {
                        opt.textContent = lang === 'de' ? 'Wählen' : 'Select';
                    } else if (opt.value === 'custom') {
                        opt.textContent = lang === 'de' ? 'Eigene / Homebrew' : 'Custom / Homebrew';
                    } else {
                        opt.textContent = lang === 'de' ? (SRD_TERMS_DE[opt.value] || opt.value) : opt.value;
                    }
                });
            }
            
            // Background dropdown
            const bgSelect = document.getElementById('background');
            if (bgSelect) {
                bgSelect.querySelectorAll('option').forEach(opt => {
                    if (opt.value === '') {
                        opt.textContent = lang === 'de' ? 'Wählen' : 'Select';
                    } else if (opt.value === 'custom') {
                        opt.textContent = lang === 'de' ? 'Eigene / Andere' : 'Custom / Other';
                    } else {
                        opt.textContent = lang === 'de' ? (SRD_TERMS_DE[opt.value] || opt.value) : opt.value;
                    }
                });
            }
            
            // Subclass dropdown
            const subclassSelect = document.getElementById('subclass');
            if (subclassSelect) {
                subclassSelect.querySelectorAll('option').forEach(opt => {
                    if (opt.value === '') {
                        opt.textContent = lang === 'de' ? 'Wählen' : 'Select';
                    } else if (opt.value === 'custom') {
                        opt.textContent = lang === 'de' ? 'Eigene / Homebrew' : 'Custom / Homebrew';
                    } else {
                        opt.textContent = lang === 'de' ? (SRD_TERMS_DE[opt.value] || opt.value) : opt.value;
                    }
                });
            }
            
            // Meta Chip Labels - direct selection
            document.querySelectorAll('.meta-chip').forEach(chip => {
                const label = chip.querySelector('label');
                const select = chip.querySelector('select');
                const input = chip.querySelector('input[type="number"], input[type="text"]:not(.custom-input)');
                
                if (label) {
                    const id = select?.id || input?.id;
                    const labelMap = {
                        'species': { en: 'Species', de: 'Spezies' },
                        'charClass': { en: 'Class', de: 'Klasse' },
                        'level': { en: 'Level', de: 'Stufe' },
                        'xp': { en: 'XP', de: 'EP' },
                        'background': { en: 'Background', de: 'Hintergrund' },
                        'subclass': { en: 'Subclass', de: 'Unterklasse' }
                    };
                    if (labelMap[id]) {
                        label.textContent = labelMap[id][lang];
                    }
                }
            });
            
            // Custom input placeholders
            const customInputs = {
                'speciesCustom': { en: 'Enter species...', de: 'Spezies eingeben...' },
                'classCustom': { en: 'Enter class...', de: 'Klasse eingeben...' },
                'backgroundCustom': { en: 'Enter background...', de: 'Hintergrund eingeben...' },
                'subclassCustom': { en: 'Enter subclass...', de: 'Unterklasse eingeben...' }
            };
            
            Object.keys(customInputs).forEach(id => {
                const input = document.getElementById(id);
                if (input) input.placeholder = customInputs[id][lang];
            });
        }
        
        // Apply language to settings and UI elements (bidirectional)
        function applySettingsI18n() {
            const lang = getLang();
            
            // Stat hints with bidirectional mapping
            const statHintMappings = [
                { en: 'DEX Mod', de: 'DEX Mod' },
                { en: 'by Level', de: 'nach Stufe' },
                { en: '10 + WIS + Prof', de: '10 + WIS + Übung' },
                { en: '10 + INT + Prof', de: '10 + INT + Übung' },
                { en: '−2 per level', de: '−2 per level' },
                { en: 'Ability Mod', de: 'Attributsmod.' },
                { en: '8 + Prof + Mod', de: '8 + Übung + Mod' },
                { en: 'Prof + Mod', de: 'Übung + Mod' }
            ];
            
            document.querySelectorAll('.stat-hint, .armor-stat-hint').forEach(el => {
                const text = el.textContent.trim();
                const mapping = statHintMappings.find(m => m.en === text || m.de === text);
                if (mapping) {
                    el.textContent = lang === 'de' ? mapping.de : mapping.en;
                }
            });
            
            // Spell stat hints
            const spellDCHint = document.getElementById('spellDCHint');
            const spellAttackHint = document.getElementById('spellAttackHint');
            if (spellDCHint) spellDCHint.textContent = lang === 'de' ? '8 + Übung + Mod' : '8 + Prof + Mod';
            if (spellAttackHint) spellAttackHint.textContent = lang === 'de' ? 'Übung + Mod' : 'Prof + Mod';
        }
        
        // Rebuild abilities grid with current language (preserves values)
        function rebuildAbilitiesGrid() {
            // Save current values
            const savedValues = {};
            const savedProfs = {};
            const savedSkillProfs = {};
            const savedSkillExps = {};
            
            ABILITIES.forEach(ab => {
                const scoreInput = document.getElementById(ab.id);
                if (scoreInput) savedValues[ab.id] = scoreInput.value;
                const profCheck = document.getElementById(ab.id + 'SaveProf');
                if (profCheck) savedProfs[ab.id] = profCheck.checked;
                
                ab.skills.forEach(sk => {
                    const skillProf = document.getElementById(sk + 'Prof');
                    const skillExp = document.getElementById(sk + 'Exp');
                    if (skillProf) savedSkillProfs[sk] = skillProf.checked;
                    if (skillExp) savedSkillExps[sk] = skillExp.checked;
                });
            });
            
            // Rebuild grid
            buildAbilitiesGrid();
            
            // Restore values
            ABILITIES.forEach(ab => {
                const scoreInput = document.getElementById(ab.id);
                if (scoreInput && savedValues[ab.id]) {
                    scoreInput.value = savedValues[ab.id];
                    updateModifier(ab.id);
                }
                const profCheck = document.getElementById(ab.id + 'SaveProf');
                if (profCheck) profCheck.checked = savedProfs[ab.id] || false;
                
                ab.skills.forEach(sk => {
                    const skillProf = document.getElementById(sk + 'Prof');
                    const skillExp = document.getElementById(sk + 'Exp');
                    if (skillProf) {
                        skillProf.checked = savedSkillProfs[sk] || false;
                        if (skillExp) {
                            skillExp.disabled = !skillProf.checked;
                            skillExp.checked = savedSkillExps[sk] || false;
                        }
                    }
                    updateSkillBonus(sk);
                });
                
                updateSaveBonus(ab.id);
            });
        }
        
        // Rebuild conditions with current language
        function rebuildConditions() {
            if (typeof renderConditions === 'function') {
                renderConditions();
            }
        }

        // Ability definitions - NO automatic calculations
        const ABILITIES = [
            { id: 'str', name: 'Strength', abbr: 'STR', skills: ['athletics'] },
            { id: 'dex', name: 'Dexterity', abbr: 'DEX', skills: ['acrobatics', 'sleight', 'stealth'] },
            { id: 'con', name: 'Constitution', abbr: 'CON', skills: [] },
            { id: 'int', name: 'Intelligence', abbr: 'INT', skills: ['arcana', 'history', 'investigation', 'nature', 'religion'] },
            { id: 'wis', name: 'Wisdom', abbr: 'WIS', skills: ['animal', 'insight', 'medicine', 'perception', 'survival'] },
            { id: 'cha', name: 'Charisma', abbr: 'CHA', skills: ['deception', 'intimidation', 'performance', 'persuasion'] }
        ];
        const SKILL_NAMES = { athletics: 'Athletics', acrobatics: 'Acrobatics', sleight: 'Sleight of Hand', stealth: 'Stealth', arcana: 'Arcana', history: 'History', investigation: 'Investigation', nature: 'Nature', religion: 'Religion', animal: 'Animal Handling', insight: 'Insight', medicine: 'Medicine', perception: 'Perception', survival: 'Survival', deception: 'Deception', intimidation: 'Intimidation', performance: 'Performance', persuasion: 'Persuasion' };

        // Subclass options per class (2024 5E) - MUST BE BEFORE FUNCTIONS
        const SUBCLASSES = {
            'Artificer': ['Alchemist', 'Armorer', 'Artillerist', 'Battle Smith'],
            'Barbarian': ['Path of the Berserker', 'Path of the Wild Heart', 'Path of the World Tree', 'Path of the Zealot'],
            'Bard': ['College of Dance', 'College of Glamour', 'College of Lore', 'College of the Moon', 'College of Valor'],
            'Cleric': ['Knowledge Domain', 'Life Domain', 'Light Domain', 'Trickery Domain', 'War Domain'],
            'Druid': ['Circle of the Land', 'Circle of the Moon', 'Circle of the Sea', 'Circle of Stars'],
            'Fighter': ['Banneret', 'Battle Master', 'Champion', 'Eldritch Knight', 'Psi Warrior'],
            'Monk': ['Warrior of Mercy', 'Warrior of Shadow', 'Warrior of the Elements', 'Warrior of the Open Hand'],
            'Paladin': ['Oath of Devotion', 'Oath of Glory', 'Oath of Redemption', 'Oath of the Ancients', 'Oath of Vengeance'],
            'Ranger': ['Beast Master', 'Fey Wanderer', 'Gloom Stalker', 'Hunter'],
            'Rogue': ['Arcane Trickster', 'Assassin', 'Mastermind', 'Swashbuckler', 'Thief'],
            'Sorcerer': ['Aberrant Mind', 'Clockwork Soul', 'Draconic Bloodline', 'Wild Magic'],
            'Warlock': ['The Archfey', 'The Celestial', 'The Fiend', 'The Great Old One'],
            'Wizard': ['Abjuration', 'Conjuration', 'Divination', 'Enchantment', 'Evocation', 'Illusion', 'Necromancy', 'Transmutation']
        };

        // Character data - starts EMPTY
        let char = {
            header: {},
            stats: { heroicInsp: false },
            abilities: {},
            saves: {},
            savesProf: {},
            skills: {},
            skillsProf: {},
            skillsExp: {},
            combat: { exhaustion: 0 },
            deathSaves: { success: [false,false,false], fail: [false,false,false] },
            conditions: [],
            multiclass: [],
            weapons: [{ name: '', bonus: '', damage: '', notes: '' }],
            classFeatures: '',
            classResources: [{ name: '', current: '', max: '' }],
            training: {},
            speciesTraits: '',
            feats: '',
            senses: '',
            spellcasting: {},
            spellSlots: {},
            pactSlots: { total: 0, expended: 0 },
            spells: [{ name: '', level: '', prepared: false, notes: '' }],
            narrative: {},
            coins: {},
            attunement: [false, false, false]
        };

        let cropper = null, isGM = false, viewingPlayer = null;
        let saveTimeout = null;
        
        // ===== V2 CHARACTER STORAGE INTEGRATION =====
        const STORAGE_KEY_OLD = 'rift_char_5e_2024'; // Legacy compatibility
        let currentCharId = null;
        
        function loadCharFromStorage() {
            const urlParams = new URLSearchParams(window.location.search);
            const charId = urlParams.get('id');
            const isNew = urlParams.get('new') === 'true';
            
            if (isNew) {
                // Start fresh character
                localStorage.removeItem(STORAGE_KEY_OLD);
                currentCharId = null;
                if (window.RIFT?.ui?.Toast) {
                    RIFT.ui.Toast.info('Neuer Charakter erstellt');
                }
                populateFields();
                return;
            }
            
            if (charId && typeof CharacterStorage !== 'undefined') {
                // Load from CharacterStorage
                const stored = CharacterStorage.getById(charId);
                if (stored && stored.data) {
                    currentCharId = charId;
                    // Merge stored data with default structure
                    char = {
                        header: stored.data.header || {},
                        stats: { heroicInsp: false, ...stored.data.stats },
                        abilities: stored.data.abilities || {},
                        saves: stored.data.saves || {},
                        savesProf: stored.data.savesProf || {},
                        skills: stored.data.skills || {},
                        skillsProf: stored.data.skillsProf || {},
                        skillsExp: stored.data.skillsExp || {},
                        combat: stored.data.combat || {},
                        deathSaves: stored.data.deathSaves || { success: [false,false,false], fail: [false,false,false] },
                        weapons: stored.data.weapons?.length > 0 ? stored.data.weapons : [{ name: '', bonus: '', damage: '', notes: '' }],
                        classResources: stored.data.classResources?.length > 0 ? stored.data.classResources : [{ name: '', current: '', max: '' }],
                        classFeatures: stored.data.classFeatures || '',
                        training: stored.data.training || {},
                        speciesTraits: stored.data.speciesTraits || '',
                        feats: stored.data.feats || '',
                        spellcasting: stored.data.spellcasting || {},
                        spellSlots: stored.data.spellSlots || {},
                        spells: stored.data.spells?.length > 0 ? stored.data.spells : [{ name: '', level: '', prepared: false, notes: '' }],
                        narrative: stored.data.narrative || {},
                        coins: stored.data.coins || {},
                        attunement: stored.data.attunement || [false, false, false]
                    };
                    populateFields();
                    CharacterStorage.updateLastPlayed(charId);
                    if (window.RIFT?.ui?.Toast) {
                        RIFT.ui.Toast.success(`${stored.name} geladen`);
                    }
                    return;
                }
            }
            
            // Fallback to legacy localStorage
            loadChar();
        }
        
        function saveToCharacterStorage() {
            if (!currentCharId && !char.header?.name) return;
            
            // Use actual portrait (base64) or fallback to preset
            let portraitValue = char.narrative?.portrait;
            if (!portraitValue) {
                portraitValue = 'char_5e2024_0' + (Math.floor(Math.random() * 7) + 1);
            }
            
            const charData = {
                id: currentCharId,
                ruleset: 'dnd5e',
                name: char.header?.name || 'Unbenannt',
                class: char.header?.charClass || '',
                race: char.header?.species || '',
                level: parseInt(char.header?.level) || 1,
                portrait: portraitValue,
                data: char
            };
            
            const saved = CharacterStorage.save(charData);
            if (saved && !currentCharId) {
                currentCharId = saved.id;
                // Update URL without reload
                window.history.replaceState({}, '', `?id=${saved.id}`);
            }
        }

        // Debounce helper - MUST BE BEFORE autoSave
        function debounce(fn, delay) {
            let timeout;
            return function(...args) {
                clearTimeout(timeout);
                timeout = setTimeout(() => fn.apply(this, args), delay);
            };
        }

        // AutoSave function - MUST BE EARLY for onchange handlers
        function autoSave() {
            if (viewingPlayer) return;
            clearTimeout(saveTimeout);
            saveTimeout = setTimeout(() => {
                collectData();
                localStorage.setItem(STORAGE_KEY_OLD, JSON.stringify(char)); // Legacy
                // V2 CharacterStorage
                if (typeof CharacterStorage !== 'undefined') {
                    saveToCharacterStorage();
                }
                syncToFirebase();
            }, 500);
        }

        function syncToFirebase() {
            if (typeof isFirebaseOnline === 'function' && isFirebaseOnline()) {
                const u = getCurrentUser();
                if (u) getRef(`characters/${sanitizeKey(u.username)}`).set({ ...char, updatedAt: Date.now() });
            }
        }

        // Spell slot maximums per level (based on official 5e character sheet)
        const SLOT_MAX = { 1: 4, 2: 3, 3: 3, 4: 3, 5: 3, 6: 2, 7: 2, 8: 1, 9: 1 };

        // ===== VETERAN FEATURES =====
        
        // Conditions Tracker
        const CONDITIONS_DATA = [
            { id: 'blinded', icon: '👁️', name: 'Blinded' },
            { id: 'charmed', icon: '💕', name: 'Charmed' },
            { id: 'deafened', icon: '🔇', name: 'Deafened' },
            { id: 'frightened', icon: '😱', name: 'Frightened' },
            { id: 'grappled', icon: '🤼', name: 'Grappled' },
            { id: 'incapacitated', icon: '💫', name: 'Incapacitated' },
            { id: 'invisible', icon: '👻', name: 'Invisible' },
            { id: 'paralyzed', icon: '⚡', name: 'Paralyzed' },
            { id: 'petrified', icon: '🪨', name: 'Petrified' },
            { id: 'poisoned', icon: '☠️', name: 'Poisoned' },
            { id: 'prone', icon: '🛌', name: 'Prone' },
            { id: 'restrained', icon: '⛓️', name: 'Restrained' },
            { id: 'stunned', icon: '💥', name: 'Stunned' },
            { id: 'unconscious', icon: '😵', name: 'Unconscious' }
        ];
        
        function renderConditions() {
            const grid = document.getElementById('conditionsGrid');
            grid.innerHTML = CONDITIONS_DATA.map(c => `
                <div class="condition-chip ${(char.conditions || []).includes(c.id) ? 'active' : ''}" 
                     data-condition="${c.id}" 
                     onclick="toggleCondition('${c.id}')">
                    <span class="condition-icon">${c.icon}</span>${term(c.name)}
                </div>
            `).join('');
            
            // Update labels
            document.querySelector('.conditions-label').textContent = term('Conditions');
            document.querySelectorAll('.rest-btn-text').forEach((el, i) => {
                el.textContent = term(i === 0 ? 'Short Rest' : 'Long Rest');
            });
        }
        
        function toggleCondition(condition) {
            if (!char.conditions) char.conditions = [];
            const idx = char.conditions.indexOf(condition);
            if (idx >= 0) {
                char.conditions.splice(idx, 1);
            } else {
                char.conditions.push(condition);
            }
            updateConditionsUI();
            autoSave();
        }
        
        function updateConditionsUI() {
            const conditions = char.conditions || [];
            document.querySelectorAll('.condition-chip').forEach(chip => {
                const cond = chip.dataset.condition;
                chip.classList.toggle('active', conditions.includes(cond));
            });
        }
        
        // Rest Functions
        function shortRest() {
            const lang = getLang();
            const msg = lang === 'de' 
                ? 'Kurze Rast: Trefferwürfel zum Heilen ausgeben?\n\nHexenmeister-Zauberplätze werden zurückgesetzt.\nManche Klassenressourcen werden aufgefrischt.'
                : 'Short Rest: Spend Hit Dice to heal?\n\nWarlock spell slots will be restored.\nSome class resources will refresh.';
            
            if (confirm(msg)) {
                // Show effect first
                showRestEffect('short');
                
                // Reset Warlock pact slots
                document.getElementById('pactExpended').value = 0;
                char.pactSlots = char.pactSlots || {};
                char.pactSlots.expended = 0;
                
                autoSave();
            }
        }
        
        function longRest() {
            const lang = getLang();
            const msg = lang === 'de'
                ? 'Lange Rast durchführen?\n\n✓ Volle TP wiederhergestellt\n✓ Alle Zauberplätze zurück\n✓ Halbe Trefferwürfel zurück\n✓ Erschöpfung -1\n✓ Todesrettungswürfe zurückgesetzt'
                : 'Take a Long Rest?\n\n✓ Full HP restored\n✓ All spell slots restored\n✓ Half hit dice restored\n✓ Exhaustion -1\n✓ Death saves reset';
            
            if (confirm(msg)) {
                // Show effect first
                showRestEffect('long');
                
                // Restore HP to max
                const hpMax = document.getElementById('hpMax').value;
                if (hpMax) {
                    document.getElementById('hpCurrent').value = hpMax;
                }
                
                // Reset temp HP
                document.getElementById('hpTemp').value = 0;
                
                // Restore half hit dice (round up)
                const hdMax = parseInt(document.getElementById('hdMax').value) || 0;
                const hdCurrent = parseInt(document.getElementById('hdCurrent').value) || 0;
                const hdRestore = Math.ceil(hdMax / 2);
                document.getElementById('hdCurrent').value = Math.min(hdMax, hdCurrent + hdRestore);
                
                // Reset all spell slots (set expended to 0)
                restoreAllSlots();
                
                // Reset Warlock pact slots
                document.getElementById('pactExpended').value = 0;
                char.pactSlots = char.pactSlots || {};
                char.pactSlots.expended = 0;
                
                // Reduce exhaustion by 1
                const exhaustion = parseInt(document.getElementById('exhaustion').value) || 0;
                if (exhaustion > 0) {
                    document.getElementById('exhaustion').value = exhaustion - 1;
                    updateExhaustion();
                }
                
                // Reset death saves
                char.deathSaves = { success: [false,false,false], fail: [false,false,false] };
                initDeathSaves();
                
                autoSave();
            }
        }
        
        function showRestToast(message) {
            const toast = document.createElement('div');
            toast.style.cssText = 'position:fixed;bottom:80px;left:50%;transform:translateX(-50%);background:var(--md-primary);color:var(--md-on-primary);padding:12px 24px;border-radius:10px;font-size:14px;font-weight:500;z-index:9999;animation:fadeIn 0.3s ease;';
            toast.textContent = message;
            document.body.appendChild(toast);
            setTimeout(() => toast.remove(), 2500);
        }
        
        function showRestEffect(type) {
            const lang = getLang();
            const isShort = type === 'short';
            
            const overlay = document.createElement('div');
            overlay.className = `rest-effect-overlay ${isShort ? 'short-rest' : 'long-rest'}`;
            
            const icon = document.createElement('div');
            icon.className = 'rest-effect-icon';
            icon.textContent = isShort ? '☀️' : '🌙';
            
            const text = document.createElement('div');
            text.className = 'rest-effect-text';
            text.textContent = isShort 
                ? (lang === 'de' ? 'Kurze Rast' : 'Short Rest')
                : (lang === 'de' ? 'Lange Rast' : 'Long Rest');
            
            overlay.appendChild(icon);
            overlay.appendChild(text);
            document.body.appendChild(overlay);
            
            // Trigger animation
            requestAnimationFrame(() => {
                overlay.classList.add('active');
            });
            
            // Remove after animation
            setTimeout(() => overlay.remove(), 2200);
        }
        
        // Concentration Tracker
        function updateConcentrationBanner() {
            const banner = document.getElementById('concentrationBanner');
            const spellName = document.getElementById('concSpellName');
            
            // Find spell with concentration active AND marked as currently concentrating
            const concSpell = (char.spells || []).find(s => s.conc && s.concentrating);
            
            if (concSpell && concSpell.name) {
                spellName.textContent = concSpell.name;
                banner.classList.add('visible');
            } else {
                banner.classList.remove('visible');
            }
            
            // Update spell row highlighting
            document.querySelectorAll('.spell-row').forEach((row, i) => {
                const spell = char.spells?.[i];
                row.classList.toggle('concentrating', spell?.conc && spell?.concentrating);
            });
        }
        
        function breakConcentration() {
            if (char.spells) {
                char.spells.forEach(s => s.concentrating = false);
            }
            updateConcentrationBanner();
            autoSave();
        }
        
        function setConcentrating(index) {
            // Only one spell can have concentration active at a time
            if (char.spells) {
                char.spells.forEach((s, i) => {
                    if (s.conc) {
                        s.concentrating = (i === index) ? !s.concentrating : false;
                    }
                });
            }
            updateConcentrationBanner();
            autoSave();
        }
        
        // Multiclass Support
        function addMulticlass() {
            if (!char.multiclass) char.multiclass = [];
            if (char.multiclass.length >= 2) return; // Max 2 additional classes
            
            char.multiclass.push({ class: '', level: 1 });
            renderMulticlass();
            autoSave();
        }
        
        function removeMulticlass(index) {
            char.multiclass.splice(index, 1);
            renderMulticlass();
            autoSave();
        }
        
        function updateMulticlass(index, field, value) {
            if (!char.multiclass) char.multiclass = [];
            char.multiclass[index] = char.multiclass[index] || {};
            char.multiclass[index][field] = field === 'level' ? parseInt(value) || 1 : value;
            autoSave();
        }
        
        function renderMulticlass() {
            const container = document.getElementById('multiclassRows');
            const section = document.getElementById('multiclassSection');
            const classes = char.multiclass || [];
            
            // Show section if main class is selected or multiclass exists
            const mainClass = document.getElementById('charClass')?.value;
            section.style.display = (mainClass && mainClass !== 'custom') || classes.length > 0 ? '' : 'none';
            
            const classOptions = ['', 'Artificer', 'Barbarian', 'Bard', 'Cleric', 'Druid', 'Fighter', 'Monk', 'Paladin', 'Ranger', 'Rogue', 'Sorcerer', 'Warlock', 'Wizard']
                .map(c => `<option value="${c}">${c || 'Select...'}</option>`).join('');
            
            container.innerHTML = classes.map((mc, i) => `
                <div class="multiclass-row">
                    <select onchange="updateMulticlass(${i}, 'class', this.value)">
                        ${classOptions.replace(`value="${mc.class}"`, `value="${mc.class}" selected`)}
                    </select>
                    <input type="number" value="${mc.level || 1}" min="1" max="20" onchange="updateMulticlass(${i}, 'level', this.value)">
                    <button class="multiclass-remove" onclick="removeMulticlass(${i})">×</button>
                </div>
            `).join('');
        }
        
        // ===== INTEGRATED DICE ROLLER =====
        let currentDiceFormula = '1d20';
        let currentDiceLabel = 'Roll';
        let currentAdvantage = 'normal';
        let diceIsRolling = false;
        
        function rollDice(formula, label) {
            currentDiceFormula = formula || '1d20';
            currentDiceLabel = label || (getLang() === 'de' ? 'Würfeln' : 'Roll');
            currentAdvantage = 'normal';
            
            // Update UI
            document.getElementById('diceRollType').textContent = currentDiceLabel;
            document.getElementById('diceFormula').textContent = currentDiceFormula;
            document.getElementById('diceResult').textContent = '–';
            document.getElementById('diceResult').className = 'dice-result';
            document.getElementById('diceBreakdown').textContent = '';
            
            // Show/hide advantage row (only for d20 rolls)
            const isD20 = currentDiceFormula.toLowerCase().includes('d20');
            document.getElementById('diceAdvRow').style.display = isD20 ? 'flex' : 'none';
            
            // Reset advantage buttons
            setAdvantage('normal');
            
            // Update button text
            const lang = getLang();
            document.getElementById('diceRollBtnText').textContent = lang === 'de' ? 'Würfeln!' : 'Roll!';
            
            // Update advantage button labels
            const advBtns = document.querySelectorAll('.dice-adv-btn');
            advBtns[0].textContent = lang === 'de' ? 'Nachteil' : 'Disadvantage';
            advBtns[1].textContent = lang === 'de' ? 'Normal' : 'Normal';
            advBtns[2].textContent = lang === 'de' ? 'Vorteil' : 'Advantage';
            
            // Open popup
            document.getElementById('dicePopup').classList.add('active');
        }
        
        function closeDicePopup() {
            document.getElementById('dicePopup').classList.remove('active');
        }
        
        function setAdvantage(mode) {
            currentAdvantage = mode;
            document.querySelectorAll('.dice-adv-btn').forEach(btn => btn.classList.remove('active'));
            const btns = document.querySelectorAll('.dice-adv-btn');
            if (mode === 'disadvantage') btns[0].classList.add('active');
            else if (mode === 'normal') btns[1].classList.add('active');
            else if (mode === 'advantage') btns[2].classList.add('active');
        }
        
        async function executeRoll() {
            if (diceIsRolling) return;
            diceIsRolling = true;
            
            const resultEl = document.getElementById('diceResult');
            const breakdownEl = document.getElementById('diceBreakdown');
            
            // Parse formula
            const parsed = parseDiceFormula(currentDiceFormula);
            
            // Rolling animation
            resultEl.classList.add('rolling');
            const animDuration = 800;
            const startTime = Date.now();
            
            while (Date.now() - startTime < animDuration) {
                resultEl.textContent = Math.floor(Math.random() * (parsed.sides || 20)) + 1;
                await new Promise(r => setTimeout(r, 50));
            }
            
            resultEl.classList.remove('rolling');
            
            // Calculate actual result
            let rolls = [];
            let total = 0;
            let isCrit = false;
            let isFail = false;
            
            if (parsed.isD20 && currentAdvantage !== 'normal') {
                // Roll with advantage/disadvantage
                const r1 = Math.floor(Math.random() * 20) + 1;
                const r2 = Math.floor(Math.random() * 20) + 1;
                const kept = currentAdvantage === 'advantage' ? Math.max(r1, r2) : Math.min(r1, r2);
                rolls = [r1, r2];
                total = kept + parsed.modifier;
                isCrit = kept === 20;
                isFail = kept === 1;
                
                const lang = getLang();
                const keptText = lang === 'de' ? 'behalten' : 'kept';
                breakdownEl.innerHTML = `<span class="roll-value">[${r1}, ${r2}]</span> → ${kept} (${keptText}) <span class="mod-value">${parsed.modifier >= 0 ? '+' : ''}${parsed.modifier}</span>`;
            } else {
                // Normal roll
                for (let i = 0; i < parsed.count; i++) {
                    rolls.push(Math.floor(Math.random() * parsed.sides) + 1);
                }
                const rollSum = rolls.reduce((a, b) => a + b, 0);
                total = rollSum + parsed.modifier;
                
                if (parsed.isD20 && parsed.count === 1) {
                    isCrit = rolls[0] === 20;
                    isFail = rolls[0] === 1;
                }
                
                if (rolls.length === 1) {
                    breakdownEl.innerHTML = `<span class="roll-value">${rolls[0]}</span> <span class="mod-value">${parsed.modifier >= 0 ? '+' : ''}${parsed.modifier}</span>`;
                } else {
                    breakdownEl.innerHTML = `<span class="roll-value">[${rolls.join(', ')}]</span> = ${rollSum} <span class="mod-value">${parsed.modifier >= 0 ? '+' : ''}${parsed.modifier}</span>`;
                }
            }
            
            // Display result
            resultEl.textContent = total;
            resultEl.classList.remove('crit', 'fail');
            
            if (isCrit) {
                resultEl.classList.add('crit');
                createDiceConfetti();
            } else if (isFail) {
                resultEl.classList.add('fail');
            }
            
            // Sync to wuerfel_5e.html history
            syncRollToHistory(currentDiceLabel, rolls, parsed.modifier, total, isCrit, isFail);
            
            diceIsRolling = false;
        }
        
        function parseDiceFormula(formula) {
            // Parse formulas like "1d20+5", "2d6+3", "1d8-1"
            const match = formula.match(/(\d+)?d(\d+)([+-]\d+)?/i);
            if (!match) {
                return { count: 1, sides: 20, modifier: 0, isD20: true };
            }
            
            const count = parseInt(match[1]) || 1;
            const sides = parseInt(match[2]) || 20;
            const modifier = parseInt(match[3]) || 0;
            
            return { count, sides, modifier, isD20: sides === 20 };
        }
        
        function createDiceConfetti() {
            const container = document.querySelector('.dice-display-area');
            const colors = ['#ffd700', '#ffaa00', '#ff6600', '#ffffff', '#88ff88'];
            
            for (let i = 0; i < 30; i++) {
                const confetti = document.createElement('div');
                confetti.className = 'dice-confetti';
                confetti.style.left = Math.random() * 100 + '%';
                confetti.style.top = '0';
                confetti.style.background = colors[Math.floor(Math.random() * colors.length)];
                confetti.style.animationDelay = Math.random() * 0.3 + 's';
                container.appendChild(confetti);
                setTimeout(() => confetti.remove(), 2500);
            }
        }
        
        function syncRollToHistory(type, rolls, mod, total, isCrit, isFail) {
            // Save to localStorage so wuerfel_5e.html can pick it up
            const rollData = {
                type: type,
                rolls: rolls,
                modifier: mod,
                total: total,
                isCrit: isCrit,
                isFail: isFail,
                timestamp: Date.now(),
                source: 'charakterbogen_5e'
            };
            
            // Get existing history or create new
            let history = [];
            try {
                history = JSON.parse(localStorage.getItem('rift_5e_history') || '[]');
            } catch(e) {}
            
            // Add to front of history (max 50)
            history.unshift(rollData);
            if (history.length > 50) history = history.slice(0, 50);
            
            localStorage.setItem('rift_5e_history', JSON.stringify(history));
        }
        
        function rollAbilityCheck(abilityId) {
            const mod = document.getElementById(abilityId + 'Mod')?.textContent || '+0';
            const abilityName = document.querySelector(`.ability-card[data-ability="${abilityId}"] .ability-name`)?.textContent || abilityId.toUpperCase();
            rollDice(`1d20${mod}`, `${abilityName} ${getLang()==='de'?'Probe':'Check'}`);
        }
        
        function rollSkillCheck(skillId) {
            const bonus = document.getElementById(skillId + 'Value')?.textContent || '+0';
            const skillName = document.querySelector(`#${skillId}Prof`)?.closest('.skill-item')?.querySelector('.skill-name')?.textContent || skillId;
            rollDice(`1d20${bonus}`, skillName);
        }
        
        function rollSavingThrow(abilityId) {
            const bonus = document.getElementById(abilityId + 'SaveValue')?.textContent || '+0';
            const abilityName = document.querySelector(`.ability-card[data-ability="${abilityId}"] .ability-name`)?.textContent || abilityId.toUpperCase();
            rollDice(`1d20${bonus}`, `${abilityName} ${getLang()==='de'?'Rettung':'Save'}`);
        }
        
        function rollInitiative() {
            const bonus = document.getElementById('initiative')?.textContent || '+0';
            rollDice(`1d20${bonus}`, 'Initiative');
        }

        // ===== SRD 5.1 WEAPONS DATABASE =====
        // SVG Icon definitions for weapons, spells, and damage types
        // Icons from tw-dnd by intrinsical (https://github.com/intrinsical/tw-dnd)
        const ICONS = {
            // Weapon Icons (tw-dnd)
            sword: '<svg viewBox="0 0 100 100" fill="currentColor"><path d="m100 0-11.16 4.0898-67.646 67.646-6.0312-6.0957a2.5 2.5 0 0 0-1.7637-0.74023 2.5 2.5 0 0 0-1.7715 0.72266 2.5 2.5 0 0 0-0.019531 3.5352l7.2812 7.3574-11.164 11.162a6.25 6.25 0 0 0-1.4746-0.17773 6.25 6.25 0 0 0-6.25 6.25 6.25 6.25 0 0 0 6.25 6.25 6.25 6.25 0 0 0 6.25-6.25 6.25 6.25 0 0 0-0.17773-1.4746l11.137-11.139 7.1465 7.2227a2.5 2.5 0 0 0 3.5352 0.017578 2.5 2.5 0 0 0 0.019531-3.5352l-5.9355-5.9961 67.686-67.686 4.0898-11.16z"/></svg>',
            dagger: '<svg viewBox="0 0 100 100" fill="currentColor"><path d="m90 10s-11.589 6.8654-16.912 10.965c-8.1565 6.282-15.129 13.969-22.864 20.764-3.406 2.992-6.7443 6.0792-10.365 8.8069-2.2539 1.6978-7.0494 4.6891-7.0494 4.6891l-0.12714 5.9067-7.6283-7.6283a4.3321 4.3321 0 0 0-6.1265 0 4.3321 4.3321 0 0 0 0 6.1265l7.6582 7.6582-15.316 15.316a4.3321 4.3321 0 0 0 0 6.1265 4.3321 4.3321 0 0 0 6.1265 0l15.316-15.316 7.6582 7.6582a4.3321 4.3321 0 0 0 6.1265 0 4.3321 4.3321 0 0 0 0-6.1265l-7.7165-7.7165 5.9964-0.04039s2.9899-4.7942 4.6876-7.0479c2.7278-3.6212 5.8148-6.9593 8.8069-10.365 6.7945-7.7348 14.482-14.707 20.764-22.864 4.0997-5.3231 10.965-16.912 10.965-16.912z"/></svg>',
            axe: '<svg viewBox="0 0 100 100" fill="currentColor"><path d="m63.576 0.011719c-8.595 0.22901-16.755 3.6732-22.818 9.7305-6.9224 6.9298-10.431 16.597-9.6289 26.523 6.7163-1.4803 13.578-0.58714 19.389 2.5234 0.34731-0.75691 0.84753-1.4686 1.4707-2.0918l15.725-15.725c0.62467-0.62469 1.3389-1.119 2.0977-1.4609-3.1151-5.8132-4.0106-12.678-2.5293-19.398-1.2408-0.10028-2.4772-0.13428-3.7051-0.10156zm12.584 19.826c-1.0237 0-2.0471 0.39083-2.8281 1.1719l-0.15234 0.15234c-1.1427-0.49291-2.7933-0.034856-4.0527 1.2246l-15.725 15.725c-1.2594 1.2595-1.7175 2.91-1.2246 4.0527l-51.006 51.008c-0.023393 0.023394-0.025432 0.037974-0.046875 0.060547a4 4.0001 0 0 0-1.125 2.7676 4 4.0001 0 0 0 4 4 4 4.0001 0 0 0 2.7676-1.125c0.022572-0.021443 0.037154-0.023481 0.060547-0.046875l51.006-51.006c1.1427 0.49291 2.7933 0.032903 4.0527-1.2266l15.725-15.725c1.2594-1.2595 1.7175-2.91 1.2246-4.0527l0.15234-0.15234c1.5621-1.5621 1.5621-4.0942 0-5.6562-0.78103-0.78105-1.8045-1.1719-2.8281-1.1719zm4.3262 10.35c-0.34192 0.7588-0.83627 1.473-1.4609 2.0977l-15.725 15.727c-0.61995 0.61996-1.3276 1.1177-2.0801 1.4648 3.1226 5.8085 4.0275 12.673 2.5547 19.395 9.912 0.78926 19.561-2.7194 26.48-9.6309 6.9235-6.9293 10.432-16.596 9.6309-26.523-6.7215 1.4821-13.587 0.58652-19.4-2.5293z"/></svg>',
            battleaxe: '<svg viewBox="0 0 100 100" fill="currentColor"><path d="m63.576 0.011719c-8.595 0.22901-16.755 3.6732-22.818 9.7305-6.9224 6.9298-10.431 16.597-9.6289 26.523 6.7163-1.4803 13.578-0.58714 19.389 2.5234 0.34731-0.75691 0.84753-1.4686 1.4707-2.0918l15.725-15.725c0.62467-0.62469 1.3389-1.119 2.0977-1.4609-3.1151-5.8132-4.0106-12.678-2.5293-19.398-1.2408-0.10028-2.4772-0.13428-3.7051-0.10156zm12.584 19.826c-1.0237 0-2.0471 0.39083-2.8281 1.1719l-0.15234 0.15234c-1.1427-0.49291-2.7933-0.034856-4.0527 1.2246l-15.725 15.725c-1.2594 1.2595-1.7175 2.91-1.2246 4.0527l-51.006 51.008c-0.023393 0.023394-0.025432 0.037974-0.046875 0.060547a4 4.0001 0 0 0-1.125 2.7676 4 4.0001 0 0 0 4 4 4 4.0001 0 0 0 2.7676-1.125c0.022572-0.021443 0.037154-0.023481 0.060547-0.046875l51.006-51.006c1.1427 0.49291 2.7933 0.032903 4.0527-1.2266l15.725-15.725c1.2594-1.2595 1.7175-2.91 1.2246-4.0527l0.15234-0.15234c1.5621-1.5621 1.5621-4.0942 0-5.6562-0.78103-0.78105-1.8045-1.1719-2.8281-1.1719zm4.3262 10.35c-0.34192 0.7588-0.83627 1.473-1.4609 2.0977l-15.725 15.727c-0.61995 0.61996-1.3276 1.1177-2.0801 1.4648 3.1226 5.8085 4.0275 12.673 2.5547 19.395 9.912 0.78926 19.561-2.7194 26.48-9.6309 6.9235-6.9293 10.432-16.596 9.6309-26.523-6.7215 1.4821-13.587 0.58652-19.4-2.5293z"/></svg>',
            handaxe: '<svg viewBox="0 0 100 100" fill="currentColor"><path d="m61.023 6.0944c-0.69702-0.23671-1.5091-0.019936-2.0576 0.55461l-10.121 11.42c-0.77754 0.91696-1.6015 1.9861-0.16447 3.2514l15.656 13.871c2.1622 2.1475 7.8992 14.302 10.293 19.49 0.58684 1.3349 1.206 2.0184 2.6493 1.6354 8.8771-3.5515 20.553-16.807 22.713-26.046 0.07893-0.80092-0.34325-1.59-1.0551-1.9731l-21.46-7.893-15.808-13.92c-0.19282-0.18283-0.41198-0.3122-0.64432-0.39111zm-14.621 19.872c-4.3578 5.302-44.424 54.053-44.42 54.318-6.7736 9.1464 5.4533 18.502 12.069 10.957l45.822-53.338z"/></svg>',
            hammer: '<svg viewBox="0 0 100 100" fill="currentColor"><path d="m54.499 0.0052177c-0.75699 0.040141-1.4478 0.31111-1.9668 0.83007l-19.984 19.986c-1.3839 1.3839-1.0132 3.9828 0.83201 5.828l6.662 6.662c1.8453 1.8453 4.4441 2.2159 5.828 0.83202l3.7089 3.7089 19.984-19.986-3.707-3.707c1.3839-1.3839 1.0113-3.9828-0.83397-5.828l-6.66-6.662c-1.1533-1.1533-2.6016-1.7309-3.8632-1.664zm21.349 18.256a5.8899 5.8899 0 0 0-4.1542 1.7363l-0.0098-0.0098-69.958 69.96 0.00977 0.0098a5.8899 5.8899 0 0 0-1.7363 4.1542 5.8899 5.8899 0 0 0 5.8886 5.8886 5.8899 5.8899 0 0 0 4.1542-1.7363l0.0098 0.0098 69.96-69.958-0.0098-0.0098a5.8899 5.8899 0 0 0 1.7343-4.1542 5.8899 5.8899 0 0 0-5.8886-5.8905zm6.285 12.176-19.986 19.984 3.7089 3.7089c-1.3839 1.3839-1.0132 3.9828 0.83201 5.828l6.662 6.662c1.8453 1.8453 4.4441 2.2159 5.828 0.83202l19.986-19.984c1.3839-1.3839 1.0113-3.9847-0.83397-5.83l-6.662-6.6601c-1.8453-1.8453-4.4441-2.2179-5.828-0.83397z"/></svg>',
            staff: '<svg viewBox="0 0 100 100" fill="currentColor"><path d="m94.497 0.034058a0.99999 0.99999 0 0 0-0.44726 0.25976l-20.506 20.506-2.123 2.1211a0.99999 0.99999 0 0 0 0 1.4141v2e-3l-47.086 47.086h-2e-3a0.99999 0.99999 0 0 0-1.4141 0l-2.121 2.123-20.506 20.506a0.99999 0.99999 0 0 0 0 1.4141l4.2422 4.2422a0.99999 0.99999 0 0 0 1.4141 0l20.506-20.506 2.123-2.1211a0.99999 0.99999 0 0 0 0-1.4141v-2e-3l47.086-47.086h2e-3a0.99999 0.99999 0 0 0 1.4141 0l2.121-2.123 20.506-20.506a0.99999 0.99999 0 0 0 0-1.4141l-4.2422-4.2422a0.99999 0.99999 0 0 0-0.96679-0.25976z"/></svg>',
            spear: '<svg viewBox="0 0 100 100" fill="currentColor"><path d="m99.998 0.0019531-31.213 17.758-2.3672 9.7559-12.896 11.635 3.7891 3.5371 42.688-42.684v-0.0019531zm0 0.0019531-42.686 42.687 3.5371 3.7871 11.635-12.895 9.7559-2.3672 17.758-31.213zm-47.711 43.467-51.408 51.408 0.0039062 0.003906a3 3 0 0 0-0.88281 2.1172 3 3 0 0 0 3 3 3 3 0 0 0 2.1172-0.88281l0.0039063 0.003906 51.408-51.408-2.0625-2.207-2.1797-2.0352z"/></svg>',
            dart: '<svg viewBox="0 0 100 100" fill="currentColor"><path d="m99.892 4.7206e-4c-0.018165 8.618e-4 -0.18041 0.046739-0.20795 0.050544-0.38532 0.071701-1.1284 0.25745-2.1277 0.52569-0.27981 0.075738-0.45753 0.11949-0.77347 0.20724-5.1323 1.409-14.634 4.2736-14.955 4.5947-0.11401 0.11398 1.6796 1.2197 3.9865 2.4566l1.5343 0.81886 0.30685 0.32855-65.387 65.165-1.9121-0.040437-5.4143-0.11121-14.942 14.982 8.9875 2.0648 2.0719 8.9569 15.033-14.891-0.11159-5.3959-0.04057-1.9056 65.256-65.034 0.45394 0.48525 0.5503 1.0716c1.2059 2.3378 2.2532 4.1906 2.3255 4.1145 0.28176-0.29644 5.5843-18.152 5.4726-18.427-0.0035-0.0086698-0.02167-0.011775-0.05833-0.010093-0.0028-0.007117-0.01801-0.009058-0.04818-0.0076346z"/></svg>',
            arrow: '<svg viewBox="0 0 100 100" fill="currentColor"><path d="m99.892 4.7206e-4c-0.018165 8.618e-4 -0.18041 0.046739-0.20795 0.050544-0.38532 0.071701-1.1284 0.25745-2.1277 0.52569-0.27981 0.075738-0.45753 0.11949-0.77347 0.20724-5.1323 1.409-14.634 4.2736-14.955 4.5947-0.11401 0.11398 1.6796 1.2197 3.9865 2.4566l1.5343 0.81886 0.30685 0.32855-65.387 65.165-1.9121-0.040437-5.4143-0.11121-14.942 14.982 8.9875 2.0648 2.0719 8.9569 15.033-14.891-0.11159-5.3959-0.04057-1.9056 65.256-65.034 0.45394 0.48525 0.5503 1.0716c1.2059 2.3378 2.2532 4.1906 2.3255 4.1145 0.28176-0.29644 5.5843-18.152 5.4726-18.427-0.0035-0.0086698-0.02167-0.011775-0.05833-0.010093-0.0028-0.007117-0.01801-0.009058-0.04818-0.0076346z"/></svg>',
            bow: '<svg viewBox="0 0 100 100" fill="currentColor"><path d="m0.068359 0c-0.043706-0.0015371-0.068359 0.015966-0.068359 0.054688 0 0.69637 3.4928 5.4011 5.7793 7.7852 0.6576 0.68563 1.3432 1.3315 2.0488 1.9512l7.0605 61.41 1.4727-1.4805 1.3145-0.53125-6.5352-56.854c5.1583 3.4547 11.488 5.5414 19.447 6.4434 6.0534 0.68598 10.21 2.0202 14.299 4.5918 1.0501 0.66038 2.2263 1.6255 3.3359 2.6719 0.26197-0.37393 0.56236-0.73228 0.90234-1.0723l3.1309-3.1309c0.48474-0.48469 1.0264-0.88254 1.5977-1.2129-3.392-3.162-6.3903-5.3434-9.7246-6.9961-3.7731-1.8702-5.9593-2.3664-11.695-2.6562-5.0893-0.25715-9.2511-0.77702-12.73-1.5918-7.252-1.698-13.622-4.7118-18.842-8.916-0.35503-0.28592-0.66185-0.46219-0.79297-0.4668zm84.557 15.357c-0.72037 0.03433-11.213 3.1454-11.482 3.416-0.07228 0.072498 1.0648 0.77573 2.5273 1.5625l0.97266 0.52148-6.666 6.666 2.8281 2.8281 6.5645-6.5645 0.34961 0.68164c0.76448 1.4871 1.4288 2.6656 1.4746 2.6172 0.17862-0.18857 3.5396-11.548 3.4688-11.723-0.0022-0.0055-0.013869-0.006959-0.037109-0.005859zm-26.633 8.1543c-1.0983 0.0038-2.1349 0.38304-2.9082 1.1562l-3.1309 3.1309c-1.7674 1.7674-1.4763 4.9046 0.65234 7.0332l12.373 12.371c2.1286 2.1286 5.2639 2.4198 7.0312 0.65234l3.1309-3.1309c1.7674-1.7674 1.4763-4.9027-0.65234-7.0312l-12.371-12.373c-1.1974-1.1974-2.7129-1.8135-4.125-1.8086zm-3.1836 19.18-29.967 29.967-1.4727-0.03125-4.1699-0.085937-11.508 11.578 6.9219 1.5957 1.5957 6.9219 11.578-11.508-0.085937-4.1699-0.03125-1.4727 29.967-29.967-2.8281-2.8281zm24.393 3.2695c-0.33094 0.56268-0.73801 1.0974-1.2324 1.5918l-3.1309 3.1309c-0.33704 0.33705-0.69203 0.63419-1.0625 0.89453 1.1171 1.1672 2.1547 2.4239 2.8535 3.5352 2.5716 4.0892 3.9058 8.2453 4.5918 14.299 0.902 7.9597 2.9886 14.289 6.4434 19.447l-56.414-6.4844-0.64258 1.5918-1.2207 1.2129 60.822 6.9922c0.61962 0.70565 1.2655 1.3912 1.9512 2.0488 2.384 2.2865 7.0888 5.7793 7.7852 5.7793 0.15489 0-0.03088-0.38796-0.41211-0.86133-4.2042-5.2203-7.218-11.59-8.916-18.842-0.81478-3.4799-1.3346-7.6417-1.5918-12.73-0.28984-5.7363-0.7861-7.9225-2.6562-11.695-1.6828-3.3951-3.9094-6.4406-7.168-9.9102z"/></svg>',
            crossbow: '<svg viewBox="0 0 100 100" fill="currentColor"><path transform="rotate(45)" d="m0.048337-0.048337c-0.031992 0.029818-0.037048 0.059627-0.0096675 0.087007 0.49241 0.49241 6.2889 1.3493 9.5915 1.4184 0.9498 0.01982 1.8913-0.0083132 2.8284-0.069053l45.253 35.92v-3.8283l-41.112-32.635c6.0903-1.2046 12.042-4.2051 18.307-9.1952 4.7654-3.7953 8.648-5.7909 13.358-6.8639 1.7572-0.40036 4.1525-0.55152 6.2977-0.46956h6.1485v-7.8831h-5.9386l-0.25135 0.002762c-5.5876 0.053104-9.6812 0.65024-13.679 1.9984-3.9904 1.3455-5.8872 2.5406-10.148 6.3916-3.7805 3.4168-7.0909 5.9921-10.127 7.8762-6.3286 3.9273-12.964 6.3003-19.628 7.0186-0.45322 0.048868-0.79481 0.14118-0.89079 0.23064zm70.65-48.931c-0.4851 0.53365-5.7049 10.153-5.7038 10.535 1.54e-4 0.10237 1.3015-0.20444 2.892-0.68225l1.0565-0.31903v4.6873h3.9996v-4.5437l0.7292 0.23478c1.5921 0.51097 2.8952 0.87453 2.8933 0.80792-0.007036-0.25964-5.6625-10.668-5.8364-10.742-0.005445-0.002334-0.014728 0.004886-0.030383 0.022097zm-5.11 19.097c-0.54225 0.54225-0.87698 1.2917-0.87698 2.1227v42.567c-1.7282 0.44237-2.9997 1.9998-2.9997 3.8698v33.356c0 2.216 1.7836 3.9996 3.9996 3.9996h9.9989c2.216 0 3.9996-1.7836 3.9996-3.9996v-33.356c0-1.8699-1.2714-3.4274-2.9997-3.8698v-42.567c0-1.662-1.3377-2.9997-2.9997-2.9997h-5.9994c-0.831 0-1.5805 0.33473-2.1227 0.87698zm15.123 6.3142v7.8887h5.8778c2.2092-0.10712 4.7373 0.048512 6.567 0.46542 4.7099 1.0731 8.5921 3.0685 13.358 6.8639 6.2662 4.9905 12.217 7.9908 18.307 9.1952l-41.112 32.635v3.8283l45.253-35.92c0.93711 0.06083 1.8786 0.088923 2.8284 0.069053 3.3025-0.068943 9.0991-0.92593 9.5915-1.4184 0.10952-0.10952-0.29617-0.25249-0.90046-0.31765-6.6641-0.71849-13.299-3.0913-19.628-7.0186-3.0368-1.8845-6.3472-4.4598-10.127-7.8762-4.2611-3.8512-6.1579-5.0462-10.148-6.3916-3.9982-1.3482-8.0918-1.9454-13.679-1.9984l-0.51652-0.005524-5.672 0.001381z"/></svg>',
            mace: '<svg viewBox="0 0 100 100" fill="currentColor"><path d="m77.027 0-3.625 7.5215a20 20 0 0 0-0.90234-0.021484 20 20 0 0 0-6.7461 1.2246l-5.7227-6.1387 1.4785 8.2227a20 20 0 0 0-5.5254 5.4668l-8.1875-1.5879 6.0293 5.791a20 20 0 0 0-1.3262 7.0215 20 20 0 0 0 0.046875 0.65039l-7.5469 3.5332 8.2402 1.1289a20 20 0 0 0 13.709 13.895l1.0234 8.293 3.6465-7.5625a20 20 0 0 0 0.88086 0.0625 20 20 0 0 0 6.7461-1.2246l5.7227 6.1387-1.4785-8.2227a20 20 0 0 0 5.5254-5.4668l8.1875 1.5879-6.0293-5.791a20 20 0 0 0 1.3262-7.0215 20 20 0 0 0-0.015625-0.66406l7.5156-3.5195-8.2246-1.127a20 20 0 0 0-3.5059-6.9824l4.0234-7.2891-7.334 3.9434a20 20 0 0 0-6.9082-3.5703l-1.0234-8.291zm-25.213 41.115-50.35 50.35 0.0078124 0.007812a5 5 0 0 0-1.4727 3.5273 5 5 0 0 0 5 5 5 5 0 0 0 3.5273-1.4727l0.0078124 0.007812 50.35-50.35c-2.8196-1.8561-5.2206-4.2485-7.0703-7.0703z"/></svg>',
            flail: '<svg viewBox="0 0 100 100" fill="currentColor"><path d="m95.454 2.9144a1.5697 1.5697 0 0 0-2.2187-1e-6l-0.38357 0.38357-0.20495-0.20495-1.0661-1.0661s-0.77742-0.63269-1.2316-0.8292c-0.49066-0.2123-1.5625-0.35537-1.5625-0.35537l-12.109-0.84236-3.3732 5.2309s1.4006 1.483 1.8051 2.3992c0.296 0.6705 0.51799 1.438 0.40614 2.1623-0.08775 0.56821-0.42238 1.1002-0.81604 1.5193-0.64918 0.69105-1.5477 1.1181-2.4161 1.4986-0.70503 0.30889-1.4707 0.46202-2.2244 0.61861-0.66122 0.13738-2.0062 0.28016-2.0062 0.28016s-3.0719 8.5293-3.8696 12.97c-0.11676 0.64999-0.16995 1.3188-0.13162 1.978 0.02433 0.41854 0.03879 0.86096 0.22751 1.2353l-9.4258 9.4258a4.0844 4.0844 0 0 0-1.1714 3.0968l-46.001 46.001-7.7016 5.7762v5.7762h5.7762l5.7762-7.7016 46.001-46.001a4.0844 4.0844 0 0 0 3.0968-1.1714l9.4258-9.4258c0.37437 0.18872 0.81679 0.20318 1.2353 0.22751 0.65928 0.03833 1.328-0.01485 1.978-0.13162 4.4407-0.79773 12.97-3.8696 12.97-3.8696s0.14278-1.345 0.28016-2.0062c0.15658-0.75363 0.30971-1.5193 0.6186-2.2244 0.38049-0.86846 0.80752-1.767 1.4986-2.4161 0.41905-0.39365 0.95105-0.72829 1.5193-0.81604 0.72434-0.11186 1.4918 0.11014 2.1623 0.40614 0.91622 0.40446 2.3992 1.8051 2.3992 1.8051l5.2309-3.3732-0.24068-3.4597-0.48134-6.9194-0.12034-1.7298s-0.14307-1.0718-0.35537-1.5625c-0.19651-0.45415-0.8292-1.2316-0.8292-1.2316l-1.2711-1.2711 0.38357-0.38357a1.5697 1.5697 0 0 0 0-2.2187l-0.81603-0.81603z"/></svg>',
            polearm: '<svg viewBox="0 0 100 100" fill="currentColor"><path d="m95.481 4.5-12.209 4.0702-5.7185 8.5508c0.26613 0.1975 0.52421 0.40884 0.76443 0.64903l3.8925 3.8923c0.23974 0.23973 0.44991 0.49882 0.64712 0.76438l8.5553-5.7182zm-60.323 14.257c-2.8459-0.03183-5.5133 0.90711-7.48 2.8737l19.674 19.672 8.1389-8.1403-9.5856-9.585c-3.1334-3.1332-7.0879-4.7799-10.747-4.8208zm38.206 0.96378c-0.76852 0-1.5368 0.29339-2.1232 0.87972-0.8237 0.83045-1.0915 2.0647-0.68427 3.1611l-70.556 70.348 0.0058652 5.8824 5.8789 0.0078 70.335-70.577c1.0965 0.40724 2.3289 0.14137 3.1594-0.68227 1.1727-1.1727 1.1727-3.0754 0-4.2481l-3.8925-3.8923c-0.58636-0.58632-1.3547-0.87972-2.1232-0.87972zm1.2903 16.93-23.815 23.813c6.5914 8.8236 7.8139 19.149 2.3617 24.601-0.08761 0.0876-0.18166 0.16607-0.27175 0.25023 12.384 1.9435 25.41-2.4797 34.767-11.808 9.3579-9.3587 13.801-22.408 11.853-34.811-0.09774 0.10583-0.19278 0.21427-0.29521 0.3167-5.4522 5.4518-15.776 4.2295-24.6-2.3616z"/></svg>',
            halberd: '<svg viewBox="0 0 100 100" fill="currentColor"><path d="m95.481 4.5-12.209 4.0702-5.7185 8.5508c0.26613 0.1975 0.52421 0.40884 0.76443 0.64903l3.8925 3.8923c0.23974 0.23973 0.44991 0.49882 0.64712 0.76438l8.5553-5.7182zm-60.323 14.257c-2.8459-0.03183-5.5133 0.90711-7.48 2.8737l19.674 19.672 8.1389-8.1403-9.5856-9.585c-3.1334-3.1332-7.0879-4.7799-10.747-4.8208zm38.206 0.96378c-0.76852 0-1.5368 0.29339-2.1232 0.87972-0.8237 0.83045-1.0915 2.0647-0.68427 3.1611l-70.556 70.348 0.0058652 5.8824 5.8789 0.0078 70.335-70.577c1.0965 0.40724 2.3289 0.14137 3.1594-0.68227 1.1727-1.1727 1.1727-3.0754 0-4.2481l-3.8925-3.8923c-0.58636-0.58632-1.3547-0.87972-2.1232-0.87972zm1.2903 16.93-23.815 23.813c6.5914 8.8236 7.8139 19.149 2.3617 24.601-0.08761 0.0876-0.18166 0.16607-0.27175 0.25023 12.384 1.9435 25.41-2.4797 34.767-11.808 9.3579-9.3587 13.801-22.408 11.853-34.811-0.09774 0.10583-0.19278 0.21427-0.29521 0.3167-5.4522 5.4518-15.776 4.2295-24.6-2.3616z"/></svg>',
            glaive: '<svg viewBox="0 0 100 100" fill="currentColor"><path d="m100 0-30.777 30.65c1.3941 0.25218 2.6921 0.91848 3.707 1.9336 2.7078 2.7084 2.7078 7.19 0 9.8984l-15.227 15.227a16 30 45 0 1-3.834 19.477c2.1663-1.3949 4.5431-2.9704 6.1797-4.2324 3.6982-2.8519 6.9642-5.8681 10.795-9.6777 3.8307-3.8097 8.6204-8.6061 12.035-13.275 3.4148-4.6692 5.6924-8.5511 8.4355-14.516 2.7431-5.9646 6.1574-15.343 7.4453-21.34 1.2879-5.9964 1.2402-14.145 1.2402-14.145zm-32.021 33.533a4 4 0 0 0-2.8281 1.1719l-65.15 65.15v0.14453h11.168l59.639-59.639a4 4 0 0 0 0-5.6562 4 4 0 0 0-2.8281-1.1719z"/></svg>',
            pike: '<svg viewBox="0 0 100 100" fill="currentColor"><path d="m100 0s-10.809 7.1032-15.97 10.992c-6.4613 4.8686-12.749 9.9854-18.74 15.423-4.4184 4.0101-8.9423 7.9893-12.658 12.658-3.2548 4.0895-8.3151 13.293-8.3151 13.293l-0.90619 0.90619c-1.3475-0.25388-2.7336 0.17269-3.7052 1.1403-0.96759 0.97161-1.3942 2.3577-1.1403 3.7052l-0.51844 0.51844-1.2825-1.2825c-0.40609-0.40609-1.0645-0.40609-1.4706 0l-4.0441 4.0441-3.3533-3.3533c0.46667-0.30318 0.94677-0.5834 1.4548-0.80566 0.92609-0.40518 2.9196-0.82002 2.9196-0.82002s-2.4183-1.5541-3.7397-2.0996c-1.7799-0.7348-4.4717-1.2773-5.5664-1.551-1.0947-0.27368-3.9247-0.47139-5.8924-0.40068-1.824 0.06554-5.4214 0.76258-5.4214 0.76258s3.2671 2.0175 4.4721 3.4697c1.0674 1.2863 1.9836 2.2568 2.6008 3.6032 0.73604 1.6058 1.2308 5.1542 1.2308 5.1542l1.7363-1.7535s0.46127-0.36765 0.73529-0.36765c0.27403-1e-6 0.7353 0.36765 0.7353 0.36765l2.9412 2.9412-11.397 11.397c-0.40609 0.40609-0.40609 1.0645 0 1.4706l-14.706 14.706v5.8824l5.8824-1e-6 14.706-14.706c0.40609 0.40609 1.0645 0.40609 1.4706 0l11.397-11.397 2.9412 2.9412s0.36765 0.46126 0.36765 0.73529c0 0.27403-0.36765 0.73529-0.36765 0.73529l-1.7535 1.7363s3.5484 0.49471 5.1542 1.2308c1.3465 0.61717 2.3169 1.5335 3.6032 2.6008 1.4522 1.205 3.4697 4.4721 3.4697 4.4721s0.69703-3.5974 0.76258-5.4214c0.07071-1.9677-0.12699-4.7977-0.40068-5.8924-0.27368-1.0947-0.81621-3.7865-1.551-5.5664-0.5455-1.3214-2.0996-3.7397-2.0996-3.7397s-0.41485 1.9935-0.82003 2.9196c-0.22226 0.50802-0.50248 0.98812-0.80566 1.4548l-3.3533-3.3533 4.0441-4.0441c0.40609-0.40609 0.40609-1.0645 0-1.4706l-1.2825-1.2825 0.51844-0.51844c1.3475 0.25388 2.7336-0.17269 3.7052-1.1403 0.97152-0.97174 1.4004-2.3606 1.146-3.7109l0.90045-0.90045s9.2031-5.0603 13.293-8.3151c4.6685-3.7156 8.648-8.2397 12.658-12.658 5.4372-5.9907 10.554-12.279 15.423-18.74 3.8889-5.1611 10.992-15.97 10.992-15.97z"/></svg>',
            lance: '<svg viewBox="0 0 100 100" fill="currentColor"><path d="m100 0-38.035 34.277-19.02 17.139-19.018 17.139s-0.30758 0.17822-0.46484 0.021484c-0.33186-0.33074-1.0796-0.52324-1.6055-0.41406-0.25676 0.053292-1.8669 0.11468-3.5762 0.13867-3.1644 0.044414-5.1013-0.13474-6.5586-0.60742-0.44731-0.14509-1.0571-0.25445-1.3555-0.24414l-0.54297 0.017578 4.498 4.4824 4.2969 4.2832-16.227 18.141-0.43555 1.1895c-0.23939 0.65419-0.77674 1.891-1.1953 2.748-0.41856 0.85701-0.7617 1.614-0.76172 1.6816 7.0236e-6 0.067632 0.75217-0.27342 1.6719-0.75781 0.9197-0.48439 2.1771-1.0987 2.793-1.3633l1.1191-0.48047 18.109-15.996 4.2227 4.1562h0.001953c4.1348 4.0684 4.4325 4.3375 4.5742 4.1289 0.085041-0.12516-0.016986-0.78078-0.23242-1.4922-0.59131-1.9526-0.77351-4.1821-0.62891-7.6992 0.14519-3.5315 0.14046-3.6321-0.18555-3.957-0.17069-0.17012-0.20508-0.41406-0.20508-0.41406l17.191-19.029 51.568-57.088z"/></svg>',
            rapier: '<svg viewBox="0 0 100 100" fill="currentColor"><path d="m93.809 0-26.353 27.342-16.521 17.168s-0.93021-0.84613-2.1465-1.8418c-1.8982-1.554-3.7185-2.4859-6.4668-3.3125-1.1384-0.34237-2.347-0.38129-2.9375-0.09375-0.15032 0.0732-0.68292 0.22686-1.1816 0.3418-1.6484 0.37986-3.8685 1.4541-5.0703 2.4531-0.7453 0.61956-1.4344 1.7188-2.1133 2.6074-0.29145 0.38154-0.59566 0.75574-0.84179 1.168-0.54387 0.91094-1.2077 1.9543-1.3926 2.8614-0.04339 0.21305-0.10955 0.93635-0.14648 1.6055-0.03694 0.66914-0.12606 1.3177-0.19726 1.4414-0.07118 0.12377-0.36485 0.28511-0.65234 0.35938-0.4706 0.12158-0.56195 0.10348-0.92773-0.18946-0.30886-0.24736-0.40299-0.42955-0.39062-0.75782 0.03583-0.93322 0.51769-2.5232 1.1562-3.8184 0.69614-1.412 1.5678-1.9079 2.4355-2.7832 0.45015-0.45405 0.96212-0.84141 1.4316-1.2754 0.47681-0.44073 1.0112-1.0148 1.4062-1.3477 0.395-0.33289 0.58593-0.61329 0.58593-0.61329s-2.0385 0.7074-3.0215 1.1484c-0.88638 0.39772-1.796 0.78013-2.5859 1.3457-0.86611 0.62013-1.6788 1.3513-2.3105 2.209-0.53857 0.73117-0.85778 1.4004-1.2129 2.4395-0.15164 0.44375-0.4043 0.80079-0.4043 0.80079 0 1e-6 -1.5793-1.4413-1.6562-1.5234l-2.9043-2.9961c-2.6398-2.7229-4.9138-5.0025-5.1113-5.125-0.24651-0.15292-1.5839 1.0178-2.0664 1.8086-0.16042 0.26293-0.26413 0.41644-0.25976 0.57227 0.00711 0.25277 0.29731 0.50961 1.084 1.2422 1.9619 1.8271 4.0011 3.7783 6.0586 5.711 0.70678 0.67253 1.399 1.3155 2.0996 1.9707 0.81119 0.75868 1.6261 1.513 2.4375 2.2715 1.5255 1.4262 3.1348 2.9485 4.5683 4.2852 2.3477 2.189 2.6046 2.469 2.5722 2.8242-0.01977 0.21689-0.07886 0.43438-0.13086 0.48243-0.05197 0.04803-1.6534 9e-3 -3.5586-0.08594-2.6924-0.13412-3.0474-0.16877-4.5586-0.0078-1.0724 0.11423-2.1304 0.3731-3.1621 0.68751-0.42264 0.1288-0.82491 0.31755-1.2324 0.48828-0.33699 0.14119-0.67126 0.288-1.0019 0.44336-0.52119 0.24487-1.0365 0.50281-1.5469 0.76954-0.69171 0.36151-1.4273 0.66067-2.0547 1.125-1.5557 1.1515-3.2364 2.3515-4.1523 4.0567-1.7713 3.2974-2.5523 7.9084-2.1094 11.029 0.18098 1.2751 0.25411 1.5618 0.74414 2.9356 0.61476 1.7234 1.3315 2.8964 2.8203 4.6133 0.47994 0.55352 0.87151 1.0557 0.86914 1.1152-0.00228 0.05955-0.12892 0.23133-0.28125 0.38282-0.15233 0.15148-0.41372 0.5152-0.58007 0.80665-0.29731 0.52083-0.29777 0.53823-0.074219 1.0352 0.36729 0.81645 0.81296 1.082 1.8828 1.1231 0.86624 0.03329 0.94768 9e-3 1.4101-0.40625 0.59204-0.53155 0.84465-1.1514 0.78711-1.9297-0.043441-0.58752-0.712-1.0623-1.0996-1.5703-1.023-1.3408-2.4973-2.3767-3.2285-3.8965-0.80415-1.6714-1.4078-3.613-1.1328-5.4473 0.37982-2.5336 1.8485-4.9669 3.7012-6.7364 1.2924-1.2344 3.0609-2.0085 4.8125-2.3633 3.1419-0.63638 6.4982-0.25708 9.6015 0.54688 1.5774 0.40867 2.994 1.3073 4.4023 2.127 1.1572 0.67351 3.4077 2.1235 3.3066 2.2813l-1.5488 1.8242c-0.44207 0.50058-0.91373 0.97375-1.3555 1.4746-0.66662 0.75586-1.3108 1.532-1.9531 2.3086-0.73588 0.88984-1.4454 1.799-2.1758 2.6934-0.82602 1.0115-1.655 2.0209-2.4941 3.0215-0.49416 0.58924-1.013 1.1575-1.4961 1.7559-0.32561 0.40324-0.63124 0.82404-0.94531 1.2363-0.37265 0.48919-1.0992 1.4621-1.1152 1.4688-0.24563 0.10285-0.68139 0.13916-1.3359 0.11523-1.9069-0.06967-4.1064 0.58394-5.416 1.6113-0.38914 0.30529-0.74415 0.52545-1.3281 1.1133-0.58396 0.58785-1.3518 1.8703-1.8066 3.0918-0.5437 1.4602-0.64835 3.7707-0.24023 5.2754 0.27855 1.027 0.27798 1.0539 0.021484 1.3164-0.14397 0.14737-0.53239 0.39064-0.86523 0.54102-1.006 0.45456-1.4128 1.4925-0.94531 2.4102 0.31438 0.61714 1.3019 1.5331 2.0215 1.875 0.52405 0.24897 0.71923 0.27976 1.1484 0.18164 0.61673-0.14098 1.1619-0.69608 1.3066-1.332 0.057764-0.25384 0.19724-0.53268 0.36133-0.81837 0.16408-0.28571 0.24278-0.32144 0.38672-0.25977 0.4642 0.199 1.7547 0.34216 2.6445 0.36133 0.76558 0.01651 1.5497-0.0064 2.2871-0.21289 1.1335-0.31744 2.2126-0.86826 3.1758-1.5449 0.43289-0.30411 0.80557-0.69484 1.1367-1.1074 1.8212-2.2691 2.4268-4.0398 2.2637-6.8751l-0.07227-1.2481c0.59715-0.5047 1.7207-1.5938 1.7207-1.5938l4.0996-3.6035s1.6885-1.3747 2.9433-2.5117c1.2549-1.137 2.4863-2.2379 4.1875-3.9082 0.904-0.89062 2.7461-2.7207 2.7461-2.7207s0.67244 0.22158 1.5879 0.86719c2.8357 1.9999 5.7017 3.444 8.3535 4.209 1.191 0.34363 1.871 0.44883 3.709 0.57618l2.2519 0.15625s0.48666 0.45477 0.73242 0.6797c0.29116 0.26648 0.58543 0.53099 0.8789 0.79493 0.54008 0.48574 1.0865 0.96372 1.625 1.4512 0.71668 0.64873 1.4266 1.305 2.1367 1.961 3.4137 3.1533 8.7958 8.1572 10.207 9.4962 0.7826 0.74258 1.5576 1.4283 1.7226 1.5234 0.43497 0.2508 0.79172 0.09745 1.2129-0.52149 0.20403-0.29984 0.52002-0.71055 0.70117-0.91212 0.49562-0.5515 0.44604-0.96576-0.1914-1.6016-0.57162-0.57017-4.1096-3.5138-6.1796-5.252-0.95025-0.79791-1.91-1.585-2.8652-2.377-0.59189-0.4907-1.1906-0.97347-1.7754-1.4727-0.567-0.48406-1.1218-0.98199-1.6797-1.4766-0.50269-0.44569-1.0138-0.88233-1.5039-1.3418-0.61241-0.57412-1.8021-1.5434-1.7949-1.7656 3e-3 -0.09021 0.2055-0.25859 0.44922-0.37305 1.004-0.4715 3.2734-2.5237 4.2422-4.2852 1.613-2.9329 1.9003-5.7667 2.248-8.7618 0.24803-2.1361 0.10633-4.3137-0.1289-6.4512-0.09642-0.87617-0.18696-1.7771-0.52343-2.5918-0.4996-1.2097-1.3603-2.2425-2.1641-3.2754-0.77185-0.99196-2.539-2.7871-2.539-2.7871l16.832-18.055 17.346-18.662 9.6894-10.426v-1.8985z"/></svg>',
            scimitar: '<svg viewBox="0 0 100 100" fill="currentColor"><path d="m76.859 23.662c-0.53027 3.0321-1.397 6.3299-3.0491 9.9663-1.6521 3.6364-4.0897 7.6114-7.7618 11.998-3.6721 4.3865-8.5786 9.1845-15.169 14.467-6.59 5.2824-14.864 11.049-25.27 17.373l-2.8818-5.1128c-0.69904-1.2398-2.2652-1.675-3.498-0.97203-1.2329 0.70299-1.6656 2.278-0.96654 3.5178l2.6992 4.7882-16.145 9.3994-2.2117 1.2582c-2.4671 1.4035-3.3357 4.5526-1.94 7.0336 1.3956 2.4811 4.527 3.3546 6.9941 1.951l2.2335-1.2707c0.015314-0.0089 0.030579-0.01725 0.045808-0.02603l16.079-9.3587 0.46642 0.82916c0.0015-2e-3 0.0068-8e-3 0.0085-0.01082l2.387 4.2332c0.69904 1.2398 2.2652 1.675 3.498 0.97203 1.2328-0.70299 1.6656-2.278 0.96654-3.5178l-2.8362-5.0317 23.821-15.339 15.681-10.089c4.3688-2.8929 8.6228-6.6875 12.489-11.114 3.8664-4.4263 7.3453-9.4844 10.163-14.904 2.8182-5.4199 4.9758-11.202 6.1998-17.075 1.224-5.8736 1.5144-11.839 0.59833-17.627-3.982 7.9937-7.2759 12.671-10.753 15.968-3.4768 3.2978-7.1365 5.2165-11.85 7.6938z"/></svg>',
            sickle: '<svg viewBox="0 0 100 100" fill="currentColor"><path d="m85.869 7.7289c-3.7696-2.9399-4.6051-3.486-6.7479-4.4135-6.4047-2.7721-12.263-3.7409-19.045-3.1485-9.2854 0.81118-17.544 5.3121-23.438 12.772-3.83 4.8475-6.27 10.014-7.6434 16.179-2.0426 9.1689-0.65215 19.661 3.7935 28.652l0.96214 1.9472-1.175 1.1798c-0.74881 0.75277-2.1818 1.2791-2.4096 1.3613a4.9497 4.9503 0 0 0-3.1687 1.5468l-25.688 27.89a4.9497 4.9503 0 0 0 0.28621 6.9954 4.9497 4.9503 0 0 0 6.9945-0.28624l25.689-27.892a4.9497 4.9503 0 0 0 1.3061-3.4376c-0.0053-0.38253 0.05323-2.0136 1.4833-3.7778l1.8405-2.2734 0.32064-4.2765c0.24775-3.3017 0.16351-5.5717-0.3713-9.9535-0.76031-6.2294-0.71739-9.0286 0.20377-13.555 0.97753-4.8034 2.7225-8.571 5.7858-12.491 7.2353-9.2594 19.601-12.568 31.846-8.5194 3.3987 1.1238 6.047 2.577 9.1828 5.0395 6.7681 5.3148 11.371 12.652 13.259 21.141 0.32185 1.4464 0.65796 2.5398 0.7453 2.4282 0.31633-0.40422-0.05194-7.3077-0.55978-10.497-0.82402-5.1749-2.4638-9.5977-5.0615-13.659-2.6889-4.2036-3.727-5.3129-8.3925-8.9515z"/></svg>',
            whip: '<svg viewBox="0 0 100 100" fill="currentColor"><path d="m55.959 0.0031582c-5.1897-0.057591-10.391 0.67268-15.279 2.1738-6.9077 1.9069-12.777 5.7739-18.434 9.7422-5.6879 4.8615-11.039 10.373-13.824 17.121-2.9506 6.0789-4.6955 12.657-5.5156 19.24-0.39753 3.1604-0.64913 6.2641-0.85547 9.17h9.4825c0.131-1e-6 0.25947 0.01078 0.38867 0.01953 0.09813-2.2031 0.22995-4.4943 0.4668-6.5723 0.75149-8.2804 2.7817-16.696 7.291-23.973 3.016-4.0126 6.4009-7.981 10.799-10.813 9.0522-7.1822 21.767-10.498 33.547-8.2168 5.3272 0.67801 10.074 3.0077 14.453 5.7617 6.0833 4.9433 11.402 11.105 13.701 18.356 4.1334 11.724 0.30101 25.053-8.3907 34.229-5.0526 5.5876-13.077 9.6106-21.139 8.5313-9.895-0.89966-19.503-5.6301-24.955-13.371-5.0082-5.9709-4.5902-14.245-1.8203-20.967 2.5908-5.2168 7.2675-9.8647 13.291-11.668 6.5672-2.2356 14.577 0.1524 18.58 5.4531 2.8654 4.5003 3.6683 11.958 2.0059 18-1.1431 4.0827-4.3351 7.9719-9.1309 8.6661-5.4827 0.93068-9.6112-4.3683-9.1446-8.9844 0.78041-7.2115 6.2228-13.222 11.838-17.918-5.111 2.9188-8.7518 7.6223-11.344 12.527-2.7885 4.9261-1.9783 12.279 3.8692 14.99 3.9582 1.942 8.4902 0.05624 11.393-2.6172 5.304-5.9804 6.3202-14.04 3.7637-21.729-1.5369-5.1624-7.4723-10.312-13.998-11.131-8.8267-1.3422-17.544 3.6838-22.078 10.424-4.9752 7.3975-6.2947 17.351-1.4219 25.07 5.0581 8.7435 14.728 14.763 25.184 16.801 7.4189 1.8989 15.509 0.60007 21.94-3.2363 2.1799-1.3031 4.0756-2.9358 5.9668-4.5606 6.6393-6.274 11.125-14.503 12.815-23.086 1.7026-8.7733-0.32706-17.879-4.9199-25.67-3.6654-5.6779-8.1839-11.053-14.158-14.807-7.0952-4.574-15.716-6.8611-24.365-6.9571zm-53.959 61.448c-1.108 0-2 0.89201-2 2v0.6543c0 1.0293 0.77003 1.8698 1.7676 1.9844v28.91c0 2.7614 2.2386 5 5 5s5-2.2386 5-5v-28.91c0.99662-0.11548 1.7656-0.9558 1.7656-1.9844v-0.6543c0-1.108-0.89201-2-2-2h-6.5801z"/></svg>',
            net: '<svg viewBox="0 0 24 24" fill="currentColor"><path d="M12 2L2 7l10 5 10-5-10-5zM2 17l10 5 10-5M2 12l10 5 10-5"/></svg>',
            sling: '<svg viewBox="0 0 100 100" fill="currentColor"><path d="m12 0a6 6 0 0 0-4.2422 1.7578 6 6 0 0 0 0 8.4844l3.1719 3.1719 8.4805-8.4805c0.001307-0.0013075 0.0026-0.0026009 0.003906-0.0039063l-3.1719-3.1719a6 6 0 0 0-4.2422-1.7578zm75.061 0.074219a6 6 0 0 0-3.3027 1.6836l-3.1719 3.1719c0.001311 0.0013083 0.002595 0.0025959 0.003906 0.0039063l8.4805 8.4805 3.1719-3.1719a6 6 0 0 0 0-8.4844 6 6 0 0 0-5.1816-1.6836zm-64.822 5.6875a2 2 0 0 0-1.4141 0.58594l-9.0801 9.0801v23.572h4v-21.916l7.9082-7.9082a2 2 0 0 0 0-2.8281 2 2 0 0 0-1.4141-0.58594zm55.697 0.0078124a2 2 0 0 0-0.69141 0.060547 2 2 0 0 0-0.89648 0.51758 2 2 0 0 0 0 2.8281l7.9082 7.9082v21.916h4v-23.572l-9.0801-9.0801a2 2 0 0 0-1.2402-0.57812zm-52.865 4.8164c-0.00131 0.001314-0.002591 0.002591-0.003906 0.003906l-7.3223 7.3223v2.3164l26.256 26.256v22.516 6.25 6.25 12.5a6 6 0 0 0 6 6 6 6 0 0 0 6-6v-12.5-6.25-6.25-22.516l26.256-26.256v-2.3164l-7.3223-7.3223c-0.001315-0.001315-0.002595-0.002591-0.003906-0.003906l-24.93 24.93-24.93-24.93zm-13.289 28.496c0.69822 19.536 12.561 35.652 28.219 37.893v-1.7246-2.3281c-13.096-2.257-23.545-16.177-24.221-33.84h-3.998zm72.439 0c-0.67564 17.663-11.124 31.583-24.221 33.84v2.3281 1.7246c15.657-2.2405 27.521-18.357 28.219-37.893h-3.998z"/></svg>',
            club: '<svg viewBox="0 0 100 100" fill="currentColor"><path d="m94.249 5.7496c-4.9704-4.9705-10.867-7.1313-13.171-4.8271 0 0-0.22207 0.24271-0.6726 0.73744-0.43322 0.47576-4.5831-2.2476-5.9616-0.8806-1.4081 1.4081 1.5446 5.7174 1.1021 6.202-0.44249 0.48466-3.0986 3.3918-3.5413 3.8763-0.44266 0.4845-4.1721-2.0318-5.4254-0.79011-1.2801 1.2801 1.4433 5.1515 1.0008 5.6361-0.44251 0.48464-1.6869 1.849-1.6869 1.849s-1.8498 2.0302-2.3001 2.5216c-0.4364 0.47626-3.7515-1.8389-4.8797-0.71988-1.1521 1.1521 1.3747 4.6169 0.91706 5.0878-0.457 0.47015-3.8587 4.1964-3.8587 4.1964s-4.0267 4.4107-4.5434 4.9595c-0.52634 0.559-2.0859-0.33782-2.5878 0.15667-0.51204 0.51205 0.53301 2.1454 0.12291 2.5945-0.49902 0.54653-3.4364 3.7382-8.1752 8.9181-4.7388 5.18-13.827 14.493-20.244 22.173-5.127 6.136-14.558 19.067-14.558 19.067a2.6224 2.6224 0 0 0-3.6385 0.05402 2.6224 2.6224 0 0 0-0.00135 3.7075l0.060777 0.06078-0.6726 0.71853c-1.0241 1.0241-1.5343 2.3666-1.5343 3.7088 0 1.3422 0.5102 2.6847 1.5343 3.7088 1.0241 1.0241 2.3665 1.5343 3.7088 1.5343 1.3422 0 2.6847-0.51021 3.7088-1.5343l0.71852-0.67261 0.06078 0.06078a2.6224 2.6224 0 0 0 3.7074-0.0014 2.6224 2.6224 0 0 0 0.05942-3.644s12.927-9.4276 19.061-14.553c7.6801-6.417 16.999-15.5 22.173-20.244 5.1742-4.7448 8.3778-7.7201 8.8978-8.1956 0.552-0.50486 2.1027 0.65522 2.6148 0.14317 0.4988-0.50033-0.42064-2.0721 0.12831-2.6162 0.49342-0.48886 4.9878-4.5151 4.9878-4.5151s3.6783-3.4496 4.1626-3.8925c0.48428-0.44287 3.9707 2.1016 5.1228 0.94949 1.1228-1.1273-1.2487-4.4923-0.76444-4.9352 0.48428-0.44287 2.5162-2.2947 2.5162-2.2947s1.3607-1.2454 1.8449-1.6883c0.48428-0.44287 4.4086 2.3336 5.6888 1.0535 1.2481-1.2511-1.3311-5.0412-0.85628-5.4754 0.43593-0.39873 3.3987-3.1079 3.883-3.5508 0.48428-0.44286 4.8533 2.5697 6.2614 1.1615 1.3733-1.3764-1.4176-5.5904-0.93326-6.0332 0.48428-0.44286 0.79145-0.59968 0.79145-0.59968 2.3042-2.3042 0.14198-8.2022-4.8284-13.173z"/></svg>',
            trident: '<svg viewBox="0 0 100 100" fill="currentColor"><path d="m63.514 0c-0.047072-0.048483-4.2258 2.3474-9.2852 5.3223-6.9639 4.0948-9.1973 5.5062-9.1973 5.8105 0 0.28907-1.7173 2.1177-6.1113 6.5117-4.7022 4.7022-6.4042 6.5276-7.3867 7.9199-6.4559 9.1491-7.5135 20.906-2.793 31.043 0.72993 1.5675 0.79034 1.8891 0.4707 2.5332-0.53516 1.0785-0.47111 2.8723 0.1582 4.3926l0.42188 1.0195-29.791 29.791v5.6562h5.6562l29.791-29.791 1.0176 0.41992c1.5203 0.62932 3.3141 0.69532 4.3926 0.16016 0.64415-0.31964 0.96762-0.26118 2.5352 0.46875 10.137 4.7205 21.894 3.6629 31.043-2.793 1.3924-0.98249 3.2157-2.6845 7.918-7.3867 4.3811-4.3811 6.2245-6.1094 6.5117-6.1094 0.30236 0 1.7272-2.2546 5.8125-9.1992 2.9763-5.0594 5.3713-9.2381 5.3223-9.2852z"/></svg>',
            morningstar: '<svg viewBox="0 0 100 100" fill="currentColor"><path d="m77.027 0-3.625 7.5215a20 20 0 0 0-0.90234-0.021484 20 20 0 0 0-6.7461 1.2246l-5.7227-6.1387 1.4785 8.2227a20 20 0 0 0-5.5254 5.4668l-8.1875-1.5879 6.0293 5.791a20 20 0 0 0-1.3262 7.0215 20 20 0 0 0 0.046875 0.65039l-7.5469 3.5332 8.2402 1.1289a20 20 0 0 0 13.709 13.895l1.0234 8.293 3.6465-7.5625a20 20 0 0 0 0.88086 0.0625 20 20 0 0 0 6.7461-1.2246l5.7227 6.1387-1.4785-8.2227a20 20 0 0 0 5.5254-5.4668l8.1875 1.5879-6.0293-5.791a20 20 0 0 0 1.3262-7.0215 20 20 0 0 0-0.015625-0.66406l7.5156-3.5195-8.2246-1.127a20 20 0 0 0-3.5059-6.9824l4.0234-7.2891-7.334 3.9434a20 20 0 0 0-6.9082-3.5703l-1.0234-8.291zm-25.213 41.115-50.35 50.35 0.0078124 0.007812a5 5 0 0 0-1.4727 3.5273 5 5 0 0 0 5 5 5 5 0 0 0 3.5273-1.4727l0.0078124 0.007812 50.35-50.35c-2.8196-1.8561-5.2206-4.2485-7.0703-7.0703z"/></svg>',
            
            // Spell School Icons (tw-dnd with octagon frame + inner symbols)
            abjuration: '<svg viewBox="0 0 100 100" fill="currentColor"><path d="m69.536 100h-39.075c-2.9187-0.76829-4.5391-3.7521-6.7983-5.627-7.6116-7.6112-15.223-15.222-22.835-22.834-1.5188-2.6082-0.55581-5.863-0.82713-8.7863v-32.294c0.76839-2.9186 3.7523-4.5389 5.6272-6.798 7.6116-7.6112 15.223-15.222 22.835-22.834 2.6082-1.5187 5.863-0.5558 8.7864-0.82709h32.291c2.9187 0.76829 4.5391 3.7521 6.7983 5.627 7.6116 7.6112 15.223 15.222 22.835 22.834 1.5188 2.6082 0.55581 5.863 0.82713 8.7863v32.29c-0.76838 2.9186-3.7523 4.5389-5.6272 6.798-7.6116 7.6112-15.223 15.222-22.835 22.834l-0.918 0.61651zm-37.904-5.6591h36.733c8.6587-8.6584 17.317-17.317 25.976-25.975v-36.732l-25.976-25.975h-36.733c-8.6587 8.6584-17.317 17.317-25.976 25.975v36.736c8.6587 8.6569 17.317 17.314 25.976 25.971z"/><path d="m49.982 21.957c-8.0028 2.2011-16.006 4.4022-24.008 6.6033v27.015c1.86 8.5373 7.8072 15.618 14.487 20.961 2.9006 2.2434 6.0777 4.1685 9.5213 5.4537 9.762-3.7726 18.163-11.4 22.437-21.001 1.1914-2.6209 1.7629-5.4668 1.5711-8.3354v-24.094c-8.0028-2.2011-16.006-4.4022-24.008-6.6033zm0 3.502v52.029c-8.0919-3.2235-14.82-9.6377-18.857-17.315-1.2663-2.4886-2.2019-5.218-1.9505-8.0381v-20.952c6.9357-1.9077 13.871-3.8155 20.807-5.7232z"/></svg>',
            conjuration: '<svg viewBox="0 0 100 100" fill="currentColor"><path d="m30.463-2.3384e-8c-0.74877 0-1.4714 0.29574-2.0025 0.82682l-27.634 27.634c-0.5311 0.52673-0.82682 1.2473-0.82682 1.996v39.087c0 0.74874 0.29572 1.4649 0.82682 1.996l27.634 27.634c0.52675 0.53106 1.2537 0.82682 2.0025 0.82682h39.074c0.75312 0 1.4714-0.29785 2.0025-0.83328l27.634-27.634c0.53109-0.52673 0.82682-1.2473 0.82682-1.996v-39.08c0-0.74873-0.29572-1.4649-0.82682-1.996l-27.634-27.634c-0.52675-0.53108-1.2537-0.82682-2.0025-0.82682zm1.1692 5.6585h36.729l25.98 25.974v36.735l-25.98 25.974h-36.729l-25.98-25.974v-36.735zm18.364 9.3405c-1.2577 0-2.3787 0.7966-2.797 1.9831l-6.9569 19.74-20.651 0.3359c-1.2547 0.01977-2.3632 0.82593-2.7647 2.0154s-0.01038 2.4988 0.97539 3.275l16.407 12.932-5.82 19.585c-0.35594 1.1974 0.07965 2.4947 1.0852 3.2362 1.0075 0.74155 2.366 0.77062 3.4042 0.07752l17.118-11.433 17.118 11.433c0.5003 0.33419 1.0737 0.49738 1.6472 0.49738 0.61994 0 1.2424-0.19028 1.7635-0.5749 1.0065-0.74353 1.4357-2.0389 1.0787-3.2362l-5.8265-19.585 16.42-12.932c0.98478-0.77714 1.3713-2.0865 0.96893-3.275-0.40044-1.1894-1.5015-1.9956-2.7582-2.0154l-20.658-0.3359-6.9505-19.74c-0.41922-1.1865-1.5467-1.9831-2.8034-1.9831zm-18.875 6.2657c-0.57092 0.02185-1.145 0.21191-1.6407 0.5749-1.321 0.96797-1.6075 2.8251-0.63949 4.147l3.3008 4.5023c0.58039 0.79296 1.4839 1.2144 2.3965 1.2144 0.60808 0 1.2216-0.18731 1.7505-0.5749 1.321-0.96797 1.6075-2.8251 0.63949-4.147l-3.3008-4.5023c-0.60498-0.82621-1.5548-1.2508-2.5063-1.2144zm37.762 0c-0.95102-0.03667-1.9065 0.38756-2.5128 1.2144l-3.3008 4.5023c-0.96995 1.3219-0.68344 3.179 0.63949 4.147 0.527 0.38758 1.1405 0.5749 1.7505 0.5749 0.91162 0 1.8151-0.42143 2.3965-1.2144l3.3008-4.5023c0.96798-1.3219 0.68047-3.179-0.63949-4.147-0.49424-0.36262-1.0636-0.5529-1.6343-0.5749zm-43.957 33.919c-0.29195 0.0051-0.58651 0.05273-0.8785 0.14857l-5.342 1.7699c-1.5543 0.51612-2.3958 2.1987-1.8797 3.753 0.4123 1.2458 1.5725 2.0348 2.8164 2.0348 0.30948 0 0.62716-0.04772 0.93663-0.14857l5.3356-1.7764c1.5543-0.51513 2.3958-2.1932 1.8797-3.7465-0.41854-1.2653-1.6029-2.0571-2.868-2.0348zm50.145 0c-1.2666-0.02361-2.4487 0.76543-2.868 2.0283-0.51513 1.5543 0.32642 3.2369 1.8797 3.753l5.342 1.7699c0.31046 0.10283 0.62169 0.15503 0.93017 0.15503 1.2438 0 2.4031-0.78796 2.8164-2.0348 0.51612-1.5513-0.32246-3.2349-1.8797-3.753l-5.3356-1.7699c-0.29291-0.09659-0.59267-0.14312-0.88496-0.14857zm-25.069 18.177c-1.6383 0-2.9289 1.3281-2.9714 2.9649l-0.14857 5.7102c-0.04251 1.6378 1.333 2.9649 2.9714 2.9649 1.6383 0 2.9224-1.3271 2.9649-2.9649l0.14857-5.7102c0.04248-1.6368-1.3266-2.9649-2.9649-2.9649z"/></svg>',
            divination: '<svg viewBox="0 0 100 100" fill="currentColor"><path d="m30.461 0c-0.74877 0-1.4669 0.29509-1.998 0.82617l-27.637 27.635c-0.5311 0.52673-0.82617 1.2493-0.82617 1.998v39.082c0 0.74874 0.29507 1.467 0.82617 1.998l27.637 27.635c0.52675 0.53106 1.2493 0.82617 1.998 0.82617h39.074c0.75312 0 1.4708-0.2966 2.002-0.83203l27.637-27.633c0.53109-0.52673 0.82617-1.2493 0.82617-1.998v-39.078c0-0.74874-0.29506-1.467-0.82617-1.998l-27.637-27.635c-0.52675-0.53108-1.2493-0.82617-1.998-0.82617zm1.1699 5.6582h36.734l25.975 25.977v36.73l-25.975 25.977h-36.734l-25.977-25.971v-36.736zm18.373 25.084c-13.952 0-27.861 9.287-35.004 19.258 7.1428 10.029 21.046 19.258 35.004 19.258 13.956 0 29.282-9.229 34.996-19.229-5.7141-10-21.041-19.287-34.996-19.287zm-0.003906 4.8203c7.9744 0 14.438 6.4638 14.438 14.438s-6.4638 14.438-14.438 14.438-14.438-6.4638-14.438-14.438 6.4638-14.438 14.438-14.438zm0 4.0234c-5.7505 0-10.412 4.6643-10.412 10.414s4.6623 10.412 10.412 10.412 10.414-4.6616 10.414-10.412c0-2.0118-0.58066-3.8848-1.5684-5.4766 0.0077 0.0959 0.02734 0.18786 0.02734 0.28516 0 1.897-1.538 3.4316-3.4336 3.4316-1.8963 0-3.4302-1.5346-3.4316-3.4316 0-1.897 1.5346-3.4336 3.4316-3.4336 0.1561 0 0.30528 0.02462 0.45508 0.04492-1.6779-1.1543-3.7056-1.834-5.8945-1.834z"/></svg>',
            enchantment: '<svg viewBox="0 0 100 100" fill="currentColor"><path d="m30.46 2.3069e-7c-0.74877 0-1.4672 0.29626-1.9983 0.82734l-27.634 27.633c-0.5311 0.52673-0.82734 1.2491-0.82734 1.9978v39.082c0 0.74873 0.29624 1.4672 0.82734 1.9983l27.634 27.633c0.52675 0.53106 1.2496 0.82734 1.9983 0.82734h39.076c0.75312 0 1.4714-0.29603 2.0025-0.83147l27.634-27.633c0.5311-0.52673 0.82734-1.2496 0.82734-1.9983v-39.078c0-0.74874-0.29623-1.4667-0.82734-1.9978l-27.634-27.633c-0.52675-0.53108-1.2496-0.82734-1.9983-0.82734zm1.171 5.6591h36.733l25.977 25.975v36.732l-25.977 25.975h-36.733l-25.976-25.971v-36.736zm3.7367 18.869c-2.509-0.05412-5.3279 0.65184-8.4341 2.5476-6 3.7333-9.6669 14.2-4.4002 23.867 1.6 2.9333 3.8001 5.7995 6.2001 8.3995 8.6666 9.3332 20.6 16.133 20.6 16.133s6.6669-3.8 13.6-9.5999v-3.8664h-8.9333v-10.533h9v-9h10.533v9h2.3999c0.13332-0.19999 0.19999-0.3333 0.33332-0.5333 4-7.3999 2.8667-15.333-0.66663-20.266v-0.06666c-1.0667-1.4666-2.3331-2.667-3.6664-3.5336-14.333-8.6666-22.6 7.5334-22.6 7.5334s-5.0049-9.8878-13.966-10.081zm30.099 20.481v9h-9v5.4663h9v9.0666h5.5335v-9.0666h9v-5.4663h-9v-9z"/></svg>',
            evocation: '<svg viewBox="0 0 100 100" fill="currentColor"><path d="m30.46 2.3069e-7c-0.74877 0-1.4672 0.29626-1.9983 0.82734l-27.634 27.633c-0.5311 0.52673-0.82734 1.2491-0.82734 1.9978v39.082c0 0.74873 0.29624 1.4672 0.82734 1.9983l27.634 27.633c0.52675 0.53106 1.2496 0.82734 1.9983 0.82734h39.076c0.75312 0 1.4714-0.29603 2.0025-0.83147l27.634-27.633c0.5311-0.52673 0.82734-1.2496 0.82734-1.9983v-39.078c0-0.74874-0.29623-1.4667-0.82734-1.9978l-27.634-27.633c-0.52675-0.53108-1.2496-0.82734-1.9983-0.82734zm1.171 5.6591h36.733l25.977 25.975v36.732l-25.977 25.975h-36.733l-25.976-25.971v-36.736zm18.654 9.3405c3.6258 17.284-22.656 20.349-17.766 40.073 3.5705 8.1917-7.3068 5.8142-3.1517-3.7915-3.6732 6.6039-4.5263 12.497-2.5435 17.687 1.4851 3.8944 5.9482 8.7212 9.3291 11.273 3.8628 2.9228 8.6654 4.9292 13.863 4.7475-0.1264 0-0.25238 1.85e-4 -0.37879-0.0076-12.529-1.5246-11.091-21.234-0.75086-30.492-2.4093 6.9752-1.5957 13.034 1.6826 16.707 0-3.847 2.2357-5.4584 2.6386-9.495 9.8427 11.075 6.6752 22.039-1.635 23.192 25.649-2.2513 29.923-33.549 10.696-50.762 3.5626 7.4097 4.4234 13.098 2.5828 17.063-2.6779 8.3497-11.92-0.59232-5.9562-8.6418 3.5705-5.2136 0.15015-16.391-8.6103-27.553z"/></svg>',
            illusion: '<svg viewBox="0 0 100 100" fill="currentColor"><path d="m30.46 5.7705e-4c-0.74877 0-1.4672 0.29626-1.9983 0.82735l-27.634 27.633c-0.53112 0.52672-0.82735 1.2491-0.82735 1.9978v39.082c0 0.74874 0.29624 1.4672 0.82735 1.9983l27.634 27.633c0.52675 0.53105 1.2496 0.82735 1.9983 0.82735h39.076c0.75314 0 1.4713-0.29603 2.0025-0.83148l27.634-27.633c0.53108-0.52672 0.82735-1.2496 0.82735-1.9983v-39.079c0-0.74874-0.29624-1.4667-0.82735-1.9978l-27.634-27.633c-0.52675-0.53109-1.2496-0.82735-1.9983-0.82735zm1.171 5.6591h36.734l25.977 25.975v36.731l-25.977 25.975h-36.734l-25.976-25.971v-36.734zm30.036 9.3411-3.3728 10.12c-1.55 4.6467-5.1967 8.2937-9.8402 9.8402l-10.12 3.3734 10.12 3.3728c4.6434 1.55 8.2904 5.1934 9.8402 9.8402l3.3728 10.12 3.3705-10.12c1.55-4.6467 5.1964-8.2904 9.8399-9.8402l10.123-3.3728-10.123-3.3734c-4.6434-1.5467-8.2897-5.1934-9.8399-9.8402zm-33.334 23.334-1.7534 5.2566c-0.99665 2.9867-3.3404 5.33-6.3235 6.3269l-5.2566 1.7498 5.2566 1.7534c2.9833 0.99334 5.3271 3.3364 6.3235 6.3232l1.7534 5.2569 1.7498-5.2569c0.99665-2.9867 3.3397-5.3297 6.3232-6.3232l5.2602-1.7534-5.2602-1.7498c-2.9833-0.99665-5.3264-3.34-6.3232-6.3269zm20 20-1.7534 5.2566c-0.99665 2.9867-3.3397 5.33-6.3232 6.3269l-5.2569 1.7498 5.2569 1.7534c2.9833 0.99334 5.3264 3.3371 6.3232 6.3235l1.7534 5.2566 1.7498-5.2566c0.99665-2.9867 3.3404-5.3304 6.3235-6.3235l5.2596-1.7534-5.2596-1.7498c-2.9833-0.99665-5.3271-3.34-6.3235-6.3269z"/></svg>',
            necromancy: '<svg viewBox="0 0 100 100" fill="currentColor"><path d="m30.46 0c-0.74877 0-1.4672 0.29626-1.9983 0.82734l-27.634 27.633c-0.5311 0.52673-0.82734 1.2491-0.82734 1.9978v39.082c0 0.74874 0.29624 1.4672 0.82734 1.9983l27.634 27.633c0.52675 0.53106 1.2496 0.82734 1.9983 0.82734h39.076c0.75312 0 1.4714-0.29604 2.0025-0.83147l27.634-27.633c0.5311-0.52673 0.82734-1.2496 0.82734-1.9983v-39.078c0-0.74874-0.29623-1.4667-0.82734-1.9978l-27.634-27.633c-0.52675-0.53108-1.2496-0.82734-1.9983-0.82734zm1.171 5.6591h36.733l25.977 25.975v36.732l-25.977 25.975h-36.733l-25.976-25.971v-36.736zm16.249 9.341c-1.3793 0-2.5823 0.26112-3.6261 0.75189-16.249 3.2882-21.256 16.354-22.582 19.002-1.5197 3.035-0.58845 10.928-0.2005 14.366 0.38795 3.4371 0.98926 2.9733 2.1637 5.5258 1.1744 2.5525 1.4417 6.7521-0.04341 8.2579-1.4851 1.5057-0.39998 2.4727-0.39998 2.4727s0.96452 0.26743 2.651 3.5207c1.6865 3.2533 7.2373 3.7336 7.2373 3.7336s0.12298-1.0723 2.6277-1.0723 4.1444 3.5925 4.1444 3.5925l-1.8231 2.5249s-0.46096 1.2327-0.46096 2.4955c0 1.6244 0.74562 1.1075 2.2841 1.7043 0.70021 0.27161 1.8413 1.7951 2.6448 2.1353 1.2839 0.54359 2.7392 0.29399 3.977 0.37724 1.5013 0.10098 2.7592 0.37696 3.3383 0.52142 0.02087 0.06011 0.03204 0.09095 0.03204 0.09095s0.05386-0.01603 0.15503-0.04289c0.10117 0.02685 0.15555 0.04289 0.15555 0.04289 0 0 0.01066-0.03084 0.03152-0.09095 0.5791-0.14446 1.837-0.42044 3.3383-0.52142 1.2378-0.08325 2.6931 0.16635 3.977-0.37724 0.80347-0.34018 1.9446-1.8637 2.6448-2.1353 1.5385-0.59678 2.2841-0.07985 2.2841-1.7043 0-1.2627-0.46095-2.4955-0.46095-2.4955l-1.8231-2.5249s1.6397-3.5925 4.1444-3.5925c2.5048 0 2.6277 1.0723 2.6277 1.0723s5.5513-0.48033 7.2378-3.7336c1.6865-3.2533 2.6505-3.5207 2.6505-3.5207s1.0857-0.96697-0.39946-2.4727c-1.4851-1.5057-1.2184-5.7054-0.04392-8.2579 1.1744-2.5525 1.7757-2.0887 2.1637-5.5258 0.38795-3.4371 1.3192-11.331-0.2005-14.366-1.326-2.6481-6.3329-15.714-22.582-19.002-1.0438-0.49077-2.2469-0.75189-3.6261-0.75189-0.72304 0-1.4296 0.01682-2.1198 0.05013-0.69013-0.03331-1.3967-0.05013-2.1198-0.05013zm-6.3009 34.166c1.4691 0 2.7131 1.0638 4.0106 2.4138 1.2975 1.35 1.0594 3.374 1.0594 3.374l-0.07286 0.4315s0.69988 2.2647-1.9823 4.4643c-2.6822 2.1996-5.2405 3.0458-8.8408 2.4789s-4.0866-1.0507-4.0866-6.9009c0-5.8502 8.4435-6.2616 9.9126-6.2616zm16.841 0c1.4691 0 9.9131 0.41146 9.9131 6.2616 0 5.8502-0.48682 6.334-4.0871 6.9009-3.6003 0.56684-6.1586-0.2793-8.8408-2.4789-2.6822-2.1996-1.9823-4.4643-1.9823-4.4643l-0.07286-0.4315s-0.23812-2.0239 1.0594-3.374c1.2975-1.35 2.5416-2.4138 4.0106-2.4138zm-8.1008 13.412c0.03426 0.0052 0.06624 0.0163 0.09663 0.03307 0.24313-0.13429 0.60708 0.08619 1.1462 0.93069 1.6911 2.8523 2.9474 4.5463 2.604 5.7289-0.51059 1.4006-1.5622 1.5627-1.5622 1.5627s-0.64059 0.16117-1.0418-0.5209c-0.19106-0.47366-0.49788-0.57876-0.72915-0.58033v0.05943h-0.83354v-0.05943c-0.23128 0.0016-0.5381 0.10667-0.72916 0.58033-0.4012 0.68207-1.0418 0.5209-1.0418 0.5209 0 0-1.0516-0.16205-1.5622-1.5627-0.34347-1.1826 0.9129-2.8765 2.604-5.7289 0.47172-0.73894 0.80919-1.0001 1.049-0.96377z"/></svg>',
            transmutation: '<svg viewBox="0 0 100 100" fill="currentColor"><path d="m30.46 0c-0.74877 0-1.4672 0.29626-1.9983 0.82734l-27.634 27.633c-0.5311 0.52673-0.82734 1.2491-0.82734 1.9978v39.082c0 0.74873 0.29624 1.4672 0.82734 1.9983l27.634 27.633c0.52675 0.53106 1.2496 0.82734 1.9983 0.82734h39.076c0.75312 0 1.4714-0.29604 2.0025-0.83148l27.634-27.633c0.5311-0.52673 0.82734-1.2496 0.82734-1.9983v-39.078c0-0.74874-0.29623-1.4667-0.82734-1.9978l-27.634-27.633c-0.52675-0.53108-1.2496-0.82734-1.9983-0.82734zm1.171 5.6591h36.733l25.977 25.975v36.732l-25.977 25.975h-36.733l-25.976-25.971v-36.736zm14.56 12.713-3.7057 8.877c-0.747 0.2634-1.4651 0.5413-2.1761 0.8785l-8.9126-3.5812-5.303 5.303 3.6329 8.8325c-0.3516 0.7254-0.63675 1.4647-0.90795 2.2267l-8.8186 3.7724v6.2332h18.983c-0.18901-0.81734-0.29197-1.6679-0.29197-2.5425 0-6.2112 5.0388-11.25 11.25-11.25 6.2112 0 11.25 5.0387 11.25 11.25 0 0.87464-0.10345 1.7251-0.2925 2.5425h19.101v-6.3516l-8.9643-3.7352c-0.24901-0.70321-0.51229-1.385-0.83509-2.051l3.6179-9.0088-5.303-5.303-8.9287 3.6773c-0.681-0.33-1.3764-0.60783-2.0934-0.86403l-3.8024-8.9059zm4.7925 32.238-0.78858 2.3647c-0.44835 1.3436-1.5027 2.398-2.8448 2.8463l-2.3647 0.78703 2.3647 0.7891c1.342 0.44685 2.3964 1.5012 2.8448 2.8448l0.78858 2.3647 0.78755-2.3647c0.44835-1.3436 1.5022-2.3979 2.8443-2.8448l2.3663-0.7891-2.3663-0.78703c-1.342-0.44835-2.3959-1.5028-2.8443-2.8463zm22.338 1.3694-0.7891 2.3647c-0.44835 1.3435-1.5022 2.398-2.8443 2.8463l-2.3647 0.78755 2.3647 0.78858c1.342 0.44685 2.3959 1.5007 2.8443 2.8443l0.7891 2.3647 0.78703-2.3647c0.44835-1.3436 1.5027-2.3974 2.8448-2.8443l2.3663-0.78858-2.3663-0.78755c-1.342-0.44835-2.3964-1.5028-2.8448-2.8463zm-39.767 1.9311-0.7891 2.3647c-0.44835 1.3436-1.5022 2.3985-2.8443 2.8469l-2.3647 0.78703 2.3647 0.7891c1.342 0.44685 2.3959 1.5007 2.8443 2.8443l0.7891 2.3647 0.78703-2.3647c0.44835-1.3436 1.5027-2.3974 2.8448-2.8443l2.3663-0.7891-2.3663-0.78703c-1.342-0.44835-2.3964-1.5033-2.8448-2.8469zm27.533 4.253-0.78858 2.3647c-0.44835 1.3436-1.5027 2.3975-2.8448 2.8458l-2.3647 0.78703 2.3647 0.7891c1.342 0.44686 2.3964 1.5007 2.8448 2.8443l0.78858 2.3647 0.78703-2.3647c0.44835-1.3436 1.5027-2.3974 2.8448-2.8443l2.3663-0.7891-2.3663-0.78703c-1.342-0.44835-2.3964-1.5023-2.8448-2.8458zm-12.571 5.8177-0.7891 2.3647c-0.44835 1.3436-1.5022 2.3975-2.8443 2.8458l-2.3647 0.78755 2.3647 0.78858c1.342 0.44685 2.3959 1.5007 2.8443 2.8443l0.7891 2.3647 0.78703-2.3647c0.44835-1.3436 1.5027-2.3974 2.8448-2.8443l2.3657-0.78858-2.3657-0.78755c-1.342-0.44835-2.3964-1.5023-2.8448-2.8458zm19.52 5.6498-0.7891 2.3647c-0.44834 1.3436-1.5022 2.398-2.8443 2.8463l-2.3647 0.78703 2.3647 0.78858c1.342 0.44685 2.3959 1.5012 2.8443 2.8448l0.7891 2.3647 0.78703-2.3647c0.44835-1.3436 1.5027-2.3979 2.8448-2.8448l2.3657-0.78858-2.3657-0.78703c-1.342-0.44835-2.3964-1.5028-2.8448-2.8463z"/></svg>',
            
            // Damage Type Icons (tw-dnd)
            fire: '<svg viewBox="0 0 100 100" fill="currentColor"><path d="m40.066 99.299c-5.2363-1.1875-7.8923-2.0993-11.768-4.04-8.1846-4.0985-13.048-9.9971-14.106-17.109-0.25517-1.7146-0.25634-4.7496-0.0024-6.4449 0.79898-5.3361 3.1856-10.696 6.8662-15.42 0.63707-0.81767 1.3683-1.8885 1.625-2.3797 0.53313-1.0201 1.1958-2.9205 1.4655-4.2032 0.7285-3.4638 0.68876-8.7193-0.10164-13.443-0.33397-1.9957-0.28187-2.1174 0.68542-1.601 1.6271 0.86873 3.9375 2.8145 5.3536 4.5087 2.4527 2.9344 3.9181 6.3338 4.492 10.421 0.26931 1.9179 0.17536 6.1488-0.182 8.196-0.14052 0.80496-0.33376 1.7724-0.42942 2.1498-0.09566 0.37741-0.15372 0.70641-0.12901 0.73113 0.10235 0.10237 1.6758-2.4556 2.3122-3.759 0.82611-1.6919 1.2727-2.9499 1.7076-4.8097 0.2987-1.2774 0.3267-1.5945 0.33009-3.7375 0.0042-2.6231-0.11775-3.4688-0.82361-5.7141-1.6868-5.3657-2.3968-9.6187-2.3984-14.366-0.0016-5.0622 0.80198-9.114 2.6243-13.231 2.6887-6.0742 7.6152-11.367 13.459-14.461 1.232-0.65217 1.7214-0.75124 1.7214-0.34844 0 0.08899-0.26763 0.72937-0.59474 1.4231-2.5101 5.3231-3.5349 10.258-3.2619 15.708 0.4057 8.1 4.0037 16.444 10.46 24.257 1.1425 1.3826 1.6299 1.9115 3.6144 3.9224l1.7332 1.7563-0.0768-1.5221c-0.17233-3.4146 0.71097-6.885 2.4854-9.7647 2.257-3.6629 6.2279-7.1409 10.545-9.2358 0.89289-0.4333 1.1125-0.49928 1.2584-0.37814 0.24734 0.20531 0.22245 0.36381-0.1299 0.82712-0.79567 1.0463-1.5604 3.1978-1.9328 5.4379-0.20269 1.2193-0.20624 5.6084-6e-3 7.0837 0.76649 5.6394 2.5507 11.526 5.5185 18.207 2.054 4.6239 3.1481 8.5453 3.5116 12.587 0.95566 10.626-4.4473 19.309-15.448 24.827-2.641 1.3247-6.5274 2.8728-6.9904 2.7845-4.2021 2.1433-18.211 1.9699-20.963 1.653z"/></svg>',
            cold: '<svg viewBox="0 0 100 100" fill="currentColor"><path d="m48.864 99.878c-0.63552-0.20459-1.4615-0.98973-1.6109-1.5311-0.2199-0.79731-0.31959-2.9308-0.40437-8.6535-0.04722-3.1875-0.10958-5.8191-0.13857-5.8481-0.029-0.029-1.4203 0.8952-3.0917 2.0538-6.4819 4.493-7.0007 4.7985-8.1183 4.7799-1.1741-0.01955-2.1058-0.60595-2.6143-1.6453-0.23485-0.48001-0.2797-0.70435-0.2797-1.399 0-1.3949 0.17309-1.5977 3.3073-3.8738 0.87022-0.63196 2.7995-1.9981 4.2873-3.0359 3.6219-2.5264 5.9274-4.1435 6.1757-4.3318 0.20134-0.15265 0.20459-0.29343 0.23601-10.219 0.01751-5.5354-0.0055-10.101-0.05104-10.146-0.04559-0.04498-0.47334 0.13646-0.95056 0.4032-0.47721 0.26675-2.1309 1.1902-3.6748 2.052-8.2403 4.6-12.964 7.3336-12.964 7.5025 0 0.07373-0.06689 0.77058-0.14865 1.5485-0.08175 0.77796-0.35778 3.9179-0.6134 6.9777-0.59318 7.1004-0.63768 7.5043-0.87894 7.9772-0.28539 0.55941-0.73848 1.0412-1.3453 1.4306-0.50164 0.3219-0.58129 0.34054-1.4518 0.33985-0.75171-5.29e-4 -0.99829-0.04192-1.3412-0.2248-0.68315-0.36428-1.0292-0.71461-1.3602-1.3771-0.28153-0.56339-0.31216-0.71856-0.31216-1.5815 0-0.52626 0.18693-3.2795 0.4154-6.1183 0.22847-2.8388 0.3905-5.1863 0.36007-5.2168-0.05719-0.05719-0.95702 0.4381-6.3387 3.489-4.2773 2.4248-5.6642 3.1173-6.3875 3.1894-1.2303 0.12259-2.4772-0.56722-3.016-1.6685-0.49205-1.0057-0.33528-2.4637 0.34799-3.2364 0.26003-0.29405 1.79-1.2657 4.9247-3.1276 5.9571-3.5382 6.9811-4.1612 7.0171-4.2692 0.02046-0.06135-1.057-0.64649-2.3943-1.3003-7.5464-3.6895-8.0232-3.9389-8.5637-4.4793-0.8206-0.82056-1.0524-1.8222-0.69795-3.0158 0.24531-0.82604 1.1041-1.6466 2.019-1.9292 1.2283-0.3794 1.158-0.40733 12.301 4.8834 2.2665 1.0762 4.1783 1.9346 4.2485 1.9077 0.19561-0.07506 16.153-9.4476 16.868-9.9077 0.18177-0.11688 0.33106-0.24437 0.33175-0.28331 0.0034-0.1923-16.994-10.332-17.301-10.32-0.05614 0.0021-1.0208 0.4402-2.1436 0.97356-12.025 5.712-12.682 5.9989-13.723 5.9967-0.9402-0.0021-1.994-0.73394-2.4783-1.7213-0.34803-0.70955-0.38525-1.9867-0.07649-2.6246 0.44161-0.91224 0.91506-1.1817 9.1829-5.2255 1.1509-0.56293 2.1845-1.097 2.2968-1.1868 0.17609-0.14083 0.1831-0.17706 0.05104-0.26352-0.08422-0.05513-1.623-0.97104-3.4196-2.0353-1.7966-1.0643-4.2968-2.5465-5.5561-3.2938-1.2593-0.74727-2.4596-1.5254-2.6673-1.7292-0.64465-0.6325-0.91535-2.0072-0.61464-3.1214 0.38985-1.4445 2.1556-2.3133 3.6946-1.818 0.75864 0.24414 2.3528 1.0894 6.8787 3.6473 5.6801 3.2102 5.2572 2.9874 5.2562 2.7687-5.29e-4 -0.10308-0.16093-2.2086-0.35664-4.6788-0.19572-2.4703-0.38598-5.1862-0.42281-6.0353-0.06316-1.4562-0.05422-1.5702 0.15757-2.0077 0.28226-0.58307 0.98585-1.2379 1.6746-1.5586 1.5595-0.72608 3.6041 0.22741 4.05 1.8887 0.1246 0.46418 0.4154 3.4177 0.86998 8.8358 0.59839 7.1321 0.63212 7.4232 0.88449 7.6338 0.23198 0.19361 5.5843 3.2544 11.16 6.3821 5.3655 3.0097 6.104 3.4022 6.1773 3.2837 0.07013-0.11347 0.20328-11.354 0.2013-16.993l-0.0011-3.2665-3.8988-2.7051c-8.9297-6.1956-9.5908-6.6859-9.9589-7.3862-0.24013-0.45681-0.27597-0.64375-0.27679-1.4435-7.94e-4 -0.8307 0.02839-0.9717 0.3053-1.472 0.76026-1.3737 2.6199-1.949 3.9826-1.2322 0.51039 0.26848 3.7071 2.4299 8.3688 5.6585l1.4291 0.98976 0.06463-0.64502c0.03554-0.35476 0.07201-1.9542 0.08104-3.5542 0.02426-4.3006 0.17858-9.0614 0.31343-9.6697 0.15215-0.68632 0.81131-1.4412 1.592-1.8231 0.50534-0.24724 0.63981-0.26922 1.3495-0.22057 0.93912 0.064369 1.3849 0.23396 1.945 0.74003 0.70695 0.63868 0.82914 0.92663 0.93241 2.1973 0.0508 0.62495 0.12477 3.7969 0.16439 7.0488 0.03962 3.2519 0.10782 5.9125 0.15154 5.9125 0.04373 0 1.2882-0.83375 2.7654-1.8528 3.7028-2.5543 5.8257-3.9663 6.8883-4.5818 0.90073-0.5217 0.9021-0.52209 1.671-0.48153 0.60429 0.03188 0.88533 0.10364 1.309 0.33423 1.3517 0.73569 1.9618 2.4955 1.3499 3.8938-0.18647 0.42611-0.39394 0.65524-1.0799 1.1926-1.228 0.96206-5.3108 3.8641-9.1367 6.4945-1.8246 1.2545-3.4209 2.3734-3.5472 2.4866-0.22871 0.20489-0.22968 0.21885-0.22968 3.3355 0 5.9844 0.13599 16.936 0.21182 17.058 0.08549 0.13833 1.0178-0.36412 7.5971-4.0943 9.4807-5.3752 9.7643-5.5433 9.9051-5.8717 0.18015-0.41994 0.40006-2.3766 0.76281-6.7871 0.82001-9.9702 0.81126-9.9131 1.6347-10.657 1.3368-1.2077 2.9173-1.2473 4.2724-0.10704 0.17753 0.14938 0.44821 0.48496 0.6015 0.74572 0.27429 0.46658 0.27848 0.50004 0.2641 2.1074-8e-3 0.89828-0.13462 3.09-0.2813 4.8704-0.3198 3.8817-0.43023 6.0009-0.31272 6.0009 0.12872 0 2.7287-1.4237 6.5802-3.6032 1.8808-1.0643 3.879-2.1626 4.4404-2.4406 1.0204-0.50537 1.0211-0.50553 1.8956-0.46677 1.0173 0.04508 1.5666 0.30061 2.1755 1.0121 0.66653 0.77868 0.91944 2.1928 0.54779 3.0629-0.38834 0.90922-1.0296 1.3589-6.8136 4.7782-3.7886 2.2397-5.3305 3.1738-5.5064 3.3358-0.12475 0.11491 0.17962 0.29378 1.9905 1.1697 1.1758 0.56874 3.5618 1.7348 5.3022 2.5912 4.2194 2.0763 4.4399 2.2818 4.4388 4.137-2.65e-4 0.58752-0.05582 0.88429-0.2386 1.276-0.43714 0.93674-1.507 1.6777-2.4286 1.682-0.99913 0.0047-2.2824-0.52074-8.9681-3.6721-4.6733-2.2028-6.7685-3.1648-6.8926-3.1648-0.21394 0-3.9245 2.1427-11.277 6.512-4.5197 2.6858-6.0095 3.592-6.0721 3.6932-0.06327 0.10238 10.717 6.559 16.338 9.7852l0.92606 0.53152 5.2497-2.4615c9.6091-4.5055 9.8786-4.6219 10.507-4.5368 0.70338 0.09534 1.6687 0.60903 2.1306 1.1337 0.99402 1.1293 0.97865 2.9706-0.03309 3.9647-0.51008 0.50121-2.2751 1.4207-7.3496 3.8289-2.0184 0.95787-3.7098 1.7816-3.7587 1.8304-0.10544 0.10544 0.96389 0.77065 5.8398 3.6328 5.5443 3.2544 5.9804 3.5543 6.391 4.3934 0.21935 0.44833 0.26913 0.69617 0.272 1.3543 0.0055 1.2582-0.50384 2.1772-1.5015 2.709-0.33693 0.17961-0.58678 0.2182-1.4291 0.22073-0.96271 0.0029-1.0643-0.01767-1.7864-0.3616-0.42107-0.20056-2.7867-1.5138-5.257-2.9183-5.6491-3.2119-5.8703-3.3343-5.9255-3.279-0.025 0.025 0.04535 1.1672 0.15636 2.5382 0.35732 4.4126 0.50507 6.506 0.57553 8.154 0.06542 1.5302 0.05744 1.6361-0.15663 2.0783-0.7086 1.4638-2.3244 2.1504-3.8441 1.6336-0.66189-0.22509-1.6148-1.1585-1.7696-1.7335-0.16982-0.63065-0.37441-2.5949-0.8755-8.4053-0.4743-5.4998-0.6964-7.5585-0.86257-7.9956-0.11068-0.29112-1.2156-0.94409-10.266-6.0666-7.1106-4.0248-7.1576-4.0499-7.2294-3.8629-0.02877 0.07498-0.08594 4.6144-0.12702 10.088l-0.07471 9.9513 0.55116 0.40868c0.30314 0.22477 2.1359 1.5026 4.0729 2.8396 5.8695 4.0516 8.7597 6.148 9.074 6.5819 0.82097 1.1333 0.63078 2.9486-0.41378 3.9492-0.42529 0.40739-1.1576 0.73679-1.8098 0.81404-0.96174 0.1139-1.3323-0.06021-4.0558-1.9058-6.013-4.0747-7.2957-4.9245-7.3504-4.8698-0.09953 0.09952-0.23203 4.5618-0.24159 8.1359-0.01098 4.1057-0.11235 5.9567-0.35155 6.4192-0.23663 0.45759-0.85662 1.0547-1.3267 1.2778-0.53642 0.25455-1.8908 0.31466-2.5207 0.11188z"/></svg>',
            lightning: '<svg viewBox="0 0 100 100" fill="currentColor"><path d="m33.014 99.906c-0.68609-0.21407-1.2736-0.81159-1.4593-1.4842-0.18095-0.65533-0.6198 1.5729 4.9223-24.992 2.1461-10.287 3.8692-18.762 3.8291-18.832-0.04013-0.0704-3.7137-0.12811-8.1635-0.12811h-8.0905l-0.52246-0.43963c-1.1301-0.9509-1.4313 0.90184 4.4137-27.147 2.917-13.998 5.3956-25.627 5.508-25.842 0.11232-0.21458 0.45056-0.5424 0.75162-0.72847 0.53708-0.33193 0.8585-0.33745 17.046-0.29308l16.499 0.0453 0.53433 0.53437c1.0912 1.0913 1.27 0.43231-4.5003 16.587-2.8602 8.0075-5.1607 14.599-5.1121 14.647 0.04857 0.0486 3.9265 0.0883 8.6177 0.0883h8.5293l0.5707 0.57071c0.65085 0.65085 0.84888 1.2383 0.68608 2.0353-0.14224 0.69638-41.531 64.636-42.116 65.062-0.53498 0.39046-1.3044 0.5155-1.944 0.31594z"/></svg>',
            thunder: '<svg viewBox="0 0 100 100" fill="currentColor"><path d="m39.048 0.102c-0.3912 8.8538-4.6155 18.513-12.438 26.337-7.777 7.7779-17.444 12.078-26.256 12.511 10.668 3.6795 22.998 1.253 31.509-7.2587 8.5108-8.5117 10.923-20.894 7.1856-31.589zm-39.048 1.0068v24.736c2.042 0.78496 4.2874 1.2465 6.5793 1.2465 10.073 0 18.151-8.0751 18.151-18.144 0-2.7627-0.76789-5.4292-1.9466-7.8389h-22.784zm55.686 0.89972c-0.53966 12.219-6.3618 25.552-17.158 36.348-10.733 10.734-24.074 16.666-36.235 17.264 14.723 5.0773 31.735 1.7278 43.481-10.019 11.789-11.79 15.069-28.833 9.9122-43.594zm18.697 0.56654c-0.72267 16.36-8.5151 34.211-22.97 48.667-14.372 14.372-32.238 22.315-48.52 23.117 19.712 6.798 42.491 2.3107 58.218-13.418 15.786-15.787 20.178-38.602 13.272-58.365zm21.704 4.6991c-0.89417 20.243-10.544 42.325-28.429 60.212-17.782 17.783-39.886 27.618-60.032 28.609 24.391 8.411 52.578 2.8626 72.037-16.598 19.532-19.533 24.969-47.77 16.424-72.224z"/></svg>',
            acid: '<svg viewBox="0 0 100 100" fill="currentColor"><path d="m10.714 99.14c-3.2354-1.7167-5.1851-5.4743-4.5708-8.8092 0.25107-1.3631 2.8071-6.3892 14.538-28.588 1.0291-1.9474 2.4614-4.6362 3.1827-5.9751 5.631-10.451 8.5546-16.542 9.143-19.049 0.50707-2.1602 0.67282-5.5928 0.67774-14.035l0.0065-11.176h6.2493l-0.18208 13.167c-0.16492 11.926-0.26737 13.397-1.087 15.602-0.83942 2.2581-5.0037 10.578-7.4766 14.938l-1.067 1.881h39.73l-0.73457-1.4385c-0.40401-0.79116-2.1216-4.024-3.8168-7.1842-5.0274-9.3718-4.8539-8.5565-5.0647-23.798l-0.18208-13.167h6.2493l8e-3 10.954c0.0049 7.8971 0.18751 11.807 0.65207 14.009 0.52979 2.5111 2.9518 7.4321 13.616 27.665 7.1345 13.536 13.105 25.325 13.268 26.197 0.6449 3.4518-1.4673 7.3308-4.826 8.8628-1.6841 0.76812-3.8277 0.81197-39.248 0.80267-36.069-9e-3 -37.526-0.0415-39.066-0.85859zm43.804-3.8953c1.0359-0.89338 0.97434-2.5372-0.1369-3.653-1.1824-1.1873-2.9446-0.97143-4.0287 0.49364-0.6772 0.9151-0.74978 1.3605-0.38059 2.3355 0.74996 1.9807 2.7785 2.3483 4.5462 0.82387zm-12.002-11.376c1.5224-0.79055 2.1951-1.9029 2.1951-3.6299 0-2.7163-2.8505-4.6828-5.3069-3.6611-3.4321 1.4275-3.6009 5.863-0.27832 7.3143 1.779 0.77704 1.8498 0.77657 3.3902-0.0233zm20.183-10.408c2.0201-1.2367 2.9726-3.6212 2.3201-5.8081-0.87754-2.9411-3.6722-4.4216-6.6534-3.5247-4.2589 1.2813-4.7018 7.5469-0.67457 9.5427 1.8351 0.90942 3.2784 0.84894 5.0079-0.20987zm-31.495-64.155c-1.5628-0.64531-2.3613-2.2334-2.3613-4.6964 0-1.8684 0.20788-2.4842 1.1621-3.4423l1.1621-1.1669h18.475c22.208 0 21.516-0.15689 21.516 4.8801 0 1.6366-0.25474 2.4496-1.0635 3.394l-1.0635 1.2418-18.441 0.0899c-10.143 0.0494-18.866-0.0856-19.386-0.30016z"/></svg>',
            poison: '<svg viewBox="0 0 100 100" fill="currentColor"><path d="m39.921 99.877c-9.3091-0.67926-13.949-2.8343-16.344-7.5919-1.5241-3.0265-1.5126-2.8389-1.5157-24.684-0.0019-12.739 0.07417-19.975 0.22001-20.957 1.3307-8.9588 6.8753-16.793 14.772-20.871l1.8959-0.97922v-13.527l-0.57344-0.13783c-4.3736-1.0512-5.7246-6.8346-2.2845-9.7792 1.5623-1.3373 1.7053-1.3512 13.91-1.3512s12.347 0.013913 13.91 1.3512c3.4401 2.9446 2.0891 8.728-2.2845 9.7792l-0.57344 0.13783v13.527l1.8959 0.97922c6.7025 3.4617 11.927 9.8622 13.958 17.099 1.0239 3.649 1.0352 3.9194 1.0331 24.689-0.0019 18.19-0.02795 19.623-0.38974 21.376-1.0629 5.1496-4.248 8.309-9.8771 9.7972-3.7797 0.99926-6.0212 1.1745-16.003 1.2514-5.1036 0.03934-10.39-0.01001-11.747-0.1086zm14.526-14.08c0.93605-0.11996 1.2866-0.26594 1.5298-0.637 0.17348-0.26476 0.25742-0.57522 0.18654-0.6899-0.21226-0.34345 0.43624-1.6286 1.0123-2.0061 0.47775-0.31304 0.6853-0.3225 1.877-0.08558 1.1795 0.23446 1.4513 0.22378 2.2706-0.08908 0.5119-0.19549 1.367-0.7997 1.9001-1.3427 1.8947-1.9296 2.1339-2.7039 1.3614-4.4068-0.50647-1.1164-0.41761-1.6739 0.5608-3.5182 0.41849-0.78885 0.70568-1.6338 0.7101-2.0892 0.0041-0.42056 0.14482-1.3277 0.31274-2.0158 0.49729-2.0379 0.61922-6.5927 0.22607-8.4452-0.63406-2.9877-2.302-5.5573-5.3173-8.1915-3.8283-3.3446-7.531-4.7322-11.903-4.4607-3.692 0.22927-6.5904 1.4085-9.5998 3.9058-3.4305 2.8467-5.296 5.5807-5.9678 8.7465-0.39315 1.8525-0.27123 6.4073 0.22607 8.4452 0.16792 0.68813 0.30865 1.5952 0.31274 2.0158 0.0044 0.4554 0.29162 1.3003 0.7101 2.0892 0.97841 1.8443 1.0673 2.4017 0.5608 3.5182-0.77248 1.7028-0.53324 2.4772 1.3614 4.4068 0.53317 0.54298 1.3882 1.1472 1.9001 1.3427 0.81935 0.31292 1.0911 0.32359 2.2706 0.08908 1.1917-0.23689 1.3993-0.22742 1.877 0.08558 0.57604 0.37744 1.2245 1.6626 1.0123 2.0061-0.07089 0.11468 0.02213 0.43898 0.2067 0.72066 0.2511 0.38323 0.53118 0.51737 1.1127 0.53293 0.42743 0.01141 1.0117 0.08778 1.2985 0.16966 0.64467 0.18411 6.3386 0.11547 7.9913-0.09629zm-6.6025-4.774c-0.06349-0.16546-0.02301-0.61119 0.08995-0.9905 0.11297-0.37931 0.29731-1.157 0.40965-1.7283 0.18782-0.95504 1.3624-3.2361 1.6664-3.2361 0.25905 0 1.2394 2.2133 1.4316 3.2321 0.10817 0.57344 0.29726 1.3068 0.42019 1.6296 0.50965 1.3385 0.43648 1.394-1.8394 1.394-1.6049 0-2.0885-0.06676-2.1784-0.30084zm-6.8329-4.0407c-0.80705-0.34124-2.2873-1.6622-2.6125-2.3312-0.53218-1.0951-0.60658-2.5126-0.17914-3.4134 0.66981-1.4115 3.2158-2.9452 5.2988-3.1919 2.6733-0.31661 4.9336 1.9582 4.4994 4.5282-0.23054 1.3646-3.3198 3.8945-5.316 4.3535-1.0698 0.24596-1.2267 0.25106-1.6906 0.05485zm16.078-0.10295c-1.9762-0.54935-4.888-3.0122-5.1092-4.3215-0.4315-2.554 1.8372-4.8277 4.5021-4.5121 2.0829 0.2467 4.629 1.7804 5.2988 3.1919 0.4251 0.89583 0.35391 2.3089-0.17194 3.4134-0.39637 0.8325-2.2114 2.2706-3.031 2.4016-0.3022 0.04824-0.97214-0.02973-1.4888-0.17331z"/></svg>',
            necrotic: '<svg viewBox="0 0 100 100" fill="currentColor"><path d="m5.6063 99.749-0.51982-0.3641v-27.73c0-29.694 0.0076-29.917 1.2029-35.475 2.6362-12.256 10.244-23.224 20.587-29.68 9.8564-6.1525 22.341-8.0672 33.812-5.1856 18.455 4.6362 31.378 20.16 33.892 40.712 0.30897 2.5256 0.4743 56.196 0.17583 57.078-0.27316 0.8075-1.0062 1.0888-1.7748 0.68114-0.35543-0.18853-2.8597-2.5739-5.565-5.3009-2.7053-2.727-5.2579-5.1055-5.6724-5.2857-0.89447-0.3888-2.5837-0.42673-3.5057-0.07872-0.36265 0.13689-2.8805 2.4533-5.5953 5.1476-3.0653 3.0422-5.2594 5.0339-5.7896 5.2554-0.46949 0.19616-1.3347 0.35666-1.9227 0.35666-0.58798 0-1.4532-0.1605-1.9227-0.35666-0.53011-0.2215-2.7243-2.2132-5.7896-5.2554-2.7148-2.6943-5.2326-5.0107-5.5953-5.1476-0.84432-0.31871-2.518-0.31954-3.3658-0.0016-0.36265 0.13597-2.8728 2.4492-5.5781 5.1405-3.1256 3.1094-5.2362 5.0259-5.7896 5.2571-1.1034 0.46098-2.7644 0.46598-3.8519 0.01156-0.51655-0.21583-2.7382-2.2339-5.737-5.2115-2.6917-2.6726-5.1812-4.9863-5.5321-5.1415-0.79683-0.35242-2.6196-0.38267-3.4921-0.05797-0.36265 0.13496-3.0309 2.6016-5.9294 5.4815-2.8985 2.8798-5.4841 5.2988-5.7457 5.3755-0.26528 0.07776-0.70553-0.02162-0.99546-0.22468zm29.958-43.451c3.8692-1.1175 7.0781-4.5774 8.0433-8.6725 1.5287-6.4853-2.7003-13.021-9.3323-14.422-4.9972-1.0559-10.353 1.4569-12.763 5.9876-1.051 1.9764-1.4298 3.5031-1.4298 5.7628 0 3.215 1.1054 6.0213 3.2269 8.1924 3.3376 3.4156 7.5715 4.5045 12.255 3.1519zm35.457 0.20538c3.777-0.93997 7.425-4.5949 8.4578-8.4739 0.37769-1.4185 0.4145-4.5138 0.0714-6.0036-1.3414-5.8245-7.5581-9.9322-13.495-8.9165-7.9273 1.3562-12.373 9.8814-8.8649 16.997 1.0115 2.0514 1.9484 3.1855 3.6916 4.4688 2.867 2.1106 6.5729 2.8153 10.139 1.9279z"/></svg>',
            radiant: '<svg viewBox="0 0 100 100" fill="currentColor"><path d="m65.783 83.578c-0.02008-0.90955-0.84182-4.6711-1.2942-5.9242-1.0375-2.8739-3.2654-4.2176-8.2289-4.9634-2.4047-0.36127-2.4198-0.37778-0.54096-0.59278 4.2954-0.49156 6.6177-1.3823 7.8829-3.0235 0.78528-1.0187 1.7084-4.3158 2.2367-7.9889 0.11643-0.80943 0.29727-0.23421 0.79598 2.5318 0.4977 2.7603 1.0928 4.5908 1.7848 5.49 0.68645 0.89192 2.0204 1.732 3.3944 2.1376 1.4754 0.43561 4.3579 0.93909 5.3944 0.94226 0.42156 0.0013 0.66103 0.0607 0.58229 0.14455-0.07355 0.0783-0.36053 0.14236-0.63772 0.14236-0.69536 0-4.0246 0.64652-5.1983 1.0095-3.3963 1.0503-4.8721 3.2431-5.5485 8.2437-0.25364 1.8754-0.59952 2.9032-0.62275 1.8506zm-34.624-3.286c2.16e-4 -0.39826-1.5435-8.652-2.0729-11.083-1.3007-5.9729-3.001-9.6264-5.7011-12.25-0.98617-0.9583-3.4032-2.5064-5.019-3.2145-3.7681-1.6516-9.5726-3.024-16.269-3.8468-1.1536-0.14173-2.0974-0.30139-2.0974-0.35477 0-0.05344 0.65727-0.14338 1.4606-0.19998 2.503-0.17633 8.2905-1.0128 10.742-1.5525 10.653-2.3451 14.47-6.1789 16.772-16.843 0.61007-2.8268 2.1853-11.604 2.1853-12.177 0-0.08513 0.04417-0.12571 0.09817-0.0902 0.05399 0.03553 0.49212 2.2403 0.97359 4.8995 2.1795 12.036 3.4566 15.665 6.6606 18.924 3.4737 3.5328 10.358 5.7178 21.209 6.7323 1.4578 0.13628 2.6507 0.29581 2.6507 0.35454 6.3e-5 0.05876-0.21898 0.10696-0.48676 0.1072-0.26778 2.83e-4 -1.5022 0.13011-2.7431 0.28861-12.021 1.5355-18.499 4.0434-22.079 8.5487-2.7714 3.4874-4.0185 7.5393-5.5382 17.995-0.30712 2.1128-0.60041 3.8692-0.65174 3.903-0.05134 0.03373-0.0933-0.02938-0.09323-0.14026zm51.933-31.105c0-0.34345-1.1248-5.9837-1.4313-7.1771-1.4191-5.5253-4.1449-7.5475-11.913-8.8379-1.3737-0.22824-2.7307-0.41498-3.0155-0.41498-1.0671 0-0.46689-0.24766 0.8136-0.33571 2.0706-0.14239 5.5416-0.76274 7.2732-1.3 0.9135-0.28339 2.0713-0.79827 2.7635-1.2289 2.7818-1.7309 3.7305-3.7767 4.9738-10.726 0.30774-1.7202 0.58589-3.145 0.61809-3.1662 0.0322-0.02123 0.32807 1.4183 0.65749 3.1989 0.99441 5.375 1.6573 7.3802 2.9859 9.0328 0.89952 1.1188 2.8226 2.2865 4.7649 2.8934 1.6763 0.52371 5.065 1.1363 7.1437 1.2914 1.1986 0.08942 1.7565 0.34056 0.75734 0.34094-0.87224 2.84e-4 -4.932 0.70456-6.61 1.1466-1.8702 0.49267-4.0239 1.4515-5.0176 2.2338-1.0113 0.79614-2.3081 2.6535-2.808 4.0221-0.48334 1.323-1.1507 4.4712-1.539 7.2604-0.13627 0.97868-0.28575 1.8062-0.3322 1.8388-0.04644 0.03262-0.08445 4.21e-4 -0.08445-0.07157z" stroke-width=".99999"/></svg>',
            force: '<svg viewBox="0 0 100 100" fill="currentColor"><path d="m51.843 4.632-31.718 44.344-5.2969-28.981-7.1136 32.48-7.7142-9.5949v27.929c0 1.0028 0.011352 1.9347 0.031648 2.8253 0.14964 6.008 0.98419 9.7202 4.7376 14.592 0.8662 1.1245 1.8748 2.3052 3.0798 3.5979 0.27314 0.29172 0.5762 0.56313 0.90748 0.81942 1.9216 1.4857 4.8515 2.3296 8.9547 2.6082 1.0141 0.06914 2.0767 0.11593 3.2405 0.11593 1.1768 0 2.3967-0.0375 3.6447-0.10286 1.0757-0.05607 2.1686-0.13485 3.2742-0.23186 12.173-1.0685 25.534-4.3389 26.204-4.5037l12.927-3.1903-25.306-4.4345 36.865-13.109h-36.815l58.253-61.717-62.97 43.312z"/></svg>',
            psychic: '<svg viewBox="0 0 100 100" fill="currentColor"><path d="m8.9922 95.819c0-4.381-0.32008-7.1738-1.0853-9.47-0.35023-1.0509-1.7187-4.0125-3.041-6.5814s-2.6607-5.3862-2.9741-6.2607c-1.3809-3.8524-1.8999-7.5518-1.8916-13.484 0.0089-6.3886 0.45424-8.2635 2.4235-10.203 1.0266-1.0112 1.0854-1.0371 2.5397-1.1192 1.8641-0.10533 2.5017 0.15091 3.7045 1.4887 1.3108 1.4579 1.7273 2.7656 2.5521 8.013 0.90488 5.7568 1.665 9.3572 2.2152 10.492 0.2352 0.48521 1.3382 2.0764 2.4512 3.536 1.113 1.4596 2.9196 3.8299 4.0147 5.2673 1.0951 1.4374 2.313 3.2474 2.7064 4.0222l0.71527 1.4087 0.06037 8.026 0.06038 8.026h-14.451zm67.512-5.8394v-9.0015l0.79613-1.1776c0.43787-0.64765 2.0071-2.5568 3.4872-4.2424 3.392-3.8632 5.2918-6.2138 5.9754-7.3934 0.58124-1.0029 1.3321-4.6925 1.9568-9.6153 0.40131-3.1625 0.93563-5.4209 1.5936-6.7355 0.5337-1.0664 1.7554-2.4144 2.5807-2.8477 0.74533-0.39126 2.9962-0.38728 3.758 7e-3 0.67868 0.35095 1.7788 1.5408 2.2282 2.41 1.2788 2.4729 1.5109 11.86 0.44308 17.918-0.52083 2.9546-1.1868 4.6502-3.8016 9.6781-4.1124 7.9076-4.3368 8.6721-4.5181 15.385l-0.12468 4.6176h-14.375zm-30.359 2.9241c-0.29192-0.0413-1.3428-0.18107-2.3353-0.31069-4.8973-0.63961-9.7826-2.2287-14.776-4.8063l-1.2948-0.66837-0.14651-2.2954c-0.39708-6.2212-0.83058-7.1524-5.8614-12.591-3.6182-3.9117-4.7062-5.4078-5.2719-7.2495-0.23826-0.77567-0.78103-3.6339-1.2062-6.3517-1.1993-7.667-1.9539-10.145-3.6891-12.117-1.3848-1.5732-3.971-2.4925-6.1278-2.178l-0.90229 0.13154v-1.0053c0-2.6432 1.0709-7.9551 2.375-11.781 4.7177-13.84 17.46-25.681 31.544-29.313 4.6196-1.1911 6.0367-1.3499 12.044-1.3499 5.9102 0 7.4888 0.17046 11.88 1.2828 13.961 3.5365 26.708 15.201 31.526 28.849 1.2742 3.6093 2.5487 9.6052 2.5557 12.024l2e-3 0.77144-2.07 0.0867c-3.2053 0.13424-5.0748 1.1749-6.8762 3.8275-2.0807 3.064-3.2671 7.3643-4.1171 14.924-0.23123 2.0562-0.47531 3.2667-0.79198 3.9276-0.2943 0.6142-1.9013 2.4337-4.5003 5.0953-5.5679 5.702-5.8469 6.2996-5.8469 12.524v3.3367l-2.3689 1.1112c-4.3342 2.033-9.509 3.4946-14.297 4.0382-1.7658 0.20048-8.225 0.26035-9.4475 0.0876zm7.274-12.661c4.2512-1.9463 6.1481-7.4161 5.8266-16.802-0.25346-7.4-1.8213-11.933-4.8301-13.966-1.4095-0.95228-2.4457-1.2343-4.5351-1.2343-3.843 0-6.6843 2.2991-8.0505 6.5145-0.75123 2.3178-0.95468 3.4601-1.206 6.7712-0.43192 5.6904 0.47817 11.645 2.3534 15.397 0.77386 1.5484 1.515 2.4106 2.6375 3.0684 1.2325 0.72229 2.3983 0.93589 4.6887 0.85906 1.5253-0.0512 2.1776-0.17843 3.1156-0.60784zm-16.191-39.397c1.475-0.57784 3.0123-1.7415 4.1579-3.1474 2.3523-2.8868 2.6322-7.3787 0.6641-10.656-0.8987-1.4968-3.0112-3.4564-4.4697-4.1464-6.2431-2.9535-13.525 1.8911-13.512 8.9892 0.0076 4.2016 2.6152 7.8762 6.4933 9.1506 1.7127 0.5628 4.9839 0.46981 6.6669-0.18951zm32.038 0.19884c2.5958-0.80792 4.8437-2.7769 6.0307-5.2826 0.63828-1.3474 0.67618-1.5644 0.67618-3.8726 0-2.3512-0.02786-2.5022-0.72428-3.9276-0.93492-1.9135-3.0438-4.0358-4.9249-4.9564-4.3066-2.1074-9.5562-0.58293-12.152 3.5288-1.9533 3.0942-1.9381 7.637 0.035 10.504 1.3133 1.908 3.3519 3.4451 5.4524 4.1112 1.3111 0.41574 4.1022 0.3637 5.6067-0.10454z"/></svg>',
            bludgeoning: '<svg viewBox="0 0 100 100" fill="currentColor"><path d="m61.395 0-19.303 19.303 2.4121 2.4141h4.8262v4.8242l7.2383 7.2402-55.496 55.494c-2.4129 2.4128 0 4.8262 0 4.8262l4.8262 4.8262s2.4133 2.4129 4.8262 0l55.496-55.496 7.2383 7.2363h4.8262v4.8262l2.4121 2.4141 19.303-19.303-2.4121-2.4121h-4.8262v-4.8262l-24.129-24.129h-4.8262v-4.8262z"/></svg>',
            piercing: '<svg viewBox="0 0 100 100" fill="currentColor"><path d="m21.577 99.656c-0.09732-0.24455-0.11486-3.189-0.06077-10.203 0.06895-8.9385 0.05709-9.899-0.1269-10.287-0.39345-0.8293 0.12106-0.79156-10.817-0.79359-10.627-2e-3 -10.498 6e-3 -10.571-0.62606-0.029768-0.25789 0.55472-0.89731 3.4993-3.8282 2.688-2.6755 3.6847-3.589 4.1599-3.8125l0.62487-0.29397 10.355-0.0334c10.167-0.0328 10.362-0.0289 10.759 0.21663 0.86406 0.53412 0.83074 0.0579 0.79178 11.317l-0.03504 10.125-0.29345 0.72752c-0.26231 0.65032-0.67025 1.1046-3.8449 4.2813-3.0788 3.0808-3.6015 3.5538-3.9275 3.5538-0.29379 0-0.40602-0.0752-0.5129-0.34375zm11.342-11.016c-0.19684-0.21754-0.2113-0.98318-0.19442-10.295 0.02024-11.16 0.06047-10.607-0.80107-11.016-0.38734-0.18384-1.4329-0.20436-10.416-0.20436-7.5997 0-10.021-0.0358-10.135-0.14999-0.44074-0.44083-0.23682-0.70009 3.3806-4.2978 2.0817-2.0703 3.7167-3.5961 3.9842-3.718 0.88283-0.40235 1.954-0.57176 4.8578-0.76826 1.6153-0.10931 3.9492-0.28054 5.1864-0.38052 1.2372-0.1 3.0336-0.23563 3.9919-0.30147l1.7424-0.1197 22.346-22.351c12.291-12.293 22.346-22.386 22.346-22.43 0-0.0909-0.09702-0.13015-2.437-0.98422-0.9623-0.35122-2.0308-0.74455-2.3745-0.87406-1.4086-0.53084-3.1623-1.1803-3.7492-1.3885-0.34368-0.12191-0.99042-0.35718-1.4372-0.52284-4.2381-1.5714-5.7739-2.1348-6.2834-2.3051-0.59591-0.19919-1.2151-0.65808-1.2151-0.90054 0-0.38595 0.91602-0.55132 11.064-1.9975 5.7715-0.82246 10.915-1.5537 11.431-1.6249 0.51552-0.0713 2.3151-0.32716 3.9992-0.56871 1.684-0.24155 3.9054-0.55853 4.9365-0.70443 1.031-0.14588 2.5648-0.37168 3.4083-0.50176 2.1766-0.33567 2.782-0.31909 3.1624 0.0866 0.37862 0.40382 0.38118 1.021 0.0142 3.4269-0.14154 0.92813-0.37644 2.5312-0.52198 3.5625-0.14555 1.0312-0.3749 2.6344-0.50969 3.5625-0.55123 3.7958-0.63271 4.3676-0.80156 5.625-0.0969 0.72189-0.35055 2.4938-0.56356 3.9375-0.21303 1.4438-0.46779 3.2213-0.56615 3.95-0.0983 0.72877-0.49177 3.485-0.87424 6.125-0.38248 2.64-0.75646 5.3062-0.83107 5.925-0.13166 1.0918-0.3692 1.8125-0.59739 1.8125-0.4241 0-0.7629-0.48459-1.1361-1.625-0.13574-0.41477-0.6548-1.8264-1.6776-4.5625-0.46261-1.2375-1.0355-2.7844-1.273-3.4375-0.23755-0.65312-0.51095-1.3844-0.60754-1.625-0.15672-0.39042-0.52545-1.3897-1.8449-5-0.21357-0.58438-0.43356-1.1155-0.48886-1.1803-0.05733-0.0672-9.7107 9.4913-22.471 22.25l-22.37 22.368-0.30872 4.0625c-0.37002 4.8692-0.67254 8.7558-0.77059 9.9001-0.14069 1.6419-0.39679 1.9926-4.34 5.9437-2.3506 2.3553-3.6104 3.5313-3.7832 3.5313-0.14246 0-0.35471-0.10576-0.47167-0.23503z"/></svg>',
            slashing: '<svg viewBox="0 0 100 100" fill="currentColor"><path d="m4.8999 90.654c-3.1793-3.4245-5.0089-5.6458-4.8949-5.9429 0.10011-0.26088 0.58598-0.66031 1.0797-0.88762 2.0124-0.92646 6.1543-2.3417 6.8534-2.3417 0.41097 0 1.0378-0.2636 1.3929-0.58577 11.617-10.538 14.106-12.853 14.004-13.028-0.06696-0.11529-0.73867-1.2233-1.4927-2.4622-1.2508-2.0551-3.7047-9.1327-3.7047-10.685 0-0.47097 0.41191-0.55291 2.7797-0.55291 3.1579 0 3.1506-5e-3 4.8745 3.0811 0.58848 1.0534 1.2153 2.0051 1.3929 2.1149 1.0795 0.66719 2.8388-0.41797 9.3555-5.7707 11.849-9.7331 13.341-11.028 24.067-20.903 1.832-1.6866 9.3742-8.1934 16.76-14.46l13.429-11.393 4.1814-1.4833c2.2997-0.81582 4.4045-1.4833 4.6772-1.4833 0.70392 0 0.41618 0.90997-1.6975 5.3684-1.7685 3.7303-1.8697 3.8616-6.2504 8.109-2.449 2.3745-8.0502 7.8512-12.447 12.17-4.3969 4.3192-12.041 11.538-16.988 16.043-8.2453 7.5081-23.338 22.61-23.876 23.891-0.59434 1.4136-0.28626 1.931 2.0907 3.5116l2.3639 1.5719-0.11552 2.9464c-0.06354 1.6205-0.20782 3.0385-0.32063 3.1511-0.47114 0.4702-8.3263-2.8347-10.762-4.5276l-2.4898-1.7309-2.9145 2.6379c-10.184 9.2179-11.951 10.955-12.316 12.113-0.63909 2.0284-3.1884 7.0138-3.5823 7.0057-0.20616-4e-3 -2.6594-2.4686-5.4517-5.4763z"/></svg>',
            healing: '<svg viewBox="0 0 24 24" fill="currentColor"><path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm-2 10h-4v4h-2v-4H7v-2h4V7h2v4h4v2z"/></svg>'
        };
        
        // Damage type colors
        const DAMAGE_COLORS = {
            fire: '#ff6b35', cold: '#4fc3f7', lightning: '#ffd54f', thunder: '#7e57c2',
            acid: '#8bc34a', poison: '#9c27b0', necrotic: '#424242', radiant: '#fff59d',
            force: '#2196f3', psychic: '#e91e63', bludgeoning: '#795548', piercing: '#607d8b',
            slashing: '#9e9e9e', healing: '#4caf50', special: '#ff9800'
        };
        
        const SRD_WEAPONS = [
            // Simple Melee Weapons (SRD 5.1 accurate)
            { name: 'Club', damage: '1d4', type: 'bludgeoning', category: 'Simple Melee', properties: ['Light'], icon: 'mace' },
            { name: 'Dagger', damage: '1d4', type: 'piercing', category: 'Simple Melee', properties: ['Finesse', 'Light', 'Thrown (20/60)'], icon: 'dagger' },
            { name: 'Greatclub', damage: '1d8', type: 'bludgeoning', category: 'Simple Melee', properties: ['Two-Handed'], icon: 'mace' },
            { name: 'Handaxe', damage: '1d6', type: 'slashing', category: 'Simple Melee', properties: ['Light', 'Thrown (20/60)'], icon: 'axe' },
            { name: 'Javelin', damage: '1d6', type: 'piercing', category: 'Simple Melee', properties: ['Thrown (30/120)'], icon: 'spear' },
            { name: 'Light Hammer', damage: '1d4', type: 'bludgeoning', category: 'Simple Melee', properties: ['Light', 'Thrown (20/60)'], icon: 'hammer' },
            { name: 'Mace', damage: '1d6', type: 'bludgeoning', category: 'Simple Melee', properties: [], icon: 'mace' },
            { name: 'Quarterstaff', damage: '1d6', type: 'bludgeoning', category: 'Simple Melee', properties: ['Versatile (1d8)'], icon: 'staff' },
            { name: 'Sickle', damage: '1d4', type: 'slashing', category: 'Simple Melee', properties: ['Light'], icon: 'dagger' },
            { name: 'Spear', damage: '1d6', type: 'piercing', category: 'Simple Melee', properties: ['Thrown (20/60)', 'Versatile (1d8)'], icon: 'spear' },
            // Simple Ranged Weapons
            { name: 'Light Crossbow', damage: '1d8', type: 'piercing', category: 'Simple Ranged', properties: ['Ammunition (80/320)', 'Loading', 'Two-Handed'], icon: 'crossbow' },
            { name: 'Dart', damage: '1d4', type: 'piercing', category: 'Simple Ranged', properties: ['Finesse', 'Thrown (20/60)'], icon: 'dagger' },
            { name: 'Shortbow', damage: '1d6', type: 'piercing', category: 'Simple Ranged', properties: ['Ammunition (80/320)', 'Two-Handed'], icon: 'bow' },
            { name: 'Sling', damage: '1d4', type: 'bludgeoning', category: 'Simple Ranged', properties: ['Ammunition (30/120)'], icon: 'sling' },
            // Martial Melee Weapons
            { name: 'Battleaxe', damage: '1d8', type: 'slashing', category: 'Martial Melee', properties: ['Versatile (1d10)'], icon: 'axe' },
            { name: 'Flail', damage: '1d8', type: 'bludgeoning', category: 'Martial Melee', properties: [], icon: 'flail' },
            { name: 'Glaive', damage: '1d10', type: 'slashing', category: 'Martial Melee', properties: ['Heavy', 'Reach', 'Two-Handed'], icon: 'polearm' },
            { name: 'Greataxe', damage: '1d12', type: 'slashing', category: 'Martial Melee', properties: ['Heavy', 'Two-Handed'], icon: 'axe' },
            { name: 'Greatsword', damage: '2d6', type: 'slashing', category: 'Martial Melee', properties: ['Heavy', 'Two-Handed'], icon: 'sword' },
            { name: 'Halberd', damage: '1d10', type: 'slashing', category: 'Martial Melee', properties: ['Heavy', 'Reach', 'Two-Handed'], icon: 'polearm' },
            { name: 'Lance', damage: '1d12', type: 'piercing', category: 'Martial Melee', properties: ['Reach', 'Special'], icon: 'spear' },
            { name: 'Longsword', damage: '1d8', type: 'slashing', category: 'Martial Melee', properties: ['Versatile (1d10)'], icon: 'sword' },
            { name: 'Maul', damage: '2d6', type: 'bludgeoning', category: 'Martial Melee', properties: ['Heavy', 'Two-Handed'], icon: 'hammer' },
            { name: 'Morningstar', damage: '1d8', type: 'piercing', category: 'Martial Melee', properties: [], icon: 'mace' },
            { name: 'Pike', damage: '1d10', type: 'piercing', category: 'Martial Melee', properties: ['Heavy', 'Reach', 'Two-Handed'], icon: 'polearm' },
            { name: 'Rapier', damage: '1d8', type: 'piercing', category: 'Martial Melee', properties: ['Finesse'], icon: 'sword' },
            { name: 'Scimitar', damage: '1d6', type: 'slashing', category: 'Martial Melee', properties: ['Finesse', 'Light'], icon: 'sword' },
            { name: 'Shortsword', damage: '1d6', type: 'piercing', category: 'Martial Melee', properties: ['Finesse', 'Light'], icon: 'sword' },
            { name: 'Trident', damage: '1d6', type: 'piercing', category: 'Martial Melee', properties: ['Thrown (20/60)', 'Versatile (1d8)'], icon: 'spear' },
            { name: 'War Pick', damage: '1d8', type: 'piercing', category: 'Martial Melee', properties: [], icon: 'axe' },
            { name: 'Warhammer', damage: '1d8', type: 'bludgeoning', category: 'Martial Melee', properties: ['Versatile (1d10)'], icon: 'hammer' },
            { name: 'Whip', damage: '1d4', type: 'slashing', category: 'Martial Melee', properties: ['Finesse', 'Reach'], icon: 'whip' },
            // Martial Ranged Weapons
            { name: 'Blowgun', damage: '1', type: 'piercing', category: 'Martial Ranged', properties: ['Ammunition (25/100)', 'Loading'], icon: 'bow' },
            { name: 'Hand Crossbow', damage: '1d6', type: 'piercing', category: 'Martial Ranged', properties: ['Ammunition (30/120)', 'Light', 'Loading'], icon: 'crossbow' },
            { name: 'Heavy Crossbow', damage: '1d10', type: 'piercing', category: 'Martial Ranged', properties: ['Ammunition (100/400)', 'Heavy', 'Loading', 'Two-Handed'], icon: 'crossbow' },
            { name: 'Longbow', damage: '1d8', type: 'piercing', category: 'Martial Ranged', properties: ['Ammunition (150/600)', 'Heavy', 'Two-Handed'], icon: 'bow' },
            { name: 'Net', damage: '—', type: 'special', category: 'Martial Ranged', properties: ['Special', 'Thrown (5/15)'], icon: 'net' }
        ];

        // German translations for weapons
        const WEAPONS_DE = {
            'Club': 'Keule', 'Dagger': 'Dolch', 'Greatclub': 'Große Keule', 'Handaxe': 'Handaxt',
            'Javelin': 'Wurfspeer', 'Light Hammer': 'Leichter Hammer', 'Mace': 'Streitkolben',
            'Quarterstaff': 'Kampfstab', 'Sickle': 'Sichel', 'Spear': 'Speer',
            'Light Crossbow': 'Leichte Armbrust', 'Dart': 'Wurfpfeil', 'Shortbow': 'Kurzbogen', 'Sling': 'Schleuder',
            'Battleaxe': 'Streitaxt', 'Flail': 'Flegel', 'Glaive': 'Glefe', 'Greataxe': 'Große Axt',
            'Greatsword': 'Großschwert', 'Halberd': 'Hellebarde', 'Lance': 'Lanze', 'Longsword': 'Langschwert',
            'Maul': 'Schlägel', 'Morningstar': 'Morgenstern', 'Pike': 'Pike', 'Rapier': 'Rapier',
            'Scimitar': 'Krummsäbel', 'Shortsword': 'Kurzschwert', 'Trident': 'Dreizack',
            'War Pick': 'Kriegspickel', 'Warhammer': 'Kriegshammer', 'Whip': 'Peitsche',
            'Blowgun': 'Blasrohr', 'Hand Crossbow': 'Handarmbrust', 'Heavy Crossbow': 'Schwere Armbrust',
            'Longbow': 'Langbogen', 'Net': 'Netz'
        };

        // ===== SRD 5.1 COMPLETE SPELL DATABASE (320+ Spells) =====
        const SRD_SPELLS = [
            // === CANTRIPS (Level 0) ===
            { name: 'Acid Splash', level: 0, school: 'Conjuration', time: 'Action', range: '60 ft', damage: '1d6 acid', classes: ['Sorcerer', 'Wizard'], conc: false, ritual: false },
            { name: 'Chill Touch', level: 0, school: 'Necromancy', time: 'Action', range: '120 ft', damage: '1d8 necrotic', classes: ['Sorcerer', 'Warlock', 'Wizard'], conc: false, ritual: false },
            { name: 'Dancing Lights', level: 0, school: 'Evocation', time: 'Action', range: '120 ft', damage: '—', classes: ['Bard', 'Sorcerer', 'Wizard'], conc: true, ritual: false },
            { name: 'Druidcraft', level: 0, school: 'Transmutation', time: 'Action', range: '30 ft', damage: '—', classes: ['Druid'], conc: false, ritual: false },
            { name: 'Eldritch Blast', level: 0, school: 'Evocation', time: 'Action', range: '120 ft', damage: '1d10 force', classes: ['Warlock'], conc: false, ritual: false },
            { name: 'Fire Bolt', level: 0, school: 'Evocation', time: 'Action', range: '120 ft', damage: '1d10 fire', classes: ['Sorcerer', 'Wizard'], conc: false, ritual: false },
            { name: 'Guidance', level: 0, school: 'Divination', time: 'Action', range: 'Touch', damage: '—', classes: ['Cleric', 'Druid'], conc: true, ritual: false },
            { name: 'Light', level: 0, school: 'Evocation', time: 'Action', range: 'Touch', damage: '—', classes: ['Bard', 'Cleric', 'Sorcerer', 'Wizard'], conc: false, ritual: false },
            { name: 'Mage Hand', level: 0, school: 'Conjuration', time: 'Action', range: '30 ft', damage: '—', classes: ['Bard', 'Sorcerer', 'Warlock', 'Wizard'], conc: false, ritual: false },
            { name: 'Mending', level: 0, school: 'Transmutation', time: '1 Minute', range: 'Touch', damage: '—', classes: ['Bard', 'Cleric', 'Druid', 'Sorcerer', 'Wizard'], conc: false, ritual: false },
            { name: 'Message', level: 0, school: 'Transmutation', time: 'Action', range: '120 ft', damage: '—', classes: ['Bard', 'Sorcerer', 'Wizard'], conc: false, ritual: false },
            { name: 'Minor Illusion', level: 0, school: 'Illusion', time: 'Action', range: '30 ft', damage: '—', classes: ['Bard', 'Sorcerer', 'Warlock', 'Wizard'], conc: false, ritual: false },
            { name: 'Poison Spray', level: 0, school: 'Conjuration', time: 'Action', range: '10 ft', damage: '1d12 poison', classes: ['Druid', 'Sorcerer', 'Warlock', 'Wizard'], conc: false, ritual: false },
            { name: 'Prestidigitation', level: 0, school: 'Transmutation', time: 'Action', range: '10 ft', damage: '—', classes: ['Bard', 'Sorcerer', 'Warlock', 'Wizard'], conc: false, ritual: false },
            { name: 'Produce Flame', level: 0, school: 'Conjuration', time: 'Action', range: '30 ft', damage: '1d8 fire', classes: ['Druid'], conc: false, ritual: false },
            { name: 'Ray of Frost', level: 0, school: 'Evocation', time: 'Action', range: '60 ft', damage: '1d8 cold', classes: ['Sorcerer', 'Wizard'], conc: false, ritual: false },
            { name: 'Resistance', level: 0, school: 'Abjuration', time: 'Action', range: 'Touch', damage: '—', classes: ['Cleric', 'Druid'], conc: true, ritual: false },
            { name: 'Sacred Flame', level: 0, school: 'Evocation', time: 'Action', range: '60 ft', damage: '1d8 radiant', classes: ['Cleric'], conc: false, ritual: false },
            { name: 'Shillelagh', level: 0, school: 'Transmutation', time: 'Bonus Action', range: 'Touch', damage: '1d8 bludgeoning', classes: ['Druid'], conc: false, ritual: false },
            { name: 'Shocking Grasp', level: 0, school: 'Evocation', time: 'Action', range: 'Touch', damage: '1d8 lightning', classes: ['Sorcerer', 'Wizard'], conc: false, ritual: false },
            { name: 'Spare the Dying', level: 0, school: 'Necromancy', time: 'Action', range: 'Touch', damage: '—', classes: ['Cleric'], conc: false, ritual: false },
            { name: 'Thaumaturgy', level: 0, school: 'Transmutation', time: 'Action', range: '30 ft', damage: '—', classes: ['Cleric'], conc: false, ritual: false },
            { name: 'True Strike', level: 0, school: 'Divination', time: 'Action', range: '30 ft', damage: '—', classes: ['Bard', 'Sorcerer', 'Warlock', 'Wizard'], conc: true, ritual: false },
            { name: 'Vicious Mockery', level: 0, school: 'Enchantment', time: 'Action', range: '60 ft', damage: '1d4 psychic', classes: ['Bard'], conc: false, ritual: false },
            
            // === 1ST LEVEL ===
            { name: 'Alarm', level: 1, school: 'Abjuration', time: '1 Minute', range: '30 ft', damage: '—', classes: ['Ranger', 'Wizard'], conc: false, ritual: true },
            { name: 'Animal Friendship', level: 1, school: 'Enchantment', time: 'Action', range: '30 ft', damage: '—', classes: ['Bard', 'Druid', 'Ranger'], conc: false, ritual: false },
            { name: 'Bane', level: 1, school: 'Enchantment', time: 'Action', range: '30 ft', damage: '—', classes: ['Bard', 'Cleric'], conc: true, ritual: false },
            { name: 'Bless', level: 1, school: 'Enchantment', time: 'Action', range: '30 ft', damage: '—', classes: ['Cleric', 'Paladin'], conc: true, ritual: false },
            { name: 'Burning Hands', level: 1, school: 'Evocation', time: 'Action', range: 'Self (15 ft cone)', damage: '3d6 fire', classes: ['Sorcerer', 'Wizard'], conc: false, ritual: false },
            { name: 'Charm Person', level: 1, school: 'Enchantment', time: 'Action', range: '30 ft', damage: '—', classes: ['Bard', 'Druid', 'Sorcerer', 'Warlock', 'Wizard'], conc: false, ritual: false },
            { name: 'Color Spray', level: 1, school: 'Illusion', time: 'Action', range: 'Self (15 ft cone)', damage: '—', classes: ['Sorcerer', 'Wizard'], conc: false, ritual: false },
            { name: 'Command', level: 1, school: 'Enchantment', time: 'Action', range: '60 ft', damage: '—', classes: ['Cleric', 'Paladin'], conc: false, ritual: false },
            { name: 'Comprehend Languages', level: 1, school: 'Divination', time: 'Action', range: 'Self', damage: '—', classes: ['Bard', 'Sorcerer', 'Warlock', 'Wizard'], conc: false, ritual: true },
            { name: 'Cure Wounds', level: 1, school: 'Evocation', time: 'Action', range: 'Touch', damage: '1d8 healing', classes: ['Bard', 'Cleric', 'Druid', 'Paladin', 'Ranger'], conc: false, ritual: false },
            { name: 'Detect Evil and Good', level: 1, school: 'Divination', time: 'Action', range: 'Self', damage: '—', classes: ['Cleric', 'Paladin'], conc: true, ritual: false },
            { name: 'Detect Magic', level: 1, school: 'Divination', time: 'Action', range: 'Self', damage: '—', classes: ['Bard', 'Cleric', 'Druid', 'Paladin', 'Ranger', 'Sorcerer', 'Wizard'], conc: true, ritual: true },
            { name: 'Detect Poison and Disease', level: 1, school: 'Divination', time: 'Action', range: 'Self', damage: '—', classes: ['Cleric', 'Druid', 'Paladin', 'Ranger'], conc: true, ritual: true },
            { name: 'Disguise Self', level: 1, school: 'Illusion', time: 'Action', range: 'Self', damage: '—', classes: ['Bard', 'Sorcerer', 'Wizard'], conc: false, ritual: false },
            { name: 'Divine Favor', level: 1, school: 'Evocation', time: 'Bonus Action', range: 'Self', damage: '+1d4 radiant', classes: ['Paladin'], conc: true, ritual: false },
            { name: 'Entangle', level: 1, school: 'Conjuration', time: 'Action', range: '90 ft', damage: '—', classes: ['Druid'], conc: true, ritual: false },
            { name: 'Expeditious Retreat', level: 1, school: 'Transmutation', time: 'Bonus Action', range: 'Self', damage: '—', classes: ['Sorcerer', 'Warlock', 'Wizard'], conc: true, ritual: false },
            { name: 'Faerie Fire', level: 1, school: 'Evocation', time: 'Action', range: '60 ft', damage: '—', classes: ['Bard', 'Druid'], conc: true, ritual: false },
            { name: 'False Life', level: 1, school: 'Necromancy', time: 'Action', range: 'Self', damage: '—', classes: ['Sorcerer', 'Wizard'], conc: false, ritual: false },
            { name: 'Feather Fall', level: 1, school: 'Transmutation', time: 'Reaction', range: '60 ft', damage: '—', classes: ['Bard', 'Sorcerer', 'Wizard'], conc: false, ritual: false },
            { name: 'Find Familiar', level: 1, school: 'Conjuration', time: '1 Hour', range: '10 ft', damage: '—', classes: ['Wizard'], conc: false, ritual: true },
            { name: 'Fog Cloud', level: 1, school: 'Conjuration', time: 'Action', range: '120 ft', damage: '—', classes: ['Druid', 'Ranger', 'Sorcerer', 'Wizard'], conc: true, ritual: false },
            { name: 'Goodberry', level: 1, school: 'Transmutation', time: 'Action', range: 'Touch', damage: '—', classes: ['Druid', 'Ranger'], conc: false, ritual: false },
            { name: 'Grease', level: 1, school: 'Conjuration', time: 'Action', range: '60 ft', damage: '—', classes: ['Wizard'], conc: false, ritual: false },
            { name: 'Guiding Bolt', level: 1, school: 'Evocation', time: 'Action', range: '120 ft', damage: '4d6 radiant', classes: ['Cleric'], conc: false, ritual: false },
            { name: 'Healing Word', level: 1, school: 'Evocation', time: 'Bonus Action', range: '60 ft', damage: '1d4 healing', classes: ['Bard', 'Cleric', 'Druid'], conc: false, ritual: false },
            { name: 'Hellish Rebuke', level: 1, school: 'Evocation', time: 'Reaction', range: '60 ft', damage: '2d10 fire', classes: ['Warlock'], conc: false, ritual: false },
            { name: 'Heroism', level: 1, school: 'Enchantment', time: 'Action', range: 'Touch', damage: '—', classes: ['Bard', 'Paladin'], conc: true, ritual: false },
            { name: 'Hideous Laughter', level: 1, school: 'Enchantment', time: 'Action', range: '30 ft', damage: '—', classes: ['Bard', 'Wizard'], conc: true, ritual: false },
            { name: "Hunter's Mark", level: 1, school: 'Divination', time: 'Bonus Action', range: '90 ft', damage: '+1d6', classes: ['Ranger'], conc: true, ritual: false },
            { name: 'Identify', level: 1, school: 'Divination', time: '1 Minute', range: 'Touch', damage: '—', classes: ['Bard', 'Wizard'], conc: false, ritual: true },
            { name: 'Inflict Wounds', level: 1, school: 'Necromancy', time: 'Action', range: 'Touch', damage: '3d10 necrotic', classes: ['Cleric'], conc: false, ritual: false },
            { name: 'Jump', level: 1, school: 'Transmutation', time: 'Action', range: 'Touch', damage: '—', classes: ['Druid', 'Ranger', 'Sorcerer', 'Wizard'], conc: false, ritual: false },
            { name: 'Longstrider', level: 1, school: 'Transmutation', time: 'Action', range: 'Touch', damage: '—', classes: ['Bard', 'Druid', 'Ranger', 'Wizard'], conc: false, ritual: false },
            { name: 'Mage Armor', level: 1, school: 'Abjuration', time: 'Action', range: 'Touch', damage: '—', classes: ['Sorcerer', 'Wizard'], conc: false, ritual: false },
            { name: 'Magic Missile', level: 1, school: 'Evocation', time: 'Action', range: '120 ft', damage: '3×1d4+1 force', classes: ['Sorcerer', 'Wizard'], conc: false, ritual: false },
            { name: 'Protection from Evil and Good', level: 1, school: 'Abjuration', time: 'Action', range: 'Touch', damage: '—', classes: ['Cleric', 'Paladin', 'Warlock', 'Wizard'], conc: true, ritual: false },
            { name: 'Sanctuary', level: 1, school: 'Abjuration', time: 'Bonus Action', range: '30 ft', damage: '—', classes: ['Cleric'], conc: false, ritual: false },
            { name: 'Shield', level: 1, school: 'Abjuration', time: 'Reaction', range: 'Self', damage: '—', classes: ['Sorcerer', 'Wizard'], conc: false, ritual: false },
            { name: 'Shield of Faith', level: 1, school: 'Abjuration', time: 'Bonus Action', range: '60 ft', damage: '—', classes: ['Cleric', 'Paladin'], conc: true, ritual: false },
            { name: 'Silent Image', level: 1, school: 'Illusion', time: 'Action', range: '60 ft', damage: '—', classes: ['Bard', 'Sorcerer', 'Wizard'], conc: true, ritual: false },
            { name: 'Sleep', level: 1, school: 'Enchantment', time: 'Action', range: '90 ft', damage: '—', classes: ['Bard', 'Sorcerer', 'Wizard'], conc: false, ritual: false },
            { name: 'Speak with Animals', level: 1, school: 'Divination', time: 'Action', range: 'Self', damage: '—', classes: ['Bard', 'Druid', 'Ranger'], conc: false, ritual: true },
            { name: 'Thunderwave', level: 1, school: 'Evocation', time: 'Action', range: 'Self (15 ft cube)', damage: '2d8 thunder', classes: ['Bard', 'Druid', 'Sorcerer', 'Wizard'], conc: false, ritual: false },
            { name: 'Unseen Servant', level: 1, school: 'Conjuration', time: 'Action', range: '60 ft', damage: '—', classes: ['Bard', 'Warlock', 'Wizard'], conc: false, ritual: true },

            // === 2ND LEVEL ===
            { name: 'Aid', level: 2, school: 'Abjuration', time: 'Action', range: '30 ft', damage: '—', classes: ['Cleric', 'Paladin'], conc: false, ritual: false },
            { name: 'Alter Self', level: 2, school: 'Transmutation', time: 'Action', range: 'Self', damage: '—', classes: ['Sorcerer', 'Wizard'], conc: true, ritual: false },
            { name: 'Barkskin', level: 2, school: 'Transmutation', time: 'Action', range: 'Touch', damage: '—', classes: ['Druid', 'Ranger'], conc: true, ritual: false },
            { name: 'Blindness/Deafness', level: 2, school: 'Necromancy', time: 'Action', range: '30 ft', damage: '—', classes: ['Bard', 'Cleric', 'Sorcerer', 'Wizard'], conc: false, ritual: false },
            { name: 'Blur', level: 2, school: 'Illusion', time: 'Action', range: 'Self', damage: '—', classes: ['Sorcerer', 'Wizard'], conc: true, ritual: false },
            { name: 'Calm Emotions', level: 2, school: 'Enchantment', time: 'Action', range: '60 ft', damage: '—', classes: ['Bard', 'Cleric'], conc: true, ritual: false },
            { name: 'Darkness', level: 2, school: 'Evocation', time: 'Action', range: '60 ft', damage: '—', classes: ['Sorcerer', 'Warlock', 'Wizard'], conc: true, ritual: false },
            { name: 'Darkvision', level: 2, school: 'Transmutation', time: 'Action', range: 'Touch', damage: '—', classes: ['Druid', 'Ranger', 'Sorcerer', 'Wizard'], conc: false, ritual: false },
            { name: 'Detect Thoughts', level: 2, school: 'Divination', time: 'Action', range: 'Self', damage: '—', classes: ['Bard', 'Sorcerer', 'Wizard'], conc: true, ritual: false },
            { name: 'Enhance Ability', level: 2, school: 'Transmutation', time: 'Action', range: 'Touch', damage: '—', classes: ['Bard', 'Cleric', 'Druid', 'Sorcerer'], conc: true, ritual: false },
            { name: 'Enlarge/Reduce', level: 2, school: 'Transmutation', time: 'Action', range: '30 ft', damage: '—', classes: ['Sorcerer', 'Wizard'], conc: true, ritual: false },
            { name: 'Flame Blade', level: 2, school: 'Evocation', time: 'Bonus Action', range: 'Self', damage: '3d6 fire', classes: ['Druid'], conc: true, ritual: false },
            { name: 'Flaming Sphere', level: 2, school: 'Conjuration', time: 'Action', range: '60 ft', damage: '2d6 fire', classes: ['Druid', 'Wizard'], conc: true, ritual: false },
            { name: 'Gust of Wind', level: 2, school: 'Evocation', time: 'Action', range: 'Self (60 ft line)', damage: '—', classes: ['Druid', 'Sorcerer', 'Wizard'], conc: true, ritual: false },
            { name: 'Heat Metal', level: 2, school: 'Transmutation', time: 'Action', range: '60 ft', damage: '2d8 fire', classes: ['Bard', 'Druid'], conc: true, ritual: false },
            { name: 'Hold Person', level: 2, school: 'Enchantment', time: 'Action', range: '60 ft', damage: '—', classes: ['Bard', 'Cleric', 'Druid', 'Sorcerer', 'Warlock', 'Wizard'], conc: true, ritual: false },
            { name: 'Invisibility', level: 2, school: 'Illusion', time: 'Action', range: 'Touch', damage: '—', classes: ['Bard', 'Sorcerer', 'Warlock', 'Wizard'], conc: true, ritual: false },
            { name: 'Knock', level: 2, school: 'Transmutation', time: 'Action', range: '60 ft', damage: '—', classes: ['Bard', 'Sorcerer', 'Wizard'], conc: false, ritual: false },
            { name: 'Lesser Restoration', level: 2, school: 'Abjuration', time: 'Action', range: 'Touch', damage: '—', classes: ['Bard', 'Cleric', 'Druid', 'Paladin', 'Ranger'], conc: false, ritual: false },
            { name: 'Levitate', level: 2, school: 'Transmutation', time: 'Action', range: '60 ft', damage: '—', classes: ['Sorcerer', 'Wizard'], conc: true, ritual: false },
            { name: 'Magic Weapon', level: 2, school: 'Transmutation', time: 'Bonus Action', range: 'Touch', damage: '—', classes: ['Paladin', 'Wizard'], conc: true, ritual: false },
            { name: 'Mirror Image', level: 2, school: 'Illusion', time: 'Action', range: 'Self', damage: '—', classes: ['Sorcerer', 'Warlock', 'Wizard'], conc: false, ritual: false },
            { name: 'Misty Step', level: 2, school: 'Conjuration', time: 'Bonus Action', range: 'Self', damage: '—', classes: ['Sorcerer', 'Warlock', 'Wizard'], conc: false, ritual: false },
            { name: 'Moonbeam', level: 2, school: 'Evocation', time: 'Action', range: '120 ft', damage: '2d10 radiant', classes: ['Druid'], conc: true, ritual: false },
            { name: 'Pass without Trace', level: 2, school: 'Abjuration', time: 'Action', range: 'Self', damage: '—', classes: ['Druid', 'Ranger'], conc: true, ritual: false },
            { name: 'Prayer of Healing', level: 2, school: 'Evocation', time: '10 Minutes', range: '30 ft', damage: '2d8 healing', classes: ['Cleric'], conc: false, ritual: false },
            { name: 'Protection from Poison', level: 2, school: 'Abjuration', time: 'Action', range: 'Touch', damage: '—', classes: ['Cleric', 'Druid', 'Paladin', 'Ranger'], conc: false, ritual: false },
            { name: 'Scorching Ray', level: 2, school: 'Evocation', time: 'Action', range: '120 ft', damage: '3×2d6 fire', classes: ['Sorcerer', 'Wizard'], conc: false, ritual: false },
            { name: 'See Invisibility', level: 2, school: 'Divination', time: 'Action', range: 'Self', damage: '—', classes: ['Bard', 'Sorcerer', 'Wizard'], conc: false, ritual: false },
            { name: 'Shatter', level: 2, school: 'Evocation', time: 'Action', range: '60 ft', damage: '3d8 thunder', classes: ['Bard', 'Sorcerer', 'Warlock', 'Wizard'], conc: false, ritual: false },
            { name: 'Silence', level: 2, school: 'Illusion', time: 'Action', range: '120 ft', damage: '—', classes: ['Bard', 'Cleric', 'Ranger'], conc: true, ritual: true },
            { name: 'Spider Climb', level: 2, school: 'Transmutation', time: 'Action', range: 'Touch', damage: '—', classes: ['Sorcerer', 'Warlock', 'Wizard'], conc: true, ritual: false },
            { name: 'Spike Growth', level: 2, school: 'Transmutation', time: 'Action', range: '150 ft', damage: '2d4 piercing', classes: ['Druid', 'Ranger'], conc: true, ritual: false },
            { name: 'Spiritual Weapon', level: 2, school: 'Evocation', time: 'Bonus Action', range: '60 ft', damage: '1d8+mod force', classes: ['Cleric'], conc: false, ritual: false },
            { name: 'Suggestion', level: 2, school: 'Enchantment', time: 'Action', range: '30 ft', damage: '—', classes: ['Bard', 'Sorcerer', 'Warlock', 'Wizard'], conc: true, ritual: false },
            { name: 'Web', level: 2, school: 'Conjuration', time: 'Action', range: '60 ft', damage: '—', classes: ['Sorcerer', 'Wizard'], conc: true, ritual: false },
            { name: 'Zone of Truth', level: 2, school: 'Enchantment', time: 'Action', range: '60 ft', damage: '—', classes: ['Bard', 'Cleric', 'Paladin'], conc: false, ritual: false },

            // === 3RD LEVEL ===
            { name: 'Animate Dead', level: 3, school: 'Necromancy', time: '1 Minute', range: '10 ft', damage: '—', classes: ['Cleric', 'Wizard'], conc: false, ritual: false },
            { name: 'Beacon of Hope', level: 3, school: 'Abjuration', time: 'Action', range: '30 ft', damage: '—', classes: ['Cleric'], conc: true, ritual: false },
            { name: 'Bestow Curse', level: 3, school: 'Necromancy', time: 'Action', range: 'Touch', damage: '—', classes: ['Bard', 'Cleric', 'Wizard'], conc: true, ritual: false },
            { name: 'Blink', level: 3, school: 'Transmutation', time: 'Action', range: 'Self', damage: '—', classes: ['Sorcerer', 'Wizard'], conc: false, ritual: false },
            { name: 'Call Lightning', level: 3, school: 'Conjuration', time: 'Action', range: '120 ft', damage: '3d10 lightning', classes: ['Druid'], conc: true, ritual: false },
            { name: 'Clairvoyance', level: 3, school: 'Divination', time: '10 Minutes', range: '1 mile', damage: '—', classes: ['Bard', 'Cleric', 'Sorcerer', 'Wizard'], conc: true, ritual: false },
            { name: 'Conjure Animals', level: 3, school: 'Conjuration', time: 'Action', range: '60 ft', damage: '—', classes: ['Druid', 'Ranger'], conc: true, ritual: false },
            { name: 'Counterspell', level: 3, school: 'Abjuration', time: 'Reaction', range: '60 ft', damage: '—', classes: ['Sorcerer', 'Warlock', 'Wizard'], conc: false, ritual: false },
            { name: 'Daylight', level: 3, school: 'Evocation', time: 'Action', range: '60 ft', damage: '—', classes: ['Cleric', 'Druid', 'Paladin', 'Ranger', 'Sorcerer'], conc: false, ritual: false },
            { name: 'Dispel Magic', level: 3, school: 'Abjuration', time: 'Action', range: '120 ft', damage: '—', classes: ['Bard', 'Cleric', 'Druid', 'Paladin', 'Sorcerer', 'Warlock', 'Wizard'], conc: false, ritual: false },
            { name: 'Fear', level: 3, school: 'Illusion', time: 'Action', range: 'Self (30 ft cone)', damage: '—', classes: ['Bard', 'Sorcerer', 'Warlock', 'Wizard'], conc: true, ritual: false },
            { name: 'Fireball', level: 3, school: 'Evocation', time: 'Action', range: '150 ft', damage: '8d6 fire', classes: ['Sorcerer', 'Wizard'], conc: false, ritual: false },
            { name: 'Fly', level: 3, school: 'Transmutation', time: 'Action', range: 'Touch', damage: '—', classes: ['Sorcerer', 'Warlock', 'Wizard'], conc: true, ritual: false },
            { name: 'Gaseous Form', level: 3, school: 'Transmutation', time: 'Action', range: 'Touch', damage: '—', classes: ['Sorcerer', 'Warlock', 'Wizard'], conc: true, ritual: false },
            { name: 'Haste', level: 3, school: 'Transmutation', time: 'Action', range: '30 ft', damage: '—', classes: ['Sorcerer', 'Wizard'], conc: true, ritual: false },
            { name: 'Hypnotic Pattern', level: 3, school: 'Illusion', time: 'Action', range: '120 ft', damage: '—', classes: ['Bard', 'Sorcerer', 'Warlock', 'Wizard'], conc: true, ritual: false },
            { name: 'Lightning Bolt', level: 3, school: 'Evocation', time: 'Action', range: 'Self (100 ft line)', damage: '8d6 lightning', classes: ['Sorcerer', 'Wizard'], conc: false, ritual: false },
            { name: 'Magic Circle', level: 3, school: 'Abjuration', time: '1 Minute', range: '10 ft', damage: '—', classes: ['Cleric', 'Paladin', 'Warlock', 'Wizard'], conc: false, ritual: false },
            { name: 'Major Image', level: 3, school: 'Illusion', time: 'Action', range: '120 ft', damage: '—', classes: ['Bard', 'Sorcerer', 'Warlock', 'Wizard'], conc: true, ritual: false },
            { name: 'Mass Healing Word', level: 3, school: 'Evocation', time: 'Bonus Action', range: '60 ft', damage: '1d4 healing', classes: ['Cleric'], conc: false, ritual: false },
            { name: 'Protection from Energy', level: 3, school: 'Abjuration', time: 'Action', range: 'Touch', damage: '—', classes: ['Cleric', 'Druid', 'Ranger', 'Sorcerer', 'Wizard'], conc: true, ritual: false },
            { name: 'Remove Curse', level: 3, school: 'Abjuration', time: 'Action', range: 'Touch', damage: '—', classes: ['Cleric', 'Paladin', 'Warlock', 'Wizard'], conc: false, ritual: false },
            { name: 'Revivify', level: 3, school: 'Necromancy', time: 'Action', range: 'Touch', damage: '—', classes: ['Cleric', 'Paladin'], conc: false, ritual: false },
            { name: 'Sending', level: 3, school: 'Evocation', time: 'Action', range: 'Unlimited', damage: '—', classes: ['Bard', 'Cleric', 'Wizard'], conc: false, ritual: false },
            { name: 'Slow', level: 3, school: 'Transmutation', time: 'Action', range: '120 ft', damage: '—', classes: ['Sorcerer', 'Wizard'], conc: true, ritual: false },
            { name: 'Speak with Dead', level: 3, school: 'Necromancy', time: 'Action', range: '10 ft', damage: '—', classes: ['Bard', 'Cleric'], conc: false, ritual: false },
            { name: 'Spirit Guardians', level: 3, school: 'Conjuration', time: 'Action', range: 'Self (15 ft radius)', damage: '3d8 radiant', classes: ['Cleric'], conc: true, ritual: false },
            { name: 'Stinking Cloud', level: 3, school: 'Conjuration', time: 'Action', range: '90 ft', damage: '—', classes: ['Bard', 'Sorcerer', 'Wizard'], conc: true, ritual: false },
            { name: 'Tongues', level: 3, school: 'Divination', time: 'Action', range: 'Touch', damage: '—', classes: ['Bard', 'Cleric', 'Sorcerer', 'Warlock', 'Wizard'], conc: false, ritual: false },
            { name: 'Vampiric Touch', level: 3, school: 'Necromancy', time: 'Action', range: 'Self', damage: '3d6 necrotic', classes: ['Warlock', 'Wizard'], conc: true, ritual: false },
            { name: 'Water Breathing', level: 3, school: 'Transmutation', time: 'Action', range: '30 ft', damage: '—', classes: ['Druid', 'Ranger', 'Sorcerer', 'Wizard'], conc: false, ritual: true },
            { name: 'Water Walk', level: 3, school: 'Transmutation', time: 'Action', range: '30 ft', damage: '—', classes: ['Cleric', 'Druid', 'Ranger', 'Sorcerer'], conc: false, ritual: true },

            // === 4TH LEVEL ===
            { name: 'Banishment', level: 4, school: 'Abjuration', time: 'Action', range: '60 ft', damage: '—', classes: ['Cleric', 'Paladin', 'Sorcerer', 'Warlock', 'Wizard'], conc: true, ritual: false },
            { name: 'Blight', level: 4, school: 'Necromancy', time: 'Action', range: '30 ft', damage: '8d8 necrotic', classes: ['Druid', 'Sorcerer', 'Warlock', 'Wizard'], conc: false, ritual: false },
            { name: 'Confusion', level: 4, school: 'Enchantment', time: 'Action', range: '90 ft', damage: '—', classes: ['Bard', 'Druid', 'Sorcerer', 'Wizard'], conc: true, ritual: false },
            { name: 'Conjure Minor Elementals', level: 4, school: 'Conjuration', time: '1 Minute', range: '90 ft', damage: '—', classes: ['Druid', 'Wizard'], conc: true, ritual: false },
            { name: 'Control Water', level: 4, school: 'Transmutation', time: 'Action', range: '300 ft', damage: '—', classes: ['Cleric', 'Druid', 'Wizard'], conc: true, ritual: false },
            { name: 'Death Ward', level: 4, school: 'Abjuration', time: 'Action', range: 'Touch', damage: '—', classes: ['Cleric', 'Paladin'], conc: false, ritual: false },
            { name: 'Dimension Door', level: 4, school: 'Conjuration', time: 'Action', range: '500 ft', damage: '—', classes: ['Bard', 'Sorcerer', 'Warlock', 'Wizard'], conc: false, ritual: false },
            { name: 'Dominate Beast', level: 4, school: 'Enchantment', time: 'Action', range: '60 ft', damage: '—', classes: ['Druid', 'Sorcerer'], conc: true, ritual: false },
            { name: 'Fire Shield', level: 4, school: 'Evocation', time: 'Action', range: 'Self', damage: '2d8 fire/cold', classes: ['Wizard'], conc: false, ritual: false },
            { name: 'Freedom of Movement', level: 4, school: 'Abjuration', time: 'Action', range: 'Touch', damage: '—', classes: ['Bard', 'Cleric', 'Druid', 'Ranger'], conc: false, ritual: false },
            { name: 'Greater Invisibility', level: 4, school: 'Illusion', time: 'Action', range: 'Touch', damage: '—', classes: ['Bard', 'Sorcerer', 'Wizard'], conc: true, ritual: false },
            { name: 'Guardian of Faith', level: 4, school: 'Conjuration', time: 'Action', range: '30 ft', damage: '20 radiant', classes: ['Cleric'], conc: false, ritual: false },
            { name: 'Ice Storm', level: 4, school: 'Evocation', time: 'Action', range: '300 ft', damage: '2d8 bludgeoning + 4d6 cold', classes: ['Druid', 'Sorcerer', 'Wizard'], conc: false, ritual: false },
            { name: 'Locate Creature', level: 4, school: 'Divination', time: 'Action', range: 'Self', damage: '—', classes: ['Bard', 'Cleric', 'Druid', 'Paladin', 'Ranger', 'Wizard'], conc: true, ritual: false },
            { name: 'Phantasmal Killer', level: 4, school: 'Illusion', time: 'Action', range: '120 ft', damage: '4d10 psychic', classes: ['Wizard'], conc: true, ritual: false },
            { name: 'Polymorph', level: 4, school: 'Transmutation', time: 'Action', range: '60 ft', damage: '—', classes: ['Bard', 'Druid', 'Sorcerer', 'Wizard'], conc: true, ritual: false },
            { name: 'Stoneskin', level: 4, school: 'Abjuration', time: 'Action', range: 'Touch', damage: '—', classes: ['Druid', 'Ranger', 'Sorcerer', 'Wizard'], conc: true, ritual: false },
            { name: 'Wall of Fire', level: 4, school: 'Evocation', time: 'Action', range: '120 ft', damage: '5d8 fire', classes: ['Druid', 'Sorcerer', 'Wizard'], conc: true, ritual: false },

            // === 5TH LEVEL ===
            { name: 'Animate Objects', level: 5, school: 'Transmutation', time: 'Action', range: '120 ft', damage: 'varies', classes: ['Bard', 'Sorcerer', 'Wizard'], conc: true, ritual: false },
            { name: 'Cloudkill', level: 5, school: 'Conjuration', time: 'Action', range: '120 ft', damage: '5d8 poison', classes: ['Sorcerer', 'Wizard'], conc: true, ritual: false },
            { name: 'Commune', level: 5, school: 'Divination', time: '1 Minute', range: 'Self', damage: '—', classes: ['Cleric'], conc: false, ritual: true },
            { name: 'Cone of Cold', level: 5, school: 'Evocation', time: 'Action', range: 'Self (60 ft cone)', damage: '8d8 cold', classes: ['Sorcerer', 'Wizard'], conc: false, ritual: false },
            { name: 'Conjure Elemental', level: 5, school: 'Conjuration', time: '1 Minute', range: '90 ft', damage: '—', classes: ['Druid', 'Wizard'], conc: true, ritual: false },
            { name: 'Dominate Person', level: 5, school: 'Enchantment', time: 'Action', range: '60 ft', damage: '—', classes: ['Bard', 'Sorcerer', 'Wizard'], conc: true, ritual: false },
            { name: 'Dream', level: 5, school: 'Illusion', time: '1 Minute', range: 'Special', damage: '—', classes: ['Bard', 'Warlock', 'Wizard'], conc: false, ritual: false },
            { name: 'Flame Strike', level: 5, school: 'Evocation', time: 'Action', range: '60 ft', damage: '4d6 fire + 4d6 radiant', classes: ['Cleric'], conc: false, ritual: false },
            { name: 'Greater Restoration', level: 5, school: 'Abjuration', time: 'Action', range: 'Touch', damage: '—', classes: ['Bard', 'Cleric', 'Druid'], conc: false, ritual: false },
            { name: 'Hold Monster', level: 5, school: 'Enchantment', time: 'Action', range: '90 ft', damage: '—', classes: ['Bard', 'Sorcerer', 'Warlock', 'Wizard'], conc: true, ritual: false },
            { name: 'Insect Plague', level: 5, school: 'Conjuration', time: 'Action', range: '300 ft', damage: '4d10 piercing', classes: ['Cleric', 'Druid', 'Sorcerer'], conc: true, ritual: false },
            { name: 'Mass Cure Wounds', level: 5, school: 'Evocation', time: 'Action', range: '60 ft', damage: '3d8 healing', classes: ['Bard', 'Cleric', 'Druid'], conc: false, ritual: false },
            { name: 'Raise Dead', level: 5, school: 'Necromancy', time: '1 Hour', range: 'Touch', damage: '—', classes: ['Bard', 'Cleric', 'Paladin'], conc: false, ritual: false },
            { name: 'Scrying', level: 5, school: 'Divination', time: '10 Minutes', range: 'Self', damage: '—', classes: ['Bard', 'Cleric', 'Druid', 'Warlock', 'Wizard'], conc: true, ritual: false },
            { name: 'Telekinesis', level: 5, school: 'Transmutation', time: 'Action', range: '60 ft', damage: '—', classes: ['Sorcerer', 'Wizard'], conc: true, ritual: false },
            { name: 'Wall of Force', level: 5, school: 'Evocation', time: 'Action', range: '120 ft', damage: '—', classes: ['Wizard'], conc: true, ritual: false },
            { name: 'Wall of Stone', level: 5, school: 'Evocation', time: 'Action', range: '120 ft', damage: '—', classes: ['Druid', 'Sorcerer', 'Wizard'], conc: true, ritual: false },

            // === 6TH LEVEL ===
            { name: 'Blade Barrier', level: 6, school: 'Evocation', time: 'Action', range: '90 ft', damage: '6d10 slashing', classes: ['Cleric'], conc: true, ritual: false },
            { name: 'Chain Lightning', level: 6, school: 'Evocation', time: 'Action', range: '150 ft', damage: '10d8 lightning', classes: ['Sorcerer', 'Wizard'], conc: false, ritual: false },
            { name: 'Circle of Death', level: 6, school: 'Necromancy', time: 'Action', range: '150 ft', damage: '8d6 necrotic', classes: ['Sorcerer', 'Warlock', 'Wizard'], conc: false, ritual: false },
            { name: 'Disintegrate', level: 6, school: 'Transmutation', time: 'Action', range: '60 ft', damage: '10d6+40 force', classes: ['Sorcerer', 'Wizard'], conc: false, ritual: false },
            { name: 'Eyebite', level: 6, school: 'Necromancy', time: 'Action', range: 'Self', damage: '—', classes: ['Bard', 'Sorcerer', 'Warlock', 'Wizard'], conc: true, ritual: false },
            { name: 'Heal', level: 6, school: 'Evocation', time: 'Action', range: '60 ft', damage: '70 healing', classes: ['Cleric', 'Druid'], conc: false, ritual: false },
            { name: "Heroes' Feast", level: 6, school: 'Conjuration', time: '10 Minutes', range: '30 ft', damage: '—', classes: ['Cleric', 'Druid'], conc: false, ritual: false },
            { name: 'Mass Suggestion', level: 6, school: 'Enchantment', time: 'Action', range: '60 ft', damage: '—', classes: ['Bard', 'Sorcerer', 'Warlock', 'Wizard'], conc: false, ritual: false },
            { name: 'Sunbeam', level: 6, school: 'Evocation', time: 'Action', range: 'Self (60 ft line)', damage: '6d8 radiant', classes: ['Druid', 'Sorcerer', 'Wizard'], conc: true, ritual: false },
            { name: 'True Seeing', level: 6, school: 'Divination', time: 'Action', range: 'Touch', damage: '—', classes: ['Bard', 'Cleric', 'Sorcerer', 'Warlock', 'Wizard'], conc: false, ritual: false },
            { name: 'Wall of Ice', level: 6, school: 'Evocation', time: 'Action', range: '120 ft', damage: '10d6 cold', classes: ['Wizard'], conc: true, ritual: false },
            { name: 'Word of Recall', level: 6, school: 'Conjuration', time: 'Action', range: '5 ft', damage: '—', classes: ['Cleric'], conc: false, ritual: false },

            // === 7TH LEVEL ===
            { name: 'Conjure Celestial', level: 7, school: 'Conjuration', time: '1 Minute', range: '90 ft', damage: '—', classes: ['Cleric'], conc: true, ritual: false },
            { name: 'Delayed Blast Fireball', level: 7, school: 'Evocation', time: 'Action', range: '150 ft', damage: '12d6 fire', classes: ['Sorcerer', 'Wizard'], conc: true, ritual: false },
            { name: 'Divine Word', level: 7, school: 'Evocation', time: 'Bonus Action', range: '30 ft', damage: 'varies', classes: ['Cleric'], conc: false, ritual: false },
            { name: 'Etherealness', level: 7, school: 'Transmutation', time: 'Action', range: 'Self', damage: '—', classes: ['Bard', 'Cleric', 'Sorcerer', 'Warlock', 'Wizard'], conc: false, ritual: false },
            { name: 'Finger of Death', level: 7, school: 'Necromancy', time: 'Action', range: '60 ft', damage: '7d8+30 necrotic', classes: ['Sorcerer', 'Warlock', 'Wizard'], conc: false, ritual: false },
            { name: 'Fire Storm', level: 7, school: 'Evocation', time: 'Action', range: '150 ft', damage: '7d10 fire', classes: ['Cleric', 'Druid', 'Sorcerer'], conc: false, ritual: false },
            { name: 'Forcecage', level: 7, school: 'Evocation', time: 'Action', range: '100 ft', damage: '—', classes: ['Bard', 'Warlock', 'Wizard'], conc: false, ritual: false },
            { name: 'Plane Shift', level: 7, school: 'Conjuration', time: 'Action', range: 'Touch', damage: '—', classes: ['Cleric', 'Druid', 'Sorcerer', 'Warlock', 'Wizard'], conc: false, ritual: false },
            { name: 'Prismatic Spray', level: 7, school: 'Evocation', time: 'Action', range: 'Self (60 ft cone)', damage: '10d6 varies', classes: ['Sorcerer', 'Wizard'], conc: false, ritual: false },
            { name: 'Regenerate', level: 7, school: 'Transmutation', time: '1 Minute', range: 'Touch', damage: '—', classes: ['Bard', 'Cleric', 'Druid'], conc: false, ritual: false },
            { name: 'Resurrection', level: 7, school: 'Necromancy', time: '1 Hour', range: 'Touch', damage: '—', classes: ['Bard', 'Cleric'], conc: false, ritual: false },
            { name: 'Reverse Gravity', level: 7, school: 'Transmutation', time: 'Action', range: '100 ft', damage: '—', classes: ['Druid', 'Sorcerer', 'Wizard'], conc: true, ritual: false },
            { name: 'Simulacrum', level: 7, school: 'Illusion', time: '12 Hours', range: 'Touch', damage: '—', classes: ['Wizard'], conc: false, ritual: false },
            { name: 'Symbol', level: 7, school: 'Abjuration', time: '1 Minute', range: 'Touch', damage: 'varies', classes: ['Bard', 'Cleric', 'Wizard'], conc: false, ritual: false },
            { name: 'Teleport', level: 7, school: 'Conjuration', time: 'Action', range: '10 ft', damage: '—', classes: ['Bard', 'Sorcerer', 'Wizard'], conc: false, ritual: false },

            // === 8TH LEVEL ===
            { name: 'Antimagic Field', level: 8, school: 'Abjuration', time: 'Action', range: 'Self (10 ft sphere)', damage: '—', classes: ['Cleric', 'Wizard'], conc: true, ritual: false },
            { name: 'Clone', level: 8, school: 'Necromancy', time: '1 Hour', range: 'Touch', damage: '—', classes: ['Wizard'], conc: false, ritual: false },
            { name: 'Control Weather', level: 8, school: 'Transmutation', time: '10 Minutes', range: 'Self (5 mile radius)', damage: '—', classes: ['Cleric', 'Druid', 'Wizard'], conc: true, ritual: false },
            { name: 'Dominate Monster', level: 8, school: 'Enchantment', time: 'Action', range: '60 ft', damage: '—', classes: ['Bard', 'Sorcerer', 'Warlock', 'Wizard'], conc: true, ritual: false },
            { name: 'Earthquake', level: 8, school: 'Evocation', time: 'Action', range: '500 ft', damage: 'varies', classes: ['Cleric', 'Druid', 'Sorcerer'], conc: true, ritual: false },
            { name: 'Feeblemind', level: 8, school: 'Enchantment', time: 'Action', range: '150 ft', damage: '4d6 psychic', classes: ['Bard', 'Druid', 'Warlock', 'Wizard'], conc: false, ritual: false },
            { name: 'Holy Aura', level: 8, school: 'Abjuration', time: 'Action', range: 'Self', damage: '—', classes: ['Cleric'], conc: true, ritual: false },
            { name: 'Incendiary Cloud', level: 8, school: 'Conjuration', time: 'Action', range: '150 ft', damage: '10d8 fire', classes: ['Sorcerer', 'Wizard'], conc: true, ritual: false },
            { name: 'Maze', level: 8, school: 'Conjuration', time: 'Action', range: '60 ft', damage: '—', classes: ['Wizard'], conc: true, ritual: false },
            { name: 'Mind Blank', level: 8, school: 'Abjuration', time: 'Action', range: 'Touch', damage: '—', classes: ['Bard', 'Wizard'], conc: false, ritual: false },
            { name: 'Power Word Stun', level: 8, school: 'Enchantment', time: 'Action', range: '60 ft', damage: '—', classes: ['Bard', 'Sorcerer', 'Warlock', 'Wizard'], conc: false, ritual: false },
            { name: 'Sunburst', level: 8, school: 'Evocation', time: 'Action', range: '150 ft', damage: '12d6 radiant', classes: ['Druid', 'Sorcerer', 'Wizard'], conc: false, ritual: false },

            // === 9TH LEVEL ===
            { name: 'Astral Projection', level: 9, school: 'Necromancy', time: '1 Hour', range: '10 ft', damage: '—', classes: ['Cleric', 'Warlock', 'Wizard'], conc: false, ritual: false },
            { name: 'Foresight', level: 9, school: 'Divination', time: '1 Minute', range: 'Touch', damage: '—', classes: ['Bard', 'Druid', 'Warlock', 'Wizard'], conc: false, ritual: false },
            { name: 'Gate', level: 9, school: 'Conjuration', time: 'Action', range: '60 ft', damage: '—', classes: ['Cleric', 'Sorcerer', 'Wizard'], conc: true, ritual: false },
            { name: 'Mass Heal', level: 9, school: 'Evocation', time: 'Action', range: '60 ft', damage: '700 healing', classes: ['Cleric'], conc: false, ritual: false },
            { name: 'Meteor Swarm', level: 9, school: 'Evocation', time: 'Action', range: '1 mile', damage: '40d6 fire+bludgeoning', classes: ['Sorcerer', 'Wizard'], conc: false, ritual: false },
            { name: 'Power Word Kill', level: 9, school: 'Enchantment', time: 'Action', range: '60 ft', damage: 'death', classes: ['Bard', 'Sorcerer', 'Warlock', 'Wizard'], conc: false, ritual: false },
            { name: 'Prismatic Wall', level: 9, school: 'Abjuration', time: 'Action', range: '60 ft', damage: 'varies', classes: ['Wizard'], conc: false, ritual: false },
            { name: 'Shapechange', level: 9, school: 'Transmutation', time: 'Action', range: 'Self', damage: '—', classes: ['Druid', 'Wizard'], conc: true, ritual: false },
            { name: 'Time Stop', level: 9, school: 'Transmutation', time: 'Action', range: 'Self', damage: '—', classes: ['Sorcerer', 'Wizard'], conc: false, ritual: false },
            { name: 'True Polymorph', level: 9, school: 'Transmutation', time: 'Action', range: '30 ft', damage: '—', classes: ['Bard', 'Warlock', 'Wizard'], conc: true, ritual: false },
            { name: 'True Resurrection', level: 9, school: 'Necromancy', time: '1 Hour', range: 'Touch', damage: '—', classes: ['Cleric', 'Druid'], conc: false, ritual: false },
            { name: 'Wish', level: 9, school: 'Conjuration', time: 'Action', range: 'Self', damage: '—', classes: ['Sorcerer', 'Wizard'], conc: false, ritual: false }
        ];

        // German spell translations - Official from dnddeutsch.de API
        // Only spells found in the official German SRD are translated, others remain in English
        const SPELLS_DE = {
            'Acid Splash': 'Säurespritzer',
            'Aid': 'Beistand',
            'Alarm': 'Alarm',
            'Alter Self': 'Gestalt verändern',
            'Animal Friendship': 'Tierfreundschaft',
            'Animate Dead': 'Tote beleben',
            'Animate Objects': 'Gegenstände beleben',
            'Antimagic Field': 'Antimagisches Feld',
            'Astral Projection': 'Astrale Projektion',
            'Bane': 'Verderben',
            'Banishment': 'Verbannung',
            'Barkskin': 'Rindenhaut',
            'Beacon of Hope': 'Leuchtfeuer der Hoffnung',
            'Bestow Curse': 'Fluch',
            'Blade Barrier': 'Klingenbarriere',
            'Bless': 'Segnen',
            'Blight': 'Dürre',
            'Blindness/Deafness': 'Blindheit/Taubheit',
            'Blink': 'Flimmern',
            'Blur': 'Verschwimmen',
            'Burning Hands': 'Brennende Hände',
            'Call Lightning': 'Blitze herbeirufen',
            'Calm Emotions': 'Gefühle besänftigen',
            'Chain Lightning': 'Kugelblitz',
            'Charm Person': 'Person bezaubern',
            'Chill Touch': 'Kalte Hand',
            'Circle of Death': 'Todeskreis',
            'Clairvoyance': 'Hellsehen',
            'Clone': 'Klon',
            'Cloudkill': 'Todeswolke',
            'Color Spray': 'Sprühende Farben',
            'Command': 'Befehl',
            'Commune': 'Heiliges Gespräch',
            'Comprehend Languages': 'Sprachen verstehen',
            'Cone of Cold': 'Kältekegel',
            'Confusion': 'Verwirrung',
            'Conjure Animals': 'Tiere beschwören',
            'Conjure Celestial': 'Celestische Wesen beschwören',
            'Conjure Elemental': 'Elementar beschwören',
            'Conjure Minor Elementals': 'Schwache Elementare beschwören',
            'Control Water': 'Wasser kontrollieren',
            'Control Weather': 'Wetterkontrolle',
            'Counterspell': 'Gegenzauber',
            'Cure Wounds': 'Wunden heilen',
            'Dancing Lights': 'Tanzende Lichter',
            'Darkness': 'Dunkelheit',
            'Darkvision': 'Dunkelsicht',
            'Daylight': 'Tageslicht',
            'Death Ward': 'Todesschutz',
            'Delayed Blast Fireball': 'Spätzündender Feuerball',
            'Detect Evil and Good': 'Gutes und Böses entdecken',
            'Detect Magic': 'Magie entdecken',
            'Detect Poison and Disease': 'Gift und Krankheit entdecken',
            'Detect Thoughts': 'Gedanken wahrnehmen',
            'Dimension Door': 'Dimensionstür',
            'Disguise Self': 'Selbstverkleidung',
            'Disintegrate': 'Auflösung',
            'Dispel Magic': 'Magie bannen',
            'Divine Favor': 'Göttliche Gunst',
            'Divine Word': 'Göttliches Wort',
            'Dominate Beast': 'Tier beherrschen',
            'Dominate Monster': 'Monster beherrschen',
            'Dominate Person': 'Person beherrschen',
            'Dream': 'Traum',
            'Druidcraft': 'Druidenkunst',
            'Earthquake': 'Erdbeben',
            'Eldritch Blast': 'Schauriger Strahl',
            'Enhance Ability': 'Attribut verbessern',
            'Enlarge/Reduce': 'Vergrössern/Verkleinern',
            'Entangle': 'Verstricken',
            'Etherealness': 'Ätherische Gestalten',
            'Expeditious Retreat': 'Rascher Rückzug',
            'Eyebite': 'Böser Blick',
            'Faerie Fire': 'Feenfeuer',
            'False Life': 'Falsches Leben',
            'Fear': 'Furcht',
            'Feather Fall': 'Federfall',
            'Feeblemind': 'Schwachsinn',
            'Find Familiar': 'Vertrauten finden',
            'Finger of Death': 'Finger des Todes',
            'Fire Bolt': 'Feuerpfeil',
            'Fire Shield': 'Feuerschild',
            'Fire Storm': 'Feuersturm',
            'Fireball': 'Feuerball',
            'Flame Blade': 'Flammenklinge',
            'Flame Strike': 'Flammenschlag',
            'Flaming Sphere': 'Flammenkugel',
            'Fly': 'Fliegen',
            'Fog Cloud': 'Nebelwolke',
            'Forcecage': 'Energiekäfig',
            'Foresight': 'Voraussicht',
            'Freedom of Movement': 'Bewegungsfreiheit',
            'Gaseous Form': 'Gasförmige Gestalt',
            'Gate': 'Tor',
            'Goodberry': 'Gute Beeren',
            'Grease': 'Schmieren',
            'Greater Invisibility': 'Mächtige Unsichtbarkeit',
            'Greater Restoration': 'Vollständige Genesung',
            'Guardian of Faith': 'Hüter des Glaubens',
            'Guidance': 'Göttliche Führung',
            'Guiding Bolt': 'Lenkendes Geschoss',
            'Gust of Wind': 'Windstoss',
            'Haste': 'Hast',
            'Heal': 'Heilung',
            'Healing Word': 'Heilendes Wort',
            'Heat Metal': 'Metall erhitzen',
            'Hellish Rebuke': 'Höllischer Tadel',
            "Heroes' Feast": 'Heldenmahl',
            'Heroism': 'Heldenmut',
            'Hideous Laughter': 'Fürchterlicher Lachanfall',
            'Hold Monster': 'Monster festhalten',
            'Hold Person': 'Person festhalten',
            'Holy Aura': 'Heilige Aura',
            "Hunter's Mark": 'Zeichen des Jägers',
            'Hypnotic Pattern': 'Hypnotisches Muster',
            'Ice Storm': 'Eissturm',
            'Identify': 'Identifizieren',
            'Incendiary Cloud': 'Flammende Wolke',
            'Inflict Wounds': 'Wunden verursachen',
            'Insect Plague': 'Insektenplage',
            'Invisibility': 'Unsichtbarkeit',
            'Jump': 'Springen',
            'Knock': 'Klopfen',
            'Lesser Restoration': 'Schwache Genesung',
            'Levitate': 'Schweben',
            'Light': 'Licht',
            'Lightning Bolt': 'Blitz',
            'Locate Creature': 'Kreatur aufspüren',
            'Longstrider': 'Lange Schritte',
            'Mage Armor': 'Magierrüstung',
            'Mage Hand': 'Magierhand',
            'Magic Circle': 'Schutzkreis',
            'Magic Missile': 'Magisches Geschoss',
            'Magic Weapon': 'Magische Waffe',
            'Major Image': 'Mächtiges Trugbild',
            'Mass Cure Wounds': 'Massen-Wunden Heilen',
            'Mass Heal': 'Massen-Heilung',
            'Mass Healing Word': 'Massen-Heilendes Wort',
            'Mass Suggestion': 'Massen-Einflüsterung',
            'Maze': 'Irrgarten',
            'Mending': 'Ausbessern',
            'Message': 'Botschaft',
            'Meteor Swarm': 'Meteoritenschwarm',
            'Mind Blank': 'Gedankenleere',
            'Minor Illusion': 'Einfache Illusion',
            'Mirror Image': 'Spiegelbilder',
            'Misty Step': 'Nebelschritt',
            'Moonbeam': 'Mondstrahl',
            'Pass without Trace': 'Spurloses gehen',
            'Phantasmal Killer': 'Tödliches Phantom',
            'Plane Shift': 'Ebenenwechsel',
            'Poison Spray': 'Gift versprühen',
            'Polymorph': 'Verwandlung',
            'Power Word Kill': 'Wort der Macht: Tod',
            'Power Word Stun': 'Wort der Macht: Betäubung',
            'Prayer of Healing': 'Gebet der Heilung',
            'Prestidigitation': 'Taschenspielerei',
            'Prismatic Spray': 'Regenbogenspiel',
            'Prismatic Wall': 'Regenbogenwand',
            'Produce Flame': 'Flammen erzeugen',
            'Protection from Energy': 'Schutz vor Energie',
            'Protection from Evil and Good': 'Schutz vor Gut und Böse',
            'Protection from Poison': 'Schutz vor Gift',
            'Raise Dead': 'Tote erwecken',
            'Ray of Frost': 'Kältestrahl',
            'Regenerate': 'Regeneration',
            'Remove Curse': 'Fluch brechen',
            'Resistance': 'Resistenz',
            'Resurrection': 'Auferstehung',
            'Reverse Gravity': 'Schwerkraft umkehren',
            'Revivify': 'Wiederbeleben',
            'Sacred Flame': 'Heilige Flamme',
            'Sanctuary': 'Heiligtum',
            'Scorching Ray': 'Sengender Strahl',
            'Scrying': 'Ausspähung',
            'See Invisibility': 'Unsichtbares Sehen',
            'Sending': 'Verständigung',
            'Shapechange': 'Gestaltwandel',
            'Shatter': 'Zerbersten',
            'Shield': 'Schild',
            'Shield of Faith': 'Schild des Glaubens',
            'Shillelagh': 'Shillelagh',
            'Shocking Grasp': 'Schockgriff',
            'Silence': 'Stille',
            'Silent Image': 'Lautloses Trugbild',
            'Simulacrum': 'Simulakrum',
            'Sleep': 'Schlaf',
            'Slow': 'Verlangsamen',
            'Spare the Dying': 'Verschonung der Toten',
            'Speak with Animals': 'Mit Tieren sprechen',
            'Speak with Dead': 'Mit Toten sprechen',
            'Spider Climb': 'Spinnenklettern',
            'Spike Growth': 'Dornenwuchs',
            'Spirit Guardians': 'Schutzgeister',
            'Spiritual Weapon': 'Waffe des Glaubens',
            'Stinking Cloud': 'Stinkende Wolke',
            'Stoneskin': 'Steinhaut',
            'Suggestion': 'Einflüsterung',
            'Sunbeam': 'Sonnenstrahl',
            'Sunburst': 'Sonnenfeuer',
            'Symbol': 'Symbol',
            'Telekinesis': 'Telekinese',
            'Teleport': 'Teleportieren',
            'Thaumaturgy': 'Thaumaturgie',
            'Thunderwave': 'Donnerwoge',
            'Time Stop': 'Zeitstop',
            'Tongues': 'Zungen',
            'True Polymorph': 'Wahre Verwandlung',
            'True Resurrection': 'Wahre Auferstehung',
            'True Seeing': 'Wahrer Blick',
            'True Strike': 'Zielsicherer Schlag',
            'Unseen Servant': 'Unsichtbarer Diener',
            'Vampiric Touch': 'Vampirgriff',
            'Vicious Mockery': 'Gehässiger Spott',
            'Wall of Fire': 'Feuerwand',
            'Wall of Force': 'Energiewand',
            'Wall of Ice': 'Eiswand',
            'Wall of Stone': 'Steinwand',
            'Water Breathing': 'Wasser atmen',
            'Water Walk': 'Auf Wasser gehen',
            'Web': 'Spinnennetz',
            'Wish': 'Wunsch',
            'Word of Recall': 'Rückruf',
            'Zone of Truth': 'Zone der Wahrheit'
        };

        // Update openCantripPicker to open full spell picker
        function openCantripPicker() {
            openSpellPicker();
        }

        // Picker state
        let currentPickerType = 'weapon';
        let currentPickerFilter = 'all';
        let currentLevelFilter = 'all';

        function openWeaponPicker() {
            currentPickerType = 'weapon';
            currentPickerFilter = 'all';
            const lang = getLang();
            document.getElementById('pickerTitle').textContent = lang === 'de' ? '⚔️ Waffe wählen' : '⚔️ Select Weapon';
            document.getElementById('pickerSearch').value = '';
            document.getElementById('pickerSearch').placeholder = lang === 'de' ? 'Suchen...' : 'Search...';
            
            // Build filters
            const filters = ['all', 'Simple Melee', 'Simple Ranged', 'Martial Melee', 'Martial Ranged'];
            const filterLabels = lang === 'de' 
                ? ['Alle', 'Einfach Nahkampf', 'Einfach Fernkampf', 'Kriegswaffe Nahkampf', 'Kriegswaffe Fernkampf']
                : filters;
            
            document.getElementById('pickerFilters').innerHTML = filters.map((f, i) => 
                `<button class="picker-filter-btn ${f === 'all' ? 'active' : ''}" onclick="setPickerFilter('${f}')">${filterLabels[i]}</button>`
            ).join('');
            
            renderPickerItems();
            document.getElementById('pickerModal').classList.add('active');
        }

        function openSpellPicker() {
            currentPickerType = 'spell';
            currentPickerFilter = 'all';
            currentLevelFilter = 'all';
            const lang = getLang();
            document.getElementById('pickerTitle').textContent = lang === 'de' ? '✨ Zauber wählen (Grad 1-9)' : '✨ Select Spell (Level 1-9)';
            document.getElementById('pickerSearch').value = '';
            document.getElementById('pickerSearch').placeholder = lang === 'de' ? 'Name, Schule, Klasse...' : 'Name, school, class...';
            
            // Build level + class filters (1-9 only, no cantrips)
            const levels = ['all', '1', '2', '3', '4', '5', '6', '7', '8', '9'];
            const levelLabels = lang === 'de'
                ? ['Alle', '1.', '2.', '3.', '4.', '5.', '6.', '7.', '8.', '9.']
                : ['All', '1st', '2nd', '3rd', '4th', '5th', '6th', '7th', '8th', '9th'];
            
            const classes = ['all', 'Bard', 'Cleric', 'Druid', 'Paladin', 'Ranger', 'Sorcerer', 'Warlock', 'Wizard'];
            const classLabels = lang === 'de'
                ? ['Alle', 'Barde', 'Kleriker', 'Druide', 'Paladin', 'Waldläufer', 'Zauberer', 'Hexenmeister', 'Magier']
                : classes;
            
            document.getElementById('pickerFilters').innerHTML = `
                <div style="display:flex;gap:6px;flex-wrap:wrap;margin-bottom:8px;">
                    ${levels.map((l, i) => 
                        `<button class="picker-filter-btn level-filter ${l === 'all' ? 'active' : ''}" onclick="setLevelFilter('${l}')">${levelLabels[i]}</button>`
                    ).join('')}
                </div>
                <div style="display:flex;gap:6px;flex-wrap:wrap;">
                    ${classes.map((c, i) => 
                        `<button class="picker-filter-btn class-filter ${c === 'all' ? 'active' : ''}" onclick="setPickerFilter('${c}')">${classLabels[i]}</button>`
                    ).join('')}
                </div>
            `;
            
            renderPickerItems();
            document.getElementById('pickerModal').classList.add('active');
        }

        function openCantripPicker() {
            currentPickerType = 'cantrip';
            currentPickerFilter = 'all';
            currentLevelFilter = '0';
            const lang = getLang();
            document.getElementById('pickerTitle').textContent = lang === 'de' ? '✨ Zaubertrick wählen' : '✨ Select Cantrip';
            document.getElementById('pickerSearch').value = '';
            document.getElementById('pickerSearch').placeholder = lang === 'de' ? 'Name, Schule, Klasse...' : 'Name, school, class...';
            
            // Class filters only for cantrips
            const classes = ['all', 'Bard', 'Cleric', 'Druid', 'Sorcerer', 'Warlock', 'Wizard'];
            const classLabels = lang === 'de'
                ? ['Alle', 'Barde', 'Kleriker', 'Druide', 'Zauberer', 'Hexenmeister', 'Magier']
                : classes;
            
            document.getElementById('pickerFilters').innerHTML = classes.map((c, i) => 
                `<button class="picker-filter-btn class-filter ${c === 'all' ? 'active' : ''}" onclick="setPickerFilter('${c}')">${classLabels[i]}</button>`
            ).join('');
            
            renderPickerItems();
            document.getElementById('pickerModal').classList.add('active');
        }

        function closePickerModal() {
            document.getElementById('pickerModal').classList.remove('active');
        }

        function setPickerFilter(filter) {
            currentPickerFilter = filter;
            // Remove active from correct button type
            if (currentPickerType === 'spell') {
                document.querySelectorAll('.picker-filter-btn.class-filter').forEach(btn => btn.classList.remove('active'));
            } else {
                document.querySelectorAll('.picker-filter-btn:not(.level-filter)').forEach(btn => btn.classList.remove('active'));
            }
            event.target.classList.add('active');
            renderPickerItems();
        }

        function setLevelFilter(level) {
            currentLevelFilter = level;
            document.querySelectorAll('.picker-filter-btn.level-filter').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
            renderPickerItems();
        }

        function filterPickerItems() {
            renderPickerItems();
        }

        function renderPickerItems() {
            const searchTerm = document.getElementById('pickerSearch').value.toLowerCase();
            const lang = getLang();
            const list = document.getElementById('pickerList');
            
            // Helper to get SVG icon with color
            const getIcon = (iconName, color = 'currentColor') => {
                const icon = ICONS[iconName] || ICONS.sword;
                return `<span class="picker-svg-icon" style="color:${color}">${icon}</span>`;
            };
            
            // Helper to get damage type color
            const getDamageColor = (type) => DAMAGE_COLORS[type] || DAMAGE_COLORS.special;
            
            // School icons mapping to SVG
            const schoolIconMap = {
                'Evocation': 'evocation', 'Necromancy': 'necromancy', 'Conjuration': 'conjuration',
                'Abjuration': 'abjuration', 'Transmutation': 'transmutation', 'Divination': 'divination',
                'Enchantment': 'enchantment', 'Illusion': 'illusion'
            };
            
            // School colors
            const schoolColors = {
                'Evocation': '#ff6b35', 'Necromancy': '#424242', 'Conjuration': '#4fc3f7',
                'Abjuration': '#ffd54f', 'Transmutation': '#8bc34a', 'Divination': '#7e57c2',
                'Enchantment': '#e91e63', 'Illusion': '#9c27b0'
            };
            
            if (currentPickerType === 'weapon') {
                let weapons = SRD_WEAPONS;
                
                // Filter by category
                if (currentPickerFilter !== 'all') {
                    weapons = weapons.filter(w => w.category === currentPickerFilter);
                }
                
                // Filter by search
                if (searchTerm) {
                    weapons = weapons.filter(w => {
                        const name = lang === 'de' ? (WEAPONS_DE[w.name] || w.name) : w.name;
                        return name.toLowerCase().includes(searchTerm) || 
                               w.type.toLowerCase().includes(searchTerm) ||
                               w.properties.some(p => p.toLowerCase().includes(searchTerm));
                    });
                }
                
                // Group by category
                const groups = {};
                weapons.forEach(w => {
                    if (!groups[w.category]) groups[w.category] = [];
                    groups[w.category].push(w);
                });
                
                const categoryLabels = lang === 'de' ? {
                    'Simple Melee': 'Einfache Nahkampfwaffen',
                    'Simple Ranged': 'Einfache Fernkampfwaffen',
                    'Martial Melee': 'Kriegswaffen Nahkampf',
                    'Martial Ranged': 'Kriegswaffen Fernkampf'
                } : {};
                
                list.innerHTML = Object.keys(groups).map(cat => `
                    <div class="picker-category">${categoryLabels[cat] || cat} (${groups[cat].length})</div>
                    ${groups[cat].map(w => {
                        const name = lang === 'de' ? (WEAPONS_DE[w.name] || w.name) : w.name;
                        const props = w.properties.slice(0, 2).join(', ');
                        const dmgColor = getDamageColor(w.type);
                        return `
                            <div class="picker-item" onclick="selectWeapon('${w.name}')">
                                ${getIcon(w.icon, dmgColor)}
                                <div class="picker-item-info">
                                    <div class="picker-item-name">${name}</div>
                                    <div class="picker-item-details">${props || '—'}</div>
                                </div>
                                <div class="picker-item-tags">
                                    <span class="picker-tag damage" style="background:${dmgColor}">${w.damage}</span>
                                    <span class="picker-tag type" style="border-color:${dmgColor};color:${dmgColor}">${w.type}</span>
                                </div>
                            </div>
                        `;
                    }).join('')}
                `).join('');
            } else {
                // Spells (cantrip picker shows only level 0, spell picker shows level 1-9)
                let spells = SRD_SPELLS;
                
                // Filter by level based on picker type
                if (currentPickerType === 'cantrip') {
                    // Cantrip picker: ONLY level 0
                    spells = spells.filter(s => s.level === 0);
                } else {
                    // Spell picker: levels 1-9 (exclude cantrips)
                    spells = spells.filter(s => s.level > 0);
                    
                    // Further filter by specific level if selected
                    if (currentLevelFilter !== 'all') {
                        const lvl = parseInt(currentLevelFilter);
                        spells = spells.filter(s => s.level === lvl);
                    }
                }
                
                // Filter by class
                if (currentPickerFilter !== 'all') {
                    spells = spells.filter(s => s.classes.includes(currentPickerFilter));
                }
                
                // Filter by search
                if (searchTerm) {
                    spells = spells.filter(s => {
                        const name = lang === 'de' ? (SPELLS_DE[s.name] || s.name) : s.name;
                        return name.toLowerCase().includes(searchTerm) || 
                               s.school.toLowerCase().includes(searchTerm) ||
                               s.classes.some(c => c.toLowerCase().includes(searchTerm));
                    });
                }
                
                // Group by level
                const groups = {};
                spells.forEach(s => {
                    const levelName = s.level === 0 ? 'Cantrips' : `Level ${s.level}`;
                    if (!groups[levelName]) groups[levelName] = [];
                    groups[levelName].push(s);
                });
                
                // Sort level groups
                const sortedGroups = Object.keys(groups).sort((a, b) => {
                    if (a === 'Cantrips') return -1;
                    if (b === 'Cantrips') return 1;
                    return parseInt(a.replace('Level ', '')) - parseInt(b.replace('Level ', ''));
                });
                
                const levelLabels = lang === 'de' ? {
                    'Cantrips': 'Zaubertricks (Grad 0)',
                    'Level 1': 'Grad 1', 'Level 2': 'Grad 2', 'Level 3': 'Grad 3',
                    'Level 4': 'Grad 4', 'Level 5': 'Grad 5', 'Level 6': 'Grad 6',
                    'Level 7': 'Grad 7', 'Level 8': 'Grad 8', 'Level 9': 'Grad 9'
                } : {};
                
                // Extract damage type from damage string
                const extractDamageType = (dmg) => {
                    if (!dmg || dmg === '—') return null;
                    const types = ['fire', 'cold', 'lightning', 'thunder', 'acid', 'poison', 'necrotic', 'radiant', 'force', 'psychic', 'bludgeoning', 'piercing', 'slashing', 'healing'];
                    for (const t of types) {
                        if (dmg.toLowerCase().includes(t)) return t;
                    }
                    return null;
                };
                
                list.innerHTML = sortedGroups.map(lvl => `
                    <div class="picker-category">${levelLabels[lvl] || lvl} (${groups[lvl].length})</div>
                    ${groups[lvl].map(s => {
                        const name = lang === 'de' ? (SPELLS_DE[s.name] || s.name) : s.name;
                        const tags = [];
                        if (s.conc) tags.push('<span class="picker-tag conc">C</span>');
                        if (s.ritual) tags.push('<span class="picker-tag ritual">R</span>');
                        // Use selectCantrip for cantrips, selectSpell for spells
                        const selectFn = s.level === 0 ? 'selectCantrip' : 'selectSpell';
                        const schoolColor = schoolColors[s.school] || '#888';
                        const dmgType = extractDamageType(s.damage);
                        const dmgColor = dmgType ? getDamageColor(dmgType) : schoolColor;
                        return `
                            <div class="picker-item" onclick="${selectFn}('${s.name.replace(/'/g, "\\'")}')">
                                ${getIcon(schoolIconMap[s.school] || 'conjuration', schoolColor)}
                                <div class="picker-item-info">
                                    <div class="picker-item-name">${name}</div>
                                    <div class="picker-item-details">${s.range} • ${s.time}</div>
                                </div>
                                <div class="picker-item-tags">
                                    ${s.damage !== '—' ? `<span class="picker-tag damage" style="background:${dmgColor}">${s.damage}</span>` : ''}
                                    <span class="picker-tag school" style="border-color:${schoolColor};color:${schoolColor}">${s.school}</span>
                                    ${tags.join('')}
                                </div>
                            </div>
                        `;
                    }).join('')}
                `).join('');
            }
        }

        function selectWeapon(weaponName) {
            const weapon = SRD_WEAPONS.find(w => w.name === weaponName);
            if (!weapon) return;
            
            const lang = getLang();
            const name = lang === 'de' ? (WEAPONS_DE[weapon.name] || weapon.name) : weapon.name;
            
            // Calculate attack bonus based on weapon type
            let atkBonus = '+0';
            const isFinesse = weapon.properties.some(p => p.includes('Finesse'));
            const isRanged = weapon.category.includes('Ranged');
            
            // Get relevant modifier
            const strMod = parseInt(document.getElementById('strMod')?.textContent) || 0;
            const dexMod = parseInt(document.getElementById('dexMod')?.textContent) || 0;
            const profBonus = parseInt(document.getElementById('profBonus')?.textContent) || 2;
            
            let abilityMod = isRanged ? dexMod : strMod;
            if (isFinesse) abilityMod = Math.max(strMod, dexMod);
            
            const totalAtk = abilityMod + profBonus;
            atkBonus = totalAtk >= 0 ? `+${totalAtk}` : `${totalAtk}`;
            
            // Calculate damage
            const dmgMod = abilityMod >= 0 ? `+${abilityMod}` : `${abilityMod}`;
            const damage = `${weapon.damage}${dmgMod} ${weapon.type}`;
            
            // Build notes from properties
            const notes = weapon.properties.join(', ');
            
            // Add to weapons list
            char.weapons.push({
                name: name,
                bonus: atkBonus,
                damage: damage,
                notes: notes
            });
            
            renderWeapons();
            autoSave();
            closePickerModal();
        }

        function selectSpell(spellName) {
            const spell = SRD_SPELLS.find(s => s.name === spellName);
            if (!spell || spell.level === 0) return; // Cantrips go elsewhere
            
            const lang = getLang();
            const name = lang === 'de' ? (SPELLS_DE[spell.name] || spell.name) : spell.name;
            
            // Determine attack vs save spell
            const isAttack = isSpellAttack(spell);
            const isSave = isSpellSave(spell);
            
            // Parse components from spell data
            const hasVerbal = !spell.components || spell.components.includes('V');
            const hasSomatic = !spell.components || spell.components.includes('S');
            const hasMaterial = spell.components && spell.components.includes('M');
            
            // SPELLS (Level 1-9) → Spell Slots section
            char.spells.push({
                name: name,
                srdName: spell.name, // Keep original name for SRD lookup
                level: spell.level.toString(),
                time: spell.time,
                conc: spell.conc,
                concentrating: false,
                ritual: spell.ritual,
                verbal: hasVerbal,
                somatic: hasSomatic,
                mat: hasMaterial,
                damage: spell.damage !== '—' ? spell.damage : '',
                damageType: spell.damageType || '',
                range: spell.range,
                school: spell.school,
                attack: isAttack,
                save: isSave,
                saveType: isSave ? guessSaveType(spell.name) : '',
                category: '', // Will be auto-determined by determineSpellCategory
                notes: `${spell.range}${spell.damage !== '—' ? ' • ' + spell.damage : ''}`
            });
            
            renderSpells();
            autoSave();
            closePickerModal();
        }

        function selectCantrip(spellName) {
            const spell = SRD_SPELLS.find(s => s.name === spellName);
            if (!spell || spell.level !== 0) return; // Only cantrips here
            
            const lang = getLang();
            const name = lang === 'de' ? (SPELLS_DE[spell.name] || spell.name) : spell.name;
            
            // Get spell attack/DC
            const spellAtk = document.getElementById('spellAttack')?.textContent || '+0';
            const spellDC = document.getElementById('spellDC')?.textContent || '10';
            
            // Determine if it's attack or save based on damage
            const hasDamage = spell.damage !== '—';
            const atkOrDC = hasDamage ? spellAtk : `DC ${spellDC}`;
            
            // CANTRIPS (Level 0) → Weapons & Cantrips section
            char.weapons.push({
                name: `✨ ${name}`,
                srdName: spell.name, // Keep original for SRD lookup
                bonus: atkOrDC,
                damage: spell.damage,
                notes: `${spell.range} • ${spell.school}${spell.conc ? ' • C' : ''}`,
                isCantrip: true
            });
            
            renderWeapons();
            autoSave();
            closePickerModal();
        }

        // Skill to Ability mapping (must be defined before initialization calls)
        const SKILL_ABILITY = {
            athletics: 'str',
            acrobatics: 'dex', sleight: 'dex', stealth: 'dex',
            arcana: 'int', history: 'int', investigation: 'int', nature: 'int', religion: 'int',
            animal: 'wis', insight: 'wis', medicine: 'wis', perception: 'wis', survival: 'wis',
            deception: 'cha', intimidation: 'cha', performance: 'cha', persuasion: 'cha'
        };

        // V2 Layout Initialization
        if (typeof initLayout === 'function') {
            initLayout();
        }
        
        buildAbilitiesGrid();
        initDeathSaves();
        initSpellSlots();
        initAttunement();
        loadCharFromStorage(); // V2: Use CharacterStorage with URL params
        initModifiers();
        updateProfBonus();
        updateSpellStats();
        initSkillExpertise();
        updateAllSkillBonuses();
        updateAllSaveBonuses();
        updateInitiative();
        updatePassiveScores();
        updatePactSlotsVisibility(document.getElementById('charClass')?.value || '');
        translateUI();
        buildQuickReference();
        
        // Initialize veteran features
        renderConditions();
        updateConditionsUI();
        renderMulticlass();
        updateConcentrationBanner();

        // Build Quick Reference with translations
        function buildQuickReference() {
            const grid = document.getElementById('quickRefGrid');
            const lang = getLang();
            
            grid.innerHTML = `
                <div class="ref-card">
                    <div class="ref-title">${term('Ability Modifier')}</div>
                    <div class="ref-formula">(${term('Ability Score')} − 10) ÷ 2</div>
                    <div class="ref-table">
                        <span>8-9: −1</span>
                        <span>10-11: +0</span>
                        <span>12-13: +1</span>
                        <span>14-15: +2</span>
                        <span>16-17: +3</span>
                        <span>18-19: +4</span>
                        <span>20: +5</span>
                    </div>
                </div>
                <div class="ref-card">
                    <div class="ref-title">${term('Proficiency Bonus')}</div>
                    <div class="ref-formula">${lang === 'de' ? 'Nach' : 'Based on'} ${term('Level')}</div>
                    <div class="ref-table">
                        <span>${term('Level')} 1-4: +2</span>
                        <span>${term('Level')} 5-8: +3</span>
                        <span>${term('Level')} 9-12: +4</span>
                        <span>${term('Level')} 13-16: +5</span>
                        <span>${term('Level')} 17-20: +6</span>
                    </div>
                </div>
                <div class="ref-card">
                    <div class="ref-title">${lang === 'de' ? 'Formeln' : 'Common Formulas'}</div>
                    <div class="ref-list">
                        <div><span class="ref-label">${term('Saving Throw')}/Skill:</span> Mod + Prof</div>
                        <div><span class="ref-label">${term('Initiative')}:</span> ${term('DEX')} Mod</div>
                        <div><span class="ref-label">${term('Passive Perception')}:</span> 10 + ${term('WIS')} Mod + Prof</div>
                        <div><span class="ref-label">${term('Spell Save DC')}:</span> 8 + Prof + Mod</div>
                        <div><span class="ref-label">${term('Spell Attack')}:</span> Prof + Mod</div>
                        <div><span class="ref-label">${term('Weapon')} Atk:</span> ${term('STR')}/${term('DEX')} Mod + Prof</div>
                    </div>
                </div>
                <div class="ref-card">
                    <div class="ref-title">${term('Hit Dice')} ${lang === 'de' ? 'nach' : 'by'} ${term('Class')}</div>
                    <div class="ref-list">
                        <div><span class="ref-label">d12:</span> Barbarian</div>
                        <div><span class="ref-label">d10:</span> Fighter, Paladin, Ranger</div>
                        <div><span class="ref-label">d8:</span> Bard, Cleric, Druid, Monk, Rogue, Warlock</div>
                        <div><span class="ref-label">d6:</span> Sorcerer, Wizard</div>
                    </div>
                </div>
            `;
        }

        // Translate all static UI labels based on language
        function translateUI() {
            const lang = getLang();
            if (lang !== 'de') return; // Only translate if German

            // Meta Chip Labels (Header)
            document.querySelectorAll('.meta-chip label').forEach(el => {
                const text = el.textContent.trim();
                const labels = {
                    'Species': term('Species'), // UI label
                    'Class': term('Class'),
                    'Level': term('Level'),
                    'Background': term('Background'),
                    'Subclass': term('Subclass')
                };
                if (labels[text]) el.textContent = labels[text];
            });

            // Dropdown Placeholders
            document.querySelectorAll('.meta-chip select option').forEach(el => {
                if (el.textContent === 'Select') el.textContent = term('Select');
            });

            // Section Headers
            document.querySelectorAll('.section-title').forEach(el => {
                const text = el.textContent.trim();
                // Map section titles
                const titles = {
                    'Your Character': term('Your Character'),
                    'Armor & Hit Points': term('Armor & Hit Points'),
                    'Abilities & Skills': term('Abilities & Skills'),
                    'Combat': term('Combat'),
                    'Weapons & Cantrips': term('Weapons & Cantrips'),
                    'Class Features': term('Class Features'),
                    'Training & Proficiencies': term('Training & Proficiencies'),
                    'Species Traits & Feats': term('Species Traits') + ' & ' + term('Feats'),
                    'Spellcasting': term('Spellcasting'),
                    'Equipment & Notes': term('Equipment & Notes'),
                    'Quick Reference': term('Quick Reference'),
                    'Manage Sheet': term('Manage Sheet'),
                    'Rules Compatibility & Licensing': term('Rules Compatibility & Licensing')
                };
                if (titles[text]) {
                    // Keep the SVG, replace text
                    const svg = el.querySelector('svg');
                    if (svg) {
                        el.innerHTML = '';
                        el.appendChild(svg);
                        el.appendChild(document.createTextNode(titles[text]));
                    }
                }
            });

            // Stats Row Labels
            const statLabels = {
                'Heroic Insp.': term('Heroic Insp.'),
                'Prof. Bonus': term('Prof. Bonus'),
                'Initiative': term('Initiative'),
                'Speed': term('Speed'),
                'Size': term('Size'),
                'Passive Perc.': term('Passive Perc.'),
                'Passive Inv.': term('Passive Inv.'),
                'Passive Ins.': term('Passive Ins.')
            };
            document.querySelectorAll('.stat-label').forEach(el => {
                const text = el.textContent.trim();
                if (statLabels[text]) el.textContent = statLabels[text];
            });

            // Stat Hints
            const statHints = {
                'by Level': term('by Level'),
                'DEX': term('DEX'),
                'Species': term('Species'), // UI label
                'from Level': 'nach Stufe',
                'DEX Mod': term('DEX') + ' Mod',
                'Ability Modifier': term('Ability Modifier'),
                '10 + WIS + Prof': '10 + ' + term('WIS') + ' + Übung',
                '10 + INT + Prof': '10 + ' + term('INT') + ' + Übung',
                '10 + WIS': '10 + ' + term('WIS')
            };
            document.querySelectorAll('.stat-hint').forEach(el => {
                const text = el.textContent.trim();
                if (statHints[text]) el.textContent = statHints[text];
            });

            // Armor Stat Hints
            document.querySelectorAll('.armor-stat-hint').forEach(el => {
                const text = el.textContent.trim();
                if (text === '−2 per level') el.textContent = '−2 per level';
            });

            // Combat Labels - AC and Shield
            document.querySelectorAll('.ac-shield-label').forEach(el => {
                if (el.textContent.trim() === 'Armor Class') el.textContent = term('Armor Class');
            });
            document.querySelectorAll('.ac-shield-sub-label').forEach(el => {
                if (el.textContent.trim() === 'Shield') el.textContent = term('Shield');
            });

            // Armor Stat Labels (HP section)
            document.querySelectorAll('.armor-stat-label').forEach(el => {
                const text = el.textContent.trim();
                const labels = {
                    'Current HP': term('Current') + ' ' + term('HP'),
                    'Maximum HP': term('Maximum') + ' ' + term('HP'),
                    'Temp HP': term('Temp') + ' ' + term('HP'),
                    'Hit Dice': term('Hit Dice'),
                    'Death Saves': term('Death Saves'),
                    'Exhaustion': term('Exhaustion')
                };
                if (labels[text]) el.textContent = labels[text];
            });

            // HP Labels
            document.querySelectorAll('.hp-label').forEach(el => {
                const text = el.textContent.trim();
                if (text === 'Current') el.textContent = term('Current');
                if (text === 'Maximum') el.textContent = term('Maximum');
                if (text === 'Temp') el.textContent = term('Temp');
            });

            // Mini Labels
            document.querySelectorAll('.mini-label').forEach(el => {
                const text = el.textContent.trim();
                if (text === 'Hit Dice') el.textContent = term('Hit Dice');
                if (text === 'Death Saves') el.textContent = term('Death Saves');
                if (text === 'Exhaustion') el.textContent = term('Exhaustion');
            });

            // Defense Labels
            document.querySelectorAll('.defense-label').forEach(el => {
                const text = el.textContent.trim();
                if (text === 'Resistances') el.textContent = term('Resistances');
                if (text === 'Immunities') el.textContent = term('Immunities');
                if (text === 'Vulnerabilities') el.textContent = term('Vulnerabilities');
            });

            // Death Labels
            document.querySelectorAll('.death-label').forEach(el => {
                const text = el.textContent.trim();
                if (text === 'Successes') el.textContent = term('Successes');
                if (text === 'Failures') el.textContent = term('Failures');
            });

            // Spell Stats
            document.querySelectorAll('.spell-stat-label').forEach(el => {
                const text = el.textContent.trim();
                if (text === 'Spellcasting Ability') el.textContent = term('Spellcasting Ability');
                if (text === 'Spellcasting Modifier') el.textContent = term('Spellcasting Modifier');
                if (text === 'Spell Save DC') el.textContent = term('Spell Save DC');
                if (text === 'Spell Attack') el.textContent = term('Spell Attack');
            });

            // Spell Ability Select
            const spellAbilitySelect = document.getElementById('spellAbility');
            if (spellAbilitySelect) {
                spellAbilitySelect.querySelectorAll('option').forEach(opt => {
                    if (opt.value === '' && opt.textContent === 'Select') {
                        opt.textContent = term('Select');
                    }
                });
            }

            // Field Labels
            document.querySelectorAll('.field-label').forEach(el => {
                const text = el.textContent.trim();
                const labels = {
                    'Tools & Other Training': 'Werkzeuge & Weitere Fertigkeiten',
                    'Weapons': term('Weapons'),
                    'Senses': term('Senses'),
                    'Species Traits': term('Species Traits'),
                    'Feats': term('Feats'),
                    'Class Resources': term('Class Resources'),
                    'Pact Slots (Warlock)': term('Pact Slots (Warlock)'),
                    'Physical Traits': term('Physical Traits'),
                    'Spell Slots': term('Spell Slots'),
                    'Prepared Spells': term('Prepared Spells'),
                    'Languages': term('Languages'),
                    'Equipment': term('Equipment'),
                    'Magic Item Attunement (0-3)': term('Magic Item') + ' ' + term('Attunement') + ' (0-3)',
                    'Alignment': term('Alignment'),
                    'Appearance': term('Appearance'),
                    'Backstory & Personality': term('Backstory') + ' & ' + term('Personality'),
                    'Coins': term('Coins')
                };
                if (labels[text]) el.textContent = labels[text];
            });

            // Training Labels
            document.querySelectorAll('.training-label').forEach(el => {
                const text = el.textContent.trim();
                if (text === 'Armor') el.textContent = term('Armor');
                if (text === 'Weapons') el.textContent = term('Weapons');
            });

            // Pact Labels (Warlock)
            document.querySelectorAll('.pact-label').forEach(el => {
                const text = el.textContent.trim();
                if (text === 'Slot Level') el.textContent = term('Slot Level');
                if (text === 'Total') el.textContent = term('Total');
                if (text === 'Expended') el.textContent = term('Expended');
            });

            // Pact Hint
            document.querySelectorAll('.pact-hint').forEach(el => {
                if (el.textContent.includes('Short Rest Recovery')) {
                    el.textContent = term('Short Rest Recovery') + ' • Zaubergrad = Zauberplatz-Stufe beim Wirken';
                }
            });

            // Training Item Checkboxes (Light, Medium, Heavy, etc.)
            document.querySelectorAll('.training-item').forEach(el => {
                const checkbox = el.querySelector('input[type="checkbox"]');
                if (checkbox) {
                    const textNode = Array.from(el.childNodes).find(n => n.nodeType === Node.TEXT_NODE);
                    if (textNode) {
                        const text = textNode.textContent.trim();
                        if (SRD_TERMS_DE[text]) {
                            textNode.textContent = term(text);
                        }
                    }
                }
            });

            // Coin Labels
            document.querySelectorAll('.coin-label').forEach(el => {
                const text = el.textContent.trim();
                if (SRD_TERMS_DE[text]) el.textContent = term(text);
            });

            // Add Buttons
            document.querySelectorAll('.add-btn').forEach(el => {
                const text = el.textContent.trim();
                if (text.includes('Weapon') && lang === 'de') {
                    el.textContent = '+ ' + term('Weapon') + ' / ' + term('Cantrip') + ' hinzufügen';
                }
                if (text.includes('Resource') && lang === 'de') {
                    el.textContent = '+ Ressource hinzufügen';
                }
                if (text.includes('Spell') && !text.includes('Weapon') && lang === 'de') {
                    el.textContent = '+ ' + term('Spell') + ' hinzufügen';
                }
            });

            // Rules Notice Content
            const rulesNotice = document.getElementById('rulesNoticeContent');
            if (rulesNotice) {
                if (lang === 'de') {
                    rulesNotice.innerHTML = `
                        <p><strong>Hinweis zur Regelkompatibilität und Lizenzierung</strong></p>
                        <p>Dieser Charakterbogen verwendet Spielmechaniken, Regelbegriffe und weitere Inhalte aus dem Systemreferenzdokument 5.2.1 (SRD), das von Wizards of the Coast LLC veröffentlicht und unter der Creative Commons Namensnennung 4.0 International Lizenz (CC-BY-4.0) zur Verfügung gestellt wird.</p>
                        <p>Das Systemreferenzdokument wurde von Wizards of the Coast unter einer offenen Lizenz veröffentlicht, um die Nutzung, Anpassung und Weiterverbreitung der darin enthaltenen Inhalte zu ermöglichen, sofern eine ordnungsgemäße Namensnennung erfolgt. Diese Anwendung erfüllt die Anforderungen der Creative-Commons-Lizenz CC-BY-4.0.</p>
                        <p>Dungeons & Dragons, D&D sowie alle damit verbundenen Marken, Produktnamen und Kennzeichen sind Marken oder eingetragene Marken der Wizards of the Coast LLC.</p>
                        <p>RIFT ist ein unabhängiges Projekt und steht in keiner Verbindung zu Wizards of the Coast LLC. RIFT wird weder von Wizards of the Coast unterstützt, empfohlen, gesponsert noch genehmigt. Die Verwendung von Inhalten aus dem Systemreferenzdokument begründet keinerlei Partnerschaft, Zusammenarbeit oder offiziellen Status.</p>
                        <p>Inhalte, die nicht ausdrücklich aus dem Systemreferenzdokument stammen, verbleiben im geistigen Eigentum ihrer jeweiligen Urheberinnen und Urheber.</p>
                        <hr style="border:none;border-top:1px solid var(--md-outline-variant);margin:16px 0;">
                        <p><strong>Hinweis zur Terminologie</strong></p>
                        <p>Bezeichnungen und Begriffe in diesem Charakterbogen orientieren sich am offiziellen deutschen Systemreferenzdokument (SRD 5.2.1), sofern dort entsprechende Übersetzungen vorhanden sind.</p>
                        <p>Begriffe ohne eigene Spielmechanik (z.&nbsp;B. Abschnitts- oder UI-Bezeichnungen) wurden aus Gründen der Verständlichkeit ins Deutsche übertragen.</p>
                        <p>Einzelne Fachbegriffe, die im SRD nicht eindeutig deutsch definiert sind oder als eigenständige Regeltermini gelten (z.&nbsp;B. „Feat"), werden bewusst in ihrer englischen Form verwendet.</p>
                        <hr style="border:none;border-top:1px solid var(--md-outline-variant);margin:16px 0;">
                        <p><a href="https://www.dndbeyond.com/srd" target="_blank" rel="noopener">Systemreferenzdokument (SRD 5.2.1) ↗</a><br>
                        <a href="https://creativecommons.org/licenses/by/4.0/legalcode.de" target="_blank" rel="noopener">Creative Commons Namensnennung 4.0 International (CC-BY-4.0) ↗</a></p>
                    `;
                } else {
                    rulesNotice.innerHTML = `
                        <p><strong>Rules Compatibility & Licensing Notice</strong></p>
                        <p>This character sheet makes use of game mechanics, rules terminology, and other content derived from the System Reference Document 5.2.1 (SRD), published by Wizards of the Coast LLC and licensed under the Creative Commons Attribution 4.0 International License (CC-BY-4.0).</p>
                        <p>The System Reference Document is made available by Wizards of the Coast under an open license to allow the use, modification, and redistribution of the covered material, provided that proper attribution is given. This application complies with the attribution requirements of the CC-BY-4.0 license.</p>
                        <p>Dungeons & Dragons, D&D, and all related trademarks, product names, and brand identifiers are trademarks or registered trademarks of Wizards of the Coast LLC.</p>
                        <p>RIFT is an independent project and is not affiliated with, endorsed by, sponsored by, or approved by Wizards of the Coast LLC in any way. The use of SRD content does not imply any partnership, endorsement, or official status.</p>
                        <p>Any content not explicitly derived from the System Reference Document remains the intellectual property of its respective creators.</p>
                        <hr style="border:none;border-top:1px solid var(--md-outline-variant);margin:16px 0;">
                        <p><strong>Note on Terminology</strong></p>
                        <p>Terms and labels in this character sheet follow the official System Reference Document (SRD 5.2.1) where applicable translations exist.</p>
                        <p>Terms without inherent game mechanics (e.g., section or UI labels) have been translated for clarity.</p>
                        <p>Certain technical terms that are not clearly defined in the SRD or serve as standalone rule terms (e.g., "Feat") are intentionally kept in their original English form.</p>
                        <hr style="border:none;border-top:1px solid var(--md-outline-variant);margin:16px 0;">
                        <p><a href="https://www.dndbeyond.com/srd" target="_blank" rel="noopener">System Reference Document (SRD 5.2.1) ↗</a><br>
                        <a href="https://creativecommons.org/licenses/by/4.0/" target="_blank" rel="noopener">Creative Commons Attribution 4.0 International License ↗</a></p>
                    `;
                }
            }

            // Translate Species Dropdown
            const speciesSelect = document.getElementById('species');
            if (speciesSelect) {
                speciesSelect.querySelectorAll('option').forEach(opt => {
                    const val = opt.value;
                    if (val && val !== 'custom' && SRD_TERMS_DE[opt.textContent]) {
                        opt.textContent = term(opt.textContent);
                    }
                    if (val === 'custom') opt.textContent = term('Custom / Other');
                    if (val === '' && opt.textContent === 'Select') opt.textContent = term('Select');
                });
            }

            // Translate Class Dropdown
            const classSelect = document.getElementById('charClass');
            if (classSelect) {
                classSelect.querySelectorAll('option').forEach(opt => {
                    const val = opt.value;
                    if (val && val !== 'custom' && SRD_TERMS_DE[opt.textContent]) {
                        opt.textContent = term(opt.textContent);
                    }
                    if (val === 'custom') opt.textContent = term('Custom / Homebrew');
                    if (val === '' && opt.textContent === 'Select') opt.textContent = term('Select');
                });
            }

            // Translate Background Dropdown
            const bgSelect = document.getElementById('background');
            if (bgSelect) {
                bgSelect.querySelectorAll('option').forEach(opt => {
                    const val = opt.value;
                    if (val && val !== 'custom' && SRD_TERMS_DE[opt.textContent]) {
                        opt.textContent = term(opt.textContent);
                    }
                    if (val === 'custom') opt.textContent = term('Custom / Other');
                    if (val === '' && opt.textContent === 'Select') opt.textContent = term('Select');
                });
            }

            // Translate Subclass Dropdown (dynamically populated)
            const subclassSelect = document.getElementById('subclass');
            if (subclassSelect) {
                subclassSelect.querySelectorAll('option').forEach(opt => {
                    const text = opt.textContent;
                    if (text && SRD_TERMS_DE[text]) {
                        opt.textContent = term(text);
                    }
                    if (opt.value === '' && text === 'Select Subclass') opt.textContent = term('Select Subclass');
                });
            }

            // Translate Placeholders
            const placeholders = {
                'Character Name': term('Character Name'),
                'Enter species...': term('Enter species...'),
                'Enter class...': term('Enter class...'),
                'Enter background...': term('Enter background...'),
                'Enter subclass...': term('Enter subclass...'),
                'Fire, Poison, ...': term('Fire, Poison, ...'),
                'Poison, Disease, ...': term('Poison, Disease, ...'),
                'Radiant, ...': term('Radiant, ...'),
                'Class features, abilities, actions...': term('Class features, abilities, actions...'),
                'Specific weapons (e.g. Longsword, Rapier, Hand Crossbow)': term('Specific weapons (e.g. Longsword, Rapier, Hand Crossbow)'),
                'Darkvision 60 ft., ...': term('Darkvision 60 ft., ...'),
                'Racial abilities, features...': term('Racial abilities, features...'),
                'Selected feats...': term('Selected feats...'),
                'Common, Elvish, ...': term('Common, Elvish, ...'),
                'Items, gear, supplies...': term('Items, gear, supplies...'),
                'Age': term('Age'), 'Height': term('Height'), 'Weight': term('Weight'),
                'Eyes': term('Eyes'), 'Hair': term('Hair'), 'Skin': term('Skin'),
                'Physical description...': term('Physical description...'),
                'History, traits, ideals, bonds, flaws...': term('History, traits, ideals, bonds, flaws...')
            };
            document.querySelectorAll('input[placeholder], textarea[placeholder]').forEach(el => {
                const ph = el.getAttribute('placeholder');
                if (placeholders[ph]) el.setAttribute('placeholder', placeholders[ph]);
            });
        }

        function toggleSection(header) { header.parentElement.classList.toggle('collapsed'); }

        // Custom dropdown handlers
        function handleSpeciesChange() {
            const sel = document.getElementById('species');
            const custom = document.getElementById('speciesCustom');
            if (sel.value === 'custom') {
                custom.style.display = 'block';
                custom.focus();
            } else {
                custom.style.display = 'none';
                custom.value = '';
            }
        }

        function handleClassChange() {
            const sel = document.getElementById('charClass');
            const custom = document.getElementById('classCustom');
            const subclassChip = document.getElementById('subclassChip');
            const subclassSel = document.getElementById('subclass');
            const subclassCustom = document.getElementById('subclassCustom');
            
            const selectedClass = sel.value;
            
            if (selectedClass === 'custom') {
                custom.style.display = 'block';
                custom.focus();
                // Hide subclass for custom class
                subclassChip.style.display = 'none';
            } else if (selectedClass && selectedClass !== '' && SUBCLASSES[selectedClass]) {
                custom.style.display = 'none';
                custom.value = '';
                // Show and populate subclass dropdown
                subclassChip.style.display = 'flex';
                populateSubclassDropdown(selectedClass);
            } else {
                custom.style.display = 'none';
                custom.value = '';
                subclassChip.style.display = 'none';
            }
            
            // Dim Pact Slots if not Warlock
            updatePactSlotsVisibility(selectedClass);
        }

        function updatePactSlotsVisibility(selectedClass) {
            const pactSection = document.getElementById('pactSlotsSection');
            if (pactSection) {
                const isWarlock = selectedClass === 'Warlock';
                pactSection.classList.toggle('dimmed', !isWarlock);
            }
        }

        function populateSubclassDropdown(className) {
            const subclassSel = document.getElementById('subclass');
            const subclasses = SUBCLASSES[className] || [];
            
            // Remove all existing options
            while (subclassSel.firstChild) {
                subclassSel.removeChild(subclassSel.firstChild);
            }
            
            // Add placeholder
            const placeholder = document.createElement('option');
            placeholder.value = '';
            placeholder.disabled = true;
            placeholder.selected = true;
            placeholder.textContent = term('Select Subclass');
            subclassSel.appendChild(placeholder);
            
            // Add subclass options (translate if available)
            subclasses.forEach(sc => {
                const opt = document.createElement('option');
                opt.value = sc; // Value stays EN for data compatibility
                opt.textContent = term(sc); // Display translated if available
                subclassSel.appendChild(opt);
            });
            
            // Add custom option
            const customOpt = document.createElement('option');
            customOpt.value = 'custom';
            customOpt.textContent = term('Custom / Other');
            subclassSel.appendChild(customOpt);
            
            // Reset custom input
            const subclassCustom = document.getElementById('subclassCustom');
            subclassCustom.style.display = 'none';
            subclassCustom.value = '';
        }

        function handleSubclassChange() {
            const sel = document.getElementById('subclass');
            const custom = document.getElementById('subclassCustom');
            if (sel.value === 'custom') {
                custom.style.display = 'block';
                custom.focus();
            } else {
                custom.style.display = 'none';
                custom.value = '';
            }
        }

        function handleBackgroundChange() {
            const sel = document.getElementById('background');
            const custom = document.getElementById('backgroundCustom');
            if (sel.value === 'custom') {
                custom.style.display = 'block';
                custom.focus();
            } else {
                custom.style.display = 'none';
                custom.value = '';
            }
        }

        function getSpeciesValue() {
            const sel = document.getElementById('species');
            const custom = document.getElementById('speciesCustom');
            return sel.value === 'custom' ? custom.value : sel.value;
        }

        function getClassValue() {
            const sel = document.getElementById('charClass');
            const custom = document.getElementById('classCustom');
            return sel.value === 'custom' ? custom.value : sel.value;
        }

        function getSubclassValue() {
            const sel = document.getElementById('subclass');
            const custom = document.getElementById('subclassCustom');
            if (!sel || sel.style.display === 'none') return '';
            return sel.value === 'custom' ? custom.value : sel.value;
        }

        function getBackgroundValue() {
            const sel = document.getElementById('background');
            const custom = document.getElementById('backgroundCustom');
            return sel.value === 'custom' ? custom.value : sel.value;
        }

        function setDropdownValue(selectId, customId, value) {
            const sel = document.getElementById(selectId);
            const custom = document.getElementById(customId);
            const options = Array.from(sel.options).map(o => o.value);
            
            if (!value) {
                sel.selectedIndex = 0;
                custom.style.display = 'none';
                custom.value = '';
            } else if (options.includes(value)) {
                sel.value = value;
                custom.style.display = 'none';
                custom.value = '';
            } else {
                sel.value = 'custom';
                custom.style.display = 'block';
                custom.value = value;
            }
        }

        function setSubclassValue(className, subclassValue) {
            const subclassChip = document.getElementById('subclassChip');
            const subclassSel = document.getElementById('subclass');
            const subclassCustom = document.getElementById('subclassCustom');
            
            if (!className || className === '' || className === 'custom' || !SUBCLASSES[className]) {
                subclassChip.style.display = 'none';
                return;
            }
            
            // Show and populate
            subclassChip.style.display = 'flex';
            populateSubclassDropdown(className);
            
            if (!subclassValue || subclassValue === '') {
                subclassSel.selectedIndex = 0;
                subclassCustom.style.display = 'none';
                subclassCustom.value = '';
            } else {
                const subclasses = SUBCLASSES[className] || [];
                if (subclasses.includes(subclassValue)) {
                    subclassSel.value = subclassValue;
                    subclassCustom.style.display = 'none';
                    subclassCustom.value = '';
                } else {
                    subclassSel.value = 'custom';
                    subclassCustom.style.display = 'block';
                    subclassCustom.value = subclassValue;
                }
            }
        }

        // Build abilities grid - all fields EDITABLE, no automatic values
        // Order: STR, WIS, CHA, INT, DEX, CON (STR+CON left column stacked, rest spans both rows)
        function buildAbilitiesGrid() {
            const grid = document.getElementById('abilitiesGrid');
            const order = ['str', 'wis', 'cha', 'int', 'dex', 'con'];
            const orderedAbilities = order.map(id => ABILITIES.find(a => a.id === id));
            
            grid.innerHTML = orderedAbilities.map(ab => `
                <div class="ability-card" data-ability="${ab.id}">
                    <div class="ability-top">
                        <span class="ability-name">${term(ab.name)}</span>
                        <div class="ability-mod-wrapper">
                            <div class="ability-mod">
                                <span class="ability-mod-value clickable" id="${ab.id}Mod" onclick="rollAbilityCheck('${ab.id}')" title="${getLang()==='de'?'Klick für Attributsprobe':'Click for ability check'}">+0</span>
                            </div>
                            <div class="ability-score-box">
                                <input type="text" class="ability-score-input" id="${ab.id}" placeholder="10" oninput="updateModifier('${ab.id}'); autoSave()">
                                <span class="ability-score-label">${term('Score')}</span>
                            </div>
                        </div>
                    </div>
                    <div class="save-row">
                        <input type="checkbox" class="prof-check" id="${ab.id}SaveProf" onchange="handleSaveProfChange('${ab.id}'); autoSave()" title="${term('Proficiency')}">
                        <span class="save-val save-computed clickable" id="${ab.id}SaveValue" onclick="rollSavingThrow('${ab.id}')" title="${getLang()==='de'?'Klick zum Würfeln':'Click to roll'}">+0</span>
                        <span class="save-label">${term('Saving Throw')}</span>
                    </div>
                    ${ab.skills.length ? `<div class="skills-list">${ab.skills.map(sk => `
                        <div class="skill-item">
                            <input type="checkbox" class="prof-check-skill" id="${sk}Prof" onchange="handleSkillProfChange('${sk}'); autoSave()" title="${term('Proficiency')}">
                            <input type="checkbox" class="expertise-check" id="${sk}Exp" onchange="handleSkillExpChange('${sk}'); autoSave()" title="${term('Expertise')}" disabled>
                            <span class="skill-val skill-computed clickable" id="${sk}Value" onclick="rollSkillCheck('${sk}')" title="${getLang()==='de'?'Klick zum Würfeln':'Click to roll'}">+0</span>
                            <span class="skill-name">${term(SKILL_NAMES[sk])}</span>
                        </div>
                    `).join('')}</div>` : ''}
                </div>
            `).join('');
        }

        // Calculate and display modifier from score (always with sign)
        function updateModifier(abilityId) {
            const scoreInput = document.getElementById(abilityId);
            const modSpan = document.getElementById(abilityId + 'Mod');
            if (!scoreInput || !modSpan) return;
            
            const score = parseInt(scoreInput.value) || 10;
            const mod = Math.floor((score - 10) / 2);
            modSpan.textContent = mod >= 0 ? `+${mod}` : `${mod}`;
            
            // Update spell stats if this ability is the spellcasting ability
            updateSpellStats();
            
            // Cascade updates for derived stats
            if (abilityId === 'dex') updateInitiative();
            if (abilityId === 'wis' || abilityId === 'int') updatePassiveScores();
            
            // Update skills that depend on this ability
            Object.entries(SKILL_ABILITY).forEach(([skillId, abId]) => {
                if (abId === abilityId) updateSkillBonus(skillId);
            });
            
            // Update saving throw for this ability
            updateSaveBonus(abilityId);
        }

        // Update Spellcasting stats based on selected ability
        function updateSpellStats() {
            const abilitySelect = document.getElementById('spellAbility');
            const modSpan = document.getElementById('spellMod');
            const dcSpan = document.getElementById('spellDC');
            const attackSpan = document.getElementById('spellAttack');
            const dcHint = document.getElementById('spellDCHint');
            const attackHint = document.getElementById('spellAttackHint');
            
            const ability = abilitySelect ? abilitySelect.value : '';
            const profBonus = parseInt(document.getElementById('profBonus')?.textContent) || 2;
            
            let abilityMod = 0;
            let abilityName = '–';
            
            if (ability && ['int', 'wis', 'cha'].includes(ability)) {
                const scoreEl = document.getElementById(ability);
                const score = parseInt(scoreEl?.value) || 10;
                abilityMod = Math.floor((score - 10) / 2);
                abilityName = ability.toUpperCase();
            }
            
            const dc = 8 + profBonus + abilityMod;
            const attack = profBonus + abilityMod;
            
            if (modSpan) modSpan.textContent = abilityMod >= 0 ? `+${abilityMod}` : `${abilityMod}`;
            if (dcSpan) dcSpan.textContent = dc;
            if (attackSpan) attackSpan.textContent = attack >= 0 ? `+${attack}` : `${attack}`;
            
            // Update hints with breakdown
            if (dcHint && ability) {
                dcHint.textContent = `8 + ${profBonus} + ${abilityMod >= 0 ? '+' : ''}${abilityMod} (${abilityName})`;
            }
            if (attackHint && ability) {
                attackHint.textContent = `${profBonus} + ${abilityMod >= 0 ? '+' : ''}${abilityMod} (${abilityName})`;
            }
        }

        // Calculate Proficiency Bonus from Level (D&D 5e rule)
        function updateProfBonus() {
            const level = parseInt(document.getElementById('level')?.value) || 1;
            const profBonus = Math.floor((level - 1) / 4) + 2; // +2 at L1-4, +3 at L5-8, etc.
            const profSpan = document.getElementById('profBonus');
            if (profSpan) {
                profSpan.textContent = `+${profBonus}`;
            }
            // Cascade updates
            updateSpellStats();
            updateInitiative();
            updatePassiveScores();
            updateAllSkillBonuses();
            updateAllSaveBonuses();
        }

        // Calculate Initiative from DEX Modifier
        function updateInitiative() {
            const dexScore = parseInt(document.getElementById('dex')?.value) || 10;
            const dexMod = Math.floor((dexScore - 10) / 2);
            const initSpan = document.getElementById('initiative');
            if (initSpan) {
                initSpan.textContent = dexMod >= 0 ? `+${dexMod}` : `${dexMod}`;
            }
        }

        // Calculate Passive Scores (Perception, Investigation, Insight)
        function updatePassiveScores() {
            const profBonus = parseInt(document.getElementById('profBonus')?.textContent) || 2;
            
            // Passive Perception = 10 + WIS mod + Prof (if proficient in Perception)
            const wisScore = parseInt(document.getElementById('wis')?.value) || 10;
            const wisMod = Math.floor((wisScore - 10) / 2);
            const percProf = document.getElementById('perceptionProf')?.checked ? profBonus : 0;
            const percExp = document.getElementById('perceptionExp')?.checked ? profBonus : 0; // Expertise adds prof again
            const passivePerc = 10 + wisMod + percProf + percExp;
            const percSpan = document.getElementById('passivePerc');
            if (percSpan) percSpan.textContent = passivePerc;
            
            // Passive Investigation = 10 + INT mod + Prof (if proficient in Investigation)
            const intScore = parseInt(document.getElementById('int')?.value) || 10;
            const intMod = Math.floor((intScore - 10) / 2);
            const invProf = document.getElementById('investigationProf')?.checked ? profBonus : 0;
            const invExp = document.getElementById('investigationExp')?.checked ? profBonus : 0;
            const passiveInv = 10 + intMod + invProf + invExp;
            const invSpan = document.getElementById('passiveInv');
            if (invSpan) invSpan.textContent = passiveInv;
            
            // Passive Insight = 10 + WIS mod + Prof (if proficient in Insight)
            const insProf = document.getElementById('insightProf')?.checked ? profBonus : 0;
            const insExp = document.getElementById('insightExp')?.checked ? profBonus : 0;
            const passiveIns = 10 + wisMod + insProf + insExp;
            const insSpan = document.getElementById('passiveIns');
            if (insSpan) insSpan.textContent = passiveIns;
        }

        // Calculate single skill bonus
        function updateSkillBonus(skillId) {
            const abilityId = SKILL_ABILITY[skillId];
            if (!abilityId) return;
            
            const abilityScore = parseInt(document.getElementById(abilityId)?.value) || 10;
            const abilityMod = Math.floor((abilityScore - 10) / 2);
            const profBonus = parseInt(document.getElementById('profBonus')?.textContent) || 2;
            
            const isProficient = document.getElementById(skillId + 'Prof')?.checked || false;
            const hasExpertise = document.getElementById(skillId + 'Exp')?.checked || false;
            
            let bonus = abilityMod;
            if (isProficient) bonus += profBonus;
            if (hasExpertise) bonus += profBonus; // Expertise doubles proficiency
            
            const valueSpan = document.getElementById(skillId + 'Value');
            if (valueSpan) {
                valueSpan.textContent = bonus >= 0 ? `+${bonus}` : `${bonus}`;
            }
        }

        // Update all skill bonuses
        function updateAllSkillBonuses() {
            Object.keys(SKILL_ABILITY).forEach(skillId => updateSkillBonus(skillId));
        }

        // Calculate single saving throw bonus
        function updateSaveBonus(abilityId) {
            const abilityScore = parseInt(document.getElementById(abilityId)?.value) || 10;
            const abilityMod = Math.floor((abilityScore - 10) / 2);
            const profBonus = parseInt(document.getElementById('profBonus')?.textContent) || 2;
            
            const isProficient = document.getElementById(abilityId + 'SaveProf')?.checked || false;
            
            let bonus = abilityMod;
            if (isProficient) bonus += profBonus;
            
            const valueSpan = document.getElementById(abilityId + 'SaveValue');
            if (valueSpan) {
                valueSpan.textContent = bonus >= 0 ? `+${bonus}` : `${bonus}`;
            }
        }

        // Update all saving throw bonuses
        function updateAllSaveBonuses() {
            ABILITIES.forEach(ab => updateSaveBonus(ab.id));
        }

        // Initialize all modifiers on load
        function initModifiers() {
            ABILITIES.forEach(ab => {
                updateModifier(ab.id);
            });
        }

        // Handle Proficiency change - enable/disable Expertise
        function handleSkillProfChange(skillId) {
            const profCheck = document.getElementById(skillId + 'Prof');
            const expCheck = document.getElementById(skillId + 'Exp');
            if (profCheck && expCheck) {
                if (profCheck.checked) {
                    expCheck.disabled = false;
                } else {
                    expCheck.checked = false;
                    expCheck.disabled = true;
                }
            }
            // Update computed bonus
            updateSkillBonus(skillId);
            // Update passive scores if relevant skill
            if (['perception', 'investigation', 'insight'].includes(skillId)) {
                updatePassiveScores();
            }
        }

        // Handle Expertise checkbox change
        function handleSkillExpChange(skillId) {
            updateSkillBonus(skillId);
            if (['perception', 'investigation', 'insight'].includes(skillId)) {
                updatePassiveScores();
            }
        }

        // Handle Save Proficiency checkbox change
        function handleSaveProfChange(abilityId) {
            updateSaveBonus(abilityId);
        }

        // Initialize all skill expertise checkboxes based on proficiency state
        function initSkillExpertise() {
            ABILITIES.forEach(ab => {
                ab.skills.forEach(sk => {
                    const profCheck = document.getElementById(sk + 'Prof');
                    const expCheck = document.getElementById(sk + 'Exp');
                    if (profCheck && expCheck) {
                        expCheck.disabled = !profCheck.checked;
                    }
                });
            });
        }

        function toggleHeroic() {
            char.stats.heroicInsp = !char.stats.heroicInsp;
            document.getElementById('heroicBtn').classList.toggle('active', char.stats.heroicInsp);
            autoSave();
        }

        // Exhaustion Tracker (5e 2024: -2 per level to d20 rolls)
        function updateExhaustion() {
            const val = parseInt(document.getElementById('exhaustion').value) || 0;
            const penalty = val * 2;
            const penaltyEl = document.getElementById('exhaustionPenalty');
            penaltyEl.textContent = penalty > 0 ? `−${penalty}` : '−0';
            penaltyEl.style.color = val >= 10 ? '#f44336' : val > 0 ? 'var(--md-error)' : 'var(--md-on-surface-variant)';
            if (val >= 10) {
                penaltyEl.textContent = '☠ DEAD';
            }
            char.combat.exhaustion = val;
        }

        // Death Saves Tracker
        function initDeathSaves() {
            ['Success', 'Fail'].forEach(type => {
                const div = document.getElementById(`death${type === 'Success' ? 'Success' : 'Fail'}`);
                const key = type === 'Success' ? 'success' : 'fail';
                div.innerHTML = '';
                for (let i = 0; i < 3; i++) {
                    const pip = document.createElement('div');
                    pip.className = `death-pip ${key}${char.deathSaves[key][i] ? ' active' : ''}`;
                    pip.onclick = () => { char.deathSaves[key][i] = !char.deathSaves[key][i]; initDeathSaves(); autoSave(); };
                    div.appendChild(pip);
                }
            });
        }

        // Spell Slots Tracker - SRD 5.1 compliant
        // Slots are resources PER SPELL LEVEL, not per spell
        // Active pip = slot AVAILABLE, Inactive pip = slot EXPENDED
        function initSpellSlots() {
            const grid = document.getElementById('slotsGrid');
            const lang = getLang();
            grid.innerHTML = '';
            
            for (let lvl = 1; lvl <= 9; lvl++) {
                const slot = char.spellSlots[lvl] || { total: 0, expended: 0 };
                const maxSlots = SLOT_MAX[lvl];
                const isEmpty = !slot.total || slot.total === 0;
                const available = Math.max(0, (slot.total || 0) - (slot.expended || 0));
                
                const levelLabel = lang === 'de' ? `Grad ${lvl}` : `Level ${lvl}`;
                const availLabel = lang === 'de' ? 'verfügbar' : 'available';
                
                const card = document.createElement('div');
                card.className = 'slot-card' + (isEmpty ? ' slot-empty' : '');
                card.id = `slotCard${lvl}`;
                card.innerHTML = `
                    <div class="slot-header">
                        <span class="slot-level">${levelLabel}</span>
                        <div class="slot-total-edit">
                            <label class="slot-total-label">${lang === 'de' ? 'Max' : 'Max'}:</label>
                            <input type="number" class="slot-total-input" id="slot${lvl}Total" 
                                   value="${slot.total || ''}" placeholder="0" min="0" max="${maxSlots}" 
                                   oninput="updateSlotDisplay(${lvl});autoSave()">
                        </div>
                    </div>
                    <div class="slot-pips" id="slotPips${lvl}"></div>
                    <div class="slot-status" id="slotStatus${lvl}">
                        <span class="slot-available">${available}</span> / <span class="slot-max">${slot.total || 0}</span>
                        <span class="slot-avail-label">${availLabel}</span>
                    </div>
                `;
                grid.appendChild(card);
                setTimeout(() => updateSlotDisplay(lvl), 0);
            }
        }

        function updateSlotCardState(lvl) {
            const card = document.getElementById(`slotCard${lvl}`);
            const total = parseInt(document.getElementById(`slot${lvl}Total`).value) || 0;
            if (card) {
                card.classList.toggle('slot-empty', total === 0);
            }
        }

        function updateSlotDisplay(lvl) {
            const maxSlots = SLOT_MAX[lvl];
            let total = parseInt(document.getElementById(`slot${lvl}Total`).value) || 0;
            total = Math.min(total, maxSlots);
            
            // Get stored expended, but clamp to new total
            let expended = char.spellSlots[lvl]?.expended || 0;
            expended = Math.min(expended, total);
            
            // Update char object
            if (!char.spellSlots[lvl]) char.spellSlots[lvl] = {};
            char.spellSlots[lvl].total = total;
            char.spellSlots[lvl].expended = expended;
            
            const available = total - expended;
            const lang = getLang();
            
            // Update pips
            const pipsDiv = document.getElementById(`slotPips${lvl}`);
            if (pipsDiv) {
                pipsDiv.innerHTML = '';
                for (let i = 0; i < total; i++) {
                    const isExpended = i < expended;
                    const pip = document.createElement('div');
                    pip.className = 'slot-pip' + (isExpended ? ' expended' : ' available');
                    pip.title = isExpended 
                        ? (lang === 'de' ? 'Verbraucht - Klick zum Wiederherstellen' : 'Expended - Click to restore')
                        : (lang === 'de' ? 'Verfügbar - Klick zum Verbrauchen' : 'Available - Click to expend');
                    pip.onclick = () => toggleSlotPip(lvl, i);
                    
                    // Add inner indicator
                    pip.innerHTML = isExpended 
                        ? '<svg viewBox="0 0 24 24" fill="currentColor"><circle cx="12" cy="12" r="8"/></svg>'
                        : '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="8"/></svg>';
                    
                    pipsDiv.appendChild(pip);
                }
            }
            
            // Update status text
            const statusDiv = document.getElementById(`slotStatus${lvl}`);
            if (statusDiv) {
                statusDiv.querySelector('.slot-available').textContent = available;
                statusDiv.querySelector('.slot-max').textContent = total;
            }
            
            // Update card state
            updateSlotCardState(lvl);
        }

        function toggleSlotPip(lvl, pipIndex) {
            if (!char.spellSlots[lvl]) char.spellSlots[lvl] = { total: 0, expended: 0 };
            
            const total = char.spellSlots[lvl].total || 0;
            let expended = char.spellSlots[lvl].expended || 0;
            
            // If clicking on an expended slot (index < expended), restore up to that point
            // If clicking on an available slot (index >= expended), expend up to that point
            if (pipIndex < expended) {
                // Clicked on expended slot - restore this and all after it
                expended = pipIndex;
            } else {
                // Clicked on available slot - expend this and all before it
                expended = pipIndex + 1;
            }
            
            char.spellSlots[lvl].expended = Math.min(expended, total);
            updateSlotDisplay(lvl);
            autoSave();
        }

        // Update slots for REST actions
        function restoreAllSlots() {
            for (let lvl = 1; lvl <= 9; lvl++) {
                if (char.spellSlots[lvl]) {
                    char.spellSlots[lvl].expended = 0;
                }
                updateSlotDisplay(lvl);
            }
            autoSave();
        }

        // Legacy compatibility
        function updateSlotPips(lvl) {
            updateSlotDisplay(lvl);
        }

        // Attunement Tracker
        function toggleAttunement(i) {
            char.attunement[i] = !char.attunement[i];
            document.getElementById('attune' + i).classList.toggle('active', char.attunement[i]);
            autoSave();
        }

        function initAttunement() {
            for (let i = 0; i < 3; i++) {
                const el = document.getElementById('attune' + i);
                if (el) el.classList.toggle('active', char.attunement[i]);
            }
        }

        // Weapons
        function renderWeapons() {
            if (!char.weapons) char.weapons = [];
            const div = document.getElementById('weaponsList');
            div.innerHTML = char.weapons.map((w, i) => `
                <div class="weapon-row">
                    <input type="text" class="weapon-input" placeholder="${term('Name')}" value="${w.name||''}" oninput="char.weapons[${i}].name=this.value;autoSave()">
                    <input type="text" class="weapon-input rollable-field" placeholder="${term('Atk/DC')}" value="${w.bonus||''}" oninput="char.weapons[${i}].bonus=this.value;autoSave()" onclick="rollWeaponAttack(${i})" title="${getLang()==='de'?'Klick zum Würfeln':'Click to roll'}">
                    <input type="text" class="weapon-input rollable-field" placeholder="${term('Damage')}" value="${w.damage||''}" oninput="char.weapons[${i}].damage=this.value;autoSave()" onclick="rollWeaponDamage(${i})" title="${getLang()==='de'?'Klick zum Würfeln':'Click to roll'}">
                    <input type="text" class="weapon-input" placeholder="${term('Notes')}" value="${w.notes||''}" oninput="char.weapons[${i}].notes=this.value;autoSave()">
                    <button class="weapon-delete" onclick="char.weapons.splice(${i},1);renderWeapons();autoSave()">×</button>
                </div>
            `).join('');
        }
        function addWeapon() { char.weapons.push({}); renderWeapons(); autoSave(); }
        
        // Weapon Roll Functions
        function rollWeaponAttack(index) {
            const weapon = char.weapons[index];
            if (!weapon || !weapon.bonus) return;
            const bonus = weapon.bonus.replace(/[^0-9+\-]/g, '');
            if (bonus) {
                rollDice(`1d20${bonus.startsWith('+') || bonus.startsWith('-') ? bonus : '+' + bonus}`, `${weapon.name || 'Attack'} (${getLang()==='de'?'Angriff':'Attack'})`);
            }
        }
        
        function rollWeaponDamage(index) {
            const weapon = char.weapons[index];
            if (!weapon || !weapon.damage) return;
            // Parse damage like "1d8+3" or "2d6+5 slashing"
            const dmgMatch = weapon.damage.match(/(\d+d\d+(?:[+\-]\d+)?)/i);
            if (dmgMatch) {
                rollDice(dmgMatch[1], `${weapon.name || 'Damage'} (${getLang()==='de'?'Schaden':'Damage'})`);
            }
        }

        // Class Resources (Ki, Rage, Sorcery Points, etc.)
        function renderResources() {
            const div = document.getElementById('resourcesList');
            if (!char.classResources) char.classResources = [];
            div.innerHTML = char.classResources.map((r, i) => `
                <div class="resource-row">
                    <input type="text" class="resource-name" placeholder="${term('Ki, Rage, ...')}" value="${r.name || ''}" oninput="char.classResources[${i}].name=this.value;autoSave()">
                    <div class="resource-tracker">
                        <input type="number" class="resource-input" placeholder="–" value="${r.current || ''}" min="0" oninput="char.classResources[${i}].current=this.value;autoSave()">
                        <span class="resource-slash">/</span>
                        <input type="number" class="resource-input" placeholder="–" value="${r.max || ''}" min="0" oninput="char.classResources[${i}].max=this.value;autoSave()">
                    </div>
                    <button class="resource-delete" onclick="char.classResources.splice(${i},1);renderResources();autoSave()">×</button>
                </div>
            `).join('');
        }
        function addResource() { 
            if (!char.classResources) char.classResources = [];
            char.classResources.push({ name: '', current: '', max: '' }); 
            renderResources(); 
            autoSave(); 
        }

        // Spells
        // Spells with complete dice rolling logic
        // RULE: Cantrips (level 0) are NEVER shown in Prepared Spells
        // RULE: Prepared Spells only contain levels 1-9
        function renderSpells() {
            const div = document.getElementById('spellsList');
            const lang = getLang();
            
            // FILTER: Only show spells level 1-9 (NOT cantrips)
            const preparedSpells = (char.spells || []).filter(s => {
                const level = parseInt(s.level) || 0;
                return level >= 1 && level <= 9;
            });
            
            div.innerHTML = preparedSpells.map((s, filteredIndex) => {
                // Find actual index in char.spells array
                const actualIndex = char.spells.findIndex(sp => sp === s);
                
                // Get SRD spell data if available
                const spellData = SRD_SPELLS.find(sp => sp.name === s.srdName) || null;
                
                // Determine spell properties
                const level = s.level || '1';
                const hasDamage = s.damage && s.damage !== '—' && s.damage.match(/\d+d\d+/);
                const isAttackSpell = spellData ? isSpellAttack(spellData) : (s.attack === true);
                const isSaveSpell = spellData ? isSpellSave(spellData) : (s.save === true);
                const hasConc = s.conc === true;
                const isConcentrating = s.concentrating === true;
                
                // Build components display
                const hasV = s.verbal !== false; // Default true
                const hasS = s.somatic !== false; // Default true  
                const hasM = s.mat === true;
                
                // Determine effect category
                const category = determineSpellCategory(s, spellData);
                
                // Build effect summary
                const effectSummary = buildEffectSummary(s, spellData, isSaveSpell);
                
                // Casting time class
                const timeClass = getTimeClass(s.time);
                
                return `
                <div class="spell-row ${isConcentrating ? 'concentrating' : ''}" data-spell-index="${actualIndex}">
                    <!-- 1. Spell Level -->
                    <div class="spell-level-badge" title="${lang === 'de' ? 'Grad' : 'Level'} ${level}">
                        ${level}
                    </div>
                    
                    <!-- 2. School Icon -->
                    <div class="spell-school-icon" title="${s.school || spellData?.school || ''}" style="color: ${getSchoolColor(s.school || spellData?.school)}">
                        ${getSchoolIconSVG(s.school || spellData?.school)}
                    </div>
                    
                    <!-- 3. Spell Name -->
                    <div class="spell-name-display" onclick="showSpellDetails(${actualIndex})" title="${lang==='de'?'Klick für Details':'Click for details'}">
                        ${s.name || term('Unnamed Spell')}
                    </div>
                    
                    <!-- 4. Casting Time -->
                    <div class="spell-time-badge ${timeClass}" title="${term('Casting Time')}">
                        ${formatCastTime(s.time, lang)}
                    </div>
                    
                    <!-- 5. Components V/S/M -->
                    <div class="spell-components" title="${term('Components')}">
                        <span class="spell-comp ${hasV ? 'active' : ''}" title="${t('spell-verbal')}">V</span>
                        <span class="spell-comp ${hasS ? 'active' : ''}" title="${t('spell-somatic')}">S</span>
                        <span class="spell-comp ${hasM ? 'active' : ''}" title="${t('spell-material')}">M</span>
                    </div>
                    
                    <!-- 6. Effect Category -->
                    <div class="spell-category ${category.toLowerCase()}" title="${term('Effect Type')}">
                        ${category}
                    </div>
                    
                    <!-- 7. Short Effect Summary -->
                    <div class="spell-effect-summary" title="${effectSummary}">
                        ${effectSummary}
                    </div>
                    
                    <!-- 8. Mechanical Flags -->
                    <div class="spell-flags">
                        ${isAttackSpell || s.attack ? `
                            <div class="spell-flag active" onclick="rollSpellAttack(${actualIndex})" title="${lang==='de'?'Zauberangriff':'Spell Attack'}">
                                <svg viewBox="0 0 24 24" fill="currentColor"><path d="M12 2L4.5 20.29l.71.71L12 18l6.79 3 .71-.71z"/></svg>
                            </div>
                        ` : ''}
                        ${isSaveSpell || s.save ? `
                            <div class="spell-flag" style="font-size:9px;font-weight:700;width:auto;padding:0 6px;" title="${lang==='de'?'Rettungswurf erforderlich':'Saving Throw Required'}">
                                DC
                            </div>
                        ` : ''}
                        ${hasDamage ? `
                            <div class="spell-flag active" onclick="rollSpellDamage(${actualIndex})" title="${lang==='de'?'Schaden würfeln':'Roll Damage'}: ${s.damage}" style="background:#ff6b35;color:#fff;">
                                <svg viewBox="0 0 24 24" fill="currentColor"><path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zM7.5 18c-.83 0-1.5-.67-1.5-1.5S6.67 15 7.5 15s1.5.67 1.5 1.5S8.33 18 7.5 18zm0-9C6.67 9 6 8.33 6 7.5S6.67 6 7.5 6 9 6.67 9 7.5 8.33 9 7.5 9zm4.5 4.5c-.83 0-1.5-.67-1.5-1.5s.67-1.5 1.5-1.5 1.5.67 1.5 1.5-.67 1.5-1.5 1.5zm4.5 4.5c-.83 0-1.5-.67-1.5-1.5s.67-1.5 1.5-1.5 1.5.67 1.5 1.5-.67 1.5-1.5 1.5zm0-9c-.83 0-1.5-.67-1.5-1.5S15.67 6 16.5 6s1.5.67 1.5 1.5S17.33 9 16.5 9z"/></svg>
                            </div>
                        ` : ''}
                        ${hasConc ? `
                            <div class="spell-flag ${isConcentrating ? 'conc-active' : ''}" onclick="setConcentrating(${actualIndex})" title="${lang==='de'?'Konzentration':'Concentration'}${isConcentrating ? ' (AKTIV)' : ''}">
                                <svg viewBox="0 0 24 24" fill="currentColor"><circle cx="12" cy="12" r="8" fill="none" stroke="currentColor" stroke-width="2"/><circle cx="12" cy="12" r="3"/></svg>
                            </div>
                        ` : ''}
                    </div>
                    
                    <!-- 9. Delete Button -->
                    <button class="spell-delete-btn" onclick="deleteSpell(${actualIndex})" title="${lang==='de'?'Entfernen':'Remove'}">×</button>
                </div>
            `;
            }).join('');
            
            // Also render cantrips
            renderCantrips();
            updateConcentrationBanner();
        }
        
        // Render Cantrips (Level 0) - separate section
        function renderCantrips() {
            const section = document.getElementById('cantripsSection');
            const div = document.getElementById('cantripsList');
            const lang = getLang();
            
            // FILTER: Only show cantrips (level 0)
            const cantrips = (char.spells || []).filter(s => {
                const level = parseInt(s.level) || 0;
                return level === 0;
            });
            
            // Show/hide section based on whether there are cantrips
            section.style.display = cantrips.length > 0 ? 'block' : 'none';
            
            // Update label
            const labelSpan = section.querySelector('.field-label span:first-child');
            if (labelSpan) {
                labelSpan.textContent = lang === 'de' ? 'Zaubertricks' : 'Cantrips';
            }
            
            div.innerHTML = cantrips.map((s, filteredIndex) => {
                // Find actual index in char.spells array
                const actualIndex = char.spells.findIndex(sp => sp === s);
                
                // Get SRD spell data if available
                const spellData = SRD_SPELLS.find(sp => sp.name === s.srdName) || null;
                
                // Determine spell properties
                const hasDamage = s.damage && s.damage !== '—' && s.damage.match(/\d+d\d+/);
                const isAttackSpell = spellData ? isSpellAttack(spellData) : (s.attack === true);
                const isSaveSpell = spellData ? isSpellSave(spellData) : (s.save === true);
                
                // Build components display
                const hasV = s.verbal !== false;
                const hasS = s.somatic !== false;
                const hasM = s.mat === true;
                
                // Determine effect category
                const category = determineSpellCategory(s, spellData);
                
                // Build effect summary
                const effectSummary = buildEffectSummary(s, spellData, isSaveSpell);
                
                // Casting time class
                const timeClass = getTimeClass(s.time);
                
                return `
                <div class="cantrip-row" data-spell-index="${actualIndex}">
                    <!-- School Icon -->
                    <div class="spell-school-icon" title="${s.school || spellData?.school || ''}" style="color: ${getSchoolColor(s.school || spellData?.school)}">
                        ${getSchoolIconSVG(s.school || spellData?.school)}
                    </div>
                    
                    <!-- Cantrip Name -->
                    <div class="spell-name-display" onclick="showSpellDetails(${actualIndex})" title="${lang==='de'?'Klick für Details':'Click for details'}">
                        ${s.name || term('Unnamed Cantrip')}
                    </div>
                    
                    <!-- Casting Time -->
                    <div class="spell-time-badge ${timeClass}" title="${term('Casting Time')}">
                        ${formatCastTime(s.time, lang)}
                    </div>
                    
                    <!-- Components V/S/M -->
                    <div class="spell-components" title="${term('Components')}">
                        <span class="spell-comp ${hasV ? 'active' : ''}" title="${t('spell-verbal')}">V</span>
                        <span class="spell-comp ${hasS ? 'active' : ''}" title="${t('spell-somatic')}">S</span>
                        <span class="spell-comp ${hasM ? 'active' : ''}" title="${t('spell-material')}">M</span>
                    </div>
                    
                    <!-- Effect Category -->
                    <div class="spell-category ${category.toLowerCase()}" title="${term('Effect Type')}">
                        ${category}
                    </div>
                    
                    <!-- Short Effect Summary -->
                    <div class="spell-effect-summary" title="${effectSummary}">
                        ${effectSummary}
                    </div>
                    
                    <!-- Mechanical Flags -->
                    <div class="spell-flags">
                        ${isAttackSpell || s.attack ? `
                            <div class="spell-flag active" onclick="rollSpellAttack(${actualIndex})" title="${lang==='de'?'Zauberangriff':'Spell Attack'}">
                                <svg viewBox="0 0 24 24" fill="currentColor"><path d="M12 2L4.5 20.29l.71.71L12 18l6.79 3 .71-.71z"/></svg>
                            </div>
                        ` : ''}
                        ${hasDamage ? `
                            <div class="spell-flag active" onclick="rollSpellDamage(${actualIndex})" title="${lang==='de'?'Schaden würfeln':'Roll Damage'}: ${s.damage}" style="background:#ff6b35;color:#fff;">
                                <svg viewBox="0 0 24 24" fill="currentColor"><path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zM7.5 18c-.83 0-1.5-.67-1.5-1.5S6.67 15 7.5 15s1.5.67 1.5 1.5S8.33 18 7.5 18zm0-9C6.67 9 6 8.33 6 7.5S6.67 6 7.5 6 9 6.67 9 7.5 8.33 9 7.5 9zm4.5 4.5c-.83 0-1.5-.67-1.5-1.5s.67-1.5 1.5-1.5 1.5.67 1.5 1.5-.67 1.5-1.5 1.5zm4.5 4.5c-.83 0-1.5-.67-1.5-1.5s.67-1.5 1.5-1.5 1.5.67 1.5 1.5-.67 1.5-1.5 1.5zm0-9c-.83 0-1.5-.67-1.5-1.5S15.67 6 16.5 6s1.5.67 1.5 1.5S17.33 9 16.5 9z"/></svg>
                            </div>
                        ` : ''}
                    </div>
                    
                    <!-- Delete Button -->
                    <button class="spell-delete-btn" onclick="deleteSpell(${actualIndex})" title="${lang==='de'?'Entfernen':'Remove'}">×</button>
                </div>
            `;
            }).join('');
        }
        
        // Delete spell helper
        function deleteSpell(index) {
            char.spells.splice(index, 1);
            renderSpells();
            updateConcentrationBanner();
            autoSave();
        }
        
        // Add Cantrip (level 0)
        function addCantrip() {
            char.spells.push({
                name: '',
                level: '0',
                time: 'Action',
                verbal: true,
                somatic: true,
                mat: false,
                conc: false,
                concentrating: false,
                ritual: false,
                damage: '',
                damageType: '',
                attack: false,
                save: false,
                saveType: '',
                category: '',
                school: ''
            });
            renderSpells();
            autoSave();
        }
        
        // Helper: Determine spell category
        function determineSpellCategory(spell, spellData) {
            // Check explicit category first
            if (spell.category) return spell.category;
            
            const name = (spell.name || '').toLowerCase();
            const damage = spell.damage || '';
            const school = spellData?.school || spell.school || '';
            
            // Damage spells
            if (damage && damage.match(/\d+d\d+/) && !name.includes('heal')) {
                return 'Damage';
            }
            
            // Healing
            if (name.includes('heal') || name.includes('cure') || name.includes('restoration')) {
                return 'Healing';
            }
            
            // Control spells
            if (name.includes('hold') || name.includes('charm') || name.includes('dominate') || 
                name.includes('sleep') || name.includes('stun') || name.includes('paralyze') ||
                name.includes('entangle') || name.includes('web') || name.includes('slow')) {
                return 'Control';
            }
            
            // Buff spells
            if (name.includes('bless') || name.includes('haste') || name.includes('shield') ||
                name.includes('protection') || name.includes('enhance') || name.includes('aid') ||
                name.includes('heroism') || name.includes('blur') || name.includes('invisibility')) {
                return 'Buff';
            }
            
            // Debuff spells
            if (name.includes('bane') || name.includes('hex') || name.includes('curse') ||
                name.includes('blind') || name.includes('silence') || name.includes('fear')) {
                return 'Debuff';
            }
            
            // Teleportation
            if (name.includes('teleport') || name.includes('dimension door') || name.includes('misty step') ||
                name.includes('thunder step') || name.includes('plane shift')) {
                return 'Teleport';
            }
            
            // Summon
            if (name.includes('summon') || name.includes('conjure') || name.includes('find familiar') ||
                name.includes('animate')) {
                return 'Summon';
            }
            
            // School-based fallback
            if (school.toLowerCase() === 'abjuration') return 'Buff';
            if (school.toLowerCase() === 'divination') return 'Utility';
            if (school.toLowerCase() === 'enchantment') return 'Control';
            if (school.toLowerCase() === 'illusion') return 'Utility';
            if (school.toLowerCase() === 'transmutation') return 'Utility';
            
            return 'Utility';
        }
        
        // Helper: Build effect summary
        function buildEffectSummary(spell, spellData, isSaveSpell) {
            const parts = [];
            
            // Damage
            if (spell.damage && spell.damage !== '—' && spell.damage.match(/\d+d\d+/)) {
                let dmgText = spell.damage;
                if (spell.damageType) {
                    dmgText += ' ' + spell.damageType.substring(0, 4).toLowerCase();
                }
                parts.push(dmgText);
            }
            
            // Save type
            if (isSaveSpell || spell.save) {
                const saveType = spell.saveType || (spellData ? guessSaveType(spellData.name) : '');
                if (saveType) {
                    parts.push(saveType.toUpperCase() + ' save');
                } else {
                    parts.push('Save');
                }
            }
            
            // Range (if not self)
            if (spellData && spellData.range && !spellData.range.toLowerCase().includes('self')) {
                const range = spellData.range.replace(' feet', 'ft').replace(' foot', 'ft');
                if (range.length < 15) parts.push(range);
            }
            
            // Duration hint for concentration
            if (spell.conc && spellData && spellData.duration) {
                const dur = spellData.duration.replace('Concentration, up to ', '').replace('Up to ', '');
                if (dur.length < 12) parts.push(dur);
            }
            
            // If nothing specific, use school or generic
            if (parts.length === 0) {
                if (spellData && spellData.school) {
                    parts.push(spellData.school);
                } else {
                    parts.push('—');
                }
            }
            
            return parts.join(' • ');
        }
        
        // Helper: Guess save type from spell name
        function guessSaveType(spellName) {
            const name = spellName.toLowerCase();
            // DEX saves - damage avoidance
            if (name.includes('fireball') || name.includes('lightning') || name.includes('ice storm') ||
                name.includes('burning hands') || name.includes('thunderwave') || name.includes('shatter')) {
                return 'DEX';
            }
            // WIS saves - mental effects
            if (name.includes('charm') || name.includes('hold') || name.includes('dominate') ||
                name.includes('fear') || name.includes('suggestion') || name.includes('phantasmal')) {
                return 'WIS';
            }
            // CON saves - body effects
            if (name.includes('poison') || name.includes('flesh to stone') || name.includes('power word') ||
                name.includes('cloudkill') || name.includes('contagion')) {
                return 'CON';
            }
            // STR saves - physical restraint
            if (name.includes('entangle') || name.includes('web') || name.includes('gust')) {
                return 'STR';
            }
            // INT saves - psychic
            if (name.includes('psychic') || name.includes('feeblemind') || name.includes('synaptic')) {
                return 'INT';
            }
            // CHA saves - banishment
            if (name.includes('banish') || name.includes('dispel') || name.includes('zone of truth')) {
                return 'CHA';
            }
            return '';
        }
        
        // Helper: Get casting time CSS class
        function getTimeClass(time) {
            if (!time) return '';
            const t = time.toLowerCase();
            if (t === 'action') return 'action';
            if (t === 'bonus action') return 'bonus';
            if (t === 'reaction') return 'reaction';
            return '';
        }
        
        // Helper: Format casting time for display
        function formatCastTime(time, lang) {
            if (!time) return '—';
            const translations = {
                'Action': lang === 'de' ? 'Aktion' : 'Action',
                'Bonus Action': lang === 'de' ? 'Bonus' : 'Bonus',
                'Reaction': lang === 'de' ? 'Reakt.' : 'React.',
                '1 Minute': '1 min',
                '10 Minutes': '10 min',
                '1 Hour': '1 hr'
            };
            return translations[time] || time;
        }
        
        // Show spell details popup (placeholder - can be expanded)
        function showSpellDetails(index) {
            const spell = char.spells[index];
            const spellData = SRD_SPELLS.find(sp => sp.name === spell.srdName);
            
            if (spellData && spellData.desc) {
                const lang = getLang();
                alert(`${spell.name}\n\n${lang === 'de' && spellData.desc_de ? spellData.desc_de : spellData.desc}`);
            }
        }
        
        // Helper: Get school color
        function getSchoolColor(school) {
            if (!school) return 'var(--md-on-surface-variant)';
            const colors = {
                'Abjuration': '#3d85c6',
                'Conjuration': '#f1c232',
                'Divination': '#9fc5e8',
                'Enchantment': '#d5a6bd',
                'Evocation': '#e06666',
                'Illusion': '#b4a7d6',
                'Necromancy': '#76a5af',
                'Transmutation': '#93c47d'
            };
            return colors[school] || 'var(--md-on-surface-variant)';
        }
        
        // Helper: Get school icon SVG
        function getSchoolIconSVG(school) {
            if (!school) return '<svg viewBox="0 0 100 100" fill="currentColor"><circle cx="50" cy="50" r="30"/></svg>';
            const s = school.toLowerCase();
            if (ICONS[s]) return ICONS[s];
            return '<svg viewBox="0 0 100 100" fill="currentColor"><circle cx="50" cy="50" r="30"/></svg>';
        }
        
        // Determine if spell requires attack roll (ranged/melee spell attack)
        function isSpellAttack(spellData) {
            if (!spellData) return false;
            const name = spellData.name.toLowerCase();
            // Attack spells typically have damage and range not "Self"
            const attackSpells = [
                'acid splash', 'chill touch', 'eldritch blast', 'fire bolt', 'poison spray',
                'produce flame', 'ray of frost', 'sacred flame', 'shocking grasp',
                'chromatic orb', 'guiding bolt', 'inflict wounds', 'magic missile', 'ray of sickness', 'witch bolt',
                'melf\'s acid arrow', 'scorching ray',
                'vampiric touch',
                'blight',
                'contagion',
                'disintegrate', 'sunbeam',
                'finger of death',
                'fire storm', 'prismatic spray'
            ];
            // Ranged/touch attack indicators
            if (attackSpells.includes(name)) return true;
            // Check if damage exists and range is not Self-only
            if (spellData.damage && spellData.damage !== '—') {
                const range = spellData.range.toLowerCase();
                if (range.includes('touch') || (range.match(/\d+\s*ft/) && !range.includes('self'))) {
                    return true;
                }
            }
            return false;
        }
        
        // Determine if spell requires saving throw
        function isSpellSave(spellData) {
            if (!spellData) return false;
            const name = spellData.name.toLowerCase();
            const saveSpells = [
                'acid splash', 'poison spray', 'sacred flame', 'vicious mockery',
                'bane', 'burning hands', 'charm person', 'color spray', 'command', 'entangle', 'faerie fire',
                'grease', 'sleep', 'thunderwave',
                'blindness/deafness', 'calm emotions', 'darkness', 'hold person', 'shatter', 'silence', 'suggestion', 'web',
                'bestow curse', 'fear', 'fireball', 'hypnotic pattern', 'lightning bolt', 'slow', 'stinking cloud',
                'banishment', 'confusion', 'dominate beast', 'ice storm', 'phantasmal killer', 'polymorph', 'wall of fire',
                'cloudkill', 'cone of cold', 'dominate person', 'hold monster', 'wall of stone',
                'chain lightning', 'disintegrate', 'flesh to stone', 'mass suggestion', 'sunbeam',
                'finger of death', 'plane shift', 'prismatic spray',
                'dominate monster', 'earthquake', 'feeblemind', 'incendiary cloud', 'power word stun', 'sunburst',
                'meteor swarm', 'power word kill', 'prismatic wall', 'time stop'
            ];
            return saveSpells.includes(name);
        }
        
        // Roll spell attack (1d20 + Spell Attack Modifier)
        function rollSpellAttack(index) {
            const spell = char.spells[index];
            if (!spell) return;
            
            const spellAtkText = document.getElementById('spellAttack')?.textContent || '+0';
            const spellAtk = parseInt(spellAtkText.replace(/[^0-9\-]/g, '')) || 0;
            const bonus = spellAtk >= 0 ? `+${spellAtk}` : `${spellAtk}`;
            
            const spellName = spell.name || (getLang() === 'de' ? 'Zauber' : 'Spell');
            const label = getLang() === 'de' ? `${spellName} (Angriff)` : `${spellName} (Attack)`;
            
            rollDice(`1d20${bonus}`, label);
        }
        
        // Roll spell damage with optional upcasting
        function rollSpellDamage(index) {
            const spell = char.spells[index];
            if (!spell || !spell.damage) return;
            
            // Parse damage dice from spell (e.g., "8d6 fire", "3d10 necrotic", "1d8+mod radiant")
            let damageStr = spell.damage;
            
            // Handle +mod by replacing with actual spellcasting modifier
            if (damageStr.includes('+mod') || damageStr.includes('+ mod')) {
                const modText = document.getElementById('spellMod')?.textContent || '+0';
                const mod = parseInt(modText.replace(/[^0-9\-]/g, '')) || 0;
                damageStr = damageStr.replace(/\+\s*mod/gi, mod >= 0 ? `+${mod}` : `${mod}`);
            }
            
            // Extract dice formula
            const dmgMatch = damageStr.match(/(\d+d\d+(?:[+\-]\d+)?)/i);
            if (!dmgMatch) return;
            
            const spellName = spell.name || (getLang() === 'de' ? 'Zauber' : 'Spell');
            
            // Extract damage type for label
            const typeMatch = damageStr.match(/(fire|cold|lightning|thunder|acid|poison|necrotic|radiant|force|psychic|bludgeoning|piercing|slashing|healing)/i);
            const damageType = typeMatch ? typeMatch[1] : '';
            
            const label = getLang() === 'de' 
                ? `${spellName} (Schaden${damageType ? ' - ' + translateDamageType(damageType) : ''})`
                : `${spellName} (Damage${damageType ? ' - ' + damageType : ''})`;
            
            rollDice(dmgMatch[1], label);
        }
        
        // Translate damage type to German
        function translateDamageType(type) {
            const translations = {
                'fire': 'Feuer', 'cold': 'Kälte', 'lightning': 'Blitz', 'thunder': 'Donner',
                'acid': 'Säure', 'poison': 'Gift', 'necrotic': 'Nekrotisch', 'radiant': 'Strahlend',
                'force': 'Energie', 'psychic': 'Psychisch', 'bludgeoning': 'Wucht',
                'piercing': 'Stich', 'slashing': 'Hieb', 'healing': 'Heilung'
            };
            return translations[type.toLowerCase()] || type;
        }
        
        // Cast spell - expend slot and optionally upcast
        function castSpell(index, upcastLevel = null) {
            const spell = char.spells[index];
            if (!spell) return;
            
            const baseLevel = parseInt(spell.level) || 1;
            const castLevel = upcastLevel || baseLevel;
            
            // Cantrips don't use slots
            if (baseLevel === 0) {
                showSpellCastEffect(spell.name, 0);
                return;
            }
            
            // Check if slot available
            const slotData = char.spellSlots[castLevel];
            if (!slotData || slotData.expended >= slotData.total) {
                const lang = getLang();
                alert(lang === 'de' 
                    ? `Kein Zauberplatz Grad ${castLevel} verfügbar!` 
                    : `No Level ${castLevel} spell slot available!`);
                return;
            }
            
            // Expend slot
            char.spellSlots[castLevel].expended++;
            updateSlotDisplay(castLevel);
            
            // Activate concentration if needed
            if (spell.conc) {
                setConcentrating(index);
            }
            
            showSpellCastEffect(spell.name, castLevel);
            autoSave();
        }
        
        function showSpellCastEffect(spellName, level) {
            const lang = getLang();
            const levelText = level === 0 
                ? (lang === 'de' ? 'Zaubertrick' : 'Cantrip')
                : (lang === 'de' ? `Grad ${level}` : `Level ${level}`);
            
            const toast = document.createElement('div');
            toast.className = 'spell-cast-toast';
            toast.innerHTML = `
                <span class="spell-cast-icon">✨</span>
                <span class="spell-cast-text">${spellName}</span>
                <span class="spell-cast-level">${levelText}</span>
            `;
            document.body.appendChild(toast);
            
            requestAnimationFrame(() => toast.classList.add('active'));
            setTimeout(() => toast.remove(), 2000);
        }
        
        // Add Spell (Level 1-9) - never cantrips
        function addSpell() { 
            char.spells.push({
                name: '',
                level: '1', // Default to level 1 - cantrips use addCantrip()
                time: 'Action',
                verbal: true,
                somatic: true,
                mat: false,
                conc: false,
                concentrating: false,
                ritual: false,
                damage: '',
                damageType: '',
                attack: false,
                save: false,
                saveType: '',
                category: '',
                school: ''
            }); 
            renderSpells(); 
            autoSave(); 
        }

        // Portrait
        function handlePortrait(e) {
            const f = e.target.files[0];
            if (!f) return;
            const r = new FileReader();
            r.onload = ev => {
                document.getElementById('cropImage').src = ev.target.result;
                document.getElementById('cropModal').classList.add('active');
                setTimeout(() => {
                    if (cropper) cropper.destroy();
                    cropper = new Cropper(document.getElementById('cropImage'), { aspectRatio: 120/205, viewMode: 1 });
                }, 100);
            };
            r.readAsDataURL(f);
        }
        function closeCrop() {
            document.getElementById('cropModal').classList.remove('active');
            if (cropper) { cropper.destroy(); cropper = null; }
        }
        function confirmCrop() {
            if (!cropper) return;
            const cv = cropper.getCroppedCanvas({ width: 200, height: 200 });
            char.narrative.portrait = cv.toDataURL('image/jpeg', 0.8);
            document.getElementById('portraitImage').src = char.narrative.portrait;
            document.getElementById('portraitImage').style.display = 'block';
            document.getElementById('portraitPlaceholder').style.display = 'none';
            document.getElementById('portraitBox').classList.add('has-image');
            closeCrop();
            autoSave();
        }

        function deletePortrait() {
            if (!confirm(t('confirm-delete-portrait'))) return;
            char.narrative.portrait = '';
            document.getElementById('portraitImage').src = '';
            document.getElementById('portraitImage').style.display = 'none';
            document.getElementById('portraitPlaceholder').style.display = 'block';
            document.getElementById('portraitBox').classList.remove('has-image');
            autoSave();
        }

        // Collect all data
        function collectData() {
            char.header = {
                name: document.getElementById('charName').value,
                species: getSpeciesValue(),
                charClass: getClassValue(),
                level: document.getElementById('level').value,
                xp: document.getElementById('xp').value,
                background: getBackgroundValue(),
                subclass: getSubclassValue()
            };
            char.stats = {
                // These are now computed, but we store level for recalculation
                speed: document.getElementById('speed').value,
                size: document.getElementById('size').value,
                heroicInsp: char.stats.heroicInsp
            };
            
            ABILITIES.forEach(ab => {
                char.abilities[ab.id] = document.getElementById(ab.id).value;
                // Mod is computed, no need to store
                // Save value is computed, just store proficiency checkbox
                char.savesProf[ab.id] = document.getElementById(ab.id + 'SaveProf')?.checked || false;
                ab.skills.forEach(sk => {
                    // Skill value is computed, just store P/E checkboxes
                    char.skillsProf[sk] = document.getElementById(sk + 'Prof')?.checked || false;
                    char.skillsExp[sk] = document.getElementById(sk + 'Exp')?.checked || false;
                });
            });

            char.combat = {
                ac: document.getElementById('ac').value,
                shield: document.getElementById('shield').value,
                hpCurrent: document.getElementById('hpCurrent').value,
                hpMax: document.getElementById('hpMax').value,
                hpTemp: document.getElementById('hpTemp').value,
                hdCurrent: document.getElementById('hdCurrent').value,
                hdMax: document.getElementById('hdMax').value,
                exhaustion: document.getElementById('exhaustion').value,
                resistances: document.getElementById('resistances').value,
                immunities: document.getElementById('immunities').value,
                vulnerabilities: document.getElementById('vulnerabilities').value
            };

            char.classFeatures = document.getElementById('classFeatures').value;
            char.training = {
                armorLight: document.getElementById('armorLight').checked,
                armorMedium: document.getElementById('armorMedium').checked,
                armorHeavy: document.getElementById('armorHeavy').checked,
                armorShields: document.getElementById('armorShields').checked,
                weaponSimple: document.getElementById('weaponSimple').checked,
                weaponMartial: document.getElementById('weaponMartial').checked,
                weaponFirearms: document.getElementById('weaponFirearms').checked,
                weaponsText: document.getElementById('weaponsText').value,
                tools: document.getElementById('tools').value
            };
            char.speciesTraits = document.getElementById('speciesTraits').value;
            char.feats = document.getElementById('feats').value;
            char.senses = document.getElementById('senses').value;
            char.spellcasting = {
                ability: document.getElementById('spellAbility').value
            };
            for (let i = 1; i <= 9; i++) {
                char.spellSlots[i] = {
                    total: parseInt(document.getElementById(`slot${i}Total`).value) || 0,
                    expended: parseInt(document.getElementById(`slot${i}Exp`).value) || 0
                };
            }
            char.pactSlots = {
                level: document.getElementById('pactLevel').value,
                total: document.getElementById('pactTotal').value,
                expended: document.getElementById('pactExpended').value
            };
            char.narrative = {
                alignment: document.getElementById('alignment').value,
                physAge: document.getElementById('physAge').value,
                physHeight: document.getElementById('physHeight').value,
                physWeight: document.getElementById('physWeight').value,
                physEyes: document.getElementById('physEyes').value,
                physHair: document.getElementById('physHair').value,
                physSkin: document.getElementById('physSkin').value,
                appearance: document.getElementById('appearance').value,
                backstory: document.getElementById('backstory').value,
                languages: document.getElementById('languages').value,
                equipment: document.getElementById('equipment').value,
                portrait: char.narrative.portrait
            };
            char.coins = {
                cp: document.getElementById('cp').value,
                sp: document.getElementById('sp').value,
                ep: document.getElementById('ep').value,
                gp: document.getElementById('gp').value,
                pp: document.getElementById('pp').value
            };
        }

        // Populate all fields
        function populateFields() {
            document.getElementById('charName').value = char.header.name || '';
            setDropdownValue('species', 'speciesCustom', char.header.species || '');
            setDropdownValue('charClass', 'classCustom', char.header.charClass || '');
            document.getElementById('level').value = char.header.level || 1;
            document.getElementById('xp').value = char.header.xp || '';
            setDropdownValue('background', 'backgroundCustom', char.header.background || '');
            
            // Handle subclass based on class
            const classVal = char.header.charClass || '';
            const classSel = document.getElementById('charClass');
            const classOptions = Array.from(classSel.options).map(o => o.value);
            const isStandardClass = classOptions.includes(classVal) && classVal !== 'custom' && classVal !== '';
            
            if (isStandardClass) {
                setSubclassValue(classVal, char.header.subclass || '');
            } else {
                document.getElementById('subclassChip').style.display = 'none';
            }

            document.getElementById('speed').value = char.stats.speed || '';
            document.getElementById('size').value = char.stats.size || '';
            // profBonus, initiative, passivePerc/Inv/Ins sind computed
            document.getElementById('heroicBtn').classList.toggle('active', char.stats.heroicInsp);

            ABILITIES.forEach(ab => {
                document.getElementById(ab.id).value = (char.abilities && char.abilities[ab.id]) || '';
                // Mod und Save sind computed, nur Checkbox laden
                const saveProf = document.getElementById(ab.id + 'SaveProf');
                if (saveProf) saveProf.checked = (char.savesProf && char.savesProf[ab.id]) || false;
                ab.skills.forEach(sk => {
                    // Skill Value ist computed, nur Checkboxen laden
                    const prof = document.getElementById(sk + 'Prof');
                    if (prof) prof.checked = (char.skillsProf && char.skillsProf[sk]) || false;
                    const exp = document.getElementById(sk + 'Exp');
                    if (exp) exp.checked = (char.skillsExp && char.skillsExp[sk]) || false;
                });
            });

            document.getElementById('ac').value = char.combat.ac || '';
            document.getElementById('shield').value = char.combat.shield || '';
            document.getElementById('hpCurrent').value = char.combat.hpCurrent || '';
            document.getElementById('hpMax').value = char.combat.hpMax || '';
            document.getElementById('hpTemp').value = char.combat.hpTemp || '0';
            document.getElementById('hdCurrent').value = char.combat.hdCurrent || '';
            document.getElementById('hdMax').value = char.combat.hdMax || '';
            document.getElementById('exhaustion').value = char.combat.exhaustion || 0;
            updateExhaustion();
            document.getElementById('resistances').value = char.combat.resistances || '';
            document.getElementById('immunities').value = char.combat.immunities || '';
            document.getElementById('vulnerabilities').value = char.combat.vulnerabilities || '';

            document.getElementById('classFeatures').value = char.classFeatures || '';
            document.getElementById('armorLight').checked = char.training.armorLight || false;
            document.getElementById('armorMedium').checked = char.training.armorMedium || false;
            document.getElementById('armorHeavy').checked = char.training.armorHeavy || false;
            document.getElementById('armorShields').checked = char.training.armorShields || false;
            document.getElementById('weaponSimple').checked = char.training.weaponSimple || false;
            document.getElementById('weaponMartial').checked = char.training.weaponMartial || false;
            document.getElementById('weaponFirearms').checked = char.training.weaponFirearms || false;
            document.getElementById('weaponsText').value = char.training.weaponsText || '';
            document.getElementById('tools').value = char.training.tools || '';
            document.getElementById('speciesTraits').value = char.speciesTraits || '';
            document.getElementById('feats').value = char.feats || '';
            document.getElementById('senses').value = char.senses || '';

            document.getElementById('spellAbility').value = char.spellcasting.ability || '';
            // spellMod, spellDC, spellAttack werden automatisch berechnet via updateSpellStats()

            // Pact Slots
            if (char.pactSlots) {
                document.getElementById('pactLevel').value = char.pactSlots.level || '';
                document.getElementById('pactTotal').value = char.pactSlots.total || '';
                document.getElementById('pactExpended').value = char.pactSlots.expended || '';
            }

            document.getElementById('alignment').value = char.narrative.alignment || '';
            document.getElementById('physAge').value = char.narrative.physAge || '';
            document.getElementById('physHeight').value = char.narrative.physHeight || '';
            document.getElementById('physWeight').value = char.narrative.physWeight || '';
            document.getElementById('physEyes').value = char.narrative.physEyes || '';
            document.getElementById('physHair').value = char.narrative.physHair || '';
            document.getElementById('physSkin').value = char.narrative.physSkin || '';
            document.getElementById('appearance').value = char.narrative.appearance || '';
            document.getElementById('backstory').value = char.narrative.backstory || '';
            document.getElementById('languages').value = char.narrative.languages || '';
            document.getElementById('equipment').value = char.narrative.equipment || '';

            document.getElementById('cp').value = char.coins.cp || '';
            document.getElementById('sp').value = char.coins.sp || '';
            document.getElementById('ep').value = char.coins.ep || '';
            document.getElementById('gp').value = char.coins.gp || '';
            document.getElementById('pp').value = char.coins.pp || '';

            if (char.narrative.portrait) {
                document.getElementById('portraitImage').src = char.narrative.portrait;
                document.getElementById('portraitImage').style.display = 'block';
                document.getElementById('portraitPlaceholder').style.display = 'none';
                document.getElementById('portraitBox').classList.add('has-image');
            }

            initDeathSaves();
            initSpellSlots();
            initAttunement();
            renderWeapons();
            renderSpells();
            renderResources();
        }

        function loadChar() {
            try {
                const s = localStorage.getItem(STORAGE_KEY_OLD);
                if (s) {
                    const loaded = JSON.parse(s);
                    // Merge with default structure to ensure all properties exist
                    char = {
                        header: loaded.header || {},
                        stats: { heroicInsp: false, ...loaded.stats },
                        abilities: loaded.abilities || {},
                        saves: loaded.saves || {},
                        savesProf: loaded.savesProf || {},
                        skills: loaded.skills || {},
                        skillsProf: loaded.skillsProf || {},
                        skillsExp: loaded.skillsExp || {},
                        combat: loaded.combat || {},
                        deathSaves: loaded.deathSaves || { success: [false,false,false], fail: [false,false,false] },
                        weapons: loaded.weapons && loaded.weapons.length > 0 ? loaded.weapons : [{ name: '', bonus: '', damage: '', notes: '' }],
                        classResources: loaded.classResources && loaded.classResources.length > 0 ? loaded.classResources : [{ name: '', current: '', max: '' }],
                        classFeatures: loaded.classFeatures || '',
                        training: loaded.training || {},
                        speciesTraits: loaded.speciesTraits || '',
                        feats: loaded.feats || '',
                        spellcasting: loaded.spellcasting || {},
                        spellSlots: loaded.spellSlots || {},
                        spells: loaded.spells && loaded.spells.length > 0 ? loaded.spells : [{ name: '', level: '', prepared: false, notes: '' }],
                        narrative: loaded.narrative || {},
                        coins: loaded.coins || {},
                        attunement: loaded.attunement || [false, false, false]
                    };
                }
            } catch(e) {
                console.warn('Error loading character:', e);
            }
            populateFields();
        }

        function downloadJSON() {
            collectData();
            const b = new Blob([JSON.stringify(char, null, 2)], { type: 'application/json' });
            const a = document.createElement('a');
            a.href = URL.createObjectURL(b);
            a.download = `${char.header.name || 'Character'}.json`;
            a.click();
        }

        function uploadJSON(e) {
            const f = e.target.files[0];
            if (!f) return;
            const r = new FileReader();
            r.onload = ev => {
                try {
                    char = JSON.parse(ev.target.result);
                    populateFields();
                    autoSave();
                } catch(err) {
                    alert(t('error-loading-file'));
                }
            };
            r.readAsText(f);
        }

        function resetSheet() {
            if (!confirm(t('confirm-reset'))) return;
            localStorage.removeItem(STORAGE_KEY_OLD);
            // V2: Also delete from CharacterStorage if exists
            if (currentCharId && typeof CharacterStorage !== 'undefined') {
                CharacterStorage.delete(currentCharId);
            }
            // Redirect to new character instead of reload
            window.location.href = 'sheet-5e.html?new=true';
        }

        // GM View
        async function initGMView() {
            const u = getCurrentUser();
            isGM = u?.isGM || false;
            if (typeof initFirebase === 'function') await initFirebase();
            if (isGM && typeof isFirebaseOnline === 'function' && isFirebaseOnline()) {
                createPlayerBar();
                loadPlayers();
            }
        }

        function createPlayerBar() {
            if (document.querySelector('.player-bar')) return;
            const b = document.createElement('div');
            b.className = 'player-bar';
            b.innerHTML = `<span class="player-bar-label">Players:</span>`;
            // Insert at start of sheet, not body
            const sheet = document.querySelector('.sheet');
            sheet.insertBefore(b, sheet.firstChild);
        }

        async function loadPlayers() {
            getRef('players').on('value', snap => {
                const ps = snap.val() || {};
                const b = document.querySelector('.player-bar');
                if (!b) return;
                
                const currentUser = getCurrentUser();
                const userColor = currentUser?.color || '#6750a4';
                
                b.innerHTML = `<span class="player-bar-label">Players:</span>`;
                
                // Own character button
                const ob = document.createElement('button');
                ob.className = 'player-tab own' + (!viewingPlayer ? ' active' : '');
                ob.innerHTML = `<span class="player-tab-dot" style="background: ${userColor}"></span> Eigener Charakter`;
                ob.onclick = () => { viewingPlayer = null; loadChar(); enableEdit(); updatePB(); removeGMBanner(); };
                b.appendChild(ob);
                
                // Other players
                Object.entries(ps).forEach(([n, d]) => {
                    if (d.isGM) return;
                    if (n === currentUser?.username) return; // Skip self
                    
                    const btn = document.createElement('button');
                    btn.className = 'player-tab' + (viewingPlayer === n ? ' active' : '');
                    btn.innerHTML = `<span class="player-tab-dot" style="background: ${d.color || '#888'}"></span> ${n}`;
                    btn.onclick = () => viewPlayer(n);
                    b.appendChild(btn);
                });
            });
        }

        function updatePB() {
            document.querySelectorAll('.player-tab').forEach(b => {
                const isOwn = b.classList.contains('own');
                const isActive = (!viewingPlayer && isOwn) || b.textContent.includes(viewingPlayer);
                b.classList.toggle('active', isActive);
            });
        }

        async function viewPlayer(n) {
            viewingPlayer = n;
            updatePB();
            showGMBanner(n);
            const snap = await getRef(`characters/${sanitizeKey(n)}`).once('value');
            if (snap.val()) { char = snap.val(); populateFields(); }
            disableEdit();
        }

        function showGMBanner(n) {
            removeGMBanner();
            const b = document.createElement('div');
            b.className = 'gm-banner';
            b.innerHTML = `<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/></svg> Viewing: <strong>${n}</strong> (read-only)`;
            // Insert after player-bar in sheet
            const playerBar = document.querySelector('.player-bar');
            if (playerBar) {
                playerBar.after(b);
            } else {
                const sheet = document.querySelector('.sheet');
                sheet.insertBefore(b, sheet.firstChild);
            }
        }

        function removeGMBanner() { document.querySelector('.gm-banner')?.remove(); }
        function enableEdit() { document.querySelectorAll('input, textarea, select').forEach(el => el.disabled = false); }
        function disableEdit() { document.querySelectorAll('input, textarea, select').forEach(el => el.disabled = true); }

        function listenForCatalogChanges() {
            if (typeof getRef === 'function' && typeof isFirebaseOnline === 'function' && isFirebaseOnline()) {
                getRef('settings/catalog').on('value', snap => {
                    const c = snap.val();
                    if (c) {
                        const cur = localStorage.getItem('rift_active_catalog');
                        localStorage.setItem('rift_active_catalog', c);
                        if (cur && cur !== c) {
                            const sh = {
                                'none': 'charakterbogen.html',
                                'rum-und-rache': 'charakterbogen_rumundrache.html',
                                '5e-2024': 'charakterbogen_5e_2024.html',
                                'neon-abyss': 'charakterbogen.html',
                                'basis': 'charakterbogen_basis.html'
                            };
                            window.location.href = sh[c] || 'charakterbogen.html';
                        }
                    }
                });
            }
        }

        setTimeout(initGMView, 100);
        // Footer handled by initLayout()
        if (typeof initFirebase === 'function') initFirebase().then(() => listenForCatalogChanges()).catch(() => {});

        // ===== TOOLTIP SYSTEM =====
        const tooltipData = {
            'proficiency': {
                title: { en: 'Proficiency Bonus', de: 'Übungsbonus' },
                text: { 
                    en: 'A bonus you add to things you\'re trained in. It increases as you level up. At level 1 it\'s +2, at level 5 it\'s +3, and so on.',
                    de: 'Ein Bonus, den du auf Dinge addierst, in denen du geübt bist. Er steigt mit deiner Stufe. Auf Stufe 1 ist er +2, auf Stufe 5 ist er +3, usw.'
                },
                example: {
                    en: '<strong>Example:</strong> If you\'re proficient in Stealth and have +3 DEX, your Stealth is +3 (DEX) + 2 (Prof) = +5',
                    de: '<strong>Beispiel:</strong> Bei Übung in Heimlichkeit mit +3 DEX ist dein Bonus +3 (DEX) + 2 (Übung) = +5'
                }
            },
            'saving-throw': {
                title: { en: 'Saving Throw', de: 'Rettungswurf' },
                text: { 
                    en: 'A roll to resist or avoid something bad - like dodging a fireball (DEX save) or resisting poison (CON save). You add your ability modifier, and proficiency if trained.',
                    de: 'Ein Wurf um etwas Schlechtem zu widerstehen oder auszuweichen - wie einem Feuerball (DEX-Rettung) oder Gift (CON-Rettung). Du addierst deinen Attributsmodifikator und Übungsbonus wenn geübt.'
                },
                example: {
                    en: '<strong>Example:</strong> A dragon breathes fire! Roll d20 + DEX modifier. Beat the DC to take half damage.',
                    de: '<strong>Beispiel:</strong> Ein Drache speit Feuer! Würfle W20 + DEX-Modifikator. Übertreffe den SG für halben Schaden.'
                }
            },
            'skill-check': {
                title: { en: 'Skill Check / Passive Score', de: 'Fertigkeitsprobe / Passiver Wert' },
                text: { 
                    en: 'When you try to do something, you roll d20 + the relevant skill modifier. The DM sets a DC (Difficulty Class) you need to beat. Passive = 10 + modifier.',
                    de: 'Wenn du etwas versuchst, würfelst du W20 + relevanten Fertigkeitsmodifikator. Der SL setzt einen SG (Schwierigkeitsgrad) den du übertreffen musst. Passiv = 10 + Modifikator.'
                },
                example: {
                    en: '<strong>Easy:</strong> DC 10 | <strong>Medium:</strong> DC 15 | <strong>Hard:</strong> DC 20 | <strong>Very Hard:</strong> DC 25',
                    de: '<strong>Leicht:</strong> SG 10 | <strong>Mittel:</strong> SG 15 | <strong>Schwer:</strong> SG 20 | <strong>Sehr schwer:</strong> SG 25'
                }
            },
            'armor-class': {
                title: { en: 'Armor Class (AC)', de: 'Rüstungsklasse (RK)' },
                text: { 
                    en: 'How hard you are to hit. Attackers must roll this number or higher to hit you. Base AC is 10 + DEX modifier, but armor can change this.',
                    de: 'Wie schwer du zu treffen bist. Angreifer müssen diese Zahl oder höher würfeln um dich zu treffen. Basis-RK ist 10 + DEX-Modifikator, Rüstung kann das ändern.'
                },
                example: {
                    en: '<strong>Unarmored:</strong> 10 + DEX<br><strong>Light Armor:</strong> Armor + DEX<br><strong>Heavy Armor:</strong> Armor only (no DEX)',
                    de: '<strong>Ungerüstet:</strong> 10 + DEX<br><strong>Leichte Rüstung:</strong> Rüstung + DEX<br><strong>Schwere Rüstung:</strong> Nur Rüstung (kein DEX)'
                }
            },
            'hit-points': {
                title: { en: 'Hit Points (HP)', de: 'Trefferpunkte (TP)' },
                text: { 
                    en: 'Your health. At 0 HP you fall unconscious and start making death saves. You regain HP by resting, healing spells, or potions.',
                    de: 'Deine Gesundheit. Bei 0 TP wirst du bewusstlos und machst Todesrettungswürfe. Du regenerierst TP durch Rasten, Heilzauber oder Tränke.'
                },
                example: {
                    en: '<strong>Level 1 HP:</strong> Max hit die + CON modifier<br><strong>Fighter:</strong> 10 + CON | <strong>Wizard:</strong> 6 + CON',
                    de: '<strong>Stufe 1 TP:</strong> Max. Trefferwürfel + CON-Mod.<br><strong>Kämpfer:</strong> 10 + CON | <strong>Magier:</strong> 6 + CON'
                }
            },
            'temp-hp': {
                title: { en: 'Temporary Hit Points', de: 'Temporäre Trefferpunkte' },
                text: { 
                    en: 'Extra HP that goes away first when you take damage. They don\'t stack - if you get new temp HP, choose which to keep. They vanish after a long rest.',
                    de: 'Extra TP die zuerst verbraucht werden bei Schaden. Sie stapeln nicht - bei neuen temp. TP wähle welche du behältst. Sie verschwinden nach einer langen Rast.'
                },
                example: {
                    en: '<strong>Example:</strong> You have 20 HP and gain 10 temp HP. An enemy deals 15 damage. Your temp HP absorbs 10, then you lose 5 regular HP.',
                    de: '<strong>Beispiel:</strong> Du hast 20 TP und erhältst 10 temp. TP. Ein Feind macht 15 Schaden. Temp. TP absorbieren 10, dann verlierst du 5 normale TP.'
                }
            },
            'hit-dice': {
                title: { en: 'Hit Dice', de: 'Trefferwürfel' },
                text: { 
                    en: 'Dice you can spend during a short rest to heal. Roll the die + CON modifier to regain HP. You get one hit die per level, and recover half on a long rest.',
                    de: 'Würfel die du während einer kurzen Rast ausgeben kannst um zu heilen. Würfle + CON-Mod. um TP zu regenerieren. Du hast einen pro Stufe, erholst die Hälfte bei langer Rast.'
                },
                example: {
                    en: '<strong>Die by Class:</strong> d6 (Wizard), d8 (Rogue, Bard), d10 (Fighter, Ranger), d12 (Barbarian)',
                    de: '<strong>Würfel nach Klasse:</strong> W6 (Magier), W8 (Schurke, Barde), W10 (Kämpfer, Waldläufer), W12 (Barbar)'
                }
            },
            'initiative': {
                title: { en: 'Initiative', de: 'Initiative' },
                text: { 
                    en: 'Determines turn order in combat. At the start of a fight, everyone rolls d20 + DEX modifier. Highest goes first.',
                    de: 'Bestimmt die Zugreihenfolge im Kampf. Zu Beginn würfelt jeder W20 + DEX-Modifikator. Höchster beginnt.'
                },
                example: {
                    en: '<strong>Tip:</strong> Having a high DEX helps you act earlier in combat, which can be crucial!',
                    de: '<strong>Tipp:</strong> Hohe DEX hilft dir früher im Kampf zu handeln, was entscheidend sein kann!'
                }
            },
            'speed': {
                title: { en: 'Speed', de: 'Bewegungsrate' },
                text: { 
                    en: 'How far you can move in one turn, measured in feet. Most races have 30 ft. You can split movement before and after actions.',
                    de: 'Wie weit du dich in einem Zug bewegen kannst, in Fuß gemessen (1 Feld = 5 ft). Die meisten Völker haben 30 ft. Du kannst Bewegung vor und nach Aktionen aufteilen.'
                },
                example: {
                    en: '<strong>Common:</strong> Human 30 ft, Dwarf 25 ft, Elf 30 ft, Wood Elf 35 ft',
                    de: '<strong>Üblich:</strong> Mensch 30 ft, Zwerg 25 ft, Elf 30 ft, Waldelf 35 ft'
                }
            },
            'heroic-inspiration': {
                title: { en: 'Heroic Inspiration', de: 'Heldische Inspiration' },
                text: { 
                    en: 'A special resource you can spend to reroll any d20 roll. You either have it or you don\'t - it doesn\'t stack. DM awards it for great roleplay.',
                    de: 'Eine besondere Ressource um einen W20-Wurf zu wiederholen. Du hast sie oder nicht - sie stapelt nicht. Der SL vergibt sie für gutes Rollenspiel.'
                },
                example: {
                    en: '<strong>Usage:</strong> After rolling, say "I use my Heroic Inspiration" and roll again. You must use the new result.',
                    de: '<strong>Nutzung:</strong> Nach dem Würfeln sagst du "Ich nutze meine Heldische Inspiration" und würfelst neu. Du musst das neue Ergebnis verwenden.'
                }
            },
            'spell-dc': {
                title: { en: 'Spell Save DC', de: 'Zauber-Rettungswurf-SG' },
                text: { 
                    en: 'The difficulty for enemies to resist your spells. They must roll their saving throw against this number.',
                    de: 'Der Schwierigkeitsgrad für Feinde um deinen Zaubern zu widerstehen. Sie müssen ihren Rettungswurf gegen diese Zahl machen.'
                },
                example: {
                    en: '<strong>Formula:</strong> 8 + Proficiency + Spellcasting Ability Modifier',
                    de: '<strong>Formel:</strong> 8 + Übungsbonus + Zauberattributs-Modifikator'
                }
            },
            'spell-attack': {
                title: { en: 'Spell Attack Bonus', de: 'Zauberangriffsbonus' },
                text: { 
                    en: 'Added to d20 when you cast a spell that requires an attack roll (like Fire Bolt). You need to beat the target\'s AC.',
                    de: 'Wird zu W20 addiert wenn du einen Zauber wirkst der einen Angriffswurf erfordert (wie Feuerblitz). Du musst die RK des Ziels übertreffen.'
                },
                example: {
                    en: '<strong>Formula:</strong> Proficiency + Spellcasting Ability Modifier',
                    de: '<strong>Formel:</strong> Übungsbonus + Zauberattributs-Modifikator'
                }
            },
            'spell-mod': {
                title: { en: 'Spellcasting Modifier', de: 'Zaubermodifikator' },
                text: { 
                    en: 'The ability modifier you add to spell damage and effects. Based on your spellcasting ability.',
                    de: 'Der Attributsmodifikator den du zu Zauberschaden und -effekten addierst. Basiert auf deinem Zauberattribut.'
                },
                example: {
                    en: '<strong>Example:</strong> A Wizard with 16 INT has a +3 spellcasting modifier.',
                    de: '<strong>Beispiel:</strong> Ein Magier mit 16 INT hat einen +3 Zaubermodifikator.'
                }
            },
            'spell-ability': {
                title: { en: 'Spellcasting Ability', de: 'Zauberattribut' },
                text: { 
                    en: 'The ability score that powers your magic. Different classes use different abilities.',
                    de: 'Das Attribut das deine Magie antreibt. Verschiedene Klassen nutzen verschiedene Attribute.'
                },
                example: {
                    en: '<strong>INT:</strong> Wizard<br><strong>WIS:</strong> Cleric, Druid, Ranger<br><strong>CHA:</strong> Bard, Paladin, Sorcerer, Warlock',
                    de: '<strong>INT:</strong> Magier<br><strong>WIS:</strong> Kleriker, Druide, Waldläufer<br><strong>CHA:</strong> Barde, Paladin, Zauberer, Hexenmeister'
                }
            },
            'death-saves': {
                title: { en: 'Death Saving Throws', de: 'Todesrettungswürfe' },
                text: { 
                    en: 'At 0 HP, roll d20 each turn. 10+ is a success, 9 or less is a failure. 3 successes = stabilize. 3 failures = death. Natural 20 = wake up with 1 HP!',
                    de: 'Bei 0 TP würfelst du jeden Zug W20. 10+ ist Erfolg, 9 oder weniger Misserfolg. 3 Erfolge = stabilisiert. 3 Misserfolge = Tod. Natürliche 20 = aufwachen mit 1 TP!'
                },
                example: {
                    en: '<strong>Critical:</strong> Rolling a 1 counts as 2 failures. Rolling a 20 wakes you up with 1 HP!',
                    de: '<strong>Kritisch:</strong> Eine 1 zählt als 2 Misserfolge. Eine 20 weckt dich mit 1 TP auf!'
                }
            },
            'exhaustion': {
                title: { en: 'Exhaustion', de: 'Erschöpfung' },
                text: { 
                    en: 'A condition that stacks from 1-6. Each level subtracts from your d20 rolls. At level 6, you die. Removed by long rests (1 level per rest).',
                    de: 'Ein Zustand der von 1-6 stapelt. Jede Stufe wird von deinen W20-Würfen abgezogen. Bei Stufe 6 stirbst du. Wird durch lange Rasten entfernt (1 Stufe pro Rast).'
                },
                example: {
                    en: '<strong>Level 1-5:</strong> -1 to -5 on d20 rolls<br><strong>Level 6:</strong> Death',
                    de: '<strong>Stufe 1-5:</strong> -1 bis -5 auf W20-Würfe<br><strong>Stufe 6:</strong> Tod'
                }
            },
            'concentration': {
                title: { en: 'Concentration', de: 'Konzentration' },
                text: { 
                    en: 'Some spells require focus to maintain. If you take damage, roll CON save (DC 10 or half damage, whichever is higher) or lose the spell.',
                    de: 'Manche Zauber erfordern Fokus um aufrechterhalten zu werden. Bei Schaden würfle CON-Rettung (SG 10 oder halber Schaden, was höher ist) oder verliere den Zauber.'
                },
                example: {
                    en: '<strong>Tip:</strong> You can only concentrate on ONE spell at a time. Casting a new concentration spell ends the previous one.',
                    de: '<strong>Tipp:</strong> Du kannst nur auf EINEN Zauber gleichzeitig konzentrieren. Ein neuer Konzentrationszauber beendet den vorherigen.'
                }
            },
            'weapon-attack': {
                title: { en: 'Weapon Attack', de: 'Waffenangriff' },
                text: { 
                    en: 'Roll d20 + ability modifier + proficiency (if proficient). Melee uses STR, ranged uses DEX. Finesse weapons can use either.',
                    de: 'Würfle W20 + Attributsmodifikator + Übung (wenn geübt). Nahkampf nutzt STR, Fernkampf nutzt DEX. Finesse-Waffen können beides.'
                },
                example: {
                    en: '<strong>Attack:</strong> d20 + STR/DEX + Prof<br><strong>Damage:</strong> Weapon die + STR/DEX modifier',
                    de: '<strong>Angriff:</strong> W20 + STR/DEX + Übung<br><strong>Schaden:</strong> Waffenwürfel + STR/DEX-Mod.'
                }
            },
            'spell-slots': {
                title: { en: 'Spell Slots', de: 'Zauberplätze' },
                text: { 
                    en: 'Resources you spend to cast spells. Higher level slots can cast lower level spells at increased power. Recover on long rest (or short rest for Warlocks).',
                    de: 'Ressourcen die du ausgibst um Zauber zu wirken. Höhere Plätze können niedrigere Zauber mit mehr Macht wirken. Erholung bei langer Rast (kurze Rast für Hexenmeister).'
                },
                example: {
                    en: '<strong>Upcasting:</strong> Cast Cure Wounds with a 2nd-level slot to heal an extra 1d8!',
                    de: '<strong>Hochstufen:</strong> Wirke Wunden heilen mit einem Platz der 2. Stufe für 1W8 extra Heilung!'
                }
            },
            'pact-slots': {
                title: { en: 'Pact Magic (Warlock)', de: 'Paktmagie (Hexenmeister)' },
                text: { 
                    en: 'Warlock spell slots are different: fewer slots, but they\'re always at your highest level and recover on SHORT rest.',
                    de: 'Hexenmeister-Zauberplätze sind anders: weniger Plätze, aber immer auf höchster Stufe und Erholung bei KURZER Rast.'
                },
                example: {
                    en: '<strong>Example:</strong> A level 5 Warlock has 2 slots, both at 3rd level. Both recover after just 1 hour!',
                    de: '<strong>Beispiel:</strong> Ein Hexenmeister Stufe 5 hat 2 Plätze, beide auf 3. Stufe. Beide erholen sich nach nur 1 Stunde!'
                }
            },
            'cantrip': {
                title: { en: 'Cantrips', de: 'Zaubertricks' },
                text: { 
                    en: 'Simple spells you can cast unlimited times without using spell slots. They scale with your character level, not class level.',
                    de: 'Einfache Zauber die du unbegrenzt wirken kannst ohne Zauberplätze. Sie skalieren mit deiner Charakterstufe, nicht Klassenstufe.'
                },
                example: {
                    en: '<strong>Scaling:</strong> Fire Bolt does 1d10 at level 1, 2d10 at level 5, 3d10 at level 11, 4d10 at level 17',
                    de: '<strong>Skalierung:</strong> Feuerblitz macht 1W10 auf Stufe 1, 2W10 auf Stufe 5, 3W10 auf Stufe 11, 4W10 auf Stufe 17'
                }
            },
            'prepared-spells': {
                title: { en: 'Prepared Spells', de: 'Vorbereitete Zauber' },
                text: { 
                    en: 'Some classes (Cleric, Druid, Paladin, Wizard) must prepare spells after a long rest. You can prepare a number equal to ability modifier + class level.',
                    de: 'Manche Klassen (Kleriker, Druide, Paladin, Magier) müssen Zauber nach einer langen Rast vorbereiten. Anzahl = Attributsmod. + Klassenstufe.'
                },
                example: {
                    en: '<strong>Bard, Ranger, Sorcerer, Warlock:</strong> Don\'t prepare - they know a fixed number of spells.',
                    de: '<strong>Barde, Waldläufer, Zauberer, Hexenmeister:</strong> Bereiten nicht vor - sie kennen eine feste Anzahl Zauber.'
                }
            },
            'class-features': {
                title: { en: 'Class Features', de: 'Klassenmerkmale' },
                text: { 
                    en: 'Special abilities granted by your class at certain levels. Check your class description for what you get and when.',
                    de: 'Besondere Fähigkeiten die deine Klasse auf bestimmten Stufen gewährt. Prüfe deine Klassenbeschreibung für was du wann bekommst.'
                },
                example: {
                    en: '<strong>Examples:</strong> Fighter\'s Action Surge, Rogue\'s Sneak Attack, Wizard\'s Arcane Recovery',
                    de: '<strong>Beispiele:</strong> Kämpfers Aktionsschub, Schurkes Hinterhältiger Angriff, Magiers Arkane Erholung'
                }
            },
            'class-resources': {
                title: { en: 'Class Resources', de: 'Klassenressourcen' },
                text: { 
                    en: 'Limited-use abilities that recharge on short or long rest. Track your uses here.',
                    de: 'Fähigkeiten mit begrenzter Nutzung die sich bei kurzer oder langer Rast erholen. Verfolge deine Nutzungen hier.'
                },
                example: {
                    en: '<strong>Examples:</strong> Rage (Barbarian), Ki Points (Monk), Sorcery Points (Sorcerer), Bardic Inspiration (Bard)',
                    de: '<strong>Beispiele:</strong> Wut (Barbar), Ki-Punkte (Mönch), Zauberpunkte (Zauberer), Bardische Inspiration (Barde)'
                }
            },
            'training': {
                title: { en: 'Armor & Weapon Training', de: 'Rüstungs- & Waffentraining' },
                text: { 
                    en: 'What armor and weapons you can use effectively. Without proficiency, you have disadvantage on attacks and can\'t cast spells in armor.',
                    de: 'Welche Rüstungen und Waffen du effektiv nutzen kannst. Ohne Übung hast du Nachteil auf Angriffe und kannst keine Zauber in Rüstung wirken.'
                },
                example: {
                    en: '<strong>Light:</strong> Leather, Studded<br><strong>Medium:</strong> Chain Shirt, Breastplate<br><strong>Heavy:</strong> Chain Mail, Plate',
                    de: '<strong>Leicht:</strong> Leder, Beschlagenes Leder<br><strong>Mittel:</strong> Kettenhemd, Brustplatte<br><strong>Schwer:</strong> Kettenpanzer, Plattenpanzer'
                }
            },
            'species-traits': {
                title: { en: 'Species Traits', de: 'Volksmerkmale' },
                text: { 
                    en: 'Abilities granted by your species (race). These include things like darkvision, resistances, and special abilities.',
                    de: 'Fähigkeiten die dein Volk (Rasse) gewährt. Dazu gehören Dunkelsicht, Resistenzen und besondere Fähigkeiten.'
                },
                example: {
                    en: '<strong>Examples:</strong> Elf\'s Darkvision & Trance, Dwarf\'s Poison Resistance, Tiefling\'s Fire Resistance',
                    de: '<strong>Beispiele:</strong> Elfen-Dunkelsicht & Trance, Zwergen-Giftresistenz, Tiefling-Feuerresistenz'
                }
            },
            'feats': {
                title: { en: 'Feats', de: 'Talente' },
                text: { 
                    en: 'Optional special abilities you can take instead of ability score increases at certain levels. Ask your DM if feats are allowed.',
                    de: 'Optionale spezielle Fähigkeiten die du statt Attributserhöhungen auf bestimmten Stufen nehmen kannst. Frage deinen SL ob Talente erlaubt sind.'
                },
                example: {
                    en: '<strong>Popular:</strong> Lucky, Sentinel, Great Weapon Master, Sharpshooter, War Caster',
                    de: '<strong>Beliebt:</strong> Glückspilz, Wächter, Waffenmeister (Groß), Scharfschütze, Kriegszauberer'
                }
            },
            'attunement': {
                title: { en: 'Attunement', de: 'Einstimmung' },
                text: { 
                    en: 'Some magic items require attunement to use. You can only be attuned to 3 items at a time. Attunement takes a short rest.',
                    de: 'Manche magische Gegenstände erfordern Einstimmung zur Nutzung. Du kannst nur auf 3 Gegenstände gleichzeitig eingestimmt sein. Einstimmung dauert eine kurze Rast.'
                },
                example: {
                    en: '<strong>Check item description:</strong> "Requires Attunement" or "Requires Attunement by a Spellcaster"',
                    de: '<strong>Prüfe Gegenstandsbeschreibung:</strong> "Erfordert Einstimmung" oder "Erfordert Einstimmung durch einen Zauberwirker"'
                }
            }
        };

        function showTooltip(key, element) {
            const data = tooltipData[key];
            if (!data) return;
            
            const lang = getLang();
            const popup = document.getElementById('tooltipPopup');
            document.getElementById('tooltipTitle').textContent = data.title[lang] || data.title.en;
            document.getElementById('tooltipText').textContent = data.text[lang] || data.text.en;
            
            const exampleEl = document.getElementById('tooltipExample');
            if (data.example) {
                exampleEl.innerHTML = data.example[lang] || data.example.en;
                exampleEl.style.display = 'block';
            } else {
                exampleEl.style.display = 'none';
            }
            
            // Position near the element
            const rect = element.getBoundingClientRect();
            popup.style.left = Math.min(rect.right + 10, window.innerWidth - 340) + 'px';
            popup.style.top = Math.max(rect.top - 20, 10) + 'px';
            popup.classList.add('visible');
        }

        function hideTooltip() {
            document.getElementById('tooltipPopup').classList.remove('visible');
        }

        // ===== RULES REFERENCE POPUP =====
        const rulesData = {
            'str': {
                title: { en: 'Strength (STR)', de: 'Stärke (STR)' },
                content: {
                    en: `<p><strong>Strength</strong> measures physical power and athletic ability.</p>
                    <p>Used for: Melee weapon attacks, carrying capacity, breaking things, grappling.</p>
                    <p><strong>Skills:</strong> Athletics</p>
                    <p><strong>Common Saves:</strong> Resisting being pushed, grappled, or restrained.</p>
                    <div class="rules-popup-example"><h4>Example Uses</h4>
                    <p>• Swing a greatsword at an enemy<br>• Break down a door<br>• Climb a cliff without rope<br>• Win an arm wrestling contest</p></div>`,
                    de: `<p><strong>Stärke</strong> misst körperliche Kraft und Athletik.</p>
                    <p>Verwendet für: Nahkampfangriffe, Tragkraft, Dinge zerbrechen, Ringen.</p>
                    <p><strong>Fertigkeiten:</strong> Athletik</p>
                    <p><strong>Typische Rettungswürfe:</strong> Widerstehen gegen Schubsen, Festhalten oder Fesseln.</p>
                    <div class="rules-popup-example"><h4>Beispiele</h4>
                    <p>• Mit einem Großschwert zuschlagen<br>• Eine Tür eintreten<br>• Eine Klippe ohne Seil erklimmen<br>• Armdrücken gewinnen</p></div>`
                }
            },
            'dex': {
                title: { en: 'Dexterity (DEX)', de: 'Geschicklichkeit (DEX)' },
                content: {
                    en: `<p><strong>Dexterity</strong> measures agility, reflexes, and balance.</p>
                    <p>Used for: Ranged attacks, finesse weapons, AC, initiative, dodging.</p>
                    <p><strong>Skills:</strong> Acrobatics, Sleight of Hand, Stealth</p>
                    <p><strong>Common Saves:</strong> Dodging fireballs, traps, and area effects.</p>
                    <div class="rules-popup-example"><h4>Example Uses</h4>
                    <p>• Fire a bow accurately<br>• Pick a lock<br>• Sneak past guards<br>• Catch yourself when falling</p></div>`,
                    de: `<p><strong>Geschicklichkeit</strong> misst Agilität, Reflexe und Balance.</p>
                    <p>Verwendet für: Fernkampfangriffe, Finesse-Waffen, RK, Initiative, Ausweichen.</p>
                    <p><strong>Fertigkeiten:</strong> Akrobatik, Fingerfertigkeit, Heimlichkeit</p>
                    <p><strong>Typische Rettungswürfe:</strong> Feuerbällen, Fallen und Flächeneffekten ausweichen.</p>
                    <div class="rules-popup-example"><h4>Beispiele</h4>
                    <p>• Präzise mit einem Bogen schießen<br>• Ein Schloss knacken<br>• An Wachen vorbeischleichen<br>• Sich beim Fallen abfangen</p></div>`
                }
            },
            'con': {
                title: { en: 'Constitution (CON)', de: 'Konstitution (CON)' },
                content: {
                    en: `<p><strong>Constitution</strong> measures health, stamina, and vital force.</p>
                    <p>Used for: Hit points, concentration checks, endurance.</p>
                    <p><strong>Skills:</strong> None directly</p>
                    <p><strong>Common Saves:</strong> Resisting poison, disease, and exhaustion.</p>
                    <div class="rules-popup-example"><h4>Why It Matters</h4>
                    <p>Your HP = Hit Die + CON modifier per level. A Fighter with +3 CON gets 13 HP at level 1 (10 + 3) instead of 10!</p></div>`,
                    de: `<p><strong>Konstitution</strong> misst Gesundheit, Ausdauer und Lebenskraft.</p>
                    <p>Verwendet für: Trefferpunkte, Konzentrationsprüfungen, Ausdauer.</p>
                    <p><strong>Fertigkeiten:</strong> Keine direkt</p>
                    <p><strong>Typische Rettungswürfe:</strong> Gift, Krankheiten und Erschöpfung widerstehen.</p>
                    <div class="rules-popup-example"><h4>Warum es wichtig ist</h4>
                    <p>Deine TP = Trefferwürfel + CON-Mod. pro Stufe. Ein Kämpfer mit +3 CON hat 13 TP auf Stufe 1 (10 + 3) statt 10!</p></div>`
                }
            },
            'int': {
                title: { en: 'Intelligence (INT)', de: 'Intelligenz (INT)' },
                content: {
                    en: `<p><strong>Intelligence</strong> measures reasoning, memory, and analytical skill.</p>
                    <p>Used for: Wizards' spellcasting, recalling lore, investigation.</p>
                    <p><strong>Skills:</strong> Arcana, History, Investigation, Nature, Religion</p>
                    <p><strong>Common Saves:</strong> Resisting illusions and mental detection.</p>
                    <div class="rules-popup-example"><h4>Example Uses</h4>
                    <p>• Identify a magic item<br>• Remember historical facts<br>• Search for clues<br>• Decode a cipher</p></div>`,
                    de: `<p><strong>Intelligenz</strong> misst Logik, Gedächtnis und analytisches Denken.</p>
                    <p>Verwendet für: Magierwirken, Wissen abrufen, Ermittlung.</p>
                    <p><strong>Fertigkeiten:</strong> Arkane Kunde, Geschichte, Nachforschungen, Naturkunde, Religion</p>
                    <p><strong>Typische Rettungswürfe:</strong> Illusionen und mentaler Erkennung widerstehen.</p>
                    <div class="rules-popup-example"><h4>Beispiele</h4>
                    <p>• Einen magischen Gegenstand identifizieren<br>• Historische Fakten erinnern<br>• Nach Hinweisen suchen<br>• Einen Code entschlüsseln</p></div>`
                }
            },
            'wis': {
                title: { en: 'Wisdom (WIS)', de: 'Weisheit (WIS)' },
                content: {
                    en: `<p><strong>Wisdom</strong> measures perception, intuition, and willpower.</p>
                    <p>Used for: Clerics/Druids/Rangers spellcasting, noticing things, insight.</p>
                    <p><strong>Skills:</strong> Animal Handling, Insight, Medicine, Perception, Survival</p>
                    <p><strong>Common Saves:</strong> Resisting charm, fear, and mind control.</p>
                    <div class="rules-popup-example"><h4>Example Uses</h4>
                    <p>• Notice a hidden enemy<br>• Sense someone is lying<br>• Track creatures in the wild<br>• Stabilize a dying ally</p></div>`,
                    de: `<p><strong>Weisheit</strong> misst Wahrnehmung, Intuition und Willenskraft.</p>
                    <p>Verwendet für: Kleriker/Druiden/Waldläufer-Wirken, Dinge bemerken, Einsicht.</p>
                    <p><strong>Fertigkeiten:</strong> Mit Tieren umgehen, Motiv erkennen, Heilkunde, Wahrnehmung, Überlebenskunst</p>
                    <p><strong>Typische Rettungswürfe:</strong> Bezauberung, Furcht und Gedankenkontrolle widerstehen.</p>
                    <div class="rules-popup-example"><h4>Beispiele</h4>
                    <p>• Einen versteckten Feind bemerken<br>• Spüren dass jemand lügt<br>• Kreaturen in der Wildnis verfolgen<br>• Einen sterbenden Verbündeten stabilisieren</p></div>`
                }
            },
            'cha': {
                title: { en: 'Charisma (CHA)', de: 'Charisma (CHA)' },
                content: {
                    en: `<p><strong>Charisma</strong> measures force of personality and social influence.</p>
                    <p>Used for: Bards/Paladins/Sorcerers/Warlocks spellcasting, social interactions.</p>
                    <p><strong>Skills:</strong> Deception, Intimidation, Performance, Persuasion</p>
                    <p><strong>Common Saves:</strong> Resisting banishment and possession.</p>
                    <div class="rules-popup-example"><h4>Example Uses</h4>
                    <p>• Convince a guard to let you pass<br>• Intimidate an enemy into surrendering<br>• Perform music for a crowd<br>• Tell a convincing lie</p></div>`,
                    de: `<p><strong>Charisma</strong> misst Persönlichkeitsstärke und sozialen Einfluss.</p>
                    <p>Verwendet für: Barden/Paladine/Zauberer/Hexenmeister-Wirken, soziale Interaktionen.</p>
                    <p><strong>Fertigkeiten:</strong> Täuschen, Einschüchtern, Auftreten, Überzeugen</p>
                    <p><strong>Typische Rettungswürfe:</strong> Verbannung und Besessenheit widerstehen.</p>
                    <div class="rules-popup-example"><h4>Beispiele</h4>
                    <p>• Eine Wache überzeugen dich durchzulassen<br>• Einen Feind zur Aufgabe einschüchtern<br>• Musik für ein Publikum spielen<br>• Eine überzeugende Lüge erzählen</p></div>`
                }
            }
        };

        function showRulesPopup(key, element) {
            const data = rulesData[key];
            if (!data) return;
            
            const lang = getLang();
            const popup = document.getElementById('rulesPopup');
            document.getElementById('rulesTitle').textContent = data.title[lang] || data.title.en;
            document.getElementById('rulesBody').innerHTML = data.content[lang] || data.content.en;
            
            const rect = element.getBoundingClientRect();
            popup.style.left = Math.min(rect.right + 15, window.innerWidth - 400) + 'px';
            popup.style.top = Math.max(rect.top, 10) + 'px';
            popup.classList.add('visible');
        }

        function closeRulesPopup() {
            document.getElementById('rulesPopup').classList.remove('visible');
        }

        // Close popups when clicking outside
        document.addEventListener('click', function(e) {
            if (!e.target.closest('.rules-popup') && !e.target.closest('.rules-link') && !e.target.closest('.help-icon')) {
                closeRulesPopup();
                hideTooltip();
            }
        });

        // ===== CHARACTER WIZARD =====
        let wizardStep = 1;
        const wizardData = {
            name: '',
            level: 1,
            species: '',
            class: '',
            background: '',
            str: 10, dex: 10, con: 10, int: 10, wis: 10, cha: 10
        };

        function openWizard() {
            wizardStep = 1;
            wizardData.name = '';
            wizardData.level = 1;
            wizardData.species = '';
            wizardData.class = '';
            wizardData.background = '';
            document.getElementById('wizardName').value = '';
            document.getElementById('wizardLevel').value = 1;
            document.querySelectorAll('.wizard-option').forEach(o => o.classList.remove('selected'));
            updateWizardStep();
            document.getElementById('wizardModal').classList.add('active');
        }

        function closeWizard() {
            document.getElementById('wizardModal').classList.remove('active');
        }

        function updateWizardStep() {
            document.querySelectorAll('.wizard-step').forEach(s => s.classList.remove('active'));
            document.querySelector(`.wizard-step[data-step="${wizardStep}"]`).classList.add('active');
            
            document.querySelectorAll('.wizard-progress-step').forEach(s => {
                const step = parseInt(s.dataset.step);
                s.classList.remove('done', 'active');
                if (step < wizardStep) s.classList.add('done');
                if (step === wizardStep) s.classList.add('active');
            });
            
            document.getElementById('wizardBack').style.display = wizardStep > 1 ? '' : 'none';
            document.getElementById('wizardNext').textContent = wizardStep === 5 ? 'Create Character' : 'Next';
        }

        function wizardNext() {
            if (wizardStep === 1) {
                wizardData.name = document.getElementById('wizardName').value;
                wizardData.level = parseInt(document.getElementById('wizardLevel').value) || 1;
            } else if (wizardStep === 5) {
                // Collect ability scores
                wizardData.str = parseInt(document.getElementById('wizardStr').value) || 10;
                wizardData.dex = parseInt(document.getElementById('wizardDex').value) || 10;
                wizardData.con = parseInt(document.getElementById('wizardCon').value) || 10;
                wizardData.int = parseInt(document.getElementById('wizardInt').value) || 10;
                wizardData.wis = parseInt(document.getElementById('wizardWis').value) || 10;
                wizardData.cha = parseInt(document.getElementById('wizardCha').value) || 10;
                
                // ALWAYS close wizard first, then apply data
                document.getElementById('wizardModal').classList.remove('active');
                
                try {
                    applyWizardData();
                } catch(e) {
                    console.error('Error applying wizard data:', e);
                }
                return;
            }
            
            if (wizardStep < 5) {
                wizardStep++;
                updateWizardStep();
            }
        }

        function wizardPrev() {
            if (wizardStep > 1) {
                wizardStep--;
                updateWizardStep();
            }
        }

        function selectWizardOption(element, type) {
            const parent = element.parentElement;
            parent.querySelectorAll('.wizard-option').forEach(o => o.classList.remove('selected'));
            element.classList.add('selected');
            wizardData[type] = element.dataset.value;
        }

        function applyStandardArray() {
            document.getElementById('wizardStr').value = 15;
            document.getElementById('wizardDex').value = 14;
            document.getElementById('wizardCon').value = 13;
            document.getElementById('wizardInt').value = 12;
            document.getElementById('wizardWis').value = 10;
            document.getElementById('wizardCha').value = 8;
        }

        function applyWizardData() {
            // Apply to character sheet
            document.getElementById('charName').value = wizardData.name;
            document.getElementById('level').value = wizardData.level;
            document.getElementById('species').value = wizardData.species;
            document.getElementById('charClass').value = wizardData.class;
            document.getElementById('background').value = wizardData.background;
            
            document.getElementById('str').value = wizardData.str;
            document.getElementById('dex').value = wizardData.dex;
            document.getElementById('con').value = wizardData.con;
            document.getElementById('int').value = wizardData.int;
            document.getElementById('wis').value = wizardData.wis;
            document.getElementById('cha').value = wizardData.cha;
            
            // Trigger calculations
            ['str', 'dex', 'con', 'int', 'wis', 'cha'].forEach(ab => updateModifier(ab));
            updateAllFromAbilities();
            handleClassChange();
            handleSpeciesChange();
            autoSave();
        }

        // Close wizard with escape key or clicking outside
        document.getElementById('wizardModal').addEventListener('click', function(e) {
            if (e.target === this) closeWizard();
        });

        // ===== QUICK START TEMPLATES =====
        const templates = [
            {
                id: 'fighter-human',
                name: 'Ser Marcus',
                species: 'Human',
                class: 'Fighter',
                level: 1,
                background: 'Soldier',
                icon: '⚔️',
                desc: 'A battle-hardened soldier skilled with sword and shield. Great for beginners who want to hit things.',
                str: 16, dex: 14, con: 14, int: 10, wis: 12, cha: 8
            },
            {
                id: 'wizard-elf',
                name: 'Elara Moonwhisper',
                species: 'Elf',
                class: 'Wizard',
                level: 1,
                background: 'Sage',
                icon: '🔮',
                desc: 'A scholarly elf who studied magic at a great academy. Perfect for those who love casting spells.',
                str: 8, dex: 14, con: 12, int: 16, wis: 13, cha: 10
            },
            {
                id: 'rogue-halfling',
                name: 'Pip Lightfoot',
                species: 'Halfling',
                class: 'Rogue',
                level: 1,
                background: 'Criminal',
                icon: '🗡️',
                desc: 'A sneaky halfling with quick fingers and quicker wit. Ideal for stealth and skill-focused play.',
                str: 8, dex: 16, con: 12, int: 14, wis: 10, cha: 13
            },
            {
                id: 'cleric-dwarf',
                name: 'Thoradin Ironheart',
                species: 'Dwarf',
                class: 'Cleric',
                level: 1,
                background: 'Acolyte',
                icon: '✨',
                desc: 'A devoted dwarf priest who heals allies and smites enemies. Great support character.',
                str: 14, dex: 10, con: 14, int: 10, wis: 16, cha: 8
            },
            {
                id: 'barbarian-halforc',
                name: 'Grukk the Fierce',
                species: 'Half-Orc',
                class: 'Barbarian',
                level: 1,
                background: 'Folk Hero',
                icon: '🪓',
                desc: 'A raging warrior from the northern tribes. Simple and devastating in combat.',
                str: 16, dex: 14, con: 16, int: 8, wis: 10, cha: 10
            },
            {
                id: 'bard-tiefling',
                name: 'Lyra Shadowsong',
                species: 'Tiefling',
                class: 'Bard',
                level: 1,
                background: 'Entertainer',
                icon: '🎵',
                desc: 'A charismatic performer who uses music as magic. Jack-of-all-trades and party face.',
                str: 8, dex: 14, con: 12, int: 12, wis: 10, cha: 16
            },
            // === GM-ONLY HIGH LEVEL TEST CHARACTERS ===
            {
                id: 'wizard-human-8',
                name: 'Aldric Flamecrest',
                species: 'Human',
                class: 'Wizard',
                level: 8,
                background: 'Sage',
                icon: '🔥',
                desc: 'Veteran battlemage of the Crimson Tower. Specializes in evocation magic.',
                str: 8, dex: 14, con: 14, int: 20, wis: 12, cha: 10,
                gmOnly: true,
                hp: 50, maxHp: 50, ac: 15,
                gold: 1250,
                speed: '30',
                spellAbility: 'int',
                alignment: 'Lawful Neutral',
                languages: 'Common, Draconic, Elvish, Ignan',
                senses: 'Passive Perception 11',
                savesProf: { int: true, wis: true },
                skillsProf: { arcana: true, history: true, investigation: true, religion: true },
                training: { weaponSimple: true, tools: 'Alchemist\'s supplies' },
                weapons: [
                    { name: 'Staff of Fire', atk: '+8', damage: '1d6+5 fire', properties: 'Versatile, +2 spell attacks' },
                    { name: 'Dagger', atk: '+5', damage: '1d4+2', properties: 'Finesse, Thrown (20/60)' }
                ],
                spellSlots: { 1: 4, 2: 3, 3: 3, 4: 2 },
                cantrips: ['Fire Bolt', 'Prestidigitation', 'Mage Hand', 'Light'],
                spells: ['Shield', 'Magic Missile', 'Detect Magic', 'Misty Step', 'Scorching Ray', 'Fireball', 'Counterspell', 'Greater Invisibility', 'Dimension Door'],
                equipment: 'Staff of Fire, Spellbook (200 pages, 45 spells copied), Component Pouch, Robe of Protection (+1 AC), Ring of Spell Storing (3 levels), Bag of Holding, Scholar\'s Pack, Ink & Quills',
                traits: 'ARCANE RECOVERY (4 levels/short rest)\nEVOCATION SAVANT (half gold/time to copy)\nSCULPT SPELLS (allies auto-save vs evocation)\nPOTENT CANTRIP (cantrips deal half on save)\n\nFEAT: War Caster (adv on concentration)',
                resistances: 'Fire (Staff of Fire)',
                backstory: 'Former battlemage of the Crimson Tower war college. Left after witnessing the destruction his magic caused in the Border Wars. Now seeks to use his power more responsibly.'
            },
            {
                id: 'barbarian-tiefling-10',
                name: 'Zariel Bloodhorn',
                species: 'Tiefling',
                class: 'Barbarian',
                level: 10,
                background: 'Outlander',
                icon: '😈',
                desc: 'Exiled from the Nine Hells, she channels infernal fury into devastating rage.',
                str: 20, dex: 14, con: 18, int: 8, wis: 12, cha: 14,
                gmOnly: true,
                hp: 115, maxHp: 115, ac: 17,
                gold: 890,
                speed: '40',
                alignment: 'Chaotic Neutral',
                languages: 'Common, Infernal, Orc',
                senses: 'Darkvision 60 ft, Passive Perception 11',
                savesProf: { str: true, con: true },
                skillsProf: { athletics: true, intimidation: true, survival: true, perception: true },
                skillsExp: {},
                training: { armorLight: true, armorMedium: true, armorShields: true, weaponSimple: true, weaponMartial: true },
                weapons: [
                    { name: 'Hellfire Greataxe +2', atk: '+11', damage: '1d12+7+2d6 fire', properties: 'Heavy, Two-Handed, Magic' },
                    { name: 'Handaxe x3', atk: '+9', damage: '1d6+5', properties: 'Light, Thrown (20/60)' },
                    { name: 'Javelin x4', atk: '+9', damage: '1d6+5', properties: 'Thrown (30/120)' }
                ],
                equipment: 'Hellfire Greataxe +2, Amulet of Health (sets CON to 19), Bracers of Defense (+2 AC unarmored), Explorer\'s Pack, Trophy necklace (demon fangs), Hunting trap, Traveler\'s clothes, Belt pouch',
                traits: 'RAGE (4/day, +3 damage, resist B/P/S)\nRECKLESS ATTACK (adv atk, enemies adv vs you)\nDANGER SENSE (adv DEX saves vs seen effects)\nEXTRA ATTACK\nFAST MOVEMENT (+10 ft)\nFERAL INSTINCT (adv initiative, act while surprised if rage)\nBRUTAL CRITICAL (+1 die)\n\nPATH OF THE BERSERKER:\nFRENZY (bonus action attack while raging)\nMINDLESS RAGE (immune charm/frighten in rage)\n\nTIEFLING TRAITS:\nHellish Rebuke (2d10, 1/day)\nDarkness (1/day)\nFire Resistance',
                resistances: 'Fire; B/P/S (while raging)',
                speciesTraits: 'Darkvision 60 ft\nHellish Resistance (fire)\nInfernal Legacy:\n- Thaumaturgy (cantrip)\n- Hellish Rebuke (1/day, 2nd level)\n- Darkness (1/day)',
                backstory: 'Born in the Nine Hells to a mortal slave, Zariel escaped through a portal during a demonic incursion. Her infernal rage makes her a terrifying warrior, but she struggles to find peace in the mortal realm.'
            },
            {
                id: 'druid-elf-7',
                name: 'Thistledown Greenmantle',
                species: 'Elf',
                class: 'Druid',
                level: 7,
                background: 'Hermit',
                icon: '🌿',
                desc: 'Ancient guardian of the Whispering Woods. Master of wild shapes and nature magic.',
                str: 10, dex: 16, con: 14, int: 12, wis: 18, cha: 10,
                gmOnly: true,
                hp: 52, maxHp: 52, ac: 16,
                gold: 420,
                speed: '30',
                spellAbility: 'wis',
                alignment: 'Neutral Good',
                languages: 'Common, Elvish, Druidic, Sylvan',
                senses: 'Darkvision 60 ft, Passive Perception 17',
                savesProf: { int: true, wis: true },
                skillsProf: { nature: true, perception: true, medicine: true, survival: true, religion: true },
                training: { armorLight: true, armorMedium: true, armorShields: true, weaponSimple: true, tools: 'Herbalism kit' },
                weapons: [
                    { name: 'Staff of the Woodlands', atk: '+7', damage: '1d6+4', properties: 'Versatile (1d8), +2 spell atk, Wall of Thorns 1/day' },
                    { name: 'Scimitar', atk: '+6', damage: '1d6+3', properties: 'Finesse, Light' },
                    { name: 'Produce Flame', atk: '+7', damage: '2d8 fire', properties: 'Ranged 30 ft, Cantrip' }
                ],
                spellSlots: { 1: 4, 2: 3, 3: 3, 4: 1 },
                cantrips: ['Druidcraft', 'Shillelagh', 'Produce Flame', 'Guidance'],
                spells: ['Cure Wounds', 'Entangle', 'Goodberry', 'Healing Word', 'Moonbeam', 'Pass without Trace', 'Call Lightning', 'Conjure Animals', 'Polymorph'],
                equipment: 'Staff of the Woodlands (+2, Wall of Thorns 1/day), +1 Hide Armor, Wooden Shield, Cloak of Elvenkind (adv Stealth), Druidic Focus (mistletoe), Herbalism Kit, Healer\'s Kit (10 uses), Explorer\'s Pack, Scroll case with notes',
                traits: 'WILD SHAPE (CR 1, swim, 2/short rest)\nDRUIDIC (secret language)\n\nCIRCLE OF THE MOON:\nCOMBAT WILD SHAPE (bonus action, spend slots to heal 1d8/level)\nCIRCLE FORMS (CR 1 at 2nd, CR 2 at 6th)\nPRIMAL STRIKE (beast attacks count as magical)\n\nPOPULAR WILD SHAPES:\n- Giant Constrictor Snake (CR 2, 60 HP)\n- Dire Wolf (CR 1, 37 HP, pack tactics)\n- Giant Eagle (CR 1, fly 80 ft)',
                speciesTraits: 'Darkvision 60 ft\nFey Ancestry (adv vs charm, immune sleep)\nTrance (4 hrs = 8 hrs sleep)\nKeen Senses (Perception prof)',
                resistances: '',
                backstory: 'For three centuries, Thistledown has guarded the Whispering Woods. When loggers from the expanding kingdom threatened the ancient grove, she emerged from isolation to negotiate - and if necessary, fight.'
            },
            {
                id: 'bard-dwarf-9',
                name: 'Borin Ironvoice',
                species: 'Dwarf',
                class: 'Bard',
                level: 9,
                background: 'Guild Artisan',
                icon: '🎸',
                desc: 'Legendary skald of the Mithral Halls. His war songs inspire armies and terrify foes.',
                str: 12, dex: 14, con: 16, int: 10, wis: 10, cha: 20,
                gmOnly: true,
                hp: 75, maxHp: 75, ac: 17,
                gold: 2100,
                speed: '25',
                spellAbility: 'cha',
                alignment: 'Neutral Good',
                languages: 'Common, Dwarvish, Giant, Undercommon',
                senses: 'Darkvision 60 ft, Passive Perception 10',
                savesProf: { dex: true, cha: true },
                skillsProf: { performance: true, persuasion: true, history: true, insight: true, athletics: true },
                skillsExp: { performance: true, persuasion: true },
                training: { armorLight: true, armorMedium: true, armorShields: true, weaponSimple: true, weaponMartial: true, tools: 'Lute, Drums, Smith\'s Tools' },
                weapons: [
                    { name: 'Rapier +1', atk: '+7', damage: '1d8+3', properties: 'Finesse, Magic' },
                    { name: 'Hand Crossbow', atk: '+6', damage: '1d6+2', properties: 'Ammunition (30/120), Light, Loading' },
                    { name: 'Dagger', atk: '+6', damage: '1d4+2', properties: 'Finesse, Light, Thrown (20/60)' }
                ],
                spellSlots: { 1: 4, 2: 3, 3: 3, 4: 3, 5: 1 },
                cantrips: ['Vicious Mockery', 'Minor Illusion', 'Mending'],
                spells: ['Healing Word', 'Dissonant Whispers', 'Faerie Fire', 'Thunderwave', 'Heat Metal', 'Shatter', 'Hypnotic Pattern', 'Dispel Magic', 'Greater Invisibility', 'Animate Objects'],
                equipment: 'Rapier +1, +1 Studded Leather Armor, Instrument of the Bards (Cli Lyre, +2 spell DC), Cloak of Protection (+1 AC/saves), Bag of Holding, Hand Crossbow, Crossbow Bolts (20), Smith\'s Tools, Fine Clothes, Guild Letter',
                traits: 'BARDIC INSPIRATION (d8, 5/short rest)\nJACK OF ALL TRADES (+2 to non-prof checks)\nSONG OF REST (d8 extra HD healing)\nEXPERTISE (Performance, Persuasion)\nFONT OF INSPIRATION (recover on short rest)\nCOUNTERCHARM (action: adv vs fear/charm 30ft)\n\nCOLLEGE OF VALOR:\nCOMBAT INSPIRATION (add to dmg or AC)\nEXTRA ATTACK\n\nFEAT: Inspiring Leader (10 temp HP to 6 allies/short rest)',
                speciesTraits: 'Darkvision 60 ft\nDwarven Resilience (adv vs poison, resist poison)\nStonecunning (History expertise for stonework)\nTool Proficiency (Smith\'s Tools)',
                resistances: 'Poison',
                backstory: 'Once the royal skald of Mithral Hall, Borin left after a political dispute with the new king. He now travels the realms, collecting songs and stories - and occasionally inspiring adventurers to greatness with his legendary voice.'
            }
        ];

        let selectedTemplate = null;

        function openTemplates() {
            selectedTemplate = null;
            const grid = document.getElementById('templateGrid');
            // Filter templates: show all for GM, hide gmOnly for players
            const visibleTemplates = templates.filter(t => !t.gmOnly || isGM);
            grid.innerHTML = visibleTemplates.map(t => `
                <div class="template-card${t.gmOnly ? ' gm-only' : ''}" data-id="${t.id}" onclick="selectTemplate('${t.id}')">
                    ${t.gmOnly ? '<div class="gm-badge">GM TEST</div>' : ''}
                    <div class="template-portrait">${t.icon}</div>
                    <div class="template-name">${t.name}</div>
                    <div class="template-info">${t.species} ${t.class} • Level ${t.level}</div>
                    <div class="template-desc">${t.desc}</div>
                </div>
            `).join('');
            document.getElementById('templateLoadBtn').disabled = true;
            document.getElementById('templatesModal').classList.add('active');
        }

        function closeTemplates() {
            document.getElementById('templatesModal').classList.remove('active');
        }

        function selectTemplate(id) {
            selectedTemplate = templates.find(t => t.id === id);
            document.querySelectorAll('.template-card').forEach(c => c.classList.remove('selected'));
            document.querySelector(`.template-card[data-id="${id}"]`).classList.add('selected');
            document.getElementById('templateLoadBtn').disabled = false;
        }

        function loadSelectedTemplate() {
            if (!selectedTemplate) return;
            
            // ALWAYS close modal first
            document.getElementById('templatesModal').classList.remove('active');
            
            try {
                const t = selectedTemplate;
                
                // Reset char to fresh state with template data
                char = {
                    header: {
                        name: t.name,
                        species: t.species,
                        charClass: t.class,
                        level: t.level,
                        background: t.background,
                        xp: '',
                        subclass: t.subclass || ''
                    },
                    stats: { heroicInsp: false, speed: t.speed || '30', size: t.size || 'Medium' },
                    abilities: { str: t.str, dex: t.dex, con: t.con, int: t.int, wis: t.wis, cha: t.cha },
                    saves: {},
                    savesProf: t.savesProf || {},
                    skills: {},
                    skillsProf: t.skillsProf || {},
                    skillsExp: t.skillsExp || {},
                    combat: {
                        ac: t.ac || 10,
                        shield: '',
                        hpCurrent: t.hp || '',
                        hpMax: t.maxHp || '',
                        hpTemp: '',
                        hdCurrent: t.level,
                        hdMax: t.level,
                        exhaustion: 0,
                        resistances: t.resistances || '',
                        immunities: t.immunities || '',
                        vulnerabilities: ''
                    },
                    deathSaves: { success: [false,false,false], fail: [false,false,false] },
                    conditions: [],
                    multiclass: t.multiclass || [],
                    weapons: [],
                    classFeatures: t.traits || '',
                    classResources: t.resources || [],
                    training: t.training || {},
                    speciesTraits: t.speciesTraits || '',
                    feats: t.feats || '',
                    senses: t.senses || '',
                    spellcasting: { ability: t.spellAbility || '' },
                    spellSlots: {},
                    pactSlots: { total: 0, expended: 0 },
                    spells: [],
                    narrative: {
                        alignment: t.alignment || '',
                        equipment: t.equipment || '',
                        languages: t.languages || '',
                        backstory: t.backstory || '',
                        portrait: ''
                    },
                    coins: { cp: '', sp: '', ep: '', gp: t.gold || '', pp: '' },
                    attunement: [false, false, false]
                };
                
                // Load weapons
                if (t.weapons && t.weapons.length > 0) {
                    char.weapons = t.weapons.map(w => ({
                        name: w.name || '',
                        bonus: w.atk || '',
                        damage: w.damage || '',
                        notes: w.properties || ''
                    }));
                } else {
                    char.weapons = [{ name: '', bonus: '', damage: '', notes: '' }];
                }
                
                // Load spell slots (initialize all to 0 first)
                for (let i = 1; i <= 9; i++) {
                    char.spellSlots[i] = { total: 0, expended: 0 };
                }
                if (t.spellSlots) {
                    Object.entries(t.spellSlots).forEach(([lvl, slots]) => {
                        char.spellSlots[parseInt(lvl)] = { total: slots, expended: 0 };
                    });
                }
                
                // Initialize spells array before loading
                char.spells = [];
                
                // Load cantrips - BOTH as weapons (for attack rolls) AND as spells level 0 (for Cantrips section)
                if (t.cantrips && t.cantrips.length > 0) {
                    t.cantrips.forEach(cantripName => {
                        const srdSpell = SRD_SPELLS.find(s => s.name === cantripName);
                        if (srdSpell) {
                            // Get spell attack/DC
                            const spellMod = getSpellcastingMod(t.spellAbility);
                            const profBonus = Math.ceil(t.level / 4) + 1;
                            const spellAtk = '+' + (spellMod + profBonus);
                            const hasDamage = srdSpell.damage && srdSpell.damage !== '—';
                            
                            // Add to weapons section (for quick attack rolls)
                            char.weapons.push({
                                name: `✨ ${cantripName}`,
                                srdName: cantripName,
                                bonus: hasDamage ? spellAtk : `DC ${8 + spellMod + profBonus}`,
                                damage: srdSpell.damage || '—',
                                damageType: srdSpell.damageType || '',
                                notes: `${srdSpell.range} • ${srdSpell.school}`,
                                isCantrip: true
                            });
                            
                            // Also add to spells array as level 0 (for Cantrips section)
                            char.spells.push({
                                name: cantripName,
                                srdName: cantripName,
                                level: '0', // Cantrip = Level 0
                                time: srdSpell.time || 'Action',
                                conc: srdSpell.conc || false,
                                concentrating: false,
                                ritual: false,
                                verbal: true,
                                somatic: true,
                                mat: false,
                                damage: srdSpell.damage !== '—' ? srdSpell.damage : '',
                                damageType: srdSpell.damageType || '',
                                range: srdSpell.range || '',
                                school: srdSpell.school || '',
                                attack: isSpellAttack(srdSpell),
                                save: isSpellSave(srdSpell),
                                saveType: '',
                                category: ''
                            });
                        }
                    });
                }
                
                // Load spells (Level 1-9) with full SRD data
                if (t.spells && t.spells.length > 0) {
                    t.spells.forEach(spellName => {
                        const srdSpell = SRD_SPELLS.find(s => s.name === spellName);
                        if (srdSpell) {
                            // Parse components
                            const comps = srdSpell.components || 'V, S';
                            const hasV = comps.includes('V');
                            const hasS = comps.includes('S');
                            const hasM = comps.includes('M');
                            
                            // Determine attack/save
                            const isAttack = isSpellAttack(srdSpell);
                            const isSave = isSpellSave(srdSpell);
                            
                            char.spells.push({
                                name: spellName,
                                srdName: spellName,
                                level: srdSpell.level.toString(),
                                time: srdSpell.time || 'Action',
                                conc: srdSpell.conc || false,
                                concentrating: false,
                                ritual: srdSpell.ritual || false,
                                verbal: hasV,
                                somatic: hasS,
                                mat: hasM,
                                damage: srdSpell.damage !== '—' ? srdSpell.damage : '',
                                damageType: srdSpell.damageType || '',
                                range: srdSpell.range || '',
                                school: srdSpell.school || '',
                                attack: isAttack,
                                save: isSave,
                                saveType: isSave ? guessSaveType(spellName) : '',
                                category: ''
                            });
                        } else {
                            // Spell not in SRD, add basic entry
                            char.spells.push({
                                name: spellName,
                                level: '',
                                time: 'Action',
                                verbal: true,
                                somatic: true,
                                mat: false,
                                conc: false,
                                concentrating: false,
                                ritual: false,
                                damage: '',
                                school: '',
                                attack: false,
                                save: false
                            });
                        }
                    });
                }
                
                // Helper to get spellcasting modifier
                function getSpellcastingMod(ability) {
                    if (!ability) return 0;
                    const score = t[ability] || 10;
                    return Math.floor((score - 10) / 2);
                }
                
                // Populate all fields from char object
                populateFields();
                
                // Render dynamic lists
                renderWeapons();
                renderResources();
                renderSpells();
                
                // Trigger calculations
                ['str', 'dex', 'con', 'int', 'wis', 'cha'].forEach(ab => updateModifier(ab));
                updateAllFromAbilities();
                handleClassChange();
                handleSpeciesChange();
                if (typeof updateSpellSlotDisplay === 'function') updateSpellSlotDisplay();
                
                autoSave();
                
                // Show success toast
                const lang = getLang();
                showToast(lang === 'de' ? `${t.name} geladen!` : `${t.name} loaded!`, 'success');
                
            } catch(e) {
                console.error('Error loading template:', e);
                showToast(t('error-loading-template'), 'error');
            }
        }

        document.getElementById('templatesModal').addEventListener('click', function(e) {
            if (e.target === this) closeTemplates();
        });

        // ===== ADD HELP ICONS TO KEY ELEMENTS =====
        let helpIconsVisible = localStorage.getItem('rift_help_icons') !== 'false';
        let gettingStartedHidden = localStorage.getItem('rift_getting_started_hidden') === 'true';
        
        // Sheet Settings Popup
        function openSheetSettings() {
            const lang = getLang();
            // Update title
            document.getElementById('settingsTitle').textContent = lang === 'de' ? '⚙️ Einstellungen' : '⚙️ Settings';
            
            // Set checkbox states
            document.getElementById('settingGettingStarted').checked = !gettingStartedHidden;
            document.getElementById('settingHelpIcons').checked = helpIconsVisible;
            
            // Translate labels
            const translations = {
                'show-getting-started': { en: 'Show "Getting Started"', de: 'Show "Getting Started"' },
                'show-getting-started-desc': { en: 'Show the beginner section with character wizard', de: 'Zeige den Anfänger-Bereich mit Charakter-Assistent' },
                'show-help-icons': { en: 'Show Help Icons', de: 'Show Help Icons' },
                'show-help-icons-desc': { en: 'Show ? icons with rule explanations', de: 'Zeige ?-Icons mit Regelerklärungen' }
            };
            document.querySelectorAll('[data-i18n-settings]').forEach(el => {
                const key = el.dataset.i18nSettings;
                if (translations[key]) {
                    el.textContent = translations[key][lang] || translations[key].en;
                }
            });
            
            document.getElementById('sheetSettingsModal').classList.add('active');
        }
        
        function closeSheetSettings() {
            document.getElementById('sheetSettingsModal').classList.remove('active');
        }
        
        function toggleGettingStartedSetting() {
            const checked = document.getElementById('settingGettingStarted').checked;
            if (checked) {
                showGettingStarted();
            } else {
                hideGettingStarted();
            }
        }
        
        function toggleHelpIconsSetting() {
            const checked = document.getElementById('settingHelpIcons').checked;
            helpIconsVisible = checked;
            localStorage.setItem('rift_help_icons', helpIconsVisible);
            document.body.classList.toggle('hide-help-icons', !helpIconsVisible);
            updateHelpIconsButton();
        }
        
        // Close settings with click outside
        document.getElementById('sheetSettingsModal')?.addEventListener('click', function(e) {
            if (e.target === this) closeSheetSettings();
        });
        
        function hideGettingStarted() {
            gettingStartedHidden = true;
            localStorage.setItem('rift_getting_started_hidden', 'true');
            document.getElementById('gettingStartedSection').style.display = 'none';
        }
        
        function showGettingStarted() {
            gettingStartedHidden = false;
            localStorage.setItem('rift_getting_started_hidden', 'false');
            document.getElementById('gettingStartedSection').style.display = '';
        }
        
        function initGettingStartedState() {
            if (gettingStartedHidden) {
                document.getElementById('gettingStartedSection').style.display = 'none';
            }
        }
        
        function toggleHelpIcons() {
            helpIconsVisible = !helpIconsVisible;
            localStorage.setItem('rift_help_icons', helpIconsVisible);
            document.body.classList.toggle('hide-help-icons', !helpIconsVisible);
            updateHelpIconsButton();
        }
        
        function updateHelpIconsButton() {
            const btn = document.getElementById('helpIconsToggle');
            const label = document.getElementById('helpIconsLabel');
            if (btn && label) {
                const lang = getLang();
                const onText = lang === 'de' ? 'Hilfe-Icons: AN' : 'Help Icons: ON';
                const offText = lang === 'de' ? 'Hilfe-Icons: AUS' : 'Help Icons: OFF';
                label.textContent = helpIconsVisible ? onText : offText;
                btn.style.opacity = helpIconsVisible ? '1' : '0.6';
            }
        }
        
        function initHelpIconsState() {
            if (!helpIconsVisible) {
                document.body.classList.add('hide-help-icons');
            }
            setTimeout(updateHelpIconsButton, 100);
        }
        
        // i18n for Getting Started section
        function applyGettingStartedI18n() {
            const lang = getLang();
            const translations = {
                'getting-started-desc': {
                    en: 'New to D&D? Start here! Create a character step-by-step or pick a ready-made template.',
                    de: 'Neu bei D&D? Starte hier! Erstelle einen Charakter Schritt für Schritt oder wähle eine fertige Vorlage.'
                },
                'new-character': { en: 'New Character', de: 'Neuer Charakter' },
                'quick-start-templates': { en: 'Quick Start Templates', de: 'Schnellstart-Vorlagen' },
                'restore': { en: 'Restore', de: 'Wiederherstellen' }
            };
            
            document.querySelectorAll('[data-i18n]').forEach(el => {
                const key = el.dataset.i18n;
                if (translations[key]) {
                    el.textContent = translations[key][lang] || translations[key].en;
                }
            });
        }
        
        function addHelpIcons() {
            // Add help icons to stat labels
            const helpTargets = [
                // Header stats
                { selector: '.stat-label', match: 'Prof', tooltip: 'proficiency' },
                { selector: '.stat-label', match: 'Initiative', tooltip: 'initiative' },
                { selector: '.stat-label', match: 'Passive', tooltip: 'skill-check' },
                { selector: '.stat-label', match: 'Speed', tooltip: 'speed' },
                { selector: '.stat-label', match: 'Heroic', tooltip: 'heroic-inspiration' },
                // Combat
                { selector: '.ac-shield-label', tooltip: 'armor-class' },
                { selector: '.armor-stat-label', match: 'Current', tooltip: 'hit-points' },
                { selector: '.armor-stat-label', match: 'Maximum', tooltip: 'hit-points' },
                { selector: '.armor-stat-label', match: 'Aktuell', tooltip: 'hit-points' },
                { selector: '.armor-stat-label', match: 'Temp', tooltip: 'temp-hp' },
                { selector: '.armor-stat-label', match: 'Hit Dice', tooltip: 'hit-dice' },
                { selector: '.armor-stat-label', match: 'Treffer', tooltip: 'hit-dice' },
                { selector: '.armor-stat-label', match: 'Death', tooltip: 'death-saves' },
                { selector: '.armor-stat-label', match: 'Todes', tooltip: 'death-saves' },
                { selector: '.armor-stat-label', match: 'Exhaustion', tooltip: 'exhaustion' },
                { selector: '.armor-stat-label', match: 'Erschöpfung', tooltip: 'exhaustion' },
                // Spellcasting
                { selector: '.spell-stat-label', match: 'DC', tooltip: 'spell-dc' },
                { selector: '.spell-stat-label', match: 'SG', tooltip: 'spell-dc' },
                { selector: '.spell-stat-label', match: 'Attack', tooltip: 'spell-attack' },
                { selector: '.spell-stat-label', match: 'angriff', tooltip: 'spell-attack' },
                { selector: '.spell-stat-label', match: 'Modifier', tooltip: 'spell-mod' },
                { selector: '.spell-stat-label', match: 'modifikator', tooltip: 'spell-mod' },
                { selector: '.spell-stat-label', match: 'Ability', tooltip: 'spell-ability' },
                { selector: '.spell-stat-label', match: 'attribut', tooltip: 'spell-ability' },
                // Skills & Saves
                { selector: '.save-label', tooltip: 'saving-throw' },
                // Weapons section
                { selector: '.section-title', match: 'Weapon', tooltip: 'weapon-attack' },
                { selector: '.section-title', match: 'Waffen', tooltip: 'weapon-attack' },
                // Class Features
                { selector: '.section-title', match: 'Class Features', tooltip: 'class-features' },
                { selector: '.section-title', match: 'Klassenmerkmale', tooltip: 'class-features' },
                { selector: '.field-label', match: 'Class Resources', tooltip: 'class-resources' },
                { selector: '.field-label', match: 'Klassenressourcen', tooltip: 'class-resources' },
                // Training
                { selector: '.section-title', match: 'Training', tooltip: 'training' },
                { selector: '.section-title', match: 'Übung', tooltip: 'training' },
                // Species & Feats
                { selector: '.field-label', match: 'Species Traits', tooltip: 'species-traits' },
                { selector: '.field-label', match: 'Volksmerkmale', tooltip: 'species-traits' },
                { selector: '.field-label', match: 'Feats', tooltip: 'feats' },
                { selector: '.field-label', match: 'Talente', tooltip: 'feats' },
                // Spellcasting section
                { selector: '.section-title', match: 'Spellcasting', tooltip: 'spell-slots' },
                { selector: '.section-title', match: 'Zauberwirken', tooltip: 'spell-slots' },
                { selector: '.field-label', match: 'Spell Slots', tooltip: 'spell-slots' },
                { selector: '.field-label', match: 'Zauberplätze', tooltip: 'spell-slots' },
                { selector: '.field-label', match: 'Pact Slots', tooltip: 'pact-slots' },
                { selector: '.field-label', match: 'Pakt', tooltip: 'pact-slots' },
                { selector: '.field-label', match: 'Prepared', tooltip: 'prepared-spells' },
                { selector: '.field-label', match: 'Vorbereitet', tooltip: 'prepared-spells' },
                // Attunement
                { selector: '.section-title', match: 'Attunement', tooltip: 'attunement' },
                { selector: '.section-title', match: 'Einstimmung', tooltip: 'attunement' }
            ];
            
            helpTargets.forEach(target => {
                document.querySelectorAll(target.selector).forEach(el => {
                    if (target.match && !el.textContent.toLowerCase().includes(target.match.toLowerCase())) return;
                    if (el.querySelector('.help-icon')) return;
                    
                    const icon = document.createElement('span');
                    icon.className = 'help-icon';
                    icon.textContent = '?';
                    icon.onmouseenter = () => showTooltip(target.tooltip, icon);
                    icon.onmouseleave = hideTooltip;
                    icon.onclick = (e) => { e.stopPropagation(); showTooltip(target.tooltip, icon); };
                    el.appendChild(icon);
                });
            });
            
            // Add help icons to ability names
            document.querySelectorAll('.ability-name').forEach(el => {
                if (el.querySelector('.help-icon')) return;
                const abilityId = el.closest('.ability-card')?.dataset.ability;
                if (!abilityId) return;
                
                const icon = document.createElement('span');
                icon.className = 'help-icon';
                icon.textContent = '?';
                icon.onmouseenter = () => showRulesPopup(abilityId, icon);
                icon.onclick = (e) => { e.stopPropagation(); showRulesPopup(abilityId, icon); };
                el.appendChild(icon);
            });
        }

        // Initialize help icons state and add them
        initHelpIconsState();
        initGettingStartedState();
        initLanguage();
        applyLanguage(); // Apply immediately
        setTimeout(() => {
            addHelpIcons();
            applyGettingStartedI18n();
            applyLanguage(); // Apply again after dynamic content loaded
        }, 800);
    </script>
    <script src="assets/js/broadcast.js"></script>
</body>
</html>
