<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <meta name="view-transition" content="same-origin">
    <title>RIFT ‚Äì Session</title>
    
    <link rel="stylesheet" href="assets/css/core.css">
    <link rel="stylesheet" href="assets/css/ui.css">
    <link rel="stylesheet" href="assets/css/sidebar.css">
    <link rel="stylesheet" href="assets/css/topbar.css">
    <link rel="stylesheet" href="assets/css/footer.css">
    <link rel="stylesheet" href="assets/css/settings.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.6.1/cropper.min.css">
    
    <style>
        /* ========================================
           SESSION LOBBY STYLES
           ======================================== */
        
        /* Page Header */
        .session-page-header {
            padding: 16px 24px;
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .session-back-btn {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 8px 16px;
            background: var(--bg-elevated);
            border: 1px solid var(--border);
            border-radius: 8px;
            color: var(--text-muted);
            font-size: 14px;
            text-decoration: none;
            transition: all 0.2s;
        }
        
        .session-back-btn:hover {
            background: var(--bg-card);
            color: var(--text);
            border-color: var(--border-hover);
        }
        
        .session-back-btn svg {
            width: 18px;
            height: 18px;
        }
        
        /* ========================================
           SESSION HERO (Cover + Info)
           ======================================== */
        .session-hero {
            margin: 0 24px 24px;
            background: var(--bg-elevated);
            border-radius: 16px;
            border: 1px solid var(--border);
            overflow: hidden;
            display: grid;
            grid-template-columns: 220px 1fr;
            min-height: 320px;
        }
        
        @media (max-width: 800px) {
            .session-hero {
                grid-template-columns: 1fr;
            }
            .session-hero__cover {
                height: 240px;
            }
        }
        
        /* Cover */
        .session-hero__cover {
            position: relative;
            background: linear-gradient(135deg, var(--red-dim) 0%, var(--gray-dark) 100%);
            cursor: pointer;
        }
        
        .session-hero__cover img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .session-hero__cover-placeholder {
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: var(--text-dim);
            gap: 8px;
        }
        
        .session-hero__cover-placeholder svg {
            width: 48px;
            height: 48px;
            opacity: 0.4;
        }
        
        .session-hero__cover-placeholder span {
            font-size: 13px;
        }
        
        .session-hero__cover-edit {
            position: absolute;
            bottom: 12px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0,0,0,0.85);
            border: none;
            border-radius: 6px;
            padding: 8px 14px;
            color: var(--text);
            font-size: 12px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 6px;
            opacity: 0;
            transition: opacity 0.2s;
        }
        
        .session-hero__cover:hover .session-hero__cover-edit,
        .session-hero__cover-edit:focus {
            opacity: 1;
        }
        
        /* Info Section */
        .session-hero__info {
            padding: 24px;
            display: flex;
            flex-direction: column;
        }
        
        .session-hero__top-row {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 12px;
            flex-wrap: wrap;
            gap: 12px;
        }
        
        .session-hero__ruleset {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            background: var(--bg-card);
            padding: 6px 12px;
            border-radius: 6px;
            font-size: 12px;
            font-weight: 600;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .session-hero__ruleset img {
            width: 18px;
            height: 18px;
            border-radius: 4px;
        }
        
        .session-hero__status {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 6px 14px;
            border-radius: 20px;
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .session-hero__status--planned {
            background: rgba(234, 179, 8, 0.15);
            color: #EAB308;
        }
        
        .session-hero__status--live {
            background: rgba(117, 171, 93, 0.15);
            color: var(--green);
        }
        
        .session-hero__status--paused {
            background: rgba(255, 159, 67, 0.15);
            color: #FF9F43;
        }
        
        .session-hero__status--ended {
            background: rgba(255,255,255,0.08);
            color: var(--text-muted);
        }
        
        .session-hero__status-dot {
            width: 6px;
            height: 6px;
            border-radius: 50%;
            background: currentColor;
        }
        
        .session-hero__status--live .session-hero__status-dot {
            animation: pulse-dot 1.5s infinite;
        }
        
        @keyframes pulse-dot {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.4; transform: scale(0.8); }
        }
        
        .session-hero__title {
            font-family: var(--font-display);
            font-size: 38px;
            font-weight: 800;
            margin-bottom: 4px;
            line-height: 1.1;
        }
        
        .session-hero__subtitle {
            font-size: 15px;
            color: var(--text-muted);
            margin-bottom: 20px;
        }
        
        /* Date/Time Row */
        .session-hero__datetime {
            display: flex;
            gap: 12px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        
        .session-date-box {
            background: var(--bg-card);
            border-radius: 10px;
            padding: 10px 16px;
            text-align: center;
            min-width: 70px;
        }
        
        .session-date-box__day {
            font-size: 11px;
            color: var(--text-dim);
            text-transform: uppercase;
        }
        
        .session-date-box__num {
            font-family: var(--font-display);
            font-size: 32px;
            font-weight: 700;
            line-height: 1;
            color: var(--text);
        }
        
        .session-date-box__month {
            font-size: 12px;
            color: var(--text-muted);
        }
        
        .session-time-box {
            background: var(--bg-card);
            border-radius: 10px;
            padding: 12px 16px;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }
        
        .session-time-box__label {
            font-size: 10px;
            color: var(--text-dim);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .session-time-box__value {
            font-size: 18px;
            font-weight: 600;
        }
        
        .session-countdown {
            background: var(--red-dim);
            border-radius: 10px;
            padding: 10px 16px;
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .countdown-item {
            text-align: center;
        }
        
        .countdown-item__value {
            font-family: var(--font-display);
            font-size: 24px;
            font-weight: 700;
            color: var(--accent);
            display: block;
            line-height: 1;
        }
        
        .countdown-item__label {
            font-size: 9px;
            color: var(--text-dim);
            text-transform: uppercase;
        }
        
        .countdown-sep {
            color: var(--text-dim);
            font-size: 18px;
        }
        
        /* Live Timer */
        .session-live-timer {
            background: rgba(117, 171, 93, 0.15);
            border: 1px solid rgba(117, 171, 93, 0.3);
            border-radius: 10px;
            padding: 12px 20px;
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .session-live-timer__label {
            font-size: 10px;
            color: var(--green);
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        .session-live-timer__value {
            font-family: var(--font-display);
            font-size: 28px;
            font-weight: 700;
            color: var(--green);
            font-variant-numeric: tabular-nums;
        }
        
        /* Description */
        .session-hero__description {
            flex: 1;
        }
        
        .session-hero__description-title {
            font-size: 10px;
            color: var(--text-dim);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 8px;
        }
        
        .session-hero__description-text {
            font-size: 14px;
            color: var(--text-muted);
            line-height: 1.6;
        }
        
        .session-hero__description-text p {
            margin-bottom: 12px;
        }
        
        .session-hero__description-text p:last-child {
            margin-bottom: 0;
        }
        
        /* Voice Link inline */
        .session-hero__voice-link {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            margin-top: 16px;
            padding: 10px 18px;
            background: #5865F2;
            border-radius: 8px;
            color: white;
            text-decoration: none;
            font-size: 13px;
            font-weight: 500;
            transition: background 0.2s;
            width: fit-content;
        }
        
        .session-hero__voice-link:hover {
            background: #4752c4;
        }
        
        .session-hero__voice-link svg {
            width: 16px;
            height: 16px;
        }
        
        /* ========================================
           PARTY SECTION
           ======================================== */
        .session-section {
            margin: 0 24px 24px;
        }
        
        .session-section__header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 16px;
        }
        
        .session-section__title {
            font-family: var(--font-display);
            font-size: 24px;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .session-section__count {
            font-family: var(--font-body);
            font-size: 14px;
            color: var(--text-dim);
            font-weight: 400;
        }
        
        .party-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 12px;
        }
        
        /* Party Member Card */
        .party-card {
            background: var(--bg-elevated);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 16px;
            display: flex;
            gap: 14px;
            align-items: center;
            transition: all 0.2s;
            cursor: pointer;
            position: relative;
        }
        
        .party-card:hover {
            border-color: var(--border-hover);
            background: var(--bg-card);
        }
        
        .party-card--empty {
            border-style: dashed;
            opacity: 0.6;
        }
        
        .party-card--gm {
            border-color: var(--red-dim);
            background: linear-gradient(135deg, var(--red-dim) 0%, var(--bg-elevated) 100%);
        }
        
        .party-card__gm-badge {
            position: absolute;
            top: -8px;
            right: 12px;
            background: var(--accent);
            color: white;
            font-size: 10px;
            font-weight: 700;
            padding: 3px 8px;
            border-radius: 4px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .party-card__portrait {
            width: 52px;
            height: 52px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            font-weight: 700;
            position: relative;
            flex-shrink: 0;
            background: var(--bg-card);
            border: 2px solid var(--border);
            overflow: hidden;
        }
        
        .party-card__portrait--has-char {
            border-color: var(--char-color, var(--accent));
            color: var(--char-color, var(--accent));
        }
        
        .party-card__portrait img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .party-card__online {
            position: absolute;
            bottom: -3px;
            right: -3px;
            width: 14px;
            height: 14px;
            border-radius: 50%;
            border: 3px solid var(--bg-elevated);
        }
        
        .party-card__online--on { background: var(--green); }
        .party-card__online--off { background: #444; }
        
        .party-card__info {
            flex: 1;
            min-width: 0;
        }
        
        .party-card__name {
            font-weight: 600;
            font-size: 15px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            margin-bottom: 2px;
        }
        
        .party-card__class {
            font-size: 13px;
            color: var(--text-muted);
            margin-bottom: 8px;
        }
        
        .party-card__hp {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .party-card__hp-bar {
            flex: 1;
            height: 4px;
            background: var(--border);
            border-radius: 2px;
            overflow: hidden;
        }
        
        .party-card__hp-fill {
            height: 100%;
            border-radius: 2px;
            transition: width 0.3s;
        }
        
        .party-card__hp-fill--high { background: var(--green); }
        .party-card__hp-fill--mid { background: #EAB308; }
        .party-card__hp-fill--low { background: var(--accent); }
        
        .party-card__hp-text {
            font-size: 11px;
            color: var(--text-dim);
            font-variant-numeric: tabular-nums;
            min-width: 45px;
            text-align: right;
        }
        
        .party-card__player {
            background: var(--bg-card);
            padding: 4px 10px;
            border-radius: 4px;
            font-size: 11px;
            color: var(--text-dim);
            align-self: flex-start;
        }
        
        .party-card__empty-text {
            color: var(--text-dim);
        }
        
        .party-card__empty-text strong {
            display: block;
            font-weight: 500;
            color: var(--text-muted);
        }
        
        .party-card__empty-text span {
            font-size: 12px;
        }
        
        /* GM Actions on Party Card */
        .party-card__actions {
            display: none;
            gap: 4px;
            margin-left: 8px;
        }
        
        .party-card:hover .party-card__actions {
            display: flex;
        }
        
        .party-card__action-btn {
            width: 28px;
            height: 28px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 6px;
            color: var(--text-muted);
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .party-card__action-btn:hover {
            background: var(--red-dim);
            border-color: var(--accent);
            color: var(--accent);
        }
        
        .party-card__action-btn svg {
            width: 14px;
            height: 14px;
        }
        
        /* ========================================
           QUICK ACTIONS
           ======================================== */
        .quick-actions {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        
        .quick-action {
            background: var(--bg-elevated);
            border: 1px solid var(--border);
            border-radius: 10px;
            padding: 14px 20px;
            display: flex;
            align-items: center;
            gap: 12px;
            text-decoration: none;
            color: var(--text);
            transition: all 0.2s;
            font-size: 14px;
            font-weight: 500;
        }
        
        .quick-action:hover {
            border-color: var(--border-hover);
            background: var(--bg-card);
        }
        
        .quick-action--discord {
            background: #5865F2;
            border-color: #5865F2;
        }
        
        .quick-action--discord:hover {
            background: #4752c4;
            border-color: #4752c4;
        }
        
        .quick-action__icon {
            width: 20px;
            height: 20px;
            flex-shrink: 0;
        }
        
        .quick-action__text span {
            display: block;
            font-size: 11px;
            color: rgba(255,255,255,0.6);
            font-weight: 400;
        }
        
        /* Invite Box */
        .invite-box {
            background: var(--bg-elevated);
            border: 1px solid var(--border);
            border-radius: 10px;
            padding: 10px 14px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .invite-box__input {
            flex: 1;
            background: transparent;
            border: none;
            color: var(--text-dim);
            font-size: 13px;
            outline: none;
            min-width: 120px;
        }
        
        .invite-box__btn {
            background: var(--red-dim);
            border: none;
            border-radius: 6px;
            padding: 8px 14px;
            color: var(--accent);
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.2s;
        }
        
        .invite-box__btn:hover {
            background: rgba(255, 70, 85, 0.2);
        }
        
        /* ========================================
           GM FLOATING BAR
           ======================================== */
        .gm-bar {
            position: fixed;
            bottom: 24px;
            left: 50%;
            transform: translateX(-50%);
            background: var(--bg-elevated);
            border: 1px solid var(--border);
            border-radius: 14px;
            padding: 10px 14px;
            display: none;
            gap: 10px;
            box-shadow: var(--shadow-lg);
            z-index: 100;
        }
        
        .gm-bar--visible {
            display: flex;
        }
        
        .gm-bar__btn {
            border: none;
            border-radius: 10px;
            padding: 12px 16px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.2s;
        }
        
        .gm-bar__btn--start {
            background: var(--green);
            color: white;
            padding: 12px 24px;
        }
        
        .gm-bar__btn--start:hover {
            filter: brightness(1.1);
        }
        
        .gm-bar__btn--pause {
            background: #FF9F43;
            color: white;
        }
        
        .gm-bar__btn--resume {
            background: var(--green);
            color: white;
        }
        
        .gm-bar__btn--end {
            background: var(--accent);
            color: white;
        }
        
        .gm-bar__btn--secondary {
            background: var(--bg-card);
            color: var(--text-muted);
            border: 1px solid var(--border);
        }
        
        .gm-bar__btn--secondary:hover {
            background: rgba(255,255,255,0.1);
            color: var(--text);
        }
        
        .gm-bar__btn svg {
            width: 18px;
            height: 18px;
        }
        
        /* ========================================
           GM SETTINGS MODAL
           ======================================== */
        .settings-modal {
            position: fixed;
            inset: 0;
            z-index: 1000;
            display: none;
            align-items: center;
            justify-content: center;
        }
        
        .settings-modal--open {
            display: flex;
        }
        
        .settings-modal__backdrop {
            position: absolute;
            inset: 0;
            background: rgba(0, 0, 0, 0.85);
            backdrop-filter: blur(8px);
        }
        
        .settings-modal__dialog {
            position: relative;
            width: 600px;
            max-width: calc(100vw - 40px);
            max-height: calc(100vh - 80px);
            background: var(--bg-elevated);
            border: 1px solid var(--border);
            border-radius: 16px;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            box-shadow: var(--shadow-lg);
        }
        
        .settings-modal__header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 20px 24px;
            border-bottom: 1px solid var(--border);
            background: var(--red-dim);
        }
        
        .settings-modal__title {
            font-family: var(--font-display);
            font-size: 24px;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .settings-modal__title svg {
            width: 24px;
            height: 24px;
            color: var(--accent);
        }
        
        .settings-modal__close {
            width: 36px;
            height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(255,255,255,0.05);
            border: 1px solid var(--border);
            border-radius: 8px;
            color: var(--text-muted);
            cursor: pointer;
            font-size: 20px;
            transition: all 0.2s;
        }
        
        .settings-modal__close:hover {
            background: var(--red-dim);
            border-color: var(--accent);
            color: var(--accent);
        }
        
        /* Tabs */
        .settings-modal__tabs {
            display: flex;
            border-bottom: 1px solid var(--border);
            padding: 0 24px;
            background: var(--bg-card);
        }
        
        .settings-modal__tab {
            padding: 14px 20px;
            background: none;
            border: none;
            color: var(--text-muted);
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            position: relative;
            transition: color 0.2s;
        }
        
        .settings-modal__tab:hover {
            color: var(--text);
        }
        
        .settings-modal__tab--active {
            color: var(--accent);
        }
        
        .settings-modal__tab--active::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 2px;
            background: var(--accent);
        }
        
        /* Tab Content */
        .settings-modal__body {
            flex: 1;
            overflow-y: auto;
            padding: 24px;
        }
        
        .settings-tab {
            display: none;
        }
        
        .settings-tab--active {
            display: block;
        }
        
        /* Form Elements */
        .settings-group {
            margin-bottom: 24px;
        }
        
        .settings-group:last-child {
            margin-bottom: 0;
        }
        
        .settings-group__label {
            font-size: 11px;
            font-weight: 600;
            color: var(--text-dim);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 10px;
            display: block;
        }
        
        .settings-input {
            width: 100%;
            padding: 12px 14px;
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 8px;
            color: var(--text);
            font-size: 14px;
            transition: border-color 0.2s;
        }
        
        .settings-input:focus {
            outline: none;
            border-color: var(--accent);
        }
        
        .settings-input::placeholder {
            color: var(--text-dim);
        }
        
        .settings-textarea {
            min-height: 100px;
            resize: vertical;
        }
        
        .settings-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px;
        }
        
        @media (max-width: 500px) {
            .settings-row {
                grid-template-columns: 1fr;
            }
        }
        
        /* Toggle Switch - Settings Modal */
        .settings-modal .session-toggle {
            display: flex !important;
            flex-direction: row !important;
            align-items: flex-start !important;
            justify-content: space-between !important;
            gap: 20px !important;
            padding: 14px 16px;
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 8px;
            margin-bottom: 10px;
            cursor: pointer;
            transition: all 0.2s;
            position: relative;
        }
        
        .settings-modal .session-toggle:hover {
            border-color: var(--border-hover);
        }
        
        .settings-modal .session-toggle__text {
            flex: 1 1 auto !important;
            min-width: 0;
            padding-right: 10px;
            order: 1;
        }
        
        .settings-modal .session-toggle__text::before {
            content: none !important;
        }
        
        .settings-modal .session-toggle__text > :first-child {
            display: block;
            font-size: 14px;
            font-weight: 500;
            color: var(--text);
        }
        
        .settings-modal .session-toggle__text span {
            display: block;
            font-size: 12px;
            color: var(--text-dim);
            line-height: 1.4;
            margin-top: 4px;
        }
        
        .settings-modal .session-toggle__switch {
            width: 44px !important;
            min-width: 44px !important;
            max-width: 44px !important;
            height: 24px !important;
            background: rgba(255,255,255,0.15);
            border-radius: 12px;
            position: relative !important;
            transition: background 0.2s;
            flex-shrink: 0 !important;
            flex-grow: 0 !important;
            order: 2;
            margin-left: auto;
        }
        
        .settings-modal .session-toggle__switch::after {
            content: '';
            position: absolute;
            top: 3px;
            left: 3px;
            width: 18px;
            height: 18px;
            background: white;
            border-radius: 50%;
            transition: transform 0.2s;
        }
        
        .settings-modal .session-toggle--active .session-toggle__switch {
            background: var(--accent);
        }
        
        .settings-modal .session-toggle--active .session-toggle__switch::after {
            transform: translateX(20px);
        }
        
        /* Select Dropdown */
        .settings-select {
            width: 100%;
            padding: 12px 14px;
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 8px;
            color: var(--text);
            font-size: 14px;
            cursor: pointer;
            appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 24 24' fill='none' stroke='%23888' stroke-width='2'%3E%3Cpolyline points='6 9 12 15 18 9'%3E%3C/polyline%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 14px center;
            padding-right: 40px;
        }
        
        .settings-select:focus {
            outline: none;
            border-color: var(--accent);
        }
        
        /* Cover Preview */
        .settings-cover-preview {
            display: flex;
            gap: 16px;
            align-items: flex-start;
        }
        
        .settings-cover-preview__image {
            width: 100px;
            aspect-ratio: 2/3;
            background: var(--bg-card);
            border-radius: 8px;
            overflow: hidden;
            border: 1px solid var(--border);
            flex-shrink: 0;
        }
        
        .settings-cover-preview__image img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .settings-cover-preview__placeholder {
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--text-dim);
            font-size: 24px;
        }
        
        .settings-cover-preview__actions {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        
        .settings-cover-btn {
            padding: 10px 16px;
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 6px;
            color: var(--text);
            font-size: 13px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.2s;
        }
        
        .settings-cover-btn:hover {
            border-color: var(--accent);
            color: var(--accent);
        }
        
        .settings-cover-btn--danger:hover {
            border-color: var(--accent);
            background: var(--red-dim);
        }
        
        /* Tags Input */
        .settings-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }
        
        .settings-tag {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 6px 12px;
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 6px;
            font-size: 13px;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .settings-tag:hover,
        .settings-tag--active {
            border-color: var(--accent);
            color: var(--accent);
        }
        
        .settings-tag--active {
            background: var(--red-dim);
        }
        
        /* Footer */
        .settings-modal__footer {
            display: flex;
            justify-content: flex-end;
            gap: 12px;
            padding: 16px 24px;
            border-top: 1px solid var(--border);
            background: var(--bg-card);
        }
        
        .settings-modal__btn {
            padding: 12px 24px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .settings-modal__btn--cancel {
            background: transparent;
            border: 1px solid var(--border);
            color: var(--text-muted);
        }
        
        .settings-modal__btn--cancel:hover {
            background: var(--bg-elevated);
            color: var(--text);
        }
        
        .settings-modal__btn--save {
            background: var(--accent);
            border: none;
            color: white;
        }
        
        .settings-modal__btn--save:hover {
            filter: brightness(1.1);
        }
        
        /* ========================================
           DELETE MODAL
           ======================================== */
        .delete-modal {
            position: fixed;
            inset: 0;
            z-index: 1001;
            display: none;
            align-items: center;
            justify-content: center;
        }
        
        .delete-modal--open {
            display: flex;
        }
        
        .delete-modal__backdrop {
            position: absolute;
            inset: 0;
            background: rgba(0, 0, 0, 0.85);
        }
        
        .delete-modal__dialog {
            position: relative;
            width: 400px;
            max-width: calc(100vw - 40px);
            background: var(--bg-elevated);
            border: 1px solid var(--accent);
            border-radius: 16px;
            padding: 24px;
            text-align: center;
        }
        
        .delete-modal__icon {
            width: 64px;
            height: 64px;
            margin: 0 auto 16px;
            background: var(--red-dim);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--accent);
        }
        
        .delete-modal__icon svg {
            width: 32px;
            height: 32px;
        }
        
        .delete-modal__title {
            font-family: var(--font-display);
            font-size: 24px;
            font-weight: 700;
            margin-bottom: 8px;
        }
        
        .delete-modal__text {
            color: var(--text-muted);
            margin-bottom: 24px;
        }
        
        .delete-modal__actions {
            display: flex;
            gap: 12px;
            justify-content: center;
        }
        
        .delete-modal__btn {
            padding: 12px 24px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
        }
        
        .delete-modal__btn--cancel {
            background: var(--bg-card);
            border: 1px solid var(--border);
            color: var(--text);
        }
        
        .delete-modal__btn--confirm {
            background: var(--accent);
            border: none;
            color: white;
        }
        
        /* ========================================
           SESSION NOT FOUND
           ======================================== */
        .session-not-found {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 60vh;
            text-align: center;
            padding: 40px;
        }
        
        .session-not-found__icon {
            width: 80px;
            height: 80px;
            margin-bottom: 24px;
            color: var(--text-dim);
            opacity: 0.5;
        }
        
        .session-not-found__title {
            font-family: var(--font-display);
            font-size: 32px;
            font-weight: 700;
            margin-bottom: 8px;
        }
        
        .session-not-found__text {
            color: var(--text-muted);
            margin-bottom: 24px;
        }
        
        .session-not-found__btn {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 12px 24px;
            background: var(--accent);
            color: white;
            border-radius: 10px;
            text-decoration: none;
            font-weight: 500;
        }
        
        /* ========================================
           LOADING STATE
           ======================================== */
        .session-loading {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 60vh;
            gap: 16px;
        }
        
        .session-loading__spinner {
            width: 48px;
            height: 48px;
            border: 3px solid var(--border);
            border-top-color: var(--accent);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        /* ========================================
           RESPONSIVE
           ======================================== */
        @media (max-width: 600px) {
            .session-hero__title {
                font-size: 28px;
            }
            
            .gm-bar {
                left: 16px;
                right: 16px;
                transform: none;
                flex-wrap: wrap;
                justify-content: center;
            }
            
            .settings-modal__dialog {
                max-height: calc(100vh - 40px);
            }
        }
    </style>
</head>
<body>
    <div class="app">
        <!-- Sidebar, Topbar, Footer werden von layout.js generiert -->
        <main class="main">
            <div class="main__content">
                <!-- Content wird dynamisch von JS generiert -->
            </div>
        </main>
    </div>
    
    <!-- GM Settings Modal -->
    <div class="settings-modal" id="sessionSettingsModal">
        <div class="settings-modal__backdrop" id="sessionSettingsBackdrop"></div>
        <div class="settings-modal__dialog">
            <div class="settings-modal__header">
                <h2 class="settings-modal__title">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="12" cy="12" r="3"/>
                        <path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"/>
                    </svg>
                    Session Einstellungen
                </h2>
                <button class="settings-modal__close" id="closeSessionSettingsModal">‚úï</button>
            </div>
            
            <div class="settings-modal__tabs">
                <button class="settings-modal__tab settings-modal__tab--active" data-tab="general">Allgemein</button>
                <button class="settings-modal__tab" data-tab="visibility">Sichtbarkeit</button>
                <button class="settings-modal__tab" data-tab="party">Party</button>
                <button class="settings-modal__tab" data-tab="advanced">Erweitert</button>
            </div>
            
            <div class="settings-modal__body">
                
                <!-- Tab: General -->
                <div class="settings-tab settings-tab--active" id="tab-general">
                    
                    <div class="settings-group">
                        <label class="settings-group__label">Cover</label>
                        <div class="settings-cover-preview">
                            <div class="settings-cover-preview__image" id="settingsCoverPreview">
                                <div class="settings-cover-preview__placeholder">üé≠</div>
                            </div>
                            <div class="settings-cover-preview__actions">
                                <button class="settings-cover-btn" id="uploadCoverBtn">
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="16" height="16">
                                        <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                                        <polyline points="17 8 12 3 7 8"/>
                                        <line x1="12" y1="3" x2="12" y2="15"/>
                                    </svg>
                                    Cover hochladen
                                </button>
                                <button class="settings-cover-btn settings-cover-btn--danger" id="removeCoverBtn">
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="16" height="16">
                                        <polyline points="3 6 5 6 21 6"/>
                                        <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/>
                                    </svg>
                                    Entfernen
                                </button>
                                <input type="file" id="coverFileInput" accept="image/*" style="display: none;">
                            </div>
                        </div>
                    </div>
                    
                    <div class="settings-group">
                        <label class="settings-group__label">Titel</label>
                        <input type="text" class="settings-input" id="settingsTitle" placeholder="Session-Titel">
                    </div>
                    
                    <div class="settings-group">
                        <label class="settings-group__label">Untertitel / Episode</label>
                        <input type="text" class="settings-input" id="settingsSubtitle" placeholder="z.B. Kapitel 3: Der versiegelte Turm">
                    </div>
                    
                    <div class="settings-group">
                        <label class="settings-group__label">Beschreibung</label>
                        <textarea class="settings-input settings-textarea" id="settingsDescription" placeholder="Kurze Beschreibung oder was bisher geschah..."></textarea>
                    </div>
                    
                    <div class="settings-row">
                        <div class="settings-group">
                            <label class="settings-group__label">Voice Chat</label>
                            <select class="settings-select" id="settingsVoiceType">
                                <option value="">Kein Voice Chat</option>
                                <option value="discord">Discord</option>
                                <option value="teamspeak">TeamSpeak</option>
                                <option value="zoom">Zoom</option>
                                <option value="googlemeet">Google Meet</option>
                                <option value="other">Andere</option>
                            </select>
                        </div>
                        <div class="settings-group">
                            <label class="settings-group__label">Voice Link</label>
                            <input type="url" class="settings-input" id="settingsVoiceLink" placeholder="https://...">
                        </div>
                    </div>
                    
                </div>
                
                <!-- Tab: Visibility -->
                <div class="settings-tab" id="tab-visibility">
                    
                    <p style="color: var(--text-muted); margin-bottom: 20px; font-size: 14px;">
                        Bestimme, was deine Spieler sehen k√∂nnen.
                    </p>
                    
                    <div class="session-toggle session-toggle--active" data-setting="showPartyHp">
                        <div class="session-toggle__text">
                            Party HP anzeigen
                            <span>Spieler sehen HP der anderen Charaktere</span>
                        </div>
                        <div class="session-toggle__switch"></div>
                    </div>
                    
                    <div class="session-toggle session-toggle--active" data-setting="showOnlineStatus">
                        <div class="session-toggle__text">
                            Online-Status anzeigen
                            <span>Gr√ºner Punkt zeigt wer online ist</span>
                        </div>
                        <div class="session-toggle__switch"></div>
                    </div>
                    
                    <div class="session-toggle session-toggle--active" data-setting="showLevel">
                        <div class="session-toggle__text">
                            Level anzeigen
                            <span>Level in den Party-Cards sichtbar</span>
                        </div>
                        <div class="session-toggle__switch"></div>
                    </div>
                    
                    <div class="session-toggle session-toggle--active" data-setting="showCountdown">
                        <div class="session-toggle__text">
                            Countdown anzeigen
                            <span>Zeit bis Session-Start sichtbar</span>
                        </div>
                        <div class="session-toggle__switch"></div>
                    </div>
                    
                    <div class="session-toggle session-toggle--active" data-setting="showDescription">
                        <div class="session-toggle__text">
                            Beschreibung anzeigen
                            <span>Beschreibungstext f√ºr Spieler sichtbar</span>
                        </div>
                        <div class="session-toggle__switch"></div>
                    </div>
                    
                    <div class="session-toggle" data-setting="hideCharacterNames">
                        <div class="session-toggle__text">
                            Charakternamen verbergen
                            <span>Nur Spielernamen anzeigen (f√ºr Blind-Sessions)</span>
                        </div>
                        <div class="session-toggle__switch"></div>
                    </div>
                    
                    <div class="settings-group" style="margin-top: 24px;">
                        <label class="settings-group__label">HP-Anzeige Stil</label>
                        <select class="settings-select" id="settingsHpStyle">
                            <option value="bar-numbers">Balken mit Zahlen</option>
                            <option value="bar-only">Nur Balken</option>
                            <option value="percent">Nur Prozent</option>
                            <option value="hidden">Verbergen</option>
                        </select>
                    </div>
                    
                </div>
                
                <!-- Tab: Party -->
                <div class="settings-tab" id="tab-party">
                    
                    <div class="session-toggle session-toggle--active" data-setting="playersCanSelectCharacter">
                        <div class="session-toggle__text">
                            Spieler w√§hlen selbst
                            <span>Spieler k√∂nnen ihren Charakter selbst ausw√§hlen</span>
                        </div>
                        <div class="session-toggle__switch"></div>
                    </div>
                    
                    <div class="session-toggle" data-setting="lockCharacters">
                        <div class="session-toggle__text">
                            Charaktere sperren
                            <span>Kein Wechsel mehr m√∂glich nach Auswahl</span>
                        </div>
                        <div class="session-toggle__switch"></div>
                    </div>
                    
                    <div class="session-toggle" data-setting="gmCanEditHp">
                        <div class="session-toggle__text">
                            GM kann HP bearbeiten
                            <span>Direkt auf der Session-Seite HP anpassen</span>
                        </div>
                        <div class="session-toggle__switch"></div>
                    </div>
                    
                    <div class="settings-group" style="margin-top: 24px;">
                        <label class="settings-group__label">Max. Spieler</label>
                        <select class="settings-select" id="settingsMaxPlayers">
                            <option value="2">2 Spieler</option>
                            <option value="3">3 Spieler</option>
                            <option value="4" selected>4 Spieler</option>
                            <option value="5">5 Spieler</option>
                            <option value="6">6 Spieler</option>
                            <option value="7">7 Spieler</option>
                            <option value="8">8 Spieler</option>
                            <option value="10">10 Spieler</option>
                            <option value="12">12 Spieler</option>
                        </select>
                    </div>
                    
                    <div class="settings-group">
                        <label class="settings-group__label">Party-Mitglieder</label>
                        <p style="color: var(--text-dim); font-size: 13px; margin-bottom: 12px;">
                            Klicke auf einen Spieler in der Session-Ansicht um HP zu bearbeiten oder zu entfernen.
                        </p>
                    </div>
                    
                </div>
                
                <!-- Tab: Advanced -->
                <div class="settings-tab" id="tab-advanced">
                    
                    <div class="settings-row">
                        <div class="settings-group">
                            <label class="settings-group__label">Datum</label>
                            <input type="date" class="settings-input" id="settingsDate">
                        </div>
                        <div class="settings-group">
                            <label class="settings-group__label">Uhrzeit</label>
                            <input type="time" class="settings-input" id="settingsTime" value="20:00">
                        </div>
                    </div>
                    
                    <div class="settings-row">
                        <div class="settings-group">
                            <label class="settings-group__label">Gesch√§tzte Dauer</label>
                            <select class="settings-select" id="settingsDuration">
                                <option value="1">~1 Stunde</option>
                                <option value="2">~2 Stunden</option>
                                <option value="3" selected>~3 Stunden</option>
                                <option value="4">~4 Stunden</option>
                                <option value="5">~5 Stunden</option>
                                <option value="6">~6+ Stunden</option>
                            </select>
                        </div>
                        <div class="settings-group">
                            <label class="settings-group__label">Wiederholung</label>
                            <select class="settings-select" id="settingsRecurring">
                                <option value="once">Einmalig</option>
                                <option value="spontan">Spontan / Flexibel</option>
                                <option value="weekly">W√∂chentlich</option>
                                <option value="biweekly">Alle 2 Wochen</option>
                                <option value="monthly">Monatlich</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="settings-row">
                        <div class="settings-group">
                            <label class="settings-group__label">Session-Nummer</label>
                            <input type="number" class="settings-input" id="settingsCurrentSession" min="1" value="1">
                        </div>
                        <div class="settings-group">
                            <label class="settings-group__label">Geplante Sessions</label>
                            <input type="number" class="settings-input" id="settingsSessionCount" min="1" value="1" placeholder="z.B. 12">
                        </div>
                    </div>
                    
                    <div class="settings-group">
                        <label class="settings-group__label">Tags</label>
                        <div class="settings-tags" id="settingsTags">
                            <span class="settings-tag" data-tag="roleplay">üé≠ Roleplay</span>
                            <span class="settings-tag" data-tag="combat">‚öîÔ∏è Combat</span>
                            <span class="settings-tag" data-tag="exploration">üó∫Ô∏è Exploration</span>
                            <span class="settings-tag" data-tag="puzzle">üß© R√§tsel</span>
                            <span class="settings-tag" data-tag="horror">üëª Horror</span>
                            <span class="settings-tag" data-tag="comedy">üòÑ Comedy</span>
                            <span class="settings-tag" data-tag="newbie">üå± Anf√§nger</span>
                            <span class="settings-tag" data-tag="oneshot">‚ö° One-Shot</span>
                        </div>
                    </div>
                    
                    <div class="settings-group" style="margin-top: 24px; padding-top: 24px; border-top: 1px solid var(--border);">
                        <label class="settings-group__label" style="color: var(--accent);">Gefahrenzone</label>
                        <button class="settings-cover-btn settings-cover-btn--danger" id="deleteSessionBtn" style="color: var(--accent);">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="16" height="16">
                                <polyline points="3 6 5 6 21 6"/>
                                <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/>
                            </svg>
                            Session l√∂schen
                        </button>
                    </div>
                    
                </div>
                
            </div>
            
            <div class="settings-modal__footer">
                <button class="settings-modal__btn settings-modal__btn--cancel" id="cancelSessionSettingsBtn">Abbrechen</button>
                <button class="settings-modal__btn settings-modal__btn--save" id="saveSessionSettingsBtn">Speichern</button>
            </div>
        </div>
    </div>
    
    <!-- Delete Confirmation Modal -->
    <div class="delete-modal" id="deleteModal">
        <div class="delete-modal__backdrop" id="deleteBackdrop"></div>
        <div class="delete-modal__dialog">
            <div class="delete-modal__icon">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <polyline points="3 6 5 6 21 6"/>
                    <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/>
                    <line x1="10" y1="11" x2="10" y2="17"/>
                    <line x1="14" y1="11" x2="14" y2="17"/>
                </svg>
            </div>
            <h3 class="delete-modal__title">Session l√∂schen?</h3>
            <p class="delete-modal__text">Diese Aktion kann nicht r√ºckg√§ngig gemacht werden.</p>
            <div class="delete-modal__actions">
                <button class="delete-modal__btn delete-modal__btn--cancel" id="cancelDeleteBtn">Abbrechen</button>
                <button class="delete-modal__btn delete-modal__btn--confirm" id="confirmDeleteBtn">L√∂schen</button>
            </div>
        </div>
    </div>
    
    <!-- Cover Cropper Modal -->
    <div class="settings-modal" id="cropperModal">
        <div class="settings-modal__backdrop" id="cropperBackdrop"></div>
        <div class="settings-modal__dialog" style="width: 500px;">
            <div class="settings-modal__header">
                <h2 class="settings-modal__title">Cover zuschneiden</h2>
                <button class="settings-modal__close" id="closeCropperModal">‚úï</button>
            </div>
            <div style="padding: 24px; background: #000;">
                <img id="cropperImage" style="max-width: 100%; display: block;">
            </div>
            <div class="settings-modal__footer">
                <button class="settings-modal__btn settings-modal__btn--cancel" id="cancelCropBtn">Abbrechen</button>
                <button class="settings-modal__btn settings-modal__btn--save" id="applyCropBtn">Anwenden</button>
            </div>
        </div>
    </div>
    
    <!-- Hidden Action Buttons for JS -->
    <div style="display: none;">
        <button id="startSessionBtn"></button>
        <button id="pauseSessionBtn"></button>
        <button id="resumeSessionBtn"></button>
        <button id="endSessionBtn"></button>
        <button id="editSessionBtn"></button>
    </div>

    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-storage-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    
    <!-- RIFT Core -->
    <script src="assets/js/firebase-config.js"></script>
    <script src="assets/js/app.js"></script>
    <script src="assets/js/layout.js"></script>
    <script src="assets/js/ui.js"></script>
    <script src="assets/js/settings.js"></script>
    <script src="assets/js/toast-service.js"></script>
    <script src="assets/js/user-service.js"></script>
    <script src="assets/js/room-service.js"></script>
    
    <!-- Cropper.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.6.1/cropper.min.js"></script>

    <script>
        // ========================================
        // COVER IMAGE DATABASE (IndexedDB)
        // ========================================
        const CoverDB = {
            dbName: 'RIFTCovers',
            storeName: 'covers',
            
            async open() {
                return new Promise((resolve, reject) => {
                    const request = indexedDB.open(this.dbName, 1);
                    request.onerror = () => reject(request.error);
                    request.onsuccess = () => resolve(request.result);
                    request.onupgradeneeded = (e) => {
                        const db = e.target.result;
                        if (!db.objectStoreNames.contains(this.storeName)) {
                            db.createObjectStore(this.storeName);
                        }
                    };
                });
            },
            
            async save(sessionId, imageData) {
                const db = await this.open();
                return new Promise((resolve, reject) => {
                    const tx = db.transaction(this.storeName, 'readwrite');
                    const store = tx.objectStore(this.storeName);
                    const request = store.put(imageData, sessionId);
                    request.onerror = () => reject(request.error);
                    request.onsuccess = () => resolve();
                });
            },
            
            async get(sessionId) {
                const db = await this.open();
                return new Promise((resolve, reject) => {
                    const tx = db.transaction(this.storeName, 'readonly');
                    const store = tx.objectStore(this.storeName);
                    const request = store.get(sessionId);
                    request.onerror = () => reject(request.error);
                    request.onsuccess = () => resolve(request.result);
                });
            },
            
            async delete(sessionId) {
                const db = await this.open();
                return new Promise((resolve, reject) => {
                    const tx = db.transaction(this.storeName, 'readwrite');
                    const store = tx.objectStore(this.storeName);
                    const request = store.delete(sessionId);
                    request.onerror = () => reject(request.error);
                    request.onsuccess = () => resolve();
                });
            }
        };

        // ========================================
        // SESSION STATE
        // ========================================
        let sessionData = null;
        let timerInterval = null;
        let sessionStartTime = null;
        let sessionUnsubscribe = null;
        let isGM = false;
        let cropper = null;
        
        // Session visibility settings (defaults)
        const defaultVisibility = {
            showPartyHp: true,
            showOnlineStatus: true,
            showLevel: true,
            showCountdown: true,
            showDescription: true,
            hideCharacterNames: false,
            playersCanSelectCharacter: true,
            lockCharacters: false,
            gmCanEditHp: false,
            hpStyle: 'bar-numbers'
        };
        
        // Get session ID from URL
        const urlParams = new URLSearchParams(window.location.search);
        const sessionId = urlParams.get('id');
        const currentRoomCode = localStorage.getItem('rift_current_room') || null;

        // ========================================
        // RENDER SESSION CONTENT
        // ========================================
        function renderSessionPage() {
            // Nach initLayout() ist der DOM neu aufgebaut - finde main__content
            const mainContent = document.querySelector('.main__content');
            if (!mainContent) {
                console.error('[Session] main__content not found');
                return;
            }
            
            // Finde oder erstelle sessionContent Container (nach Topbar)
            let content = document.getElementById('sessionContent');
            if (!content) {
                content = document.createElement('div');
                content.id = 'sessionContent';
                mainContent.appendChild(content);
            }
            
            // Get visibility settings
            const visibility = { ...defaultVisibility, ...(sessionData.visibility || {}) };
            
            // Format date
            let dateDisplay = { day: '--', num: '--', month: '--', full: '--', time: '20:00' };
            if (sessionData.date) {
                const dateObj = new Date(sessionData.date);
                const weekdays = ['Sonntag', 'Montag', 'Dienstag', 'Mittwoch', 'Donnerstag', 'Freitag', 'Samstag'];
                const weekdaysShort = ['SO', 'MO', 'DI', 'MI', 'DO', 'FR', 'SA'];
                const months = ['Januar', 'Februar', 'M√§rz', 'April', 'Mai', 'Juni', 'Juli', 'August', 'September', 'Oktober', 'November', 'Dezember'];
                const monthsShort = ['Jan', 'Feb', 'M√§r', 'Apr', 'Mai', 'Jun', 'Jul', 'Aug', 'Sep', 'Okt', 'Nov', 'Dez'];
                
                dateDisplay = {
                    day: weekdaysShort[dateObj.getDay()],
                    num: String(dateObj.getDate()).padStart(2, '0'),
                    month: monthsShort[dateObj.getMonth()],
                    full: `${weekdays[dateObj.getDay()]}, ${dateObj.getDate()}. ${months[dateObj.getMonth()]}`,
                    time: sessionData.time || '20:00'
                };
            }
            
            // Ruleset info
            const rulesetNames = {
                '5e2024': 'D&D 5E (2024)',
                'worldsapart': 'WORLDS APART',
                'htbah': 'HOW TO BE A HERO',
                'cyberpunk': 'CYBERPUNK RED'
            };
            const rulesetIcons = {
                '5e2024': 'assets/img/rulesets/ruleset_5e_2024.svg',
                'worldsapart': 'assets/img/rulesets/ruleset_worldsapart.svg',
                'htbah': 'assets/img/rulesets/ruleset_htbah.svg',
                'cyberpunk': 'assets/img/rulesets/ruleset_cyberpunkred.svg'
            };
            
            // Status
            const statusMap = {
                'planned': { text: 'Geplant', class: 'planned' },
                'live': { text: 'Live', class: 'live' },
                'paused': { text: 'Pausiert', class: 'paused' },
                'ended': { text: 'Beendet', class: 'ended' }
            };
            const status = statusMap[sessionData.status] || statusMap.planned;
            
            // Build subtitle
            const subtitleParts = [];
            if (sessionData.subtitle) subtitleParts.push(sessionData.subtitle);
            if (sessionData.sessionCount > 1) {
                subtitleParts.push(`Session ${sessionData.currentSession || 1}/${sessionData.sessionCount}`);
            }
            subtitleParts.push(`${sessionData.maxPlayers || 4} Spieler`);
            
            // Party data
            const players = sessionData.players || [];
            const partyCharacters = sessionData.partyCharacters || [];
            
            content.innerHTML = `
                <!-- Page Header -->
                <div class="session-page-header">
                    <a href="sessions.html" class="session-back-btn">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <polyline points="15 18 9 12 15 6"/>
                        </svg>
                        Zur√ºck
                    </a>
                </div>
                
                <!-- Session Hero -->
                <div class="session-hero">
                    <!-- Cover -->
                    <div class="session-hero__cover" id="sessionCover" ${isGM ? 'onclick="openSettingsModal()"' : ''}>
                        ${sessionData.hasCover ? '' : `
                            <div class="session-hero__cover-placeholder">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                                    <rect x="3" y="3" width="18" height="18" rx="2" ry="2"/>
                                    <circle cx="8.5" cy="8.5" r="1.5"/>
                                    <polyline points="21 15 16 10 5 21"/>
                                </svg>
                                <span>Kein Cover</span>
                            </div>
                        `}
                        ${isGM ? '<button class="session-hero__cover-edit" onclick="event.stopPropagation(); openSettingsModal();">üì∑ √Ñndern</button>' : ''}
                    </div>
                    
                    <!-- Info -->
                    <div class="session-hero__info">
                        <!-- Top Row -->
                        <div class="session-hero__top-row">
                            <div class="session-hero__ruleset">
                                <img src="${rulesetIcons[sessionData.ruleset] || rulesetIcons.worldsapart}" alt="">
                                ${rulesetNames[sessionData.ruleset] || sessionData.ruleset}
                            </div>
                            <div class="session-hero__status session-hero__status--${status.class}">
                                <span class="session-hero__status-dot"></span>
                                ${status.text}
                            </div>
                        </div>
                        
                        <!-- Title -->
                        <h1 class="session-hero__title">${sessionData.name || 'Unbenannte Session'}</h1>
                        <p class="session-hero__subtitle">${subtitleParts.join(' ¬∑ ')}</p>
                        
                        <!-- Date/Time/Countdown -->
                        <div class="session-hero__datetime">
                            <div class="session-date-box">
                                <div class="session-date-box__day">${dateDisplay.day}</div>
                                <div class="session-date-box__num">${dateDisplay.num}</div>
                                <div class="session-date-box__month">${dateDisplay.month}</div>
                            </div>
                            <div class="session-time-box">
                                <div class="session-time-box__label">Startzeit</div>
                                <div class="session-time-box__value">${dateDisplay.time} Uhr</div>
                            </div>
                            ${sessionData.status === 'live' ? `
                                <div class="session-live-timer">
                                    <div>
                                        <div class="session-live-timer__label">Spielzeit</div>
                                        <div class="session-live-timer__value" id="liveTimer">0:00:00</div>
                                    </div>
                                </div>
                            ` : (visibility.showCountdown && sessionData.status === 'planned' ? `
                                <div class="session-countdown" id="sessionCountdown">
                                    <div class="countdown-item">
                                        <span class="countdown-item__value" id="countdownDays">0</span>
                                        <span class="countdown-item__label">Tage</span>
                                    </div>
                                    <span class="countdown-sep">:</span>
                                    <div class="countdown-item">
                                        <span class="countdown-item__value" id="countdownHours">0</span>
                                        <span class="countdown-item__label">Std</span>
                                    </div>
                                    <span class="countdown-sep">:</span>
                                    <div class="countdown-item">
                                        <span class="countdown-item__value" id="countdownMins">0</span>
                                        <span class="countdown-item__label">Min</span>
                                    </div>
                                </div>
                            ` : '')}
                        </div>
                        
                        <!-- Description -->
                        ${(visibility.showDescription || isGM) && sessionData.description ? `
                            <div class="session-hero__description">
                                <div class="session-hero__description-title">Beschreibung</div>
                                <div class="session-hero__description-text">${formatDescription(sessionData.description)}</div>
                            </div>
                        ` : ''}
                        
                        <!-- Voice Link -->
                        ${sessionData.voiceLink ? `
                            <a href="${sessionData.voiceLink}" target="_blank" class="session-hero__voice-link">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"/>
                                    <path d="M19 10v2a7 7 0 0 1-14 0v-2"/>
                                </svg>
                                ${getVoicePlatformName(sessionData.voiceLink)}
                            </a>
                        ` : ''}
                    </div>
                </div>
                
                <!-- Party Section -->
                <section class="session-section">
                    <div class="session-section__header">
                        <h2 class="session-section__title">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor" style="color: var(--accent);">
                                <path d="M16.5 13C15.3 13 14.29 13.62 13.67 14.5H10.33C9.71 13.62 8.7 13 7.5 13C5.57 13 4 14.57 4 16.5C4 18.43 5.57 20 7.5 20C8.7 20 9.71 19.38 10.33 18.5H13.67C14.29 19.38 15.3 20 16.5 20C18.43 20 20 18.43 20 16.5C20 14.57 18.43 13 16.5 13ZM7.5 18.5C6.4 18.5 5.5 17.6 5.5 16.5S6.4 14.5 7.5 14.5 9.5 15.4 9.5 16.5 8.6 18.5 7.5 18.5ZM16.5 18.5C15.4 18.5 14.5 17.6 14.5 16.5S15.4 14.5 16.5 14.5 18.5 15.4 18.5 16.5 17.6 18.5 16.5 18.5Z"/>
                                <path d="M12 11C14.21 11 16 9.21 16 7S14.21 3 12 3 8 4.79 8 7 9.79 11 12 11Z"/>
                            </svg>
                            Die Gruppe
                            <span class="session-section__count">${partyCharacters.length} / ${sessionData.maxPlayers || 4} Charaktere</span>
                        </h2>
                    </div>
                    <div class="party-grid" id="partyGrid">
                        ${renderPartyCards(visibility)}
                    </div>
                </section>
                
                <!-- Quick Actions -->
                <section class="session-section">
                    <div class="session-section__header">
                        <h2 class="session-section__title">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor" style="color: var(--accent);">
                                <path d="M14 4.43L10 4.42C7.05 4.4 5 6.45 5 9.4V10.6C5 13.55 7.03 15.59 10 15.59H14C16.97 15.6 19 13.56 19 10.61V9.4C19 6.45 16.97 4.43 14 4.43ZM14.72 11.72C14.58 11.86 14.4 11.92 14.22 11.92C14.04 11.92 13.86 11.86 13.72 11.72L12.5 10.5V13.5C12.5 13.91 12.16 14.25 11.75 14.25C11.34 14.25 11 13.91 11 13.5V10.5L9.78 11.72C9.49 12.01 9.01 12.01 8.72 11.72C8.43 11.43 8.43 10.95 8.72 10.66L11.22 8.16C11.51 7.87 11.99 7.87 12.28 8.16L14.78 10.66C15.07 10.95 15.07 11.43 14.72 11.72Z"/>
                                <path d="M19.44 17.61C19.3 17.52 19.13 17.49 18.96 17.52L14.29 18.3C14.01 18.35 13.72 18.37 13.44 18.37H10C9.59 18.37 9.25 18.01 9.25 17.6C9.25 17.19 9.59 16.85 10 16.85H13.44C14.03 16.85 14.61 16.79 15.18 16.68L15.96 16.54C16.2 16.5 16.46 16.54 16.67 16.67L17.85 17.4C18.59 17.83 19.5 17.27 19.5 16.4C19.5 16.13 19.4 15.87 19.22 15.68L17.96 14.26C17.35 13.57 16.49 13.16 15.57 13.12L14.37 13.07C13.93 13.05 13.5 13.08 13.08 13.17L10.24 13.78C9.83 13.87 9.44 13.61 9.35 13.2C9.26 12.79 9.52 12.4 9.93 12.31L12.78 11.69C13.31 11.58 13.85 11.54 14.39 11.57L15.59 11.62C16.89 11.67 18.1 12.24 18.96 13.2L20.22 14.62C20.73 15.18 21 15.91 21 16.68C21 18.97 18.6 20.43 16.53 19.38L15.35 18.77L19.63 18.06C20.08 17.98 20.38 17.55 20.3 17.1C20.24 16.86 20.13 16.66 19.93 16.54L19.44 17.61Z"/>
                            </svg>
                            Schnellzugriff
                        </h2>
                    </div>
                    <div class="quick-actions">
                        ${sessionData.voiceLink ? `
                            <a href="${sessionData.voiceLink}" target="_blank" class="quick-action quick-action--discord">
                                <svg class="quick-action__icon" width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                                    <path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"/>
                                    <path d="M19 10v2a7 7 0 0 1-14 0v-2"/>
                                    <line x1="12" y1="19" x2="12" y2="23" stroke="currentColor" stroke-width="2"/>
                                    <line x1="8" y1="23" x2="16" y2="23" stroke="currentColor" stroke-width="2"/>
                                </svg>
                                <div class="quick-action__text">
                                    Voice Chat
                                    <span>${getVoicePlatformName(sessionData.voiceLink)} beitreten</span>
                                </div>
                            </a>
                        ` : ''}
                        <a href="dice.html" class="quick-action">
                            <svg class="quick-action__icon" width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                                <path d="M20.47 6.62L12.57 2.18C12.41 2.06 12.21 2 12 2S11.59 2.06 11.43 2.18L3.53 6.62C3.21 6.79 3 7.12 3 7.5V16.5C3 16.88 3.21 17.21 3.53 17.38L11.43 21.82C11.59 21.94 11.79 22 12 22S12.41 21.94 12.57 21.82L20.47 17.38C20.79 17.21 21 16.88 21 16.5V7.5C21 7.12 20.79 6.79 20.47 6.62M11.45 15.96L6.31 15.93V14.91C6.31 14.91 9.74 11.58 9.75 10.57C9.75 9.33 8.73 9.46 8.73 9.46S7.75 9.5 7.64 10.71L6.14 10.76C6.14 10.76 6.18 8.26 8.83 8.26C11.2 8.26 11.23 10.04 11.23 10.5C11.23 12.18 8.15 14.77 8.15 14.77L11.45 14.76V15.96M17.5 13.5C17.5 14.9 16.35 16.05 14.93 16.05C13.5 16.05 12.36 14.9 12.36 13.5V10.84C12.36 9.42 13.5 8.27 14.93 8.27S17.5 9.42 17.5 10.84V13.5M16 10.77V13.53C16 14.12 15.5 14.6 14.92 14.6C14.34 14.6 13.86 14.12 13.86 13.53V10.77C13.86 10.18 14.34 9.71 14.92 9.71C15.5 9.71 16 10.18 16 10.77Z"/>
                            </svg>
                            W√ºrfeln
                        </a>
                        <a href="sheet.html" class="quick-action">
                            <svg class="quick-action__icon" width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                                <path fill-rule="evenodd" clip-rule="evenodd" d="M4.17157 3.17157C3 4.34315 3 6.22876 3 10V14C3 17.7712 3 19.6569 4.17157 20.8284C5.34315 22 7.22876 22 11 22H13C16.7712 22 18.6569 22 19.8284 20.8284C21 19.6569 21 17.7712 21 14V10C21 6.22876 21 4.34315 19.8284 3.17157C18.6569 2 16.7712 2 13 2H11C7.22876 2 5.34315 2 4.17157 3.17157ZM7.25 8C7.25 7.58579 7.58579 7.25 8 7.25H16C16.4142 7.25 16.75 7.58579 16.75 8C16.75 8.41421 16.4142 8.75 16 8.75H8C7.58579 8.75 7.25 8.41421 7.25 8ZM7.25 12C7.25 11.5858 7.58579 11.25 8 11.25H16C16.4142 11.25 16.75 11.5858 16.75 12C16.75 12.4142 16.4142 12.75 16 12.75H8C7.58579 12.75 7.25 12.4142 7.25 12ZM8 15.25C7.58579 15.25 7.25 15.5858 7.25 16C7.25 16.4142 7.58579 16.75 8 16.75H13C13.4142 16.75 13.75 16.4142 13.75 16C13.75 15.5858 13.4142 15.25 13 15.25H8Z"/>
                            </svg>
                            Mein Bogen
                        </a>
                        <a href="chat.html" class="quick-action">
                            <svg class="quick-action__icon" width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                                <path fill-rule="evenodd" clip-rule="evenodd" d="M12 22C17.5228 22 22 17.5228 22 12C22 6.47715 17.5228 2 12 2C6.47715 2 2 6.47715 2 12C2 13.5997 2.37562 15.1116 3.04346 16.4525C3.22094 16.8088 3.28001 17.2161 3.17712 17.6006L2.58151 19.8267C2.32295 20.793 3.20701 21.677 4.17335 21.4185L6.39939 20.8229C6.78393 20.72 7.19121 20.7791 7.54753 20.9565C8.88837 21.6244 10.4003 22 12 22Z"/>
                            </svg>
                            Chat
                        </a>
                        <a href="map.html" class="quick-action">
                            <svg class="quick-action__icon" width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                                <path fill-rule="evenodd" clip-rule="evenodd" d="M12 22C17.5228 22 22 17.5228 22 12C22 6.47715 17.5228 2 12 2C6.47715 2 2 6.47715 2 12C2 17.5228 6.47715 22 12 22ZM13.9563 14.0949C13.763 14.2644 13.5167 14.3629 13.024 14.56C10.7142 15.4839 9.55936 15.9459 8.89971 15.4976C8.7433 15.3913 8.6084 15.2564 8.50212 15.1C8.05386 14.4404 8.51582 13.2855 9.43973 10.9757C9.6368 10.483 9.73533 10.2367 9.9048 10.0434C9.94799 9.99419 9.99435 9.94782 10.0436 9.90464C10.2368 9.73517 10.4832 9.63663 10.9759 9.43956C13.2856 8.51565 14.4405 8.0537 15.1002 8.50196C15.2566 8.60824 15.3915 8.74314 15.4978 8.89954C15.946 9.5592 15.4841 10.7141 14.5602 13.0239C14.3631 13.5165 14.2646 13.7629 14.0951 13.9561C14.0519 14.0054 14.0055 14.0517 13.9563 14.0949Z"/>
                            </svg>
                            Karte
                        </a>
                        <a href="whiteboard.html" class="quick-action">
                            <svg class="quick-action__icon" width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                                <path fill-rule="evenodd" clip-rule="evenodd" d="M3.46447 3.46447C2 4.92893 2 7.28595 2 12C2 16.714 2 19.0711 3.46447 20.5355C4.92893 22 7.28595 22 12 22C16.714 22 19.0711 22 20.5355 20.5355C22 19.0711 22 16.714 22 12C22 7.28595 22 4.92893 20.5355 3.46447C19.0711 2 16.714 2 12 2C7.28595 2 4.92893 2 3.46447 3.46447ZM17 12.25C17.4142 12.25 17.75 12.5858 17.75 13V18C17.75 18.4142 17.4142 18.75 17 18.75C16.5858 18.75 16.25 18.4142 16.25 18V13C16.25 12.5858 16.5858 12.25 17 12.25ZM12.75 6C12.75 5.58579 12.4142 5.25 12 5.25C11.5858 5.25 11.25 5.58579 11.25 6V18C11.25 18.4142 11.5858 18.75 12 18.75C12.4142 18.75 12.75 18.4142 12.75 18V6ZM7 8.25C7.41421 8.25 7.75 8.58579 7.75 9V18C7.75 18.4142 7.41421 18.75 7 18.75C6.58579 18.75 6.25 18.4142 6.25 18V9C6.25 8.58579 6.58579 8.25 7 8.25Z"/>
                            </svg>
                            Whiteboard
                        </a>
                        <div class="invite-box">
                            <input type="text" class="invite-box__input" id="inviteLink" value="${window.location.origin}/login.html?room=${currentRoomCode || ''}" readonly>
                            <button class="invite-box__btn" onclick="copyInviteLink()">Kopieren</button>
                        </div>
                    </div>
                </section>
                
                <!-- GM Bar -->
                <div class="gm-bar ${isGM ? 'gm-bar--visible' : ''}" id="gmBar">
                    ${renderGMBarButtons()}
                </div>
            `;
            
            // Load cover image
            if (sessionData.hasCover) {
                loadCoverImage();
            }
            
            // Start timer if live
            if (sessionData.status === 'live') {
                startTimer();
            }
            
            // Update countdown
            if (sessionData.status === 'planned') {
                updateCountdown();
            }
            
            // Update document title
            document.title = `RIFT ‚Äì ${sessionData.name || 'Session'}`;
        }
        
        function renderPartyCards(visibility) {
            const players = sessionData.players || [];
            const partyCharacters = sessionData.partyCharacters || [];
            const maxPlayers = sessionData.maxPlayers || 4;
            
            let html = '';
            
            // GM Card (always first if we have GM data)
            const gmData = sessionData.gm || { name: sessionData.gmName || 'Game Master', color: '#FF4655' };
            html += `
                <div class="party-card party-card--gm">
                    <span class="party-card__gm-badge">GM</span>
                    <div class="party-card__portrait" style="border-color: ${gmData.color || 'var(--accent)'}; color: ${gmData.color || 'var(--accent)'};">
                        ${gmData.avatar ? `<img src="${gmData.avatar}" alt="">` : (gmData.name || 'GM')[0].toUpperCase()}
                        ${visibility.showOnlineStatus ? `<div class="party-card__online party-card__online--on"></div>` : ''}
                    </div>
                    <div class="party-card__info">
                        <div class="party-card__name">${gmData.name || 'Game Master'}</div>
                        <div class="party-card__class">Spielleiter</div>
                    </div>
                </div>
            `;
            
            // Party Characters
            partyCharacters.forEach((char, index) => {
                const player = players.find(p => p.id === char.playerId) || {};
                const hpPercent = char.maxHp ? Math.round((char.hp / char.maxHp) * 100) : 100;
                const hpClass = hpPercent > 60 ? 'high' : hpPercent > 30 ? 'mid' : 'low';
                
                html += `
                    <div class="party-card" data-char-id="${char.id}">
                        <div class="party-card__portrait party-card__portrait--has-char" style="--char-color: ${char.color || '#8B5CF6'};">
                            ${char.portrait ? `<img src="${char.portrait}" alt="">` : (char.name || '?')[0].toUpperCase()}
                            ${visibility.showOnlineStatus ? `<div class="party-card__online party-card__online--${player.online ? 'on' : 'off'}"></div>` : ''}
                        </div>
                        <div class="party-card__info">
                            <div class="party-card__name">${visibility.hideCharacterNames ? (player.name || 'Spieler') : (char.name || 'Unbenannt')}</div>
                            <div class="party-card__class">${char.class || char.profession || 'Abenteurer'}${visibility.showLevel && char.level ? ` ¬∑ Lvl ${char.level}` : ''}</div>
                            ${visibility.showPartyHp && visibility.hpStyle !== 'hidden' ? `
                                <div class="party-card__hp">
                                    ${visibility.hpStyle !== 'percent' ? `
                                        <div class="party-card__hp-bar">
                                            <div class="party-card__hp-fill party-card__hp-fill--${hpClass}" style="width: ${hpPercent}%;"></div>
                                        </div>
                                    ` : ''}
                                    <span class="party-card__hp-text">
                                        ${visibility.hpStyle === 'percent' ? `${hpPercent}%` : 
                                          visibility.hpStyle === 'bar-only' ? '' : 
                                          `${char.hp || 0}/${char.maxHp || 0}`}
                                    </span>
                                </div>
                            ` : ''}
                        </div>
                        <div class="party-card__player">${player.name || 'Spieler'}</div>
                        ${isGM ? `
                            <div class="party-card__actions">
                                <button class="party-card__action-btn" onclick="editPartyMember('${char.id}')" title="Bearbeiten">
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/>
                                        <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/>
                                    </svg>
                                </button>
                                <button class="party-card__action-btn" onclick="removePartyMember('${char.id}')" title="Entfernen">
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <line x1="18" y1="6" x2="6" y2="18"/>
                                        <line x1="6" y1="6" x2="18" y2="18"/>
                                    </svg>
                                </button>
                            </div>
                        ` : ''}
                    </div>
                `;
            });
            
            // Empty Slots
            const emptySlots = Math.max(0, maxPlayers - partyCharacters.length - 1); // -1 for GM
            for (let i = 0; i < emptySlots; i++) {
                html += `
                    <div class="party-card party-card--empty">
                        <div class="party-card__portrait" style="color: var(--text-dim); font-size: 24px;">+</div>
                        <div class="party-card__info">
                            <div class="party-card__empty-text">
                                <strong>Freier Platz</strong>
                                <span>Wartet auf Spieler...</span>
                            </div>
                        </div>
                    </div>
                `;
            }
            
            return html;
        }
        
        function renderGMBarButtons() {
            const status = sessionData?.status || 'planned';
            
            switch (status) {
                case 'planned':
                    return `
                        <button class="gm-bar__btn gm-bar__btn--start" onclick="startSession()">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polygon points="5 3 19 12 5 21 5 3"/></svg>
                            Session starten
                        </button>
                        <button class="gm-bar__btn gm-bar__btn--secondary" onclick="openSettingsModal()">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"/></svg>
                            Einstellungen
                        </button>
                    `;
                case 'live':
                    return `
                        <button class="gm-bar__btn gm-bar__btn--pause" onclick="pauseSession()">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="6" y="4" width="4" height="16"/><rect x="14" y="4" width="4" height="16"/></svg>
                            Pausieren
                        </button>
                        <button class="gm-bar__btn gm-bar__btn--end" onclick="endSession()">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="6" y="6" width="12" height="12" rx="2"/></svg>
                            Beenden
                        </button>
                        <button class="gm-bar__btn gm-bar__btn--secondary" onclick="openSettingsModal()">‚öôÔ∏è</button>
                    `;
                case 'paused':
                    return `
                        <button class="gm-bar__btn gm-bar__btn--resume" onclick="resumeSession()">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polygon points="5 3 19 12 5 21 5 3"/></svg>
                            Fortsetzen
                        </button>
                        <button class="gm-bar__btn gm-bar__btn--end" onclick="endSession()">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="6" y="6" width="12" height="12" rx="2"/></svg>
                            Beenden
                        </button>
                        <button class="gm-bar__btn gm-bar__btn--secondary" onclick="openSettingsModal()">‚öôÔ∏è</button>
                    `;
                case 'ended':
                    return `
                        <button class="gm-bar__btn gm-bar__btn--start" onclick="reopenSession()">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"/><path d="M3 3v5h5"/></svg>
                            Wiederaufnehmen
                        </button>
                        <button class="gm-bar__btn gm-bar__btn--secondary" onclick="openSettingsModal()">‚öôÔ∏è</button>
                    `;
                default:
                    return '';
            }
        }

        // ========================================
        // HELPER FUNCTIONS
        // ========================================
        
        function formatDescription(text) {
            if (!text) return '';
            return text
                .split(/\n\n+/)
                .filter(p => p.trim())
                .map(p => `<p>${p.replace(/\n/g, '<br>')}</p>`)
                .join('');
        }
        
        function getVoicePlatformName(url) {
            if (!url) return 'Voice Chat';
            const lower = url.toLowerCase();
            if (lower.includes('discord')) return 'Discord';
            if (lower.includes('teamspeak')) return 'TeamSpeak';
            if (lower.includes('zoom')) return 'Zoom';
            if (lower.includes('meet.google')) return 'Google Meet';
            return 'Voice Chat';
        }
        
        function copyInviteLink() {
            const input = document.getElementById('inviteLink');
            input.select();
            document.execCommand('copy');
            if (window.RIFT?.ui?.Toast) {
                RIFT.ui.Toast.success('Link kopiert!');
            }
        }
        
        function getCharactersForRuleset(ruleset) {
            try {
                const stored = localStorage.getItem('rift_characters');
                if (!stored) return [];
                
                const allCharacters = JSON.parse(stored);
                let characterArray;
                if (Array.isArray(allCharacters)) {
                    characterArray = allCharacters;
                } else if (typeof allCharacters === 'object' && allCharacters !== null) {
                    characterArray = Object.values(allCharacters);
                } else {
                    return [];
                }
                
                return characterArray.filter(c => c.ruleset === ruleset && c.name);
            } catch (e) {
                console.warn('[Session] Failed to load characters:', e);
                return [];
            }
        }

        // ========================================
        // SESSION CONTROL FUNCTIONS
        // ========================================
        
        function startSession() {
            if (!sessionData) return;
            sessionData.status = 'live';
            sessionData.startTime = Date.now();
            sessionData.totalPausedMs = 0;
            
            localStorage.setItem('rift_active_session', JSON.stringify({
                id: sessionData.id,
                name: sessionData.name,
                startTime: sessionData.startTime
            }));
            
            saveSession();
            renderSessionPage();
            
            if (window.RIFT?.ui?.Toast) {
                RIFT.ui.Toast.success('Session gestartet!');
            }
        }
        
        function pauseSession() {
            if (!sessionData) return;
            sessionData.status = 'paused';
            sessionData.pausedTime = Date.now();
            stopTimer();
            
            saveSession();
            renderSessionPage();
            
            if (window.RIFT?.ui?.Toast) {
                RIFT.ui.Toast.info('Session pausiert');
            }
        }
        
        function resumeSession() {
            if (!sessionData) return;
            if (sessionData.pausedTime) {
                const pausedDuration = Date.now() - sessionData.pausedTime;
                sessionData.totalPausedMs = (sessionData.totalPausedMs || 0) + pausedDuration;
            }
            
            sessionData.status = 'live';
            sessionData.pausedTime = null;
            
            saveSession();
            renderSessionPage();
            
            if (window.RIFT?.ui?.Toast) {
                RIFT.ui.Toast.success('Session fortgesetzt!');
            }
        }
        
        function endSession() {
            if (!sessionData) return;
            if (!confirm('Session wirklich beenden?')) return;
            
            const endTime = Date.now();
            let totalDuration = endTime - sessionData.startTime;
            if (sessionData.pausedTime) {
                totalDuration -= (endTime - sessionData.pausedTime);
            }
            totalDuration -= (sessionData.totalPausedMs || 0);
            
            sessionData.status = 'ended';
            sessionData.endTime = endTime;
            sessionData.duration = Math.round(totalDuration / 1000 / 60);
            stopTimer();
            
            localStorage.removeItem('rift_active_session');
            
            saveSession();
            renderSessionPage();
            
            if (window.RIFT?.ui?.Toast) {
                RIFT.ui.Toast.success(`Session beendet! Dauer: ${Math.floor(sessionData.duration / 60)}h ${sessionData.duration % 60}min`);
            }
        }
        
        function reopenSession() {
            if (!sessionData) return;
            sessionData.status = 'live';
            sessionData.endTime = null;
            
            if (!sessionData.startTime) {
                sessionData.startTime = Date.now();
                sessionData.totalPausedMs = 0;
            }
            
            localStorage.setItem('rift_active_session', JSON.stringify({
                id: sessionData.id,
                name: sessionData.name,
                startTime: sessionData.startTime
            }));
            
            saveSession();
            renderSessionPage();
            
            if (window.RIFT?.ui?.Toast) {
                RIFT.ui.Toast.success('Session wiederaufgenommen!');
            }
        }

        // ========================================
        // TIMER FUNCTIONS
        // ========================================
        
        function startTimer() {
            if (timerInterval) clearInterval(timerInterval);
            
            const updateTimer = () => {
                const timerEl = document.getElementById('liveTimer');
                if (!timerEl || !sessionData?.startTime) return;
                
                let elapsed = Date.now() - sessionData.startTime;
                elapsed -= (sessionData.totalPausedMs || 0);
                if (sessionData.pausedTime) {
                    elapsed -= (Date.now() - sessionData.pausedTime);
                }
                
                const hours = Math.floor(elapsed / 3600000);
                const minutes = Math.floor((elapsed % 3600000) / 60000);
                const seconds = Math.floor((elapsed % 60000) / 1000);
                
                timerEl.textContent = `${hours}:${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
            };
            
            updateTimer();
            timerInterval = setInterval(updateTimer, 1000);
        }
        
        function stopTimer() {
            if (timerInterval) {
                clearInterval(timerInterval);
                timerInterval = null;
            }
        }
        
        function updateCountdown() {
            if (!sessionData?.date || sessionData.status !== 'planned') return;
            
            const sessionDateTime = new Date(`${sessionData.date}T${sessionData.time || '20:00'}`);
            const now = new Date();
            const diff = sessionDateTime - now;
            
            if (diff <= 0) {
                const countdown = document.getElementById('sessionCountdown');
                if (countdown) countdown.style.display = 'none';
                return;
            }
            
            const days = Math.floor(diff / 86400000);
            const hours = Math.floor((diff % 86400000) / 3600000);
            const mins = Math.floor((diff % 3600000) / 60000);
            
            const daysEl = document.getElementById('countdownDays');
            const hoursEl = document.getElementById('countdownHours');
            const minsEl = document.getElementById('countdownMins');
            
            if (daysEl) daysEl.textContent = days;
            if (hoursEl) hoursEl.textContent = hours;
            if (minsEl) minsEl.textContent = mins;
            
            // Update every minute
            setTimeout(updateCountdown, 60000);
        }

        // ========================================
        // COVER IMAGE
        // ========================================
        
        function loadCoverImage() {
            CoverDB.get(sessionId).then(coverImage => {
                if (coverImage) {
                    const coverEl = document.getElementById('sessionCover');
                    if (coverEl) {
                        coverEl.innerHTML = `<img src="${coverImage}" alt="Session Cover">` + 
                            (isGM ? '<button class="session-hero__cover-edit" onclick="event.stopPropagation(); openSettingsModal();">üì∑ √Ñndern</button>' : '');
                    }
                    
                    // Also update settings preview
                    const previewEl = document.getElementById('settingsCoverPreview');
                    if (previewEl) {
                        previewEl.innerHTML = `<img src="${coverImage}" alt="">`;
                    }
                }
            }).catch(err => {
                console.warn('[Session] Failed to load cover:', err);
            });
        }

        // ========================================
        // GM SETTINGS MODAL
        // ========================================
        
        function openSettingsModal() {
            if (!isGM || !sessionData) return;
            
            const modal = document.getElementById('sessionSettingsModal');
            modal.classList.add('settings-modal--open');
            document.body.style.overflow = 'hidden';
            
            // Populate form fields
            document.getElementById('settingsTitle').value = sessionData.name || '';
            document.getElementById('settingsSubtitle').value = sessionData.subtitle || '';
            document.getElementById('settingsDescription').value = sessionData.description || '';
            document.getElementById('settingsVoiceLink').value = sessionData.voiceLink || '';
            document.getElementById('settingsDate').value = sessionData.date || '';
            document.getElementById('settingsTime').value = sessionData.time || '20:00';
            document.getElementById('settingsDuration').value = sessionData.duration || '3';
            document.getElementById('settingsRecurring').value = sessionData.recurring || 'once';
            document.getElementById('settingsCurrentSession').value = sessionData.currentSession || 1;
            document.getElementById('settingsSessionCount').value = sessionData.sessionCount || 1;
            document.getElementById('settingsMaxPlayers').value = sessionData.maxPlayers || 4;
            document.getElementById('settingsHpStyle').value = sessionData.visibility?.hpStyle || 'bar-numbers';
            
            // Detect voice type
            if (sessionData.voiceLink) {
                const link = sessionData.voiceLink.toLowerCase();
                if (link.includes('discord')) document.getElementById('settingsVoiceType').value = 'discord';
                else if (link.includes('teamspeak')) document.getElementById('settingsVoiceType').value = 'teamspeak';
                else if (link.includes('zoom')) document.getElementById('settingsVoiceType').value = 'zoom';
                else if (link.includes('meet.google')) document.getElementById('settingsVoiceType').value = 'googlemeet';
                else document.getElementById('settingsVoiceType').value = 'other';
            }
            
            // Visibility toggles
            const visibility = { ...defaultVisibility, ...(sessionData.visibility || {}) };
            document.querySelectorAll('.session-toggle[data-setting]').forEach(toggle => {
                const setting = toggle.dataset.setting;
                if (visibility[setting]) {
                    toggle.classList.add('session-toggle--active');
                } else {
                    toggle.classList.remove('session-toggle--active');
                }
            });
            
            // Tags
            const tags = sessionData.tags || [];
            document.querySelectorAll('.settings-tag[data-tag]').forEach(tag => {
                if (tags.includes(tag.dataset.tag)) {
                    tag.classList.add('settings-tag--active');
                } else {
                    tag.classList.remove('settings-tag--active');
                }
            });
            
            // Cover preview
            if (sessionData.hasCover) {
                CoverDB.get(sessionId).then(coverImage => {
                    if (coverImage) {
                        document.getElementById('settingsCoverPreview').innerHTML = `<img src="${coverImage}" alt="">`;
                    }
                });
            }
        }
        
        function closeSessionSettingsModal() {
            const modal = document.getElementById('sessionSettingsModal');
            modal.classList.remove('settings-modal--open');
            document.body.style.overflow = '';
        }
        
        function saveSettings() {
            if (!sessionData) return;
            
            // Basic info
            sessionData.name = document.getElementById('settingsTitle').value;
            sessionData.subtitle = document.getElementById('settingsSubtitle').value;
            sessionData.description = document.getElementById('settingsDescription').value;
            sessionData.voiceLink = document.getElementById('settingsVoiceLink').value;
            sessionData.date = document.getElementById('settingsDate').value;
            sessionData.time = document.getElementById('settingsTime').value;
            sessionData.duration = parseInt(document.getElementById('settingsDuration').value) || 3;
            sessionData.recurring = document.getElementById('settingsRecurring').value;
            sessionData.currentSession = parseInt(document.getElementById('settingsCurrentSession').value) || 1;
            sessionData.sessionCount = parseInt(document.getElementById('settingsSessionCount').value) || 1;
            sessionData.maxPlayers = parseInt(document.getElementById('settingsMaxPlayers').value) || 4;
            
            // Visibility settings
            sessionData.visibility = sessionData.visibility || {};
            document.querySelectorAll('.session-toggle[data-setting]').forEach(toggle => {
                sessionData.visibility[toggle.dataset.setting] = toggle.classList.contains('session-toggle--active');
            });
            sessionData.visibility.hpStyle = document.getElementById('settingsHpStyle').value;
            
            // Tags
            sessionData.tags = [];
            document.querySelectorAll('.settings-tag--active[data-tag]').forEach(tag => {
                sessionData.tags.push(tag.dataset.tag);
            });
            
            saveSession();
            closeSessionSettingsModal();
            renderSessionPage();
            
            if (window.RIFT?.ui?.Toast) {
                RIFT.ui.Toast.success('Einstellungen gespeichert!');
            }
        }

        // ========================================
        // COVER UPLOAD & CROPPER
        // ========================================
        
        document.getElementById('uploadCoverBtn')?.addEventListener('click', () => {
            document.getElementById('coverFileInput').click();
        });
        
        document.getElementById('coverFileInput')?.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = (event) => {
                const img = document.getElementById('cropperImage');
                img.src = event.target.result;
                
                document.getElementById('cropperModal').classList.add('settings-modal--open');
                
                // Destroy existing cropper
                if (cropper) cropper.destroy();
                
                // Initialize cropper with 2:3 aspect ratio
                setTimeout(() => {
                    cropper = new Cropper(img, {
                        aspectRatio: 2/3,
                        viewMode: 1,
                        dragMode: 'move',
                        autoCropArea: 1,
                        restore: false,
                        guides: true,
                        center: true,
                        highlight: false,
                        cropBoxMovable: true,
                        cropBoxResizable: true,
                        toggleDragModeOnDblclick: false
                    });
                }, 100);
            };
            reader.readAsDataURL(file);
        });
        
        document.getElementById('applyCropBtn')?.addEventListener('click', async () => {
            if (!cropper) return;
            
            const canvas = cropper.getCroppedCanvas({
                width: 600,
                height: 900,
                imageSmoothingEnabled: true,
                imageSmoothingQuality: 'high'
            });
            
            const croppedImage = canvas.toDataURL('image/jpeg', 0.9);
            
            // Save to IndexedDB
            await CoverDB.save(sessionId, croppedImage);
            sessionData.hasCover = true;
            saveSession();
            
            // Update UI
            document.getElementById('settingsCoverPreview').innerHTML = `<img src="${croppedImage}" alt="">`;
            
            // Close cropper modal
            document.getElementById('cropperModal').classList.remove('settings-modal--open');
            cropper.destroy();
            cropper = null;
            
            // Update main cover
            const coverEl = document.getElementById('sessionCover');
            if (coverEl) {
                coverEl.innerHTML = `<img src="${croppedImage}" alt="Session Cover">` + 
                    '<button class="session-hero__cover-edit" onclick="event.stopPropagation(); openSettingsModal();">üì∑ √Ñndern</button>';
            }
            
            if (window.RIFT?.ui?.Toast) {
                RIFT.ui.Toast.success('Cover gespeichert!');
            }
        });
        
        document.getElementById('removeCoverBtn')?.addEventListener('click', async () => {
            if (!confirm('Cover wirklich entfernen?')) return;
            
            await CoverDB.delete(sessionId);
            sessionData.hasCover = false;
            saveSession();
            
            document.getElementById('settingsCoverPreview').innerHTML = '<div class="settings-cover-preview__placeholder">üé≠</div>';
            renderSessionPage();
            
            if (window.RIFT?.ui?.Toast) {
                RIFT.ui.Toast.success('Cover entfernt');
            }
        });

        // ========================================
        // DELETE SESSION
        // ========================================
        
        document.getElementById('deleteSessionBtn')?.addEventListener('click', () => {
            closeSessionSettingsModal();
            document.getElementById('deleteModal').classList.add('delete-modal--open');
        });
        
        document.getElementById('cancelDeleteBtn')?.addEventListener('click', () => {
            document.getElementById('deleteModal').classList.remove('delete-modal--open');
        });
        
        document.getElementById('deleteBackdrop')?.addEventListener('click', () => {
            document.getElementById('deleteModal').classList.remove('delete-modal--open');
        });
        
        document.getElementById('confirmDeleteBtn')?.addEventListener('click', async () => {
            if (!sessionData) return;
            
            // Delete from localStorage
            const sessions = JSON.parse(localStorage.getItem('rift_sessions') || '[]');
            const filtered = sessions.filter(s => s.id !== sessionData.id);
            localStorage.setItem('rift_sessions', JSON.stringify(filtered));
            
            // Delete cover
            await CoverDB.delete(sessionId);
            
            // Remove active session if it's this one
            const activeSession = JSON.parse(localStorage.getItem('rift_active_session') || 'null');
            if (activeSession && activeSession.id === sessionData.id) {
                localStorage.removeItem('rift_active_session');
            }
            
            document.getElementById('deleteModal').classList.remove('delete-modal--open');
            
            if (window.RIFT?.ui?.Toast) {
                RIFT.ui.Toast.success('Session gel√∂scht!');
            }
            
            setTimeout(() => {
                window.location.href = 'sessions.html';
            }, 500);
        });

        // ========================================
        // PARTY MEMBER ACTIONS
        // ========================================
        
        function editPartyMember(charId) {
            // TODO: Implement HP editing modal
            console.log('Edit party member:', charId);
            if (window.RIFT?.ui?.Toast) {
                RIFT.ui.Toast.info('HP-Editor kommt bald!');
            }
        }
        
        function removePartyMember(charId) {
            if (!confirm('Charakter aus der Party entfernen?')) return;
            
            sessionData.partyCharacters = (sessionData.partyCharacters || []).filter(c => c.id !== charId);
            saveSession();
            renderSessionPage();
            
            if (window.RIFT?.ui?.Toast) {
                RIFT.ui.Toast.success('Charakter entfernt');
            }
        }

        // ========================================
        // MODAL EVENT LISTENERS
        // ========================================
        
        // Settings Modal
        document.getElementById('closeSessionSettingsModal')?.addEventListener('click', closeSessionSettingsModal);
        document.getElementById('sessionSettingsBackdrop')?.addEventListener('click', closeSessionSettingsModal);
        document.getElementById('cancelSessionSettingsBtn')?.addEventListener('click', closeSessionSettingsModal);
        document.getElementById('saveSessionSettingsBtn')?.addEventListener('click', saveSettings);
        
        // Cropper Modal
        document.getElementById('closeCropperModal')?.addEventListener('click', () => {
            document.getElementById('cropperModal').classList.remove('settings-modal--open');
            if (cropper) {
                cropper.destroy();
                cropper = null;
            }
        });
        document.getElementById('cropperBackdrop')?.addEventListener('click', () => {
            document.getElementById('cropperModal').classList.remove('settings-modal--open');
            if (cropper) {
                cropper.destroy();
                cropper = null;
            }
        });
        document.getElementById('cancelCropBtn')?.addEventListener('click', () => {
            document.getElementById('cropperModal').classList.remove('settings-modal--open');
            if (cropper) {
                cropper.destroy();
                cropper = null;
            }
        });
        
        // Tabs
        document.querySelectorAll('.settings-modal__tab').forEach(tab => {
            tab.addEventListener('click', () => {
                // Remove active from all tabs
                document.querySelectorAll('.settings-modal__tab').forEach(t => t.classList.remove('settings-modal__tab--active'));
                document.querySelectorAll('.settings-tab').forEach(t => t.classList.remove('settings-tab--active'));
                
                // Activate clicked tab
                tab.classList.add('settings-modal__tab--active');
                document.getElementById(`tab-${tab.dataset.tab}`).classList.add('settings-tab--active');
            });
        });
        
        // Visibility Toggles
        document.querySelectorAll('.session-toggle').forEach(toggle => {
            toggle.addEventListener('click', () => {
                toggle.classList.toggle('session-toggle--active');
            });
        });
        
        // Tags
        document.querySelectorAll('.settings-tag').forEach(tag => {
            tag.addEventListener('click', () => {
                tag.classList.toggle('settings-tag--active');
            });
        });

        // ========================================
        // LOAD SESSION
        // ========================================
        
        async function loadSession() {
            // Finde main__content und erstelle/leere sessionContent
            const mainContent = document.querySelector('.main__content');
            if (!mainContent) {
                console.error('[Session] main__content not found');
                return;
            }
            
            // Erstelle oder finde sessionContent Container
            let content = document.getElementById('sessionContent');
            if (!content) {
                content = document.createElement('div');
                content.id = 'sessionContent';
                mainContent.appendChild(content);
            }
            
            // Zeige Loading State
            content.innerHTML = `
                <div class="session-loading" id="sessionLoading">
                    <div class="session-loading__spinner"></div>
                    <span style="color: var(--text-muted);">Session wird geladen...</span>
                </div>
            `;
            
            if (!sessionId) {
                showSessionNotFound();
                return;
            }
            
            // Check if user is GM
            const userData = JSON.parse(localStorage.getItem('rift_user') || '{}');
            isGM = userData.isGM === true;
            
            // Also check room membership
            if (currentRoomCode && typeof RIFT !== 'undefined' && RIFT.rooms) {
                try {
                    const membership = await RIFT.rooms.getCurrentMembership(currentRoomCode);
                    if (membership) {
                        isGM = membership.isGM === true;
                    }
                } catch (e) {
                    console.warn('[Session] Could not check room membership:', e);
                }
            }
            
            // Try Firebase first
            if (currentRoomCode && typeof RIFT !== 'undefined' && RIFT.rooms) {
                try {
                    console.log('[Session] Loading from Firebase:', sessionId);
                    sessionData = await RIFT.rooms.getSession(currentRoomCode, sessionId);
                    
                    if (sessionData) {
                        console.log('[Session] Loaded from Firebase:', sessionData.name);
                        renderSessionPage();
                        subscribeToSession();
                        return;
                    }
                } catch (err) {
                    console.warn('[Session] Firebase load failed:', err);
                }
            }
            
            // Fallback to localStorage
            console.log('[Session] Falling back to localStorage');
            const sessions = JSON.parse(localStorage.getItem('rift_sessions') || '[]');
            sessionData = sessions.find(s => s.id === sessionId);
            
            if (!sessionData) {
                showSessionNotFound();
                return;
            }
            
            renderSessionPage();
        }
        
        function subscribeToSession() {
            if (!currentRoomCode || !RIFT?.rooms) return;
            
            const db = RIFT.firebase.getFirestore();
            if (!db) return;
            
            const normalizedCode = currentRoomCode.replace('-', '').toUpperCase();
            
            sessionUnsubscribe = db.collection('rooms').doc(normalizedCode)
                .collection('sessions').doc(sessionId)
                .onSnapshot(doc => {
                    if (doc.exists) {
                        const newData = { id: doc.id, ...doc.data() };
                        console.log('[Session] Realtime update:', newData.status);
                        
                        const statusChanged = sessionData?.status !== newData.status;
                        sessionData = newData;
                        
                        renderSessionPage();
                    }
                }, err => {
                    console.error('[Session] Subscription error:', err);
                });
        }
        
        function showSessionNotFound() {
            const mainContent = document.querySelector('.main__content');
            if (!mainContent) return;
            
            let content = document.getElementById('sessionContent');
            if (!content) {
                content = document.createElement('div');
                content.id = 'sessionContent';
                mainContent.appendChild(content);
            }
            
            content.innerHTML = `
                <div class="session-not-found">
                    <svg class="session-not-found__icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                        <circle cx="12" cy="12" r="10"/>
                        <line x1="12" y1="8" x2="12" y2="12"/>
                        <line x1="12" y1="16" x2="12.01" y2="16"/>
                    </svg>
                    <h2 class="session-not-found__title">Session nicht gefunden</h2>
                    <p class="session-not-found__text">Diese Session existiert nicht oder wurde gel√∂scht.</p>
                    <a href="sessions.html" class="session-not-found__btn">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="18" height="18"><polyline points="15 18 9 12 15 6"/></svg>
                        Zur√ºck zu Sessions
                    </a>
                </div>
            `;
        }
        
        async function saveSession() {
            if (!sessionData) return;
            
            // Try Firebase first
            if (currentRoomCode && RIFT?.rooms?.updateSession) {
                try {
                    await RIFT.rooms.updateSession(currentRoomCode, sessionData.id, sessionData);
                    console.log('[Session] Saved to Firebase');
                    return;
                } catch (err) {
                    console.error('[Session] Firebase save failed:', err);
                }
            }
            
            // Fallback to localStorage
            const sessions = JSON.parse(localStorage.getItem('rift_sessions') || '[]');
            const index = sessions.findIndex(s => s.id === sessionData.id);
            if (index >= 0) {
                sessions[index] = sessionData;
            } else {
                sessions.push(sessionData);
            }
            localStorage.setItem('rift_sessions', JSON.stringify(sessions));
        }
        
        // Cleanup on page unload
        window.addEventListener('beforeunload', () => {
            if (sessionUnsubscribe) sessionUnsubscribe();
            stopTimer();
        });

        // ========================================
        // INIT
        // ========================================
        
        // Initialize Layout and load session
        document.addEventListener('DOMContentLoaded', () => {
            // Init Layout (Sidebar, Topbar, Footer)
            if (typeof initLayout === 'function') {
                initLayout();
            }
            
            // Wait for Firebase to be ready, then load session
            const waitForFirebase = () => {
                if (typeof RIFT !== 'undefined' && RIFT.firebase) {
                    console.log('[Session] Firebase ready, loading session...');
                    loadSession();
                } else {
                    console.log('[Session] Waiting for Firebase...');
                    setTimeout(waitForFirebase, 200);
                }
            };
            
            // Start waiting after a brief delay for layout to settle
            setTimeout(waitForFirebase, 300);
        });
    </script>
    <script src="assets/js/broadcast.js"></script>
</body>
</html>
