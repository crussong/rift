<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <meta name="view-transition" content="same-origin">
    <title>RIFT – Session</title>
    
    <link rel="stylesheet" href="assets/css/core.css">
    <link rel="stylesheet" href="assets/css/ui.css">
    <link rel="stylesheet" href="assets/css/sidebar.css">
    <link rel="stylesheet" href="assets/css/topbar.css">
    <link rel="stylesheet" href="assets/css/footer.css">
    <link rel="stylesheet" href="assets/css/settings.css">
    <link rel="stylesheet" href="assets/css/session.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.6.1/cropper.min.css">
</head>
<body>
    <div class="app">
        <main class="main">
            <div class="main__content">
                
                <!-- Session Header -->
                <div class="session-header" id="sessionHeader">
                    <div class="session-header__cover" id="sessionCover">
                        <!-- Cover-Bild oder Gradient-Fallback -->
                    </div>
                    <div class="session-header__overlay"></div>
                    <div class="session-header__content">
                        <div class="session-header__top">
                            <a href="sessions.html" class="session-header__back">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <polyline points="15 18 9 12 15 6"/>
                                </svg>
                                Zurück
                            </a>
                            <div class="session-header__status session-header__status--planned" id="sessionStatus">
                                <span class="session-header__status-dot"></span>
                                Geplant
                            </div>
                        </div>
                        <div class="session-header__body">
                            <!-- Linke Seite: Session Info -->
                            <div class="session-header__main">
                                <div class="session-header__ruleset" id="sessionRuleset">
                                    <img src="assets/img/rulesets/ruleset_worldsapart.svg" alt="" id="rulesetIcon">
                                    <span id="rulesetName">Worlds Apart</span>
                                </div>
                                <h1 class="session-header__title" id="sessionTitle">Session laden...</h1>
                                <p class="session-header__meta" id="sessionMeta">Session 6 von 12 · Max. 4 Spieler</p>
                            </div>
                            <!-- Rechte Seite: Datum Widget -->
                            <div class="session-header__date-widget">
                                <div class="session-header__date-box" id="dateBox">
                                    <span class="session-header__date-day" id="sessionDay">SO</span>
                                    <span class="session-header__date-num" id="sessionNum">19</span>
                                    <span class="session-header__date-month" id="sessionMonth">Jan</span>
                                </div>
                                <div class="session-header__date-info">
                                    <span class="session-header__date-full" id="sessionDateFull">Sonntag, 19. Januar 2025</span>
                                    <span class="session-header__date-time" id="sessionTimeDisplay">um 20:00 Uhr</span>
                                </div>
                                <!-- Countdown (nur für geplante Sessions) -->
                                <div class="session-header__countdown" id="sessionCountdown">
                                    <div class="session-header__countdown-grid">
                                        <div class="countdown-item">
                                            <span class="countdown-value" id="countdownDays">0</span>
                                            <span class="countdown-label">Tage</span>
                                        </div>
                                        <span class="countdown-sep">:</span>
                                        <div class="countdown-item">
                                            <span class="countdown-value" id="countdownHours">0</span>
                                            <span class="countdown-label">Std</span>
                                        </div>
                                        <span class="countdown-sep">:</span>
                                        <div class="countdown-item">
                                            <span class="countdown-value" id="countdownMins">0</span>
                                            <span class="countdown-label">Min</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <!-- Timer (während Session läuft) - SEPARAT positioniert -->
                            <div class="session-header__live-timer" id="sessionTimer" style="display: none;">
                                <div class="session-header__timer-label">SPIELZEIT</div>
                                <div class="session-header__timer-value" id="timerValue">0:00:00</div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Session Content -->
                <div class="session-content">
                    
                    <!-- Left Column -->
                    <div class="session-main">
                        
                        <!-- My Character Card -->
                        <div class="session-card session-card--character" id="myCharacterCard">
                            <div class="session-card__header">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/>
                                    <circle cx="12" cy="7" r="4"/>
                                </svg>
                                <h2 class="session-card__title">Mein Charakter</h2>
                            </div>
                            <div class="session-card__body">
                                <!-- Character assigned -->
                                <div class="my-character" id="myCharacterAssigned" style="display: none;">
                                    <div class="my-character__portrait" id="myCharPortrait">
                                        <img src="" alt="" id="myCharImage">
                                        <div class="my-character__fallback">
                                            <svg viewBox="0 0 24 24" fill="currentColor">
                                                <path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/>
                                            </svg>
                                        </div>
                                    </div>
                                    <div class="my-character__info">
                                        <h3 class="my-character__name" id="myCharName">Charaktername</h3>
                                        <p class="my-character__class" id="myCharClass">Klasse / Beruf</p>
                                        <div class="my-character__stats">
                                            <span class="my-character__stat">
                                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"/></svg>
                                                <span id="myCharHP">--</span>
                                            </span>
                                            <span class="my-character__stat">
                                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"/></svg>
                                                <span id="myCharLevel">Lvl --</span>
                                            </span>
                                        </div>
                                    </div>
                                    <a href="#" class="my-character__link" id="myCharLink" title="Charakterbogen öffnen">
                                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                            <polyline points="9 18 15 12 9 6"/>
                                        </svg>
                                    </a>
                                </div>
                                
                                <!-- Actions when character is loaded -->
                                <div class="my-character-actions" id="myCharacterActions" style="display: none;">
                                    <button class="my-character-action" id="changeCharacterBtn">
                                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                            <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/>
                                            <circle cx="9" cy="7" r="4"/>
                                            <path d="M23 21v-2a4 4 0 0 0-3-3.87"/>
                                            <path d="M16 3.13a4 4 0 0 1 0 7.75"/>
                                        </svg>
                                        Wechseln
                                    </button>
                                    <a href="#" class="my-character-action" id="newCharacterLink">
                                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                            <line x1="12" y1="5" x2="12" y2="19"/>
                                            <line x1="5" y1="12" x2="19" y2="12"/>
                                        </svg>
                                        Neu
                                    </a>
                                    <button class="my-character-action my-character-action--gm" id="gmViewBtnLoaded" style="display: none;">
                                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                            <polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/>
                                        </svg>
                                        GM
                                    </button>
                                </div>
                                
                                <!-- No character yet - empty state -->
                                <div class="my-character-empty" id="myCharacterEmpty">
                                    <div class="my-character-empty__icon">
                                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                            <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/>
                                            <circle cx="12" cy="7" r="4"/>
                                            <line x1="12" y1="11" x2="12" y2="17"/>
                                            <line x1="9" y1="14" x2="15" y2="14"/>
                                        </svg>
                                    </div>
                                    <h3 class="my-character-empty__title">Kein Charakter ausgewählt</h3>
                                    <p class="my-character-empty__text">Erstelle oder wähle einen Charakter für diese Session</p>
                                    <div class="my-character-empty__actions">
                                        <button class="my-character-empty__btn my-character-empty__btn--primary" id="createCharacterBtn">
                                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
                                            Charakter erstellen
                                        </button>
                                        <button class="my-character-empty__btn my-character-empty__btn--secondary" id="selectCharacterBtn" style="display: none;">
                                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>
                                            Charakter auswählen
                                        </button>
                                        <button class="my-character-empty__btn my-character-empty__btn--gm" id="gmViewBtn" style="display: none;">
                                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                                <polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/>
                                            </svg>
                                            GM Übersicht
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Quick Links -->
                        <div class="session-card session-card--quicklinks" id="quickLinksCard">
                            <div class="session-card__header">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"/>
                                </svg>
                                <h2 class="session-card__title">Schnellzugriff</h2>
                            </div>
                            <div class="session-card__body">
                                <div class="session-quicklinks">
                                    <a href="dice.html" class="session-quicklink">
                                        <div class="session-quicklink__icon session-quicklink__icon--red">
                                            <svg viewBox="0 0 24 24" fill="currentColor">
                                                <path d="M20.47 6.62L12.57 2.18C12.41 2.06 12.21 2 12 2S11.59 2.06 11.43 2.18L3.53 6.62C3.21 6.79 3 7.12 3 7.5V16.5C3 16.88 3.21 17.21 3.53 17.38L11.43 21.82C11.59 21.94 11.79 22 12 22S12.41 21.94 12.57 21.82L20.47 17.38C20.79 17.21 21 16.88 21 16.5V7.5C21 7.12 20.79 6.79 20.47 6.62M11.45 15.96L6.31 15.93V14.91C6.31 14.91 9.74 11.58 9.75 10.57C9.75 9.33 8.73 9.46 8.73 9.46S7.75 9.5 7.64 10.71L6.14 10.76C6.14 10.76 6.18 8.26 8.83 8.26C11.2 8.26 11.23 10.04 11.23 10.5C11.23 12.18 8.15 14.77 8.15 14.77L11.45 14.76V15.96M17.5 13.5C17.5 14.9 16.35 16.05 14.93 16.05C13.5 16.05 12.36 14.9 12.36 13.5V10.84C12.36 9.42 13.5 8.27 14.93 8.27S17.5 9.42 17.5 10.84V13.5M16 10.77V13.53C16 14.12 15.5 14.6 14.92 14.6C14.34 14.6 13.86 14.12 13.86 13.53V10.77C13.86 10.18 14.34 9.71 14.92 9.71C15.5 9.71 16 10.18 16 10.77Z"/>
                                            </svg>
                                        </div>
                                        <span>Würfeltisch</span>
                                    </a>
                                    <a href="whiteboard.html" class="session-quicklink">
                                        <div class="session-quicklink__icon session-quicklink__icon--blue">
                                            <svg viewBox="0 0 24 24" fill="currentColor">
                                                <path fill-rule="evenodd" clip-rule="evenodd" d="M3.46447 3.46447C2 4.92893 2 7.28595 2 12C2 16.714 2 19.0711 3.46447 20.5355C4.92893 22 7.28595 22 12 22C16.714 22 19.0711 22 20.5355 20.5355C22 19.0711 22 16.714 22 12C22 7.28595 22 4.92893 20.5355 3.46447C19.0711 2 16.714 2 12 2C7.28595 2 4.92893 2 3.46447 3.46447ZM17 12.25C17.4142 12.25 17.75 12.5858 17.75 13V18C17.75 18.4142 17.4142 18.75 17 18.75C16.5858 18.75 16.25 18.4142 16.25 18V13C16.25 12.5858 16.5858 12.25 17 12.25ZM12.75 6C12.75 5.58579 12.4142 5.25 12 5.25C11.5858 5.25 11.25 5.58579 11.25 6V18C11.25 18.4142 11.5858 18.75 12 18.75C12.4142 18.75 12.75 18.4142 12.75 18V6ZM7 8.25C7.41421 8.25 7.75 8.58579 7.75 9V18C7.75 18.4142 7.41421 18.75 7 18.75C6.58579 18.75 6.25 18.4142 6.25 18V9C6.25 8.58579 6.58579 8.25 7 8.25Z"/>
                                            </svg>
                                        </div>
                                        <span>Whiteboard</span>
                                    </a>
                                    <a href="chat.html" class="session-quicklink">
                                        <div class="session-quicklink__icon session-quicklink__icon--green">
                                            <svg viewBox="0 0 24 24" fill="currentColor">
                                                <path fill-rule="evenodd" clip-rule="evenodd" d="M12 22C17.5228 22 22 17.5228 22 12C22 6.47715 17.5228 2 12 2C6.47715 2 2 6.47715 2 12C2 13.5997 2.37562 15.1116 3.04346 16.4525C3.22094 16.8088 3.28001 17.2161 3.17712 17.6006L2.58151 19.8267C2.32295 20.793 3.20701 21.677 4.17335 21.4185L6.39939 20.8229C6.78393 20.72 7.19121 20.7791 7.54753 20.9565C8.88837 21.6244 10.4003 22 12 22ZM8 13.25C7.58579 13.25 7.25 13.5858 7.25 14C7.25 14.4142 7.58579 14.75 8 14.75H13.5C13.9142 14.75 14.25 14.4142 14.25 14C14.25 13.5858 13.9142 13.25 13.5 13.25H8ZM7.25 10.5C7.25 10.0858 7.58579 9.75 8 9.75H16C16.4142 9.75 16.75 10.0858 16.75 10.5C16.75 10.9142 16.4142 11.25 16 11.25H8C7.58579 11.25 7.25 10.9142 7.25 10.5Z"/>
                                            </svg>
                                        </div>
                                        <span>Chat</span>
                                    </a>
                                    <a href="notes.html" class="session-quicklink">
                                        <div class="session-quicklink__icon session-quicklink__icon--yellow">
                                            <svg viewBox="0 0 24 24" fill="currentColor">
                                                <path d="M14,10V4.5L19.5,10M5,3C3.89,3 3,3.89 3,5V19A2,2 0 0,0 5,21H19A2,2 0 0,0 21,19V9L15,3H5Z"/>
                                            </svg>
                                        </div>
                                        <span>Notizen</span>
                                    </a>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Info Card -->
                        <div class="session-card">
                            <div class="session-card__header">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <circle cx="12" cy="12" r="10"/>
                                    <polyline points="12 6 12 12 16 14"/>
                                </svg>
                                <h2 class="session-card__title">Termin</h2>
                            </div>
                            <div class="session-card__body">
                                <div class="session-info-grid">
                                    <div class="session-info">
                                        <span class="session-info__label">Datum</span>
                                        <span class="session-info__value" id="infoDate">Samstag, 18. Januar 2026</span>
                                    </div>
                                    <div class="session-info">
                                        <span class="session-info__label">Uhrzeit</span>
                                        <span class="session-info__value" id="infoTime">20:00 Uhr</span>
                                    </div>
                                    <div class="session-info">
                                        <span class="session-info__label">Dauer</span>
                                        <span class="session-info__value" id="infoDuration">~3 Stunden</span>
                                    </div>
                                    <div class="session-info">
                                        <span class="session-info__label">Wiederholt sich</span>
                                        <span class="session-info__value" id="infoRecurring">Wöchentlich</span>
                                    </div>
                                </div>
                                
                                <!-- Voice Chat & Calendar - Inline -->
                                <div class="session-voice" id="voiceLinkSection">
                                    <a href="#" class="session-voice__link" id="voiceLink" target="_blank" style="display: none;">
                                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                            <path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"/>
                                            <path d="M19 10v2a7 7 0 0 1-14 0v-2"/>
                                            <line x1="12" y1="19" x2="12" y2="23"/>
                                            <line x1="8" y1="23" x2="16" y2="23"/>
                                        </svg>
                                        <span id="voiceLinkText">Discord</span>
                                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="session-voice__external">
                                            <path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"/>
                                            <polyline points="15 3 21 3 21 9"/>
                                            <line x1="10" y1="14" x2="21" y2="3"/>
                                        </svg>
                                    </a>
                                    <div class="session-calendar">
                                        <button class="session-calendar__btn" id="exportCalendarBtn">
                                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                                <rect x="3" y="4" width="18" height="18" rx="2" ry="2"/>
                                                <line x1="16" y1="2" x2="16" y2="6"/>
                                                <line x1="8" y1="2" x2="8" y2="6"/>
                                                <line x1="3" y1="10" x2="21" y2="10"/>
                                            </svg>
                                            Kalender
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Description Card -->
                        <div class="session-card" id="descriptionCard">
                            <div class="session-card__header">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
                                    <polyline points="14 2 14 8 20 8"/>
                                    <line x1="16" y1="13" x2="8" y2="13"/>
                                    <line x1="16" y1="17" x2="8" y2="17"/>
                                </svg>
                                <h2 class="session-card__title">Beschreibung</h2>
                            </div>
                            <div class="session-card__body">
                                <div class="session-description" id="sessionDescription">
                                    Keine Beschreibung vorhanden.
                                </div>
                            </div>
                        </div>
                        
                        <!-- Tags Card -->
                        <div class="session-card" id="tagsCard">
                            <div class="session-card__header">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M20.59 13.41l-7.17 7.17a2 2 0 0 1-2.83 0L2 12V2h10l8.59 8.59a2 2 0 0 1 0 2.82z"/>
                                    <line x1="7" y1="7" x2="7.01" y2="7"/>
                                </svg>
                                <h2 class="session-card__title">Tags</h2>
                            </div>
                            <div class="session-card__body">
                                <div class="session-tags" id="sessionTags">
                                    <!-- Dynamisch gefüllt -->
                                </div>
                            </div>
                        </div>
                        
                    </div>
                    
                    <!-- Right Column / Sidebar -->
                    <div class="session-sidebar">
                        
                        <!-- Players Card -->
                        <div class="session-card">
                            <div class="session-card__header">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/>
                                    <circle cx="9" cy="7" r="4"/>
                                    <path d="M23 21v-2a4 4 0 0 0-3-3.87"/>
                                    <path d="M16 3.13a4 4 0 0 1 0 7.75"/>
                                </svg>
                                <h2 class="session-card__title">Spieler</h2>
                                <span class="session-card__badge" id="playerCount">0 / 4</span>
                            </div>
                            <div class="session-card__body">
                                <div class="session-players" id="playerList">
                                    <!-- Dynamisch gefüllt -->
                                </div>
                                <div class="session-players-empty" id="playersEmpty">
                                    <p>Noch keine Spieler beigetreten</p>
                                </div>
                                
                                <div class="session-invite">
                                    <div class="session-invite__link">
                                        <input type="text" class="session-invite__input" id="inviteLink" readonly>
                                        <button class="session-invite__btn" id="copyInviteBtn" title="Link kopieren">
                                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                                <rect x="9" y="9" width="13" height="13" rx="2" ry="2"/>
                                                <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"/>
                                            </svg>
                                        </button>
                                    </div>
                                    <p class="session-invite__hint">Teile diesen Link um Spieler einzuladen</p>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Party Overview Card -->
                        <div class="session-card session-card--party" id="partyCard">
                            <div class="session-card__header">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M12 2L2 7l10 5 10-5-10-5z"/>
                                    <path d="M2 17l10 5 10-5"/>
                                    <path d="M2 12l10 5 10-5"/>
                                </svg>
                                <h2 class="session-card__title">Party</h2>
                            </div>
                            <div class="session-card__body">
                                <div class="party-characters" id="partyCharacters">
                                    <!-- Dynamisch gefüllt -->
                                </div>
                                <div class="party-empty" id="partyEmpty">
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/>
                                        <circle cx="9" cy="7" r="4"/>
                                        <path d="M23 21v-2a4 4 0 0 0-3-3.87"/>
                                        <path d="M16 3.13a4 4 0 0 1 0 7.75"/>
                                    </svg>
                                    <p>Noch keine Charaktere in der Party</p>
                                </div>
                            </div>
                        </div>
                        
                        <!-- GM Actions (nur für GM sichtbar) -->
                        <div class="session-card session-card--gm" id="gmActions">
                            <div class="session-card__header">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/>
                                </svg>
                                <h2 class="session-card__title">GM-Aktionen</h2>
                            </div>
                            <div class="session-card__body">
                                <div class="session-gm-actions">
                                    <!-- Session Controls (mutually exclusive) -->
                                    <button class="gm-btn gm-btn--start" id="startSessionBtn">
                                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                            <polygon points="5 3 19 12 5 21 5 3"/>
                                        </svg>
                                        Session starten
                                    </button>
                                    <button class="gm-btn" id="pauseSessionBtn" style="display: none;">
                                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                            <rect x="6" y="4" width="4" height="16"/>
                                            <rect x="14" y="4" width="4" height="16"/>
                                        </svg>
                                        Session pausieren
                                    </button>
                                    <button class="gm-btn gm-btn--start" id="resumeSessionBtn" style="display: none;">
                                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                            <polygon points="5 3 19 12 5 21 5 3"/>
                                        </svg>
                                        Session fortsetzen
                                    </button>
                                    <button class="gm-btn" id="reopenSessionBtn" style="display: none;">
                                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                            <path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"/>
                                            <path d="M3 3v5h5"/>
                                        </svg>
                                        Session wiederaufnehmen
                                    </button>
                                    <button class="gm-btn gm-btn--danger" id="endSessionBtn" style="display: none;">
                                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                            <rect x="6" y="6" width="12" height="12" rx="2"/>
                                        </svg>
                                        Session beenden
                                    </button>
                                    
                                    <div class="gm-divider"></div>
                                    
                                    <!-- Tools -->
                                    <a href="gm.html" class="gm-btn">
                                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                            <rect x="3" y="3" width="7" height="7"/>
                                            <rect x="14" y="3" width="7" height="7"/>
                                            <rect x="14" y="14" width="7" height="7"/>
                                            <rect x="3" y="14" width="7" height="7"/>
                                        </svg>
                                        GM Dashboard
                                    </a>
                                    <button class="gm-btn" id="editSessionBtn">
                                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                            <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/>
                                            <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/>
                                        </svg>
                                        Bearbeiten
                                    </button>
                                    <button class="gm-btn gm-btn--danger-subtle" id="deleteSessionBtn">
                                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                            <polyline points="3 6 5 6 21 6"/>
                                            <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/>
                                        </svg>
                                        Löschen
                                    </button>
                                </div>
                            </div>
                        </div>
                        
                    </div>
                    
                </div>
                
            </div>
        </main>
    </div>
    
    <!-- Delete Confirmation Modal -->
    <div class="session-modal" id="deleteModal">
        <div class="session-modal__backdrop"></div>
        <div class="session-modal__content">
            <div class="session-modal__header">
                <h2 class="session-modal__title">Session löschen?</h2>
                <button class="session-modal__close" id="closeDeleteModal">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="18" y1="6" x2="6" y2="18"/>
                        <line x1="6" y1="6" x2="18" y2="18"/>
                    </svg>
                </button>
            </div>
            <div class="session-modal__body">
                <p class="session-modal__text">Diese Aktion kann nicht rückgängig gemacht werden. Die Session und alle zugehörigen Daten werden permanent gelöscht.</p>
            </div>
            <div class="session-modal__footer">
                <button class="session-modal__btn session-modal__btn--secondary" id="cancelDeleteBtn">Abbrechen</button>
                <button class="session-modal__btn session-modal__btn--danger" id="confirmDeleteBtn">Endgültig löschen</button>
            </div>
        </div>
    </div>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.6.1/cropper.min.js"></script>
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    
    <!-- RIFT Services -->
    <script src="assets/js/firebase-config.js"></script>
    <script src="assets/js/room-service.js"></script>
    <script src="assets/js/user-service.js"></script>
    
    <script src="assets/js/auth.js"></script>
    <script src="assets/js/ui.js"></script>
    <script src="assets/js/layout.js"></script>
    <script src="assets/js/settings.js"></script>
    <script src="assets/js/admin.js"></script>
    <script src="assets/js/transitions.js"></script>
    <script src="assets/js/app.js"></script>
    <script>
        initLayout();
        
        // ========================================
        // INDEXEDDB FOR COVER IMAGES
        // ========================================
        
        const CoverDB = {
            dbName: 'rift_covers',
            storeName: 'covers',
            
            async open() {
                return new Promise((resolve, reject) => {
                    const request = indexedDB.open(this.dbName, 1);
                    request.onerror = () => reject(request.error);
                    request.onsuccess = () => resolve(request.result);
                    request.onupgradeneeded = (e) => {
                        const db = e.target.result;
                        if (!db.objectStoreNames.contains(this.storeName)) {
                            db.createObjectStore(this.storeName, { keyPath: 'id' });
                        }
                    };
                });
            },
            
            async get(sessionId) {
                const db = await this.open();
                return new Promise((resolve, reject) => {
                    const tx = db.transaction(this.storeName, 'readonly');
                    const store = tx.objectStore(this.storeName);
                    const request = store.get(sessionId);
                    request.onsuccess = () => resolve(request.result?.image || null);
                    request.onerror = () => reject(request.error);
                });
            }
        };
        
        // ========================================
        // SESSION DATA
        // ========================================
        
        let sessionData = null;
        let timerInterval = null;
        let sessionStartTime = null;
        
        // Get session ID from URL
        const urlParams = new URLSearchParams(window.location.search);
        const sessionId = urlParams.get('id');
        
        // Load session data
        function loadSession() {
            if (!sessionId) {
                // No session ID provided
                showSessionNotFound();
                return;
            }
            
            // Load from localStorage (in production: Firebase)
            const sessions = JSON.parse(localStorage.getItem('rift_sessions') || '[]');
            sessionData = sessions.find(s => s.id === sessionId);
            
            if (!sessionData) {
                // Session not found
                showSessionNotFound();
                return;
            }
            
            renderSession();
            
            // Load cover image from IndexedDB
            if (sessionData.hasCover) {
                CoverDB.get(sessionId).then(coverImage => {
                    if (coverImage) {
                        const coverEl = document.getElementById('sessionCover');
                        coverEl.style.backgroundImage = `url(${coverImage})`;
                        coverEl.style.backgroundSize = 'cover';
                        coverEl.style.backgroundPosition = 'center';
                    }
                }).catch(err => {
                    console.warn('Failed to load cover:', err);
                });
            }
        }
        
        function showSessionNotFound() {
            const sessionPage = document.querySelector('.main__content');
            if (!sessionPage) {
                // Redirect to sessions if page element not found
                window.location.href = 'sessions.html';
                return;
            }
            sessionPage.innerHTML = `
                <div style="display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 60vh; text-align: center; padding: 40px;">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" style="width: 64px; height: 64px; color: rgba(255,255,255,0.3); margin-bottom: 20px;">
                        <circle cx="12" cy="12" r="10"/>
                        <line x1="12" y1="8" x2="12" y2="12"/>
                        <line x1="12" y1="16" x2="12.01" y2="16"/>
                    </svg>
                    <h2 style="font-family: 'Dharma Gothic', sans-serif; font-size: 28px; margin: 0 0 12px 0; color: white;">Session nicht gefunden</h2>
                    <p style="color: rgba(255,255,255,0.5); margin: 0 0 24px 0;">Diese Session existiert nicht oder wurde gelöscht.</p>
                    <a href="sessions.html" style="display: inline-flex; align-items: center; gap: 8px; padding: 12px 24px; background: var(--accent); color: white; border-radius: 10px; text-decoration: none; font-weight: 500;">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width: 18px; height: 18px;"><polyline points="15 18 9 12 15 6"/></svg>
                        Zurück zu Sessions
                    </a>
                </div>
            `;
        }
        
        // Render session data to UI
        function renderSession() {
            if (!sessionData) return;
            
            // Title
            document.getElementById('sessionTitle').textContent = sessionData.name;
            document.title = `RIFT – ${sessionData.name}`;
            
            // Ruleset
            const rulesetNames = {
                '5e2024': 'D&D 5e (2024)',
                'worldsapart': 'Worlds Apart',
                'htbah': 'How To Be A Hero',
                'cyberpunk': 'Cyberpunk Red'
            };
            const rulesetIcons = {
                '5e2024': 'ruleset_5e.svg',
                'worldsapart': 'ruleset_worldsapart.svg',
                'htbah': 'ruleset_htbah.svg',
                'cyberpunk': 'ruleset_cyberpunkred.svg'
            };
            document.getElementById('rulesetName').textContent = rulesetNames[sessionData.ruleset] || sessionData.ruleset;
            document.getElementById('rulesetIcon').src = `assets/img/rulesets/${rulesetIcons[sessionData.ruleset] || 'ruleset_worldsapart.svg'}`;
            
            // Meta
            const metaParts = [];
            if (sessionData.sessionCount > 1) {
                metaParts.push(`Session ${sessionData.currentSession || 1} von ${sessionData.sessionCount}`);
            }
            metaParts.push(`Max. ${sessionData.maxPlayers} Spieler`);
            document.getElementById('sessionMeta').textContent = metaParts.join(' · ');
            
            // Status
            const statusEl = document.getElementById('sessionStatus');
            statusEl.className = `session-header__status session-header__status--${sessionData.status || 'planned'}`;
            const statusTexts = { planned: 'Geplant', live: 'Live', paused: 'Pausiert', ended: 'Beendet' };
            statusEl.innerHTML = `<span class="session-header__status-dot"></span>${statusTexts[sessionData.status] || 'Geplant'}`;
            
            // Timer (only if live)
            if (sessionData.status === 'live') {
                document.getElementById('sessionTimer').style.display = 'block';
                startTimer();
            }
            
            // Date & Time
            if (sessionData.date) {
                const dateObj = new Date(sessionData.date);
                const weekdays = ['Sonntag', 'Montag', 'Dienstag', 'Mittwoch', 'Donnerstag', 'Freitag', 'Samstag'];
                const weekdaysShort = ['SO', 'MO', 'DI', 'MI', 'DO', 'FR', 'SA'];
                const months = ['Januar', 'Februar', 'März', 'April', 'Mai', 'Juni', 'Juli', 'August', 'September', 'Oktober', 'November', 'Dezember'];
                const monthsShort = ['Jan', 'Feb', 'Mär', 'Apr', 'Mai', 'Jun', 'Jul', 'Aug', 'Sep', 'Okt', 'Nov', 'Dez'];
                
                // Sidebar Date Info
                document.getElementById('infoDate').textContent = `${weekdays[dateObj.getDay()]}, ${dateObj.getDate()}. ${months[dateObj.getMonth()]} ${dateObj.getFullYear()}`;
                
                // Header Date Widget
                const dayEl = document.getElementById('sessionDay');
                const numEl = document.getElementById('sessionNum');
                const monthEl = document.getElementById('sessionMonth');
                const fullEl = document.getElementById('sessionDateFull');
                const timeDisplayEl = document.getElementById('sessionTimeDisplay');
                
                if (dayEl) dayEl.textContent = weekdaysShort[dateObj.getDay()];
                if (numEl) numEl.textContent = String(dateObj.getDate()).padStart(2, '0');
                if (monthEl) monthEl.textContent = monthsShort[dateObj.getMonth()];
                if (fullEl) fullEl.textContent = `${weekdays[dateObj.getDay()]}, ${dateObj.getDate()}. ${months[dateObj.getMonth()]} ${dateObj.getFullYear()}`;
                if (timeDisplayEl) timeDisplayEl.textContent = `um ${sessionData.time || '20:00'} Uhr`;
            }
            document.getElementById('infoTime').textContent = `${sessionData.time || '20:00'} Uhr`;
            document.getElementById('infoDuration').textContent = `~${sessionData.duration || 3} Stunden`;
            
            const recurringTexts = { 
                once: 'Einmalig', 
                spontan: 'Spontan / Flexibel',
                daily: 'Täglich',
                weekly: 'Wöchentlich', 
                biweekly: 'Alle 2 Wochen', 
                monthly: 'Monatlich',
                yearly: 'Jährlich'
            };
            document.getElementById('infoRecurring').textContent = recurringTexts[sessionData.recurring] || 'Einmalig';
            
            // Description - render with paragraph formatting
            if (sessionData.description) {
                // Convert line breaks to paragraphs
                const formatted = sessionData.description
                    .split(/\n\n+/)  // Split on double line breaks (paragraphs)
                    .filter(p => p.trim())
                    .map(p => `<p>${p.replace(/\n/g, '<br>')}</p>`)  // Single breaks become <br>
                    .join('');
                document.getElementById('sessionDescription').innerHTML = formatted || sessionData.description;
            } else {
                document.getElementById('descriptionCard').style.display = 'none';
            }
            
            // Tags
            if (sessionData.tags && sessionData.tags.length > 0) {
                const tagNames = {
                    roleplay: 'Roleplay-heavy',
                    combat: 'Combat-focused',
                    exploration: 'Exploration',
                    puzzle: 'Rätsel / Puzzle',
                    homebrew: 'Homebrew',
                    official: 'Offizielles Abenteuer',
                    newbie: 'Anfängerfreundlich',
                    experienced: 'Erfahrene Spieler',
                    serious: 'Ernst / Düster',
                    casual: 'Casual / Locker',
                    comedy: 'Comedy / Humor',
                    horror: 'Horror',
                    sandbox: 'Sandbox / Open World',
                    oneshot: 'One-Shot',
                    campaign: 'Kampagne',
                    pvp: 'PvP möglich'
                };
                document.getElementById('sessionTags').innerHTML = sessionData.tags
                    .map(t => `<span class="session-tag">${tagNames[t] || t}</span>`)
                    .join('');
            } else {
                document.getElementById('tagsCard').style.display = 'none';
            }
            
            // Cover
            if (sessionData.cover) {
                document.getElementById('sessionCover').style.backgroundImage = `url(${sessionData.cover})`;
            }
            
            // Invite link
            const inviteLink = `${window.location.origin}/join/${sessionData.id}`;
            document.getElementById('inviteLink').value = inviteLink;
            
            // Players (GM is always shown first)
            const players = sessionData.players || [];
            const maxPlayers = sessionData.maxPlayers || 4;
            
            // Create GM entry - use stored gmName or fallback
            const gmData = sessionData.gm || {
                name: sessionData.gmName || 'Game Master',
                color: sessionData.gmColor || '#FF4655',
                isGM: true,
                online: true
            };
            
            // Count: GM + players
            const totalCount = 1 + players.filter(p => !p.isGM).length;
            document.getElementById('playerCount').textContent = `${totalCount} / ${maxPlayers}`;
            
            const playerListEl = document.getElementById('playerList');
            const playersEmptyEl = document.getElementById('playersEmpty');
            
            // Always show at least the GM
            playersEmptyEl.style.display = 'none';
            
            // Render GM first, then other players
            const allParticipants = [
                { ...gmData, isGM: true },
                ...players.filter(p => !p.isGM)
            ];
            
            playerListEl.innerHTML = allParticipants.map(p => {
                const hasCharacter = p.characterName && p.characterName !== 'Kein Charakter';
                const avatarContent = p.avatar 
                    ? `<img src="${p.avatar}" alt="${p.name}">`
                    : (p.name || 'GM')[0].toUpperCase();
                
                return `
                <div class="session-player ${p.isGM ? 'session-player--gm' : ''}">
                    <div class="session-player__avatar" style="background: ${p.color || (p.isGM ? '#FF4655' : '#3B82F6')};">
                        ${avatarContent}
                    </div>
                    <div class="session-player__info">
                        <span class="session-player__name">
                            ${p.name || 'Game Master'}
                            ${p.isGM ? '<span class="session-player__gm-badge">GM</span>' : ''}
                        </span>
                        <span class="session-player__character ${!hasCharacter ? 'session-player__character--none' : ''}">
                            ${hasCharacter ? p.characterName : 'Noch kein Charakter'}
                        </span>
                    </div>
                    <span class="session-player__status session-player__status--${p.online ? 'online' : 'offline'}"></span>
                </div>
                `;
            }).join('');
            
            // Countdown (if session is planned and in future)
            updateCountdown();
            
            // Voice Link
            if (sessionData.voiceLink) {
                document.getElementById('voiceLink').style.display = 'inline-flex';
                document.getElementById('voiceLink').href = sessionData.voiceLink;
                // Detect platform from URL
                const link = sessionData.voiceLink.toLowerCase();
                let linkText = 'Voice Chat';
                if (link.includes('discord')) linkText = 'Discord';
                else if (link.includes('teamspeak')) linkText = 'TeamSpeak';
                else if (link.includes('zoom')) linkText = 'Zoom';
                else if (link.includes('meet.google')) linkText = 'Google Meet';
                document.getElementById('voiceLinkText').textContent = linkText;
            }
            
            // Party Overview
            renderPartyOverview();
            
            // Update start button based on status
            updateActionButtons();
            
            // My Character
            loadMyCharacter();
        }
        
        // ========================================
        // COUNTDOWN
        // ========================================
        
        let countdownInterval = null;
        
        function updateCountdown() {
            const countdownEl = document.getElementById('sessionCountdown');
            const daysEl = document.getElementById('countdownDays');
            const hoursEl = document.getElementById('countdownHours');
            const minsEl = document.getElementById('countdownMins');
            
            // Only show countdown for planned sessions
            if (sessionData.status !== 'planned' && sessionData.status !== undefined) {
                if (countdownEl) countdownEl.style.display = 'none';
                return;
            }
            
            const sessionDateTime = new Date(`${sessionData.date}T${sessionData.time || '20:00'}`);
            const now = new Date();
            const diff = sessionDateTime - now;
            
            if (diff <= 0) {
                if (countdownEl) countdownEl.style.display = 'none';
                return;
            }
            
            if (countdownEl) countdownEl.style.display = 'block';
            
            const updateDisplay = () => {
                const currentDiff = sessionDateTime - new Date();
                if (currentDiff <= 0) {
                    if (daysEl) daysEl.textContent = '0';
                    if (hoursEl) hoursEl.textContent = '0';
                    if (minsEl) minsEl.textContent = '0';
                    clearInterval(countdownInterval);
                    return;
                }
                
                const days = Math.floor(currentDiff / (1000 * 60 * 60 * 24));
                const hours = Math.floor((currentDiff % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
                const minutes = Math.floor((currentDiff % (1000 * 60 * 60)) / (1000 * 60));
                
                if (daysEl) daysEl.textContent = days;
                if (hoursEl) hoursEl.textContent = hours;
                if (minsEl) minsEl.textContent = minutes;
            };
            
            updateDisplay();
            countdownInterval = setInterval(updateDisplay, 60000); // Update every minute
        }
        
        // ========================================
        // PARTY OVERVIEW
        // ========================================
        
        function renderPartyOverview() {
            const partyEl = document.getElementById('partyCharacters');
            const emptyEl = document.getElementById('partyEmpty');
            
            // Get party characters from session data
            const partyCharacters = sessionData.partyCharacters || [];
            
            if (partyCharacters.length === 0) {
                partyEl.style.display = 'none';
                emptyEl.style.display = 'flex';
                return;
            }
            
            emptyEl.style.display = 'none';
            partyEl.style.display = 'grid';
            
            partyEl.innerHTML = partyCharacters.map(char => `
                <a href="character.html?id=${char.id}" class="party-character ${char.id === sessionData.myCharacterId ? 'party-character--self' : ''}">
                    <div class="party-character__portrait">
                        ${char.portrait ? `<img src="${char.portrait}" alt="">` : `
                        <div class="party-character__portrait-fallback">
                            <svg viewBox="0 0 24 24" fill="currentColor">
                                <path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/>
                            </svg>
                        </div>
                        `}
                    </div>
                    <span class="party-character__name">${char.name || 'Unbenannt'}</span>
                    <span class="party-character__class">${char.class || char.profession || ''}</span>
                </a>
            `).join('');
        }
        
        // ========================================
        // CALENDAR EXPORT
        // ========================================
        
        document.getElementById('exportCalendarBtn')?.addEventListener('click', () => {
            if (!sessionData) return;
            const sessionDateTime = new Date(`${sessionData.date}T${sessionData.time || '20:00'}`);
            const endDateTime = new Date(sessionDateTime.getTime() + (sessionData.duration || 3) * 60 * 60 * 1000);
            
            // Format for ICS (YYYYMMDDTHHMMSS)
            const formatICS = (date) => {
                return date.toISOString().replace(/[-:]/g, '').split('.')[0] + 'Z';
            };
            
            const icsContent = [
                'BEGIN:VCALENDAR',
                'VERSION:2.0',
                'PRODID:-//RIFT//Session//DE',
                'BEGIN:VEVENT',
                `DTSTART:${formatICS(sessionDateTime)}`,
                `DTEND:${formatICS(endDateTime)}`,
                `SUMMARY:${sessionData.name}`,
                `DESCRIPTION:${sessionData.description || 'RIFT Session'}\\n\\nVoice: ${sessionData.voiceLink || 'Nicht festgelegt'}`,
                `LOCATION:${sessionData.voiceLink || 'Online'}`,
                'END:VEVENT',
                'END:VCALENDAR'
            ].join('\r\n');
            
            const blob = new Blob([icsContent], { type: 'text/calendar;charset=utf-8' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `${sessionData.name.replace(/[^a-zA-Z0-9]/g, '_')}.ics`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
            
            if (window.RIFT?.ui?.Toast) {
                RIFT.ui.Toast.success('Kalender-Datei heruntergeladen!');
            }
        });
        
        // ========================================
        // MY CHARACTER LOGIC
        // ========================================
        
        // Get characters for a specific ruleset from central storage
        function getCharactersForRuleset(ruleset) {
            try {
                const stored = localStorage.getItem('rift_characters');
                if (!stored) return [];
                
                const allCharacters = JSON.parse(stored);
                
                // Support both old array format and new object format
                let characterArray;
                if (Array.isArray(allCharacters)) {
                    characterArray = allCharacters;
                } else if (typeof allCharacters === 'object' && allCharacters !== null) {
                    characterArray = Object.values(allCharacters);
                } else {
                    return [];
                }
                
                const compatible = characterArray.filter(c => c.ruleset === ruleset && c.name);
                console.log('[RIFT] Characters for', ruleset, ':', compatible.length);
                return compatible;
            } catch (e) {
                console.warn('[RIFT] Failed to load characters:', e);
                return [];
            }
        }
        
        function loadMyCharacter() {
            const assignedEl = document.getElementById('myCharacterAssigned');
            const emptyEl = document.getElementById('myCharacterEmpty');
            const actionsEl = document.getElementById('myCharacterActions');
            const selectBtn = document.getElementById('selectCharacterBtn');
            const gmViewBtn = document.getElementById('gmViewBtn');
            const gmViewBtnLoaded = document.getElementById('gmViewBtnLoaded');
            
            // Get available characters for this ruleset
            const compatibleCharacters = getCharactersForRuleset(sessionData.ruleset);
            
            // Show select button if there are compatible characters
            selectBtn.style.display = compatibleCharacters.length > 0 ? 'inline-flex' : 'none';
            
            // Show GM View button if user is GM
            const isGM = sessionData.gameMaster === window.currentUser?.id || sessionData.gameMaster === 'GM';
            if (gmViewBtn) {
                gmViewBtn.style.display = isGM ? 'inline-flex' : 'none';
            }
            if (gmViewBtnLoaded) {
                gmViewBtnLoaded.style.display = isGM ? 'inline-flex' : 'none';
            }
            
            // Check if session has a character assigned
            const myCharacterId = sessionData.myCharacterId;
            
            if (myCharacterId) {
                const character = compatibleCharacters.find(c => c.id === myCharacterId);
                if (character) {
                    displayMyCharacter(character);
                    assignedEl.style.display = 'flex';
                    actionsEl.style.display = 'flex';
                    emptyEl.style.display = 'none';
                    
                    // Set new character link
                    const newCharLink = document.getElementById('newCharacterLink');
                    if (newCharLink) {
                        newCharLink.href = getCharacterSheetUrl(sessionData.ruleset);
                    }
                    return;
                }
            }
            
            // No character assigned
            assignedEl.style.display = 'none';
            actionsEl.style.display = 'none';
            emptyEl.style.display = 'flex';
        }
        
        function displayMyCharacter(character) {
            document.getElementById('myCharName').textContent = character.name || 'Unbenannt';
            document.getElementById('myCharClass').textContent = character.class || character.profession || 'Abenteurer';
            document.getElementById('myCharLevel').textContent = character.level ? `Lvl ${character.level}` : 'Lvl 1';
            document.getElementById('myCharHP').textContent = character.hp || character.maxHp || '--';
            
            // Character image
            const imgEl = document.getElementById('myCharImage');
            if (character.portrait || character.image) {
                imgEl.src = character.portrait || character.image;
                imgEl.classList.add('loaded');
            }
            
            // Link to character sheet
            const sheetUrl = getCharacterSheetUrl(sessionData.ruleset, character.id);
            document.getElementById('myCharLink').href = sheetUrl;
        }
        
        // Get character sheet URL for ruleset
        function getCharacterSheetUrl(ruleset, characterId = null) {
            const sheets = {
                '5e2024': 'sheet-5e-de.html',
                'worldsapart': 'sheet-worldsapart.html',
                'htbah': 'sheet-htbah.html',
                'cyberpunk': 'sheet-cyberpunk.html'
            };
            const sheetUrl = sheets[ruleset] || 'sheet-worldsapart.html';
            if (characterId) {
                return `${sheetUrl}?id=${characterId}&session=${sessionData.id}`;
            }
            return `${sheetUrl}?new=true&session=${sessionData.id}`;
        }
        
        // Create character button - go directly to character sheet
        document.getElementById('createCharacterBtn')?.addEventListener('click', () => {
            if (!sessionData) return;
            window.location.href = getCharacterSheetUrl(sessionData.ruleset);
        });
        
        // Select character button - opens modal if characters exist, otherwise go to sheet
        document.getElementById('selectCharacterBtn')?.addEventListener('click', () => {
            if (!sessionData) return;
            const compatibleCharacters = getCharactersForRuleset(sessionData.ruleset);
            
            if (compatibleCharacters.length === 0) {
                // No characters - go directly to sheet
                window.location.href = getCharacterSheetUrl(sessionData.ruleset);
            } else {
                // Has characters - open selection modal
                openCharacterSelectModal(compatibleCharacters);
            }
        });
        
        // Change character button - same as select
        document.getElementById('changeCharacterBtn')?.addEventListener('click', () => {
            if (!sessionData) return;
            const compatibleCharacters = getCharactersForRuleset(sessionData.ruleset);
            openCharacterSelectModal(compatibleCharacters);
        });
        
        // GM View button (empty state)
        document.getElementById('gmViewBtn')?.addEventListener('click', () => {
            openGMViewModal();
        });
        
        // GM View button (loaded state)
        document.getElementById('gmViewBtnLoaded')?.addEventListener('click', () => {
            openGMViewModal();
        });
        
        function openGMViewModal() {
            if (!sessionData) return;
            document.getElementById('gmViewModal')?.remove();
            document.getElementById('gmViewStyles')?.remove();
            
            // Get party characters
            const partyCharacters = sessionData.partyCharacters || [];
            
            // Create styles
            const styles = document.createElement('style');
            styles.id = 'gmViewStyles';
            styles.textContent = `
                #gmViewModal {
                    position: fixed !important;
                    top: 0 !important;
                    left: 0 !important;
                    width: 100vw !important;
                    height: 100vh !important;
                    display: flex !important;
                    align-items: center !important;
                    justify-content: center !important;
                    z-index: 999999 !important;
                }
                #gmViewBackdrop {
                    position: fixed !important;
                    top: 0 !important;
                    left: 0 !important;
                    width: 100vw !important;
                    height: 100vh !important;
                    background: rgba(0,0,0,0.85) !important;
                    backdrop-filter: blur(8px) !important;
                }
                #gmViewDialog {
                    position: relative !important;
                    z-index: 1 !important;
                    width: 700px !important;
                    max-width: calc(100vw - 40px) !important;
                    max-height: 85vh !important;
                    background: #1a1a1e !important;
                    border: 1px solid rgba(234,179,8,0.3) !important;
                    border-radius: 16px !important;
                    overflow: hidden !important;
                    box-shadow: 0 20px 60px rgba(0,0,0,0.5) !important;
                }
                #gmViewDialog .gm-header {
                    display: flex;
                    align-items: center;
                    justify-content: space-between;
                    padding: 16px 20px;
                    background: rgba(234,179,8,0.1);
                    border-bottom: 1px solid rgba(234,179,8,0.2);
                }
                #gmViewDialog .gm-title {
                    display: flex;
                    align-items: center;
                    gap: 10px;
                    font-family: 'Dharma Gothic', sans-serif;
                    font-size: 22px;
                    font-weight: 700;
                    color: #EAB308;
                }
                #gmViewDialog .gm-title svg { width: 22px; height: 22px; }
                #gmViewDialog .gm-close {
                    width: 32px; height: 32px;
                    display: flex; align-items: center; justify-content: center;
                    background: rgba(255,255,255,0.05);
                    border: 1px solid rgba(255,255,255,0.1);
                    border-radius: 8px;
                    color: rgba(255,255,255,0.5);
                    font-size: 18px;
                    cursor: pointer;
                }
                #gmViewDialog .gm-close:hover {
                    background: rgba(255,70,85,0.15);
                    color: #ff4655;
                }
                #gmViewDialog .gm-body {
                    padding: 16px;
                    max-height: calc(85vh - 70px);
                    overflow-y: auto;
                }
                #gmViewDialog .gm-empty {
                    text-align: center;
                    padding: 40px 20px;
                    color: rgba(255,255,255,0.4);
                }
                #gmViewDialog .gm-empty svg {
                    width: 48px;
                    height: 48px;
                    margin-bottom: 12px;
                    opacity: 0.3;
                }
                #gmViewDialog .gm-grid {
                    display: grid;
                    grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
                    gap: 12px;
                }
                #gmViewDialog .player-card {
                    background: rgba(255,255,255,0.03);
                    border: 1px solid rgba(255,255,255,0.08);
                    border-radius: 12px;
                    padding: 16px;
                    display: flex;
                    flex-direction: column;
                    align-items: center;
                    text-align: center;
                    transition: all 0.15s;
                }
                #gmViewDialog .player-card:hover {
                    background: rgba(139,92,246,0.08);
                    border-color: rgba(139,92,246,0.2);
                }
                #gmViewDialog .player-username {
                    font-size: 11px;
                    color: rgba(255,255,255,0.4);
                    text-transform: uppercase;
                    letter-spacing: 0.5px;
                    margin-bottom: 10px;
                }
                #gmViewDialog .player-portrait {
                    width: 72px;
                    height: 72px;
                    border-radius: 12px;
                    background: linear-gradient(135deg, #7c3aed, #4c1d95);
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    overflow: hidden;
                    margin-bottom: 10px;
                    border: 2px solid rgba(139,92,246,0.3);
                }
                #gmViewDialog .player-portrait img {
                    width: 100%;
                    height: 100%;
                    object-fit: cover;
                }
                #gmViewDialog .player-portrait span {
                    font-size: 28px;
                    opacity: 0.5;
                }
                #gmViewDialog .player-name {
                    font-size: 15px;
                    font-weight: 600;
                    color: white;
                    margin-bottom: 2px;
                }
                #gmViewDialog .player-stats {
                    display: flex;
                    gap: 12px;
                    justify-content: center;
                    margin: 8px 0;
                    font-size: 12px;
                }
                #gmViewDialog .player-hp {
                    color: #22c55e;
                    display: flex;
                    align-items: center;
                    gap: 4px;
                }
                #gmViewDialog .player-moral {
                    color: #60a5fa;
                    display: flex;
                    align-items: center;
                    gap: 4px;
                }
                #gmViewDialog .player-link {
                    margin-top: 10px;
                    padding: 8px 14px;
                    background: rgba(139,92,246,0.15);
                    border: 1px solid rgba(139,92,246,0.25);
                    border-radius: 8px;
                    color: #A78BFA;
                    font-size: 12px;
                    text-decoration: none;
                    display: flex;
                    align-items: center;
                    gap: 6px;
                    transition: all 0.15s;
                }
                #gmViewDialog .player-link:hover {
                    background: rgba(139,92,246,0.25);
                    border-color: rgba(139,92,246,0.4);
                }
                #gmViewDialog .player-link svg {
                    width: 14px;
                    height: 14px;
                }
            `;
            document.head.appendChild(styles);
            
            // Create modal
            const modal = document.createElement('div');
            modal.id = 'gmViewModal';
            
            const playersHTML = partyCharacters.length > 0 ? `
                <div class="gm-grid">
                    ${partyCharacters.map(char => `
                        <div class="player-card">
                            <div class="player-username">${char.playerName || 'Spieler'}</div>
                            <div class="player-portrait">
                                ${char.portrait ? `<img src="${char.portrait}" alt="">` : `<span>👤</span>`}
                            </div>
                            <div class="player-name">${char.name || 'Unbenannt'}</div>
                            <div class="player-stats">
                                <span class="player-hp">❤ ${char.hp || '--'}/${char.maxHp || '--'}</span>
                                ${char.moral !== undefined ? `<span class="player-moral">✦ ${char.moral || '--'}</span>` : ''}
                            </div>
                            <a href="${getCharacterSheetUrl(sessionData.ruleset, char.id)}" class="player-link">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
                                    <polyline points="14 2 14 8 20 8"/>
                                </svg>
                                Zum Bogen
                            </a>
                        </div>
                    `).join('')}
                </div>
            ` : `
                <div class="gm-empty">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/>
                        <circle cx="9" cy="7" r="4"/>
                        <path d="M23 21v-2a4 4 0 0 0-3-3.87"/>
                        <path d="M16 3.13a4 4 0 0 1 0 7.75"/>
                    </svg>
                    <p>Noch keine Spieler in der Party</p>
                </div>
            `;
            
            modal.innerHTML = `
                <div id="gmViewBackdrop"></div>
                <div id="gmViewDialog">
                    <div class="gm-header">
                        <div class="gm-title">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/>
                            </svg>
                            GM Übersicht
                        </div>
                        <button class="gm-close" id="gmViewClose">✕</button>
                    </div>
                    <div class="gm-body">
                        ${playersHTML}
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            // Close handler
            const closeModal = () => {
                modal.remove();
                styles.remove();
            };
            
            document.getElementById('gmViewClose').onclick = closeModal;
            document.getElementById('gmViewBackdrop').onclick = closeModal;
        }
        
        function openCharacterSelectModal(compatibleCharacters) {
            // Remove any existing modal
            document.getElementById('characterSelectModal')?.remove();
            document.getElementById('charSelectStyles')?.remove();
            
            // Create styles
            const styles = document.createElement('style');
            styles.id = 'charSelectStyles';
            styles.textContent = `
                #characterSelectModal {
                    position: fixed !important;
                    top: 0 !important;
                    left: 0 !important;
                    width: 100vw !important;
                    height: 100vh !important;
                    display: flex !important;
                    align-items: center !important;
                    justify-content: center !important;
                    z-index: 999999 !important;
                }
                #charSelectBackdrop {
                    position: fixed !important;
                    top: 0 !important;
                    left: 0 !important;
                    width: 100vw !important;
                    height: 100vh !important;
                    background: rgba(0,0,0,0.85) !important;
                    backdrop-filter: blur(8px) !important;
                }
                #charSelectDialog {
                    position: relative !important;
                    z-index: 1 !important;
                    width: 380px !important;
                    max-width: calc(100vw - 40px) !important;
                    background: #1a1a1e !important;
                    border: 1px solid rgba(139,92,246,0.3) !important;
                    border-radius: 16px !important;
                    overflow: hidden !important;
                    box-shadow: 0 20px 60px rgba(0,0,0,0.5) !important;
                }
                #charSelectDialog .header {
                    display: flex;
                    align-items: center;
                    justify-content: space-between;
                    padding: 16px 20px;
                    background: rgba(139,92,246,0.1);
                    border-bottom: 1px solid rgba(139,92,246,0.2);
                }
                #charSelectDialog .title {
                    display: flex;
                    align-items: center;
                    gap: 10px;
                    font-family: 'Dharma Gothic', sans-serif;
                    font-size: 20px;
                    font-weight: 700;
                    color: white;
                }
                #charSelectDialog .title svg { width: 20px; height: 20px; color: #a78bfa; }
                #charSelectDialog .close-btn {
                    width: 32px; height: 32px;
                    display: flex; align-items: center; justify-content: center;
                    background: rgba(255,255,255,0.05);
                    border: 1px solid rgba(255,255,255,0.1);
                    border-radius: 8px;
                    color: rgba(255,255,255,0.5);
                    font-size: 18px;
                    cursor: pointer;
                }
                #charSelectDialog .close-btn:hover {
                    background: rgba(255,70,85,0.15);
                    color: #ff4655;
                }
                #charSelectDialog .body {
                    padding: 12px;
                    max-height: 300px;
                    overflow-y: auto;
                }
                #charSelectDialog .char-item {
                    display: flex;
                    align-items: center;
                    gap: 12px;
                    padding: 12px;
                    background: rgba(255,255,255,0.03);
                    border: 1px solid rgba(255,255,255,0.06);
                    border-radius: 12px;
                    cursor: pointer;
                    margin-bottom: 8px;
                    width: 100%;
                    text-align: left;
                }
                #charSelectDialog .char-item:hover {
                    background: rgba(139,92,246,0.1);
                    border-color: rgba(139,92,246,0.3);
                }
                #charSelectDialog .portrait {
                    width: 48px; height: 48px;
                    border-radius: 10px;
                    background: linear-gradient(135deg, #7c3aed, #4c1d95);
                    display: flex; align-items: center; justify-content: center;
                    overflow: hidden;
                    flex-shrink: 0;
                }
                #charSelectDialog .portrait img { width: 100%; height: 100%; object-fit: cover; }
                #charSelectDialog .portrait span { font-size: 20px; opacity: 0.5; }
                #charSelectDialog .info { flex: 1; }
                #charSelectDialog .name { font-size: 15px; font-weight: 600; color: white; }
                #charSelectDialog .class { font-size: 12px; color: rgba(255,255,255,0.5); }
                #charSelectDialog .hp { font-size: 11px; color: #22c55e; }
                #charSelectDialog .arrow { font-size: 24px; color: rgba(139,92,246,0.5); }
                #charSelectDialog .char-item:hover .arrow { color: #a78bfa; }
                #charSelectDialog .footer {
                    padding: 12px;
                    border-top: 1px solid rgba(255,255,255,0.06);
                }
                #charSelectDialog .create-link {
                    display: block;
                    padding: 12px;
                    text-align: center;
                    border: 1px dashed rgba(255,255,255,0.1);
                    border-radius: 10px;
                    color: rgba(255,255,255,0.4);
                    font-size: 13px;
                    text-decoration: none;
                }
                #charSelectDialog .create-link:hover {
                    background: rgba(139,92,246,0.1);
                    border-color: rgba(139,92,246,0.3);
                    border-style: solid;
                    color: #a78bfa;
                }
            `;
            document.head.appendChild(styles);
            
            // Create modal
            const modal = document.createElement('div');
            modal.id = 'characterSelectModal';
            modal.innerHTML = `
                <div id="charSelectBackdrop"></div>
                <div id="charSelectDialog">
                    <div class="header">
                        <div class="title">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/>
                                <circle cx="9" cy="7" r="4"/>
                            </svg>
                            Charakter auswählen
                        </div>
                        <button class="close-btn" id="charSelectClose">✕</button>
                    </div>
                    <div class="body">
                        ${compatibleCharacters.map(c => `
                            <button class="char-item" data-char-id="${c.id}">
                                <div class="portrait">
                                    ${c.portrait ? `<img src="${c.portrait}" alt="">` : `<span>👤</span>`}
                                </div>
                                <div class="info">
                                    <div class="name">${c.name || 'Unbenannt'}</div>
                                    <div class="class">${c.class || c.role || 'Abenteurer'}</div>
                                    ${c.hp ? `<div class="hp">❤ ${c.hp}/${c.maxHp || c.hp}</div>` : ''}
                                </div>
                                <div class="arrow">›</div>
                            </button>
                        `).join('')}
                    </div>
                    <div class="footer">
                        <a href="${getCharacterSheetUrl(sessionData.ruleset)}" class="create-link">+ Neuen Charakter erstellen</a>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            // Close handler
            const closeModal = () => {
                modal.remove();
                styles.remove();
            };
            
            document.getElementById('charSelectClose').onclick = closeModal;
            document.getElementById('charSelectBackdrop').onclick = closeModal;
            
            // Select handler
            modal.querySelectorAll('.char-item').forEach(btn => {
                btn.onclick = () => {
                    assignCharacterToSession(btn.dataset.charId);
                    closeModal();
                };
            });
        }
        
        function assignCharacterToSession(characterId) {
            sessionData.myCharacterId = characterId;
            
            // Also add to party if not already
            const compatibleCharacters = getCharactersForRuleset(sessionData.ruleset);
            const character = compatibleCharacters.find(c => c.id === characterId);
            
            if (character) {
                if (!sessionData.partyCharacters) {
                    sessionData.partyCharacters = [];
                }
                if (!sessionData.partyCharacters.find(c => c.id === characterId)) {
                    sessionData.partyCharacters.push({
                        id: character.id,
                        name: character.name,
                        class: character.class || character.profession,
                        portrait: character.portrait
                    });
                }
            }
            
            saveSession();
            loadMyCharacter();
            renderPartyOverview();
            
            if (window.RIFT?.ui?.Toast) {
                RIFT.ui.Toast.success('Charakter zugewiesen!');
            }
        }
        
        function updateActionButtons() {
            const startBtn = document.getElementById('startSessionBtn');
            const pauseBtn = document.getElementById('pauseSessionBtn');
            const resumeBtn = document.getElementById('resumeSessionBtn');
            const reopenBtn = document.getElementById('reopenSessionBtn');
            const endBtn = document.getElementById('endSessionBtn');
            
            // Hide all first
            if (startBtn) startBtn.style.display = 'none';
            if (pauseBtn) pauseBtn.style.display = 'none';
            if (resumeBtn) resumeBtn.style.display = 'none';
            if (reopenBtn) reopenBtn.style.display = 'none';
            if (endBtn) endBtn.style.display = 'none';
            
            switch (sessionData.status) {
                case 'planned':
                    if (startBtn) startBtn.style.display = 'flex';
                    break;
                case 'live':
                    if (pauseBtn) pauseBtn.style.display = 'flex';
                    if (endBtn) endBtn.style.display = 'flex';
                    break;
                case 'paused':
                    if (resumeBtn) resumeBtn.style.display = 'flex';
                    if (endBtn) endBtn.style.display = 'flex';
                    break;
                case 'ended':
                    if (reopenBtn) reopenBtn.style.display = 'flex';
                    break;
            }
        }
        
        // Timer functions
        function startTimer() {
            sessionStartTime = sessionData.startTime ? new Date(sessionData.startTime) : new Date();
            const totalPausedMs = sessionData.totalPausedMs || 0;
            
            timerInterval = setInterval(() => {
                let elapsed = Date.now() - sessionStartTime.getTime() - totalPausedMs;
                if (elapsed < 0) elapsed = 0;
                
                const hours = Math.floor(elapsed / (1000 * 60 * 60));
                const mins = Math.floor((elapsed % (1000 * 60 * 60)) / (1000 * 60));
                const secs = Math.floor((elapsed % (1000 * 60)) / 1000);
                document.getElementById('timerValue').textContent = 
                    `${hours}:${String(mins).padStart(2, '0')}:${String(secs).padStart(2, '0')}`;
            }, 1000);
        }
        
        function stopTimer() {
            if (timerInterval) {
                clearInterval(timerInterval);
                timerInterval = null;
            }
        }
        
        // ========================================
        // EVENT HANDLERS
        // ========================================
        
        // Copy invite link
        document.getElementById('copyInviteBtn')?.addEventListener('click', () => {
            const input = document.getElementById('inviteLink');
            input.select();
            navigator.clipboard.writeText(input.value).then(() => {
                if (window.RIFT?.ui?.Toast) {
                    RIFT.ui.Toast.success('Einladungslink kopiert!');
                }
            });
        });
        
        // Start session
        document.getElementById('startSessionBtn')?.addEventListener('click', () => {
            if (!sessionData) return;
            sessionData.status = 'live';
            sessionData.startTime = Date.now();
            sessionData.pausedTime = null;
            sessionData.totalPausedMs = 0;
            
            // Save to localStorage and rift_active_session
            saveSession();
            localStorage.setItem('rift_active_session', JSON.stringify({
                id: sessionData.id,
                name: sessionData.name,
                startTime: sessionData.startTime
            }));
            
            renderSession();
            
            if (window.RIFT?.ui?.Toast) {
                RIFT.ui.Toast.success('Session gestartet!');
            }
        });
        
        // Pause session
        document.getElementById('pauseSessionBtn')?.addEventListener('click', () => {
            if (!sessionData) return;
            sessionData.status = 'paused';
            sessionData.pausedTime = Date.now();
            stopTimer();
            
            // Update active session
            const activeSession = JSON.parse(localStorage.getItem('rift_active_session') || 'null');
            if (activeSession && activeSession.id === sessionData.id) {
                activeSession.paused = true;
                localStorage.setItem('rift_active_session', JSON.stringify(activeSession));
            }
            
            saveSession();
            renderSession();
            
            if (window.RIFT?.ui?.Toast) {
                RIFT.ui.Toast.info('Session pausiert');
            }
        });
        
        // Resume session
        document.getElementById('resumeSessionBtn')?.addEventListener('click', () => {
            if (!sessionData) return;
            // Calculate paused duration and add to total
            if (sessionData.pausedTime) {
                const pausedDuration = Date.now() - sessionData.pausedTime;
                sessionData.totalPausedMs = (sessionData.totalPausedMs || 0) + pausedDuration;
            }
            
            sessionData.status = 'live';
            sessionData.pausedTime = null;
            
            // Update active session
            const activeSession = JSON.parse(localStorage.getItem('rift_active_session') || 'null');
            if (activeSession && activeSession.id === sessionData.id) {
                activeSession.paused = false;
                localStorage.setItem('rift_active_session', JSON.stringify(activeSession));
            }
            
            saveSession();
            renderSession();
            
            if (window.RIFT?.ui?.Toast) {
                RIFT.ui.Toast.success('Session fortgesetzt!');
            }
        });
        
        // End session
        document.getElementById('endSessionBtn')?.addEventListener('click', () => {
            if (!sessionData) return;
            if (!confirm('Session wirklich beenden?')) return;
            
            // Calculate total duration
            const endTime = Date.now();
            let totalDuration = endTime - sessionData.startTime;
            if (sessionData.pausedTime) {
                // Currently paused - add current pause time
                totalDuration -= (endTime - sessionData.pausedTime);
            }
            totalDuration -= (sessionData.totalPausedMs || 0);
            
            sessionData.status = 'ended';
            sessionData.endTime = endTime;
            sessionData.duration = Math.round(totalDuration / 1000 / 60); // in minutes
            stopTimer();
            document.getElementById('sessionTimer').style.display = 'none';
            
            // Remove from active session
            localStorage.removeItem('rift_active_session');
            
            saveSession();
            renderSession();
            
            if (window.RIFT?.ui?.Toast) {
                RIFT.ui.Toast.success(`Session beendet! Dauer: ${Math.floor(sessionData.duration / 60)}h ${sessionData.duration % 60}min`);
            }
        });
        
        // Reopen ended session
        document.getElementById('reopenSessionBtn')?.addEventListener('click', () => {
            if (!sessionData) return;
            // Reopen as live session, continuing from where we left off
            sessionData.status = 'live';
            sessionData.endTime = null;
            
            // If there was a previous startTime, keep it. Otherwise start fresh.
            if (!sessionData.startTime) {
                sessionData.startTime = Date.now();
                sessionData.totalPausedMs = 0;
            }
            
            // Set as active session again
            localStorage.setItem('rift_active_session', JSON.stringify({
                id: sessionData.id,
                name: sessionData.name,
                startTime: sessionData.startTime
            }));
            
            saveSession();
            renderSession();
            
            if (window.RIFT?.ui?.Toast) {
                RIFT.ui.Toast.success('Session wiederaufgenommen!');
            }
        });
        
        // Edit session
        document.getElementById('editSessionBtn')?.addEventListener('click', () => {
            if (!sessionData) return;
            // Navigate to sessions page with edit modal open
            window.location.href = `sessions.html?edit=${sessionData.id}`;
        });
        
        // Delete session
        const deleteModal = document.getElementById('deleteModal');
        
        document.getElementById('deleteSessionBtn')?.addEventListener('click', () => {
            deleteModal.classList.add('open');
            document.body.style.overflow = 'hidden';
        });
        
        document.getElementById('closeDeleteModal')?.addEventListener('click', closeDeleteModal);
        document.getElementById('cancelDeleteBtn')?.addEventListener('click', closeDeleteModal);
        deleteModal?.querySelector('.session-modal__backdrop')?.addEventListener('click', closeDeleteModal);
        
        function closeDeleteModal() {
            deleteModal.classList.remove('open');
            document.body.style.overflow = '';
        }
        
        document.getElementById('confirmDeleteBtn')?.addEventListener('click', () => {
            if (!sessionData) return;
            // Delete from localStorage
            const sessions = JSON.parse(localStorage.getItem('rift_sessions') || '[]');
            const filtered = sessions.filter(s => s.id !== sessionData.id);
            localStorage.setItem('rift_sessions', JSON.stringify(filtered));
            
            // Remove active session if it's this one
            const activeSession = JSON.parse(localStorage.getItem('rift_active_session') || 'null');
            if (activeSession && activeSession.id === sessionData.id) {
                localStorage.removeItem('rift_active_session');
            }
            
            closeDeleteModal();
            
            if (window.RIFT?.ui?.Toast) {
                RIFT.ui.Toast.success('Session gelöscht!');
            }
            
            // Navigate back to sessions
            setTimeout(() => {
                window.location.href = 'sessions.html';
            }, 500);
        });
        
        // Save session to localStorage
        function saveSession() {
            if (!sessionData) return;
            const sessions = JSON.parse(localStorage.getItem('rift_sessions') || '[]');
            const index = sessions.findIndex(s => s.id === sessionData.id);
            if (index >= 0) {
                sessions[index] = sessionData;
            } else {
                sessions.push(sessionData);
            }
            localStorage.setItem('rift_sessions', JSON.stringify(sessions));
        }
        
        // Init
        loadSession();
    </script>
</body>
</html>
