<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <meta name="view-transition" content="same-origin">
    <title>RIFT – Session</title>
    
    <link rel="stylesheet" href="assets/css/core.css">
    <link rel="stylesheet" href="assets/css/ui.css">
    <link rel="stylesheet" href="assets/css/sidebar.css">
    <link rel="stylesheet" href="assets/css/topbar.css">
    <link rel="stylesheet" href="assets/css/footer.css">
    <link rel="stylesheet" href="assets/css/settings.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.6.1/cropper.min.css">
    
    <style>
        /* ========================================
           SESSION LOBBY STYLES
           ======================================== */
        
        /* Page Header */
        .session-page-header {
            padding: 16px 24px;
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .session-back-btn {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 8px 16px;
            background: var(--bg-elevated);
            border: 1px solid var(--border);
            border-radius: 8px;
            color: var(--text-muted);
            font-size: 14px;
            text-decoration: none;
            transition: all 0.2s;
        }
        
        .session-back-btn:hover {
            background: var(--bg-card);
            color: var(--text);
            border-color: var(--border-hover);
        }
        
        .session-back-btn svg {
            width: 18px;
            height: 18px;
        }
        
        /* ========================================
           SESSION HERO (Cover + Info)
           ======================================== */
        .session-hero {
            margin: 0 24px 24px;
            background: var(--bg-elevated);
            border-radius: 16px;
            border: 1px solid var(--border);
            display: flex;
            flex-direction: row;
            /* Exakt gleich wie Cover-Höhe */
            height: 420px;
            overflow: hidden;
        }
        
        @media (max-width: 900px) {
            .session-hero {
                flex-direction: column;
                height: auto;
            }
            .session-hero__cover {
                width: 100%;
                height: 300px;
                border-radius: 16px 16px 0 0;
            }
            .session-hero__cover img {
                border-radius: 16px 16px 0 0;
            }
            .session-hero__info {
                max-height: none;
                overflow-y: visible;
            }
        }
        
        /* Cover - FIXED 280x420 (perfect 2:3), flush with edges */
        .session-hero__cover {
            position: relative;
            background: linear-gradient(135deg, var(--red-dim) 0%, var(--gray-dark) 100%);
            cursor: pointer;
            width: 280px;
            min-width: 280px;
            height: 420px;
            flex-shrink: 0;
            border-radius: 16px 0 0 16px;
        }
        
        .session-hero__cover img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 16px 0 0 16px;
        }
        
        .session-hero__cover-placeholder {
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: var(--text-dim);
            gap: 8px;
        }
        
        .session-hero__cover-placeholder svg {
            width: 48px;
            height: 48px;
            opacity: 0.4;
        }
        
        .session-hero__cover-placeholder span {
            font-size: 13px;
        }
        
        .session-hero__cover-edit {
            position: absolute;
            bottom: 12px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0,0,0,0.85);
            border: 1px solid rgba(255,255,255,0.15);
            border-radius: 6px;
            padding: 8px 14px;
            color: var(--text);
            font-size: 12px;
            font-weight: 500;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 6px;
            opacity: 0;
            transition: all 0.2s;
        }
        
        .session-hero__cover-edit:hover {
            background: rgba(0,0,0,0.95);
            border-color: rgba(255,255,255,0.25);
        }
        
        .session-hero__cover-edit svg {
            width: 14px;
            height: 14px;
            opacity: 0.8;
        }
        
        .session-hero__cover:hover .session-hero__cover-edit,
        .session-hero__cover-edit:focus {
            opacity: 1;
        }
        
        /* Info Section - scrolls if content overflows */
        .session-hero__info {
            padding: 16px 20px;
            display: flex;
            flex-direction: column;
            min-width: 0;
            flex: 1;
            overflow-y: auto;
            overflow-x: hidden;
        }
        
        /* Custom scrollbar for info section */
        .session-hero__info::-webkit-scrollbar {
            width: 6px;
        }
        
        .session-hero__info::-webkit-scrollbar-track {
            background: transparent;
        }
        
        .session-hero__info::-webkit-scrollbar-thumb {
            background: var(--border);
            border-radius: 3px;
        }
        
        .session-hero__info::-webkit-scrollbar-thumb:hover {
            background: var(--text-dim);
        }
        
        .session-hero__top-row {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 12px;
            flex-wrap: wrap;
            gap: 12px;
        }
        
        .session-hero__ruleset {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            background: var(--bg-card);
            padding: 6px 12px;
            border-radius: 6px;
            font-size: 12px;
            font-weight: 600;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .session-hero__ruleset img {
            width: 18px;
            height: 18px;
            border-radius: 4px;
        }
        
        .session-hero__status {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 6px 14px;
            border-radius: 20px;
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .session-hero__status--planned {
            background: rgba(234, 179, 8, 0.15);
            color: #EAB308;
        }
        
        .session-hero__status--live {
            background: rgba(117, 171, 93, 0.15);
            color: var(--green);
        }
        
        .session-hero__status--paused {
            background: rgba(255, 159, 67, 0.15);
            color: #FF9F43;
        }
        
        .session-hero__status--ended {
            background: rgba(255,255,255,0.08);
            color: var(--text-muted);
        }
        
        .session-hero__status-dot {
            width: 6px;
            height: 6px;
            border-radius: 50%;
            background: currentColor;
        }
        
        .session-hero__status--live .session-hero__status-dot {
            animation: pulse-dot 1.5s infinite;
        }
        
        @keyframes pulse-dot {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.4; transform: scale(0.8); }
        }
        
        .session-hero__title {
            font-family: var(--font-display);
            font-size: 38px;
            font-weight: 800;
            margin-bottom: 4px;
            line-height: 1.1;
        }
        
        .session-hero__subtitle {
            font-size: 15px;
            color: var(--text-muted);
            margin-bottom: 20px;
        }
        
        /* Date/Time Row */
        .session-hero__datetime {
            display: flex;
            gap: 12px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        
        .session-date-box {
            background: var(--bg-card);
            border-radius: 10px;
            padding: 10px 16px;
            text-align: center;
            min-width: 70px;
        }
        
        .session-date-box__day {
            font-size: 11px;
            color: var(--text-dim);
            text-transform: uppercase;
        }
        
        .session-date-box__num {
            font-family: var(--font-display);
            font-size: 32px;
            font-weight: 700;
            line-height: 1;
            color: var(--text);
        }
        
        .session-date-box__month {
            font-size: 12px;
            color: var(--text-muted);
        }
        
        .session-time-box {
            background: var(--bg-card);
            border-radius: 10px;
            padding: 12px 16px;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }
        
        .session-time-box__label {
            font-size: 10px;
            color: var(--text-dim);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .session-time-box__value {
            font-size: 18px;
            font-weight: 600;
        }
        
        .session-countdown {
            background: var(--red-dim);
            border-radius: 10px;
            padding: 10px 16px;
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .countdown-item {
            text-align: center;
        }
        
        .countdown-item__value {
            font-family: var(--font-display);
            font-size: 24px;
            font-weight: 700;
            color: var(--accent);
            display: block;
            line-height: 1;
        }
        
        .countdown-item__label {
            font-size: 9px;
            color: var(--text-dim);
            text-transform: uppercase;
        }
        
        .countdown-sep {
            color: var(--text-dim);
            font-size: 18px;
        }
        
        /* Live Timer */
        .session-live-timer {
            background: rgba(117, 171, 93, 0.15);
            border: 1px solid rgba(117, 171, 93, 0.3);
            border-radius: 10px;
            padding: 12px 20px;
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .session-live-timer__label {
            font-size: 10px;
            color: var(--green);
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        .session-live-timer__value {
            font-family: var(--font-display);
            font-size: 28px;
            font-weight: 700;
            color: var(--green);
            font-variant-numeric: tabular-nums;
        }
        
        /* Description */
        .session-hero__description {
            flex: 1;
        }
        
        .session-hero__description-title {
            font-size: 10px;
            color: var(--text-dim);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 8px;
        }
        
        .session-hero__description-text {
            font-size: 14px;
            color: var(--text-muted);
            line-height: 1.6;
        }
        
        .session-hero__description-text p {
            margin-bottom: 12px;
        }
        
        .session-hero__description-text p:last-child {
            margin-bottom: 0;
        }
        
        /* Session Meta (Duration, Recurrence) */
        .session-hero__meta {
            display: flex;
            flex-wrap: wrap;
            gap: 16px;
            margin-top: 12px;
            padding-top: 12px;
            border-top: 1px solid var(--border);
        }
        
        .session-meta-item {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 13px;
            color: var(--text-muted);
        }
        
        .session-meta-item svg {
            width: 16px;
            height: 16px;
            color: var(--text-dim);
        }
        
        /* Session Tags */
        .session-hero__tags {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 12px;
        }
        
        .session-tag {
            display: inline-flex;
            align-items: center;
            gap: 5px;
            padding: 4px 10px;
            background: rgba(255,255,255,0.06);
            border-radius: 12px;
            font-size: 12px;
            color: var(--text-muted);
        }
        
        .session-tag--highlight {
            background: rgba(255, 70, 85, 0.15);
            color: var(--accent);
        }
        
        /* ========================================
           DESCRIPTION SECTION (Collapsible)
           ======================================== */
        .session-description-section {
            margin: 0 24px 24px;
            background: var(--bg-elevated);
            border-radius: 12px;
            border: 1px solid var(--border);
            overflow: hidden;
            transition: all 0.3s ease;
        }
        
        .session-description__header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 16px 20px;
            cursor: pointer;
            transition: background 0.2s;
        }
        
        .session-description__header:hover {
            background: rgba(255, 255, 255, 0.02);
        }
        
        .session-description__header-left {
            display: flex;
            align-items: center;
            gap: 12px;
            font-size: 15px;
            font-weight: 600;
            color: var(--text);
        }
        
        .session-description__toggle {
            background: none;
            border: none;
            width: 32px;
            height: 32px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
            color: var(--text-dim);
        }
        
        .session-description__toggle:hover {
            background: var(--bg-card);
            color: var(--text);
        }
        
        .session-description__toggle svg {
            width: 20px;
            height: 20px;
            transition: transform 0.3s ease;
        }
        
        .session-description-section.expanded .session-description__toggle svg {
            transform: rotate(180deg);
        }
        
        .session-description__content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease, padding 0.3s ease;
        }
        
        .session-description-section.expanded .session-description__content {
            max-height: 500px;
        }
        
        .session-description__text {
            padding: 0 20px 20px;
            font-size: 14px;
            line-height: 1.7;
            color: var(--text-muted);
        }
        
        .session-description__text p {
            margin: 0 0 12px;
        }
        
        .session-description__text p:last-child {
            margin-bottom: 0;
        }
        
        .session-description__text a {
            color: var(--accent);
            text-decoration: none;
        }
        
        .session-description__text a:hover {
            text-decoration: underline;
        }
        
        /* ========================================
           RESOURCES SECTION
           ======================================== */
        .session-resources {
            margin: 0 24px 24px;
        }
        
        .session-resources__grid {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }
        
        .resource-btn {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 10px 16px;
            background: var(--bg-elevated);
            border: 1px solid var(--border);
            border-radius: 10px;
            color: var(--text);
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            text-decoration: none;
        }
        
        .resource-btn:hover {
            border-color: var(--accent);
            background: var(--red-dim);
            color: var(--text);
        }
        
        .resource-btn svg {
            width: 18px;
            height: 18px;
            flex-shrink: 0;
            fill: currentColor;
        }
        
        /* Voice Chat Button - Platform Colors */
        .resource-btn--voice {
            color: white;
            border-color: transparent;
        }
        
        .resource-btn--voice svg {
            fill: white;
        }
        
        .resource-btn--voice[data-platform="discord"] {
            background: #5865F2;
        }
        .resource-btn--voice[data-platform="discord"]:hover {
            background: #4752c4;
        }
        
        .resource-btn--voice[data-platform="zoom"] {
            background: #2D8CFF;
        }
        .resource-btn--voice[data-platform="zoom"]:hover {
            background: #1a7ae8;
        }
        
        .resource-btn--voice[data-platform="ms teams"] {
            background: #6264A7;
        }
        .resource-btn--voice[data-platform="ms teams"]:hover {
            background: #525498;
        }
        
        .resource-btn--voice[data-platform="google meet"] {
            background: #00897B;
        }
        .resource-btn--voice[data-platform="google meet"]:hover {
            background: #00796B;
        }
        
        .resource-btn--voice[data-platform="teamspeak"] {
            background: #2580C3;
        }
        .resource-btn--voice[data-platform="teamspeak"]:hover {
            background: #1e6ba3;
        }
        
        .resource-btn--voice[data-platform="voice chat"] {
            background: var(--accent);
        }
        .resource-btn--voice[data-platform="voice chat"]:hover {
            background: #e0404e;
        }
        
        /* Add Link Button */
        .resource-btn--add {
            border-style: dashed;
            color: var(--text-dim);
        }
        
        .resource-btn--add:hover {
            color: var(--accent);
            border-color: var(--accent);
        }
        
        .resource-btn__delete {
            margin-left: 4px;
            width: 18px;
            height: 18px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: transparent;
            border: none;
            border-radius: 4px;
            color: var(--text-dim);
            font-size: 12px;
            cursor: pointer;
            opacity: 0;
            transition: all 0.2s;
        }
        
        .resource-btn:hover .resource-btn__delete {
            opacity: 1;
        }
        
        .resource-btn__delete:hover {
            background: var(--accent);
            color: white;
        }
        
        /* Icon Select Grid */
        .icon-select-grid {
            display: grid;
            grid-template-columns: repeat(6, 1fr);
            gap: 8px;
            margin-top: 8px;
        }
        
        .icon-select-btn {
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: var(--bg-card);
            border: 2px solid var(--border);
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
            color: var(--text-dim);
        }
        
        .icon-select-btn:hover {
            border-color: var(--text-muted);
            color: var(--text);
        }
        
        .icon-select-btn--active {
            border-color: var(--accent);
            background: var(--red-dim);
            color: var(--accent);
        }
        
        .icon-select-btn svg {
            width: 20px;
            height: 20px;
            fill: currentColor;
        }
        
        /* ========================================
           PARTY SECTION
           ======================================== */
        .session-section {
            margin: 0 24px 24px;
        }
        
        .session-section__header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 16px;
        }
        
        .session-section__title {
            font-family: var(--font-display);
            font-size: 24px;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .session-section__count {
            font-family: var(--font-body);
            font-size: 14px;
            color: var(--text-dim);
            font-weight: 400;
        }
        
        .party-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 12px;
        }
        
        /* Party Member Card */
        .party-card {
            background: var(--bg-elevated);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 16px;
            display: flex;
            gap: 14px;
            align-items: center;
            transition: all 0.2s;
            cursor: pointer;
            position: relative;
        }
        
        .party-card:hover {
            border-color: var(--border-hover);
            background: var(--bg-card);
        }
        
        .party-card--empty {
            border-style: dashed;
            opacity: 0.6;
        }
        
        .party-card--clickable {
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .party-card--clickable:hover {
            opacity: 1;
            border-color: var(--accent);
            border-style: solid;
            background: var(--red-dim);
        }
        
        .party-card--clickable:hover .party-card__portrait {
            color: var(--accent);
            border-color: var(--accent);
        }
        
        .party-card--gm {
            border-color: var(--red-dim);
            background: linear-gradient(135deg, var(--red-dim) 0%, var(--bg-elevated) 100%);
        }
        
        .party-card__gm-badge {
            position: absolute;
            top: -8px;
            right: 12px;
            background: var(--accent);
            color: white;
            font-size: 10px;
            font-weight: 700;
            padding: 3px 8px;
            border-radius: 4px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .party-card__portrait {
            width: 52px;
            height: 52px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            font-weight: 700;
            position: relative;
            flex-shrink: 0;
            background: var(--bg-card);
            border: 2px solid var(--border);
            overflow: hidden;
        }
        
        .party-card__portrait--has-char {
            border-color: var(--char-color, var(--accent));
            color: var(--char-color, var(--accent));
        }
        
        .party-card__portrait img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .party-card__online {
            position: absolute;
            bottom: -3px;
            right: -3px;
            width: 14px;
            height: 14px;
            border-radius: 50%;
            border: 3px solid var(--bg-elevated);
        }
        
        .party-card__online--on { background: var(--green); }
        .party-card__online--off { background: #444; }
        
        .party-card__info {
            flex: 1;
            min-width: 0;
        }
        
        .party-card__name {
            font-weight: 600;
            font-size: 15px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            margin-bottom: 2px;
        }
        
        .party-card__class {
            font-size: 13px;
            color: var(--text-muted);
            margin-bottom: 8px;
        }
        
        .party-card__hp {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .party-card__hp-bar {
            flex: 1;
            height: 4px;
            background: var(--border);
            border-radius: 2px;
            overflow: hidden;
        }
        
        .party-card__hp-fill {
            height: 100%;
            border-radius: 2px;
            transition: width 0.3s;
        }
        
        .party-card__hp-fill--high { background: var(--green); }
        .party-card__hp-fill--mid { background: #EAB308; }
        .party-card__hp-fill--low { background: var(--accent); }
        
        .party-card__hp-text {
            font-size: 11px;
            color: var(--text-dim);
            font-variant-numeric: tabular-nums;
            min-width: 45px;
            text-align: right;
        }
        
        .party-card__player {
            background: var(--bg-card);
            padding: 4px 10px;
            border-radius: 4px;
            font-size: 11px;
            color: var(--text-dim);
            align-self: flex-start;
        }
        
        .party-card__empty-text {
            color: var(--text-dim);
        }
        
        .party-card__empty-text strong {
            display: block;
            font-weight: 500;
            color: var(--text-muted);
        }
        
        .party-card__empty-text span {
            font-size: 12px;
        }
        
        /* GM Actions on Party Card */
        .party-card__actions {
            display: none;
            gap: 4px;
            margin-left: 8px;
        }
        
        .party-card:hover .party-card__actions {
            display: flex;
        }
        
        .party-card__action-btn {
            width: 28px;
            height: 28px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 6px;
            color: var(--text-muted);
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .party-card__action-btn:hover {
            background: var(--red-dim);
            border-color: var(--accent);
            color: var(--accent);
        }
        
        .party-card__action-btn svg {
            width: 14px;
            height: 14px;
        }
        
        /* ========================================
           QUICK ACTIONS
           ======================================== */
        .quick-actions {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        
        .quick-action {
            background: var(--bg-elevated);
            border: 1px solid var(--border);
            border-radius: 10px;
            padding: 14px 20px;
            display: flex;
            align-items: center;
            gap: 12px;
            text-decoration: none;
            color: var(--text);
            transition: all 0.2s;
            font-size: 14px;
            font-weight: 500;
        }
        
        .quick-action:hover {
            border-color: var(--border-hover);
            background: var(--bg-card);
        }
        
        .quick-action--voice {
            background: #5865F2;
            border-color: #5865F2;
            color: white;
        }
        
        .quick-action--voice:hover {
            background: #4752c4;
            border-color: #4752c4;
        }
        
        .quick-action--voice svg {
            width: 22px;
            height: 22px;
            fill: white;
        }
        
        .quick-action--voice .quick-action__text {
            color: white;
        }
        
        .quick-action--voice .quick-action__text strong {
            display: block;
            font-size: 14px;
            font-weight: 600;
        }
        
        .quick-action--voice .quick-action__text span {
            color: rgba(255,255,255,0.7);
        }
        
        .quick-action__icon {
            width: 20px;
            height: 20px;
            flex-shrink: 0;
        }
        
        .quick-action__text span {
            display: block;
            font-size: 11px;
            color: var(--text-dim);
            font-weight: 400;
        }
        
        /* Invite Box */
        .invite-box {
            background: var(--bg-elevated);
            border: 1px solid var(--border);
            border-radius: 10px;
            padding: 8px 10px 8px 16px;
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .invite-box__label {
            display: flex;
            align-items: center;
            gap: 8px;
            color: var(--text-muted);
            font-size: 13px;
            white-space: nowrap;
        }
        
        .invite-box__label svg {
            width: 18px;
            height: 18px;
            color: var(--text-dim);
        }
        
        .invite-box__btn {
            background: var(--accent);
            border: none;
            border-radius: 6px;
            padding: 10px 16px;
            color: white;
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            white-space: nowrap;
        }
        
        .invite-box__btn:hover {
            filter: brightness(1.1);
        }
        
        /* ========================================
           GM FLOATING BAR
           ======================================== */
        .gm-bar {
            position: fixed;
            bottom: 24px;
            left: 50%;
            transform: translateX(-50%);
            background: var(--bg-elevated);
            border: 1px solid var(--border);
            border-radius: 14px;
            padding: 10px 14px;
            display: none;
            gap: 10px;
            box-shadow: var(--shadow-lg);
            z-index: 100;
        }
        
        .gm-bar--visible {
            display: flex;
        }
        
        .gm-bar__btn {
            border: none;
            border-radius: 10px;
            padding: 12px 16px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.2s;
        }
        
        .gm-bar__btn--start {
            background: var(--green);
            color: white;
            padding: 12px 24px;
        }
        
        .gm-bar__btn--start:hover {
            filter: brightness(1.1);
        }
        
        .gm-bar__btn--pause {
            background: #FF9F43;
            color: white;
        }
        
        .gm-bar__btn--resume {
            background: var(--green);
            color: white;
        }
        
        .gm-bar__btn--end {
            background: var(--accent);
            color: white;
        }
        
        .gm-bar__btn--secondary {
            background: var(--bg-card);
            color: var(--text-muted);
            border: 1px solid var(--border);
        }
        
        .gm-bar__btn--secondary:hover {
            background: rgba(255,255,255,0.1);
            color: var(--text);
        }
        
        .gm-bar__btn svg {
            width: 18px;
            height: 18px;
        }
        
        /* ========================================
           GM SETTINGS MODAL
           ======================================== */
        .settings-modal {
            position: fixed;
            inset: 0;
            z-index: 1000;
            display: none;
            align-items: center;
            justify-content: center;
        }
        
        .settings-modal--open {
            display: flex;
        }
        
        .settings-modal__backdrop {
            position: absolute;
            inset: 0;
            background: rgba(0, 0, 0, 0.85);
            backdrop-filter: blur(8px);
        }
        
        .settings-modal__dialog {
            position: relative;
            width: 600px;
            max-width: calc(100vw - 40px);
            max-height: calc(100vh - 80px);
            background: var(--bg-elevated);
            border: 1px solid var(--border);
            border-radius: 16px;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            box-shadow: var(--shadow-lg);
        }
        
        .settings-modal__header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 20px 24px;
            border-bottom: 1px solid var(--border);
            background: var(--red-dim);
        }
        
        .settings-modal__title {
            font-family: var(--font-display);
            font-size: 24px;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .settings-modal__title svg {
            width: 24px;
            height: 24px;
            color: var(--accent);
        }
        
        .settings-modal__close {
            width: 36px;
            height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(255,255,255,0.05);
            border: 1px solid var(--border);
            border-radius: 8px;
            color: var(--text-muted);
            cursor: pointer;
            font-size: 20px;
            transition: all 0.2s;
        }
        
        .settings-modal__close:hover {
            background: var(--red-dim);
            border-color: var(--accent);
            color: var(--accent);
        }
        
        /* Tabs */
        .settings-modal__tabs {
            display: flex;
            border-bottom: 1px solid var(--border);
            padding: 0 24px;
            background: var(--bg-card);
        }
        
        .settings-modal__tab {
            padding: 14px 20px;
            background: none;
            border: none;
            color: var(--text-muted);
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            position: relative;
            transition: color 0.2s;
        }
        
        .settings-modal__tab:hover {
            color: var(--text);
        }
        
        .settings-modal__tab--active {
            color: var(--accent);
        }
        
        .settings-modal__tab--active::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 2px;
            background: var(--accent);
        }
        
        /* Tab Content */
        .settings-modal__body {
            flex: 1;
            overflow-y: auto;
            padding: 24px;
        }
        
        .settings-tab {
            display: none;
        }
        
        .settings-tab--active {
            display: block;
        }
        
        /* Form Elements */
        .settings-group {
            margin-bottom: 24px;
        }
        
        .settings-group:last-child {
            margin-bottom: 0;
        }
        
        .settings-group__label {
            font-size: 11px;
            font-weight: 600;
            color: var(--text-dim);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 10px;
            display: block;
        }
        
        .settings-input {
            width: 100%;
            padding: 12px 14px;
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 8px;
            color: var(--text);
            font-size: 14px;
            transition: border-color 0.2s;
        }
        
        .settings-input:focus {
            outline: none;
            border-color: var(--accent);
        }
        
        .settings-input::placeholder {
            color: var(--text-dim);
        }
        
        .settings-textarea {
            min-height: 100px;
            resize: vertical;
        }
        
        .settings-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px;
        }
        
        @media (max-width: 500px) {
            .settings-row {
                grid-template-columns: 1fr;
            }
        }
        
        /* Toggle Switch - Settings Modal */
        .settings-modal .session-toggle {
            display: flex !important;
            flex-direction: row !important;
            align-items: flex-start !important;
            justify-content: space-between !important;
            gap: 20px !important;
            padding: 14px 16px;
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 8px;
            margin-bottom: 10px;
            cursor: pointer;
            transition: all 0.2s;
            position: relative;
        }
        
        .settings-modal .session-toggle:hover {
            border-color: var(--border-hover);
        }
        
        .settings-modal .session-toggle__text {
            flex: 1 1 auto !important;
            min-width: 0;
            padding-right: 10px;
            order: 1;
        }
        
        .settings-modal .session-toggle__text::before {
            content: none !important;
        }
        
        .settings-modal .session-toggle__text > :first-child {
            display: block;
            font-size: 14px;
            font-weight: 500;
            color: var(--text);
        }
        
        .settings-modal .session-toggle__text span {
            display: block;
            font-size: 12px;
            color: var(--text-dim);
            line-height: 1.4;
            margin-top: 4px;
        }
        
        .settings-modal .session-toggle__switch {
            width: 44px !important;
            min-width: 44px !important;
            max-width: 44px !important;
            height: 24px !important;
            background: rgba(255,255,255,0.15);
            border-radius: 12px;
            position: relative !important;
            transition: background 0.2s;
            flex-shrink: 0 !important;
            flex-grow: 0 !important;
            order: 2;
            margin-left: auto;
        }
        
        .settings-modal .session-toggle__switch::after {
            content: '';
            position: absolute;
            top: 3px;
            left: 3px;
            width: 18px;
            height: 18px;
            background: white;
            border-radius: 50%;
            transition: transform 0.2s;
        }
        
        .settings-modal .session-toggle--active .session-toggle__switch {
            background: var(--accent);
        }
        
        .settings-modal .session-toggle--active .session-toggle__switch::after {
            transform: translateX(20px);
        }
        
        /* Select Dropdown */
        .settings-select {
            width: 100%;
            padding: 12px 14px;
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 8px;
            color: var(--text);
            font-size: 14px;
            cursor: pointer;
            appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 24 24' fill='none' stroke='%23888' stroke-width='2'%3E%3Cpolyline points='6 9 12 15 18 9'%3E%3C/polyline%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 14px center;
            padding-right: 40px;
        }
        
        .settings-select:focus {
            outline: none;
            border-color: var(--accent);
        }
        
        /* Cover Preview */
        .settings-cover-preview {
            display: flex;
            gap: 16px;
            align-items: flex-start;
        }
        
        .settings-cover-preview__image {
            width: 100px;
            aspect-ratio: 2/3;
            background: var(--bg-card);
            border-radius: 8px;
            overflow: hidden;
            border: 1px solid var(--border);
            flex-shrink: 0;
        }
        
        .settings-cover-preview__image img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .settings-cover-preview__placeholder {
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--text-dim);
            font-size: 24px;
        }
        
        .settings-cover-preview__actions {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        
        .settings-cover-btn {
            padding: 10px 16px;
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 6px;
            color: var(--text);
            font-size: 13px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.2s;
        }
        
        .settings-cover-btn:hover {
            border-color: var(--accent);
            color: var(--accent);
        }
        
        .settings-cover-btn--danger:hover {
            border-color: var(--accent);
            background: var(--red-dim);
        }
        
        /* Tags Input */
        .settings-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }
        
        .settings-tag {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 6px 12px;
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 6px;
            font-size: 13px;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .settings-tag:hover,
        .settings-tag--active {
            border-color: var(--accent);
            color: var(--accent);
        }
        
        .settings-tag--active {
            background: var(--red-dim);
        }
        
        .settings-tag__remove {
            background: none;
            border: none;
            color: currentColor;
            cursor: pointer;
            padding: 0 0 0 4px;
            font-size: 16px;
            line-height: 1;
            opacity: 0.6;
        }
        
        .settings-tag__remove:hover {
            opacity: 1;
        }
        
        /* Character Select Items */
        .char-select-item {
            display: flex;
            align-items: center;
            gap: 14px;
            padding: 14px 16px;
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .char-select-item:hover {
            border-color: var(--accent);
            background: var(--red-dim);
        }
        
        .char-select-item__avatar {
            width: 48px;
            height: 48px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            font-weight: 700;
            border: 2px solid;
            flex-shrink: 0;
            overflow: hidden;
        }
        
        .char-select-item__avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .char-select-item__info {
            flex: 1;
            min-width: 0;
        }
        
        .char-select-item__info strong {
            display: block;
            font-size: 15px;
            font-weight: 600;
            color: var(--text);
            margin-bottom: 2px;
        }
        
        .char-select-item__info span {
            display: block;
            font-size: 12px;
            color: var(--text-dim);
        }
        
        .char-select-item__arrow {
            width: 20px;
            height: 20px;
            color: var(--text-dim);
            flex-shrink: 0;
            transition: transform 0.2s;
        }
        
        .char-select-item:hover .char-select-item__arrow {
            color: var(--accent);
            transform: translateX(4px);
        }
        
        /* Assigned character state */
        .char-select-item--assigned {
            background: var(--accent-dim);
            border-color: var(--accent);
        }
        
        .char-select-item__badge {
            display: inline-block;
            font-size: 11px;
            color: var(--accent);
            font-weight: 600;
            margin-top: 4px;
        }
        
        /* Main character state */
        .char-select-item--main {
            background: rgba(255, 193, 7, 0.08);
            border-color: rgba(255, 193, 7, 0.4);
        }
        
        .char-select-item--main:hover {
            border-color: #FFC107;
        }
        
        .char-select-item__badge--main {
            color: #FFC107;
        }
        
        /* Footer */
        .settings-modal__footer {
            display: flex;
            justify-content: flex-end;
            gap: 12px;
            padding: 16px 24px;
            border-top: 1px solid var(--border);
            background: var(--bg-card);
        }
        
        .settings-modal__btn {
            padding: 12px 24px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .settings-modal__btn--cancel {
            background: transparent;
            border: 1px solid var(--border);
            color: var(--text-muted);
        }
        
        .settings-modal__btn--cancel:hover {
            background: var(--bg-elevated);
            color: var(--text);
        }
        
        .settings-modal__btn--save {
            background: var(--accent);
            border: none;
            color: white;
        }
        
        .settings-modal__btn--save:hover {
            filter: brightness(1.1);
        }
        
        /* ========================================
           DELETE MODAL
           ======================================== */
        .delete-modal {
            position: fixed;
            inset: 0;
            z-index: 1001;
            display: none;
            align-items: center;
            justify-content: center;
        }
        
        .delete-modal--open {
            display: flex;
        }
        
        .delete-modal__backdrop {
            position: absolute;
            inset: 0;
            background: rgba(0, 0, 0, 0.85);
        }
        
        .delete-modal__dialog {
            position: relative;
            width: 400px;
            max-width: calc(100vw - 40px);
            background: var(--bg-elevated);
            border: 1px solid var(--accent);
            border-radius: 16px;
            padding: 24px;
            text-align: center;
        }
        
        .delete-modal__icon {
            width: 64px;
            height: 64px;
            margin: 0 auto 16px;
            background: var(--red-dim);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--accent);
        }
        
        .delete-modal__icon svg {
            width: 32px;
            height: 32px;
        }
        
        .delete-modal__title {
            font-family: var(--font-display);
            font-size: 24px;
            font-weight: 700;
            margin-bottom: 8px;
        }
        
        .delete-modal__text {
            color: var(--text-muted);
            margin-bottom: 24px;
        }
        
        .delete-modal__actions {
            display: flex;
            gap: 12px;
            justify-content: center;
        }
        
        .delete-modal__btn {
            padding: 12px 24px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
        }
        
        .delete-modal__btn--cancel {
            background: var(--bg-card);
            border: 1px solid var(--border);
            color: var(--text);
        }
        
        .delete-modal__btn--confirm {
            background: var(--accent);
            border: none;
            color: white;
        }
        
        /* ========================================
           SESSION NOT FOUND
           ======================================== */
        .session-not-found {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 60vh;
            text-align: center;
            padding: 40px;
        }
        
        .session-not-found__icon {
            width: 80px;
            height: 80px;
            margin-bottom: 24px;
            color: var(--text-dim);
            opacity: 0.5;
        }
        
        .session-not-found__title {
            font-family: var(--font-display);
            font-size: 32px;
            font-weight: 700;
            margin-bottom: 8px;
        }
        
        .session-not-found__text {
            color: var(--text-muted);
            margin-bottom: 24px;
        }
        
        .session-not-found__btn {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 12px 24px;
            background: var(--accent);
            color: white;
            border-radius: 10px;
            text-decoration: none;
            font-weight: 500;
        }
        
        /* ========================================
           LOADING STATE
           ======================================== */
        .session-loading {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 60vh;
            gap: 16px;
        }
        
        .session-loading__spinner {
            width: 48px;
            height: 48px;
            border: 3px solid var(--border);
            border-top-color: var(--accent);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        /* ========================================
           RESPONSIVE
           ======================================== */
        @media (max-width: 600px) {
            .session-hero__title {
                font-size: 28px;
            }
            
            .gm-bar {
                left: 16px;
                right: 16px;
                transform: none;
                flex-wrap: wrap;
                justify-content: center;
            }
            
            .settings-modal__dialog {
                max-height: calc(100vh - 40px);
            }
        }
    </style>

    <!-- Auth Guard: Hide until authenticated -->
    <style>
        body:not(.auth-ready) .app { opacity: 0; pointer-events: none; }
        body:not(.auth-ready) .sheet-container { opacity: 0; pointer-events: none; }
        body:not(.auth-ready) main { opacity: 0; pointer-events: none; }
        body.auth-ready .app { opacity: 1; transition: opacity 0.15s ease; }
        body.auth-ready .sheet-container { opacity: 1; transition: opacity 0.15s ease; }
        body.auth-ready main { opacity: 1; transition: opacity 0.15s ease; }
    </style>
</head>
<body>
    <div class="app">
        <!-- Sidebar, Topbar, Footer werden von layout.js generiert -->
        <main class="main">
            <div class="main__content">
                <!-- Content wird dynamisch von JS generiert -->
            </div>
        </main>
    </div>
    
    <!-- GM Settings Modal -->
    <div class="settings-modal" id="sessionSettingsModal">
        <div class="settings-modal__backdrop" id="sessionSettingsBackdrop"></div>
        <div class="settings-modal__dialog">
            <div class="settings-modal__header">
                <h2 class="settings-modal__title">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="12" cy="12" r="3"/>
                        <path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"/>
                    </svg>
                    Session Einstellungen
                </h2>
                <button class="settings-modal__close" id="closeSessionSettingsModal">✕</button>
            </div>
            
            <div class="settings-modal__tabs">
                <button class="settings-modal__tab settings-modal__tab--active" data-tab="general">Allgemein</button>
                <button class="settings-modal__tab" data-tab="visibility">Sichtbarkeit</button>
                <button class="settings-modal__tab" data-tab="party">Party</button>
                <button class="settings-modal__tab" data-tab="advanced">Erweitert</button>
            </div>
            
            <div class="settings-modal__body">
                
                <!-- Tab: General -->
                <div class="settings-tab settings-tab--active" id="tab-general">
                    
                    <div class="settings-group">
                        <label class="settings-group__label">Cover</label>
                        <div class="settings-cover-preview">
                            <div class="settings-cover-preview__image" id="settingsCoverPreview">
                                <div class="settings-cover-preview__placeholder">🎭</div>
                            </div>
                            <div class="settings-cover-preview__actions">
                                <button class="settings-cover-btn" id="uploadCoverBtn">
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="16" height="16">
                                        <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                                        <polyline points="17 8 12 3 7 8"/>
                                        <line x1="12" y1="3" x2="12" y2="15"/>
                                    </svg>
                                    Cover hochladen
                                </button>
                                <button class="settings-cover-btn settings-cover-btn--danger" id="removeCoverBtn">
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="16" height="16">
                                        <polyline points="3 6 5 6 21 6"/>
                                        <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/>
                                    </svg>
                                    Entfernen
                                </button>
                                <input type="file" id="coverFileInput" accept="image/*" style="display: none;">
                            </div>
                        </div>
                    </div>
                    
                    <div class="settings-group">
                        <label class="settings-group__label">Titel</label>
                        <input type="text" class="settings-input" id="settingsTitle" placeholder="Session-Titel">
                    </div>
                    
                    <div class="settings-group">
                        <label class="settings-group__label">Untertitel / Episode</label>
                        <input type="text" class="settings-input" id="settingsSubtitle" placeholder="z.B. Kapitel 3: Der versiegelte Turm">
                    </div>
                    
                    <div class="settings-group">
                        <label class="settings-group__label">Beschreibung</label>
                        <textarea class="settings-input settings-textarea" id="settingsDescription" placeholder="Kurze Beschreibung oder was bisher geschah..."></textarea>
                    </div>
                    
                    <div class="settings-row">
                        <div class="settings-group">
                            <label class="settings-group__label">Voice Chat</label>
                            <select class="settings-select" id="settingsVoiceType">
                                <option value="">Kein Voice Chat</option>
                                <option value="discord">Discord</option>
                                <option value="teamspeak">TeamSpeak</option>
                                <option value="zoom">Zoom</option>
                                <option value="googlemeet">Google Meet</option>
                                <option value="other">Andere</option>
                            </select>
                        </div>
                        <div class="settings-group">
                            <label class="settings-group__label">Voice Link</label>
                            <input type="url" class="settings-input" id="settingsVoiceLink" placeholder="https://...">
                        </div>
                    </div>
                    
                </div>
                
                <!-- Tab: Visibility -->
                <div class="settings-tab" id="tab-visibility">
                    
                    <p style="color: var(--text-muted); margin-bottom: 20px; font-size: 14px;">
                        Bestimme, was deine Spieler sehen können.
                    </p>
                    
                    <div class="session-toggle session-toggle--active" data-setting="showPartyHp">
                        <div class="session-toggle__text">
                            Party HP anzeigen
                            <span>Spieler sehen HP der anderen Charaktere</span>
                        </div>
                        <div class="session-toggle__switch"></div>
                    </div>
                    
                    <div class="session-toggle session-toggle--active" data-setting="showOnlineStatus">
                        <div class="session-toggle__text">
                            Online-Status anzeigen
                            <span>Grüner Punkt zeigt wer online ist</span>
                        </div>
                        <div class="session-toggle__switch"></div>
                    </div>
                    
                    <div class="session-toggle session-toggle--active" data-setting="showLevel">
                        <div class="session-toggle__text">
                            Level anzeigen
                            <span>Level in den Party-Cards sichtbar</span>
                        </div>
                        <div class="session-toggle__switch"></div>
                    </div>
                    
                    <div class="session-toggle session-toggle--active" data-setting="showCountdown">
                        <div class="session-toggle__text">
                            Countdown anzeigen
                            <span>Zeit bis Session-Start sichtbar</span>
                        </div>
                        <div class="session-toggle__switch"></div>
                    </div>
                    
                    <div class="session-toggle session-toggle--active" data-setting="showDescription">
                        <div class="session-toggle__text">
                            Beschreibung anzeigen
                            <span>Beschreibungstext für Spieler sichtbar</span>
                        </div>
                        <div class="session-toggle__switch"></div>
                    </div>
                    
                    <div class="session-toggle" data-setting="hideCharacterNames">
                        <div class="session-toggle__text">
                            Charakternamen verbergen
                            <span>Nur Spielernamen anzeigen (für Blind-Sessions)</span>
                        </div>
                        <div class="session-toggle__switch"></div>
                    </div>
                    
                    <div class="settings-group" style="margin-top: 24px;">
                        <label class="settings-group__label">HP-Anzeige Stil</label>
                        <select class="settings-select" id="settingsHpStyle">
                            <option value="bar-numbers">Balken mit Zahlen</option>
                            <option value="bar-only">Nur Balken</option>
                            <option value="percent">Nur Prozent</option>
                            <option value="hidden">Verbergen</option>
                        </select>
                    </div>
                    
                </div>
                
                <!-- Tab: Party -->
                <div class="settings-tab" id="tab-party">
                    
                    <div class="session-toggle session-toggle--active" data-setting="playersCanSelectCharacter">
                        <div class="session-toggle__text">
                            Spieler wählen selbst
                            <span>Spieler können ihren Charakter selbst auswählen</span>
                        </div>
                        <div class="session-toggle__switch"></div>
                    </div>
                    
                    <div class="session-toggle" data-setting="lockCharacters">
                        <div class="session-toggle__text">
                            Charaktere sperren
                            <span>Kein Wechsel mehr möglich nach Auswahl</span>
                        </div>
                        <div class="session-toggle__switch"></div>
                    </div>
                    
                    <div class="session-toggle" data-setting="gmCanEditHp">
                        <div class="session-toggle__text">
                            GM kann HP bearbeiten
                            <span>Direkt auf der Session-Seite HP anpassen</span>
                        </div>
                        <div class="session-toggle__switch"></div>
                    </div>
                    
                    <div class="settings-group" style="margin-top: 24px;">
                        <label class="settings-group__label">Max. Teilnehmer</label>
                        <select class="settings-select" id="settingsMaxPlayers">
                            <option value="2">2 Teilnehmer</option>
                            <option value="3">3 Teilnehmer</option>
                            <option value="4" selected>4 Teilnehmer</option>
                            <option value="5">5 Teilnehmer</option>
                            <option value="6">6 Teilnehmer</option>
                            <option value="7">7 Teilnehmer</option>
                            <option value="8">8 Teilnehmer</option>
                            <option value="10">10 Teilnehmer</option>
                            <option value="12">12 Teilnehmer</option>
                        </select>
                    </div>
                    
                    <div class="settings-group">
                        <label class="settings-group__label">Party-Mitglieder</label>
                        <p style="color: var(--text-dim); font-size: 13px; margin-bottom: 12px;">
                            Klicke auf einen Spieler in der Session-Ansicht um HP zu bearbeiten oder zu entfernen.
                        </p>
                    </div>
                    
                </div>
                
                <!-- Tab: Advanced -->
                <div class="settings-tab" id="tab-advanced">
                    
                    <div class="settings-row">
                        <div class="settings-group">
                            <label class="settings-group__label">Datum</label>
                            <input type="date" class="settings-input" id="settingsDate">
                        </div>
                        <div class="settings-group">
                            <label class="settings-group__label">Uhrzeit</label>
                            <input type="time" class="settings-input" id="settingsTime" value="20:00">
                        </div>
                    </div>
                    
                    <div class="settings-row">
                        <div class="settings-group">
                            <label class="settings-group__label">Geschätzte Dauer</label>
                            <select class="settings-select" id="settingsDuration">
                                <option value="1">~1 Stunde</option>
                                <option value="2">~2 Stunden</option>
                                <option value="3" selected>~3 Stunden</option>
                                <option value="4">~4 Stunden</option>
                                <option value="5">~5 Stunden</option>
                                <option value="6">~6+ Stunden</option>
                            </select>
                        </div>
                        <div class="settings-group">
                            <label class="settings-group__label">Wiederholung</label>
                            <select class="settings-select" id="settingsRecurring">
                                <option value="once">Einmalig</option>
                                <option value="spontan">Spontan / Flexibel</option>
                                <option value="weekly">Wöchentlich</option>
                                <option value="biweekly">Alle 2 Wochen</option>
                                <option value="monthly">Monatlich</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="settings-row">
                        <div class="settings-group">
                            <label class="settings-group__label">Session-Nummer</label>
                            <input type="number" class="settings-input" id="settingsCurrentSession" min="1" value="1">
                        </div>
                        <div class="settings-group">
                            <label class="settings-group__label">Geplante Sessions</label>
                            <input type="number" class="settings-input" id="settingsSessionCount" min="1" value="1" placeholder="z.B. 12">
                        </div>
                    </div>
                    
                    <div class="settings-group">
                        <label class="settings-group__label">Tags</label>
                        <div class="settings-tags" id="settingsTags">
                            <span class="settings-tag" data-tag="roleplay">🎭 Roleplay</span>
                            <span class="settings-tag" data-tag="combat">⚔️ Combat</span>
                            <span class="settings-tag" data-tag="exploration">🗺️ Exploration</span>
                            <span class="settings-tag" data-tag="puzzle">🧩 Rätsel</span>
                            <span class="settings-tag" data-tag="horror">👻 Horror</span>
                            <span class="settings-tag" data-tag="comedy">😄 Comedy</span>
                            <span class="settings-tag" data-tag="newbie">🌱 Anfänger</span>
                            <span class="settings-tag" data-tag="oneshot">⚡ One-Shot</span>
                            <span class="settings-tag" data-tag="campaign">📚 Kampagne</span>
                            <span class="settings-tag" data-tag="sandbox">🏜️ Sandbox</span>
                            <span class="settings-tag" data-tag="mystery">🔍 Mystery</span>
                            <span class="settings-tag" data-tag="social">💬 Social</span>
                            <span class="settings-tag" data-tag="stealth">🥷 Stealth</span>
                            <span class="settings-tag" data-tag="dungeon">🏰 Dungeon</span>
                            <span class="settings-tag" data-tag="boss">💀 Bosskampf</span>
                            <span class="settings-tag" data-tag="homebrew">🧪 Homebrew</span>
                            <span class="settings-tag" data-tag="pvp">⚔️ PvP</span>
                            <span class="settings-tag" data-tag="mature">🔞 18+</span>
                        </div>
                        
                        <!-- Custom Tags -->
                        <div class="settings-custom-tags" style="margin-top: 12px;">
                            <div style="display: flex; gap: 8px;">
                                <input type="text" class="settings-input" id="customTagInput" placeholder="Eigenen Tag hinzufügen..." style="flex: 1;">
                                <button type="button" class="settings-cover-btn" id="addCustomTagBtn" style="padding: 10px 16px;">
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="16" height="16">
                                        <line x1="12" y1="5" x2="12" y2="19"/>
                                        <line x1="5" y1="12" x2="19" y2="12"/>
                                    </svg>
                                    Hinzufügen
                                </button>
                            </div>
                            <div class="settings-tags" id="customTagsList" style="margin-top: 10px;"></div>
                        </div>
                    </div>
                    
                    <div class="settings-group" style="margin-top: 24px; padding-top: 24px; border-top: 1px solid var(--border);">
                        <label class="settings-group__label" style="color: var(--accent);">Gefahrenzone</label>
                        <button class="settings-cover-btn settings-cover-btn--danger" id="deleteSessionBtn" style="color: var(--accent);">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="16" height="16">
                                <polyline points="3 6 5 6 21 6"/>
                                <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/>
                            </svg>
                            Session löschen
                        </button>
                    </div>
                    
                </div>
                
            </div>
            
            <div class="settings-modal__footer">
                <button class="settings-modal__btn settings-modal__btn--cancel" id="cancelSessionSettingsBtn">Abbrechen</button>
                <button class="settings-modal__btn settings-modal__btn--save" id="saveSessionSettingsBtn">Speichern</button>
            </div>
        </div>
    </div>
    
    <!-- Delete Confirmation Modal -->
    <div class="delete-modal" id="deleteModal">
        <div class="delete-modal__backdrop" id="deleteBackdrop"></div>
        <div class="delete-modal__dialog">
            <div class="delete-modal__icon">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <polyline points="3 6 5 6 21 6"/>
                    <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/>
                    <line x1="10" y1="11" x2="10" y2="17"/>
                    <line x1="14" y1="11" x2="14" y2="17"/>
                </svg>
            </div>
            <h3 class="delete-modal__title">Session löschen?</h3>
            <p class="delete-modal__text">Diese Aktion kann nicht rückgängig gemacht werden.</p>
            <div class="delete-modal__actions">
                <button class="delete-modal__btn delete-modal__btn--cancel" id="cancelDeleteBtn">Abbrechen</button>
                <button class="delete-modal__btn delete-modal__btn--confirm" id="confirmDeleteBtn">Löschen</button>
            </div>
        </div>
    </div>
    
    <!-- Cover Cropper Modal -->
    <div class="settings-modal" id="coverCropperModal">
        <div class="settings-modal__backdrop" id="coverCropperBackdrop"></div>
        <div class="settings-modal__dialog" style="width: 500px;">
            <div class="settings-modal__header">
                <h2 class="settings-modal__title">Cover zuschneiden</h2>
                <button class="settings-modal__close" id="closeCoverCropperModal">✕</button>
            </div>
            <div style="padding: 24px; background: #000;">
                <img id="coverCropperImage" style="max-width: 100%; display: block;">
            </div>
            <div class="settings-modal__footer">
                <button class="settings-modal__btn settings-modal__btn--cancel" id="coverCancelCropBtn">Abbrechen</button>
                <button class="settings-modal__btn settings-modal__btn--save" id="coverApplyCropBtn">Anwenden</button>
            </div>
        </div>
    </div>
    
    <!-- Character Select Modal (for Players) -->
    <div class="settings-modal" id="charSelectModal">
        <div class="settings-modal__backdrop" id="charSelectBackdrop"></div>
        <div class="settings-modal__dialog" style="max-width: 500px;">
            <div class="settings-modal__header">
                <h2 class="settings-modal__title" style="display: flex; align-items: center; gap: 10px;">
                    <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/>
                        <circle cx="12" cy="7" r="4"/>
                    </svg>
                    Charakter auswählen
                </h2>
                <button class="settings-modal__close" id="closeCharSelectModal">✕</button>
            </div>
            <div class="settings-tab settings-tab--active" style="padding: 24px;">
                <p style="color: var(--text-muted); margin-bottom: 20px; font-size: 14px;">
                    Wähle einen deiner Charaktere für diese Session:
                </p>
                <div id="charSelectList" style="display: flex; flex-direction: column; gap: 10px;">
                    <!-- Wird dynamisch gefüllt -->
                </div>
                <div id="charSelectEmpty" style="display: none; text-align: center; padding: 40px 20px; color: var(--text-dim);">
                    <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" style="margin-bottom: 16px; opacity: 0.5;">
                        <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/>
                        <circle cx="12" cy="7" r="4"/>
                    </svg>
                    <p style="margin-bottom: 12px;">Du hast noch keinen Charakter für dieses Regelwerk.</p>
                    <a href="sheet.html" class="settings-modal__btn settings-modal__btn--save" style="display: inline-block; text-decoration: none;">
                        Charakter erstellen
                    </a>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Add Link Modal -->
    <div class="settings-modal" id="addLinkModal">
        <div class="settings-modal__backdrop" onclick="closeAddLinkModal()"></div>
        <div class="settings-modal__dialog" style="max-width: 450px;">
            <div class="settings-modal__header">
                <h2 class="settings-modal__title" style="display: flex; align-items: center; gap: 10px;">
                    <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"/>
                        <path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"/>
                    </svg>
                    Link hinzufügen
                </h2>
                <button class="settings-modal__close" onclick="closeAddLinkModal()">✕</button>
            </div>
            <div class="settings-tab settings-tab--active" style="padding: 24px;">
                <div class="settings-group">
                    <label class="settings-group__label">Titel</label>
                    <input type="text" class="settings-input" id="addLinkTitle" placeholder="z.B. Spotify Playlist, Wiki, ...">
                </div>
                <div class="settings-group" style="margin-top: 16px;">
                    <label class="settings-group__label">URL</label>
                    <input type="url" class="settings-input" id="addLinkUrl" placeholder="https://...">
                </div>
                <div class="settings-group" style="margin-top: 16px;">
                    <label class="settings-group__label">Icon</label>
                    <div class="icon-select-grid">
                        <button type="button" class="icon-select-btn icon-select-btn--active" data-icon="link" onclick="selectLinkIcon(this)">
                            <svg viewBox="0 0 24 24" fill="currentColor"><path d="M3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7c-2.76 0-5 2.24-5 5s2.24 5 5 5h4v-1.9H7c-1.71 0-3.1-1.39-3.1-3.1zM8 13h8v-2H8v2zm9-6h-4v1.9h4c1.71 0 3.1 1.39 3.1 3.1s-1.39 3.1-3.1 3.1h-4V17h4c2.76 0 5-2.24 5-5s-2.24-5-5-5z"/></svg>
                        </button>
                        <button type="button" class="icon-select-btn" data-icon="music" onclick="selectLinkIcon(this)">
                            <svg viewBox="0 0 24 24" fill="currentColor"><path d="M12 3v10.55c-.59-.34-1.27-.55-2-.55-2.21 0-4 1.79-4 4s1.79 4 4 4 4-1.79 4-4V7h4V3h-6z"/></svg>
                        </button>
                        <button type="button" class="icon-select-btn" data-icon="video" onclick="selectLinkIcon(this)">
                            <svg viewBox="0 0 24 24" fill="currentColor"><path d="M18 4l2 4h-3l-2-4h-2l2 4h-3l-2-4H8l2 4H7L5 4H4c-1.1 0-1.99.9-1.99 2L2 18c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V4h-4z"/></svg>
                        </button>
                        <button type="button" class="icon-select-btn" data-icon="document" onclick="selectLinkIcon(this)">
                            <svg viewBox="0 0 24 24" fill="currentColor"><path d="M14 2H6c-1.1 0-1.99.9-1.99 2L4 20c0 1.1.89 2 1.99 2H18c1.1 0 2-.9 2-2V8l-6-6zm2 16H8v-2h8v2zm0-4H8v-2h8v2zm-3-5V3.5L18.5 9H13z"/></svg>
                        </button>
                        <button type="button" class="icon-select-btn" data-icon="map" onclick="selectLinkIcon(this)">
                            <svg viewBox="0 0 24 24" fill="currentColor"><path d="M20.5 3l-.16.03L15 5.1 9 3 3.36 4.9c-.21.07-.36.25-.36.48V20.5c0 .28.22.5.5.5l.16-.03L9 18.9l6 2.1 5.64-1.9c.21-.07.36-.25.36-.48V3.5c0-.28-.22-.5-.5-.5zM15 19l-6-2.11V5l6 2.11V19z"/></svg>
                        </button>
                        <button type="button" class="icon-select-btn" data-icon="image" onclick="selectLinkIcon(this)">
                            <svg viewBox="0 0 24 24" fill="currentColor"><path d="M21 19V5c0-1.1-.9-2-2-2H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2zM8.5 13.5l2.5 3.01L14.5 12l4.5 6H5l3.5-4.5z"/></svg>
                        </button>
                        <button type="button" class="icon-select-btn" data-icon="dice" onclick="selectLinkIcon(this)">
                            <svg viewBox="0 0 24 24" fill="currentColor"><path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zM7.5 18c-.83 0-1.5-.67-1.5-1.5S6.67 15 7.5 15s1.5.67 1.5 1.5S8.33 18 7.5 18zm0-9C6.67 9 6 8.33 6 7.5S6.67 6 7.5 6 9 6.67 9 7.5 8.33 9 7.5 9zm4.5 4.5c-.83 0-1.5-.67-1.5-1.5s.67-1.5 1.5-1.5 1.5.67 1.5 1.5-.67 1.5-1.5 1.5zm4.5 4.5c-.83 0-1.5-.67-1.5-1.5s.67-1.5 1.5-1.5 1.5.67 1.5 1.5-.67 1.5-1.5 1.5zm0-9c-.83 0-1.5-.67-1.5-1.5S15.67 6 16.5 6s1.5.67 1.5 1.5S17.33 9 16.5 9z"/></svg>
                        </button>
                        <button type="button" class="icon-select-btn" data-icon="shop" onclick="selectLinkIcon(this)">
                            <svg viewBox="0 0 24 24" fill="currentColor"><path d="M7 18c-1.1 0-1.99.9-1.99 2S5.9 22 7 22s2-.9 2-2-.9-2-2-2zM1 2v2h2l3.6 7.59-1.35 2.45c-.16.28-.25.61-.25.96 0 1.1.9 2 2 2h12v-2H7.42c-.14 0-.25-.11-.25-.25l.03-.12.9-1.63h7.45c.75 0 1.41-.41 1.75-1.03l3.58-6.49c.08-.14.12-.31.12-.48 0-.55-.45-1-1-1H5.21l-.94-2H1zm16 16c-1.1 0-1.99.9-1.99 2s.89 2 1.99 2 2-.9 2-2-.9-2-2-2z"/></svg>
                        </button>
                        <button type="button" class="icon-select-btn" data-icon="star" onclick="selectLinkIcon(this)">
                            <svg viewBox="0 0 24 24" fill="currentColor"><path d="M12 17.27L18.18 21l-1.64-7.03L22 9.24l-7.19-.61L12 2 9.19 8.63 2 9.24l5.46 4.73L5.82 21z"/></svg>
                        </button>
                        <button type="button" class="icon-select-btn" data-icon="heart" onclick="selectLinkIcon(this)">
                            <svg viewBox="0 0 24 24" fill="currentColor"><path d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z"/></svg>
                        </button>
                        <button type="button" class="icon-select-btn" data-icon="discord" onclick="selectLinkIcon(this)">
                            <svg viewBox="0 0 24 24" fill="currentColor"><path d="M20.317 4.37a19.791 19.791 0 0 0-4.885-1.515.074.074 0 0 0-.079.037c-.21.375-.444.864-.608 1.25a18.27 18.27 0 0 0-5.487 0 12.64 12.64 0 0 0-.617-1.25.077.077 0 0 0-.079-.037A19.736 19.736 0 0 0 3.677 4.37a.07.07 0 0 0-.032.027C.533 9.046-.32 13.58.099 18.057a.082.082 0 0 0 .031.057 19.9 19.9 0 0 0 5.993 3.03.078.078 0 0 0 .084-.028c.462-.63.874-1.295 1.226-1.994a.076.076 0 0 0-.041-.106 13.107 13.107 0 0 1-1.872-.892.077.077 0 0 1-.008-.128c.126-.094.252-.192.373-.292a.074.074 0 0 1 .077-.01c3.928 1.793 8.18 1.793 12.062 0a.074.074 0 0 1 .078.01c.12.098.246.198.373.292a.077.077 0 0 1-.006.127 12.299 12.299 0 0 1-1.873.892.077.077 0 0 0-.041.107c.36.698.772 1.362 1.225 1.993a.076.076 0 0 0 .084.028 19.839 19.839 0 0 0 6.002-3.03.077.077 0 0 0 .032-.054c.5-5.177-.838-9.674-3.549-13.66a.061.061 0 0 0-.031-.03zM8.02 15.33c-1.183 0-2.157-1.085-2.157-2.419 0-1.333.956-2.419 2.157-2.419 1.21 0 2.176 1.096 2.157 2.42 0 1.333-.956 2.418-2.157 2.418zm7.975 0c-1.183 0-2.157-1.085-2.157-2.419 0-1.333.955-2.419 2.157-2.419 1.21 0 2.176 1.096 2.157 2.42 0 1.333-.946 2.418-2.157 2.418z"/></svg>
                        </button>
                        <button type="button" class="icon-select-btn" data-icon="wiki" onclick="selectLinkIcon(this)">
                            <svg viewBox="0 0 24 24" fill="currentColor"><path d="M14.97 18.95L12.41 12.92L10.23 17.31L8.05 12.92L5.59 18.95L3.81 18.36L7.05 10.55L8.95 14.04L9.97 12.11L8.07 8.27L5.73 12.91L3.97 12.29L7.25 5.05L10.03 10.21L12.41 5.92L15.19 10.21L17.97 5.05L21.25 12.29L19.49 12.91L17.15 8.27L15.25 12.11L16.27 14.04L18.17 10.55L21.41 18.36L19.63 18.95L17.17 12.92L14.97 18.95Z"/></svg>
                        </button>
                    </div>
                </div>
                <div style="display: flex; gap: 12px; margin-top: 24px;">
                    <button class="settings-modal__btn" style="flex: 1;" onclick="closeAddLinkModal()">Abbrechen</button>
                    <button class="settings-modal__btn settings-modal__btn--save" style="flex: 1;" onclick="saveCustomLink()">Hinzufügen</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Hidden Action Buttons for JS -->
    <div style="display: none;">
        <button id="startSessionBtn"></button>
        <button id="pauseSessionBtn"></button>
        <button id="resumeSessionBtn"></button>
        <button id="endSessionBtn"></button>
        <button id="editSessionBtn"></button>
    </div>

    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-storage-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    
    <!-- RIFT Core -->
    <script src="assets/js/firebase-config.js"></script>
    <script>
        // Auth Guard - redirect to login if not authenticated
        (function() {
            function waitForAuth() {
                // Wait for Firebase SDK
                if (typeof firebase === 'undefined' || !firebase.auth) {
                    return setTimeout(waitForAuth, 50);
                }
                // Wait for Firebase app initialization
                try {
                    var auth = firebase.auth();
                    auth.onAuthStateChanged(function(user) {
                        if (!user) {
                            window.location.href = '/login';
                        } else {
                            document.body.classList.add('auth-ready');
                        }
                    });
                } catch(e) {
                    // Firebase not initialized yet, retry
                    setTimeout(waitForAuth, 50);
                }
            }
            waitForAuth();
        })();
    </script>

    <script src="assets/js/app.js"></script>
    <script src="assets/js/layout.js"></script>
    <script src="assets/js/ui.js"></script>
    <script src="assets/js/settings.js"></script>
    <script src="assets/js/toast-service.js"></script>
    <script src="assets/js/user-service.js"></script>
    <script src="assets/js/room-service.js"></script>
    
    <!-- Cropper.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.6.1/cropper.min.js"></script>

    <script>
        // ========================================
        // COVER IMAGE DATABASE (IndexedDB)
        // ========================================
        // ========================================
        // COVER STORAGE (Cloudinary - kostenlos)
        // ========================================
        
        const CoverStorage = {
            cloudName: 'dza4jgreq',
            uploadPreset: 'RIFTapp',
            
            // Upload cover to Cloudinary
            async upload(sessionId, imageDataUrl) {
                try {
                    console.log('[CoverStorage] Uploading cover via Cloudinary...');
                    console.log('[CoverStorage] Image data length:', imageDataUrl.length);
                    
                    // Convert data URL to blob
                    const response = await fetch(imageDataUrl);
                    const blob = await response.blob();
                    
                    console.log('[CoverStorage] Blob size:', blob.size, 'type:', blob.type);
                    
                    // Create form data - unique public_id to avoid caching
                    const timestamp = Date.now();
                    const formData = new FormData();
                    formData.append('file', blob);
                    formData.append('upload_preset', this.uploadPreset);
                    formData.append('public_id', `session-covers/${sessionId}_${timestamp}`);
                    
                    // Upload to Cloudinary
                    const uploadResponse = await fetch(`https://api.cloudinary.com/v1_1/${this.cloudName}/image/upload`, {
                        method: 'POST',
                        body: formData
                    });
                    
                    if (!uploadResponse.ok) {
                        const errorText = await uploadResponse.text();
                        console.error('[CoverStorage] Upload response error:', errorText);
                        throw new Error('Upload failed');
                    }
                    
                    const result = await uploadResponse.json();
                    console.log('[CoverStorage] Cloudinary result:', result);
                    
                    if (result.secure_url) {
                        // Add cache-buster to URL
                        const urlWithCacheBuster = result.secure_url + '?v=' + timestamp;
                        console.log('[CoverStorage] Upload complete, URL:', urlWithCacheBuster);
                        return urlWithCacheBuster;
                    } else {
                        console.error('[CoverStorage] Upload failed:', result);
                        return null;
                    }
                } catch (error) {
                    console.error('[CoverStorage] Upload failed:', error);
                    return null;
                }
            },
            
            // Cloudinary doesn't need explicit delete for overwriting
            async delete(sessionId) {
                // With public_id, uploading same id overwrites the old image
                console.log('[CoverStorage] Cover reference removed');
            }
        };
        
        // Legacy CoverDB for migration (can be removed later)
        const CoverDB = {
            dbName: 'RIFTCovers',
            storeName: 'covers',
            
            async open() {
                return new Promise((resolve, reject) => {
                    const request = indexedDB.open(this.dbName, 1);
                    request.onerror = () => reject(request.error);
                    request.onsuccess = () => resolve(request.result);
                    request.onupgradeneeded = (e) => {
                        const db = e.target.result;
                        if (!db.objectStoreNames.contains(this.storeName)) {
                            db.createObjectStore(this.storeName);
                        }
                    };
                });
            },
            
            async get(sessionId) {
                try {
                    const db = await this.open();
                    return new Promise((resolve, reject) => {
                        const tx = db.transaction(this.storeName, 'readonly');
                        const store = tx.objectStore(this.storeName);
                        const request = store.get(sessionId);
                        request.onerror = () => reject(request.error);
                        request.onsuccess = () => resolve(request.result);
                    });
                } catch (e) {
                    return null;
                }
            },
            
            async delete(sessionId) {
                try {
                    const db = await this.open();
                    return new Promise((resolve, reject) => {
                        const tx = db.transaction(this.storeName, 'readwrite');
                        const store = tx.objectStore(this.storeName);
                        const request = store.delete(sessionId);
                        request.onerror = () => reject(request.error);
                        request.onsuccess = () => resolve();
                    });
                } catch (e) {
                    // Ignore
                }
            }
        };

        // ========================================
        // SESSION STATE
        // ========================================
        let sessionData = null;
        let timerInterval = null;
        let sessionStartTime = null;
        let sessionUnsubscribe = null;
        let isGM = false;
        let cropper = null;
        
        // Session visibility settings (defaults)
        const defaultVisibility = {
            showPartyHp: true,
            showOnlineStatus: true,
            showLevel: true,
            showCountdown: true,
            showDescription: true,
            hideCharacterNames: false,
            playersCanSelectCharacter: true,
            lockCharacters: false,
            gmCanEditHp: false,
            hpStyle: 'bar-numbers'
        };
        
        // Get session ID from URL
        const urlParams = new URLSearchParams(window.location.search);
        const sessionId = urlParams.get('id');
        const currentRoomCode = localStorage.getItem('rift_current_room') || null;

        // ========================================
        // RENDER SESSION CONTENT
        // ========================================
        function renderSessionPage() {
            // Sync active session to localStorage for topbar
            if (sessionData && (sessionData.status === 'live' || sessionData.status === 'paused')) {
                localStorage.setItem('rift_active_session', JSON.stringify({
                    id: sessionData.id,
                    name: sessionData.name,
                    startTime: sessionData.startTime,
                    status: sessionData.status,
                    pausedTime: sessionData.pausedTime || null,
                    totalPausedMs: sessionData.totalPausedMs || 0
                }));
            } else if (sessionData && sessionData.status !== 'live' && sessionData.status !== 'paused') {
                // Clear localStorage if this session is no longer active
                const activeSession = JSON.parse(localStorage.getItem('rift_active_session') || 'null');
                if (activeSession && activeSession.id === sessionData.id) {
                    localStorage.removeItem('rift_active_session');
                }
            }
            
            // Nach initLayout() ist der DOM neu aufgebaut - finde main__content
            const mainContent = document.querySelector('.main__content');
            if (!mainContent) {
                console.error('[Session] main__content not found');
                return;
            }
            
            // Finde oder erstelle sessionContent Container (nach Topbar)
            let content = document.getElementById('sessionContent');
            if (!content) {
                content = document.createElement('div');
                content.id = 'sessionContent';
                mainContent.appendChild(content);
            }
            
            // Get visibility settings
            const visibility = { ...defaultVisibility, ...(sessionData.visibility || {}) };
            
            // Format date
            let dateDisplay = { day: '--', num: '--', month: '--', full: '--', time: '20:00' };
            if (sessionData.date) {
                const dateObj = new Date(sessionData.date);
                const weekdays = ['Sonntag', 'Montag', 'Dienstag', 'Mittwoch', 'Donnerstag', 'Freitag', 'Samstag'];
                const weekdaysShort = ['SO', 'MO', 'DI', 'MI', 'DO', 'FR', 'SA'];
                const months = ['Januar', 'Februar', 'März', 'April', 'Mai', 'Juni', 'Juli', 'August', 'September', 'Oktober', 'November', 'Dezember'];
                const monthsShort = ['Jan', 'Feb', 'Mär', 'Apr', 'Mai', 'Jun', 'Jul', 'Aug', 'Sep', 'Okt', 'Nov', 'Dez'];
                
                dateDisplay = {
                    day: weekdaysShort[dateObj.getDay()],
                    num: String(dateObj.getDate()).padStart(2, '0'),
                    month: monthsShort[dateObj.getMonth()],
                    full: `${weekdays[dateObj.getDay()]}, ${dateObj.getDate()}. ${months[dateObj.getMonth()]}`,
                    time: sessionData.time || '20:00'
                };
            }
            
            // Ruleset info
            const rulesetNames = {
                '5e2024': 'D&D 5E (2024)',
                'worldsapart': 'WORLDS APART',
                'htbah': 'HOW TO BE A HERO',
                'cyberpunk': 'CYBERPUNK RED'
            };
            const rulesetIcons = {
                '5e2024': 'assets/img/rulesets/ruleset_5e_2024.svg',
                'worldsapart': 'assets/img/rulesets/ruleset_worldsapart.svg',
                'htbah': 'assets/img/rulesets/ruleset_htbah.svg',
                'cyberpunk': 'assets/img/rulesets/ruleset_cyberpunkred.svg'
            };
            
            // Status
            const statusMap = {
                'planned': { text: 'Geplant', class: 'planned' },
                'live': { text: 'Live', class: 'live' },
                'paused': { text: 'Pausiert', class: 'paused' },
                'ended': { text: 'Beendet', class: 'ended' }
            };
            const status = statusMap[sessionData.status] || statusMap.planned;
            
            // Build subtitle
            const subtitleParts = [];
            if (sessionData.subtitle) subtitleParts.push(sessionData.subtitle);
            if (sessionData.sessionCount > 1) {
                subtitleParts.push(`Session ${sessionData.currentSession || 1}/${sessionData.sessionCount}`);
            }
            subtitleParts.push(`${sessionData.maxPlayers || 4} Teilnehmer`);
            
            // Party data
            const players = sessionData.players || [];
            const partyCharacters = sessionData.partyCharacters || [];
            
            content.innerHTML = `
                <!-- Page Header -->
                <div class="session-page-header">
                    <a href="sessions.html" class="session-back-btn">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <polyline points="15 18 9 12 15 6"/>
                        </svg>
                        Zurück
                    </a>
                </div>
                
                <!-- Session Hero -->
                <div class="session-hero">
                    <!-- Cover -->
                    <div class="session-hero__cover" id="sessionCover" ${isGM ? 'onclick="openSettingsModal()"' : ''}>
                        ${sessionData.coverUrl ? `
                            <img src="${sessionData.coverUrl}" alt="Session Cover">
                        ` : (sessionData.hasCover ? '' : `
                            <div class="session-hero__cover-placeholder">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                                    <rect x="3" y="3" width="18" height="18" rx="2" ry="2"/>
                                    <circle cx="8.5" cy="8.5" r="1.5"/>
                                    <polyline points="21 15 16 10 5 21"/>
                                </svg>
                                <span>Kein Cover</span>
                            </div>
                        `)}
                        ${isGM ? '<button class="session-hero__cover-edit" onclick="event.stopPropagation(); openSettingsModal();"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></svg>Ändern</button>' : ''}
                    </div>
                    
                    <!-- Info -->
                    <div class="session-hero__info">
                        <!-- Top Row -->
                        <div class="session-hero__top-row">
                            <div class="session-hero__ruleset">
                                <img src="${rulesetIcons[sessionData.ruleset] || rulesetIcons.worldsapart}" alt="">
                                ${rulesetNames[sessionData.ruleset] || sessionData.ruleset}
                            </div>
                            <div class="session-hero__status session-hero__status--${status.class}">
                                <span class="session-hero__status-dot"></span>
                                ${status.text}
                            </div>
                        </div>
                        
                        <!-- Title -->
                        <h1 class="session-hero__title">${sessionData.name || 'Unbenannte Session'}</h1>
                        <p class="session-hero__subtitle">${subtitleParts.join(' · ')}</p>
                        
                        <!-- Date/Time/Countdown -->
                        <div class="session-hero__datetime">
                            <div class="session-date-box">
                                <div class="session-date-box__day">${dateDisplay.day}</div>
                                <div class="session-date-box__num">${dateDisplay.num}</div>
                                <div class="session-date-box__month">${dateDisplay.month}</div>
                            </div>
                            <div class="session-time-box">
                                <div class="session-time-box__label">Startzeit</div>
                                <div class="session-time-box__value">${dateDisplay.time} Uhr</div>
                            </div>
                            ${sessionData.status === 'live' ? `
                                <div class="session-live-timer">
                                    <div>
                                        <div class="session-live-timer__label">Spielzeit</div>
                                        <div class="session-live-timer__value" id="liveTimer">0:00:00</div>
                                    </div>
                                </div>
                            ` : (visibility.showCountdown && sessionData.status === 'planned' ? `
                                <div class="session-countdown" id="sessionCountdown">
                                    <div class="countdown-item">
                                        <span class="countdown-item__value" id="countdownDays">0</span>
                                        <span class="countdown-item__label">Tage</span>
                                    </div>
                                    <span class="countdown-sep">:</span>
                                    <div class="countdown-item">
                                        <span class="countdown-item__value" id="countdownHours">0</span>
                                        <span class="countdown-item__label">Std</span>
                                    </div>
                                    <span class="countdown-sep">:</span>
                                    <div class="countdown-item">
                                        <span class="countdown-item__value" id="countdownMins">0</span>
                                        <span class="countdown-item__label">Min</span>
                                    </div>
                                </div>
                            ` : '')}
                        </div>
                        
                        <!-- Session Meta (Duration, Recurrence) -->
                        ${(sessionData.duration || sessionData.recurring) ? `
                            <div class="session-hero__meta">
                                ${sessionData.duration ? `
                                    <div class="session-meta-item">
                                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                            <circle cx="12" cy="12" r="10"/>
                                            <polyline points="12 6 12 12 16 14"/>
                                        </svg>
                                        ~${sessionData.duration} Stunden
                                    </div>
                                ` : ''}
                                ${sessionData.recurring && sessionData.recurring !== 'once' ? `
                                    <div class="session-meta-item">
                                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                            <path d="M17 2l4 4-4 4"/>
                                            <path d="M3 11v-1a4 4 0 0 1 4-4h14"/>
                                            <path d="M7 22l-4-4 4-4"/>
                                            <path d="M21 13v1a4 4 0 0 1-4 4H3"/>
                                        </svg>
                                        ${getRecurrenceLabel(sessionData.recurring)}
                                    </div>
                                ` : ''}
                            </div>
                        ` : ''}
                        
                        <!-- Tags -->
                        ${(sessionData.tags && sessionData.tags.length > 0) || (sessionData.customTags && sessionData.customTags.length > 0) ? `
                            <div class="session-hero__tags">
                                ${(sessionData.tags || []).map(tag => `<span class="session-tag">${getTagLabel(tag)}</span>`).join('')}
                                ${(sessionData.customTags || []).map(tag => `<span class="session-tag session-tag--highlight">🏷️ ${tag}</span>`).join('')}
                            </div>
                        ` : ''}
                    </div>
                </div>
                
                <!-- Description Section (Collapsible) -->
                ${(visibility.showDescription || isGM) && sessionData.description ? `
                    <section class="session-description-section" id="descriptionSection">
                        <div class="session-description__header" onclick="toggleDescription()">
                            <div class="session-description__header-left">
                                <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor" style="color: var(--accent);">
                                    <path d="M3 3h18v2H3V3zm0 4h12v2H3V7zm0 4h18v2H3v-2zm0 4h12v2H3v-2zm0 4h18v2H3v-2z"/>
                                </svg>
                                <span>Über dieses Abenteuer</span>
                            </div>
                            <button class="session-description__toggle" id="descToggleBtn">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <polyline points="6 9 12 15 18 9"/>
                                </svg>
                            </button>
                        </div>
                        <div class="session-description__content" id="descriptionContent">
                            <div class="session-description__text">
                                ${formatDescription(sessionData.description)}
                            </div>
                        </div>
                    </section>
                ` : ''}
                
                <!-- Resources Section -->
                <section class="session-resources">
                    <div class="session-resources__grid">
                        <!-- Voice Chat -->
                        ${sessionData.voiceLink ? `
                            <a href="${sessionData.voiceLink}" target="_blank" class="resource-btn resource-btn--voice" data-platform="${getVoicePlatformName(sessionData.voiceLink).toLowerCase()}">
                                ${getVoiceIcon(sessionData.voiceLink)}
                                <span>${getVoicePlatformName(sessionData.voiceLink) ? getVoicePlatformName(sessionData.voiceLink) + ' Voice-Chat' : 'Voice-Chat'}</span>
                            </a>
                        ` : ''}
                        
                        <!-- Calendar Export -->
                        ${sessionData.date ? `
                            <button class="resource-btn" onclick="exportToCalendar()">
                                <svg viewBox="0 0 24 24" fill="currentColor">
                                    <path d="M19 4h-1V2h-2v2H8V2H6v2H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2zm0 16H5V10h14v10zm0-12H5V6h14v2z"/>
                                </svg>
                                <span>Kalender Export</span>
                            </button>
                        ` : ''}
                        
                        <!-- Rulebook Link -->
                        ${getRulebookLink(sessionData.ruleset) ? `
                            <a href="${getRulebookLink(sessionData.ruleset)}" ${sessionData.ruleset !== 'worldsapart' ? 'target="_blank"' : ''} class="resource-btn">
                                <svg viewBox="0 0 24 24" fill="currentColor">
                                    <path d="M21 5c-1.11-.35-2.33-.5-3.5-.5-1.95 0-4.05.4-5.5 1.5-1.45-1.1-3.55-1.5-5.5-1.5S2.45 4.9 1 6v14.65c0 .25.25.5.5.5.1 0 .15-.05.25-.05C3.1 20.45 5.05 20 6.5 20c1.95 0 4.05.4 5.5 1.5 1.35-.85 3.8-1.5 5.5-1.5 1.65 0 3.35.3 4.75 1.05.1.05.15.05.25.05.25 0 .5-.25.5-.5V6c-.6-.45-1.25-.75-2-1zm0 13.5c-1.1-.35-2.3-.5-3.5-.5-1.7 0-4.15.65-5.5 1.5V8c1.35-.85 3.8-1.5 5.5-1.5 1.2 0 2.4.15 3.5.5v11.5z"/>
                                </svg>
                                <span>Regelwerk aufrufen</span>
                            </a>
                        ` : ''}
                        
                        <!-- Custom Links -->
                        ${(sessionData.customLinks || []).map((link, index) => `
                            <a href="${link.url}" target="_blank" class="resource-btn">
                                ${getCustomLinkIcon(link.icon)}
                                <span>${link.title}</span>
                                ${isGM ? `<button class="resource-btn__delete" onclick="event.preventDefault(); event.stopPropagation(); removeCustomLink(${index});">✕</button>` : ''}
                            </a>
                        `).join('')}
                        
                        <!-- Add Link (GM only) -->
                        ${isGM ? `
                            <button class="resource-btn resource-btn--add" onclick="openAddLinkModal()">
                                <svg viewBox="0 0 24 24" fill="currentColor">
                                    <path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z"/>
                                </svg>
                                <span>Link hinzufügen</span>
                            </button>
                        ` : ''}
                    </div>
                </section>
                
                <!-- Party Section -->
                <section class="session-section">
                    <div class="session-section__header">
                        <h2 class="session-section__title">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor" style="color: var(--accent);">
                                <path d="M16.5 13C15.3 13 14.29 13.62 13.67 14.5H10.33C9.71 13.62 8.7 13 7.5 13C5.57 13 4 14.57 4 16.5C4 18.43 5.57 20 7.5 20C8.7 20 9.71 19.38 10.33 18.5H13.67C14.29 19.38 15.3 20 16.5 20C18.43 20 20 18.43 20 16.5C20 14.57 18.43 13 16.5 13ZM7.5 18.5C6.4 18.5 5.5 17.6 5.5 16.5S6.4 14.5 7.5 14.5 9.5 15.4 9.5 16.5 8.6 18.5 7.5 18.5ZM16.5 18.5C15.4 18.5 14.5 17.6 14.5 16.5S15.4 14.5 16.5 14.5 18.5 15.4 18.5 16.5 17.6 18.5 16.5 18.5Z"/>
                                <path d="M12 11C14.21 11 16 9.21 16 7S14.21 3 12 3 8 4.79 8 7 9.79 11 12 11Z"/>
                            </svg>
                            Die Gruppe
                            <span class="session-section__count">${partyCharacters.length} / ${sessionData.maxPlayers || 4} Charaktere</span>
                        </h2>
                    </div>
                    <div class="party-grid" id="partyGrid">
                        ${renderPartyCards(visibility)}
                    </div>
                </section>
                
                <!-- Quick Actions -->
                <section class="session-section">
                    <div class="session-section__header">
                        <h2 class="session-section__title">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor" style="color: var(--accent);">
                                <path d="M14 4.43L10 4.42C7.05 4.4 5 6.45 5 9.4V10.6C5 13.55 7.03 15.59 10 15.59H14C16.97 15.6 19 13.56 19 10.61V9.4C19 6.45 16.97 4.43 14 4.43ZM14.72 11.72C14.58 11.86 14.4 11.92 14.22 11.92C14.04 11.92 13.86 11.86 13.72 11.72L12.5 10.5V13.5C12.5 13.91 12.16 14.25 11.75 14.25C11.34 14.25 11 13.91 11 13.5V10.5L9.78 11.72C9.49 12.01 9.01 12.01 8.72 11.72C8.43 11.43 8.43 10.95 8.72 10.66L11.22 8.16C11.51 7.87 11.99 7.87 12.28 8.16L14.78 10.66C15.07 10.95 15.07 11.43 14.72 11.72Z"/>
                                <path d="M19.44 17.61C19.3 17.52 19.13 17.49 18.96 17.52L14.29 18.3C14.01 18.35 13.72 18.37 13.44 18.37H10C9.59 18.37 9.25 18.01 9.25 17.6C9.25 17.19 9.59 16.85 10 16.85H13.44C14.03 16.85 14.61 16.79 15.18 16.68L15.96 16.54C16.2 16.5 16.46 16.54 16.67 16.67L17.85 17.4C18.59 17.83 19.5 17.27 19.5 16.4C19.5 16.13 19.4 15.87 19.22 15.68L17.96 14.26C17.35 13.57 16.49 13.16 15.57 13.12L14.37 13.07C13.93 13.05 13.5 13.08 13.08 13.17L10.24 13.78C9.83 13.87 9.44 13.61 9.35 13.2C9.26 12.79 9.52 12.4 9.93 12.31L12.78 11.69C13.31 11.58 13.85 11.54 14.39 11.57L15.59 11.62C16.89 11.67 18.1 12.24 18.96 13.2L20.22 14.62C20.73 15.18 21 15.91 21 16.68C21 18.97 18.6 20.43 16.53 19.38L15.35 18.77L19.63 18.06C20.08 17.98 20.38 17.55 20.3 17.1C20.24 16.86 20.13 16.66 19.93 16.54L19.44 17.61Z"/>
                            </svg>
                            Schnellzugriff
                        </h2>
                    </div>
                    <div class="quick-actions">
                        <a href="dice.html" class="quick-action">
                            <svg class="quick-action__icon" width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                                <path d="M20.47 6.62L12.57 2.18C12.41 2.06 12.21 2 12 2S11.59 2.06 11.43 2.18L3.53 6.62C3.21 6.79 3 7.12 3 7.5V16.5C3 16.88 3.21 17.21 3.53 17.38L11.43 21.82C11.59 21.94 11.79 22 12 22S12.41 21.94 12.57 21.82L20.47 17.38C20.79 17.21 21 16.88 21 16.5V7.5C21 7.12 20.79 6.79 20.47 6.62M11.45 15.96L6.31 15.93V14.91C6.31 14.91 9.74 11.58 9.75 10.57C9.75 9.33 8.73 9.46 8.73 9.46S7.75 9.5 7.64 10.71L6.14 10.76C6.14 10.76 6.18 8.26 8.83 8.26C11.2 8.26 11.23 10.04 11.23 10.5C11.23 12.18 8.15 14.77 8.15 14.77L11.45 14.76V15.96M17.5 13.5C17.5 14.9 16.35 16.05 14.93 16.05C13.5 16.05 12.36 14.9 12.36 13.5V10.84C12.36 9.42 13.5 8.27 14.93 8.27S17.5 9.42 17.5 10.84V13.5M16 10.77V13.53C16 14.12 15.5 14.6 14.92 14.6C14.34 14.6 13.86 14.12 13.86 13.53V10.77C13.86 10.18 14.34 9.71 14.92 9.71C15.5 9.71 16 10.18 16 10.77Z"/>
                            </svg>
                            Würfeln
                        </a>
                        <a href="${getCharacterSheetLink(sessionData.ruleset)}" class="quick-action">
                            <svg class="quick-action__icon" width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                                <path fill-rule="evenodd" clip-rule="evenodd" d="M4.17157 3.17157C3 4.34315 3 6.22876 3 10V14C3 17.7712 3 19.6569 4.17157 20.8284C5.34315 22 7.22876 22 11 22H13C16.7712 22 18.6569 22 19.8284 20.8284C21 19.6569 21 17.7712 21 14V10C21 6.22876 21 4.34315 19.8284 3.17157C18.6569 2 16.7712 2 13 2H11C7.22876 2 5.34315 2 4.17157 3.17157ZM7.25 8C7.25 7.58579 7.58579 7.25 8 7.25H16C16.4142 7.25 16.75 7.58579 16.75 8C16.75 8.41421 16.4142 8.75 16 8.75H8C7.58579 8.75 7.25 8.41421 7.25 8ZM7.25 12C7.25 11.5858 7.58579 11.25 8 11.25H16C16.4142 11.25 16.75 11.5858 16.75 12C16.75 12.4142 16.4142 12.75 16 12.75H8C7.58579 12.75 7.25 12.4142 7.25 12ZM8 15.25C7.58579 15.25 7.25 15.5858 7.25 16C7.25 16.4142 7.58579 16.75 8 16.75H13C13.4142 16.75 13.75 16.4142 13.75 16C13.75 15.5858 13.4142 15.25 13 15.25H8Z"/>
                            </svg>
                            Mein Bogen
                        </a>
                        <a href="chat.html" class="quick-action">
                            <svg class="quick-action__icon" width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                                <path fill-rule="evenodd" clip-rule="evenodd" d="M12 22C17.5228 22 22 17.5228 22 12C22 6.47715 17.5228 2 12 2C6.47715 2 2 6.47715 2 12C2 13.5997 2.37562 15.1116 3.04346 16.4525C3.22094 16.8088 3.28001 17.2161 3.17712 17.6006L2.58151 19.8267C2.32295 20.793 3.20701 21.677 4.17335 21.4185L6.39939 20.8229C6.78393 20.72 7.19121 20.7791 7.54753 20.9565C8.88837 21.6244 10.4003 22 12 22Z"/>
                            </svg>
                            Chat
                        </a>
                        <a href="map.html" class="quick-action">
                            <svg class="quick-action__icon" width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                                <path fill-rule="evenodd" clip-rule="evenodd" d="M12 22C17.5228 22 22 17.5228 22 12C22 6.47715 17.5228 2 12 2C6.47715 2 2 6.47715 2 12C2 17.5228 6.47715 22 12 22ZM13.9563 14.0949C13.763 14.2644 13.5167 14.3629 13.024 14.56C10.7142 15.4839 9.55936 15.9459 8.89971 15.4976C8.7433 15.3913 8.6084 15.2564 8.50212 15.1C8.05386 14.4404 8.51582 13.2855 9.43973 10.9757C9.6368 10.483 9.73533 10.2367 9.9048 10.0434C9.94799 9.99419 9.99435 9.94782 10.0436 9.90464C10.2368 9.73517 10.4832 9.63663 10.9759 9.43956C13.2856 8.51565 14.4405 8.0537 15.1002 8.50196C15.2566 8.60824 15.3915 8.74314 15.4978 8.89954C15.946 9.5592 15.4841 10.7141 14.5602 13.0239C14.3631 13.5165 14.2646 13.7629 14.0951 13.9561C14.0519 14.0054 14.0055 14.0517 13.9563 14.0949Z"/>
                            </svg>
                            Karte
                        </a>
                        <a href="whiteboard.html" class="quick-action">
                            <svg class="quick-action__icon" width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                                <path fill-rule="evenodd" clip-rule="evenodd" d="M3.46447 3.46447C2 4.92893 2 7.28595 2 12C2 16.714 2 19.0711 3.46447 20.5355C4.92893 22 7.28595 22 12 22C16.714 22 19.0711 22 20.5355 20.5355C22 19.0711 22 16.714 22 12C22 7.28595 22 4.92893 20.5355 3.46447C19.0711 2 16.714 2 12 2C7.28595 2 4.92893 2 3.46447 3.46447ZM17 12.25C17.4142 12.25 17.75 12.5858 17.75 13V18C17.75 18.4142 17.4142 18.75 17 18.75C16.5858 18.75 16.25 18.4142 16.25 18V13C16.25 12.5858 16.5858 12.25 17 12.25ZM12.75 6C12.75 5.58579 12.4142 5.25 12 5.25C11.5858 5.25 11.25 5.58579 11.25 6V18C11.25 18.4142 11.5858 18.75 12 18.75C12.4142 18.75 12.75 18.4142 12.75 18V6ZM7 8.25C7.41421 8.25 7.75 8.58579 7.75 9V18C7.75 18.4142 7.41421 18.75 7 18.75C6.58579 18.75 6.25 18.4142 6.25 18V9C6.25 8.58579 6.58579 8.25 7 8.25Z"/>
                            </svg>
                            Whiteboard
                        </a>
                        <div class="invite-box">
                            <span class="invite-box__label">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/>
                                    <circle cx="9" cy="7" r="4"/>
                                    <line x1="19" y1="8" x2="19" y2="14"/>
                                    <line x1="22" y1="11" x2="16" y2="11"/>
                                </svg>
                                Session-Einladung
                            </span>
                            <button class="invite-box__btn" onclick="copyInviteLink()">Kopieren</button>
                        </div>
                    </div>
                </section>
                
                <!-- GM Bar -->
                <div class="gm-bar ${isGM ? 'gm-bar--visible' : ''}" id="gmBar">
                    ${renderGMBarButtons()}
                </div>
            `;
            
            // Load cover image (for legacy IndexedDB covers that need migration)
            if (sessionData.hasCover && !sessionData.coverUrl) {
                loadCoverImage();
            }
            
            // Start timer if live
            if (sessionData.status === 'live') {
                startTimer();
            }
            
            // Update countdown
            if (sessionData.status === 'planned') {
                updateCountdown();
            }
            
            // Update document title
            document.title = `RIFT – ${sessionData.name || 'Session'}`;
            
            // Initialize description collapsed/expanded state
            initDescriptionState();
        }
        
        function renderPartyCards(visibility) {
            const players = sessionData.players || [];
            const partyCharacters = sessionData.partyCharacters || [];
            const maxPlayers = sessionData.maxPlayers || 4;
            
            let html = '';
            
            // GM Card (always first if we have GM data)
            const gmData = sessionData.gm || { name: sessionData.gmName || 'Game Master', color: '#FF4655' };
            html += `
                <div class="party-card party-card--gm">
                    <span class="party-card__gm-badge">GM</span>
                    <div class="party-card__portrait" style="border-color: ${gmData.color || 'var(--accent)'}; color: ${gmData.color || 'var(--accent)'};">
                        ${gmData.avatar ? `<img src="${gmData.avatar}" alt="">` : (gmData.name || 'GM')[0].toUpperCase()}
                        ${visibility.showOnlineStatus ? `<div class="party-card__online party-card__online--on"></div>` : ''}
                    </div>
                    <div class="party-card__info">
                        <div class="party-card__name">${gmData.name || 'Game Master'}</div>
                        <div class="party-card__class">Spielleiter</div>
                    </div>
                </div>
            `;
            
            // Party Characters
            partyCharacters.forEach((char, index) => {
                const player = players.find(p => p.id === char.playerId) || {};
                const hpPercent = char.maxHp ? Math.round((char.hp / char.maxHp) * 100) : 100;
                const hpClass = hpPercent > 60 ? 'high' : hpPercent > 30 ? 'mid' : 'low';
                
                html += `
                    <div class="party-card" data-char-id="${char.id}">
                        <div class="party-card__portrait party-card__portrait--has-char" style="--char-color: ${char.color || '#8B5CF6'};">
                            ${char.portrait ? `<img src="${char.portrait}" alt="">` : (char.name || '?')[0].toUpperCase()}
                            ${visibility.showOnlineStatus ? `<div class="party-card__online party-card__online--${player.online ? 'on' : 'off'}"></div>` : ''}
                        </div>
                        <div class="party-card__info">
                            <div class="party-card__name">${visibility.hideCharacterNames ? (player.name || 'Spieler') : (char.name || 'Unbenannt')}</div>
                            <div class="party-card__class">${char.class || char.profession || 'Abenteurer'}${visibility.showLevel && char.level ? ` · Lvl ${char.level}` : ''}</div>
                            ${visibility.showPartyHp && visibility.hpStyle !== 'hidden' ? `
                                <div class="party-card__hp">
                                    ${visibility.hpStyle !== 'percent' ? `
                                        <div class="party-card__hp-bar">
                                            <div class="party-card__hp-fill party-card__hp-fill--${hpClass}" style="width: ${hpPercent}%;"></div>
                                        </div>
                                    ` : ''}
                                    <span class="party-card__hp-text">
                                        ${visibility.hpStyle === 'percent' ? `${hpPercent}%` : 
                                          visibility.hpStyle === 'bar-only' ? '' : 
                                          `${char.hp || 0}/${char.maxHp || 0}`}
                                    </span>
                                </div>
                            ` : ''}
                        </div>
                        <div class="party-card__player">${player.name || 'Spieler'}</div>
                        ${isGM ? `
                            <div class="party-card__actions">
                                <button class="party-card__action-btn" onclick="editPartyMember('${char.id}')" title="Bearbeiten">
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/>
                                        <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/>
                                    </svg>
                                </button>
                                <button class="party-card__action-btn" onclick="removePartyMember('${char.id}')" title="Entfernen">
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <line x1="18" y1="6" x2="6" y2="18"/>
                                        <line x1="6" y1="6" x2="18" y2="18"/>
                                    </svg>
                                </button>
                            </div>
                        ` : ''}
                    </div>
                `;
            });
            
            // Empty Slots
            const emptySlots = Math.max(0, maxPlayers - partyCharacters.length - 1); // -1 for GM
            for (let i = 0; i < emptySlots; i++) {
                html += `
                    <div class="party-card party-card--empty ${!isGM ? 'party-card--clickable' : ''}" ${!isGM ? 'onclick="openCharacterSelectModal()"' : ''}>
                        <div class="party-card__portrait" style="color: var(--text-dim); font-size: 24px;">+</div>
                        <div class="party-card__info">
                            <div class="party-card__empty-text">
                                <strong>Freier Platz</strong>
                                <span>${!isGM ? 'Klicke um deinen Charakter zuzuweisen' : 'Wartet auf Spieler...'}</span>
                            </div>
                        </div>
                    </div>
                `;
            }
            
            return html;
        }
        
        function renderGMBarButtons() {
            const status = sessionData?.status || 'planned';
            
            switch (status) {
                case 'planned':
                    return `
                        <button class="gm-bar__btn gm-bar__btn--start" onclick="startSession()">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polygon points="5 3 19 12 5 21 5 3"/></svg>
                            Session starten
                        </button>
                        <button class="gm-bar__btn gm-bar__btn--secondary" onclick="openSettingsModal()">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"/></svg>
                            Einstellungen
                        </button>
                    `;
                case 'live':
                    return `
                        <button class="gm-bar__btn gm-bar__btn--pause" onclick="pauseSession()">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="6" y="4" width="4" height="16"/><rect x="14" y="4" width="4" height="16"/></svg>
                            Pausieren
                        </button>
                        <button class="gm-bar__btn gm-bar__btn--end" onclick="endSession()">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="6" y="6" width="12" height="12" rx="2"/></svg>
                            Beenden
                        </button>
                        <button class="gm-bar__btn gm-bar__btn--secondary" onclick="openSettingsModal()">⚙️</button>
                    `;
                case 'paused':
                    return `
                        <button class="gm-bar__btn gm-bar__btn--resume" onclick="resumeSession()">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polygon points="5 3 19 12 5 21 5 3"/></svg>
                            Fortsetzen
                        </button>
                        <button class="gm-bar__btn gm-bar__btn--end" onclick="endSession()">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="6" y="6" width="12" height="12" rx="2"/></svg>
                            Beenden
                        </button>
                        <button class="gm-bar__btn gm-bar__btn--secondary" onclick="openSettingsModal()">⚙️</button>
                    `;
                case 'ended':
                    return `
                        <button class="gm-bar__btn gm-bar__btn--start" onclick="reopenSession()">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"/><path d="M3 3v5h5"/></svg>
                            Wiederaufnehmen
                        </button>
                        <button class="gm-bar__btn gm-bar__btn--secondary" onclick="openSettingsModal()">⚙️</button>
                    `;
                default:
                    return '';
            }
        }

        // ========================================
        // HELPER FUNCTIONS
        // ========================================
        
        function formatDescription(text) {
            if (!text) return '';
            return text
                .split(/\n\n+/)
                .filter(p => p.trim())
                .map(p => `<p>${p.replace(/\n/g, '<br>')}</p>`)
                .join('');
        }
        
        function getVoicePlatformName(url) {
            if (!url) return '';
            const lower = url.toLowerCase();
            if (lower.includes('discord')) return 'Discord';
            if (lower.includes('teamspeak') || lower.includes('ts3server')) return 'TeamSpeak';
            if (lower.includes('zoom')) return 'Zoom';
            if (lower.includes('meet.google')) return 'Google Meet';
            if (lower.includes('teams.microsoft') || lower.includes('teams.live')) return 'MS Teams';
            if (lower.includes('skype')) return 'Skype';
            if (lower.includes('mumble')) return 'Mumble';
            return 'Voice Chat';
        }
        
        function getVoiceIcon(url) {
            const defaultIcon = `<svg viewBox="0 0 24 24" fill="currentColor"><path d="M12 14c1.66 0 3-1.34 3-3V5c0-1.66-1.34-3-3-3S9 3.34 9 5v6c0 1.66 1.34 3 3 3zm5.91-3c-.49 0-.9.36-.98.85C16.52 14.2 14.47 16 12 16s-4.52-1.8-4.93-4.15c-.08-.49-.49-.85-.98-.85-.61 0-1.09.54-1 1.14.49 3 2.89 5.35 5.91 5.78V20c0 .55.45 1 1 1s1-.45 1-1v-2.08c3.02-.43 5.42-2.78 5.91-5.78.1-.6-.39-1.14-1-1.14z"/></svg>`;
            if (!url) return defaultIcon;
            const lower = url.toLowerCase();
            
            // Discord
            if (lower.includes('discord')) {
                return `<svg viewBox="0 0 24 24" fill="currentColor"><path d="M20.317 4.37a19.791 19.791 0 0 0-4.885-1.515.074.074 0 0 0-.079.037c-.21.375-.444.864-.608 1.25a18.27 18.27 0 0 0-5.487 0 12.64 12.64 0 0 0-.617-1.25.077.077 0 0 0-.079-.037A19.736 19.736 0 0 0 3.677 4.37a.07.07 0 0 0-.032.027C.533 9.046-.32 13.58.099 18.057a.082.082 0 0 0 .031.057 19.9 19.9 0 0 0 5.993 3.03.078.078 0 0 0 .084-.028 14.09 14.09 0 0 0 1.226-1.994.076.076 0 0 0-.041-.106 13.107 13.107 0 0 1-1.872-.892.077.077 0 0 1-.008-.128 10.2 10.2 0 0 0 .372-.292.074.074 0 0 1 .077-.01c3.928 1.793 8.18 1.793 12.062 0a.074.074 0 0 1 .078.01c.12.098.246.198.373.292a.077.077 0 0 1-.006.127 12.299 12.299 0 0 1-1.873.892.077.077 0 0 0-.041.107c.36.698.772 1.362 1.225 1.993a.076.076 0 0 0 .084.028 19.839 19.839 0 0 0 6.002-3.03.077.077 0 0 0 .032-.054c.5-5.177-.838-9.674-3.549-13.66a.061.061 0 0 0-.031-.03zM8.02 15.33c-1.183 0-2.157-1.085-2.157-2.419 0-1.333.956-2.419 2.157-2.419 1.21 0 2.176 1.096 2.157 2.42 0 1.333-.956 2.418-2.157 2.418zm7.975 0c-1.183 0-2.157-1.085-2.157-2.419 0-1.333.955-2.419 2.157-2.419 1.21 0 2.176 1.096 2.157 2.42 0 1.333-.946 2.418-2.157 2.418z"/></svg>`;
            }
            
            // TeamSpeak
            if (lower.includes('teamspeak') || lower.includes('ts3server')) {
                return `<svg viewBox="0 0 24 24" fill="currentColor"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 3c1.66 0 3 1.34 3 3s-1.34 3-3 3-3-1.34-3-3 1.34-3 3-3zm0 14.2c-2.5 0-4.71-1.28-6-3.22.03-1.99 4-3.08 6-3.08 1.99 0 5.97 1.09 6 3.08-1.29 1.94-3.5 3.22-6 3.22z"/></svg>`;
            }
            
            // Zoom
            if (lower.includes('zoom')) {
                return `<svg viewBox="0 0 24 24" fill="currentColor"><path d="M4 4h11a3 3 0 0 1 3 3v6a3 3 0 0 1-3 3H4a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2zm14 4l4-3v10l-4-3V8z"/></svg>`;
            }
            
            // Google Meet
            if (lower.includes('meet.google')) {
                return `<svg viewBox="0 0 24 24" fill="currentColor"><path d="M12 11h6v2h-6v6h-2v-6H4v-2h6V5h2v6z"/><path d="M19 3H5a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V5a2 2 0 0 0-2-2z" fill="none" stroke="currentColor" stroke-width="2"/></svg>`;
            }
            
            // MS Teams
            if (lower.includes('teams.microsoft') || lower.includes('teams.live')) {
                return `<svg viewBox="0 0 24 24" fill="currentColor"><path d="M19.5 9.5a2.5 2.5 0 1 0 0-5 2.5 2.5 0 0 0 0 5zm-5-5a3 3 0 1 0 0 6 3 3 0 0 0 0-6zM9 13v7H2v-4a4 4 0 0 1 4-4h3zm11.5 0a2 2 0 0 1 2 2v3h-5v-3a2 2 0 0 1 2-2h1zm-6.5 0a3 3 0 0 1 3 3v4H7v-4a3 3 0 0 1 3-3h4z"/></svg>`;
            }
            
            // Skype
            if (lower.includes('skype')) {
                return `<svg viewBox="0 0 24 24" fill="currentColor"><path d="M12.069 18.874c-4.023 0-5.82-1.979-5.82-3.464 0-.765.561-1.296 1.333-1.296 1.723 0 1.273 2.477 4.487 2.477 1.641 0 2.55-.895 2.55-1.811 0-.551-.269-1.16-1.354-1.429l-3.576-.895c-2.88-.724-3.403-2.286-3.403-3.751 0-3.047 2.861-4.191 5.549-4.191 2.471 0 5.393 1.373 5.393 3.199 0 .784-.688 1.24-1.453 1.24-1.469 0-1.198-2.037-4.164-2.037-1.469 0-2.292.664-2.292 1.617s1.153 1.258 2.157 1.487l2.637.587c2.891.649 3.624 2.346 3.624 3.944 0 2.476-1.902 4.324-5.722 4.324M20.5 12c0 .689-.084 1.36-.234 2.001a5.5 5.5 0 0 1-6.267 6.267A8.5 8.5 0 1 1 20.5 12z"/></svg>`;
            }
            
            // Default microphone
            return defaultIcon;
        }
        
        function getRulebookLink(ruleset) {
            const links = {
                '5e2024': 'https://www.dndbeyond.com/sources/dnd/phb-2024',
                'worldsapart': 'worldsapart.html',
                'htbah': 'https://howtobeahero.de/index.php/Regelwerk',
                'cyberpunk': 'https://rtalsoriangames.com/cyberpunk/'
            };
            return links[ruleset] || null;
        }
        
        function getCustomLinkIcon(iconName) {
            const icons = {
                'link': '<svg viewBox="0 0 24 24" fill="currentColor"><path d="M3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7c-2.76 0-5 2.24-5 5s2.24 5 5 5h4v-1.9H7c-1.71 0-3.1-1.39-3.1-3.1zM8 13h8v-2H8v2zm9-6h-4v1.9h4c1.71 0 3.1 1.39 3.1 3.1s-1.39 3.1-3.1 3.1h-4V17h4c2.76 0 5-2.24 5-5s-2.24-5-5-5z"/></svg>',
                'wiki': '<svg viewBox="0 0 24 24" fill="currentColor"><path d="M14.97 18.95L12.41 12.92L10.23 17.31L8.05 12.92L5.59 18.95L3.81 18.36L7.05 10.55L8.95 14.04L9.97 12.11L8.07 8.27L5.73 12.91L3.97 12.29L7.25 5.05L10.03 10.21L12.41 5.92L15.19 10.21L17.97 5.05L21.25 12.29L19.49 12.91L17.15 8.27L15.25 12.11L16.27 14.04L18.17 10.55L21.41 18.36L19.63 18.95L17.17 12.92L14.97 18.95Z"/></svg>',
                'map': '<svg viewBox="0 0 24 24" fill="currentColor"><path d="M20.5 3l-.16.03L15 5.1 9 3 3.36 4.9c-.21.07-.36.25-.36.48V20.5c0 .28.22.5.5.5l.16-.03L9 18.9l6 2.1 5.64-1.9c.21-.07.36-.25.36-.48V3.5c0-.28-.22-.5-.5-.5zM15 19l-6-2.11V5l6 2.11V19z"/></svg>',
                'music': '<svg viewBox="0 0 24 24" fill="currentColor"><path d="M12 3v10.55c-.59-.34-1.27-.55-2-.55-2.21 0-4 1.79-4 4s1.79 4 4 4 4-1.79 4-4V7h4V3h-6z"/></svg>',
                'video': '<svg viewBox="0 0 24 24" fill="currentColor"><path d="M18 4l2 4h-3l-2-4h-2l2 4h-3l-2-4H8l2 4H7L5 4H4c-1.1 0-1.99.9-1.99 2L2 18c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V4h-4z"/></svg>',
                'document': '<svg viewBox="0 0 24 24" fill="currentColor"><path d="M14 2H6c-1.1 0-1.99.9-1.99 2L4 20c0 1.1.89 2 1.99 2H18c1.1 0 2-.9 2-2V8l-6-6zm2 16H8v-2h8v2zm0-4H8v-2h8v2zm-3-5V3.5L18.5 9H13z"/></svg>',
                'image': '<svg viewBox="0 0 24 24" fill="currentColor"><path d="M21 19V5c0-1.1-.9-2-2-2H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2zM8.5 13.5l2.5 3.01L14.5 12l4.5 6H5l3.5-4.5z"/></svg>',
                'dice': '<svg viewBox="0 0 24 24" fill="currentColor"><path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zM7.5 18c-.83 0-1.5-.67-1.5-1.5S6.67 15 7.5 15s1.5.67 1.5 1.5S8.33 18 7.5 18zm0-9C6.67 9 6 8.33 6 7.5S6.67 6 7.5 6 9 6.67 9 7.5 8.33 9 7.5 9zm4.5 4.5c-.83 0-1.5-.67-1.5-1.5s.67-1.5 1.5-1.5 1.5.67 1.5 1.5-.67 1.5-1.5 1.5zm4.5 4.5c-.83 0-1.5-.67-1.5-1.5s.67-1.5 1.5-1.5 1.5.67 1.5 1.5-.67 1.5-1.5 1.5zm0-9c-.83 0-1.5-.67-1.5-1.5S15.67 6 16.5 6s1.5.67 1.5 1.5S17.33 9 16.5 9z"/></svg>',
                'shop': '<svg viewBox="0 0 24 24" fill="currentColor"><path d="M7 18c-1.1 0-1.99.9-1.99 2S5.9 22 7 22s2-.9 2-2-.9-2-2-2zM1 2v2h2l3.6 7.59-1.35 2.45c-.16.28-.25.61-.25.96 0 1.1.9 2 2 2h12v-2H7.42c-.14 0-.25-.11-.25-.25l.03-.12.9-1.63h7.45c.75 0 1.41-.41 1.75-1.03l3.58-6.49c.08-.14.12-.31.12-.48 0-.55-.45-1-1-1H5.21l-.94-2H1zm16 16c-1.1 0-1.99.9-1.99 2s.89 2 1.99 2 2-.9 2-2-.9-2-2-2z"/></svg>',
                'star': '<svg viewBox="0 0 24 24" fill="currentColor"><path d="M12 17.27L18.18 21l-1.64-7.03L22 9.24l-7.19-.61L12 2 9.19 8.63 2 9.24l5.46 4.73L5.82 21z"/></svg>',
                'heart': '<svg viewBox="0 0 24 24" fill="currentColor"><path d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z"/></svg>',
                'discord': '<svg viewBox="0 0 24 24" fill="currentColor"><path d="M20.317 4.37a19.791 19.791 0 0 0-4.885-1.515.074.074 0 0 0-.079.037c-.21.375-.444.864-.608 1.25a18.27 18.27 0 0 0-5.487 0 12.64 12.64 0 0 0-.617-1.25.077.077 0 0 0-.079-.037A19.736 19.736 0 0 0 3.677 4.37a.07.07 0 0 0-.032.027C.533 9.046-.32 13.58.099 18.057a.082.082 0 0 0 .031.057 19.9 19.9 0 0 0 5.993 3.03.078.078 0 0 0 .084-.028c.462-.63.874-1.295 1.226-1.994a.076.076 0 0 0-.041-.106 13.107 13.107 0 0 1-1.872-.892.077.077 0 0 1-.008-.128c.126-.094.252-.192.373-.292a.074.074 0 0 1 .077-.01c3.928 1.793 8.18 1.793 12.062 0a.074.074 0 0 1 .078.01c.12.098.246.198.373.292a.077.077 0 0 1-.006.127 12.299 12.299 0 0 1-1.873.892.077.077 0 0 0-.041.107c.36.698.772 1.362 1.225 1.993a.076.076 0 0 0 .084.028 19.839 19.839 0 0 0 6.002-3.03.077.077 0 0 0 .032-.054c.5-5.177-.838-9.674-3.549-13.66a.061.061 0 0 0-.031-.03zM8.02 15.33c-1.183 0-2.157-1.085-2.157-2.419 0-1.333.956-2.419 2.157-2.419 1.21 0 2.176 1.096 2.157 2.42 0 1.333-.956 2.418-2.157 2.418zm7.975 0c-1.183 0-2.157-1.085-2.157-2.419 0-1.333.955-2.419 2.157-2.419 1.21 0 2.176 1.096 2.157 2.42 0 1.333-.946 2.418-2.157 2.418z"/></svg>'
            };
            return icons[iconName] || icons['link'];
        }
        
        function exportToCalendar() {
            if (!sessionData.date) return;
            
            const title = sessionData.name || 'RIFT Session';
            const dateStr = sessionData.date;
            const timeStr = sessionData.time || '20:00';
            const duration = sessionData.duration || 3;
            
            // Parse date and time
            const [year, month, day] = dateStr.split('-');
            const [hours, minutes] = timeStr.split(':');
            
            // Create start date
            const startDate = new Date(year, month - 1, day, hours, minutes);
            const endDate = new Date(startDate.getTime() + duration * 60 * 60 * 1000);
            
            // Format for iCal
            const formatDate = (d) => {
                return d.toISOString().replace(/[-:]/g, '').replace(/\.\d{3}/, '');
            };
            
            const description = sessionData.description ? sessionData.description.replace(/\n/g, '\\n') : '';
            const location = sessionData.voiceLink || '';
            
            const icsContent = [
                'BEGIN:VCALENDAR',
                'VERSION:2.0',
                'PRODID:-//RIFT//Session//DE',
                'BEGIN:VEVENT',
                `DTSTART:${formatDate(startDate)}`,
                `DTEND:${formatDate(endDate)}`,
                `SUMMARY:${title}`,
                `DESCRIPTION:${description}`,
                `LOCATION:${location}`,
                'END:VEVENT',
                'END:VCALENDAR'
            ].join('\r\n');
            
            // Download
            const blob = new Blob([icsContent], { type: 'text/calendar;charset=utf-8' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `${title.replace(/[^a-z0-9]/gi, '_')}.ics`;
            link.click();
            
            if (window.RIFT?.ui?.Toast) {
                RIFT.ui.Toast.success('Kalender-Event heruntergeladen!');
            }
        }
        
        function openAddLinkModal() {
            const modal = document.getElementById('addLinkModal');
            modal.classList.add('settings-modal--open');
            document.body.style.overflow = 'hidden';
            
            // Reset form
            document.getElementById('addLinkTitle').value = '';
            document.getElementById('addLinkUrl').value = '';
            
            // Reset icon selection
            document.querySelectorAll('.icon-select-btn').forEach(btn => btn.classList.remove('icon-select-btn--active'));
            document.querySelector('.icon-select-btn[data-icon="link"]')?.classList.add('icon-select-btn--active');
        }
        
        function closeAddLinkModal() {
            document.getElementById('addLinkModal').classList.remove('settings-modal--open');
            document.body.style.overflow = '';
        }
        
        function saveCustomLink() {
            const title = document.getElementById('addLinkTitle').value.trim();
            const url = document.getElementById('addLinkUrl').value.trim();
            const icon = document.querySelector('.icon-select-btn--active')?.dataset.icon || 'link';
            
            if (!title || !url) {
                RIFT.ui.Toast?.error('Bitte Titel und URL eingeben');
                return;
            }
            
            // Validate URL
            if (!url.startsWith('http://') && !url.startsWith('https://')) {
                RIFT.ui.Toast?.error('URL muss mit http:// oder https:// beginnen');
                return;
            }
            
            // Add to session data
            if (!sessionData.customLinks) sessionData.customLinks = [];
            sessionData.customLinks.push({ title, url, icon });
            
            saveSession();
            closeAddLinkModal();
            renderSessionPage();
            
            RIFT.ui.Toast?.success('Link hinzugefügt!');
        }
        
        function removeCustomLink(index) {
            if (!sessionData.customLinks) return;
            sessionData.customLinks.splice(index, 1);
            saveSession();
            renderSessionPage();
            RIFT.ui.Toast?.success('Link entfernt!');
        }
        
        function selectLinkIcon(btn) {
            document.querySelectorAll('.icon-select-btn').forEach(b => b.classList.remove('icon-select-btn--active'));
            btn.classList.add('icon-select-btn--active');
        }
        
        function getRecurrenceLabel(recurrence) {
            const labels = {
                'once': 'Einmalig',
                'weekly': 'Wöchentlich',
                'biweekly': 'Alle 2 Wochen',
                'monthly': 'Monatlich',
                'flexible': 'Flexibel',
                'spontan': 'Spontan / Flexibel'
            };
            return labels[recurrence] || recurrence;
        }
        
        function getTagLabel(tag) {
            const labels = {
                'roleplay': '🎭 Roleplay',
                'combat': '⚔️ Combat',
                'exploration': '🗺️ Exploration',
                'puzzle': '🧩 Rätsel',
                'horror': '👻 Horror',
                'comedy': '😄 Comedy',
                'newbie': '🌱 Anfänger',
                'oneshot': '⚡ One-Shot',
                'campaign': '📚 Kampagne',
                'sandbox': '🏜️ Sandbox',
                'mystery': '🔍 Mystery',
                'social': '💬 Social',
                'stealth': '🥷 Stealth',
                'dungeon': '🏰 Dungeon',
                'boss': '💀 Bosskampf',
                'homebrew': '🧪 Homebrew',
                'pvp': '⚔️ PvP',
                'mature': '🔞 18+'
            };
            return labels[tag] || tag;
        }
        
        function getCharacterSheetLink(ruleset) {
            // Prüfe ob der User einen Charakter für dieses Ruleset hat
            const characters = getCharactersForRuleset(ruleset);
            if (characters.length > 0) {
                // Nimm den ersten/einzigen Charakter oder den zuletzt bearbeiteten
                const sortedChars = characters.sort((a, b) => (b.lastModified || 0) - (a.lastModified || 0));
                const char = sortedChars[0];
                
                // Bestimme die richtige Sheet-Seite basierend auf dem Ruleset
                const sheetPages = {
                    '5e2024': 'sheet-5e2024.html',
                    'worldsapart': 'sheet-worldsapart.html',
                    'htbah': 'sheet-htbah.html',
                    'cyberpunk': 'sheet-cyberpunk.html'
                };
                const sheetPage = sheetPages[ruleset] || 'sheet.html';
                return `${sheetPage}?id=${char.id}`;
            }
            // Kein Charakter → zur Übersicht
            return 'sheet.html';
        }
        
        // ========================================
        // DESCRIPTION TOGGLE
        // ========================================
        
        function toggleDescription() {
            const section = document.getElementById('descriptionSection');
            if (section) {
                section.classList.toggle('expanded');
                
                // Save preference
                const isExpanded = section.classList.contains('expanded');
                localStorage.setItem('rift_desc_expanded', isExpanded ? '1' : '0');
            }
        }
        
        // Auto-expand description on page load if previously expanded
        function initDescriptionState() {
            const section = document.getElementById('descriptionSection');
            const wasExpanded = localStorage.getItem('rift_desc_expanded');
            
            // Default: expanded on first visit
            if (wasExpanded === null || wasExpanded === '1') {
                section?.classList.add('expanded');
            }
        }
        
        function copyInviteLink() {
            const inviteUrl = `${window.location.origin}/login.html?room=${currentRoomCode || ''}`;
            
            if (navigator.clipboard && navigator.clipboard.writeText) {
                navigator.clipboard.writeText(inviteUrl).then(() => {
                    if (window.RIFT?.ui?.Toast) {
                        RIFT.ui.Toast.success('Link kopiert!');
                    }
                }).catch(err => {
                    console.error('Copy failed:', err);
                    fallbackCopy(inviteUrl);
                });
            } else {
                fallbackCopy(inviteUrl);
            }
        }
        
        function fallbackCopy(text) {
            const textarea = document.createElement('textarea');
            textarea.value = text;
            textarea.style.position = 'fixed';
            textarea.style.opacity = '0';
            document.body.appendChild(textarea);
            textarea.select();
            document.execCommand('copy');
            document.body.removeChild(textarea);
            if (window.RIFT?.ui?.Toast) {
                RIFT.ui.Toast.success('Link kopiert!');
            }
        }
        
        function getCharactersForRuleset(ruleset) {
            try {
                const stored = localStorage.getItem('rift_characters');
                if (!stored) return [];
                
                const allCharacters = JSON.parse(stored);
                let characterArray;
                if (Array.isArray(allCharacters)) {
                    characterArray = allCharacters;
                } else if (typeof allCharacters === 'object' && allCharacters !== null) {
                    characterArray = Object.values(allCharacters);
                } else {
                    return [];
                }
                
                return characterArray.filter(c => c.ruleset === ruleset && c.name);
            } catch (e) {
                console.warn('[Session] Failed to load characters:', e);
                return [];
            }
        }

        // ========================================
        // SESSION CONTROL FUNCTIONS
        // ========================================
        
        function startSession() {
            if (!sessionData) return;
            sessionData.status = 'live';
            sessionData.startTime = Date.now();
            sessionData.totalPausedMs = 0;
            
            localStorage.setItem('rift_active_session', JSON.stringify({
                id: sessionData.id,
                name: sessionData.name,
                startTime: sessionData.startTime,
                status: 'live',
                totalPausedMs: 0
            }));
            
            saveSession();
            renderSessionPage();
            startTimer();
            
            if (window.RIFT?.ui?.Toast) {
                RIFT.ui.Toast.success('Session gestartet!');
            }
        }
        
        function pauseSession() {
            if (!sessionData) return;
            sessionData.status = 'paused';
            sessionData.pausedTime = Date.now();
            stopTimer();
            
            // Update localStorage for topbar
            const activeSession = JSON.parse(localStorage.getItem('rift_active_session') || '{}');
            activeSession.status = 'paused';
            activeSession.pausedTime = sessionData.pausedTime;
            activeSession.totalPausedMs = sessionData.totalPausedMs || 0;
            localStorage.setItem('rift_active_session', JSON.stringify(activeSession));
            
            saveSession();
            renderSessionPage();
            
            if (window.RIFT?.ui?.Toast) {
                RIFT.ui.Toast.info('Session pausiert');
            }
        }
        
        function resumeSession() {
            if (!sessionData) return;
            if (sessionData.pausedTime) {
                const pausedDuration = Date.now() - sessionData.pausedTime;
                sessionData.totalPausedMs = (sessionData.totalPausedMs || 0) + pausedDuration;
            }
            
            sessionData.status = 'live';
            sessionData.pausedTime = null;
            
            // Update localStorage for topbar
            const activeSession = JSON.parse(localStorage.getItem('rift_active_session') || '{}');
            activeSession.status = 'live';
            activeSession.pausedTime = null;
            activeSession.totalPausedMs = sessionData.totalPausedMs;
            localStorage.setItem('rift_active_session', JSON.stringify(activeSession));
            
            saveSession();
            renderSessionPage();
            startTimer();
            
            if (window.RIFT?.ui?.Toast) {
                RIFT.ui.Toast.success('Session fortgesetzt!');
            }
        }
        
        function endSession() {
            if (!sessionData) return;
            if (!confirm('Session wirklich beenden?')) return;
            
            const endTime = Date.now();
            let totalDuration = endTime - sessionData.startTime;
            if (sessionData.pausedTime) {
                totalDuration -= (endTime - sessionData.pausedTime);
            }
            totalDuration -= (sessionData.totalPausedMs || 0);
            
            sessionData.status = 'ended';
            sessionData.endTime = endTime;
            sessionData.duration = Math.round(totalDuration / 1000 / 60);
            stopTimer();
            
            localStorage.removeItem('rift_active_session');
            
            saveSession();
            renderSessionPage();
            
            if (window.RIFT?.ui?.Toast) {
                RIFT.ui.Toast.success(`Session beendet! Dauer: ${Math.floor(sessionData.duration / 60)}h ${sessionData.duration % 60}min`);
            }
        }
        
        function reopenSession() {
            if (!sessionData) return;
            sessionData.status = 'live';
            sessionData.endTime = null;
            
            if (!sessionData.startTime) {
                sessionData.startTime = Date.now();
                sessionData.totalPausedMs = 0;
            }
            
            localStorage.setItem('rift_active_session', JSON.stringify({
                id: sessionData.id,
                name: sessionData.name,
                startTime: sessionData.startTime,
                status: 'live',
                totalPausedMs: sessionData.totalPausedMs || 0
            }));
            
            saveSession();
            renderSessionPage();
            startTimer();
            
            if (window.RIFT?.ui?.Toast) {
                RIFT.ui.Toast.success('Session wiederaufgenommen!');
            }
        }

        // ========================================
        // TIMER FUNCTIONS
        // ========================================
        
        function startTimer() {
            if (timerInterval) clearInterval(timerInterval);
            
            const updateTimer = () => {
                const timerEl = document.getElementById('liveTimer');
                if (!timerEl || !sessionData?.startTime) return;
                
                let elapsed = Date.now() - sessionData.startTime;
                elapsed -= (sessionData.totalPausedMs || 0);
                if (sessionData.pausedTime) {
                    elapsed -= (Date.now() - sessionData.pausedTime);
                }
                
                const hours = Math.floor(elapsed / 3600000);
                const minutes = Math.floor((elapsed % 3600000) / 60000);
                const seconds = Math.floor((elapsed % 60000) / 1000);
                
                timerEl.textContent = `${hours}:${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
            };
            
            updateTimer();
            timerInterval = setInterval(updateTimer, 1000);
        }
        
        function stopTimer() {
            if (timerInterval) {
                clearInterval(timerInterval);
                timerInterval = null;
            }
        }
        
        function updateCountdown() {
            if (!sessionData?.date || sessionData.status !== 'planned') return;
            
            const sessionDateTime = new Date(`${sessionData.date}T${sessionData.time || '20:00'}`);
            const now = new Date();
            const diff = sessionDateTime - now;
            
            if (diff <= 0) {
                const countdown = document.getElementById('sessionCountdown');
                if (countdown) countdown.style.display = 'none';
                return;
            }
            
            const days = Math.floor(diff / 86400000);
            const hours = Math.floor((diff % 86400000) / 3600000);
            const mins = Math.floor((diff % 3600000) / 60000);
            
            const daysEl = document.getElementById('countdownDays');
            const hoursEl = document.getElementById('countdownHours');
            const minsEl = document.getElementById('countdownMins');
            
            if (daysEl) daysEl.textContent = days;
            if (hoursEl) hoursEl.textContent = hours;
            if (minsEl) minsEl.textContent = mins;
            
            // Update every minute
            setTimeout(updateCountdown, 60000);
        }

        // ========================================
        // COVER IMAGE
        // ========================================
        
        function loadCoverImage() {
            // Priorität: 1. sessionData.coverUrl (Firebase Storage), 2. Legacy IndexedDB
            if (sessionData.coverUrl) {
                // Cover URL ist in Firebase Storage
                const coverEl = document.getElementById('sessionCover');
                if (coverEl) {
                    coverEl.innerHTML = `<img src="${sessionData.coverUrl}" alt="Session Cover">` + 
                        (isGM ? '<button class="session-hero__cover-edit" onclick="event.stopPropagation(); openSettingsModal();"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></svg>Ändern</button>' : '');
                }
                
                // Also update settings preview
                const previewEl = document.getElementById('settingsCoverPreview');
                if (previewEl) {
                    previewEl.innerHTML = `<img src="${sessionData.coverUrl}" alt="">`;
                }
            } else if (sessionData.hasCover) {
                // Legacy: Try IndexedDB (nur für GM der das Cover ursprünglich hochgeladen hat)
                CoverDB.get(sessionId).then(coverImage => {
                    if (coverImage) {
                        const coverEl = document.getElementById('sessionCover');
                        if (coverEl) {
                            coverEl.innerHTML = `<img src="${coverImage}" alt="Session Cover">` + 
                                (isGM ? '<button class="session-hero__cover-edit" onclick="event.stopPropagation(); openSettingsModal();"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></svg>Ändern</button>' : '');
                        }
                        
                        // Also update settings preview
                        const previewEl = document.getElementById('settingsCoverPreview');
                        if (previewEl) {
                            previewEl.innerHTML = `<img src="${coverImage}" alt="">`;
                        }
                        
                        // Migration: Upload to Firebase Storage if GM
                        if (isGM && !sessionData.coverUrl) {
                            console.log('[Session] Migrating cover to Firebase Storage...');
                            CoverStorage.upload(sessionId, coverImage).then(url => {
                                if (url) {
                                    sessionData.coverUrl = url;
                                    saveSession();
                                    // Delete from IndexedDB after migration
                                    CoverDB.delete(sessionId);
                                    console.log('[Session] Cover migrated successfully');
                                }
                            });
                        }
                    }
                }).catch(err => {
                    console.warn('[Session] Failed to load cover from IndexedDB:', err);
                });
            }
        }

        // ========================================
        // CHARACTER SELECT MODAL (for Players)
        // ========================================
        
        function openCharacterSelectModal() {
            if (isGM) return; // GM doesn't need this
            
            const modal = document.getElementById('charSelectModal');
            modal.classList.add('settings-modal--open');
            document.body.style.overflow = 'hidden';
            
            // Get characters for this ruleset from localStorage
            let characters = getCharactersForRuleset(sessionData?.ruleset);
            const list = document.getElementById('charSelectList');
            const empty = document.getElementById('charSelectEmpty');
            
            // Get current user's assigned character
            const currentUserId = firebase?.auth()?.currentUser?.uid;
            const assignedChar = (sessionData?.partyCharacters || []).find(c => c.ownerId === currentUserId);
            const assignedCharId = assignedChar?.id;
            
            // Also try to get Room Characters for this user (Multi-Char Support)
            // This is async, so we render first then update
            if (currentRoomCode && typeof RIFT !== 'undefined' && RIFT.rooms?.getPlayerCharacters) {
                RIFT.rooms.getPlayerCharacters(currentRoomCode, currentUserId).then(roomChars => {
                    if (roomChars && roomChars.length > 0) {
                        // Filter for matching ruleset
                        const matchingRoomChars = roomChars.filter(c => c.ruleset === sessionData?.ruleset);
                        
                        // Merge with localStorage chars (avoid duplicates by ID)
                        const existingIds = new Set(characters.map(c => c.id));
                        matchingRoomChars.forEach(rc => {
                            if (!existingIds.has(rc.id)) {
                                characters.push({
                                    id: rc.id,
                                    name: rc.name || 'Unbenannt',
                                    class: rc.class || rc.data?.role || '',
                                    level: rc.level || rc.data?.level || 1,
                                    portrait: rc.portrait || rc.data?.portrait || null,
                                    avatar: rc.portrait || rc.data?.portrait || null,
                                    color: '#8B5CF6',
                                    ruleset: rc.ruleset,
                                    data: rc.data,
                                    fromRoom: true // Mark as from room
                                });
                            }
                        });
                        
                        // Re-render if we found more characters
                        if (matchingRoomChars.length > 0) {
                            renderCharacterSelectList(characters, assignedCharId);
                        }
                    }
                }).catch(e => {
                    console.warn('[Session] Could not load Room characters:', e);
                });
            }
            
            // Initial render with localStorage characters
            renderCharacterSelectList(characters, assignedCharId);
        }
        
        function renderCharacterSelectList(characters, assignedCharId) {
            const list = document.getElementById('charSelectList');
            const empty = document.getElementById('charSelectEmpty');
            
            // Get main character for this ruleset
            const mainCharId = typeof CharacterStorage !== 'undefined' 
                ? CharacterStorage.getMainCharacters()[sessionData?.ruleset]
                : null;
            
            if (characters.length === 0) {
                list.style.display = 'none';
                empty.style.display = 'block';
            } else {
                list.style.display = 'flex';
                empty.style.display = 'none';
                
                // Sort: main character first, then assigned, then others
                const sortedChars = [...characters].sort((a, b) => {
                    if (a.id === mainCharId) return -1;
                    if (b.id === mainCharId) return 1;
                    if (a.id === assignedCharId) return -1;
                    if (b.id === assignedCharId) return 1;
                    return 0;
                });
                
                list.innerHTML = sortedChars.map(char => {
                    const isAssigned = char.id === assignedCharId;
                    const isMain = char.id === mainCharId;
                    return `
                    <div class="char-select-item ${isAssigned ? 'char-select-item--assigned' : ''} ${isMain ? 'char-select-item--main' : ''}" onclick="selectCharacterForSession('${char.id}')">
                        <div class="char-select-item__avatar" style="background-color: ${char.color || '#FF4655'}20; border-color: ${char.color || '#FF4655'}; color: ${char.color || '#FF4655'};">
                            ${char.avatar ? `<img src="${char.avatar}" alt="">` : char.name?.charAt(0).toUpperCase()}
                        </div>
                        <div class="char-select-item__info">
                            <strong>${isMain ? '★ ' : ''}${char.name || 'Unbenannt'}</strong>
                            <span>${char.class || char.profession || char.data?.role || 'Charakter'} ${char.level ? `• Level ${char.level}` : ''}</span>
                            ${isMain && !isAssigned ? '<span class="char-select-item__badge char-select-item__badge--main">★ Hauptcharakter</span>' : ''}
                            ${isAssigned ? '<span class="char-select-item__badge">✓ Aktuell zugewiesen</span>' : ''}
                        </div>
                        <svg class="char-select-item__arrow" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <polyline points="9 18 15 12 9 6"/>
                        </svg>
                    </div>
                `;
                }).join('');
            }
        }
        
        function closeCharacterSelectModal() {
            const modal = document.getElementById('charSelectModal');
            modal.classList.remove('settings-modal--open');
            document.body.style.overflow = '';
        }
        
        async function selectCharacterForSession(charId) {
            if (!sessionData || !charId) return;
            
            // Get character data from localStorage
            const characters = getCharactersForRuleset(sessionData.ruleset);
            const selectedChar = characters.find(c => c.id === charId);
            
            if (!selectedChar) {
                RIFT?.ui?.Toast?.error('Charakter nicht gefunden');
                return;
            }
            
            // Get current user info
            const currentUser = firebase?.auth()?.currentUser;
            const userId = currentUser?.uid;
            const userName = currentUser?.displayName || currentUser?.email?.split('@')[0] || 'Spieler';
            
            if (!userId) {
                RIFT?.ui?.Toast?.error('Nicht angemeldet');
                return;
            }
            
            // Build party character entry
            const partyChar = {
                id: charId,
                name: selectedChar.name || 'Unbenannt',
                class: selectedChar.class || selectedChar.profession || selectedChar.data?.role || 'Abenteurer',
                level: selectedChar.level || 1,
                portrait: selectedChar.portrait || selectedChar.avatar || null,
                color: selectedChar.color || '#8B5CF6',
                hp: selectedChar.data?.status?.health || selectedChar.data?.health?.current || 100,
                maxHp: selectedChar.data?.status?.maxHealth || selectedChar.data?.health?.max || 100,
                playerId: userId,
                playerName: userName,
                ownerId: userId,
                assignedAt: Date.now()
            };
            
            // Remove any existing character from this user (replace mode)
            // or allow multiple (uncomment the filter to enable replace mode)
            sessionData.partyCharacters = (sessionData.partyCharacters || [])
                .filter(c => c.ownerId !== userId); // Replace existing char from same user
            
            // Add new character
            sessionData.partyCharacters.push(partyChar);
            
            // Track active character for this user in this session
            const activeChars = JSON.parse(localStorage.getItem('rift_active_chars') || '{}');
            activeChars[sessionData.id] = charId;
            localStorage.setItem('rift_active_chars', JSON.stringify(activeChars));
            
            // Save to Firebase
            await saveSession();
            
            // Also sync to Room system for Multi-Character Support
            if (currentRoomCode && typeof RIFT !== 'undefined' && RIFT.rooms) {
                try {
                    // 1. Sync character to room (if not already there)
                    if (typeof CharacterStorage !== 'undefined') {
                        await CharacterStorage.syncToRoom(selectedChar);
                    }
                    
                    // 2. Set as active character for this user in the room
                    await RIFT.rooms.assignCharacterToMember(currentRoomCode, userId, charId);
                    console.log('[Session] Character assigned in Room Members:', charId);
                } catch (e) {
                    console.warn('[Session] Room sync failed (non-critical):', e);
                }
            }
            
            // Re-render party section
            renderSession();
            
            // Show success
            RIFT?.ui?.Toast?.success(`${selectedChar.name} zugewiesen!`);
            
            // Close modal
            closeCharacterSelectModal();
            
            console.log('[Session] Character assigned:', charId, 'for user:', userId);
        }
        
        // Character Select Modal Event Listeners
        document.getElementById('closeCharSelectModal')?.addEventListener('click', closeCharacterSelectModal);
        document.getElementById('charSelectBackdrop')?.addEventListener('click', closeCharacterSelectModal);

        // ========================================
        // GM SETTINGS MODAL
        // ========================================
        
        function openSettingsModal() {
            if (!isGM || !sessionData) return;
            
            const modal = document.getElementById('sessionSettingsModal');
            modal.classList.add('settings-modal--open');
            document.body.style.overflow = 'hidden';
            
            // Populate form fields
            document.getElementById('settingsTitle').value = sessionData.name || '';
            document.getElementById('settingsSubtitle').value = sessionData.subtitle || '';
            document.getElementById('settingsDescription').value = sessionData.description || '';
            document.getElementById('settingsVoiceLink').value = sessionData.voiceLink || '';
            document.getElementById('settingsDate').value = sessionData.date || '';
            document.getElementById('settingsTime').value = sessionData.time || '20:00';
            document.getElementById('settingsDuration').value = sessionData.duration || '3';
            document.getElementById('settingsRecurring').value = sessionData.recurring || 'once';
            document.getElementById('settingsCurrentSession').value = sessionData.currentSession || 1;
            document.getElementById('settingsSessionCount').value = sessionData.sessionCount || 1;
            document.getElementById('settingsMaxPlayers').value = sessionData.maxPlayers || 4;
            document.getElementById('settingsHpStyle').value = sessionData.visibility?.hpStyle || 'bar-numbers';
            
            // Detect voice type
            if (sessionData.voiceLink) {
                const link = sessionData.voiceLink.toLowerCase();
                if (link.includes('discord')) document.getElementById('settingsVoiceType').value = 'discord';
                else if (link.includes('teamspeak')) document.getElementById('settingsVoiceType').value = 'teamspeak';
                else if (link.includes('zoom')) document.getElementById('settingsVoiceType').value = 'zoom';
                else if (link.includes('meet.google')) document.getElementById('settingsVoiceType').value = 'googlemeet';
                else document.getElementById('settingsVoiceType').value = 'other';
            }
            
            // Visibility toggles
            const visibility = { ...defaultVisibility, ...(sessionData.visibility || {}) };
            document.querySelectorAll('.session-toggle[data-setting]').forEach(toggle => {
                const setting = toggle.dataset.setting;
                if (visibility[setting]) {
                    toggle.classList.add('session-toggle--active');
                } else {
                    toggle.classList.remove('session-toggle--active');
                }
            });
            
            // Tags
            const tags = sessionData.tags || [];
            document.querySelectorAll('.settings-tag[data-tag]').forEach(tag => {
                if (tags.includes(tag.dataset.tag)) {
                    tag.classList.add('settings-tag--active');
                } else {
                    tag.classList.remove('settings-tag--active');
                }
            });
            
            // Custom Tags
            const customTagsList = document.getElementById('customTagsList');
            customTagsList.innerHTML = '';
            const customTags = sessionData.customTags || [];
            customTags.forEach(tagText => {
                const tag = document.createElement('span');
                tag.className = 'settings-tag settings-tag--active';
                tag.dataset.customTag = tagText;
                tag.innerHTML = `🏷️ ${tagText} <button type="button" class="settings-tag__remove" onclick="this.parentElement.remove()">×</button>`;
                customTagsList.appendChild(tag);
            });
            
            // Cover preview
            if (sessionData.coverUrl) {
                // Cover ist in Firebase Storage
                document.getElementById('settingsCoverPreview').innerHTML = `<img src="${sessionData.coverUrl}" alt="">`;
            } else if (sessionData.hasCover) {
                // Legacy: versuche IndexedDB
                CoverDB.get(sessionId).then(coverImage => {
                    if (coverImage) {
                        document.getElementById('settingsCoverPreview').innerHTML = `<img src="${coverImage}" alt="">`;
                    }
                });
            }
        }
        
        function closeSessionSettingsModal() {
            const modal = document.getElementById('sessionSettingsModal');
            modal.classList.remove('settings-modal--open');
            document.body.style.overflow = '';
        }
        
        function saveSettings() {
            if (!sessionData) return;
            
            // Basic info
            sessionData.name = document.getElementById('settingsTitle').value;
            sessionData.subtitle = document.getElementById('settingsSubtitle').value;
            sessionData.description = document.getElementById('settingsDescription').value;
            sessionData.voiceLink = document.getElementById('settingsVoiceLink').value;
            sessionData.date = document.getElementById('settingsDate').value;
            sessionData.time = document.getElementById('settingsTime').value;
            sessionData.duration = parseInt(document.getElementById('settingsDuration').value) || 3;
            sessionData.recurring = document.getElementById('settingsRecurring').value;
            sessionData.currentSession = parseInt(document.getElementById('settingsCurrentSession').value) || 1;
            sessionData.sessionCount = parseInt(document.getElementById('settingsSessionCount').value) || 1;
            sessionData.maxPlayers = parseInt(document.getElementById('settingsMaxPlayers').value) || 4;
            
            // Visibility settings
            sessionData.visibility = sessionData.visibility || {};
            document.querySelectorAll('.session-toggle[data-setting]').forEach(toggle => {
                sessionData.visibility[toggle.dataset.setting] = toggle.classList.contains('session-toggle--active');
            });
            sessionData.visibility.hpStyle = document.getElementById('settingsHpStyle').value;
            
            // Tags
            sessionData.tags = [];
            document.querySelectorAll('.settings-tag--active[data-tag]').forEach(tag => {
                sessionData.tags.push(tag.dataset.tag);
            });
            
            // Custom Tags
            sessionData.customTags = [];
            document.querySelectorAll('#customTagsList .settings-tag[data-custom-tag]').forEach(tag => {
                sessionData.customTags.push(tag.dataset.customTag);
            });
            
            saveSession();
            closeSessionSettingsModal();
            renderSessionPage();
            
            if (window.RIFT?.ui?.Toast) {
                RIFT.ui.Toast.success('Einstellungen gespeichert!');
            }
        }

        // ========================================
        // COVER UPLOAD & CROPPER
        // ========================================
        
        document.getElementById('uploadCoverBtn')?.addEventListener('click', () => {
            document.getElementById('coverFileInput').click();
        });
        
        document.getElementById('coverFileInput')?.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = (event) => {
                const img = document.getElementById('coverCropperImage');
                img.src = event.target.result;
                
                document.getElementById('coverCropperModal').classList.add('settings-modal--open');
                
                // Destroy existing cropper
                if (cropper) cropper.destroy();
                
                // Initialize cropper with 2:3 aspect ratio
                setTimeout(() => {
                    cropper = new Cropper(img, {
                        aspectRatio: 2/3,
                        viewMode: 1,
                        dragMode: 'move',
                        autoCropArea: 1,
                        restore: false,
                        guides: true,
                        center: true,
                        highlight: false,
                        cropBoxMovable: true,
                        cropBoxResizable: true,
                        toggleDragModeOnDblclick: false
                    });
                }, 100);
            };
            reader.readAsDataURL(file);
        });
        
        document.getElementById('coverApplyCropBtn')?.addEventListener('click', async () => {
            if (!cropper) return;
            
            const canvas = cropper.getCroppedCanvas({
                width: 600,
                height: 900,
                imageSmoothingEnabled: true,
                imageSmoothingQuality: 'high'
            });
            
            const croppedImage = canvas.toDataURL('image/jpeg', 0.9);
            
            // Show loading
            if (window.RIFT?.ui?.Toast) {
                RIFT.ui.Toast.info('Cover wird hochgeladen...');
            }
            
            // Upload to Firebase Storage
            const coverUrl = await CoverStorage.upload(sessionId, croppedImage);
            
            if (coverUrl) {
                // Save URL to session data
                sessionData.coverUrl = coverUrl;
                sessionData.hasCover = true;
                saveSession();
                
                // Update UI
                document.getElementById('settingsCoverPreview').innerHTML = `<img src="${coverUrl}" alt="">`;
                
                // Close cropper modal
                document.getElementById('coverCropperModal').classList.remove('settings-modal--open');
                cropper.destroy();
                cropper = null;
                
                // Update main cover
                const coverEl = document.getElementById('sessionCover');
                if (coverEl) {
                    coverEl.innerHTML = `<img src="${coverUrl}" alt="Session Cover">` + 
                        '<button class="session-hero__cover-edit" onclick="event.stopPropagation(); openSettingsModal();"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></svg>Ändern</button>';
                }
                
                if (window.RIFT?.ui?.Toast) {
                    RIFT.ui.Toast.success('Cover gespeichert!');
                }
            } else {
                if (window.RIFT?.ui?.Toast) {
                    RIFT.ui.Toast.error('Cover konnte nicht hochgeladen werden');
                }
            }
        });
        
        document.getElementById('removeCoverBtn')?.addEventListener('click', async () => {
            if (!confirm('Cover wirklich entfernen?')) return;
            
            // Delete from Firebase Storage
            await CoverStorage.delete(sessionId);
            
            // Also delete from legacy IndexedDB
            await CoverDB.delete(sessionId);
            
            // Update session data
            sessionData.hasCover = false;
            sessionData.coverUrl = null;
            saveSession();
            
            document.getElementById('settingsCoverPreview').innerHTML = '<div class="settings-cover-preview__placeholder">🎭</div>';
            renderSessionPage();
            
            if (window.RIFT?.ui?.Toast) {
                RIFT.ui.Toast.success('Cover entfernt');
            }
        });

        // ========================================
        // DELETE SESSION
        // ========================================
        
        document.getElementById('deleteSessionBtn')?.addEventListener('click', () => {
            closeSessionSettingsModal();
            document.getElementById('deleteModal').classList.add('delete-modal--open');
        });
        
        document.getElementById('cancelDeleteBtn')?.addEventListener('click', () => {
            document.getElementById('deleteModal').classList.remove('delete-modal--open');
        });
        
        document.getElementById('deleteBackdrop')?.addEventListener('click', () => {
            document.getElementById('deleteModal').classList.remove('delete-modal--open');
        });
        
        document.getElementById('confirmDeleteBtn')?.addEventListener('click', async () => {
            if (!sessionData) return;
            
            // Delete from localStorage
            const sessions = JSON.parse(localStorage.getItem('rift_sessions') || '[]');
            const filtered = sessions.filter(s => s.id !== sessionData.id);
            localStorage.setItem('rift_sessions', JSON.stringify(filtered));
            
            // Delete cover from Firebase Storage
            await CoverStorage.delete(sessionId);
            
            // Also delete from legacy IndexedDB
            await CoverDB.delete(sessionId);
            
            // Remove active session if it's this one
            const activeSession = JSON.parse(localStorage.getItem('rift_active_session') || 'null');
            if (activeSession && activeSession.id === sessionData.id) {
                localStorage.removeItem('rift_active_session');
            }
            
            document.getElementById('deleteModal').classList.remove('delete-modal--open');
            
            if (window.RIFT?.ui?.Toast) {
                RIFT.ui.Toast.success('Session gelöscht!');
            }
            
            setTimeout(() => {
                window.location.href = 'sessions.html';
            }, 500);
        });

        // ========================================
        // PARTY MEMBER ACTIONS
        // ========================================
        
        function editPartyMember(charId) {
            // TODO: Implement HP editing modal
            console.log('Edit party member:', charId);
            if (window.RIFT?.ui?.Toast) {
                RIFT.ui.Toast.info('HP-Editor kommt bald!');
            }
        }
        
        function removePartyMember(charId) {
            if (!confirm('Charakter aus der Party entfernen?')) return;
            
            sessionData.partyCharacters = (sessionData.partyCharacters || []).filter(c => c.id !== charId);
            saveSession();
            renderSessionPage();
            
            if (window.RIFT?.ui?.Toast) {
                RIFT.ui.Toast.success('Charakter entfernt');
            }
        }

        // ========================================
        // MODAL EVENT LISTENERS
        // ========================================
        
        // Settings Modal
        document.getElementById('closeSessionSettingsModal')?.addEventListener('click', closeSessionSettingsModal);
        document.getElementById('sessionSettingsBackdrop')?.addEventListener('click', closeSessionSettingsModal);
        document.getElementById('cancelSessionSettingsBtn')?.addEventListener('click', closeSessionSettingsModal);
        document.getElementById('saveSessionSettingsBtn')?.addEventListener('click', saveSettings);
        
        // Cropper Modal
        document.getElementById('closeCoverCropperModal')?.addEventListener('click', () => {
            document.getElementById('coverCropperModal').classList.remove('settings-modal--open');
            if (cropper) {
                cropper.destroy();
                cropper = null;
            }
        });
        document.getElementById('coverCropperBackdrop')?.addEventListener('click', () => {
            document.getElementById('coverCropperModal').classList.remove('settings-modal--open');
            if (cropper) {
                cropper.destroy();
                cropper = null;
            }
        });
        document.getElementById('coverCancelCropBtn')?.addEventListener('click', () => {
            document.getElementById('coverCropperModal').classList.remove('settings-modal--open');
            if (cropper) {
                cropper.destroy();
                cropper = null;
            }
        });
        
        // Tabs
        document.querySelectorAll('.settings-modal__tab').forEach(tab => {
            tab.addEventListener('click', () => {
                // Remove active from all tabs
                document.querySelectorAll('.settings-modal__tab').forEach(t => t.classList.remove('settings-modal__tab--active'));
                document.querySelectorAll('.settings-tab').forEach(t => t.classList.remove('settings-tab--active'));
                
                // Activate clicked tab
                tab.classList.add('settings-modal__tab--active');
                document.getElementById(`tab-${tab.dataset.tab}`).classList.add('settings-tab--active');
            });
        });
        
        // Visibility Toggles
        document.querySelectorAll('.session-toggle').forEach(toggle => {
            toggle.addEventListener('click', () => {
                toggle.classList.toggle('session-toggle--active');
            });
        });
        
        // Tags
        document.querySelectorAll('.settings-tag').forEach(tag => {
            tag.addEventListener('click', () => {
                tag.classList.toggle('settings-tag--active');
            });
        });
        
        // Custom Tags
        document.getElementById('addCustomTagBtn')?.addEventListener('click', addCustomTag);
        document.getElementById('customTagInput')?.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                e.preventDefault();
                addCustomTag();
            }
        });
        
        function addCustomTag() {
            const input = document.getElementById('customTagInput');
            const list = document.getElementById('customTagsList');
            const tagText = input.value.trim();
            
            if (!tagText || tagText.length < 2) {
                if (window.RIFT?.ui?.Toast) {
                    RIFT.ui.Toast.error('Tag muss mindestens 2 Zeichen haben');
                }
                return;
            }
            
            if (tagText.length > 20) {
                if (window.RIFT?.ui?.Toast) {
                    RIFT.ui.Toast.error('Tag darf maximal 20 Zeichen haben');
                }
                return;
            }
            
            // Prüfe ob Tag schon existiert
            const existingTags = list.querySelectorAll('.settings-tag');
            for (const t of existingTags) {
                if (t.dataset.customTag === tagText) {
                    if (window.RIFT?.ui?.Toast) {
                        RIFT.ui.Toast.info('Tag existiert bereits');
                    }
                    return;
                }
            }
            
            // Erstelle neuen Tag
            const tag = document.createElement('span');
            tag.className = 'settings-tag settings-tag--active';
            tag.dataset.customTag = tagText;
            tag.innerHTML = `🏷️ ${tagText} <button type="button" class="settings-tag__remove" onclick="this.parentElement.remove()">×</button>`;
            list.appendChild(tag);
            
            input.value = '';
        }

        // ========================================
        // LOAD SESSION
        // ========================================
        
        async function loadSession() {
            // Finde main__content und erstelle/leere sessionContent
            const mainContent = document.querySelector('.main__content');
            if (!mainContent) {
                console.error('[Session] main__content not found');
                return;
            }
            
            // Erstelle oder finde sessionContent Container
            let content = document.getElementById('sessionContent');
            if (!content) {
                content = document.createElement('div');
                content.id = 'sessionContent';
                mainContent.appendChild(content);
            }
            
            // Zeige Loading State
            content.innerHTML = `
                <div class="session-loading" id="sessionLoading">
                    <div class="session-loading__spinner"></div>
                    <span style="color: var(--text-muted);">Session wird geladen...</span>
                </div>
            `;
            
            if (!sessionId) {
                showSessionNotFound();
                return;
            }
            
            // Check if user is GM
            const userData = JSON.parse(localStorage.getItem('rift_user') || '{}');
            isGM = userData.isGM === true;
            
            // Also check room membership
            if (currentRoomCode && typeof RIFT !== 'undefined' && RIFT.rooms) {
                try {
                    const membership = await RIFT.rooms.getCurrentMembership(currentRoomCode);
                    if (membership) {
                        isGM = membership.isGM === true;
                    }
                } catch (e) {
                    console.warn('[Session] Could not check room membership:', e);
                }
            }
            
            // Try Firebase first
            if (currentRoomCode && typeof RIFT !== 'undefined' && RIFT.rooms) {
                try {
                    console.log('[Session] Loading from Firebase:', sessionId);
                    sessionData = await RIFT.rooms.getSession(currentRoomCode, sessionId);
                    
                    if (sessionData) {
                        console.log('[Session] Loaded from Firebase:', sessionData.name);
                        renderSessionPage();
                        subscribeToSession();
                        return;
                    }
                } catch (err) {
                    console.warn('[Session] Firebase load failed:', err);
                }
            }
            
            // Fallback to localStorage
            console.log('[Session] Falling back to localStorage');
            const sessions = JSON.parse(localStorage.getItem('rift_sessions') || '[]');
            sessionData = sessions.find(s => s.id === sessionId);
            
            if (!sessionData) {
                showSessionNotFound();
                return;
            }
            
            renderSessionPage();
        }
        
        function subscribeToSession() {
            if (!currentRoomCode || !RIFT?.rooms) return;
            
            const db = RIFT.firebase.getFirestore();
            if (!db) return;
            
            const normalizedCode = currentRoomCode.replace('-', '').toUpperCase();
            
            sessionUnsubscribe = db.collection('rooms').doc(normalizedCode)
                .collection('sessions').doc(sessionId)
                .onSnapshot(doc => {
                    if (doc.exists) {
                        const newData = { id: doc.id, ...doc.data() };
                        console.log('[Session] Realtime update:', newData.status);
                        
                        const statusChanged = sessionData?.status !== newData.status;
                        sessionData = newData;
                        
                        renderSessionPage();
                    }
                }, err => {
                    console.error('[Session] Subscription error:', err);
                });
        }
        
        function showSessionNotFound() {
            const mainContent = document.querySelector('.main__content');
            if (!mainContent) return;
            
            let content = document.getElementById('sessionContent');
            if (!content) {
                content = document.createElement('div');
                content.id = 'sessionContent';
                mainContent.appendChild(content);
            }
            
            content.innerHTML = `
                <div class="session-not-found">
                    <svg class="session-not-found__icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                        <circle cx="12" cy="12" r="10"/>
                        <line x1="12" y1="8" x2="12" y2="12"/>
                        <line x1="12" y1="16" x2="12.01" y2="16"/>
                    </svg>
                    <h2 class="session-not-found__title">Session nicht gefunden</h2>
                    <p class="session-not-found__text">Diese Session existiert nicht oder wurde gelöscht.</p>
                    <a href="sessions.html" class="session-not-found__btn">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="18" height="18"><polyline points="15 18 9 12 15 6"/></svg>
                        Zurück zu Sessions
                    </a>
                </div>
            `;
        }
        
        async function saveSession() {
            if (!sessionData) return;
            
            // Always save to localStorage first
            const sessions = JSON.parse(localStorage.getItem('rift_sessions') || '[]');
            const index = sessions.findIndex(s => s.id === sessionData.id);
            if (index >= 0) {
                sessions[index] = sessionData;
            } else {
                sessions.push(sessionData);
            }
            localStorage.setItem('rift_sessions', JSON.stringify(sessions));
            console.log('[Session] Saved to localStorage, status:', sessionData.status);
            
            // Also try Firebase if available
            if (currentRoomCode && RIFT?.rooms?.updateSession) {
                try {
                    await RIFT.rooms.updateSession(currentRoomCode, sessionData.id, sessionData);
                    console.log('[Session] Also saved to Firebase');
                } catch (err) {
                    console.error('[Session] Firebase save failed:', err);
                }
            }
        }
        
        // Cleanup on page unload
        window.addEventListener('beforeunload', () => {
            if (sessionUnsubscribe) sessionUnsubscribe();
            stopTimer();
        });

        // ========================================
        // INIT
        // ========================================
        
        // Initialize Layout and load session
        document.addEventListener('DOMContentLoaded', () => {
            // Init Layout (Sidebar, Topbar, Footer)
            if (typeof initLayout === 'function') {
                initLayout();
            }
            
            // Wait for Firebase to be ready, then load session
            const waitForFirebase = () => {
                if (typeof RIFT !== 'undefined' && RIFT.firebase) {
                    console.log('[Session] Firebase ready, loading session...');
                    loadSession();
                } else {
                    console.log('[Session] Waiting for Firebase...');
                    setTimeout(waitForFirebase, 200);
                }
            };
            
            // Start waiting after a brief delay for layout to settle
            setTimeout(waitForFirebase, 300);
        });
    </script>
    <script src="assets/js/broadcast.js"></script>
</body>
</html>
