<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <meta name="description" content="RIFT - Dein digitaler Begleiter für Pen & Paper Rollenspiele">
    <meta name="theme-color" content="#161616" media="(prefers-color-scheme: dark)">
    <meta name="theme-color" content="#f5f5f5" media="(prefers-color-scheme: light)">
    <title>RIFT</title>
    
    <!-- PWA -->
    <link rel="manifest" href="manifest.json">
    <link rel="icon" href="/assets/icons/icon_rift_r.svg" type="image/svg+xml">
    <link rel="apple-touch-icon" href="assets/icons/icon-192.png">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="RIFT">
    <meta name="view-transition" content="same-origin">
    
    <!-- Styles -->
    <link rel="stylesheet" href="assets/css/core.css">
    <link rel="stylesheet" href="assets/css/ui.css">
    <link rel="stylesheet" href="assets/css/sidebar.css">
    <link rel="stylesheet" href="assets/css/topbar.css">
    <link rel="stylesheet" href="assets/css/dock.css">
    <link rel="stylesheet" href="assets/css/footer.css">
    <link rel="stylesheet" href="assets/css/hub.css">
    <link rel="stylesheet" href="assets/css/settings.css">
    <link rel="stylesheet" href="assets/css/article.css">
    <link rel="stylesheet" href="assets/css/hub-features.css">
    
    <!-- Cropper.js -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.6.1/cropper.min.css">
</head>
<body>
    <!-- ═══════════════════════════════════════════
         TOP NAVIGATION
         ═══════════════════════════════════════════ -->
    <header class="topnav">
        <div class="topnav__inner">
            <!-- Logo -->
            <a href="index.html" class="topnav__logo">
                <img src="assets/img/logo_rift.png" alt="RIFT">
            </a>
            
            <!-- Search -->
            <div class="topnav__search" id="searchContainer">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.35-4.35"/></svg>
                <input type="text" placeholder="Suchen..." id="searchInput">
                <div class="topnav__search-dropdown" id="search-dropdown"></div>
            </div>
            
            <div class="topnav__spacer"></div>
            
            <div class="topnav__right">
                <!-- Party Dropdown -->
                <div class="topnav__dropdown-trigger" id="partyTrigger">
                    <div class="topnav__party">
                        <div class="topnav__party-info">
                            <span class="topnav__party-label">Party</span>
                            <span class="topnav__party-status" id="partyOnlineCount">0 Online</span>
                        </div>
                    </div>
                    <div class="topnav__dropdown topnav__dropdown--party">
                        <div class="topnav__dropdown-header">
                            <div class="topnav__dropdown-title">Party</div>
                            <div class="topnav__dropdown-value">Keine Spieler</div>
                        </div>
                        <div class="topnav__dropdown-body">
                            <div class="topnav__dropdown-empty">Noch niemand in der Party</div>
                            <div class="topnav__dropdown-divider"></div>
                            <a href="#" class="topnav__dropdown-item" data-action="invite">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><line x1="19" y1="8" x2="19" y2="14"/><line x1="22" y1="11" x2="16" y2="11"/></svg>
                                Spieler einladen
                            </a>
                            <a href="#" class="topnav__dropdown-item" data-action="manage">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 20h9"/><path d="M16.5 3.5a2.121 2.121 0 1 1 3 3L7 19l-4 1 1-4L16.5 3.5z"/></svg>
                                Party verwalten
                            </a>
                        </div>
                    </div>
                </div>
                
                <!-- Room Code Dropdown -->
                <div class="topnav__dropdown-trigger" id="roomTrigger">
                    <div class="topnav__room topnav__room-code">
                        <svg viewBox="0 0 24 24" fill="currentColor"><path d="M7 7V3a1 1 0 0 1 1-1h13a1 1 0 0 1 1 1v13a1 1 0 0 1-1 1h-4v4a1 1 0 0 1-1 1H3a1 1 0 0 1-1-1V8a1 1 0 0 1 1-1h4zm0 2H4v10h10v-4H8a1 1 0 0 1-1-1V9zm2-4v10h10V4H9z"/></svg>
                        <code id="roomCodeDisplay">---</code>
                    </div>
                    <div class="topnav__dropdown topnav__dropdown--room">
                        <div class="topnav__dropdown-header">
                            <div class="topnav__dropdown-title">Session Raumcode</div>
                            <div class="topnav__dropdown-value">Teile diesen Code</div>
                        </div>
                        <div class="topnav__dropdown-room-code">
                            <code id="roomCodeLarge">---</code>
                            <button class="topnav__dropdown-room-copy" title="Code kopieren" onclick="HeaderController.copyRoomCode()">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"/><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"/></svg>
                            </button>
                        </div>
                        <div class="topnav__dropdown-body">
                            <a href="#" class="topnav__dropdown-item" onclick="HeaderController.shareRoomLink(); return false;">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="18" cy="5" r="3"/><circle cx="6" cy="12" r="3"/><circle cx="18" cy="19" r="3"/><line x1="8.59" y1="13.51" x2="15.42" y2="17.49"/><line x1="15.41" y1="6.51" x2="8.59" y2="10.49"/></svg>
                                Link teilen
                            </a>
                            <a href="#" class="topnav__dropdown-item" onclick="HeaderController.showQRCode(); return false;">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="7" height="7"/><rect x="14" y="3" width="7" height="7"/><rect x="3" y="14" width="7" height="7"/><path d="M14 14h7v7h-7z"/></svg>
                                QR-Code anzeigen
                            </a>
                            <div class="topnav__dropdown-divider"></div>
                            <a href="#" class="topnav__dropdown-item topnav__dropdown-item--danger" onclick="HeaderController.leaveSession(); return false;">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" y1="12" x2="9" y2="12"/></svg>
                                Session verlassen
                            </a>
                        </div>
                    </div>
                </div>
                
                <div class="topnav__divider"></div>
                
                <!-- Notifications -->
                <div class="topnav__icon-wrapper">
                    <button class="topnav__icon-btn" id="notifications-btn" title="Benachrichtigungen">
                        <!-- Tabler bell-filled -->
                        <svg viewBox="0 0 24 24" fill="currentColor"><path d="M14.235 19c.865 0 1.322 1.024 .745 1.668a3.992 3.992 0 0 1 -2.98 1.332a3.992 3.992 0 0 1 -2.98 -1.332c-.552 -.616 -.158 -1.579 .634 -1.661l.11 -.006h4.47zm-2.235 -17c4.97 0 8 3.03 8 7v3l.005 .158a2 2 0 0 0 1.3 1.77l.195 .072v2h-19v-2a2 2 0 0 0 1.275 -1.776l.025 -.224v-3c0 -3.97 3.03 -7 7 -7z"/></svg>
                        <span class="topnav__badge" id="notificationBadge" style="display: none;">0</span>
                    </button>
                </div>
                
                <!-- Settings (GM only) -->
                <button class="topnav__icon-btn" id="settings-btn" title="GM Optionen" style="display: none;">
                    <!-- Tabler shield-filled -->
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="currentColor"><path d="M11.884 2.007l.114 -.007l.118 .007l.059 .008l.061 .013l.111 .034a.993 .993 0 0 1 .217 .112l.104 .082l.255 .218a11 11 0 0 0 7.189 2.537l.342 -.01a1 1 0 0 1 1.005 .717a13 13 0 0 1 -9.208 16.25a1 1 0 0 1 -.502 0a13 13 0 0 1 -9.209 -16.25a1 1 0 0 1 1.005 -.717a11 11 0 0 0 7.531 -2.527l.263 -.225l.096 -.075a.993 .993 0 0 1 .217 -.112l.112 -.034a.97 .97 0 0 1 .119 -.021z"/></svg>
                </button>
                
                <!-- User Dropdown -->
                <div class="topnav__dropdown-trigger" id="userTrigger">
                    <div class="topnav__user">
                        <div class="topnav__user-avatar" id="userAvatar"></div>
                        <span class="topnav__user-name" id="userName">Anmelden</span>
                    </div>
                    <div class="topnav__dropdown topnav__dropdown--user">
                        <div class="topnav__dropdown-user-header">
                            <div class="topnav__dropdown-user-avatar" id="userAvatarLarge"></div>
                            <div class="topnav__dropdown-user-info">
                                <div class="topnav__dropdown-user-name" id="userNameLarge">Gast</div>
                                <div class="topnav__dropdown-user-email" id="userEmail">Nicht angemeldet</div>
                            </div>
                        </div>
                        <div class="topnav__dropdown-body">
                            <a href="user-settings.html" class="topnav__dropdown-item">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>
                                Mein Profil
                            </a>
                            <a href="sheet.html" class="topnav__dropdown-item">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M22 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>
                                Meine Charaktere
                            </a>
                            <a href="user-settings.html" class="topnav__dropdown-item">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"/></svg>
                                Einstellungen
                            </a>
                            <div class="topnav__dropdown-divider"></div>
                            <a href="https://ko-fi.com/riftapp" target="_blank" class="topnav__dropdown-item">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 2l2.4 7.4H22l-6 4.6 2.3 7-6.3-4.6L5.7 21l2.3-7-6-4.6h7.6z"/></svg>
                                RIFT unterstützen
                            </a>
                            <a href="#" class="topnav__dropdown-item topnav__dropdown-item--danger" id="logoutBtn">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" y1="12" x2="9" y2="12"/></svg>
                                Abmelden
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </header>
    
    <!-- ═══════════════════════════════════════════
         MEGA NAVIGATION
         ═══════════════════════════════════════════ -->
    <nav class="meganav">
        <div class="meganav__inner">
            <!-- Hub -->
            <a href="index.html" class="meganav__item meganav__item--link active">
                <svg viewBox="0 0 24 24" fill="currentColor" width="18" height="18"><path d="M12.707 2.293l9 9c.63 .63 .184 1.707 -.707 1.707h-1v6a3 3 0 0 1 -3 3h-1v-7a3 3 0 0 0 -2.824 -2.995l-.176 -.005h-2a3 3 0 0 0 -3 3v7h-1a3 3 0 0 1 -3 -3v-6h-1c-.89 0 -1.337 -1.077 -.707 -1.707l9 -9a1 1 0 0 1 1.414 0m.293 11.707a1 1 0 0 1 1 1v7h-4v-7a1 1 0 0 1 .883 -.993l.117 -.007z"/></svg>
                Hub
            </a>
            
            <!-- Abenteuer -->
            <div class="meganav__item">
                Abenteuer
                <svg class="chevron" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="6 9 12 15 18 9"/></svg>
                
                <div class="meganav__dropdown">
                    <div class="meganav__dropdown-grid">
                        <a href="sessions.html" class="meganav__dropdown-card">
                            <div class="meganav__dropdown-card-icon">
                                <svg viewBox="0 0 24 24" fill="currentColor"><path d="M14 2a5 5 0 0 1 5 5v14a1 1 0 0 1 -1.555 .832l-5.445 -3.63l-5.444 3.63a1 1 0 0 1 -1.55 -.72l-.006 -.112v-14a5 5 0 0 1 5 -5h4z"/></svg>
                            </div>
                            <div class="meganav__dropdown-card-content">
                                <div class="meganav__dropdown-card-title">Meine Sessions</div>
                                <div class="meganav__dropdown-card-desc">Alle deine Abenteuer</div>
                            </div>
                        </a>
                        <a href="session.html" class="meganav__dropdown-card">
                            <div class="meganav__dropdown-card-icon">
                                <svg viewBox="0 0 24 24" fill="currentColor"><path d="M12 22C6.477 22 2 17.523 2 12S6.477 2 12 2s10 4.477 10 10-4.477 10-10 10zm-1-11v6h2v-6h-2zm0-4v2h2V7h-2z"/></svg>
                            </div>
                            <div class="meganav__dropdown-card-content">
                                <div class="meganav__dropdown-card-title">Aktive Session</div>
                                <div class="meganav__dropdown-card-desc">Zur aktuellen Session</div>
                            </div>
                        </a>
                        <a href="sessions.html?new=true" class="meganav__dropdown-card">
                            <div class="meganav__dropdown-card-icon meganav__dropdown-card-icon--accent">
                                <svg viewBox="0 0 24 24" fill="currentColor"><path d="M11 11V5h2v6h6v2h-6v6h-2v-6H5v-2z"/></svg>
                            </div>
                            <div class="meganav__dropdown-card-content">
                                <span class="meganav__dropdown-card-badge">Neu</span>
                                <div class="meganav__dropdown-card-title">Session erstellen</div>
                            </div>
                        </a>
                    </div>
                </div>
            </div>
            
            <!-- Charaktere -->
            <div class="meganav__item">
                Charaktere
                <svg class="chevron" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="6 9 12 15 18 9"/></svg>
                
                <div class="meganav__dropdown">
                    <div class="meganav__dropdown-grid">
                        <a href="sheet.html" class="meganav__dropdown-card">
                            <div class="meganav__dropdown-card-icon">
                                <svg viewBox="0 0 24 24" fill="currentColor"><path d="M12 2l.117 .007a1 1 0 0 1 .876 .876l.007 .117v4l.005 .15a2 2 0 0 0 1.838 1.844l.157 .006h4l.117 .007a1 1 0 0 1 .876 .876l.007 .117v9a3 3 0 0 1 -2.824 2.995l-.176 .005h-10a3 3 0 0 1 -2.995 -2.824l-.005 -.176v-14a3 3 0 0 1 2.824 -2.995l.176 -.005zm3 14h-6a1 1 0 0 0 0 2h6a1 1 0 0 0 0 -2m0 -4h-6a1 1 0 0 0 0 2h6a1 1 0 0 0 0 -2"/><path d="M19 7h-4l-.001 -4.001z"/></svg>
                            </div>
                            <div class="meganav__dropdown-card-content">
                                <div class="meganav__dropdown-card-title">Meine Charaktere</div>
                                <div class="meganav__dropdown-card-desc">Charakterverwaltung</div>
                            </div>
                        </a>
                        <a href="sheet.html?new=true" class="meganav__dropdown-card">
                            <div class="meganav__dropdown-card-icon meganav__dropdown-card-icon--accent">
                                <svg viewBox="0 0 24 24" fill="currentColor"><path d="M14 14.252v2.09A6 6 0 0 0 6 22l-2-.001a8 8 0 0 1 10-7.748zM12 13c-3.315 0-6-2.685-6-6s2.685-6 6-6 6 2.685 6 6-2.685 6-6 6zm0-2c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm6 6v-3h2v3h3v2h-3v3h-2v-3h-3v-2h3z"/></svg>
                            </div>
                            <div class="meganav__dropdown-card-content">
                                <div class="meganav__dropdown-card-title">Charakter erstellen</div>
                                <div class="meganav__dropdown-card-desc">Neuen Helden erschaffen</div>
                            </div>
                        </a>
                        <a href="dice.html" class="meganav__dropdown-card">
                            <div class="meganav__dropdown-card-icon">
                                <svg viewBox="0 0 24 24" fill="currentColor"><path d="M10.425 1.414l-6.775 3.996a3.21 3.21 0 0 0 -1.65 2.807v7.285a3.226 3.226 0 0 0 1.678 2.826l6.695 4.237c1.034 .57 2.22 .57 3.2 .032l6.804 -4.302c.98 -.537 1.623 -1.618 1.623 -2.793v-7.284l-.005 -.204a3.223 3.223 0 0 0 -1.284 -2.39l-.107 -.075l-.007 -.007a1.074 1.074 0 0 0 -.181 -.133l-6.776 -3.995a3.33 3.33 0 0 0 -3.216 0z"/></svg>
                            </div>
                            <div class="meganav__dropdown-card-content">
                                <div class="meganav__dropdown-card-title">Würfel</div>
                                <div class="meganav__dropdown-card-desc">3D Dice Roller</div>
                            </div>
                        </a>
                    </div>
                </div>
            </div>
            
            <!-- Regelwerke -->
            <div class="meganav__item">
                Regelwerke
                <svg class="chevron" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="6 9 12 15 18 9"/></svg>
                
                <div class="meganav__dropdown meganav__dropdown--wide">
                    <div class="meganav__dropdown-grid meganav__dropdown-grid--2col">
                        <a href="sheet-worldsapart.html" class="meganav__dropdown-card meganav__dropdown-card--ruleset" style="--ruleset-color: #8b5cf6;">
                            <img src="assets/img/rulesets/worldsapart-icon.png" alt="Worlds Apart" class="meganav__dropdown-card-ruleset-icon">
                            <div class="meganav__dropdown-card-content">
                                <div class="meganav__dropdown-card-title">Worlds Apart</div>
                                <div class="meganav__dropdown-card-desc">Piraten & Magie</div>
                            </div>
                        </a>
                        <a href="sheet-dnd5e.html" class="meganav__dropdown-card meganav__dropdown-card--ruleset" style="--ruleset-color: #ef4444;">
                            <img src="assets/img/rulesets/dnd5e-icon.png" alt="D&D 5e" class="meganav__dropdown-card-ruleset-icon">
                            <div class="meganav__dropdown-card-content">
                                <div class="meganav__dropdown-card-title">D&D 5e (2024)</div>
                                <div class="meganav__dropdown-card-desc">Fantasy-Klassiker</div>
                            </div>
                        </a>
                        <a href="sheet-htbah.html" class="meganav__dropdown-card meganav__dropdown-card--ruleset" style="--ruleset-color: #22c55e;">
                            <img src="assets/img/rulesets/htbah-icon.png" alt="HTBAH" class="meganav__dropdown-card-ruleset-icon">
                            <div class="meganav__dropdown-card-content">
                                <div class="meganav__dropdown-card-title">How To Be A Hero</div>
                                <div class="meganav__dropdown-card-desc">Einfach & flexibel</div>
                            </div>
                        </a>
                        <a href="sheet-cyberpunk.html" class="meganav__dropdown-card meganav__dropdown-card--ruleset" style="--ruleset-color: #eab308;">
                            <img src="assets/img/rulesets/cyberpunk-icon.png" alt="Cyberpunk" class="meganav__dropdown-card-ruleset-icon">
                            <div class="meganav__dropdown-card-content">
                                <div class="meganav__dropdown-card-title">Cyberpunk Red</div>
                                <div class="meganav__dropdown-card-desc">Neon & Chrome</div>
                            </div>
                        </a>
                    </div>
                </div>
            </div>
            
            <!-- Tools -->
            <div class="meganav__item">
                Tools
                <svg class="chevron" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="6 9 12 15 18 9"/></svg>
                
                <div class="meganav__dropdown">
                    <div class="meganav__dropdown-grid">
                        <a href="dice.html" class="meganav__dropdown-card">
                            <div class="meganav__dropdown-card-icon" style="background: rgba(139, 92, 246, 0.15); color: #a78bfa;">
                                <svg viewBox="0 0 24 24" fill="currentColor"><path d="M10.425 1.414l-6.775 3.996a3.21 3.21 0 0 0 -1.65 2.807v7.285a3.226 3.226 0 0 0 1.678 2.826l6.695 4.237c1.034 .57 2.22 .57 3.2 .032l6.804 -4.302c.98 -.537 1.623 -1.618 1.623 -2.793v-7.284l-.005 -.204a3.223 3.223 0 0 0 -1.284 -2.39l-.107 -.075l-.007 -.007a1.074 1.074 0 0 0 -.181 -.133l-6.776 -3.995a3.33 3.33 0 0 0 -3.216 0z"/></svg>
                            </div>
                            <div class="meganav__dropdown-card-content">
                                <div class="meganav__dropdown-card-title">Würfel</div>
                                <div class="meganav__dropdown-card-desc">3D Dice Roller</div>
                            </div>
                        </a>
                        <a href="maps.html" class="meganav__dropdown-card">
                            <div class="meganav__dropdown-card-icon" style="background: rgba(6, 182, 212, 0.15); color: #22d3ee;">
                                <svg viewBox="0 0 24 24" fill="currentColor"><path d="M18.364 4.636a9 9 0 0 1 .203 12.519l-.203 .21l-4.243 4.242a3 3 0 0 1 -4.097 .135l-.144 -.135l-4.244 -4.243a9 9 0 0 1 12.728 -12.728zm-6.364 3.364a3 3 0 1 0 0 6a3 3 0 0 0 0 -6"/></svg>
                            </div>
                            <div class="meganav__dropdown-card-content">
                                <span class="meganav__dropdown-card-badge">Beta</span>
                                <div class="meganav__dropdown-card-title">Karten</div>
                            </div>
                        </a>
                        <a href="whiteboard.html" class="meganav__dropdown-card">
                            <div class="meganav__dropdown-card-icon" style="background: rgba(34, 197, 94, 0.15); color: #4ade80;">
                                <svg viewBox="0 0 24 24" fill="currentColor"><path d="M9 3a2 2 0 0 1 2 2v6a2 2 0 0 1 -2 2h-4a2 2 0 0 1 -2 -2v-6a2 2 0 0 1 2 -2zm0 12a2 2 0 0 1 2 2v2a2 2 0 0 1 -2 2h-4a2 2 0 0 1 -2 -2v-2a2 2 0 0 1 2 -2zm10 -4a2 2 0 0 1 2 2v6a2 2 0 0 1 -2 2h-4a2 2 0 0 1 -2 -2v-6a2 2 0 0 1 2 -2zm0 -8a2 2 0 0 1 2 2v2a2 2 0 0 1 -2 2h-4a2 2 0 0 1 -2 -2v-2a2 2 0 0 1 2 -2z"/></svg>
                            </div>
                            <div class="meganav__dropdown-card-content">
                                <div class="meganav__dropdown-card-title">Whiteboard</div>
                                <div class="meganav__dropdown-card-desc">Zeichnen & Planen</div>
                            </div>
                        </a>
                        <a href="chat.html" class="meganav__dropdown-card">
                            <div class="meganav__dropdown-card-icon" style="background: rgba(236, 72, 153, 0.15); color: #f472b6;">
                                <svg viewBox="0 0 24 24" fill="currentColor"><path d="M5.821 4.91c3.899 -2.765 9.468 -2.539 13.073 .535c3.667 3.129 4.168 8.238 1.152 11.898c-2.841 3.447 -7.965 4.583 -12.231 2.805l-.233 -.101l-4.374 .931l-.04 .006l-.035 .007h-.018l-.022 .005h-.038l-.033 .004l-.021 -.001l-.023 .001l-.033 -.003h-.035l-.022 -.004l-.022 -.002l-.035 -.007l-.034 -.005l-.016 -.004l-.024 -.005l-.049 -.016l-.024 -.005l-.011 -.005l-.022 -.007l-.045 -.02l-.03 -.012l-.011 -.006l-.014 -.006l-.031 -.018l-.045 -.024l-.016 -.011l-.037 -.026l-.04 -.027l-.002 -.004l-.013 -.009l-.043 -.04l-.025 -.02l-.006 -.007l-.056 -.062l-.013 -.014l-.011 -.014l-.039 -.056l-.014 -.019l-.005 -.01l-.042 -.073l-.007 -.012l-.004 -.008l-.007 -.012l-.014 -.038l-.02 -.042l-.004 -.016l-.004 -.01l-.017 -.061l-.007 -.018l-.002 -.015l-.005 -.019l-.005 -.033l-.008 -.042l-.002 -.031l-.003 -.01v-.016l-.004 -.054l.001 -.036l.001 -.023l.002 -.053l.004 -.025v-.019l.008 -.035l.005 -.034l.005 -.02l.004 -.02l.018 -.06l.003 -.013l1.15 -3.45l-.022 -.037c-2.21 -3.747 -1.209 -8.391 2.413 -11.119z"/></svg>
                            </div>
                            <div class="meganav__dropdown-card-content">
                                <div class="meganav__dropdown-card-title">Chat</div>
                                <div class="meganav__dropdown-card-desc">Gruppen-Chat</div>
                            </div>
                        </a>
                    </div>
                </div>
            </div>
            
            <div class="meganav__spacer"></div>
            
            <!-- Social Links -->
            <div class="meganav__social">
                <a href="https://discord.gg/riftapp" target="_blank" class="meganav__social-link" title="Discord">
                    <svg viewBox="0 0 24 24" fill="currentColor"><path d="M20.317 4.37a19.791 19.791 0 0 0-4.885-1.515.074.074 0 0 0-.079.037c-.21.375-.444.864-.608 1.25a18.27 18.27 0 0 0-5.487 0 12.64 12.64 0 0 0-.617-1.25.077.077 0 0 0-.079-.037A19.736 19.736 0 0 0 3.677 4.37a.07.07 0 0 0-.032.027C.533 9.046-.32 13.58.099 18.057a.082.082 0 0 0 .031.057 19.9 19.9 0 0 0 5.993 3.03.078.078 0 0 0 .084-.028 14.09 14.09 0 0 0 1.226-1.994.076.076 0 0 0-.041-.106 13.107 13.107 0 0 1-1.872-.892.077.077 0 0 1-.008-.128 10.2 10.2 0 0 0 .372-.292.074.074 0 0 1 .077-.01c3.928 1.793 8.18 1.793 12.062 0a.074.074 0 0 1 .078.01c.12.098.246.198.373.292a.077.077 0 0 1-.006.127 12.299 12.299 0 0 1-1.873.892.077.077 0 0 0-.041.107c.36.698.772 1.362 1.225 1.993a.076.076 0 0 0 .084.028 19.839 19.839 0 0 0 6.002-3.03.077.077 0 0 0 .032-.054c.5-5.177-.838-9.674-3.549-13.66a.061.061 0 0 0-.031-.03zM8.02 15.33c-1.183 0-2.157-1.085-2.157-2.419 0-1.333.956-2.419 2.157-2.419 1.21 0 2.176 1.096 2.157 2.42 0 1.333-.956 2.418-2.157 2.418zm7.975 0c-1.183 0-2.157-1.085-2.157-2.419 0-1.333.956-2.419 2.157-2.419 1.21 0 2.176 1.096 2.157 2.42 0 1.333-.946 2.418-2.157 2.418z"/></svg>
                </a>
                <a href="https://twitter.com/riftapp" target="_blank" class="meganav__social-link" title="X / Twitter">
                    <svg viewBox="0 0 24 24" fill="currentColor"><path d="M18.244 2.25h3.308l-7.227 8.26 8.502 11.24H16.17l-5.214-6.817L4.99 21.75H1.68l7.73-8.835L1.254 2.25H8.08l4.713 6.231zm-1.161 17.52h1.833L7.084 4.126H5.117z"/></svg>
                </a>
                <a href="https://ko-fi.com/riftapp" target="_blank" class="meganav__social-link" title="Ko-fi">
                    <svg viewBox="0 0 24 24" fill="currentColor"><path d="M23.881 8.948c-.773-4.085-4.859-4.593-4.859-4.593H.723c-.604 0-.679.798-.679.798s-.082 7.324-.022 11.822c.164 2.424 2.586 2.672 2.586 2.672s8.267-.023 11.966-.049c2.438-.426 2.683-2.566 2.658-3.734 4.352.24 7.422-2.831 6.649-6.916zm-11.062 3.511c-1.246 1.453-4.011 3.976-4.011 3.976s-.121.119-.31.023c-.076-.057-.108-.09-.108-.09-.443-.441-3.368-3.049-4.034-3.954-.709-.965-1.041-2.7-.091-3.71.951-1.01 3.005-1.086 4.363.407 0 0 1.565-1.782 3.468-.963 1.904.82 1.832 3.011.723 4.311zm6.173.478c-.928.116-1.682.028-1.682.028V7.284h1.77s1.971.551 1.971 2.638c0 1.913-.985 2.667-2.059 3.015z"/></svg>
                </a>
                <a href="mailto:contact@rift.app" class="meganav__social-link" title="Email">
                    <svg viewBox="0 0 24 24" fill="currentColor"><path d="M3 3h18a1 1 0 0 1 1 1v16a1 1 0 0 1-1 1H3a1 1 0 0 1-1-1V4a1 1 0 0 1 1-1zm9.06 8.683L5.648 6.238 4.353 7.762l7.72 6.555 7.581-6.56-1.308-1.513-6.286 5.439z"/></svg>
                </a>
            </div>
        </div>
    </nav>
    
    <div class="app">
        <main class="main main--hub">
            <div class="main__content">
                
                <!-- Page Header -->
                <div class="page-header">
                    <div class="page-header__icon">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                            <path fill-rule="evenodd" clip-rule="evenodd" d="M2.5192 7.82274C2 8.77128 2 9.91549 2 12.2039V13.725C2 17.6258 2 19.5763 3.17157 20.7881C4.34315 22 6.22876 22 10 22H14C17.7712 22 19.6569 22 20.8284 20.7881C22 19.5763 22 17.6258 22 13.725V12.2039C22 9.91549 22 8.77128 21.4808 7.82274C20.9616 6.87421 20.0131 6.28551 18.116 5.10812L16.116 3.86687C14.1106 2.62229 13.1079 2 12 2C10.8921 2 9.88939 2.62229 7.88403 3.86687L5.88403 5.10813C3.98695 6.28551 3.0384 6.87421 2.5192 7.82274ZM9 17.25C8.58579 17.25 8.25 17.5858 8.25 18C8.25 18.4142 8.58579 18.75 9 18.75H15C15.4142 18.75 15.75 18.4142 15.75 18C15.75 17.5858 15.4142 17.25 15 17.25H9Z"/>
                        </svg>
                    </div>
                    <div class="page-header__divider"></div>
                    <h1 class="page-header__title">Hub</h1>
                    <span class="page-header__tagline">Dein Abenteuer beginnt hier</span>
                </div>
                
                <!-- User Greeting -->
                <div class="hub-greeting" id="hubGreeting">
                    <h2 class="hub-greeting__text"><span class="hub-greeting__time" id="greetingTime">Guten Tag,</span> <span class="hub-greeting__name" id="greetingUsername">Abenteurer</span></h2>
                </div>
                
                <div class="hub-divider"></div>
                
                <!-- ═══════════════════════════════════════════
                     1. HERO CAROUSEL (Admin-editable via carousel-config.json)
                     ═══════════════════════════════════════════ -->
                <div class="hero-carousel" id="heroCarousel">
                    <div class="hero-carousel__slides" id="carouselSlides">
                        <!-- Slides werden dynamisch aus admin/carousel-config.json geladen -->
                    </div>
                    
                    <!-- Navigation Arrows -->
                    <button class="hero-carousel__nav hero-carousel__nav--prev" aria-label="Vorherige Slide">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M15 18l-6-6 6-6"/></svg>
                    </button>
                    <button class="hero-carousel__nav hero-carousel__nav--next" aria-label="Nächste Slide">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M9 18l6-6-6-6"/></svg>
                    </button>
                    
                    <!-- Tab Navigation -->
                    <div class="hero-carousel__tabs" id="carouselTabs">
                        <!-- Tabs werden dynamisch generiert -->
                    </div>
                    
                    <!-- Dots (Mobile) -->
                    <div class="hero-carousel__dots" id="carouselDots">
                        <!-- Dots werden dynamisch generiert -->
                    </div>
                </div>
                
                <!-- ═══════════════════════════════════════════
                     2. FEATURE SHOWCASE (Admin-editable via Firebase hub_features)
                     ═══════════════════════════════════════════ -->
                <div class="hub-section hub-section--features">
                    <section class="feature-showcase feature-showcase--fullwidth" id="featureShowcase">
                        <!-- Feature Content - wird dynamisch aus Firebase geladen -->
                        <div class="feature-content" id="featureContent">
                            <!-- Loading Placeholder -->
                            <div class="feature-panel active" data-panel="loading">
                                <div class="feature-panel__inner">
                                    <div class="feature-panel__image feature-panel__image--placeholder">
                                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                                            <rect x="3" y="3" width="18" height="18" rx="2"/>
                                            <circle cx="8.5" cy="8.5" r="1.5"/>
                                            <polyline points="21 15 16 10 5 21"/>
                                        </svg>
                                    </div>
                                    <div class="feature-panel__text">
                                        <nav class="feature-tabs" id="featureTabs">
                                            <button class="feature-tab active">Laden...</button>
                                        </nav>
                                        <h3 class="feature-panel__title">Features werden geladen...</h3>
                                        <p class="feature-panel__desc">Bitte warten...</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </section>
                </div>

                <div class="hub-divider"></div>

                <!-- ═══════════════════════════════════════════
                     3. SESSION/CHARACTER CARDS
                     ═══════════════════════════════════════════ -->
                <div class="hub-section hub-section--cards">
                    <h2 class="hub-section__title">Deine Reise</h2>
                    
                    <!-- Hero Section -->
                <div class="hero-section" id="heroSection">
                    <!-- Loading Skeleton (initial sichtbar) -->
                    <div class="hero-loading" id="heroLoading">
                        <div class="hero-loading__card hero-loading__card--small"></div>
                        <div class="hero-loading__card hero-loading__card--large"></div>
                    </div>
                    
                    <!-- Kompakter Status-Banner (kontextabhängig) -->
                    <div class="status-banner" id="statusBanner" style="display: none;">
                        <div class="status-banner__icon" id="statusIcon">
                            <!-- Icon wird dynamisch gesetzt -->
                        </div>
                        <div class="status-banner__content">
                            <h3 class="status-banner__title" id="statusTitle">Willkommen bei RIFT</h3>
                            <p class="status-banner__text" id="statusText">Erstelle deinen ersten Charakter oder plane eine Session.</p>
                        </div>
                        <div class="status-banner__actions" id="statusActions">
                            <!-- Buttons werden dynamisch gesetzt -->
                        </div>
                    </div>
                    
                    <!-- Container für dynamische Karten (initial versteckt) -->
                    <div id="continueCardsContainer" style="display: none;"></div>
                    
                    <!-- ═══════════════════════════════════════════
                         HERO PANELS - Character + Session
                         ═══════════════════════════════════════════ -->
                    <div class="hero-panels" id="heroPanels" style="display: none;">
                        
                        <!-- CHARACTER PANEL -->
                        <a href="#" class="character-panel" id="characterPanel">
                            <div class="character-panel__bg"></div>
                            
                            <!-- Portrait (2:3) -->
                            <div class="character-panel__portrait" id="charPanelPortrait">
                                <span class="character-panel__portrait-placeholder">?</span>
                            </div>
                            
                            <!-- Content -->
                            <div class="character-panel__content">
                                <span class="character-panel__label">Dein Charakter</span>
                                <h3 class="character-panel__name" id="charPanelName">Charakter</h3>
                                
                                <!-- Meta: Geschlecht, Alter, Rolle, Fokus (alle als Badges) -->
                                <div class="character-panel__meta" id="charPanelMeta">
                                    <span class="character-panel__badge" id="charPanelGender" style="display: none;">--</span>
                                    <span class="character-panel__badge" id="charPanelAge" style="display: none;">--</span>
                                    <span class="character-panel__badge" id="charPanelRole" style="display: none;">--</span>
                                    <span class="character-panel__badge character-panel__badge--fokus" id="charPanelElement" style="display: none;">
                                        <img src="" alt="" class="character-panel__fokus-icon" id="charPanelFokusIcon">
                                        <span>--</span>
                                    </span>
                                </div>
                                
                                <!-- Attribute: KRF, GES, ZÄH, VER, PRÄ -->
                                <div class="character-panel__attributes" id="charPanelAttributes">
                                    <span class="character-panel__attr">
                                        <span class="character-panel__attr-value" id="charPanelAttrKrf">0</span>
                                        <span class="character-panel__attr-label">KRF</span>
                                    </span>
                                    <span class="character-panel__attr">
                                        <span class="character-panel__attr-value" id="charPanelAttrGes">0</span>
                                        <span class="character-panel__attr-label">GES</span>
                                    </span>
                                    <span class="character-panel__attr">
                                        <span class="character-panel__attr-value" id="charPanelAttrZaeh">0</span>
                                        <span class="character-panel__attr-label">ZÄH</span>
                                    </span>
                                    <span class="character-panel__attr">
                                        <span class="character-panel__attr-value" id="charPanelAttrVer">0</span>
                                        <span class="character-panel__attr-label">VER</span>
                                    </span>
                                    <span class="character-panel__attr">
                                        <span class="character-panel__attr-value" id="charPanelAttrPrae">0</span>
                                        <span class="character-panel__attr-label">PRÄ</span>
                                    </span>
                                </div>
                                
                                <!-- Stats: LP, Moral, Resonanz -->
                                <div class="character-panel__stats" id="charPanelStats">
                                    <div class="character-panel__stat character-panel__stat--hp">
                                        <svg viewBox="0 0 24 24" fill="currentColor" class="character-panel__stat-icon">
                                            <path d="M6.979 3.074a6 6 0 0 1 4.988 1.425l.037 .033l.034 -.03a6 6 0 0 1 4.733 -1.44l.246 .036a6 6 0 0 1 3.364 10.008l-.18 .185l-.048 .041l-7.45 7.379a1 1 0 0 1 -1.313 .082l-.094 -.082l-7.493 -7.422a6 6 0 0 1 3.176 -10.215z"/>
                                        </svg>
                                        <div class="character-panel__stat-bar">
                                            <div class="character-panel__stat-fill character-panel__stat-fill--hp" id="charPanelHpBar" style="width: 100%"></div>
                                        </div>
                                        <span class="character-panel__stat-value" id="charPanelHp">--</span>
                                    </div>
                                    <div class="character-panel__stat character-panel__stat--mp">
                                        <svg viewBox="0 0 24 24" fill="currentColor" class="character-panel__stat-icon">
                                            <path d="M13 3l0 6l6 0l-8 12l0 -6l-6 0l8 -12z"/>
                                        </svg>
                                        <div class="character-panel__stat-bar">
                                            <div class="character-panel__stat-fill character-panel__stat-fill--mp" id="charPanelMpBar" style="width: 100%"></div>
                                        </div>
                                        <span class="character-panel__stat-value" id="charPanelMp">--</span>
                                    </div>
                                    <div class="character-panel__stat character-panel__stat--resonanz" id="charPanelResonanzStat">
                                        <svg viewBox="0 0 24 24" fill="currentColor" class="character-panel__stat-icon">
                                            <path d="M6 5h12l3 5l-9 11l-9 -11z"/>
                                        </svg>
                                        <div class="character-panel__stat-bar">
                                            <div class="character-panel__stat-fill character-panel__stat-fill--resonanz" id="charPanelResonanzBar" style="width: 100%"></div>
                                        </div>
                                        <span class="character-panel__stat-value" id="charPanelResonanz">--</span>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Arrow -->
                            <div class="character-panel__arrow">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M5 12h14M12 5l7 7-7 7"/>
                                </svg>
                            </div>
                        </a>
                        
                        <!-- SESSION PANEL (Adventure Panel) -->
                        <a href="#" class="adventure-panel" id="adventurePanel">
                            <div class="adventure-panel__bg"></div>
                            
                            <!-- Cover Image (2:3) -->
                            <div class="adventure-panel__cover" id="adventureCover">
                                <div class="adventure-panel__cover-placeholder">
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                                        <rect x="3" y="3" width="18" height="18" rx="2"/>
                                        <circle cx="8.5" cy="8.5" r="1.5"/>
                                        <path d="M21 15l-5-5L5 21"/>
                                    </svg>
                                </div>
                            </div>
                            
                            <div class="adventure-panel__inner">
                                <div class="adventure-panel__content">
                                    <div class="adventure-panel__header">
                                        <span class="adventure-panel__label">Weiterspielen</span>
                                        <span class="adventure-panel__gm-badge" id="adventureGmBadge" style="display: none;">
                                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                                <path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/>
                                            </svg>
                                            GM
                                        </span>
                                    </div>
                                    <h2 class="adventure-panel__title" id="adventureTitle">Session Name</h2>
                                    <p class="adventure-panel__subtitle" id="adventureSubtitle">Beschreibung...</p>
                                    
                                    <!-- Meta Row -->
                                    <div class="adventure-panel__meta">
                                        <span class="adventure-panel__ruleset" id="adventureRuleset">
                                            <img src="" alt="" id="adventureRulesetIcon">
                                            <span id="adventureRulesetName">Worlds Apart</span>
                                        </span>
                                        <span class="adventure-panel__session-num" id="adventureSessionNum">Session 1</span>
                                        
                                        <!-- Schedule inline -->
                                        <div class="adventure-panel__schedule" id="adventureSchedule">
                                            <div class="adventure-panel__date">
                                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                                    <rect x="3" y="4" width="18" height="18" rx="2" ry="2"/>
                                                    <line x1="16" y1="2" x2="16" y2="6"/>
                                                    <line x1="8" y1="2" x2="8" y2="6"/>
                                                    <line x1="3" y1="10" x2="21" y2="10"/>
                                                </svg>
                                                <span id="adventureDateText">Keine Session geplant</span>
                                            </div>
                                            <div class="adventure-panel__countdown" id="adventureCountdown" style="display: none;">
                                                <span class="adventure-panel__countdown-item">
                                                    <span class="adventure-panel__countdown-num" id="adventureCountdownDays">0</span>
                                                    <span class="adventure-panel__countdown-unit">T</span>
                                                </span>
                                                <span class="adventure-panel__countdown-sep">:</span>
                                                <span class="adventure-panel__countdown-item">
                                                    <span class="adventure-panel__countdown-num" id="adventureCountdownHours">0</span>
                                                    <span class="adventure-panel__countdown-unit">Std</span>
                                                </span>
                                                <span class="adventure-panel__countdown-sep">:</span>
                                                <span class="adventure-panel__countdown-item">
                                                    <span class="adventure-panel__countdown-num" id="adventureCountdownMins">0</span>
                                                    <span class="adventure-panel__countdown-unit">Min</span>
                                                </span>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <!-- Tags -->
                                    <div class="adventure-panel__tags" id="adventureTags"></div>
                                </div>
                                
                                <!-- CTA Side -->
                                <div class="adventure-panel__side">
                                    <span class="adventure-panel__cta">
                                        Session öffnen
                                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                            <path d="M5 12h14M12 5l7 7-7 7"/>
                                        </svg>
                                    </span>
                                </div>
                            </div>
                        </a>
                        
                    </div>
                    
                    <!-- Legacy Hero Cards Container (fallback) -->
                    <div class="hero-cards-container" id="heroCardsContainer" style="display: none;">
                        
                        <!-- Character Hero Card (links) -->
                        <a href="#" class="character-hero" id="characterHeroCard" style="display: none;">
                            <div class="character-hero__portrait" id="characterHeroPortrait">
                                <!-- Portrait or placeholder -->
                            </div>
                            <div class="character-hero__content">
                                <span class="character-hero__label">Dein Charakter</span>
                                <h3 class="character-hero__name" id="characterHeroName">Charakter</h3>
                                <div class="character-hero__meta">
                                    <span class="character-hero__class" id="characterHeroClass"></span>
                                </div>
                                <div class="character-hero__stats" id="characterHeroStats">
                                    <div class="character-hero__stat">
                                        <span class="character-hero__stat-icon character-hero__stat-icon--lp">
                                            <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="currentColor"><path d="M6.979 3.074a6 6 0 0 1 4.988 1.425l.037 .033l.034 -.03a6 6 0 0 1 4.733 -1.44l.246 .036a6 6 0 0 1 3.364 10.008l-.18 .185l-.048 .041l-7.45 7.379a1 1 0 0 1 -1.313 .082l-.094 -.082l-7.493 -7.422a6 6 0 0 1 3.176 -10.215z"/></svg>
                                        </span>
                                        <div class="character-hero__stat-bar">
                                            <div class="character-hero__stat-fill character-hero__stat-fill--lp" id="characterHeroLpBar" style="width: 100%"></div>
                                        </div>
                                        <span class="character-hero__stat-value" id="characterHeroLpValue">--</span>
                                    </div>
                                    <div class="character-hero__stat">
                                        <span class="character-hero__stat-icon character-hero__stat-icon--moral">
                                            <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="currentColor"><path d="M12 23c-6.627 0-12-4.925-12-11c0-3.073 1.152-5.881 3.051-8.009a1 1 0 0 1 1.47 -.076l2.121 2.121c.603 .603 1.572 .705 2.3 .242l1.894 -1.205a1 1 0 0 1 1.197 .054l2.042 1.701c.68 .567 1.678 .593 2.389 .062l1.724 -1.29a1 1 0 0 1 1.448 .196c1.565 2.091 2.364 4.678 2.364 7.204c0 6.075-5.373 11-12 11z"/></svg>
                                        </span>
                                        <div class="character-hero__stat-bar">
                                            <div class="character-hero__stat-fill character-hero__stat-fill--moral" id="characterHeroMoralBar" style="width: 100%"></div>
                                        </div>
                                        <span class="character-hero__stat-value" id="characterHeroMoralValue">--</span>
                                    </div>
                                </div>
                            </div>
                        </a>
                        
                        <!-- Session Hero Card (rechts) -->
                        <a href="#" class="session-hero" id="sessionHeroCard" style="display: none;">
                            <div class="session-hero__cover" id="sessionHeroCover">
                                <!-- Cover image or placeholder -->
                            </div>
                            <div class="session-hero__content">
                                <div class="session-hero__header">
                                    <span class="session-hero__label">Weiterspielen</span>
                                    <div class="session-hero__gm-badge" id="sessionHeroGmBadge" style="display: none;">
                                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                            <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/>
                                            <circle cx="12" cy="7" r="4"/>
                                        </svg>
                                        <span>Game Master</span>
                                    </div>
                                </div>
                                <h2 class="session-hero__title" id="sessionHeroTitle">Session Name</h2>
                                <p class="session-hero__subtitle" id="sessionHeroSubtitle"></p>
                                <div class="session-hero__meta">
                                    <span class="session-hero__ruleset" id="sessionHeroRuleset">
                                        <img src="" alt="">
                                        <span></span>
                                    </span>
                                    <span class="session-hero__session-num" id="sessionHeroSessionNum">Session 1/2</span>
                                </div>
                                <div class="session-hero__tags" id="sessionHeroTags"></div>
                                <div class="session-hero__footer">
                                    <span class="session-hero__btn">
                                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                            <path d="M15 3h4a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2h-4"/>
                                            <polyline points="10 17 15 12 10 7"/>
                                            <line x1="15" y1="12" x2="3" y2="12"/>
                                        </svg>
                                        Session öffnen
                                    </span>
                                </div>
                            </div>
                            <div class="session-hero__calendar">
                                <span class="session-hero__calendar-label">Nächste Session</span>
                                <div class="session-hero__date-box" id="sessionHeroDateBox">
                                    <span class="session-hero__day" id="sessionHeroDay">--</span>
                                    <span class="session-hero__num" id="sessionHeroNum">--</span>
                                    <span class="session-hero__month" id="sessionHeroMonth">---</span>
                                </div>
                                <span class="session-hero__time" id="sessionHeroTime">--:-- Uhr</span>
                                <div class="session-hero__countdown" id="sessionHeroCountdown">
                                    <span class="session-hero__countdown-value" id="heroCountdownDays">-</span>
                                    <span class="session-hero__countdown-label">T</span>
                                    <span class="session-hero__countdown-sep">:</span>
                                    <span class="session-hero__countdown-value" id="heroCountdownHours">-</span>
                                    <span class="session-hero__countdown-label">Std</span>
                                    <span class="session-hero__countdown-sep">:</span>
                                    <span class="session-hero__countdown-value" id="heroCountdownMins">-</span>
                                    <span class="session-hero__countdown-label">Min</span>
                                </div>
                                <div class="session-hero__no-date" id="sessionHeroNoDate" style="display: none;">
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <rect x="3" y="4" width="18" height="18" rx="2" ry="2"/>
                                        <line x1="16" y1="2" x2="16" y2="6"/>
                                        <line x1="8" y1="2" x2="8" y2="6"/>
                                        <line x1="3" y1="10" x2="21" y2="10"/>
                                    </svg>
                                    <span>Kein Termin</span>
                                </div>
                            </div>
                        </a>
                    </div>
                    
                    <!-- Nächste Session Card (legacy - für Fallback wenn keine aktive Session) -->
                    <a href="/sessions" class="next-session-card" id="nextSessionCard" style="display: none;">
                        <div class="next-session-card__header">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <rect x="3" y="4" width="18" height="18" rx="2" ry="2"/>
                                <line x1="16" y1="2" x2="16" y2="6"/>
                                <line x1="8" y1="2" x2="8" y2="6"/>
                                <line x1="3" y1="10" x2="21" y2="10"/>
                            </svg>
                            <span>Nächste Session</span>
                        </div>
                        <div class="next-session-card__date">
                            <span class="next-session-card__day" id="nextSessionDay">--</span>
                            <span class="next-session-card__num" id="nextSessionNum">--</span>
                            <span class="next-session-card__month" id="nextSessionMonth">---</span>
                        </div>
                        <div class="next-session-card__time" id="nextSessionTime">--:-- Uhr</div>
                        <div class="next-session-card__countdown" id="sessionCountdown">
                            <span class="countdown__value" id="countdownDays">-</span>
                            <span class="countdown__label">Tage</span>
                            <span class="countdown__sep">:</span>
                            <span class="countdown__value" id="countdownHours">-</span>
                            <span class="countdown__label">Std</span>
                            <span class="countdown__sep">:</span>
                            <span class="countdown__value" id="countdownMins">-</span>
                            <span class="countdown__label">Min</span>
                        </div>
                    </a>
                </div>
                </div><!-- Ende hub-section--cards -->

                <div class="hub-divider"></div>

                <!-- ═══════════════════════════════════════════
                     4. NEUIGKEITEN
                     ═══════════════════════════════════════════ -->
                <div class="hub-section hub-section--dark">
                    <div class="hub-section__inner">
                        
                        <!-- News + Feature Showcase Row -->
                        <div class="hub-showcase">
                    
                    <!-- LEFT: News Section -->
                    <section class="news-section" id="newsSection">
                        <header class="news-section__header">
                            <h2 class="news-section__title">
                                <span class="news-section__icon">◆</span>
                                Neuigkeiten
                            </h2>
                            <a href="roadmap.html" class="news-section__link">
                                Alle Beiträge
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M5 12h14M12 5l7 7-7 7"/>
                                </svg>
                            </a>
                        </header>
                        
                        <!-- Category Tabs -->
                        <nav class="news-tabs" id="newsTabs">
                            <button class="news-tab active" data-category="all">Alle</button>
                            <button class="news-tab" data-category="news">News</button>
                            <button class="news-tab" data-category="update">Updates</button>
                            <button class="news-tab" data-category="guide">Guides</button>
                        </nav>
                        
                        <!-- Loading State -->
                        <div class="news-layout news-layout--loading" id="newsLoading">
                            <div class="news-featured news-featured--skeleton">
                                <div class="skeleton"></div>
                            </div>
                            <div class="news-list">
                                <div class="news-list-item news-list-item--skeleton"><div class="skeleton"></div></div>
                                <div class="news-list-item news-list-item--skeleton"><div class="skeleton"></div></div>
                                <div class="news-list-item news-list-item--skeleton"><div class="skeleton"></div></div>
                            </div>
                        </div>
                        
                        <!-- News Layout (filled by JS) -->
                        <div class="news-layout" id="newsLayout" style="display: none;">
                            <a class="news-featured" id="newsFeatured" href="#"></a>
                            <div class="news-list" id="newsList"></div>
                        </div>
                        
                        <!-- Empty State -->
                        <div class="news-empty" id="newsEmpty" style="display: none;">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                                <path d="M19 20H5a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h10a2 2 0 0 1 2 2v1m2 13a2 2 0 0 1-2-2V9a2 2 0 0 1 2-2h2a2 2 0 0 1 2 2v9a2 2 0 0 1-2 2h-2z"/>
                            </svg>
                            <p>Bald gibt's Neuigkeiten!</p>
                        </div>
                    </section>
                    
                    </div><!-- Ende hub-showcase -->
                    </div><!-- Ende hub-section__inner -->
                </div><!-- Ende hub-section--dark -->

                <div class="hub-divider"></div>

                <!-- ═══════════════════════════════════════════
                     5. QUOTE OF THE DAY
                     ═══════════════════════════════════════════ -->
                <div class="hub-section hub-section--quote">
                    <div class="quote-of-day" id="quoteOfDay">
                        
                        <div class="quote-of-day__label">
                            <svg viewBox="0 0 24 24" fill="currentColor"><path d="M12 2l3.09 6.26l6.91 1.01l-5 4.87l1.18 6.86l-6.18 -3.25l-6.18 3.25l1.18 -6.86l-5 -4.87l6.91 -1.01l3.09 -6.26z"/></svg>
                            Zitat des Tages
                        </div>
                        <p class="quote-of-day__text" id="quoteText">„Ein wahrer Held ist nicht der, der keine Angst kennt, sondern der, der trotz seiner Angst handelt."</p>
                        <div class="quote-of-day__footer">
                            <div class="quote-of-day__author">
                                <span class="quote-of-day__name" id="quoteAuthor">Gandalf der Graue</span>
                                <span class="quote-of-day__source" id="quoteSource">Der Herr der Ringe</span>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="hub-divider"></div>

                <!-- ═══════════════════════════════════════════
                     6. INFO CARDS (Widgets)
                     ═══════════════════════════════════════════ -->
                <div class="hub-section hub-section--widgets">
                    <!-- Widget Grid -->
                    <div class="widgets">
                    
                    <!-- Widget: Letzte Sessions -->
                    <div class="widget">
                        <div class="widget__header">
                            <h2 class="widget__title">Letzte Sessions</h2>
                            <a href="/sessions" class="widget__action">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
                                Neu
                            </a>
                        </div>
                        <div class="widget__content">
                            <div class="widget__list" id="recentSessionsList">
                                <!-- Dynamisch befüllt -->
                            </div>
                            <!-- Empty State -->
                            <div class="widget__empty" id="sessionsEmpty">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                                    <rect x="3" y="4" width="18" height="18" rx="2" ry="2"/>
                                    <line x1="16" y1="2" x2="16" y2="6"/>
                                    <line x1="8" y1="2" x2="8" y2="6"/>
                                    <line x1="3" y1="10" x2="21" y2="10"/>
                                </svg>
                                <p>Noch keine Sessions</p>
                                <a href="/sessions" class="widget__empty-btn">Session erstellen</a>
                            </div>
                        </div>
                        <div class="widget__footer" id="sessionsFooter" style="display: none;">
                            <a href="/sessions" class="widget__link">
                                Alle Sessions anzeigen
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="9 18 15 12 9 6"/></svg>
                            </a>
                        </div>
                    </div>
                    
                    <!-- Widget: Aktive Charaktere -->
                    <div class="widget">
                        <div class="widget__header">
                            <h2 class="widget__title">Aktive Charaktere</h2>
                            <a href="/sheet" class="widget__action">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
                                Neu
                            </a>
                        </div>
                        <div class="widget__content">
                            <div class="widget__list" id="charactersList">
                                <!-- Dynamisch befüllt -->
                            </div>
                            <!-- Empty State -->
                            <div class="widget__empty" id="charactersEmpty">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                                    <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/>
                                    <circle cx="12" cy="7" r="4"/>
                                </svg>
                                <p>Noch keine Charaktere</p>
                                <a href="/sheet" class="widget__empty-btn">Charakter erstellen</a>
                            </div>
                        </div>
                        <div class="widget__footer" id="charactersFooter" style="display: none;">
                            <a href="/sheet" class="widget__link">
                                Alle Charaktere
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="9 18 15 12 9 6"/></svg>
                            </a>
                        </div>
                    </div>
                    
                    <!-- Widget: Deine Party -->
                    <div class="widget">
                        <div class="widget__header">
                            <h2 class="widget__title">Deine Party</h2>
                            <button class="widget__action" id="invitePartyBtn">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M16 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="8.5" cy="7" r="4"/><line x1="20" y1="8" x2="20" y2="14"/><line x1="23" y1="11" x2="17" y2="11"/></svg>
                                Einladen
                            </button>
                        </div>
                        <div class="widget__content">
                            <div class="widget__list" id="partyList">
                                <!-- Dynamisch befüllt -->
                            </div>
                            <!-- Empty State -->
                            <div class="widget__empty" id="partyEmpty">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                                    <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/>
                                    <circle cx="9" cy="7" r="4"/>
                                    <path d="M23 21v-2a4 4 0 0 0-3-3.87"/>
                                    <path d="M16 3.13a4 4 0 0 1 0 7.75"/>
                                </svg>
                                <p>Noch keine Mitspieler</p>
                                <span class="widget__empty-hint">Teile deinen Raum-Code um Spieler einzuladen</span>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Widget: Session Timer -->
                    <div class="widget widget--compact" id="sessionTimerWidget" style="display: none;">
                        <div class="widget__header">
                            <h2 class="widget__title">Session läuft</h2>
                            <span class="session-timer__live">● Live</span>
                        </div>
                        <div class="widget__content">
                            <div class="session-timer">
                                <div class="session-timer__display">
                                    <span class="session-timer__value" id="sessionTimerValue">0:00:00</span>
                                </div>
                                <div class="session-timer__controls">
                                    <button class="session-timer__btn" id="pauseSessionBtn" title="Pause">
                                        <svg viewBox="0 0 24 24" fill="currentColor"><rect x="6" y="4" width="4" height="16"/><rect x="14" y="4" width="4" height="16"/></svg>
                                    </button>
                                    <button class="session-timer__btn session-timer__btn--stop" id="stopSessionBtn" title="Session beenden">
                                        <svg viewBox="0 0 24 24" fill="currentColor"><rect x="4" y="4" width="16" height="16" rx="2"/></svg>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Widget: Achievements -->
                    <div class="widget widget--compact">
                        <div class="widget__header">
                            <h2 class="widget__title">Achievements</h2>
                        </div>
                        <div class="widget__content">
                            <div class="achievements">
                                <div class="achievement achievement--unlocked" title="Erste Schritte: Erste Session gespielt">
                                    <div class="achievement__icon">🎲</div>
                                </div>
                                <div class="achievement achievement--unlocked" title="Würfelmeister: 100 Würfe">
                                    <div class="achievement__icon">🎯</div>
                                </div>
                                <div class="achievement achievement--unlocked" title="Kritischer Treffer: Nat 20 gewürfelt">
                                    <div class="achievement__icon">⚔️</div>
                                </div>
                                <div class="achievement achievement--unlocked" title="Geschichtenerzähler: 10 Sessions">
                                    <div class="achievement__icon">📖</div>
                                </div>
                                <div class="achievement" title="Veteran: 50 Sessions">
                                    <div class="achievement__icon">🏆</div>
                                </div>
                                <div class="achievement" title="Glückspilz: 5 Nat 20s in einer Session">
                                    <div class="achievement__icon">🍀</div>
                                </div>
                            </div>
                            <a href="#" class="widget__link widget__link--small">
                                Alle anzeigen (12/24)
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="9 18 15 12 9 6"/></svg>
                            </a>
                        </div>
                    </div>
                    
                </div>
                
            </div>
        </main>
        
        <!-- GM Floating Action Button -->
        <a href="gm.html" class="gm-fab" id="gmFab" style="display: none;" title="GM Optionen">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <circle cx="12" cy="12" r="3"/>
                <path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"/>
            </svg>
            <span>GM</span>
        </a>
    </div>
    
    <!-- Scripts -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.6.1/cropper.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/marked/11.1.1/marked.min.js"></script>
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    
    <!-- RIFT Services -->
    <script src="assets/js/firebase-config.js"></script>
    <script src="assets/js/room-service.js"></script>
    <script src="assets/js/user-service.js"></script>
    <script src="assets/js/character-storage.js"></script>
    
    <script src="assets/js/auth.js"></script>
    <script src="assets/js/ui.js"></script>
    <script src="assets/js/layout.js"></script>
    <script src="assets/js/settings.js"></script>
    <script src="assets/js/admin.js"></script>
    <script src="assets/js/news.js"></script>
    <script src="assets/js/data-manager.js"></script>
    <script src="assets/js/transitions.js"></script>
    <script src="assets/js/app.js"></script>
    <script>
        initLayout();
        
        // Get current room code for filtering
        var currentRoomCode = localStorage.getItem('rift_current_room') || null;
        
        // ========================================
        // PARTY MEMBERS (Realtime from Firebase)
        // ========================================
        (function() {
            const partyList = document.getElementById('partyList');
            const partyEmpty = document.getElementById('partyEmpty');
            let unsubscribe = null;
            
            function renderPartyMembers(members) {
                if (!partyList || !partyEmpty) return;
                
                const currentUserId = firebase.auth()?.currentUser?.uid;
                const currentUserData = window.currentUser || JSON.parse(localStorage.getItem('rift_user') || '{}');
                
                if (members.length === 0) {
                    partyList.style.display = 'none';
                    partyEmpty.style.display = 'flex';
                    return;
                }
                
                partyEmpty.style.display = 'none';
                partyList.style.display = 'flex';
                
                partyList.innerHTML = members.map(member => {
                    const isYou = member.id === currentUserId || member.id === currentUserData.uid;
                    
                    let name = member.displayName || member.name;
                    if (!name && isYou) name = currentUserData.displayName || currentUserData.name;
                    name = name || 'Unbekannt';
                    
                    const displayName = isYou ? name + ' (Du)' : name;
                    const color = (isYou ? currentUserData.color : member.color) || '#8B5CF6';
                    const initial = name.charAt(0).toUpperCase();
                    const avatar = member.avatar || member.photoURL || (isYou ? (currentUserData.avatar || currentUserData.photoURL) : null);
                    const isOnline = member.online === true;
                    const role = member.role === 'gm' ? 'Spielleiter' : 'Spieler';
                    
                    return `
                        <div style="display:flex;align-items:center;gap:12px;padding:10px 12px;background:rgba(255,255,255,0.03);border-radius:10px;border:1px solid rgba(255,255,255,0.06);">
                            <div style="position:relative;flex-shrink:0;">
                                <div style="width:38px;height:38px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:15px;font-weight:700;color:white;overflow:hidden;background:${color};">
                                    ${avatar ? `<img src="${avatar}" style="width:100%;height:100%;object-fit:cover;">` : initial}
                                </div>
                                <span style="position:absolute;bottom:-2px;right:-2px;width:12px;height:12px;border-radius:50%;border:2px solid #1a1a1a;background:${isOnline ? '#22c55e' : '#6b7280'};"></span>
                            </div>
                            <div style="display:flex;flex-direction:column;gap:2px;min-width:0;flex:1;">
                                <span style="font-size:14px;font-weight:600;color:white;">${displayName}</span>
                                <span style="font-size:12px;color:rgba(255,255,255,0.5);">${role}</span>
                            </div>
                        </div>
                    `;
                }).join('');
            }
            
            function subscribeToParty() {
                const roomCode = localStorage.getItem('rift_current_room');
                if (!roomCode) {
                    console.log('[Hub] No room code, skipping party subscription');
                    return;
                }
                
                // Wait for Firebase and RIFT.rooms
                if (typeof RIFT === 'undefined' || !RIFT.rooms) {
                    setTimeout(subscribeToParty, 500);
                    return;
                }
                
                console.log('[Hub] Subscribing to party members for room:', roomCode);
                
                // Unsubscribe from previous if exists
                if (unsubscribe) unsubscribe();
                
                // Subscribe to realtime updates
                unsubscribe = RIFT.rooms.subscribeToMembers(roomCode, (members) => {
                    console.log('[Hub] Received members update:', members);
                    renderPartyMembers(members);
                });
            }
            
            // Start subscription after a delay to ensure Firebase is ready
            setTimeout(subscribeToParty, 1000);
            
            // Cleanup on page unload
            window.addEventListener('beforeunload', () => {
                if (unsubscribe) unsubscribe();
            });
        })();
        
        // Show GM elements and adjust UI based on role
        (function() {
            const userData = JSON.parse(localStorage.getItem('rift_user') || '{}');
            let isGM = userData.isGM === true;
            
            function updateGMUI(gmStatus) {
                // GM FAB
                const gmFab = document.getElementById('gmFab');
                if (gmFab) {
                    gmFab.style.display = gmStatus ? 'flex' : 'none';
                }
                
                // Quick Action Primary - different for GM vs Player
                const quickActionPrimary = document.getElementById('quickActionPrimary');
                if (quickActionPrimary && gmStatus) {
                    // GM: First action is "Neue Session"
                    quickActionPrimary.href = 'sessions.html?create=true';
                    quickActionPrimary.innerHTML = `
                        <div class="quick-action__icon quick-action__icon--red">
                            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <rect x="3" y="4" width="18" height="18" rx="2" ry="2"/>
                                <line x1="16" y1="2" x2="16" y2="6"/>
                                <line x1="8" y1="2" x2="8" y2="6"/>
                                <line x1="3" y1="10" x2="21" y2="10"/>
                                <line x1="12" y1="14" x2="12" y2="18"/>
                                <line x1="10" y1="16" x2="14" y2="16"/>
                            </svg>
                        </div>
                        <span class="quick-action__label">Neue Session</span>
                    `;
                }
                
                console.log('[Hub] User isGM:', gmStatus);
            }
            
            // Initial update from localStorage
            updateGMUI(isGM);
            
            // Check room membership after Firebase is ready
            async function checkRoomMembership() {
                if (typeof RIFT === 'undefined' || !RIFT.rooms || !RIFT.user) {
                    return false; // Services not loaded yet
                }
                
                const roomCode = RIFT.user.getCurrentRoom();
                if (!roomCode) return true; // No room, done
                
                try {
                    const membership = await RIFT.rooms.getCurrentMembership(roomCode);
                    if (membership) {
                        const roomIsGM = membership.isGM === true;
                        if (roomIsGM !== isGM) {
                            console.log('[Hub] Updated isGM from room membership:', roomIsGM);
                            isGM = roomIsGM;
                            updateGMUI(isGM);
                            
                            // Also update localStorage
                            userData.isGM = isGM;
                            localStorage.setItem('rift_user', JSON.stringify(userData));
                        }
                        return true; // Done
                    }
                } catch (e) {
                    console.warn('[Hub] Could not check room membership:', e);
                }
                return false;
            }
            
            // Try to check membership after delays (Firebase init takes time)
            setTimeout(async () => {
                const done = await checkRoomMembership();
                if (!done) setTimeout(checkRoomMembership, 1000);
            }, 500);
        })();
        
        // Random background image
        (function() {
            const bgNum = String(Math.floor(Math.random() * 12) + 1).padStart(3, '0');
            const style = document.createElement('style');
            style.textContent = `.main--hub::before { background-image: url('assets/bg/bg_${bgNum}.jpg'); }`;
            document.head.appendChild(style);
        })();
        
        // News Edit Button Handler
        (function() {
            document.querySelectorAll('.news-card__edit').forEach(editBtn => {
                editBtn.addEventListener('click', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    const newsId = this.dataset.news;
                    window.location.href = `news${newsId}.html?edit=true`;
                });
            });
        })();
        
        // ========================================
        // DYNAMIC NEWS SYSTEM - Featured + List
        // ========================================
        (async function() {
            const newsLayout = document.getElementById('newsLayout');
            const newsLoading = document.getElementById('newsLoading');
            const newsEmpty = document.getElementById('newsEmpty');
            const newsFeatured = document.getElementById('newsFeatured');
            const newsList = document.getElementById('newsList');
            const newsTabs = document.getElementById('newsTabs');
            
            let allArticles = [];
            let currentCategory = 'all';
            
            // Wait for Firebase
            const waitForFirebase = () => new Promise(resolve => {
                const check = () => {
                    if (typeof firebase !== 'undefined' && firebase.firestore && firebase.apps?.length > 0) {
                        resolve();
                    } else {
                        setTimeout(check, 100);
                    }
                };
                check();
            });
            
            await waitForFirebase();
            
            // Category config
            const categoryConfig = {
                update: { label: 'Update', color: '#4ADE80' },
                news: { label: 'News', color: '#F87171' },
                guide: { label: 'Guide', color: '#60A5FA' }
            };
            
            // Format date
            function formatDate(timestamp) {
                const date = timestamp?.toDate?.() || new Date();
                return date.toLocaleDateString('de-DE', { day: '2-digit', month: 'short', year: 'numeric' });
            }
            
            // Render featured article
            function renderFeatured(article) {
                if (!article) {
                    newsFeatured.style.display = 'none';
                    return;
                }
                
                const cat = categoryConfig[article.category] || categoryConfig.news;
                newsFeatured.href = `news.html?id=${article.id}`;
                newsFeatured.style.display = 'flex';
                newsFeatured.innerHTML = `
                    <div class="news-featured__image" style="background-image: url('${article.imageUrl || ''}');">
                        ${!article.imageUrl ? `<div class="news-featured__placeholder">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                                <rect x="3" y="3" width="18" height="18" rx="2"/>
                                <circle cx="8.5" cy="8.5" r="1.5"/>
                                <path d="M21 15l-5-5L5 21"/>
                            </svg>
                        </div>` : ''}
                        <div class="news-featured__overlay"></div>
                    </div>
                    <div class="news-featured__content">
                        <span class="news-featured__category" style="background: ${cat.color}20; color: ${cat.color};">${cat.label}</span>
                        <h3 class="news-featured__title">${article.title || 'Ohne Titel'}</h3>
                        <p class="news-featured__excerpt">${article.excerpt || ''}</p>
                        <div class="news-featured__arrow">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M5 12h14M12 5l7 7-7 7"/>
                            </svg>
                        </div>
                    </div>
                `;
            }
            
            // Render list item
            function createListItem(article) {
                const cat = categoryConfig[article.category] || categoryConfig.news;
                const item = document.createElement('a');
                item.href = `news.html?id=${article.id}`;
                item.className = 'news-list-item';
                item.innerHTML = `
                    <div class="news-list-item__image" style="background-image: url('${article.imageUrl || ''}');">
                        ${!article.imageUrl ? `<div class="news-list-item__placeholder">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                                <rect x="3" y="3" width="18" height="18" rx="2"/>
                                <circle cx="8.5" cy="8.5" r="1.5"/>
                                <path d="M21 15l-5-5L5 21"/>
                            </svg>
                        </div>` : ''}
                    </div>
                    <div class="news-list-item__content">
                        <span class="news-list-item__category" style="color: ${cat.color};">${cat.label}</span>
                        <h4 class="news-list-item__title">${article.title || 'Ohne Titel'}</h4>
                    </div>
                `;
                return item;
            }
            
            // Render all articles based on filter
            function renderArticles() {
                // Filter by category
                const filtered = currentCategory === 'all' 
                    ? allArticles 
                    : allArticles.filter(a => a.category === currentCategory);
                
                if (filtered.length === 0) {
                    newsLayout.style.display = 'none';
                    newsEmpty.style.display = 'flex';
                    return;
                }
                
                newsEmpty.style.display = 'none';
                newsLayout.style.display = 'grid';
                
                // Featured = first article (or first with featured flag)
                const featuredIndex = filtered.findIndex(a => a.featured);
                const featured = featuredIndex >= 0 ? filtered[featuredIndex] : filtered[0];
                const listArticles = filtered.filter(a => a.id !== featured.id).slice(0, 5);
                
                renderFeatured(featured);
                
                // Render list
                newsList.innerHTML = '';
                listArticles.forEach(article => {
                    newsList.appendChild(createListItem(article));
                });
            }
            
            // Tab click handler
            newsTabs?.addEventListener('click', (e) => {
                const tab = e.target.closest('.news-tab');
                if (!tab) return;
                
                // Update active state
                newsTabs.querySelectorAll('.news-tab').forEach(t => t.classList.remove('active'));
                tab.classList.add('active');
                
                // Filter
                currentCategory = tab.dataset.category;
                renderArticles();
            });
            
            // Load news from Firestore
            async function loadNews() {
                try {
                    const db = firebase.firestore();
                    const snapshot = await db.collection('hub_news')
                        .where('published', '==', true)
                        .get();
                    
                    console.log('[Hub] Loaded', snapshot.size, 'news articles');
                    
                    // Hide loading
                    if (newsLoading) newsLoading.style.display = 'none';
                    
                    if (snapshot.empty) {
                        newsEmpty.style.display = 'flex';
                        return;
                    }
                    
                    // Sort by date (newest first)
                    allArticles = snapshot.docs
                        .map(doc => ({ id: doc.id, ...doc.data() }))
                        .sort((a, b) => {
                            const aTime = a.publishedAt?.toMillis?.() || a.createdAt?.toMillis?.() || 0;
                            const bTime = b.publishedAt?.toMillis?.() || b.createdAt?.toMillis?.() || 0;
                            return bTime - aTime;
                        });
                    
                    renderArticles();
                    
                } catch (e) {
                    console.error('[Hub] News load error:', e);
                    if (newsLoading) newsLoading.style.display = 'none';
                    newsEmpty.style.display = 'flex';
                }
            }
            
            // Initialize
            await loadNews();
        })();
        
        // ========================================
        // FEATURE SHOWCASE TABS
        // ========================================
        (function() {
            const showcase = document.getElementById('featureShowcase');
            const panels = document.querySelectorAll('.feature-panel');
            
            showcase?.addEventListener('click', (e) => {
                const tab = e.target.closest('.feature-tab');
                if (!tab) return;
                
                const feature = tab.dataset.feature;
                
                // Update all tabs across all panels
                showcase.querySelectorAll('.feature-tab').forEach(t => {
                    t.classList.toggle('active', t.dataset.feature === feature);
                });
                
                // Update active panel
                panels.forEach(p => {
                    p.classList.toggle('active', p.dataset.panel === feature);
                });
            });
        })();
        
        // Random Character Image for Continue Cards
        (function() {
            const characterImages = {
                'dnd5e': ['char_5e2024_01', 'char_5e2024_02', 'char_5e2024_03', 'char_5e2024_04', 'char_5e2024_05', 'char_5e2024_06', 'char_5e2024_07'],
                'worldsapart': ['char_worldsapart_01', 'char_worldsapart_02', 'char_worldsapart_03', 'char_worldsapart_04', 'char_worldsapart_05', 'char_worldsapart_06', 'char_worldsapart_07'],
                'htbah': ['char_htbah_01', 'char_htbah_02', 'char_htbah_03', 'char_htbah_04', 'char_htbah_05', 'char_htbah_06', 'char_htbah_07'],
                'cyberpunkred': ['char_cyberpunk_01', 'char_cyberpunk_02', 'char_cyberpunk_03', 'char_cyberpunk_04']
            };
            
            // Load images for all continue cards
            document.querySelectorAll('.continue-card[data-rulebook]').forEach(card => {
                const rulebookId = card.dataset.rulebook;
                const images = characterImages[rulebookId];
                
                if (images && images.length > 0) {
                    const randomImg = images[Math.floor(Math.random() * images.length)];
                    const imgEl = card.querySelector('.continue-card__character img');
                    
                    if (imgEl) {
                        imgEl.onload = () => imgEl.classList.add('loaded');
                        imgEl.onerror = () => imgEl.style.display = 'none';
                        imgEl.src = `assets/img/rift_chars/hero_card/${randomImg}.png`;
                    }
                }
            });
        })();
        
        // Session Timer (for active sessions)
        (function() {
            let sessionStartTime = null;
            let timerInterval = null;
            const timerWidget = document.getElementById('sessionTimerWidget');
            const timerValue = document.getElementById('sessionTimerValue');
            const pauseBtn = document.getElementById('pauseSessionBtn');
            const stopBtn = document.getElementById('stopSessionBtn');
            let isPaused = false;
            let pausedTime = 0;
            
            // Check if there's an active session
            const activeSession = JSON.parse(localStorage.getItem('rift_active_session') || 'null');
            if (activeSession && timerWidget) {
                sessionStartTime = new Date(activeSession.startTime);
                pausedTime = activeSession.pausedTime || 0;
                timerWidget.style.display = 'block';
                startTimer();
            }
            
            function startTimer() {
                timerInterval = setInterval(updateTimer, 1000);
            }
            
            function updateTimer() {
                if (isPaused) return;
                const now = new Date();
                const elapsed = now - sessionStartTime - pausedTime;
                const hours = Math.floor(elapsed / (1000 * 60 * 60));
                const mins = Math.floor((elapsed % (1000 * 60 * 60)) / (1000 * 60));
                const secs = Math.floor((elapsed % (1000 * 60)) / 1000);
                if (timerValue) {
                    timerValue.textContent = `${hours}:${String(mins).padStart(2, '0')}:${String(secs).padStart(2, '0')}`;
                }
            }
            
            if (pauseBtn) {
                pauseBtn.addEventListener('click', () => {
                    isPaused = !isPaused;
                    pauseBtn.classList.toggle('active', isPaused);
                });
            }
            
            if (stopBtn) {
                stopBtn.addEventListener('click', () => {
                    if (confirm('Session wirklich beenden?')) {
                        clearInterval(timerInterval);
                        localStorage.removeItem('rift_active_session');
                        if (timerWidget) timerWidget.style.display = 'none';
                    }
                });
            }
        })();
        
        // Service Worker deaktiviert - verursachte Caching-Probleme
        // Falls ein alter SW noch läuft, deregistrieren:
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.getRegistrations().then(registrations => {
                registrations.forEach(registration => {
                    registration.unregister();
                    console.log('[SW] Alte Registrierung entfernt');
                });
            });
        }
        
        // ========================================
        // LOAD DASHBOARD DATA
        // ========================================
        
        // Use var to avoid re-declaration errors on View Transitions
        var firebaseSessions = window._firebaseSessions || [];
        var sessionsUnsubscribe = window._sessionsUnsubscribe || null;
        var heroSkeletonRemoved = window._heroSkeletonRemoved || false;
        
        // Failsafe: Remove hero skeleton after 800ms
        setTimeout(() => {
            if (!heroSkeletonRemoved) {
                const heroLoading = document.getElementById('heroLoading');
                if (heroLoading) heroLoading.style.display = 'none';
                console.log('[Hub] Hero skeleton removed by timeout');
            }
        }, 800);
        
        // Initialize Firebase Sessions for Hub
        let initRetries = 0; // Local counter, resets on each page load
        
        function initFirebaseSessions() {
            if (!currentRoomCode) {
                console.log('[Hub] No room code - using localStorage for sessions');
                window._firebaseSessions = firebaseSessions = JSON.parse(localStorage.getItem('rift_sessions') || '[]');
                loadDashboardData();
                return;
            }
            
            // Wait for RIFT.rooms (max 20 attempts = 2 seconds)
            if (typeof RIFT === 'undefined' || !RIFT.rooms) {
                initRetries++;
                
                if (initRetries > 20) {
                    console.warn('[Hub] RIFT.rooms not available after 2s, loading with empty sessions');
                    window._firebaseSessions = firebaseSessions = [];
                    loadDashboardData();
                    return;
                }
                
                setTimeout(initFirebaseSessions, 100);
                return;
            }
            
            console.log('[Hub] Subscribing to Firebase sessions for room:', currentRoomCode);
            
            // Subscribe to realtime session updates
            let hasReceivedData = false;
            window._sessionsUnsubscribe = sessionsUnsubscribe = RIFT.rooms.subscribeToSessions(currentRoomCode, (sessions) => {
                console.log('[Hub] Firebase sessions update:', sessions.length);
                hasReceivedData = true;
                window._firebaseSessions = firebaseSessions = sessions;
                loadDashboardData();
            });
            
            // Fallback: If no data received after 1 second, load anyway with empty/cached sessions
            setTimeout(() => {
                if (!hasReceivedData) {
                    console.warn('[Hub] No Firebase sessions received after 1s, loading with cache');
                    window._firebaseSessions = firebaseSessions = JSON.parse(localStorage.getItem('rift_sessions') || '[]');
                    loadDashboardData();
                }
            }, 1000);
        }
        
        // Start quickly
        setTimeout(initFirebaseSessions, 100);
        
        // Cleanup
        window.addEventListener('beforeunload', () => {
            if (sessionsUnsubscribe) sessionsUnsubscribe();
        });
        
        async function loadDashboardData() {
            // Hide loading skeleton
            const heroLoading = document.getElementById('heroLoading');
            if (heroLoading) heroLoading.style.display = 'none';
            heroSkeletonRemoved = true;
            window._heroSkeletonRemoved = true;
            
            // Use Firebase sessions (already filtered by room)
            const sessions = firebaseSessions;
            
            // Use CharacterStorage format (object) and convert to array
            const characterData = JSON.parse(localStorage.getItem('rift_characters') || '{}');
            const characters = Object.values(characterData);
            const now = new Date();
            const currentUserId = window.currentUser?.uid || null;
            
            // Check data state
            const hasCharacters = characters.length > 0;
            const hasSessions = sessions.filter(s => s.status !== 'ended').length > 0;
            
            console.log('[Hub] Dashboard data: sessions=', sessions.length, 'characters=', characters.length);
            
            // Status Banner (4 Varianten)
            const statusBanner = document.getElementById('statusBanner');
            const statusIcon = document.getElementById('statusIcon');
            const statusTitle = document.getElementById('statusTitle');
            const statusText = document.getElementById('statusText');
            const statusActions = document.getElementById('statusActions');
            const continueContainer = document.getElementById('continueCardsContainer');
            const nextSessionCard = document.getElementById('nextSessionCard');
            
            // Banner-Konfiguration basierend auf Zustand
            const bannerConfig = {
                // 1. Keine Session, kein Charakter
                noSessionNoChar: {
                    icon: `<svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                        <path d="M12 2L2 7l10 5 10-5-10-5z"/>
                        <path d="M2 17l10 5 10-5"/>
                        <path d="M2 12l10 5 10-5"/>
                    </svg>`,
                    title: 'Willkommen bei RIFT!',
                    text: 'Erstelle deinen ersten Charakter oder plane eine Session um loszulegen.',
                    actions: `
                        <a href="/sheet" class="status-banner__btn status-banner__btn--primary">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 5v14M5 12h14"/></svg>
                            Charakter erstellen
                        </a>
                        <a href="/sessions" class="status-banner__btn status-banner__btn--secondary">Session planen</a>
                    `
                },
                // 2. Keine Session, aber Charakter vorhanden
                noSessionHasChar: {
                    icon: `<svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                        <rect x="3" y="4" width="18" height="18" rx="2" ry="2"/>
                        <line x1="16" y1="2" x2="16" y2="6"/>
                        <line x1="8" y1="2" x2="8" y2="6"/>
                        <line x1="3" y1="10" x2="21" y2="10"/>
                    </svg>`,
                    title: 'Bereit für ein Abenteuer?',
                    text: `Du hast ${characters.length} Charakter${characters.length > 1 ? 'e' : ''}. Plane jetzt deine erste Session!`,
                    actions: `
                        <a href="/sessions" class="status-banner__btn status-banner__btn--primary">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 5v14M5 12h14"/></svg>
                            Session planen
                        </a>
                    `
                },
                // 3. Session vorhanden, aber kein Charakter
                hasSessionNoChar: {
                    icon: `<svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                        <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/>
                        <circle cx="12" cy="7" r="4"/>
                    </svg>`,
                    title: 'Session geplant!',
                    text: 'Erstelle jetzt einen Charakter, um mitzuspielen.',
                    actions: `
                        <a href="/sheet" class="status-banner__btn status-banner__btn--primary">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 5v14M5 12h14"/></svg>
                            Charakter erstellen
                        </a>
                    `
                }
                // 4. Beides vorhanden → Banner wird nicht angezeigt
            };
            
            // Bestimme welche Variante angezeigt werden soll
            let currentConfig = null;
            if (!hasSessions && !hasCharacters) {
                currentConfig = bannerConfig.noSessionNoChar;
            } else if (!hasSessions && hasCharacters) {
                currentConfig = bannerConfig.noSessionHasChar;
            }
            // hasSessionNoChar wird jetzt von der Character Hero Card Empty State behandelt
            // Wenn beides vorhanden → kein Banner
            
            if (currentConfig) {
                statusBanner.style.display = 'flex';
                statusIcon.innerHTML = currentConfig.icon;
                statusTitle.textContent = currentConfig.title;
                statusText.textContent = currentConfig.text;
                statusActions.innerHTML = currentConfig.actions;
            } else {
                statusBanner.style.display = 'none';
            }
            
            // Update Quick Action Bar based on session status
            const quickActionPrimary = document.getElementById('quickActionPrimary');
            if (quickActionPrimary) {
                if (!hasSessions) {
                    // Keine Session - zeige "Session beitreten"
                    quickActionPrimary.href = 'sessions.html';
                    quickActionPrimary.querySelector('.quick-action__icon').innerHTML = `
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M15 3h4a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2h-4"/>
                            <polyline points="10 17 15 12 10 7"/>
                            <line x1="15" y1="12" x2="3" y2="12"/>
                        </svg>`;
                    quickActionPrimary.querySelector('.quick-action__label').textContent = 'Session beitreten';
                }
            }
                
                // Find next upcoming session
                const upcomingSessions = sessions.filter(s => {
                    const sessionDate = new Date(s.date + 'T' + (s.time || '00:00'));
                    return sessionDate >= now && s.status !== 'ended';
                }).sort((a, b) => new Date(a.date) - new Date(b.date));
                
                // Ruleset Configuration
                const rulesetConfig = {
                    '5e2024': { name: 'D&D 5E', class: '5e', icon: 'ruleset_5e_2024.svg' },
                    'worldsapart': { name: 'WORLDS APART', class: 'worldsapart', icon: 'ruleset_worldsapart.svg' },
                    'htbah': { name: 'HTBAH', class: 'htbah', icon: 'ruleset_htbah.svg' },
                    'cyberpunk': { name: 'CYBERPUNK', class: 'cyberpunk', icon: 'ruleset_cyberpunkred.svg' }
                };
                
                const weekdays = ['SO', 'MO', 'DI', 'MI', 'DO', 'FR', 'SA'];
                const months = ['Jan', 'Feb', 'Mär', 'Apr', 'Mai', 'Jun', 'Jul', 'Aug', 'Sep', 'Okt', 'Nov', 'Dez'];
                
                // ============================================
                // CHARACTER HERO CARD - Always show if character exists
                // ============================================
                const heroCardsContainer = document.getElementById('heroCardsContainer');
                const characterHeroCard = document.getElementById('characterHeroCard');
                const sessionHeroCard = document.getElementById('sessionHeroCard');
                
                // Filter to only show non-ended sessions
                const activeSessions = sessions.filter(s => s.status !== 'ended');
                const heroSession = activeSessions.length > 0 ? activeSessions[0] : null;
                
                // Determine ruleset (from session or from character)
                let ruleset = rulesetConfig['worldsapart']; // default
                if (heroSession) {
                    ruleset = rulesetConfig[heroSession.ruleset] || rulesetConfig['worldsapart'];
                } else if (characters.length > 0) {
                    ruleset = rulesetConfig[characters[0].ruleset] || rulesetConfig['worldsapart'];
                }
                
                // Find Main Character
                let selectedChar = null;
                
                // 1. Try Main Character from CharacterStorage (for session ruleset or any)
                if (typeof CharacterStorage !== 'undefined') {
                    if (heroSession) {
                        selectedChar = CharacterStorage.getMainCharacter(heroSession.ruleset);
                    }
                    if (!selectedChar && characters.length > 0) {
                        // Try to get main character for first character's ruleset, or just use first character
                        const firstRuleset = characters[0].ruleset || 'worldsapart';
                        selectedChar = CharacterStorage.getMainCharacter(firstRuleset);
                        if (!selectedChar) {
                            selectedChar = characters[0];
                        }
                    }
                    console.log('[Hub] Main character:', selectedChar?.name || 'none');
                }
                
                // 2. Fallback: session's selected character
                if (!selectedChar && heroSession?.selectedCharacterId) {
                    selectedChar = characters.find(c => c.id === heroSession.selectedCharacterId);
                }
                
                // 3. Fallback: any character with matching ruleset
                if (!selectedChar && heroSession) {
                    selectedChar = characters.find(c => c.ruleset === heroSession.ruleset);
                }
                
                // 4. Last fallback: first character
                if (!selectedChar && characters.length > 0) {
                    selectedChar = characters[0];
                }
                
                // Show hero cards container if we have EITHER character OR session
                if (selectedChar || heroSession) {
                    heroCardsContainer.style.display = 'flex';
                }
                
                // ============================================
                // CHARACTER HERO CARD (left side) - Show if character exists
                // ============================================
                if (selectedChar) {
                    const charRuleset = rulesetConfig[selectedChar.ruleset] || ruleset;
                    
                    characterHeroCard.style.display = 'flex';
                    characterHeroCard.href = `sheet-${selectedChar.ruleset || 'worldsapart'}.html?id=${selectedChar.id}`;
                    characterHeroCard.className = `character-hero character-hero--${charRuleset.class}`;
                    
                    // Portrait
                    const portraitEl = document.getElementById('characterHeroPortrait');
                    if (selectedChar.portrait) {
                        // Check if it's a base64 image or a preset name
                        const portraitSrc = selectedChar.portrait.startsWith('data:') 
                            ? selectedChar.portrait 
                            : `assets/img/rift_chars/hero_card/${selectedChar.portrait}.png`;
                        portraitEl.innerHTML = `<img src="${portraitSrc}" alt="${selectedChar.name}" class="character-hero__portrait-img">`;
                    } else {
                        const initial = (selectedChar.name || 'C').charAt(0).toUpperCase();
                        portraitEl.innerHTML = `
                            <div class="character-hero__portrait-placeholder">
                                <span class="character-hero__portrait-initial">${initial}</span>
                            </div>`;
                    }
                    
                    // Name
                    document.getElementById('characterHeroName').textContent = selectedChar.name || 'Charakter';
                    
                    // Class
                    const classEl = document.getElementById('characterHeroClass');
                    if (selectedChar.class || selectedChar.role) {
                        classEl.textContent = selectedChar.class || selectedChar.role || '';
                        classEl.style.display = 'inline';
                    } else {
                        classEl.style.display = 'none';
                    }
                    
                    // LP & Moral Stats - Load from Room Characters (Multi-Char Support)
                    const lpBarEl = document.getElementById('characterHeroLpBar');
                    const lpValueEl = document.getElementById('characterHeroLpValue');
                    const moralBarEl = document.getElementById('characterHeroMoralBar');
                    const moralValueEl = document.getElementById('characterHeroMoralValue');
                    
                    const userId = window.currentUser?.uid || null;
                    const roomCode = currentRoomCode;
                    
                    console.log('[Hub] Loading character stats - roomCode:', roomCode, 'userId:', userId);
                    
                    let lpValue = null;
                    let moralValue = null;
                    let lpMax = 100;
                    let moralMax = 100;
                    
                    // Try Room Characters first (Firestore) - Multi-Char Ready!
                    if (roomCode && userId && typeof RIFT !== 'undefined' && RIFT.rooms?.getActiveCharacter) {
                        try {
                            const activeChar = await RIFT.rooms.getActiveCharacter(roomCode, userId);
                            console.log('[Hub] Active character from Room:', activeChar ? activeChar.name : 'none');
                            
                            if (activeChar && activeChar.data) {
                                // Worlds Apart structure: data.status.health/moral
                                lpValue = activeChar.data.status?.health ?? activeChar.data.health?.current ?? null;
                                moralValue = activeChar.data.status?.moral ?? activeChar.data.moral?.current ?? null;
                                
                                // Also check for max values
                                lpMax = activeChar.data.health?.max || 100;
                                moralMax = activeChar.data.moral?.max || 100;
                                
                                console.log('[Hub] Room Character stats:', { lpValue, moralValue, lpMax, moralMax });
                            }
                        } catch (e) {
                            console.warn('[Hub] Room Character error:', e);
                        }
                    }
                    
                    // Fallback 1: Try selected character's data directly
                    if (lpValue === null && selectedChar?.data) {
                        lpValue = selectedChar.data.status?.health ?? selectedChar.data.health?.current ?? null;
                        moralValue = selectedChar.data.status?.moral ?? selectedChar.data.moral?.current ?? null;
                        console.log('[Hub] Selected char stats:', { lpValue, moralValue });
                    }
                    
                    // Fallback 2: Try localStorage (worldsapart_character_v5)
                    if (lpValue === null) {
                        try {
                            const localData = JSON.parse(localStorage.getItem('worldsapart_character_v5') || 'null');
                            if (localData) {
                                lpValue = localData.health?.current ?? null;
                                moralValue = localData.moral?.current ?? null;
                                lpMax = localData.health?.max || 100;
                                moralMax = localData.moral?.max || 100;
                                console.log('[Hub] LocalStorage stats:', { lpValue, moralValue });
                            }
                        } catch (e) {
                            console.warn('[Hub] LocalStorage error:', e);
                        }
                    }
                    
                    // Update UI
                    if (lpValue !== null) {
                        const lpPercent = Math.min(100, Math.max(0, (lpValue / lpMax) * 100));
                        lpBarEl.style.width = `${lpPercent}%`;
                        lpValueEl.textContent = `${lpValue}`;
                    }
                    
                    if (moralValue !== null) {
                        const moralPercent = Math.min(100, Math.max(0, (moralValue / moralMax) * 100));
                        moralBarEl.style.width = `${moralPercent}%`;
                        moralValueEl.textContent = `${moralValue}`;
                    }
                } else if (heroSession) {
                    // No character but have session - show empty state prompting to create
                    characterHeroCard.style.display = 'flex';
                    characterHeroCard.href = 'sheet.html';
                    characterHeroCard.className = `character-hero character-hero--${ruleset.class} character-hero--empty`;
                    
                    // Empty Portrait with icon
                    const portraitEl = document.getElementById('characterHeroPortrait');
                    portraitEl.innerHTML = `
                        <div class="character-hero__portrait-placeholder">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                                <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/>
                                <circle cx="12" cy="7" r="4"/>
                            </svg>
                        </div>`;
                    
                    // Empty State Text
                    document.getElementById('characterHeroName').textContent = 'Charakter erstellen';
                    
                    const classEl = document.getElementById('characterHeroClass');
                    classEl.textContent = 'Um mitzuspielen';
                    classEl.style.display = 'inline';
                    
                    // Hide stats, show CTA hint
                    document.getElementById('characterHeroStats').innerHTML = `
                        <div class="character-hero__cta">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <line x1="12" y1="5" x2="12" y2="19"/>
                                <line x1="5" y1="12" x2="19" y2="12"/>
                            </svg>
                            <span>Jetzt erstellen</span>
                        </div>
                    `;
                } else {
                    // No session and no character - hide character card
                    characterHeroCard.style.display = 'none';
                }
                
                // ============================================
                // SESSION HERO CARD (right side) - Only if active session exists
                // ============================================
                if (heroSession) {
                    const sessionHeroCover = document.getElementById('sessionHeroCover');
                    
                    // Show and configure the card
                    sessionHeroCard.style.display = 'flex';
                    sessionHeroCard.href = `session.html?id=${heroSession.id}`;
                    sessionHeroCard.className = `session-hero session-hero--${ruleset.class}`;
                    
                    // Cover Image
                    if (heroSession.coverUrl) {
                        sessionHeroCover.innerHTML = `<img src="${heroSession.coverUrl}" alt="${heroSession.name}" class="session-hero__cover-img">`;
                    } else {
                        sessionHeroCover.innerHTML = `
                            <div class="session-hero__cover-placeholder">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                                    <rect x="3" y="3" width="18" height="18" rx="2"/>
                                    <circle cx="8.5" cy="8.5" r="1.5"/>
                                    <path d="M21 15l-5-5L5 21"/>
                                </svg>
                            </div>`;
                    }
                    
                    // Title & Subtitle
                    document.getElementById('sessionHeroTitle').textContent = heroSession.name || 'Unbenannte Session';
                    document.getElementById('sessionHeroSubtitle').textContent = heroSession.subtitle || '';
                    document.getElementById('sessionHeroSubtitle').style.display = heroSession.subtitle ? 'block' : 'none';
                    
                    // GM Badge (show if user is GM)
                    const gmBadge = document.getElementById('sessionHeroGmBadge');
                    if (heroSession.isGM || heroSession.gmId === currentUserId) {
                        gmBadge.style.display = 'flex';
                    } else {
                        gmBadge.style.display = 'none';
                    }
                    
                    // Ruleset
                    const rulesetEl = document.getElementById('sessionHeroRuleset');
                    rulesetEl.innerHTML = `
                        <img src="assets/img/rulesets/${ruleset.icon}" alt="${ruleset.name}">
                        <span>${ruleset.name}</span>`;
                    
                    // Session Number
                    const sessionNum = heroSession.currentSession || 1;
                    const totalSessions = heroSession.sessionCount || '?';
                    document.getElementById('sessionHeroSessionNum').textContent = `Session ${sessionNum}/${totalSessions}`;
                    
                    // Tags (capitalize via CSS)
                    const tagsContainer = document.getElementById('sessionHeroTags');
                    if (heroSession.tags && heroSession.tags.length > 0) {
                        tagsContainer.innerHTML = heroSession.tags.slice(0, 3).map(tag => 
                            `<span class="session-hero__tag">${tag}</span>`
                        ).join('');
                        tagsContainer.style.display = 'flex';
                    } else {
                        tagsContainer.style.display = 'none';
                    }
                    
                    // Calendar / Date
                    const dateBox = document.getElementById('sessionHeroDateBox');
                    const noDate = document.getElementById('sessionHeroNoDate');
                    const countdown = document.getElementById('sessionHeroCountdown');
                    const timeEl = document.getElementById('sessionHeroTime');
                    
                    if (heroSession.date) {
                        const sessionDate = new Date(heroSession.date);
                        dateBox.style.display = 'flex';
                        noDate.style.display = 'none';
                        countdown.style.display = 'flex';
                        timeEl.style.display = 'block';
                        
                        document.getElementById('sessionHeroDay').textContent = weekdays[sessionDate.getDay()];
                        document.getElementById('sessionHeroNum').textContent = String(sessionDate.getDate()).padStart(2, '0');
                        document.getElementById('sessionHeroMonth').textContent = months[sessionDate.getMonth()];
                        document.getElementById('sessionHeroTime').textContent = `${heroSession.time || '20:00'} Uhr`;
                        
                        // Countdown
                        const sessionDateTime = new Date(heroSession.date + 'T' + (heroSession.time || '20:00'));
                        updateHeroCountdown(sessionDateTime);
                        setInterval(() => updateHeroCountdown(sessionDateTime), 60000);
                    } else {
                        dateBox.style.display = 'none';
                        noDate.style.display = 'flex';
                        countdown.style.display = 'none';
                        timeEl.style.display = 'none';
                    }
                    
                    // Hide old continue cards container
                    continueContainer.style.display = 'none';
                    
                    // Hide old next session card (we have the unified hero now)
                    nextSessionCard.style.display = 'none';
                } else {
                    // No active session - hide session hero card
                    sessionHeroCard.style.display = 'none';
                }
                
                // ============================================
                // HERO PANELS - Character + Session
                // ============================================
                const heroPanels = document.getElementById('heroPanels');
                const characterPanel = document.getElementById('characterPanel');
                const adventurePanel = document.getElementById('adventurePanel');
                
                if ((selectedChar || heroSession) && heroPanels) {
                    // Show Hero Panels container, hide legacy
                    heroPanels.style.display = 'flex';
                    heroCardsContainer.style.display = 'none';
                    
                    // ─────────────────────────────────────────
                    // CHARACTER PANEL
                    // ─────────────────────────────────────────
                    if (selectedChar && characterPanel) {
                        characterPanel.style.display = 'flex';
                        characterPanel.classList.remove('character-panel--empty');
                        characterPanel.className = `character-panel character-panel--${ruleset.class}`;
                        characterPanel.href = `sheet-${selectedChar.ruleset || 'worldsapart'}.html?id=${selectedChar.id}`;
                        
                        // Portrait
                        const portraitContainer = document.getElementById('charPanelPortrait');
                        if (selectedChar.portrait) {
                            const portraitSrc = selectedChar.portrait.startsWith('data:') 
                                ? selectedChar.portrait 
                                : `assets/img/rift_chars/hero_card/${selectedChar.portrait}.png`;
                            portraitContainer.innerHTML = `<img src="${portraitSrc}" alt="${selectedChar.name}">`;
                        } else {
                            const initial = (selectedChar.name || 'C').charAt(0).toUpperCase();
                            portraitContainer.innerHTML = `<span class="character-panel__portrait-placeholder">${initial}</span>`;
                        }
                        
                        // Name
                        document.getElementById('charPanelName').textContent = selectedChar.name || 'Charakter';
                        
                        // Get character data - SIMPLIFIED: Always try localStorage first for Worlds Apart
                        let charData = null;
                        
                        // Source 1: localStorage (most reliable for local characters)
                        try {
                            const localData = localStorage.getItem('worldsapart_character_v5');
                            if (localData) {
                                charData = JSON.parse(localData);
                                console.log('[Hub] CharPanel: Loaded from localStorage:', charData);
                            }
                        } catch (e) {
                            console.warn('[Hub] CharPanel: localStorage error:', e);
                        }
                        
                        // Source 2: selectedChar.data as fallback
                        if (!charData && selectedChar.data) {
                            charData = selectedChar.data;
                            console.log('[Hub] CharPanel: Using selectedChar.data');
                        }
                        
                        // Source 3: Room Character if in a room
                        if (!charData && roomCode && userId && typeof RIFT !== 'undefined' && RIFT.rooms?.getActiveCharacter) {
                            try {
                                const activeChar = await RIFT.rooms.getActiveCharacter(roomCode, userId);
                                if (activeChar && activeChar.data) {
                                    charData = activeChar.data;
                                    console.log('[Hub] CharPanel: Using Room Character data');
                                }
                            } catch (e) {
                                console.warn('[Hub] CharPanel: Room error:', e);
                            }
                        }
                        
                        if (!charData) {
                            console.warn('[Hub] CharPanel: No character data found!');
                            charData = {};
                        }
                        
                        // Meta: Geschlecht, Alter, Rolle, Element
                        const genderEl = document.getElementById('charPanelGender');
                        const ageEl = document.getElementById('charPanelAge');
                        const roleEl = document.getElementById('charPanelRole');
                        const elementEl = document.getElementById('charPanelElement');
                        
                        // Geschlecht
                        const genderValue = charData.gender;
                        if (genderValue) {
                            genderEl.textContent = genderValue;
                            genderEl.style.display = 'inline-flex';
                        } else {
                            genderEl.style.display = 'none';
                        }
                        
                        // Alter
                        const ageValue = charData.age;
                        if (ageValue) {
                            ageEl.textContent = `${ageValue} Jahre`;
                            ageEl.style.display = 'inline-flex';
                        } else {
                            ageEl.style.display = 'none';
                        }
                        
                        // Rolle
                        const roleText = charData.role || selectedChar.role || selectedChar.class || '';
                        if (roleText) {
                            roleEl.textContent = roleText;
                            roleEl.style.display = 'inline-flex';
                        } else {
                            roleEl.style.display = 'none';
                        }
                        
                        // Fokus Element (Worlds Apart spezifisch) mit Icon und Farbe
                        const fokusType = charData.fokus?.type;
                        if (fokusType) {
                            // Fokus Konfiguration: Name, Icon-Datei, Farbe
                            const fokusConfig = {
                                'fire': { name: 'Feuer', icon: 'fire', color: '#f97316' },
                                'water': { name: 'Wasser', icon: 'water', color: '#3b82f6' },
                                'wind': { name: 'Wind', icon: 'wind', color: '#06b6d4' },
                                'earth': { name: 'Erde', icon: 'earth', color: '#84cc16' },
                                'lightning': { name: 'Blitz', icon: 'lightning', color: '#eab308' },
                                'room': { name: 'Raum', icon: 'room', color: '#a855f7' },
                                'illusion': { name: 'Illusion', icon: 'illusion', color: '#ec4899' },
                                'shadow': { name: 'Schatten', icon: 'shadow', color: '#6b7280' },
                                'time': { name: 'Zeit', icon: 'time', color: '#f59e0b' },
                                'poison': { name: 'Gift', icon: 'poison', color: '#22c55e' },
                                'sound': { name: 'Schall', icon: 'sound', color: '#14b8a6' }
                            };
                            
                            const fokus = fokusConfig[fokusType] || { 
                                name: fokusType.charAt(0).toUpperCase() + fokusType.slice(1), 
                                icon: fokusType, 
                                color: '#a78bfa' 
                            };
                            
                            // Icon setzen
                            const fokusIcon = document.getElementById('charPanelFokusIcon');
                            fokusIcon.src = `assets/icons/icon_focus_${fokus.icon}.png`;
                            fokusIcon.alt = fokus.name;
                            
                            // Name setzen
                            elementEl.querySelector('span').textContent = fokus.name;
                            
                            // Farbe setzen
                            elementEl.style.background = `${fokus.color}20`;
                            elementEl.style.color = fokus.color;
                            
                            elementEl.style.display = 'inline-flex';
                        } else {
                            elementEl.style.display = 'none';
                        }
                        
                        // Attribute: KRF, GES, ZÄH, VER, PRÄ
                        const attributesContainer = document.getElementById('charPanelAttributes');
                        if (charData.attributes) {
                            document.getElementById('charPanelAttrKrf').textContent = charData.attributes.power || 0;
                            document.getElementById('charPanelAttrGes').textContent = charData.attributes.agility || 0;
                            document.getElementById('charPanelAttrZaeh').textContent = charData.attributes.endurance || 0;
                            document.getElementById('charPanelAttrVer').textContent = charData.attributes.mind || 0;
                            document.getElementById('charPanelAttrPrae').textContent = charData.attributes.presence || 0;
                            attributesContainer.style.display = 'flex';
                        } else {
                            attributesContainer.style.display = 'none';
                        }
                        
                        // Stats: LP, Moral, Resonanz
                        const statsContainer = document.getElementById('charPanelStats');
                        
                        // LP
                        const lpCurrent = charData.health?.current ?? null;
                        const lpMax = charData.health?.max || 100;
                        if (lpCurrent !== null) {
                            const lpPercent = Math.min(100, Math.max(0, (lpCurrent / lpMax) * 100));
                            document.getElementById('charPanelHp').textContent = lpCurrent;
                            document.getElementById('charPanelHpBar').style.width = `${lpPercent}%`;
                        }
                        
                        // Moral
                        const moralCurrent = charData.moral?.current ?? null;
                        const moralMax = charData.moral?.max || 100;
                        if (moralCurrent !== null) {
                            const moralPercent = Math.min(100, Math.max(0, (moralCurrent / moralMax) * 100));
                            document.getElementById('charPanelMp').textContent = moralCurrent;
                            document.getElementById('charPanelMpBar').style.width = `${moralPercent}%`;
                        }
                        
                        // Resonanz (Worlds Apart) - 10 + KRF * PRÄ
                        const resonanzStat = document.getElementById('charPanelResonanzStat');
                        if (charData.attributes) {
                            const power = charData.attributes.power || 0;
                            const presence = charData.attributes.presence || 0;
                            const resonanzValue = 10 + (power * presence);
                            const resonanzMax = 100; // Für die Bar
                            const resonanzPercent = Math.min(100, (resonanzValue / resonanzMax) * 100);
                            document.getElementById('charPanelResonanz').textContent = resonanzValue;
                            document.getElementById('charPanelResonanzBar').style.width = `${resonanzPercent}%`;
                            resonanzStat.style.display = 'flex';
                        } else {
                            resonanzStat.style.display = 'none';
                        }
                        
                        statsContainer.style.display = 'flex';
                        
                    } else if (characterPanel) {
                        // Empty State - CTA to create character (linksbündig)
                        characterPanel.style.display = 'flex';
                        characterPanel.classList.add('character-panel--empty');
                        characterPanel.href = 'sheet.html';
                        
                        document.getElementById('charPanelPortrait').innerHTML = `
                            <span class="character-panel__portrait-placeholder">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" width="48" height="48">
                                    <path d="M12 5v14M5 12h14"/>
                                </svg>
                            </span>`;
                        
                        const contentEl = document.querySelector('.character-panel__content');
                        contentEl.innerHTML = `
                            <span class="character-panel__label">Dein Charakter</span>
                            <h3 class="character-panel__name">Charakter erstellen</h3>
                            <p class="character-panel__subtitle">Erwecke deinen Helden zum Leben</p>
                            <span class="character-panel__cta-btn">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="16" height="16">
                                    <path d="M12 5v14M5 12h14"/>
                                </svg>
                                Jetzt erstellen
                            </span>
                        `;
                    }
                    
                    // ─────────────────────────────────────────
                    // SESSION PANEL (Adventure Panel)
                    // ─────────────────────────────────────────
                    if (heroSession && adventurePanel) {
                        adventurePanel.style.display = 'flex';
                        adventurePanel.classList.remove('adventure-panel--empty');
                        adventurePanel.className = `adventure-panel adventure-panel--${ruleset.class}`;
                        adventurePanel.href = `session.html?id=${heroSession.id}`;
                        
                        // Cover Image
                        const coverContainer = document.getElementById('adventureCover');
                        if (heroSession.coverUrl) {
                            coverContainer.innerHTML = `<img src="${heroSession.coverUrl}" alt="${heroSession.name}">`;
                        } else {
                            coverContainer.innerHTML = `
                                <div class="adventure-panel__cover-placeholder">
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                                        <rect x="3" y="3" width="18" height="18" rx="2"/>
                                        <circle cx="8.5" cy="8.5" r="1.5"/>
                                        <path d="M21 15l-5-5L5 21"/>
                                    </svg>
                                </div>`;
                        }
                        
                        // Title & Subtitle
                        document.getElementById('adventureTitle').textContent = heroSession.name || 'Unbenannte Session';
                        document.getElementById('adventureSubtitle').textContent = heroSession.subtitle || '';
                        
                        // Ruleset
                        const rulesetIcon = document.getElementById('adventureRulesetIcon');
                        const rulesetName = document.getElementById('adventureRulesetName');
                        if (rulesetIcon) rulesetIcon.src = `assets/img/rulesets/${ruleset.icon}`;
                        if (rulesetName) rulesetName.textContent = ruleset.name;
                        
                        // Session Number
                        const sessionNum = heroSession.currentSession || 1;
                        const totalSessions = heroSession.sessionCount || '?';
                        document.getElementById('adventureSessionNum').textContent = `Session ${sessionNum}/${totalSessions}`;
                        
                        // GM Badge
                        const gmBadge = document.getElementById('adventureGmBadge');
                        if (heroSession.isGM || heroSession.gmId === currentUserId) {
                            gmBadge.style.display = 'inline-flex';
                        } else {
                            gmBadge.style.display = 'none';
                        }
                        
                        // Tags
                        const tagsContainer = document.getElementById('adventureTags');
                        if (heroSession.tags && heroSession.tags.length > 0) {
                            tagsContainer.innerHTML = heroSession.tags.slice(0, 4).map(tag => 
                                `<span class="adventure-panel__tag">${tag}</span>`
                            ).join('');
                            tagsContainer.style.display = 'flex';
                        } else {
                            tagsContainer.style.display = 'none';
                        }
                        
                        // Schedule / Date
                        const scheduleContainer = document.getElementById('adventureSchedule');
                        const dateText = document.getElementById('adventureDateText');
                        const countdown = document.getElementById('adventureCountdown');
                        
                        if (heroSession.date) {
                            scheduleContainer.style.display = 'flex';
                            const sessionDate = new Date(heroSession.date);
                            const dayName = weekdays[sessionDate.getDay()];
                            const dateNum = sessionDate.getDate();
                            const monthName = months[sessionDate.getMonth()];
                            const time = heroSession.time || '20:00';
                            
                            dateText.textContent = `${dayName}, ${dateNum}. ${monthName} · ${time} Uhr`;
                            
                            // Countdown
                            const sessionDateTime = new Date(heroSession.date + 'T' + time);
                            countdown.style.display = 'flex';
                            
                            function updateAdventureCountdown() {
                                const now = new Date();
                                const diff = sessionDateTime - now;
                                
                                if (diff <= 0) {
                                    document.getElementById('adventureCountdownDays').textContent = '0';
                                    document.getElementById('adventureCountdownHours').textContent = '0';
                                    document.getElementById('adventureCountdownMins').textContent = '0';
                                    return;
                                }
                                
                                const days = Math.floor(diff / (1000 * 60 * 60 * 24));
                                const hours = Math.floor((diff % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
                                const mins = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
                                
                                document.getElementById('adventureCountdownDays').textContent = days;
                                document.getElementById('adventureCountdownHours').textContent = hours;
                                document.getElementById('adventureCountdownMins').textContent = mins;
                            }
                            
                            updateAdventureCountdown();
                            setInterval(updateAdventureCountdown, 60000);
                        } else {
                            dateText.textContent = 'Keine Session geplant';
                            countdown.style.display = 'none';
                        }
                        
                    } else if (adventurePanel) {
                        // Empty State - CTA to create/join session
                        adventurePanel.style.display = 'flex';
                        adventurePanel.classList.add('adventure-panel--empty');
                        adventurePanel.href = 'sessions.html';
                        
                        document.getElementById('adventureCover').style.display = 'none';
                        document.getElementById('adventureTitle').textContent = 'Session starten';
                        document.getElementById('adventureSubtitle').textContent = 'Erstelle eine neue Session oder tritt einer bestehenden bei.';
                        document.getElementById('adventureRuleset').style.display = 'none';
                        document.getElementById('adventureSessionNum').style.display = 'none';
                        document.getElementById('adventureSchedule').style.display = 'none';
                        document.getElementById('adventureTags').style.display = 'none';
                    }
                    
                } else if (heroPanels) {
                    heroPanels.style.display = 'none';
                }
                
                // Fallback: Show old next session card if we have upcoming but no active sessions and no character
                if (!heroSession && !selectedChar && upcomingSessions.length > 0) {
                    const next = upcomingSessions[0];
                    const date = new Date(next.date);
                    
                    nextSessionCard.style.display = 'flex';
                    nextSessionCard.href = `session.html?id=${next.id}`;
                    document.getElementById('nextSessionDay').textContent = weekdays[date.getDay()];
                    document.getElementById('nextSessionNum').textContent = String(date.getDate()).padStart(2, '0');
                    document.getElementById('nextSessionMonth').textContent = months[date.getMonth()];
                    document.getElementById('nextSessionTime').textContent = `${next.time || '20:00'} Uhr`;
                    
                    // Countdown
                    const sessionDateTime = new Date(next.date + 'T' + (next.time || '20:00'));
                    updateCountdown(sessionDateTime);
                    setInterval(() => updateCountdown(sessionDateTime), 60000);
                }
            
            // Sessions Widget
            const recentSessions = sessions.slice(-3).reverse();
            const sessionsList = document.getElementById('recentSessionsList');
            const sessionsEmpty = document.getElementById('sessionsEmpty');
            const sessionsFooter = document.getElementById('sessionsFooter');
            
            if (recentSessions.length > 0) {
                sessionsEmpty.style.display = 'none';
                sessionsFooter.style.display = 'block';
                sessionsList.innerHTML = recentSessions.map(renderSessionItem).join('');
            } else {
                sessionsEmpty.style.display = 'flex';
                sessionsFooter.style.display = 'none';
            }
            
            // Characters Widget
            const charactersList = document.getElementById('charactersList');
            const charactersEmpty = document.getElementById('charactersEmpty');
            const charactersFooter = document.getElementById('charactersFooter');
            
            if (characters.length > 0) {
                charactersEmpty.style.display = 'none';
                charactersFooter.style.display = 'block';
                
                // Sort: main characters first
                const sortedChars = [...characters].sort((a, b) => {
                    const aIsMain = typeof CharacterStorage !== 'undefined' && CharacterStorage.isMainCharacter(a.id);
                    const bIsMain = typeof CharacterStorage !== 'undefined' && CharacterStorage.isMainCharacter(b.id);
                    if (aIsMain && !bIsMain) return -1;
                    if (!aIsMain && bIsMain) return 1;
                    return 0;
                });
                
                charactersList.innerHTML = sortedChars.slice(0, 3).map(renderCharacterItem).join('');
            } else {
                charactersEmpty.style.display = 'flex';
                charactersFooter.style.display = 'none';
            }
        }
        
        function updateCountdown(targetDate) {
            const now = new Date();
            const diff = targetDate - now;
            
            if (diff <= 0) {
                document.getElementById('countdownDays').textContent = '0';
                document.getElementById('countdownHours').textContent = '0';
                document.getElementById('countdownMins').textContent = '0';
                return;
            }
            
            const days = Math.floor(diff / (1000 * 60 * 60 * 24));
            const hours = Math.floor((diff % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
            const mins = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
            
            document.getElementById('countdownDays').textContent = days;
            document.getElementById('countdownHours').textContent = hours;
            document.getElementById('countdownMins').textContent = mins;
        }
        
        // Hero Countdown for the new Session Hero Card
        function updateHeroCountdown(targetDate) {
            const now = new Date();
            const diff = targetDate - now;
            
            const daysEl = document.getElementById('heroCountdownDays');
            const hoursEl = document.getElementById('heroCountdownHours');
            const minsEl = document.getElementById('heroCountdownMins');
            
            if (!daysEl || !hoursEl || !minsEl) return;
            
            if (diff <= 0) {
                daysEl.textContent = '0';
                hoursEl.textContent = '0';
                minsEl.textContent = '0';
                return;
            }
            
            const days = Math.floor(diff / (1000 * 60 * 60 * 24));
            const hours = Math.floor((diff % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
            const mins = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
            
            daysEl.textContent = days;
            hoursEl.textContent = hours;
            minsEl.textContent = mins;
        }
        
        function renderSessionItem(session) {
            const rulesetConfig = {
                '5e2024': { name: 'D&D 5e', badge: '5e', icon: 'assets/img/rulesets/ruleset_5e_2024.svg' },
                'worldsapart': { name: 'Worlds Apart', badge: 'worldsapart', icon: 'assets/img/rulesets/ruleset_worldsapart.svg' },
                'htbah': { name: 'How To Be A Hero', badge: 'htbah', icon: 'assets/img/rulesets/ruleset_htbah.svg' },
                'cyberpunk': { name: 'Cyberpunk Red', badge: 'cyberpunk', icon: 'assets/img/rulesets/ruleset_cyberpunkred.svg' }
            };
            const ruleset = rulesetConfig[session.ruleset] || { name: session.ruleset, badge: '', icon: '' };
            
            return `
                <a href="session.html?id=${session.id}" class="widget__item session-item">
                    <div class="session-item__left">
                        <div class="ruleset-badge ruleset-badge--${ruleset.badge}">
                            <img src="${ruleset.icon}" alt="">
                            <span>${ruleset.name}</span>
                        </div>
                        <span class="session-item__title">${session.name}</span>
                        <span class="session-item__meta">${session.date} · ${session.maxPlayers || 4} Spieler</span>
                    </div>
                </a>
            `;
        }
        
        function renderCharacterItem(char) {
            // Check if this is the main character for its ruleset
            const isMain = typeof CharacterStorage !== 'undefined' && CharacterStorage.isMainCharacter(char.id);
            
            // Get correct sheet URL based on ruleset
            const sheetUrl = {
                'worldsapart': 'sheet-worldsapart.html',
                'dnd5e': 'sheet-5e.html',
                '5e': 'sheet-5e-en.html',
                '5e-de': 'sheet-5e-de.html',
                'htbah': 'sheet-htbah.html',
                'cyberpunk': 'sheet-cyberpunk.html'
            }[char.ruleset] || 'sheet-worldsapart.html';
            
            return `
                <a href="${sheetUrl}?id=${char.id}" class="widget__item character-item ${isMain ? 'character-item--main' : ''}">
                    <div class="character-item__portrait" style="background: linear-gradient(135deg, ${isMain ? '#FFC107' : '#7c3aed'} 0%, ${isMain ? '#FF8F00' : '#4c1d95'} 100%);">
                        <span class="character-item__initial">${isMain ? '★' : (char.name ? char.name.charAt(0).toUpperCase() : '?')}</span>
                    </div>
                    <div class="widget__item-info">
                        <span class="character-item__name">${isMain ? '★ ' : ''}${char.name || 'Unbenannt'}</span>
                        <span class="widget__item-meta">${char.race || char.class || char.data?.role || ''}</span>
                    </div>
                </a>
            `;
        }
        
        // Reload dashboard when coming back via browser Back button (bfcache)
        window.addEventListener('pageshow', function(event) {
            if (event.persisted) {
                console.log('[Hub] Page restored from bfcache, reloading dashboard');
                loadDashboardData();
            }
        });
        
        // Reload dashboard when tab becomes visible again
        document.addEventListener('visibilitychange', function() {
            if (document.visibilityState === 'visible' && window._heroSkeletonRemoved) {
                console.log('[Hub] Tab became visible, refreshing dashboard');
                loadDashboardData();
            }
        });
        
        // Final safety net: ensure dashboard loads within 3 seconds no matter what
        setTimeout(() => {
            if (!window._heroSkeletonRemoved) {
                console.warn('[Hub] Safety net triggered - forcing dashboard load');
                loadDashboardData();
            }
        }, 3000);
        
        // Dashboard wird von initFirebaseSessions geladen
        // (nicht direkt aufrufen - verhindert Flash des falschen Contents)
    </script>
    
    <!-- Hub & Header Controller -->
    <script src="assets/js/hub-controller.js"></script>
    <script src="assets/js/header-controller.js"></script>
    <script src="assets/js/hub-features.js"></script>
    <script src="assets/js/broadcast.js"></script>
    
    <!-- TopNav & MegaNav Interactivity -->
    <script>
    console.log('=== [TopNav] Script loaded ===');
    
    // Event Delegation für alle Dropdowns
    document.addEventListener('click', function(e) {
        // Sicherheitsprüfung
        if (!e.target || typeof e.target.closest !== 'function') return;
        
        // TopNav Dropdown Trigger geklickt?
        var trigger = e.target.closest('.topnav__dropdown-trigger');
        if (trigger) {
            e.stopPropagation();
            console.log('[TopNav] Trigger clicked:', trigger.id || 'no-id');
            
            var wasOpen = trigger.classList.contains('open');
            
            // Alle TopNav Dropdowns schließen
            document.querySelectorAll('.topnav__dropdown-trigger').forEach(function(t) {
                t.classList.remove('open');
            });
            
            // Diesen öffnen wenn er vorher zu war
            if (!wasOpen) {
                trigger.classList.add('open');
                console.log('[TopNav] Dropdown opened');
            }
            return;
        }
        
        // MegaNav Item geklickt?
        var megaItem = e.target.closest('.meganav__item');
        if (megaItem && !megaItem.classList.contains('meganav__item--link')) {
            // Nur wenn nicht auf einen Link geklickt wurde
            if (!e.target.closest('a') || e.target.closest('.meganav__item') === megaItem) {
                e.stopPropagation();
                console.log('[TopNav] MegaNav item clicked');
                
                var wasOpen = megaItem.classList.contains('open');
                
                // Alle MegaNav Dropdowns schließen
                document.querySelectorAll('.meganav__item').forEach(function(i) {
                    i.classList.remove('open');
                });
                
                if (!wasOpen) {
                    megaItem.classList.add('open');
                }
            }
            return;
        }
        
        // Klick außerhalb - alle schließen
        document.querySelectorAll('.topnav__dropdown-trigger.open').forEach(function(t) {
            t.classList.remove('open');
        });
        document.querySelectorAll('.meganav__item.open').forEach(function(i) {
            i.classList.remove('open');
        });
    });
    
    // Hover für MegaNav (Desktop)
    document.addEventListener('mouseenter', function(e) {
        if (window.innerWidth <= 768) return;
        if (!e.target || typeof e.target.closest !== 'function') return;
        
        var megaItem = e.target.closest('.meganav__item:not(.meganav__item--link)');
        if (megaItem) {
            document.querySelectorAll('.meganav__item.open').forEach(function(i) {
                i.classList.remove('open');
            });
            megaItem.classList.add('open');
        }
    }, true);
    
    // MegaNav verlassen
    var meganav = document.querySelector('.meganav');
    if (meganav) {
        meganav.addEventListener('mouseleave', function() {
            if (window.innerWidth > 768) {
                document.querySelectorAll('.meganav__item.open').forEach(function(i) {
                    i.classList.remove('open');
                });
            }
        });
    }
    
    // ═══════════════════════════════════════════
    // SEARCH
    // ═══════════════════════════════════════════
    var searchInput = document.getElementById('searchInput');
    var searchDropdown = document.getElementById('search-dropdown');
    
    if (searchInput && searchDropdown) {
        var searchData = [
            { cat: 'Seiten', name: 'Hub', url: 'index.html', icon: '🏠' },
            { cat: 'Seiten', name: 'Würfel', url: 'dice.html', icon: '🎲' },
            { cat: 'Seiten', name: 'Whiteboard', url: 'whiteboard.html', icon: '🎨' },
            { cat: 'Seiten', name: 'Karten', url: 'maps.html', icon: '🗺️' },
            { cat: 'Seiten', name: 'Chat', url: 'chat.html', icon: '💬' },
            { cat: 'Seiten', name: 'Sessions', url: 'sessions.html', icon: '📅' },
            { cat: 'Regelwerke', name: 'Worlds Apart', url: 'sheet-worldsapart.html', icon: '📗' },
            { cat: 'Regelwerke', name: 'D&D 5e', url: 'sheet-dnd5e.html', icon: '📕' },
            { cat: 'Regelwerke', name: 'Cyberpunk Red', url: 'sheet-cyberpunk.html', icon: '📘' },
            { cat: 'Regelwerke', name: 'HTBAH', url: 'sheet-htbah.html', icon: '📙' }
        ];
        
        searchInput.addEventListener('input', function() {
            var query = this.value.toLowerCase();
            if (!query) {
                searchDropdown.classList.remove('active');
                return;
            }
            
            var results = searchData.filter(function(item) {
                return item.name.toLowerCase().indexOf(query) !== -1;
            });
            
            if (results.length === 0) {
                searchDropdown.innerHTML = '<div style="padding:20px;text-align:center;color:rgba(255,255,255,0.5);">Keine Ergebnisse</div>';
            } else {
                var html = '';
                results.forEach(function(item) {
                    html += '<a href="' + item.url + '" style="display:flex;align-items:center;gap:12px;padding:10px 16px;text-decoration:none;color:#fff;">';
                    html += '<span style="font-size:18px;">' + item.icon + '</span>';
                    html += '<span>' + item.name + '</span></a>';
                });
                searchDropdown.innerHTML = html;
            }
            searchDropdown.classList.add('active');
        });
        
        document.addEventListener('click', function(e) {
            if (!e.target.closest('.topnav__search')) {
                searchDropdown.classList.remove('active');
            }
        });
    }
    
    // ═══════════════════════════════════════════
    // USER & ROOM CODE
    // ═══════════════════════════════════════════
    var roomCode = localStorage.getItem('rift_current_room');
    var roomTrigger = document.getElementById('roomTrigger');
    
    if (roomCode) {
        var formatted = roomCode.length === 6 
            ? roomCode.substring(0, 3) + '-' + roomCode.substring(3)
            : roomCode;
        formatted = formatted.toUpperCase();
        
        var codeDisplay = document.getElementById('roomCodeDisplay');
        var codeLarge = document.getElementById('roomCodeLarge');
        if (codeDisplay) codeDisplay.textContent = formatted;
        if (codeLarge) codeLarge.textContent = formatted;
    } else if (roomTrigger) {
        roomTrigger.style.display = 'none';
    }
    
    // Firebase Auth - warte bis Firebase bereit ist
    function initFirebaseAuth() {
        if (typeof firebase !== 'undefined' && firebase.apps && firebase.apps.length > 0) {
            firebase.auth().onAuthStateChanged(async function(user) {
                var userAvatar = document.getElementById('userAvatar');
                var userName = document.getElementById('userName');
                var userAvatarLarge = document.getElementById('userAvatarLarge');
                var userNameLarge = document.getElementById('userNameLarge');
                var userEmail = document.getElementById('userEmail');
                
                if (user) {
                    // Hole User-Daten aus Firestore (displayName, color, avatar)
                    var displayName = user.displayName || (user.email ? user.email.split('@')[0] : 'Spieler');
                    var color = '#8b5cf6';
                    var avatarUrl = null;
                    
                    try {
                        var userDoc = await firebase.firestore().collection('users').doc(user.uid).get();
                        if (userDoc.exists) {
                            var data = userDoc.data();
                            if (data.displayName) displayName = data.displayName;
                            if (data.color) color = data.color;
                            if (data.avatar) avatarUrl = data.avatar;
                        }
                    } catch (e) {
                        console.log('[TopNav] Could not load user data from Firestore');
                    }
                    
                    var initial = displayName.charAt(0).toUpperCase();
                    
                    // TopNav User
                    if (userAvatar) {
                        userAvatar.style.background = color;
                        if (avatarUrl) {
                            userAvatar.innerHTML = '<img src="' + avatarUrl + '" alt="">';
                        } else {
                            userAvatar.textContent = initial;
                        }
                    }
                    if (userName) userName.textContent = displayName;
                    
                    // Dropdown User
                    if (userAvatarLarge) {
                        userAvatarLarge.style.background = color;
                        if (avatarUrl) {
                            userAvatarLarge.innerHTML = '<img src="' + avatarUrl + '" alt="">';
                        } else {
                            userAvatarLarge.textContent = initial;
                        }
                    }
                    if (userNameLarge) userNameLarge.textContent = displayName;
                    if (userEmail) userEmail.textContent = user.email || '';
                    
                    // Hub Greeting
                    var greetingUsername = document.getElementById('greetingUsername');
                    if (greetingUsername) greetingUsername.textContent = displayName;
                    
                    // Update time-based greeting
                    updateGreetingTime();
                }
            });
        } else {
            // Firebase noch nicht bereit, erneut versuchen
            setTimeout(initFirebaseAuth, 100);
        }
    }
    initFirebaseAuth();
    
    // Time-based greeting
    function updateGreetingTime() {
        var greetingTime = document.getElementById('greetingTime');
        if (!greetingTime) return;
        
        var hour = new Date().getHours();
        var greeting = 'Guten Tag,';
        
        if (hour >= 5 && hour < 12) {
            greeting = 'Guten Morgen,';
        } else if (hour >= 12 && hour < 18) {
            greeting = 'Guten Tag,';
        } else {
            greeting = 'Guten Abend,';
        }
        
        greetingTime.textContent = greeting;
    }
    updateGreetingTime();
    
    // Logout
    var logoutBtn = document.getElementById('logoutBtn');
    if (logoutBtn) {
        logoutBtn.addEventListener('click', function(e) {
            e.preventDefault();
            if (typeof firebase !== 'undefined' && firebase.auth) {
                firebase.auth().signOut().then(function() {
                    window.location.href = 'login.html';
                });
            }
        });
    }
    
    console.log('=== [TopNav] Initialized ===');
    </script>
</body>
</html>
