<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <meta name="description" content="RIFT - Dein digitaler Begleiter f√ºr Pen & Paper Rollenspiele">
    <meta name="theme-color" content="#161616" media="(prefers-color-scheme: dark)">
    <meta name="theme-color" content="#f5f5f5" media="(prefers-color-scheme: light)">
    <title>RIFT</title>
    
    <!-- Open Graph / Discord / Facebook -->
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://rift-app.com/">
    <meta property="og:title" content="RIFT - Dein digitaler Begleiter f√ºr Pen & Paper Rollenspiele">
    <meta property="og:description" content="Charakterb√∂gen, W√ºrfel, Karten, Chat und mehr. Spiele D&D 5e, Worlds Apart, How To Be A Hero oder Cyberpunk Red ‚Äì alles in einer App.">
    <meta property="og:image" content="https://i.imgur.com/VrFzMx6.png">
    <meta property="og:image:width" content="1200">
    <meta property="og:image:height" content="630">
    <meta property="og:site_name" content="RIFT">
    <meta property="og:locale" content="de_DE">
    
    <!-- Twitter -->
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:url" content="https://rift-app.com/">
    <meta name="twitter:title" content="RIFT - Dein digitaler Begleiter f√ºr Pen & Paper Rollenspiele">
    <meta name="twitter:description" content="Charakterb√∂gen, W√ºrfel, Karten, Chat und mehr. Spiele D&D 5e, Worlds Apart, How To Be A Hero oder Cyberpunk Red ‚Äì alles in einer App.">
    <meta name="twitter:image" content="https://i.imgur.com/VrFzMx6.png">
    
    <!-- PWA -->
    <link rel="manifest" href="manifest.json">
    <link rel="icon" href="/assets/icons/icon_rift_r.svg" type="image/svg+xml">
    <link rel="apple-touch-icon" href="assets/icons/icon-192.png">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="RIFT">
    <meta name="view-transition" content="same-origin">
    
    <!-- Styles -->
    <link rel="stylesheet" href="assets/css/core.css">
    <link rel="stylesheet" href="assets/css/ui.css">
    <link rel="stylesheet" href="assets/css/dock.css">
    <link rel="stylesheet" href="assets/css/hub.css">
    <link rel="stylesheet" href="assets/css/settings.css">
    <link rel="stylesheet" href="assets/css/article.css">
    <link rel="stylesheet" href="assets/css/hub-features.css">
    
    <!-- Cropper.js -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.6.1/cropper.min.css">
</head>
<body>
    <!-- Unified Layout Placeholders -->
    <div id="topnav-placeholder"></div>
    <div id="meganav-placeholder"></div>
    
    <div class="app">
        <main class="main main--hub">
            <div class="main__content">
                
                <!-- Page Header -->
                <div class="page-header">
                    <div class="page-header__icon">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                            <path fill-rule="evenodd" clip-rule="evenodd" d="M2.5192 7.82274C2 8.77128 2 9.91549 2 12.2039V13.725C2 17.6258 2 19.5763 3.17157 20.7881C4.34315 22 6.22876 22 10 22H14C17.7712 22 19.6569 22 20.8284 20.7881C22 19.5763 22 17.6258 22 13.725V12.2039C22 9.91549 22 8.77128 21.4808 7.82274C20.9616 6.87421 20.0131 6.28551 18.116 5.10812L16.116 3.86687C14.1106 2.62229 13.1079 2 12 2C10.8921 2 9.88939 2.62229 7.88403 3.86687L5.88403 5.10813C3.98695 6.28551 3.0384 6.87421 2.5192 7.82274ZM9 17.25C8.58579 17.25 8.25 17.5858 8.25 18C8.25 18.4142 8.58579 18.75 9 18.75H15C15.4142 18.75 15.75 18.4142 15.75 18C15.75 17.5858 15.4142 17.25 15 17.25H9Z"/>
                        </svg>
                    </div>
                    <div class="page-header__divider"></div>
                    <h1 class="page-header__title">Hub</h1>
                    <span class="page-header__tagline">Dein Abenteuer beginnt hier</span>
                </div>
                
                <!-- Announcement Banner (loaded from Firebase) -->
                <div id="announcementBanner" style="display: none;"></div>
                
                <!-- User Greeting -->
                <div class="hub-greeting" id="hubGreeting">
                    <h2 class="hub-greeting__text"><span class="hub-greeting__time" id="greetingTime">Guten Tag,</span> <span class="hub-greeting__name" id="greetingUsername">Abenteurer</span></h2>
                </div>
                
                <div class="hub-divider"></div>
                
                <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
                     1. HERO CAROUSEL (Admin-editable via carousel-config.json)
                     ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
                <div class="hero-carousel" id="heroCarousel">
                    <div class="hero-carousel__slides" id="carouselSlides">
                        <!-- Slides werden dynamisch aus admin/carousel-config.json geladen -->
                    </div>
                    
                    <!-- Navigation Arrows -->
                    <button class="hero-carousel__nav hero-carousel__nav--prev" aria-label="Vorherige Slide">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M15 18l-6-6 6-6"/></svg>
                    </button>
                    <button class="hero-carousel__nav hero-carousel__nav--next" aria-label="N√§chste Slide">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M9 18l6-6-6-6"/></svg>
                    </button>
                    
                    <!-- Tab Navigation -->
                    <div class="hero-carousel__tabs" id="carouselTabs">
                        <!-- Tabs werden dynamisch generiert -->
                    </div>
                    
                    <!-- Dots (Mobile) -->
                    <div class="hero-carousel__dots" id="carouselDots">
                        <!-- Dots werden dynamisch generiert -->
                    </div>
                </div>
                
                <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
                     2. FEATURE SHOWCASE (Admin-editable via Firebase hub_features)
                     ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
                <div class="hub-section hub-section--features">
                    <section class="feature-showcase feature-showcase--fullwidth" id="featureShowcase">
                        <!-- Feature Content - wird dynamisch aus Firebase geladen -->
                        <div class="feature-content" id="featureContent">
                            <!-- Loading Placeholder -->
                            <div class="feature-panel active" data-panel="loading">
                                <div class="feature-panel__inner">
                                    <div class="feature-panel__image feature-panel__image--placeholder">
                                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                                            <rect x="3" y="3" width="18" height="18" rx="2"/>
                                            <circle cx="8.5" cy="8.5" r="1.5"/>
                                            <polyline points="21 15 16 10 5 21"/>
                                        </svg>
                                    </div>
                                    <div class="feature-panel__text">
                                        <nav class="feature-tabs" id="featureTabs">
                                            <button class="feature-tab active">Laden...</button>
                                        </nav>
                                        <h3 class="feature-panel__title">Features werden geladen...</h3>
                                        <p class="feature-panel__desc">Bitte warten...</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </section>
                </div>

                <div class="hub-divider"></div>

                <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
                     3. SESSION/CHARACTER CARDS
                     ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
                <div class="hub-section hub-section--cards">
                    <h2 class="hub-section__title">Deine Reise</h2>
                    
                    <!-- Hero Section -->
                <div class="hero-section" id="heroSection">
                    <!-- Loading Skeleton (initial sichtbar) -->
                    <div class="hero-loading" id="heroLoading">
                        <div class="hero-loading__card hero-loading__card--small"></div>
                        <div class="hero-loading__card hero-loading__card--large"></div>
                    </div>
                    
                    <!-- Kompakter Status-Banner (kontextabh√§ngig) -->
                    <div class="status-banner" id="statusBanner" style="display: none;">
                        <div class="status-banner__icon" id="statusIcon">
                            <!-- Icon wird dynamisch gesetzt -->
                        </div>
                        <div class="status-banner__content">
                            <h3 class="status-banner__title" id="statusTitle">Willkommen bei RIFT</h3>
                            <p class="status-banner__text" id="statusText">Erstelle deinen ersten Charakter oder plane eine Session.</p>
                        </div>
                        <div class="status-banner__actions" id="statusActions">
                            <!-- Buttons werden dynamisch gesetzt -->
                        </div>
                    </div>
                    
                    <!-- Container f√ºr dynamische Karten (initial versteckt) -->
                    <div id="continueCardsContainer" style="display: none;"></div>
                    
                    <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
                         HERO PANELS - Character + Session
                         ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
                    <div class="hero-panels" id="heroPanels" style="display: none;">
                        
                        <!-- CHARACTER PANEL -->
                        <a href="#" class="character-panel" id="characterPanel">
                            <div class="character-panel__bg"></div>
                            
                            <!-- Portrait (2:3) -->
                            <div class="character-panel__portrait" id="charPanelPortrait">
                                <span class="character-panel__portrait-placeholder">?</span>
                            </div>
                            
                            <!-- Content -->
                            <div class="character-panel__content">
                                <span class="character-panel__label">Dein Charakter</span>
                                <h3 class="character-panel__name" id="charPanelName">Charakter</h3>
                                
                                <!-- Meta: Geschlecht, Alter, Rolle, Fokus (alle als Badges) -->
                                <div class="character-panel__meta" id="charPanelMeta">
                                    <span class="character-panel__badge" id="charPanelGender" style="display: none;">--</span>
                                    <span class="character-panel__badge" id="charPanelAge" style="display: none;">--</span>
                                    <span class="character-panel__badge" id="charPanelRole" style="display: none;">--</span>
                                    <span class="character-panel__badge character-panel__badge--fokus" id="charPanelElement" style="display: none;">
                                        <img src="" alt="" class="character-panel__fokus-icon" id="charPanelFokusIcon">
                                        <span>--</span>
                                    </span>
                                </div>
                                
                                <!-- Attribute: KRF, GES, Z√ÑH, VER, PR√Ñ -->
                                <div class="character-panel__attributes" id="charPanelAttributes">
                                    <span class="character-panel__attr">
                                        <span class="character-panel__attr-value" id="charPanelAttrKrf">0</span>
                                        <span class="character-panel__attr-label">KRF</span>
                                    </span>
                                    <span class="character-panel__attr">
                                        <span class="character-panel__attr-value" id="charPanelAttrGes">0</span>
                                        <span class="character-panel__attr-label">GES</span>
                                    </span>
                                    <span class="character-panel__attr">
                                        <span class="character-panel__attr-value" id="charPanelAttrZaeh">0</span>
                                        <span class="character-panel__attr-label">Z√ÑH</span>
                                    </span>
                                    <span class="character-panel__attr">
                                        <span class="character-panel__attr-value" id="charPanelAttrVer">0</span>
                                        <span class="character-panel__attr-label">VER</span>
                                    </span>
                                    <span class="character-panel__attr">
                                        <span class="character-panel__attr-value" id="charPanelAttrPrae">0</span>
                                        <span class="character-panel__attr-label">PR√Ñ</span>
                                    </span>
                                </div>
                                
                                <!-- Stats: LP, Moral, Resonanz -->
                                <div class="character-panel__stats" id="charPanelStats">
                                    <div class="character-panel__stat character-panel__stat--hp">
                                        <svg viewBox="0 0 24 24" fill="currentColor" class="character-panel__stat-icon">
                                            <path d="M6.979 3.074a6 6 0 0 1 4.988 1.425l.037 .033l.034 -.03a6 6 0 0 1 4.733 -1.44l.246 .036a6 6 0 0 1 3.364 10.008l-.18 .185l-.048 .041l-7.45 7.379a1 1 0 0 1 -1.313 .082l-.094 -.082l-7.493 -7.422a6 6 0 0 1 3.176 -10.215z"/>
                                        </svg>
                                        <div class="character-panel__stat-bar">
                                            <div class="character-panel__stat-fill character-panel__stat-fill--hp" id="charPanelHpBar" style="width: 100%"></div>
                                        </div>
                                        <span class="character-panel__stat-value" id="charPanelHp">--</span>
                                    </div>
                                    <div class="character-panel__stat character-panel__stat--mp">
                                        <svg viewBox="0 0 24 24" fill="currentColor" class="character-panel__stat-icon">
                                            <path d="M13 3l0 6l6 0l-8 12l0 -6l-6 0l8 -12z"/>
                                        </svg>
                                        <div class="character-panel__stat-bar">
                                            <div class="character-panel__stat-fill character-panel__stat-fill--mp" id="charPanelMpBar" style="width: 100%"></div>
                                        </div>
                                        <span class="character-panel__stat-value" id="charPanelMp">--</span>
                                    </div>
                                    <div class="character-panel__stat character-panel__stat--resonanz" id="charPanelResonanzStat">
                                        <svg viewBox="0 0 24 24" fill="currentColor" class="character-panel__stat-icon">
                                            <path d="M6 5h12l3 5l-9 11l-9 -11z"/>
                                        </svg>
                                        <div class="character-panel__stat-bar">
                                            <div class="character-panel__stat-fill character-panel__stat-fill--resonanz" id="charPanelResonanzBar" style="width: 100%"></div>
                                        </div>
                                        <span class="character-panel__stat-value" id="charPanelResonanz">--</span>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- CTA Button -->
                            <span class="character-panel__cta">
                                Charakter anzeigen
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M5 12h14M12 5l7 7-7 7"/>
                                </svg>
                            </span>
                        </a>
                        
                        <!-- SESSION PANEL (Adventure Panel) -->
                        <a href="#" class="adventure-panel" id="adventurePanel">
                            <div class="adventure-panel__bg"></div>
                            
                            <!-- Cover Image (2:3) -->
                            <div class="adventure-panel__cover" id="adventureCover">
                                <div class="adventure-panel__cover-placeholder">
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                                        <rect x="3" y="3" width="18" height="18" rx="2"/>
                                        <circle cx="8.5" cy="8.5" r="1.5"/>
                                        <path d="M21 15l-5-5L5 21"/>
                                    </svg>
                                </div>
                            </div>
                            
                            <div class="adventure-panel__inner">
                                <div class="adventure-panel__content">
                                    <div class="adventure-panel__header">
                                        <span class="adventure-panel__label">Weiterspielen</span>
                                        <span class="adventure-panel__gm-badge" id="adventureGmBadge" style="display: none;">
                                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                                <path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/>
                                            </svg>
                                            GM
                                        </span>
                                    </div>
                                    <h2 class="adventure-panel__title" id="adventureTitle">Session Name</h2>
                                    <p class="adventure-panel__subtitle" id="adventureSubtitle">Beschreibung...</p>
                                    
                                    <!-- Meta Row -->
                                    <div class="adventure-panel__meta">
                                        <span class="adventure-panel__ruleset" id="adventureRuleset">
                                            <img src="" alt="" id="adventureRulesetIcon">
                                            <span id="adventureRulesetName">Worlds Apart</span>
                                        </span>
                                        <span class="adventure-panel__session-num" id="adventureSessionNum">Session 1</span>
                                        
                                        <!-- Schedule inline -->
                                        <div class="adventure-panel__schedule" id="adventureSchedule">
                                            <div class="adventure-panel__date">
                                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                                    <rect x="3" y="4" width="18" height="18" rx="2" ry="2"/>
                                                    <line x1="16" y1="2" x2="16" y2="6"/>
                                                    <line x1="8" y1="2" x2="8" y2="6"/>
                                                    <line x1="3" y1="10" x2="21" y2="10"/>
                                                </svg>
                                                <span id="adventureDateText">Keine Session geplant</span>
                                            </div>
                                            <div class="adventure-panel__countdown" id="adventureCountdown" style="display: none;">
                                                <span class="adventure-panel__countdown-item">
                                                    <span class="adventure-panel__countdown-num" id="adventureCountdownDays">0</span>
                                                    <span class="adventure-panel__countdown-unit">T</span>
                                                </span>
                                                <span class="adventure-panel__countdown-sep">:</span>
                                                <span class="adventure-panel__countdown-item">
                                                    <span class="adventure-panel__countdown-num" id="adventureCountdownHours">0</span>
                                                    <span class="adventure-panel__countdown-unit">Std</span>
                                                </span>
                                                <span class="adventure-panel__countdown-sep">:</span>
                                                <span class="adventure-panel__countdown-item">
                                                    <span class="adventure-panel__countdown-num" id="adventureCountdownMins">0</span>
                                                    <span class="adventure-panel__countdown-unit">Min</span>
                                                </span>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <!-- Tags -->
                                    <div class="adventure-panel__tags" id="adventureTags"></div>
                                </div>
                            </div>
                            
                            <!-- CTA Button -->
                            <span class="adventure-panel__cta">
                                Session √∂ffnen
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M5 12h14M12 5l7 7-7 7"/>
                                </svg>
                            </span>
                        </a>
                        
                    </div>
                    
                    <!-- Legacy Hero Cards Container (fallback) -->
                    <div class="hero-cards-container" id="heroCardsContainer" style="display: none;">
                        
                        <!-- Character Hero Card (links) -->
                        <a href="#" class="character-hero" id="characterHeroCard" style="display: none;">
                            <div class="character-hero__portrait" id="characterHeroPortrait">
                                <!-- Portrait or placeholder -->
                            </div>
                            <div class="character-hero__content">
                                <span class="character-hero__label">Dein Charakter</span>
                                <h3 class="character-hero__name" id="characterHeroName">Charakter</h3>
                                <div class="character-hero__meta">
                                    <span class="character-hero__class" id="characterHeroClass"></span>
                                </div>
                                <div class="character-hero__stats" id="characterHeroStats">
                                    <div class="character-hero__stat">
                                        <span class="character-hero__stat-icon character-hero__stat-icon--lp">
                                            <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="currentColor"><path d="M6.979 3.074a6 6 0 0 1 4.988 1.425l.037 .033l.034 -.03a6 6 0 0 1 4.733 -1.44l.246 .036a6 6 0 0 1 3.364 10.008l-.18 .185l-.048 .041l-7.45 7.379a1 1 0 0 1 -1.313 .082l-.094 -.082l-7.493 -7.422a6 6 0 0 1 3.176 -10.215z"/></svg>
                                        </span>
                                        <div class="character-hero__stat-bar">
                                            <div class="character-hero__stat-fill character-hero__stat-fill--lp" id="characterHeroLpBar" style="width: 100%"></div>
                                        </div>
                                        <span class="character-hero__stat-value" id="characterHeroLpValue">--</span>
                                    </div>
                                    <div class="character-hero__stat">
                                        <span class="character-hero__stat-icon character-hero__stat-icon--moral">
                                            <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="currentColor"><path d="M12 23c-6.627 0-12-4.925-12-11c0-3.073 1.152-5.881 3.051-8.009a1 1 0 0 1 1.47 -.076l2.121 2.121c.603 .603 1.572 .705 2.3 .242l1.894 -1.205a1 1 0 0 1 1.197 .054l2.042 1.701c.68 .567 1.678 .593 2.389 .062l1.724 -1.29a1 1 0 0 1 1.448 .196c1.565 2.091 2.364 4.678 2.364 7.204c0 6.075-5.373 11-12 11z"/></svg>
                                        </span>
                                        <div class="character-hero__stat-bar">
                                            <div class="character-hero__stat-fill character-hero__stat-fill--moral" id="characterHeroMoralBar" style="width: 100%"></div>
                                        </div>
                                        <span class="character-hero__stat-value" id="characterHeroMoralValue">--</span>
                                    </div>
                                </div>
                            </div>
                        </a>
                        
                        <!-- Session Hero Card (rechts) -->
                        <a href="#" class="session-hero" id="sessionHeroCard" style="display: none;">
                            <div class="session-hero__cover" id="sessionHeroCover">
                                <!-- Cover image or placeholder -->
                            </div>
                            <div class="session-hero__content">
                                <div class="session-hero__header">
                                    <span class="session-hero__label">Weiterspielen</span>
                                    <div class="session-hero__gm-badge" id="sessionHeroGmBadge" style="display: none;">
                                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                            <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/>
                                            <circle cx="12" cy="7" r="4"/>
                                        </svg>
                                        <span>Game Master</span>
                                    </div>
                                </div>
                                <h2 class="session-hero__title" id="sessionHeroTitle">Session Name</h2>
                                <p class="session-hero__subtitle" id="sessionHeroSubtitle"></p>
                                <div class="session-hero__meta">
                                    <span class="session-hero__ruleset" id="sessionHeroRuleset">
                                        <img src="" alt="">
                                        <span></span>
                                    </span>
                                    <span class="session-hero__session-num" id="sessionHeroSessionNum">Session 1/2</span>
                                </div>
                                <div class="session-hero__tags" id="sessionHeroTags"></div>
                                <div class="session-hero__footer">
                                    <span class="session-hero__btn">
                                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                            <path d="M15 3h4a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2h-4"/>
                                            <polyline points="10 17 15 12 10 7"/>
                                            <line x1="15" y1="12" x2="3" y2="12"/>
                                        </svg>
                                        Session √∂ffnen
                                    </span>
                                </div>
                            </div>
                            <div class="session-hero__calendar">
                                <span class="session-hero__calendar-label">N√§chste Session</span>
                                <div class="session-hero__date-box" id="sessionHeroDateBox">
                                    <span class="session-hero__day" id="sessionHeroDay">--</span>
                                    <span class="session-hero__num" id="sessionHeroNum">--</span>
                                    <span class="session-hero__month" id="sessionHeroMonth">---</span>
                                </div>
                                <span class="session-hero__time" id="sessionHeroTime">--:-- Uhr</span>
                                <div class="session-hero__countdown" id="sessionHeroCountdown">
                                    <span class="session-hero__countdown-value" id="heroCountdownDays">-</span>
                                    <span class="session-hero__countdown-label">T</span>
                                    <span class="session-hero__countdown-sep">:</span>
                                    <span class="session-hero__countdown-value" id="heroCountdownHours">-</span>
                                    <span class="session-hero__countdown-label">Std</span>
                                    <span class="session-hero__countdown-sep">:</span>
                                    <span class="session-hero__countdown-value" id="heroCountdownMins">-</span>
                                    <span class="session-hero__countdown-label">Min</span>
                                </div>
                                <div class="session-hero__no-date" id="sessionHeroNoDate" style="display: none;">
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <rect x="3" y="4" width="18" height="18" rx="2" ry="2"/>
                                        <line x1="16" y1="2" x2="16" y2="6"/>
                                        <line x1="8" y1="2" x2="8" y2="6"/>
                                        <line x1="3" y1="10" x2="21" y2="10"/>
                                    </svg>
                                    <span>Kein Termin</span>
                                </div>
                            </div>
                        </a>
                    </div>
                    
                    <!-- N√§chste Session Card (legacy - f√ºr Fallback wenn keine aktive Session) -->
                    <a href="/sessions" class="next-session-card" id="nextSessionCard" style="display: none;">
                        <div class="next-session-card__header">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <rect x="3" y="4" width="18" height="18" rx="2" ry="2"/>
                                <line x1="16" y1="2" x2="16" y2="6"/>
                                <line x1="8" y1="2" x2="8" y2="6"/>
                                <line x1="3" y1="10" x2="21" y2="10"/>
                            </svg>
                            <span>N√§chste Session</span>
                        </div>
                        <div class="next-session-card__date">
                            <span class="next-session-card__day" id="nextSessionDay">--</span>
                            <span class="next-session-card__num" id="nextSessionNum">--</span>
                            <span class="next-session-card__month" id="nextSessionMonth">---</span>
                        </div>
                        <div class="next-session-card__time" id="nextSessionTime">--:-- Uhr</div>
                        <div class="next-session-card__countdown" id="sessionCountdown">
                            <span class="countdown__value" id="countdownDays">-</span>
                            <span class="countdown__label">Tage</span>
                            <span class="countdown__sep">:</span>
                            <span class="countdown__value" id="countdownHours">-</span>
                            <span class="countdown__label">Std</span>
                            <span class="countdown__sep">:</span>
                            <span class="countdown__value" id="countdownMins">-</span>
                            <span class="countdown__label">Min</span>
                        </div>
                    </a>
                </div>
                </div><!-- Ende hub-section--cards -->

                <div class="hub-divider"></div>

                <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
                     4. NEUIGKEITEN
                     ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
                <div class="hub-section hub-section--dark">
                    <div class="hub-section__inner">
                        
                        <!-- News + Feature Showcase Row -->
                        <div class="hub-showcase">
                    
                    <!-- LEFT: News Section -->
                    <section class="news-section" id="newsSection">
                        <header class="news-section__header">
                            <h2 class="news-section__title">
                                Neuigkeiten
                            </h2>
                            <a href="roadmap.html" class="news-section__link">
                                Alle Beitr√§ge
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M5 12h14M12 5l7 7-7 7"/>
                                </svg>
                            </a>
                        </header>
                        
                        <!-- Category Tabs -->
                        <nav class="news-tabs" id="newsTabs">
                            <button class="news-tab active" data-category="all">Alle</button>
                            <button class="news-tab" data-category="news">News</button>
                            <button class="news-tab" data-category="update">Updates</button>
                            <button class="news-tab" data-category="guide">Guides</button>
                        </nav>
                        
                        <!-- Loading State -->
                        <div class="news-layout news-layout--loading" id="newsLoading">
                            <div class="news-featured news-featured--skeleton">
                                <div class="skeleton"></div>
                            </div>
                            <div class="news-list">
                                <div class="news-list-item news-list-item--skeleton"><div class="skeleton"></div></div>
                                <div class="news-list-item news-list-item--skeleton"><div class="skeleton"></div></div>
                                <div class="news-list-item news-list-item--skeleton"><div class="skeleton"></div></div>
                            </div>
                        </div>
                        
                        <!-- News Layout (filled by JS) -->
                        <div class="news-layout" id="newsLayout" style="display: none;">
                            <a class="news-featured" id="newsFeatured" href="#"></a>
                            <div class="news-list" id="newsList"></div>
                        </div>
                        
                        <!-- Empty State -->
                        <div class="news-empty" id="newsEmpty" style="display: none;">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                                <path d="M19 20H5a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h10a2 2 0 0 1 2 2v1m2 13a2 2 0 0 1-2-2V9a2 2 0 0 1 2-2h2a2 2 0 0 1 2 2v9a2 2 0 0 1-2 2h-2z"/>
                            </svg>
                            <p>Bald gibt's Neuigkeiten!</p>
                        </div>
                    </section>
                    
                    </div><!-- Ende hub-showcase -->
                    </div><!-- Ende hub-section__inner -->
                </div><!-- Ende hub-section--dark -->

                <div class="hub-divider"></div>

                <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
                     5. QUOTE OF THE DAY
                     ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
                <div class="hub-section hub-section--quote">
                    <div class="quote-of-day" id="quoteOfDay">
                        
                        <div class="quote-of-day__label">
                            Zitat des Tages
                        </div>
                        <p class="quote-of-day__text" id="quoteText">‚ÄûEin wahrer Held ist nicht der, der keine Angst kennt, sondern der, der trotz seiner Angst handelt."</p>
                        <div class="quote-of-day__footer">
                            <div class="quote-of-day__author">
                                <span class="quote-of-day__name" id="quoteAuthor">Gandalf der Graue</span>
                                <span class="quote-of-day__source" id="quoteSource">Der Herr der Ringe</span>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="hub-divider"></div>

                <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
                     6. INFO CARDS (Widgets)
                     ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
                <div class="hub-section hub-section--widgets">
                    <!-- Widget Grid -->
                    <div class="widgets">
                    
                    <!-- Widget: Letzte Sessions -->
                    <div class="widget">
                        <div class="widget__header">
                            <h2 class="widget__title">Letzte Sessions</h2>
                            <a href="/sessions" class="widget__action">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
                                Neu
                            </a>
                        </div>
                        <div class="widget__content">
                            <div class="widget__list" id="recentSessionsList">
                                <!-- Dynamisch bef√ºllt -->
                            </div>
                            <!-- Empty State -->
                            <div class="widget__empty" id="sessionsEmpty">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                                    <rect x="3" y="4" width="18" height="18" rx="2" ry="2"/>
                                    <line x1="16" y1="2" x2="16" y2="6"/>
                                    <line x1="8" y1="2" x2="8" y2="6"/>
                                    <line x1="3" y1="10" x2="21" y2="10"/>
                                </svg>
                                <p>Noch keine Sessions</p>
                                <a href="/sessions" class="widget__empty-btn">Session erstellen</a>
                            </div>
                        </div>
                        <div class="widget__footer" id="sessionsFooter" style="display: none;">
                            <a href="/sessions" class="widget__link">
                                Alle Sessions anzeigen
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="9 18 15 12 9 6"/></svg>
                            </a>
                        </div>
                    </div>
                    
                    <!-- Widget: Aktive Charaktere -->
                    <div class="widget">
                        <div class="widget__header">
                            <h2 class="widget__title">Aktive Charaktere</h2>
                            <a href="/sheet" class="widget__action">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
                                Neu
                            </a>
                        </div>
                        <div class="widget__content">
                            <div class="widget__list" id="charactersList">
                                <!-- Dynamisch bef√ºllt -->
                            </div>
                            <!-- Empty State -->
                            <div class="widget__empty" id="charactersEmpty">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                                    <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/>
                                    <circle cx="12" cy="7" r="4"/>
                                </svg>
                                <p>Noch keine Charaktere</p>
                                <a href="/sheet" class="widget__empty-btn">Charakter erstellen</a>
                            </div>
                        </div>
                        <div class="widget__footer" id="charactersFooter" style="display: none;">
                            <a href="/sheet" class="widget__link">
                                Alle Charaktere
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="9 18 15 12 9 6"/></svg>
                            </a>
                        </div>
                    </div>
                    
                    <!-- Widget: Deine Party -->
                    <div class="widget">
                        <div class="widget__header">
                            <h2 class="widget__title">Deine Party</h2>
                            <button class="widget__action" id="invitePartyBtn">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M16 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="8.5" cy="7" r="4"/><line x1="20" y1="8" x2="20" y2="14"/><line x1="23" y1="11" x2="17" y2="11"/></svg>
                                Einladen
                            </button>
                        </div>
                        <div class="widget__content">
                            <div class="widget__list" id="partyList">
                                <!-- Dynamisch bef√ºllt -->
                            </div>
                            <!-- Empty State -->
                            <div class="widget__empty" id="partyEmpty">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                                    <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/>
                                    <circle cx="9" cy="7" r="4"/>
                                    <path d="M23 21v-2a4 4 0 0 0-3-3.87"/>
                                    <path d="M16 3.13a4 4 0 0 1 0 7.75"/>
                                </svg>
                                <p>Noch keine Mitspieler</p>
                                <span class="widget__empty-hint">Teile deinen Raum-Code um Spieler einzuladen</span>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Widget: Session Timer -->
                    <div class="widget widget--compact" id="sessionTimerWidget" style="display: none;">
                        <div class="widget__header">
                            <h2 class="widget__title">Session l√§uft</h2>
                            <span class="session-timer__live">‚óè Live</span>
                        </div>
                        <div class="widget__content">
                            <div class="session-timer">
                                <div class="session-timer__display">
                                    <span class="session-timer__value" id="sessionTimerValue">0:00:00</span>
                                </div>
                                <div class="session-timer__controls">
                                    <button class="session-timer__btn" id="pauseSessionBtn" title="Pause">
                                        <svg viewBox="0 0 24 24" fill="currentColor"><rect x="6" y="4" width="4" height="16"/><rect x="14" y="4" width="4" height="16"/></svg>
                                    </button>
                                    <button class="session-timer__btn session-timer__btn--stop" id="stopSessionBtn" title="Session beenden">
                                        <svg viewBox="0 0 24 24" fill="currentColor"><rect x="4" y="4" width="16" height="16" rx="2"/></svg>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Widget: Achievements -->
                    <div class="widget widget--compact">
                        <div class="widget__header">
                            <h2 class="widget__title">Achievements</h2>
                        </div>
                        <div class="widget__content">
                            <div class="achievements">
                                <div class="achievement achievement--unlocked" title="Erste Schritte: Erste Session gespielt">
                                    <div class="achievement__icon">üé≤</div>
                                </div>
                                <div class="achievement achievement--unlocked" title="W√ºrfelmeister: 100 W√ºrfe">
                                    <div class="achievement__icon">üéØ</div>
                                </div>
                                <div class="achievement achievement--unlocked" title="Kritischer Treffer: Nat 20 gew√ºrfelt">
                                    <div class="achievement__icon">‚öîÔ∏è</div>
                                </div>
                                <div class="achievement achievement--unlocked" title="Geschichtenerz√§hler: 10 Sessions">
                                    <div class="achievement__icon">üìñ</div>
                                </div>
                                <div class="achievement" title="Veteran: 50 Sessions">
                                    <div class="achievement__icon">üèÜ</div>
                                </div>
                                <div class="achievement" title="Gl√ºckspilz: 5 Nat 20s in einer Session">
                                    <div class="achievement__icon">üçÄ</div>
                                </div>
                            </div>
                            <a href="#" class="widget__link widget__link--small">
                                Alle anzeigen (12/24)
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="9 18 15 12 9 6"/></svg>
                            </a>
                        </div>
                    </div>
                    
                </div>
                
                <!-- Footer Placeholder -->
                <div id="footer-placeholder"></div>
                
            </div>
        </main>
    </div>
    
    <!-- Dock Placeholder -->
    <div id="dock-placeholder"></div>
    
    <!-- Scripts -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.6.1/cropper.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/marked/11.1.1/marked.min.js"></script>
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    
    <!-- RIFT Services -->
    <script src="assets/js/firebase-config.js"></script>
    <script src="assets/js/room-service.js"></script>
    <script src="assets/js/user-service.js"></script>
    <script src="assets/js/character-storage.js"></script>
    
    <script src="assets/js/auth.js"></script>
    <script src="assets/js/ui.js"></script>
    <script src="assets/js/layout.js"></script>
    <script src="assets/js/layout-unified.js"></script>
    <script src="assets/js/settings.js"></script>
    <script src="assets/js/admin.js"></script>
    <script src="assets/js/news.js"></script>
    <script src="assets/js/data-manager.js"></script>
    <script src="assets/js/transitions.js"></script>
    <script src="assets/js/app.js"></script>
    <script>
        // Initialize unified layout (TopNav, MegaNav, Dock, Footer)
        initUnifiedLayout();
        
        // Get current room code for filtering
        var currentRoomCode = localStorage.getItem('rift_current_room') || null;
        
        // ========================================
        // PARTY MEMBERS (Realtime from Firebase)
        // ========================================
        (function() {
            const partyList = document.getElementById('partyList');
            const partyEmpty = document.getElementById('partyEmpty');
            let unsubscribe = null;
            
            function renderPartyMembers(members) {
                if (!partyList || !partyEmpty) return;
                
                const currentUserId = firebase.auth()?.currentUser?.uid;
                const currentUserData = window.currentUser || JSON.parse(localStorage.getItem('rift_user') || '{}');
                
                if (members.length === 0) {
                    partyList.style.display = 'none';
                    partyEmpty.style.display = 'flex';
                    return;
                }
                
                partyEmpty.style.display = 'none';
                partyList.style.display = 'flex';
                
                partyList.innerHTML = members.map(member => {
                    const isYou = member.id === currentUserId || member.id === currentUserData.uid;
                    
                    let name = member.displayName || member.name;
                    if (!name && isYou) name = currentUserData.displayName || currentUserData.name;
                    name = name || 'Unbekannt';
                    
                    const displayName = isYou ? name + ' (Du)' : name;
                    const color = (isYou ? currentUserData.color : member.color) || '#8B5CF6';
                    const initial = name.charAt(0).toUpperCase();
                    const avatar = member.avatar || member.photoURL || (isYou ? (currentUserData.avatar || currentUserData.photoURL) : null);
                    const isOnline = member.online === true;
                    const role = member.role === 'gm' ? 'Spielleiter' : 'Spieler';
                    
                    return `
                        <div style="display:flex;align-items:center;gap:12px;padding:10px 12px;background:rgba(255,255,255,0.03);border-radius:10px;border:1px solid rgba(255,255,255,0.06);">
                            <div style="position:relative;flex-shrink:0;">
                                <div style="width:38px;height:38px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:15px;font-weight:700;color:white;overflow:hidden;background:${color};">
                                    ${avatar ? `<img src="${avatar}" style="width:100%;height:100%;object-fit:cover;">` : initial}
                                </div>
                                <span style="position:absolute;bottom:-2px;right:-2px;width:12px;height:12px;border-radius:50%;border:2px solid #1a1a1a;background:${isOnline ? '#22c55e' : '#6b7280'};"></span>
                            </div>
                            <div style="display:flex;flex-direction:column;gap:2px;min-width:0;flex:1;">
                                <span style="font-size:14px;font-weight:600;color:white;">${displayName}</span>
                                <span style="font-size:12px;color:rgba(255,255,255,0.5);">${role}</span>
                            </div>
                        </div>
                    `;
                }).join('');
            }
            
            function subscribeToParty() {
                const roomCode = localStorage.getItem('rift_current_room');
                if (!roomCode) {
                    console.log('[Hub] No room code, skipping party subscription');
                    return;
                }
                
                // Wait for Firebase and RIFT.rooms
                if (typeof RIFT === 'undefined' || !RIFT.rooms) {
                    setTimeout(subscribeToParty, 500);
                    return;
                }
                
                console.log('[Hub] Subscribing to party members for room:', roomCode);
                
                // Unsubscribe from previous if exists
                if (unsubscribe) unsubscribe();
                
                // Subscribe to realtime updates
                unsubscribe = RIFT.rooms.subscribeToMembers(roomCode, (members) => {
                    console.log('[Hub] Received members update:', members);
                    renderPartyMembers(members);
                });
            }
            
            // Start subscription after a delay to ensure Firebase is ready
            setTimeout(subscribeToParty, 1000);
            
            // Cleanup on page unload
            window.addEventListener('beforeunload', () => {
                if (unsubscribe) unsubscribe();
            });
        })();
        
        // Show GM elements and adjust UI based on role
        (function() {
            const userData = JSON.parse(localStorage.getItem('rift_user') || '{}');
            let isGM = userData.isGM === true;
            
            function updateGMUI(gmStatus) {
                // GM FAB
                const gmFab = document.getElementById('gmFab');
                if (gmFab) {
                    gmFab.style.display = gmStatus ? 'flex' : 'none';
                }
                
                // Quick Action Primary - different for GM vs Player
                const quickActionPrimary = document.getElementById('quickActionPrimary');
                if (quickActionPrimary && gmStatus) {
                    // GM: First action is "Neue Session"
                    quickActionPrimary.href = 'sessions.html?create=true';
                    quickActionPrimary.innerHTML = `
                        <div class="quick-action__icon quick-action__icon--red">
                            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <rect x="3" y="4" width="18" height="18" rx="2" ry="2"/>
                                <line x1="16" y1="2" x2="16" y2="6"/>
                                <line x1="8" y1="2" x2="8" y2="6"/>
                                <line x1="3" y1="10" x2="21" y2="10"/>
                                <line x1="12" y1="14" x2="12" y2="18"/>
                                <line x1="10" y1="16" x2="14" y2="16"/>
                            </svg>
                        </div>
                        <span class="quick-action__label">Neue Session</span>
                    `;
                }
                
                console.log('[Hub] User isGM:', gmStatus);
            }
            
            // Initial update from localStorage
            updateGMUI(isGM);
            
            // Check room membership after Firebase is ready
            async function checkRoomMembership() {
                if (typeof RIFT === 'undefined' || !RIFT.rooms || !RIFT.user) {
                    return false; // Services not loaded yet
                }
                
                const roomCode = RIFT.user.getCurrentRoom();
                if (!roomCode) return true; // No room, done
                
                try {
                    const membership = await RIFT.rooms.getCurrentMembership(roomCode);
                    if (membership) {
                        const roomIsGM = membership.isGM === true;
                        if (roomIsGM !== isGM) {
                            console.log('[Hub] Updated isGM from room membership:', roomIsGM);
                            isGM = roomIsGM;
                            updateGMUI(isGM);
                            
                            // Also update localStorage
                            userData.isGM = isGM;
                            localStorage.setItem('rift_user', JSON.stringify(userData));
                        }
                        return true; // Done
                    }
                } catch (e) {
                    console.warn('[Hub] Could not check room membership:', e);
                }
                return false;
            }
            
            // Try to check membership after delays (Firebase init takes time)
            setTimeout(async () => {
                const done = await checkRoomMembership();
                if (!done) setTimeout(checkRoomMembership, 1000);
            }, 500);
        })();
        
        // Random background image
        (function() {
            const bgNum = String(Math.floor(Math.random() * 12) + 1).padStart(3, '0');
            const style = document.createElement('style');
            style.textContent = `.main--hub::before { background-image: url('assets/bg/bg_${bgNum}.jpg'); }`;
            document.head.appendChild(style);
        })();
        
        // News Edit Button Handler
        (function() {
            document.querySelectorAll('.news-card__edit').forEach(editBtn => {
                editBtn.addEventListener('click', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    const newsId = this.dataset.news;
                    window.location.href = `news${newsId}.html?edit=true`;
                });
            });
        })();
        
        // ========================================
        // DYNAMIC NEWS SYSTEM - Featured + List
        // ========================================
        (async function() {
            const newsLayout = document.getElementById('newsLayout');
            const newsLoading = document.getElementById('newsLoading');
            const newsEmpty = document.getElementById('newsEmpty');
            const newsFeatured = document.getElementById('newsFeatured');
            const newsList = document.getElementById('newsList');
            const newsTabs = document.getElementById('newsTabs');
            
            let allArticles = [];
            let currentCategory = 'all';
            
            // Wait for Firebase
            const waitForFirebase = () => new Promise(resolve => {
                const check = () => {
                    if (typeof firebase !== 'undefined' && firebase.firestore && firebase.apps?.length > 0) {
                        resolve();
                    } else {
                        setTimeout(check, 100);
                    }
                };
                check();
            });
            
            await waitForFirebase();
            
            // Category config
            const categoryConfig = {
                update: { label: 'Update', color: '#4ADE80' },
                news: { label: 'News', color: '#F87171' },
                guide: { label: 'Guide', color: '#60A5FA' }
            };
            
            // Format date
            function formatDate(timestamp) {
                const date = timestamp?.toDate?.() || new Date();
                return date.toLocaleDateString('de-DE', { day: '2-digit', month: 'short', year: 'numeric' });
            }
            
            // Render featured article
            function renderFeatured(article) {
                if (!article) {
                    newsFeatured.style.display = 'none';
                    return;
                }
                
                const cat = categoryConfig[article.category] || categoryConfig.news;
                newsFeatured.href = `news.html?id=${article.id}`;
                newsFeatured.style.display = 'flex';
                newsFeatured.innerHTML = `
                    <div class="news-featured__image" style="background-image: url('${article.imageUrl || ''}');">
                        ${!article.imageUrl ? `<div class="news-featured__placeholder">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                                <rect x="3" y="3" width="18" height="18" rx="2"/>
                                <circle cx="8.5" cy="8.5" r="1.5"/>
                                <path d="M21 15l-5-5L5 21"/>
                            </svg>
                        </div>` : ''}
                        <div class="news-featured__overlay"></div>
                    </div>
                    <div class="news-featured__content">
                        <span class="news-featured__category" style="background: ${cat.color}20; color: ${cat.color};">${cat.label}</span>
                        <h3 class="news-featured__title">${article.title || 'Ohne Titel'}</h3>
                        <p class="news-featured__excerpt">${article.excerpt || ''}</p>
                        <div class="news-featured__arrow">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M5 12h14M12 5l7 7-7 7"/>
                            </svg>
                        </div>
                    </div>
                `;
            }
            
            // Render list item
            function createListItem(article) {
                const cat = categoryConfig[article.category] || categoryConfig.news;
                const item = document.createElement('a');
                item.href = `news.html?id=${article.id}`;
                item.className = 'news-list-item';
                item.innerHTML = `
                    <div class="news-list-item__image" style="background-image: url('${article.imageUrl || ''}');">
                        ${!article.imageUrl ? `<div class="news-list-item__placeholder">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                                <rect x="3" y="3" width="18" height="18" rx="2"/>
                                <circle cx="8.5" cy="8.5" r="1.5"/>
                                <path d="M21 15l-5-5L5 21"/>
                            </svg>
                        </div>` : ''}
                    </div>
                    <div class="news-list-item__content">
                        <span class="news-list-item__category" style="color: ${cat.color};">${cat.label}</span>
                        <h4 class="news-list-item__title">${article.title || 'Ohne Titel'}</h4>
                    </div>
                `;
                return item;
            }
            
            // Render all articles based on filter
            function renderArticles() {
                // Filter by category
                const filtered = currentCategory === 'all' 
                    ? allArticles 
                    : allArticles.filter(a => a.category === currentCategory);
                
                if (filtered.length === 0) {
                    newsLayout.style.display = 'none';
                    newsEmpty.style.display = 'flex';
                    return;
                }
                
                newsEmpty.style.display = 'none';
                newsLayout.style.display = 'grid';
                
                // Featured = first article (or first with featured flag)
                const featuredIndex = filtered.findIndex(a => a.featured);
                const featured = featuredIndex >= 0 ? filtered[featuredIndex] : filtered[0];
                const listArticles = filtered.filter(a => a.id !== featured.id).slice(0, 5);
                
                renderFeatured(featured);
                
                // Render list
                newsList.innerHTML = '';
                listArticles.forEach(article => {
                    newsList.appendChild(createListItem(article));
                });
            }
            
            // Tab click handler
            newsTabs?.addEventListener('click', (e) => {
                const tab = e.target.closest('.news-tab');
                if (!tab) return;
                
                // Update active state
                newsTabs.querySelectorAll('.news-tab').forEach(t => t.classList.remove('active'));
                tab.classList.add('active');
                
                // Filter
                currentCategory = tab.dataset.category;
                renderArticles();
            });
            
            // Load news from Firestore
            async function loadNews() {
                try {
                    const db = firebase.firestore();
                    const snapshot = await db.collection('hub_news')
                        .where('published', '==', true)
                        .get();
                    
                    console.log('[Hub] Loaded', snapshot.size, 'news articles');
                    
                    // Hide loading
                    if (newsLoading) newsLoading.style.display = 'none';
                    
                    if (snapshot.empty) {
                        newsEmpty.style.display = 'flex';
                        return;
                    }
                    
                    // Sort by date (newest first)
                    allArticles = snapshot.docs
                        .map(doc => ({ id: doc.id, ...doc.data() }))
                        .sort((a, b) => {
                            const aTime = a.publishedAt?.toMillis?.() || a.createdAt?.toMillis?.() || 0;
                            const bTime = b.publishedAt?.toMillis?.() || b.createdAt?.toMillis?.() || 0;
                            return bTime - aTime;
                        });
                    
                    renderArticles();
                    
                } catch (e) {
                    console.error('[Hub] News load error:', e);
                    if (newsLoading) newsLoading.style.display = 'none';
                    newsEmpty.style.display = 'flex';
                }
            }
            
            // Initialize
            await loadNews();
        })();
        
        // ========================================
        // QUOTE OF THE DAY
        // ========================================
        async function loadQuoteOfDay() {
            const quoteText = document.getElementById('quoteText');
            const quoteAuthor = document.getElementById('quoteAuthor');
            const quoteSource = document.getElementById('quoteSource');
            const quoteWidget = document.getElementById('quoteOfDay');
            
            if (!quoteText || !quoteAuthor) return;
            
            try {
                const db = firebase.firestore();
                
                // Load settings
                const settingsDoc = await db.collection('hub_settings').doc('quotes').get();
                const settings = settingsDoc.exists ? settingsDoc.data() : {};
                
                // Check if widget is enabled
                if (settings.enabled === false) {
                    if (quoteWidget) quoteWidget.style.display = 'none';
                    return;
                }
                
                // Load quotes (active field might not exist, so we filter client-side)
                const snapshot = await db.collection('hub_quotes').get();
                
                if (snapshot.empty) {
                    console.log('[Hub] No quotes found');
                    return;
                }
                
                // Filter active quotes (active !== false means active)
                const quotes = snapshot.docs
                    .map(doc => ({ id: doc.id, ...doc.data() }))
                    .filter(q => q.active !== false);
                    
                if (quotes.length === 0) {
                    console.log('[Hub] No active quotes found');
                    return;
                }
                
                console.log('[Hub] Loaded', quotes.length, 'quotes');
                
                // Select quote based on display mode
                let selectedQuote;
                const mode = settings.displayMode || 'daily';
                
                // Check for special day quotes first
                const today = new Date();
                const month = today.getMonth() + 1;
                const day = today.getDate();
                
                const specialDayMap = {
                    'newyear': (m, d) => m === 1 && d === 1,
                    'valentine': (m, d) => m === 2 && d === 14,
                    'easter': (m, d) => false, // Would need calculation
                    'halloween': (m, d) => m === 10 && d === 31,
                    'christmas': (m, d) => m === 12 && (d >= 24 && d <= 26)
                };
                
                // Find special day quote
                const specialQuote = quotes.find(q => {
                    if (!q.specialDays || q.specialDays.length === 0) return false;
                    return q.specialDays.some(sd => specialDayMap[sd]?.(month, day));
                });
                
                if (specialQuote) {
                    selectedQuote = specialQuote;
                } else if (mode === 'fixed' && settings.fixedQuoteId) {
                    selectedQuote = quotes.find(q => q.id === settings.fixedQuoteId) || quotes[0];
                } else if (mode === 'random') {
                    // Weighted random based on priority
                    const weighted = [];
                    quotes.forEach(q => {
                        const weight = q.priority || 1;
                        for (let i = 0; i < weight; i++) weighted.push(q);
                    });
                    selectedQuote = weighted[Math.floor(Math.random() * weighted.length)];
                } else if (mode === 'sequential') {
                    // Based on day of year
                    const dayOfYear = Math.floor((today - new Date(today.getFullYear(), 0, 0)) / (1000 * 60 * 60 * 24));
                    selectedQuote = quotes[dayOfYear % quotes.length];
                } else {
                    // Daily mode (default) - same quote all day
                    const dayOfYear = Math.floor((today - new Date(today.getFullYear(), 0, 0)) / (1000 * 60 * 60 * 24));
                    // Use seeded random for consistent daily selection
                    const seed = today.getFullYear() * 1000 + dayOfYear;
                    const seededIndex = Math.abs(Math.sin(seed) * 10000) % quotes.length;
                    selectedQuote = quotes[Math.floor(seededIndex)];
                }
                
                if (!selectedQuote) {
                    console.log('[Hub] No quote selected');
                    return;
                }
                
                // Apply quote marks based on settings
                const quoteMarks = {
                    german: ['‚Äû', '"'],
                    english: ['"', '"'],
                    guillemets: ['¬´', '¬ª'],
                    none: ['', '']
                };
                const marks = quoteMarks[settings.quoteMarks] || quoteMarks.german;
                
                // Update DOM
                quoteText.textContent = `${marks[0]}${selectedQuote.text}${marks[1]}`;
                quoteAuthor.textContent = selectedQuote.author || 'Unbekannt';
                
                if (quoteSource) {
                    if (selectedQuote.source && settings.showSource !== false) {
                        quoteSource.textContent = selectedQuote.source;
                        quoteSource.style.display = '';
                    } else {
                        quoteSource.style.display = 'none';
                    }
                }
                
                // Apply font settings
                if (settings.fontStyle) {
                    const fontStyles = {
                        normal: { fontStyle: 'normal', fontFamily: '' },
                        italic: { fontStyle: 'italic', fontFamily: '' },
                        serif: { fontStyle: 'normal', fontFamily: 'Georgia, serif' },
                        handwritten: { fontStyle: 'normal', fontFamily: '"Brush Script MT", cursive' }
                    };
                    const style = fontStyles[settings.fontStyle] || fontStyles.normal;
                    quoteText.style.fontStyle = style.fontStyle;
                    if (style.fontFamily) quoteText.style.fontFamily = style.fontFamily;
                }
                
                if (settings.fontSize) {
                    const fontSizes = { small: '16px', medium: '18px', large: '22px', xlarge: '26px' };
                    quoteText.style.fontSize = fontSizes[settings.fontSize] || '18px';
                }
                
                if (settings.alignment && quoteWidget) {
                    quoteWidget.style.textAlign = settings.alignment;
                }
                
                // Hide author if disabled
                if (settings.showAuthor === false) {
                    quoteAuthor.parentElement.style.display = 'none';
                }
                
                // Animation
                if (settings.animation && settings.animation !== 'none' && quoteWidget) {
                    quoteWidget.style.opacity = '0';
                    quoteWidget.style.transform = settings.animation === 'slide' ? 'translateY(20px)' : '';
                    
                    setTimeout(() => {
                        quoteWidget.style.transition = 'opacity 0.6s ease, transform 0.6s ease';
                        quoteWidget.style.opacity = '1';
                        quoteWidget.style.transform = '';
                    }, 100);
                }
                
                console.log('[Hub] Quote loaded:', selectedQuote.text.substring(0, 50) + '...');
                
            } catch (e) {
                console.error('[Hub] Quote load error:', e);
            }
        }
        
        // ========================================
        // FEATURE SHOWCASE TABS
        // ========================================
        (function() {
            const showcase = document.getElementById('featureShowcase');
            const panels = document.querySelectorAll('.feature-panel');
            
            showcase?.addEventListener('click', (e) => {
                const tab = e.target.closest('.feature-tab');
                if (!tab) return;
                
                const feature = tab.dataset.feature;
                
                // Update all tabs across all panels
                showcase.querySelectorAll('.feature-tab').forEach(t => {
                    t.classList.toggle('active', t.dataset.feature === feature);
                });
                
                // Update active panel
                panels.forEach(p => {
                    p.classList.toggle('active', p.dataset.panel === feature);
                });
            });
        })();
        
        // Random Character Image for Continue Cards
        (function() {
            const characterImages = {
                'dnd5e': ['char_5e2024_01', 'char_5e2024_02', 'char_5e2024_03', 'char_5e2024_04', 'char_5e2024_05', 'char_5e2024_06', 'char_5e2024_07'],
                'worldsapart': ['char_worldsapart_01', 'char_worldsapart_02', 'char_worldsapart_03', 'char_worldsapart_04', 'char_worldsapart_05', 'char_worldsapart_06', 'char_worldsapart_07'],
                'htbah': ['char_htbah_01', 'char_htbah_02', 'char_htbah_03', 'char_htbah_04', 'char_htbah_05', 'char_htbah_06', 'char_htbah_07'],
                'cyberpunkred': ['char_cyberpunk_01', 'char_cyberpunk_02', 'char_cyberpunk_03', 'char_cyberpunk_04']
            };
            
            // Load images for all continue cards
            document.querySelectorAll('.continue-card[data-rulebook]').forEach(card => {
                const rulebookId = card.dataset.rulebook;
                const images = characterImages[rulebookId];
                
                if (images && images.length > 0) {
                    const randomImg = images[Math.floor(Math.random() * images.length)];
                    const imgEl = card.querySelector('.continue-card__character img');
                    
                    if (imgEl) {
                        imgEl.onload = () => imgEl.classList.add('loaded');
                        imgEl.onerror = () => imgEl.style.display = 'none';
                        imgEl.src = `assets/img/rift_chars/hero_card/${randomImg}.png`;
                    }
                }
            });
        })();
        
        // Session Timer (for active sessions)
        (function() {
            let sessionStartTime = null;
            let timerInterval = null;
            const timerWidget = document.getElementById('sessionTimerWidget');
            const timerValue = document.getElementById('sessionTimerValue');
            const pauseBtn = document.getElementById('pauseSessionBtn');
            const stopBtn = document.getElementById('stopSessionBtn');
            let isPaused = false;
            let pausedTime = 0;
            
            // Check if there's an active session
            const activeSession = JSON.parse(localStorage.getItem('rift_active_session') || 'null');
            if (activeSession && timerWidget) {
                sessionStartTime = new Date(activeSession.startTime);
                pausedTime = activeSession.pausedTime || 0;
                timerWidget.style.display = 'block';
                startTimer();
            }
            
            function startTimer() {
                timerInterval = setInterval(updateTimer, 1000);
            }
            
            function updateTimer() {
                if (isPaused) return;
                const now = new Date();
                const elapsed = now - sessionStartTime - pausedTime;
                const hours = Math.floor(elapsed / (1000 * 60 * 60));
                const mins = Math.floor((elapsed % (1000 * 60 * 60)) / (1000 * 60));
                const secs = Math.floor((elapsed % (1000 * 60)) / 1000);
                if (timerValue) {
                    timerValue.textContent = `${hours}:${String(mins).padStart(2, '0')}:${String(secs).padStart(2, '0')}`;
                }
            }
            
            if (pauseBtn) {
                pauseBtn.addEventListener('click', () => {
                    isPaused = !isPaused;
                    pauseBtn.classList.toggle('active', isPaused);
                });
            }
            
            if (stopBtn) {
                stopBtn.addEventListener('click', () => {
                    if (confirm('Session wirklich beenden?')) {
                        clearInterval(timerInterval);
                        localStorage.removeItem('rift_active_session');
                        if (timerWidget) timerWidget.style.display = 'none';
                    }
                });
            }
        })();
        
        // Service Worker deaktiviert - verursachte Caching-Probleme
        // Falls ein alter SW noch l√§uft, deregistrieren:
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.getRegistrations().then(registrations => {
                registrations.forEach(registration => {
                    registration.unregister();
                    console.log('[SW] Alte Registrierung entfernt');
                });
            });
        }
        
        // ========================================
        // LOAD DASHBOARD DATA
        // ========================================
        
        // Use var to avoid re-declaration errors on View Transitions
        var firebaseSessions = window._firebaseSessions || [];
        var sessionsUnsubscribe = window._sessionsUnsubscribe || null;
        var heroSkeletonRemoved = window._heroSkeletonRemoved || false;
        
        // Failsafe: Remove hero skeleton after 800ms
        setTimeout(() => {
            if (!heroSkeletonRemoved) {
                const heroLoading = document.getElementById('heroLoading');
                if (heroLoading) heroLoading.style.display = 'none';
                console.log('[Hub] Hero skeleton removed by timeout');
            }
        }, 800);
        
        // Initialize Firebase Sessions for Hub
        let initRetries = 0; // Local counter, resets on each page load
        
        function initFirebaseSessions() {
            if (!currentRoomCode) {
                console.log('[Hub] No room code - using localStorage for sessions');
                window._firebaseSessions = firebaseSessions = JSON.parse(localStorage.getItem('rift_sessions') || '[]');
                loadDashboardData();
                return;
            }
            
            // Wait for RIFT.rooms (max 20 attempts = 2 seconds)
            if (typeof RIFT === 'undefined' || !RIFT.rooms) {
                initRetries++;
                
                if (initRetries > 20) {
                    console.warn('[Hub] RIFT.rooms not available after 2s, loading with empty sessions');
                    window._firebaseSessions = firebaseSessions = [];
                    loadDashboardData();
                    return;
                }
                
                setTimeout(initFirebaseSessions, 100);
                return;
            }
            
            console.log('[Hub] Subscribing to Firebase sessions for room:', currentRoomCode);
            
            // Subscribe to realtime session updates
            let hasReceivedData = false;
            window._sessionsUnsubscribe = sessionsUnsubscribe = RIFT.rooms.subscribeToSessions(currentRoomCode, (sessions) => {
                console.log('[Hub] Firebase sessions update:', sessions.length);
                hasReceivedData = true;
                window._firebaseSessions = firebaseSessions = sessions;
                loadDashboardData();
            });
            
            // Fallback: If no data received after 1 second, load anyway with empty/cached sessions
            setTimeout(() => {
                if (!hasReceivedData) {
                    console.warn('[Hub] No Firebase sessions received after 1s, loading with cache');
                    window._firebaseSessions = firebaseSessions = JSON.parse(localStorage.getItem('rift_sessions') || '[]');
                    loadDashboardData();
                }
            }, 1000);
        }
        
        // Start quickly
        setTimeout(initFirebaseSessions, 100);
        
        // Cleanup
        window.addEventListener('beforeunload', () => {
            if (sessionsUnsubscribe) sessionsUnsubscribe();
        });
        
        async function loadDashboardData() {
            // Hide loading skeleton
            const heroLoading = document.getElementById('heroLoading');
            if (heroLoading) heroLoading.style.display = 'none';
            heroSkeletonRemoved = true;
            window._heroSkeletonRemoved = true;
            
            // Use Firebase sessions (already filtered by room)
            const sessions = firebaseSessions;
            
            // Use CharacterStorage format (object) and convert to array
            const characterData = JSON.parse(localStorage.getItem('rift_characters') || '{}');
            const characters = Object.values(characterData);
            const now = new Date();
            const currentUserId = window.currentUser?.uid || null;
            
            // Check data state
            const hasCharacters = characters.length > 0;
            const hasSessions = sessions.filter(s => s.status !== 'ended').length > 0;
            
            console.log('[Hub] Dashboard data: sessions=', sessions.length, 'characters=', characters.length);
            
            // Status Banner - DEAKTIVIERT: Wir zeigen immer die zwei gro√üen Panels
            const statusBanner = document.getElementById('statusBanner');
            statusBanner.style.display = 'none';
            
            const continueContainer = document.getElementById('continueCardsContainer');
            const nextSessionCard = document.getElementById('nextSessionCard');
            
            // Update Quick Action Bar based on session status
            const quickActionPrimary = document.getElementById('quickActionPrimary');
            if (quickActionPrimary) {
                if (!hasSessions) {
                    // Keine Session - zeige "Session beitreten"
                    quickActionPrimary.href = 'sessions.html';
                    quickActionPrimary.querySelector('.quick-action__icon').innerHTML = `
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M15 3h4a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2h-4"/>
                            <polyline points="10 17 15 12 10 7"/>
                            <line x1="15" y1="12" x2="3" y2="12"/>
                        </svg>`;
                    quickActionPrimary.querySelector('.quick-action__label').textContent = 'Session beitreten';
                }
            }
                
                // Find next upcoming session
                const upcomingSessions = sessions.filter(s => {
                    const sessionDate = new Date(s.date + 'T' + (s.time || '00:00'));
                    return sessionDate >= now && s.status !== 'ended';
                }).sort((a, b) => new Date(a.date) - new Date(b.date));
                
                // Ruleset Configuration
                const rulesetConfig = {
                    '5e2024': { name: 'D&D 5E', class: '5e', icon: 'ruleset_5e_2024.svg' },
                    'worldsapart': { name: 'WORLDS APART', class: 'worldsapart', icon: 'ruleset_worldsapart.svg' },
                    'htbah': { name: 'HTBAH', class: 'htbah', icon: 'ruleset_htbah.svg' },
                    'cyberpunk': { name: 'CYBERPUNK', class: 'cyberpunk', icon: 'ruleset_cyberpunkred.svg' }
                };
                
                const weekdays = ['SO', 'MO', 'DI', 'MI', 'DO', 'FR', 'SA'];
                const months = ['Jan', 'Feb', 'M√§r', 'Apr', 'Mai', 'Jun', 'Jul', 'Aug', 'Sep', 'Okt', 'Nov', 'Dez'];
                
                // ============================================
                // CHARACTER HERO CARD - Always show if character exists
                // ============================================
                const heroCardsContainer = document.getElementById('heroCardsContainer');
                const characterHeroCard = document.getElementById('characterHeroCard');
                const sessionHeroCard = document.getElementById('sessionHeroCard');
                
                // Filter to only show non-ended sessions
                const activeSessions = sessions.filter(s => s.status !== 'ended');
                const heroSession = activeSessions.length > 0 ? activeSessions[0] : null;
                
                // Determine ruleset (from session or from character)
                let ruleset = rulesetConfig['worldsapart']; // default
                if (heroSession) {
                    ruleset = rulesetConfig[heroSession.ruleset] || rulesetConfig['worldsapart'];
                } else if (characters.length > 0) {
                    ruleset = rulesetConfig[characters[0].ruleset] || rulesetConfig['worldsapart'];
                }
                
                // Find Main Character
                let selectedChar = null;
                
                // 1. Try Main Character from CharacterStorage (for session ruleset or any)
                if (typeof CharacterStorage !== 'undefined') {
                    if (heroSession) {
                        selectedChar = CharacterStorage.getMainCharacter(heroSession.ruleset);
                    }
                    if (!selectedChar && characters.length > 0) {
                        // Try to get main character for first character's ruleset, or just use first character
                        const firstRuleset = characters[0].ruleset || 'worldsapart';
                        selectedChar = CharacterStorage.getMainCharacter(firstRuleset);
                        if (!selectedChar) {
                            selectedChar = characters[0];
                        }
                    }
                    console.log('[Hub] Main character:', selectedChar?.name || 'none');
                }
                
                // 2. Fallback: session's selected character
                if (!selectedChar && heroSession?.selectedCharacterId) {
                    selectedChar = characters.find(c => c.id === heroSession.selectedCharacterId);
                }
                
                // 3. Fallback: any character with matching ruleset
                if (!selectedChar && heroSession) {
                    selectedChar = characters.find(c => c.ruleset === heroSession.ruleset);
                }
                
                // 4. Last fallback: first character
                if (!selectedChar && characters.length > 0) {
                    selectedChar = characters[0];
                }
                
                // Show hero cards container if we have EITHER character OR session
                if (selectedChar || heroSession) {
                    heroCardsContainer.style.display = 'flex';
                }
                
                // ============================================
                // CHARACTER HERO CARD (left side) - Show if character exists
                // ============================================
                if (selectedChar) {
                    const charRuleset = rulesetConfig[selectedChar.ruleset] || ruleset;
                    
                    characterHeroCard.style.display = 'flex';
                    characterHeroCard.href = `sheet-${selectedChar.ruleset || 'worldsapart'}.html?id=${selectedChar.id}`;
                    characterHeroCard.className = `character-hero character-hero--${charRuleset.class}`;
                    
                    // Portrait
                    const portraitEl = document.getElementById('characterHeroPortrait');
                    if (selectedChar.portrait) {
                        // Check if it's a base64 image or a preset name
                        const portraitSrc = selectedChar.portrait.startsWith('data:') 
                            ? selectedChar.portrait 
                            : `assets/img/rift_chars/hero_card/${selectedChar.portrait}.png`;
                        portraitEl.innerHTML = `<img src="${portraitSrc}" alt="${selectedChar.name}" class="character-hero__portrait-img">`;
                    } else {
                        const initial = (selectedChar.name || 'C').charAt(0).toUpperCase();
                        portraitEl.innerHTML = `
                            <div class="character-hero__portrait-placeholder">
                                <span class="character-hero__portrait-initial">${initial}</span>
                            </div>`;
                    }
                    
                    // Name
                    document.getElementById('characterHeroName').textContent = selectedChar.name || 'Charakter';
                    
                    // Class
                    const classEl = document.getElementById('characterHeroClass');
                    if (selectedChar.class || selectedChar.role) {
                        classEl.textContent = selectedChar.class || selectedChar.role || '';
                        classEl.style.display = 'inline';
                    } else {
                        classEl.style.display = 'none';
                    }
                    
                    // LP & Moral Stats - Load from Room Characters (Multi-Char Support)
                    const lpBarEl = document.getElementById('characterHeroLpBar');
                    const lpValueEl = document.getElementById('characterHeroLpValue');
                    const moralBarEl = document.getElementById('characterHeroMoralBar');
                    const moralValueEl = document.getElementById('characterHeroMoralValue');
                    
                    const userId = window.currentUser?.uid || null;
                    const roomCode = currentRoomCode;
                    
                    console.log('[Hub] Loading character stats - roomCode:', roomCode, 'userId:', userId);
                    
                    let lpValue = null;
                    let moralValue = null;
                    let lpMax = 100;
                    let moralMax = 100;
                    
                    // Try Room Characters first (Firestore) - Multi-Char Ready!
                    if (roomCode && userId && typeof RIFT !== 'undefined' && RIFT.rooms?.getActiveCharacter) {
                        try {
                            const activeChar = await RIFT.rooms.getActiveCharacter(roomCode, userId);
                            console.log('[Hub] Active character from Room:', activeChar ? activeChar.name : 'none');
                            
                            if (activeChar && activeChar.data) {
                                // Worlds Apart structure: data.status.health/moral
                                lpValue = activeChar.data.status?.health ?? activeChar.data.health?.current ?? null;
                                moralValue = activeChar.data.status?.moral ?? activeChar.data.moral?.current ?? null;
                                
                                // Also check for max values
                                lpMax = activeChar.data.health?.max || 100;
                                moralMax = activeChar.data.moral?.max || 100;
                                
                                console.log('[Hub] Room Character stats:', { lpValue, moralValue, lpMax, moralMax });
                            }
                        } catch (e) {
                            console.warn('[Hub] Room Character error:', e);
                        }
                    }
                    
                    // Fallback 1: Try selected character's data directly
                    if (lpValue === null && selectedChar?.data) {
                        lpValue = selectedChar.data.status?.health ?? selectedChar.data.health?.current ?? null;
                        moralValue = selectedChar.data.status?.moral ?? selectedChar.data.moral?.current ?? null;
                        console.log('[Hub] Selected char stats:', { lpValue, moralValue });
                    }
                    
                    // Fallback 2: Try localStorage (worldsapart_character_v5)
                    if (lpValue === null) {
                        try {
                            const localData = JSON.parse(localStorage.getItem('worldsapart_character_v5') || 'null');
                            if (localData) {
                                lpValue = localData.health?.current ?? null;
                                moralValue = localData.moral?.current ?? null;
                                lpMax = localData.health?.max || 100;
                                moralMax = localData.moral?.max || 100;
                                console.log('[Hub] LocalStorage stats:', { lpValue, moralValue });
                            }
                        } catch (e) {
                            console.warn('[Hub] LocalStorage error:', e);
                        }
                    }
                    
                    // Update UI
                    if (lpValue !== null) {
                        const lpPercent = Math.min(100, Math.max(0, (lpValue / lpMax) * 100));
                        lpBarEl.style.width = `${lpPercent}%`;
                        lpValueEl.textContent = `${lpValue}`;
                    }
                    
                    if (moralValue !== null) {
                        const moralPercent = Math.min(100, Math.max(0, (moralValue / moralMax) * 100));
                        moralBarEl.style.width = `${moralPercent}%`;
                        moralValueEl.textContent = `${moralValue}`;
                    }
                } else if (heroSession) {
                    // No character but have session - show empty state prompting to create
                    characterHeroCard.style.display = 'flex';
                    characterHeroCard.href = 'sheet.html';
                    characterHeroCard.className = `character-hero character-hero--${ruleset.class} character-hero--empty`;
                    
                    // Empty Portrait with icon
                    const portraitEl = document.getElementById('characterHeroPortrait');
                    portraitEl.innerHTML = `
                        <div class="character-hero__portrait-placeholder">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                                <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/>
                                <circle cx="12" cy="7" r="4"/>
                            </svg>
                        </div>`;
                    
                    // Empty State Text
                    document.getElementById('characterHeroName').textContent = 'Charakter erstellen';
                    
                    const classEl = document.getElementById('characterHeroClass');
                    classEl.textContent = 'Um mitzuspielen';
                    classEl.style.display = 'inline';
                    
                    // Hide stats, show CTA hint
                    document.getElementById('characterHeroStats').innerHTML = `
                        <div class="character-hero__cta">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <line x1="12" y1="5" x2="12" y2="19"/>
                                <line x1="5" y1="12" x2="19" y2="12"/>
                            </svg>
                            <span>Jetzt erstellen</span>
                        </div>
                    `;
                } else {
                    // No session and no character - hide character card
                    characterHeroCard.style.display = 'none';
                }
                
                // ============================================
                // SESSION HERO CARD (right side) - Only if active session exists
                // ============================================
                if (heroSession) {
                    const sessionHeroCover = document.getElementById('sessionHeroCover');
                    
                    // Show and configure the card
                    sessionHeroCard.style.display = 'flex';
                    sessionHeroCard.href = `session.html?id=${heroSession.id}`;
                    sessionHeroCard.className = `session-hero session-hero--${ruleset.class}`;
                    
                    // Cover Image
                    if (heroSession.coverUrl) {
                        sessionHeroCover.innerHTML = `<img src="${heroSession.coverUrl}" alt="${heroSession.name}" class="session-hero__cover-img">`;
                    } else {
                        sessionHeroCover.innerHTML = `
                            <div class="session-hero__cover-placeholder">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                                    <rect x="3" y="3" width="18" height="18" rx="2"/>
                                    <circle cx="8.5" cy="8.5" r="1.5"/>
                                    <path d="M21 15l-5-5L5 21"/>
                                </svg>
                            </div>`;
                    }
                    
                    // Title & Subtitle
                    document.getElementById('sessionHeroTitle').textContent = heroSession.name || 'Unbenannte Session';
                    document.getElementById('sessionHeroSubtitle').textContent = heroSession.subtitle || '';
                    document.getElementById('sessionHeroSubtitle').style.display = heroSession.subtitle ? 'block' : 'none';
                    
                    // GM Badge (show if user is GM)
                    const gmBadge = document.getElementById('sessionHeroGmBadge');
                    if (heroSession.isGM || heroSession.gmId === currentUserId) {
                        gmBadge.style.display = 'flex';
                    } else {
                        gmBadge.style.display = 'none';
                    }
                    
                    // Ruleset
                    const rulesetEl = document.getElementById('sessionHeroRuleset');
                    rulesetEl.innerHTML = `
                        <img src="assets/img/rulesets/${ruleset.icon}" alt="${ruleset.name}">
                        <span>${ruleset.name}</span>`;
                    
                    // Session Number
                    const sessionNum = heroSession.currentSession || 1;
                    const totalSessions = heroSession.sessionCount || '?';
                    document.getElementById('sessionHeroSessionNum').textContent = `Session ${sessionNum}/${totalSessions}`;
                    
                    // Tags (capitalize via CSS)
                    const tagsContainer = document.getElementById('sessionHeroTags');
                    if (heroSession.tags && heroSession.tags.length > 0) {
                        tagsContainer.innerHTML = heroSession.tags.slice(0, 3).map(tag => 
                            `<span class="session-hero__tag">${tag}</span>`
                        ).join('');
                        tagsContainer.style.display = 'flex';
                    } else {
                        tagsContainer.style.display = 'none';
                    }
                    
                    // Calendar / Date
                    const dateBox = document.getElementById('sessionHeroDateBox');
                    const noDate = document.getElementById('sessionHeroNoDate');
                    const countdown = document.getElementById('sessionHeroCountdown');
                    const timeEl = document.getElementById('sessionHeroTime');
                    
                    if (heroSession.date) {
                        const sessionDate = new Date(heroSession.date);
                        dateBox.style.display = 'flex';
                        noDate.style.display = 'none';
                        countdown.style.display = 'flex';
                        timeEl.style.display = 'block';
                        
                        document.getElementById('sessionHeroDay').textContent = weekdays[sessionDate.getDay()];
                        document.getElementById('sessionHeroNum').textContent = String(sessionDate.getDate()).padStart(2, '0');
                        document.getElementById('sessionHeroMonth').textContent = months[sessionDate.getMonth()];
                        document.getElementById('sessionHeroTime').textContent = `${heroSession.time || '20:00'} Uhr`;
                        
                        // Countdown
                        const sessionDateTime = new Date(heroSession.date + 'T' + (heroSession.time || '20:00'));
                        updateHeroCountdown(sessionDateTime);
                        setInterval(() => updateHeroCountdown(sessionDateTime), 60000);
                    } else {
                        dateBox.style.display = 'none';
                        noDate.style.display = 'flex';
                        countdown.style.display = 'none';
                        timeEl.style.display = 'none';
                    }
                    
                    // Hide old continue cards container
                    continueContainer.style.display = 'none';
                    
                    // Hide old next session card (we have the unified hero now)
                    nextSessionCard.style.display = 'none';
                } else {
                    // No active session - hide session hero card
                    sessionHeroCard.style.display = 'none';
                }
                
                // ============================================
                // HERO PANELS - Character + Session
                // IMMER anzeigen, egal ob leer oder bef√ºllt
                // ============================================
                const heroPanels = document.getElementById('heroPanels');
                const characterPanel = document.getElementById('characterPanel');
                const adventurePanel = document.getElementById('adventurePanel');
                
                if (heroPanels) {
                    // IMMER Hero Panels anzeigen
                    heroPanels.style.display = 'flex';
                    heroCardsContainer.style.display = 'none';
                    
                    // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
                    // CHARACTER PANEL
                    // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
                    if (selectedChar && characterPanel) {
                        characterPanel.style.display = 'flex';
                        characterPanel.classList.remove('character-panel--empty');
                        characterPanel.className = `character-panel character-panel--${ruleset.class}`;
                        characterPanel.href = `sheet-${selectedChar.ruleset || 'worldsapart'}.html?id=${selectedChar.id}`;
                        
                        // Portrait
                        const portraitContainer = document.getElementById('charPanelPortrait');
                        if (selectedChar.portrait) {
                            const portraitSrc = selectedChar.portrait.startsWith('data:') 
                                ? selectedChar.portrait 
                                : `assets/img/rift_chars/hero_card/${selectedChar.portrait}.png`;
                            portraitContainer.innerHTML = `<img src="${portraitSrc}" alt="${selectedChar.name}">`;
                        } else {
                            const initial = (selectedChar.name || 'C').charAt(0).toUpperCase();
                            portraitContainer.innerHTML = `<span class="character-panel__portrait-placeholder">${initial}</span>`;
                        }
                        
                        // Name
                        document.getElementById('charPanelName').textContent = selectedChar.name || 'Charakter';
                        
                        // Get character data - SIMPLIFIED: Always try localStorage first for Worlds Apart
                        let charData = null;
                        
                        // Source 1: localStorage (most reliable for local characters)
                        try {
                            const localData = localStorage.getItem('worldsapart_character_v5');
                            if (localData) {
                                charData = JSON.parse(localData);
                                console.log('[Hub] CharPanel: Loaded from localStorage:', charData);
                            }
                        } catch (e) {
                            console.warn('[Hub] CharPanel: localStorage error:', e);
                        }
                        
                        // Source 2: selectedChar.data as fallback
                        if (!charData && selectedChar.data) {
                            charData = selectedChar.data;
                            console.log('[Hub] CharPanel: Using selectedChar.data');
                        }
                        
                        // Source 3: Room Character if in a room
                        if (!charData && roomCode && userId && typeof RIFT !== 'undefined' && RIFT.rooms?.getActiveCharacter) {
                            try {
                                const activeChar = await RIFT.rooms.getActiveCharacter(roomCode, userId);
                                if (activeChar && activeChar.data) {
                                    charData = activeChar.data;
                                    console.log('[Hub] CharPanel: Using Room Character data');
                                }
                            } catch (e) {
                                console.warn('[Hub] CharPanel: Room error:', e);
                            }
                        }
                        
                        if (!charData) {
                            console.warn('[Hub] CharPanel: No character data found!');
                            charData = {};
                        }
                        
                        // Meta: Geschlecht, Alter, Rolle, Element
                        const genderEl = document.getElementById('charPanelGender');
                        const ageEl = document.getElementById('charPanelAge');
                        const roleEl = document.getElementById('charPanelRole');
                        const elementEl = document.getElementById('charPanelElement');
                        
                        // Geschlecht
                        const genderValue = charData.gender;
                        if (genderValue) {
                            genderEl.textContent = genderValue;
                            genderEl.style.display = 'inline-flex';
                        } else {
                            genderEl.style.display = 'none';
                        }
                        
                        // Alter
                        const ageValue = charData.age;
                        if (ageValue) {
                            ageEl.textContent = `${ageValue} Jahre`;
                            ageEl.style.display = 'inline-flex';
                        } else {
                            ageEl.style.display = 'none';
                        }
                        
                        // Rolle
                        const roleText = charData.role || selectedChar.role || selectedChar.class || '';
                        if (roleText) {
                            roleEl.textContent = roleText;
                            roleEl.style.display = 'inline-flex';
                        } else {
                            roleEl.style.display = 'none';
                        }
                        
                        // Fokus Element (Worlds Apart spezifisch) mit Icon und Farbe
                        const fokusType = charData.fokus?.type;
                        if (fokusType) {
                            // Fokus Konfiguration: Name, Icon-Datei, Farbe
                            const fokusConfig = {
                                'fire': { name: 'Feuer', icon: 'fire', color: '#f97316' },
                                'water': { name: 'Wasser', icon: 'water', color: '#3b82f6' },
                                'wind': { name: 'Wind', icon: 'wind', color: '#06b6d4' },
                                'earth': { name: 'Erde', icon: 'earth', color: '#84cc16' },
                                'lightning': { name: 'Blitz', icon: 'lightning', color: '#eab308' },
                                'room': { name: 'Raum', icon: 'room', color: '#a855f7' },
                                'illusion': { name: 'Illusion', icon: 'illusion', color: '#ec4899' },
                                'shadow': { name: 'Schatten', icon: 'shadow', color: '#6b7280' },
                                'time': { name: 'Zeit', icon: 'time', color: '#f59e0b' },
                                'poison': { name: 'Gift', icon: 'poison', color: '#22c55e' },
                                'sound': { name: 'Schall', icon: 'sound', color: '#14b8a6' }
                            };
                            
                            const fokus = fokusConfig[fokusType] || { 
                                name: fokusType.charAt(0).toUpperCase() + fokusType.slice(1), 
                                icon: fokusType, 
                                color: '#a78bfa' 
                            };
                            
                            // Icon setzen
                            const fokusIcon = document.getElementById('charPanelFokusIcon');
                            fokusIcon.src = `assets/icons/icon_focus_${fokus.icon}.png`;
                            fokusIcon.alt = fokus.name;
                            
                            // Name setzen
                            elementEl.querySelector('span').textContent = fokus.name;
                            
                            // Farbe setzen
                            elementEl.style.background = `${fokus.color}20`;
                            elementEl.style.color = fokus.color;
                            
                            elementEl.style.display = 'inline-flex';
                        } else {
                            elementEl.style.display = 'none';
                        }
                        
                        // Attribute: KRF, GES, Z√ÑH, VER, PR√Ñ
                        const attributesContainer = document.getElementById('charPanelAttributes');
                        if (charData.attributes) {
                            document.getElementById('charPanelAttrKrf').textContent = charData.attributes.power || 0;
                            document.getElementById('charPanelAttrGes').textContent = charData.attributes.agility || 0;
                            document.getElementById('charPanelAttrZaeh').textContent = charData.attributes.endurance || 0;
                            document.getElementById('charPanelAttrVer').textContent = charData.attributes.mind || 0;
                            document.getElementById('charPanelAttrPrae').textContent = charData.attributes.presence || 0;
                            attributesContainer.style.display = 'flex';
                        } else {
                            attributesContainer.style.display = 'none';
                        }
                        
                        // Stats: LP, Moral, Resonanz
                        const statsContainer = document.getElementById('charPanelStats');
                        
                        // LP
                        const lpCurrent = charData.health?.current ?? null;
                        const lpMax = charData.health?.max || 100;
                        if (lpCurrent !== null) {
                            const lpPercent = Math.min(100, Math.max(0, (lpCurrent / lpMax) * 100));
                            document.getElementById('charPanelHp').textContent = lpCurrent;
                            document.getElementById('charPanelHpBar').style.width = `${lpPercent}%`;
                        }
                        
                        // Moral
                        const moralCurrent = charData.moral?.current ?? null;
                        const moralMax = charData.moral?.max || 100;
                        if (moralCurrent !== null) {
                            const moralPercent = Math.min(100, Math.max(0, (moralCurrent / moralMax) * 100));
                            document.getElementById('charPanelMp').textContent = moralCurrent;
                            document.getElementById('charPanelMpBar').style.width = `${moralPercent}%`;
                        }
                        
                        // Resonanz (Worlds Apart) - 10 + KRF * PR√Ñ
                        const resonanzStat = document.getElementById('charPanelResonanzStat');
                        if (charData.attributes) {
                            const power = charData.attributes.power || 0;
                            const presence = charData.attributes.presence || 0;
                            const resonanzValue = 10 + (power * presence);
                            const resonanzMax = 100; // F√ºr die Bar
                            const resonanzPercent = Math.min(100, (resonanzValue / resonanzMax) * 100);
                            document.getElementById('charPanelResonanz').textContent = resonanzValue;
                            document.getElementById('charPanelResonanzBar').style.width = `${resonanzPercent}%`;
                            resonanzStat.style.display = 'flex';
                        } else {
                            resonanzStat.style.display = 'none';
                        }
                        
                        statsContainer.style.display = 'flex';
                        
                    } else if (characterPanel) {
                        // Empty State - CTA to create character (linksb√ºndig)
                        characterPanel.style.display = 'flex';
                        characterPanel.classList.add('character-panel--empty');
                        characterPanel.href = 'sheet.html';
                        
                        document.getElementById('charPanelPortrait').innerHTML = `
                            <span class="character-panel__portrait-placeholder">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" width="48" height="48">
                                    <path d="M12 5v14M5 12h14"/>
                                </svg>
                            </span>`;
                        
                        const contentEl = document.querySelector('.character-panel__content');
                        contentEl.innerHTML = `
                            <span class="character-panel__label">Dein Charakter</span>
                            <h3 class="character-panel__name">Charakter erstellen</h3>
                            <p class="character-panel__subtitle">Erwecke deinen Helden zum Leben</p>
                            <span class="character-panel__cta-btn">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="16" height="16">
                                    <path d="M12 5v14M5 12h14"/>
                                </svg>
                                Jetzt erstellen
                            </span>
                        `;
                    }
                    
                    // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
                    // SESSION PANEL (Adventure Panel)
                    // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
                    if (heroSession && adventurePanel) {
                        adventurePanel.style.display = 'flex';
                        adventurePanel.classList.remove('adventure-panel--empty');
                        adventurePanel.className = `adventure-panel adventure-panel--${ruleset.class}`;
                        adventurePanel.href = `session.html?id=${heroSession.id}`;
                        
                        // Cover Image
                        const coverContainer = document.getElementById('adventureCover');
                        if (heroSession.coverUrl) {
                            coverContainer.innerHTML = `<img src="${heroSession.coverUrl}" alt="${heroSession.name}">`;
                        } else {
                            coverContainer.innerHTML = `
                                <div class="adventure-panel__cover-placeholder">
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                                        <rect x="3" y="3" width="18" height="18" rx="2"/>
                                        <circle cx="8.5" cy="8.5" r="1.5"/>
                                        <path d="M21 15l-5-5L5 21"/>
                                    </svg>
                                </div>`;
                        }
                        
                        // Title & Subtitle
                        document.getElementById('adventureTitle').textContent = heroSession.name || 'Unbenannte Session';
                        document.getElementById('adventureSubtitle').textContent = heroSession.subtitle || '';
                        
                        // Ruleset
                        const rulesetIcon = document.getElementById('adventureRulesetIcon');
                        const rulesetName = document.getElementById('adventureRulesetName');
                        if (rulesetIcon) rulesetIcon.src = `assets/img/rulesets/${ruleset.icon}`;
                        if (rulesetName) rulesetName.textContent = ruleset.name;
                        
                        // Session Number
                        const sessionNum = heroSession.currentSession || 1;
                        const totalSessions = heroSession.sessionCount || '?';
                        document.getElementById('adventureSessionNum').textContent = `Session ${sessionNum}/${totalSessions}`;
                        
                        // GM Badge
                        const gmBadge = document.getElementById('adventureGmBadge');
                        if (heroSession.isGM || heroSession.gmId === currentUserId) {
                            gmBadge.style.display = 'inline-flex';
                        } else {
                            gmBadge.style.display = 'none';
                        }
                        
                        // Tags
                        const tagsContainer = document.getElementById('adventureTags');
                        if (heroSession.tags && heroSession.tags.length > 0) {
                            tagsContainer.innerHTML = heroSession.tags.slice(0, 4).map(tag => 
                                `<span class="adventure-panel__tag">${tag}</span>`
                            ).join('');
                            tagsContainer.style.display = 'flex';
                        } else {
                            tagsContainer.style.display = 'none';
                        }
                        
                        // Schedule / Date
                        const scheduleContainer = document.getElementById('adventureSchedule');
                        const dateText = document.getElementById('adventureDateText');
                        const countdown = document.getElementById('adventureCountdown');
                        
                        if (heroSession.date) {
                            scheduleContainer.style.display = 'flex';
                            const sessionDate = new Date(heroSession.date);
                            const dayName = weekdays[sessionDate.getDay()];
                            const dateNum = sessionDate.getDate();
                            const monthName = months[sessionDate.getMonth()];
                            const time = heroSession.time || '20:00';
                            
                            dateText.textContent = `${dayName}, ${dateNum}. ${monthName} ¬∑ ${time} Uhr`;
                            
                            // Countdown
                            const sessionDateTime = new Date(heroSession.date + 'T' + time);
                            countdown.style.display = 'flex';
                            
                            function updateAdventureCountdown() {
                                const now = new Date();
                                const diff = sessionDateTime - now;
                                
                                if (diff <= 0) {
                                    document.getElementById('adventureCountdownDays').textContent = '0';
                                    document.getElementById('adventureCountdownHours').textContent = '0';
                                    document.getElementById('adventureCountdownMins').textContent = '0';
                                    return;
                                }
                                
                                const days = Math.floor(diff / (1000 * 60 * 60 * 24));
                                const hours = Math.floor((diff % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
                                const mins = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
                                
                                document.getElementById('adventureCountdownDays').textContent = days;
                                document.getElementById('adventureCountdownHours').textContent = hours;
                                document.getElementById('adventureCountdownMins').textContent = mins;
                            }
                            
                            updateAdventureCountdown();
                            setInterval(updateAdventureCountdown, 60000);
                        } else {
                            dateText.textContent = 'Keine Session geplant';
                            countdown.style.display = 'none';
                        }
                        
                    } else if (adventurePanel) {
                        // Empty State - CTA to create/join session (same layout as character panel)
                        adventurePanel.style.display = 'flex';
                        adventurePanel.classList.add('adventure-panel--empty');
                        adventurePanel.href = 'sessions.html';
                        
                        // Show cover with + icon (like character portrait)
                        const coverEl = document.getElementById('adventureCover');
                        coverEl.style.display = 'flex';
                        coverEl.innerHTML = `
                            <span class="adventure-panel__cover-placeholder">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" width="48" height="48">
                                    <path d="M12 5v14M5 12h14"/>
                                </svg>
                            </span>`;
                        
                        // Update content area
                        const innerEl = document.querySelector('.adventure-panel__inner');
                        innerEl.innerHTML = `
                            <div class="adventure-panel__content">
                                <span class="adventure-panel__label">Deine Session</span>
                                <h2 class="adventure-panel__title">Session starten</h2>
                                <p class="adventure-panel__subtitle">Starte ein neues Abenteuer</p>
                                <span class="adventure-panel__cta-btn">
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="16" height="16">
                                        <path d="M12 5v14M5 12h14"/>
                                    </svg>
                                    Jetzt erstellen
                                </span>
                            </div>
                        `;
                    }
                }
                
                // Fallback: Show old next session card if we have upcoming but no active sessions and no character
                if (!heroSession && !selectedChar && upcomingSessions.length > 0) {
                    const next = upcomingSessions[0];
                    const date = new Date(next.date);
                    
                    nextSessionCard.style.display = 'flex';
                    nextSessionCard.href = `session.html?id=${next.id}`;
                    document.getElementById('nextSessionDay').textContent = weekdays[date.getDay()];
                    document.getElementById('nextSessionNum').textContent = String(date.getDate()).padStart(2, '0');
                    document.getElementById('nextSessionMonth').textContent = months[date.getMonth()];
                    document.getElementById('nextSessionTime').textContent = `${next.time || '20:00'} Uhr`;
                    
                    // Countdown
                    const sessionDateTime = new Date(next.date + 'T' + (next.time || '20:00'));
                    updateCountdown(sessionDateTime);
                    setInterval(() => updateCountdown(sessionDateTime), 60000);
                }
            
            // Sessions Widget
            const recentSessions = sessions.slice(-3).reverse();
            const sessionsList = document.getElementById('recentSessionsList');
            const sessionsEmpty = document.getElementById('sessionsEmpty');
            const sessionsFooter = document.getElementById('sessionsFooter');
            
            if (recentSessions.length > 0) {
                sessionsEmpty.style.display = 'none';
                sessionsFooter.style.display = 'block';
                sessionsList.innerHTML = recentSessions.map(renderSessionItem).join('');
            } else {
                sessionsEmpty.style.display = 'flex';
                sessionsFooter.style.display = 'none';
            }
            
            // Characters Widget
            const charactersList = document.getElementById('charactersList');
            const charactersEmpty = document.getElementById('charactersEmpty');
            const charactersFooter = document.getElementById('charactersFooter');
            
            if (characters.length > 0) {
                charactersEmpty.style.display = 'none';
                charactersFooter.style.display = 'block';
                
                // Sort: main characters first
                const sortedChars = [...characters].sort((a, b) => {
                    const aIsMain = typeof CharacterStorage !== 'undefined' && CharacterStorage.isMainCharacter(a.id);
                    const bIsMain = typeof CharacterStorage !== 'undefined' && CharacterStorage.isMainCharacter(b.id);
                    if (aIsMain && !bIsMain) return -1;
                    if (!aIsMain && bIsMain) return 1;
                    return 0;
                });
                
                charactersList.innerHTML = sortedChars.slice(0, 3).map(renderCharacterItem).join('');
            } else {
                charactersEmpty.style.display = 'flex';
                charactersFooter.style.display = 'none';
            }
        }
        
        function updateCountdown(targetDate) {
            const now = new Date();
            const diff = targetDate - now;
            
            if (diff <= 0) {
                document.getElementById('countdownDays').textContent = '0';
                document.getElementById('countdownHours').textContent = '0';
                document.getElementById('countdownMins').textContent = '0';
                return;
            }
            
            const days = Math.floor(diff / (1000 * 60 * 60 * 24));
            const hours = Math.floor((diff % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
            const mins = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
            
            document.getElementById('countdownDays').textContent = days;
            document.getElementById('countdownHours').textContent = hours;
            document.getElementById('countdownMins').textContent = mins;
        }
        
        // Hero Countdown for the new Session Hero Card
        function updateHeroCountdown(targetDate) {
            const now = new Date();
            const diff = targetDate - now;
            
            const daysEl = document.getElementById('heroCountdownDays');
            const hoursEl = document.getElementById('heroCountdownHours');
            const minsEl = document.getElementById('heroCountdownMins');
            
            if (!daysEl || !hoursEl || !minsEl) return;
            
            if (diff <= 0) {
                daysEl.textContent = '0';
                hoursEl.textContent = '0';
                minsEl.textContent = '0';
                return;
            }
            
            const days = Math.floor(diff / (1000 * 60 * 60 * 24));
            const hours = Math.floor((diff % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
            const mins = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
            
            daysEl.textContent = days;
            hoursEl.textContent = hours;
            minsEl.textContent = mins;
        }
        
        function renderSessionItem(session) {
            const rulesetConfig = {
                '5e2024': { name: 'D&D 5e', badge: '5e', icon: 'assets/img/rulesets/ruleset_5e_2024.svg' },
                'worldsapart': { name: 'Worlds Apart', badge: 'worldsapart', icon: 'assets/img/rulesets/ruleset_worldsapart.svg' },
                'htbah': { name: 'How To Be A Hero', badge: 'htbah', icon: 'assets/img/rulesets/ruleset_htbah.svg' },
                'cyberpunk': { name: 'Cyberpunk Red', badge: 'cyberpunk', icon: 'assets/img/rulesets/ruleset_cyberpunkred.svg' }
            };
            const ruleset = rulesetConfig[session.ruleset] || { name: session.ruleset, badge: '', icon: '' };
            
            return `
                <a href="session.html?id=${session.id}" class="widget__item session-item">
                    <div class="session-item__left">
                        <div class="ruleset-badge ruleset-badge--${ruleset.badge}">
                            <img src="${ruleset.icon}" alt="">
                            <span>${ruleset.name}</span>
                        </div>
                        <span class="session-item__title">${session.name}</span>
                        <span class="session-item__meta">${session.date} ¬∑ ${session.maxPlayers || 4} Spieler</span>
                    </div>
                </a>
            `;
        }
        
        function renderCharacterItem(char) {
            // Check if this is the main character for its ruleset
            const isMain = typeof CharacterStorage !== 'undefined' && CharacterStorage.isMainCharacter(char.id);
            
            // Get correct sheet URL based on ruleset
            const sheetUrl = {
                'worldsapart': 'sheet-worldsapart.html',
                'dnd5e': 'sheet-5e.html',
                '5e': 'sheet-5e-en.html',
                '5e-de': 'sheet-5e-de.html',
                'htbah': 'sheet-htbah.html',
                'cyberpunk': 'sheet-cyberpunk.html'
            }[char.ruleset] || 'sheet-worldsapart.html';
            
            return `
                <a href="${sheetUrl}?id=${char.id}" class="widget__item character-item ${isMain ? 'character-item--main' : ''}">
                    <div class="character-item__portrait" style="background: linear-gradient(135deg, ${isMain ? '#FFC107' : '#7c3aed'} 0%, ${isMain ? '#FF8F00' : '#4c1d95'} 100%);">
                        <span class="character-item__initial">${isMain ? '‚òÖ' : (char.name ? char.name.charAt(0).toUpperCase() : '?')}</span>
                    </div>
                    <div class="widget__item-info">
                        <span class="character-item__name">${isMain ? '‚òÖ ' : ''}${char.name || 'Unbenannt'}</span>
                        <span class="widget__item-meta">${char.race || char.class || char.data?.role || ''}</span>
                    </div>
                </a>
            `;
        }
        
        // Reload dashboard when coming back via browser Back button (bfcache)
        window.addEventListener('pageshow', function(event) {
            if (event.persisted) {
                console.log('[Hub] Page restored from bfcache, reloading dashboard');
                loadDashboardData();
            }
        });
        
        // Reload dashboard when tab becomes visible again
        document.addEventListener('visibilitychange', function() {
            if (document.visibilityState === 'visible' && window._heroSkeletonRemoved) {
                console.log('[Hub] Tab became visible, refreshing dashboard');
                loadDashboardData();
            }
        });
        
        // Final safety net: ensure dashboard loads within 3 seconds no matter what
        setTimeout(() => {
            if (!window._heroSkeletonRemoved) {
                console.warn('[Hub] Safety net triggered - forcing dashboard load');
                loadDashboardData();
            }
        }, 3000);
        
        // Dashboard wird von initFirebaseSessions geladen
        // (nicht direkt aufrufen - verhindert Flash des falschen Contents)
    </script>
    
    <!-- Hub & Header Controller -->
    <script src="assets/js/hub-controller.js"></script>
    <script src="assets/js/header-controller.js"></script>
    <script src="assets/js/hub-features.js"></script>
    <script src="assets/js/broadcast.js"></script>
    
    <!-- TopNav & MegaNav Interactivity -->
    <script>
    console.log('=== [TopNav] Script loaded ===');
    
    // Event Delegation f√ºr alle Dropdowns
    document.addEventListener('click', function(e) {
        // Sicherheitspr√ºfung
        if (!e.target || typeof e.target.closest !== 'function') return;
        
        // TopNav Dropdown Trigger geklickt?
        var trigger = e.target.closest('.topnav__dropdown-trigger');
        if (trigger) {
            e.stopPropagation();
            console.log('[TopNav] Trigger clicked:', trigger.id || 'no-id');
            
            var wasOpen = trigger.classList.contains('open');
            
            // Alle TopNav Dropdowns schlie√üen
            document.querySelectorAll('.topnav__dropdown-trigger').forEach(function(t) {
                t.classList.remove('open');
            });
            
            // Diesen √∂ffnen wenn er vorher zu war
            if (!wasOpen) {
                trigger.classList.add('open');
                console.log('[TopNav] Dropdown opened');
            }
            return;
        }
        
        // MegaNav Item geklickt?
        var megaItem = e.target.closest('.meganav__item');
        if (megaItem && !megaItem.classList.contains('meganav__item--link')) {
            // Nur wenn nicht auf einen Link geklickt wurde
            if (!e.target.closest('a') || e.target.closest('.meganav__item') === megaItem) {
                e.stopPropagation();
                console.log('[TopNav] MegaNav item clicked');
                
                var wasOpen = megaItem.classList.contains('open');
                
                // Alle MegaNav Dropdowns schlie√üen
                document.querySelectorAll('.meganav__item').forEach(function(i) {
                    i.classList.remove('open');
                });
                
                if (!wasOpen) {
                    megaItem.classList.add('open');
                }
            }
            return;
        }
        
        // Klick au√üerhalb - alle schlie√üen
        document.querySelectorAll('.topnav__dropdown-trigger.open').forEach(function(t) {
            t.classList.remove('open');
        });
        document.querySelectorAll('.meganav__item.open').forEach(function(i) {
            i.classList.remove('open');
        });
    });
    
    // Hover f√ºr MegaNav (Desktop)
    document.addEventListener('mouseenter', function(e) {
        if (window.innerWidth <= 768) return;
        if (!e.target || typeof e.target.closest !== 'function') return;
        
        var megaItem = e.target.closest('.meganav__item:not(.meganav__item--link)');
        if (megaItem) {
            document.querySelectorAll('.meganav__item.open').forEach(function(i) {
                i.classList.remove('open');
            });
            megaItem.classList.add('open');
        }
    }, true);
    
    // MegaNav verlassen
    var meganav = document.querySelector('.meganav');
    if (meganav) {
        meganav.addEventListener('mouseleave', function() {
            if (window.innerWidth > 768) {
                document.querySelectorAll('.meganav__item.open').forEach(function(i) {
                    i.classList.remove('open');
                });
            }
        });
    }
    
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // SEARCH
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    var searchInput = document.getElementById('searchInput');
    var searchDropdown = document.getElementById('search-dropdown');
    
    if (searchInput && searchDropdown) {
        var searchData = [
            { cat: 'Seiten', name: 'Hub', url: 'index.html', icon: 'üè†' },
            { cat: 'Seiten', name: 'W√ºrfel', url: 'dice.html', icon: 'üé≤' },
            { cat: 'Seiten', name: 'Whiteboard', url: 'whiteboard.html', icon: 'üé®' },
            { cat: 'Seiten', name: 'Karten', url: 'maps.html', icon: 'üó∫Ô∏è' },
            { cat: 'Seiten', name: 'Chat', url: 'chat.html', icon: 'üí¨' },
            { cat: 'Seiten', name: 'Sessions', url: 'sessions.html', icon: 'üìÖ' },
            { cat: 'Regelwerke', name: 'Worlds Apart', url: 'sheet-worldsapart.html', icon: 'üìó' },
            { cat: 'Regelwerke', name: 'D&D 5e', url: 'sheet-dnd5e.html', icon: 'üìï' },
            { cat: 'Regelwerke', name: 'Cyberpunk Red', url: 'sheet-cyberpunk.html', icon: 'üìò' },
            { cat: 'Regelwerke', name: 'HTBAH', url: 'sheet-htbah.html', icon: 'üìô' }
        ];
        
        searchInput.addEventListener('input', function() {
            var query = this.value.toLowerCase();
            if (!query) {
                searchDropdown.classList.remove('active');
                return;
            }
            
            var results = searchData.filter(function(item) {
                return item.name.toLowerCase().indexOf(query) !== -1;
            });
            
            if (results.length === 0) {
                searchDropdown.innerHTML = '<div style="padding:20px;text-align:center;color:rgba(255,255,255,0.5);">Keine Ergebnisse</div>';
            } else {
                var html = '';
                results.forEach(function(item) {
                    html += '<a href="' + item.url + '" style="display:flex;align-items:center;gap:12px;padding:10px 16px;text-decoration:none;color:#fff;">';
                    html += '<span style="font-size:18px;">' + item.icon + '</span>';
                    html += '<span>' + item.name + '</span></a>';
                });
                searchDropdown.innerHTML = html;
            }
            searchDropdown.classList.add('active');
        });
        
        document.addEventListener('click', function(e) {
            if (!e.target.closest('.topnav__search')) {
                searchDropdown.classList.remove('active');
            }
        });
    }
    
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // USER & ROOM CODE
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    var roomCode = localStorage.getItem('rift_current_room');
    var roomTrigger = document.getElementById('roomTrigger');
    
    if (roomCode) {
        var formatted = roomCode.length === 6 
            ? roomCode.substring(0, 3) + '-' + roomCode.substring(3)
            : roomCode;
        formatted = formatted.toUpperCase();
        
        var codeDisplay = document.getElementById('roomCodeDisplay');
        var codeLarge = document.getElementById('roomCodeLarge');
        if (codeDisplay) codeDisplay.textContent = formatted;
        if (codeLarge) codeLarge.textContent = formatted;
    } else if (roomTrigger) {
        roomTrigger.style.display = 'none';
    }
    
    // Firebase Auth - warte bis Firebase bereit ist
    function initFirebaseAuth() {
        if (typeof firebase !== 'undefined' && firebase.apps && firebase.apps.length > 0) {
            firebase.auth().onAuthStateChanged(async function(user) {
                var userAvatar = document.getElementById('userAvatar');
                var userName = document.getElementById('userName');
                var userAvatarLarge = document.getElementById('userAvatarLarge');
                var userNameLarge = document.getElementById('userNameLarge');
                var userEmail = document.getElementById('userEmail');
                
                if (user) {
                    // Hole User-Daten aus Firestore (displayName, color, avatar)
                    var displayName = user.displayName || (user.email ? user.email.split('@')[0] : 'Spieler');
                    var color = '#8b5cf6';
                    var avatarUrl = null;
                    
                    try {
                        var userDoc = await firebase.firestore().collection('users').doc(user.uid).get();
                        if (userDoc.exists) {
                            var data = userDoc.data();
                            if (data.displayName) displayName = data.displayName;
                            if (data.color) color = data.color;
                            if (data.avatar) avatarUrl = data.avatar;
                        }
                    } catch (e) {
                        console.log('[TopNav] Could not load user data from Firestore');
                    }
                    
                    var initial = displayName.charAt(0).toUpperCase();
                    
                    // TopNav User
                    if (userAvatar) {
                        userAvatar.style.background = color;
                        if (avatarUrl) {
                            userAvatar.innerHTML = '<img src="' + avatarUrl + '" alt="">';
                        } else {
                            userAvatar.textContent = initial;
                        }
                    }
                    if (userName) userName.textContent = displayName;
                    
                    // Dropdown User
                    if (userAvatarLarge) {
                        userAvatarLarge.style.background = color;
                        if (avatarUrl) {
                            userAvatarLarge.innerHTML = '<img src="' + avatarUrl + '" alt="">';
                        } else {
                            userAvatarLarge.textContent = initial;
                        }
                    }
                    if (userNameLarge) userNameLarge.textContent = displayName;
                    if (userEmail) userEmail.textContent = user.email || '';
                    
                    // Hub Greeting
                    var greetingUsername = document.getElementById('greetingUsername');
                    if (greetingUsername) greetingUsername.textContent = displayName;
                    
                    // Update time-based greeting
                    updateGreetingTime();
                }
            });
        } else {
            // Firebase noch nicht bereit, erneut versuchen
            setTimeout(initFirebaseAuth, 100);
        }
    }
    initFirebaseAuth();
    
    // Load Quote of Day when Firebase is ready
    function initQuoteOfDay() {
        if (typeof firebase !== 'undefined' && firebase.apps && firebase.apps.length > 0) {
            loadQuoteOfDay();
        } else {
            setTimeout(initQuoteOfDay, 100);
        }
    }
    initQuoteOfDay();
    
    // ========================================
    // ANNOUNCEMENT BANNER
    // ========================================
    async function loadAnnouncementBanner() {
        const container = document.getElementById('announcementBanner');
        if (!container) return;
        
        try {
            const db = firebase.firestore();
            const snapshot = await db.collection('announcements')
                .where('active', '==', true)
                .orderBy('createdAt', 'desc')
                .limit(1)
                .get();
            
            if (snapshot.empty) {
                container.style.display = 'none';
                return;
            }
            
            const banner = snapshot.docs[0].data();
            
            // Check time constraints if set
            const now = new Date();
            if (banner.startDate) {
                const start = banner.startDate.toDate ? banner.startDate.toDate() : new Date(banner.startDate);
                if (now < start) { container.style.display = 'none'; return; }
            }
            if (banner.endDate) {
                const end = banner.endDate.toDate ? banner.endDate.toDate() : new Date(banner.endDate);
                if (now > end) { container.style.display = 'none'; return; }
            }
            
            // Check if user dismissed this banner
            const dismissedId = localStorage.getItem('dismissedBanner');
            if (dismissedId === snapshot.docs[0].id) {
                container.style.display = 'none';
                return;
            }
            
            const colors = {
                info: { bg: '#3B82F620', border: '#3B82F640', text: '#3B82F6', icon: '‚ÑπÔ∏è' },
                warning: { bg: '#F59E0B20', border: '#F59E0B40', text: '#F59E0B', icon: '‚ö†Ô∏è' },
                critical: { bg: '#EF444420', border: '#EF444440', text: '#EF4444', icon: 'üö®' }
            };
            const c = colors[banner.level] || colors.info;
            
            container.innerHTML = `
                <div style="background: ${c.bg}; border: 1px solid ${c.border}; border-radius: 12px; padding: 16px 20px; margin-bottom: 24px; display: flex; align-items: center; gap: 16px;">
                    <span style="font-size: 24px;">${c.icon}</span>
                    <div style="flex: 1;">
                        <div style="font-weight: 600; color: ${c.text}; margin-bottom: 2px;">${banner.title}</div>
                        ${banner.message ? '<div style="font-size: 14px; color: var(--text-muted);">' + banner.message + '</div>' : ''}
                    </div>
                    <button onclick="dismissBanner('${snapshot.docs[0].id}')" style="background: none; border: none; color: var(--text-muted); cursor: pointer; padding: 8px; font-size: 18px;" title="Schlie√üen">‚úï</button>
                </div>
            `;
            container.style.display = 'block';
            
            console.log('[Hub] Banner loaded:', banner.title);
            
        } catch (e) {
            console.warn('[Hub] Banner load error:', e.message);
            container.style.display = 'none';
        }
    }
    
    function dismissBanner(id) {
        localStorage.setItem('dismissedBanner', id);
        document.getElementById('announcementBanner').style.display = 'none';
    }
    
    // Init banner when Firebase ready
    function initAnnouncementBanner() {
        if (typeof firebase !== 'undefined' && firebase.apps && firebase.apps.length > 0) {
            loadAnnouncementBanner();
        } else {
            setTimeout(initAnnouncementBanner, 100);
        }
    }
    initAnnouncementBanner();
    
    // Time-based greeting
    function updateGreetingTime() {
        var greetingTime = document.getElementById('greetingTime');
        if (!greetingTime) return;
        
        var hour = new Date().getHours();
        var greeting = 'Guten Tag,';
        
        if (hour >= 5 && hour < 12) {
            greeting = 'Guten Morgen,';
        } else if (hour >= 12 && hour < 18) {
            greeting = 'Guten Tag,';
        } else {
            greeting = 'Guten Abend,';
        }
        
        greetingTime.textContent = greeting;
    }
    updateGreetingTime();
    
    // Logout
    var logoutBtn = document.getElementById('logoutBtn');
    if (logoutBtn) {
        logoutBtn.addEventListener('click', function(e) {
            e.preventDefault();
            if (typeof firebase !== 'undefined' && firebase.auth) {
                firebase.auth().signOut().then(function() {
                    window.location.href = 'login.html';
                });
            }
        });
    }
    
    console.log('=== [TopNav] Initialized ===');
    </script>
</body>
</html>
