<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <meta name="description" content="RIFT - Dein digitaler Begleiter f√ºr Pen & Paper Rollenspiele">
    <meta name="theme-color" content="#161616" media="(prefers-color-scheme: dark)">
    <meta name="theme-color" content="#f5f5f5" media="(prefers-color-scheme: light)">
    <title>RIFT</title>
    
    <!-- PWA -->
    <link rel="manifest" href="manifest.json">
    <link rel="icon" href="/assets/icons/icon_rift_r.svg" type="image/svg+xml">
    <link rel="apple-touch-icon" href="assets/icons/icon-192.png">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="RIFT">
    <meta name="view-transition" content="same-origin">
    
    <!-- Styles -->
    <link rel="stylesheet" href="assets/css/core.css">
    <link rel="stylesheet" href="assets/css/ui.css">
    <link rel="stylesheet" href="assets/css/sidebar.css">
    <link rel="stylesheet" href="assets/css/topbar.css">
    <link rel="stylesheet" href="assets/css/dock.css">
    <link rel="stylesheet" href="assets/css/footer.css">
    <link rel="stylesheet" href="assets/css/hub.css">
    <link rel="stylesheet" href="assets/css/settings.css">
    <link rel="stylesheet" href="assets/css/article.css">
    <link rel="stylesheet" href="assets/css/hub-features.css">
    
    <!-- Cropper.js -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.6.1/cropper.min.css">
</head>
<body>
    <div class="app">
        <main class="main main--hub">
            <div class="main__content">
                
                <!-- Page Header -->
                <div class="page-header">
                    <div class="page-header__icon">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                            <path fill-rule="evenodd" clip-rule="evenodd" d="M2.5192 7.82274C2 8.77128 2 9.91549 2 12.2039V13.725C2 17.6258 2 19.5763 3.17157 20.7881C4.34315 22 6.22876 22 10 22H14C17.7712 22 19.6569 22 20.8284 20.7881C22 19.5763 22 17.6258 22 13.725V12.2039C22 9.91549 22 8.77128 21.4808 7.82274C20.9616 6.87421 20.0131 6.28551 18.116 5.10812L16.116 3.86687C14.1106 2.62229 13.1079 2 12 2C10.8921 2 9.88939 2.62229 7.88403 3.86687L5.88403 5.10813C3.98695 6.28551 3.0384 6.87421 2.5192 7.82274ZM9 17.25C8.58579 17.25 8.25 17.5858 8.25 18C8.25 18.4142 8.58579 18.75 9 18.75H15C15.4142 18.75 15.75 18.4142 15.75 18C15.75 17.5858 15.4142 17.25 15 17.25H9Z"/>
                        </svg>
                    </div>
                    <div class="page-header__divider"></div>
                    <h1 class="page-header__title">Hub</h1>
                    <span class="page-header__tagline">Dein Abenteuer beginnt hier</span>
                </div>
                
                <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
                     1. HERO CAROUSEL (Admin-editable via carousel-config.json)
                     ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
                <div class="hero-carousel" id="heroCarousel">
                    <div class="hero-carousel__slides" id="carouselSlides">
                        <!-- Slides werden dynamisch aus admin/carousel-config.json geladen -->
                    </div>
                    
                    <!-- Navigation Arrows -->
                    <button class="hero-carousel__nav hero-carousel__nav--prev" aria-label="Vorherige Slide">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M15 18l-6-6 6-6"/></svg>
                    </button>
                    <button class="hero-carousel__nav hero-carousel__nav--next" aria-label="N√§chste Slide">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M9 18l6-6-6-6"/></svg>
                    </button>
                    
                    <!-- Tab Navigation -->
                    <div class="hero-carousel__tabs" id="carouselTabs">
                        <!-- Tabs werden dynamisch generiert -->
                    </div>
                    
                    <!-- Dots (Mobile) -->
                    <div class="hero-carousel__dots" id="carouselDots">
                        <!-- Dots werden dynamisch generiert -->
                    </div>
                </div>
                
                <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
                     2. SESSION/CHARACTER CARDS
                     ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
                <div class="hub-section hub-section--cards">
                    <!-- Hero Section -->
                <div class="hero-section" id="heroSection">
                    <!-- Loading Skeleton (initial sichtbar) -->
                    <div class="hero-loading" id="heroLoading">
                        <div class="hero-loading__card hero-loading__card--small"></div>
                        <div class="hero-loading__card hero-loading__card--large"></div>
                    </div>
                    
                    <!-- Kompakter Status-Banner (kontextabh√§ngig) -->
                    <div class="status-banner" id="statusBanner" style="display: none;">
                        <div class="status-banner__icon" id="statusIcon">
                            <!-- Icon wird dynamisch gesetzt -->
                        </div>
                        <div class="status-banner__content">
                            <h3 class="status-banner__title" id="statusTitle">Willkommen bei RIFT</h3>
                            <p class="status-banner__text" id="statusText">Erstelle deinen ersten Charakter oder plane eine Session.</p>
                        </div>
                        <div class="status-banner__actions" id="statusActions">
                            <!-- Buttons werden dynamisch gesetzt -->
                        </div>
                    </div>
                    
                    <!-- Container f√ºr dynamische Karten (initial versteckt) -->
                    <div id="continueCardsContainer" style="display: none;"></div>
                    
                    <!-- Hero Cards Container -->
                    <div class="hero-cards-container" id="heroCardsContainer" style="display: none;">
                        
                        <!-- Character Hero Card (links) -->
                        <a href="#" class="character-hero" id="characterHeroCard" style="display: none;">
                            <div class="character-hero__portrait" id="characterHeroPortrait">
                                <!-- Portrait or placeholder -->
                            </div>
                            <div class="character-hero__content">
                                <span class="character-hero__label">Dein Charakter</span>
                                <h3 class="character-hero__name" id="characterHeroName">Charakter</h3>
                                <div class="character-hero__meta">
                                    <span class="character-hero__class" id="characterHeroClass"></span>
                                </div>
                                <div class="character-hero__stats" id="characterHeroStats">
                                    <div class="character-hero__stat">
                                        <span class="character-hero__stat-icon character-hero__stat-icon--lp">
                                            <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="currentColor"><path d="M6.979 3.074a6 6 0 0 1 4.988 1.425l.037 .033l.034 -.03a6 6 0 0 1 4.733 -1.44l.246 .036a6 6 0 0 1 3.364 10.008l-.18 .185l-.048 .041l-7.45 7.379a1 1 0 0 1 -1.313 .082l-.094 -.082l-7.493 -7.422a6 6 0 0 1 3.176 -10.215z"/></svg>
                                        </span>
                                        <div class="character-hero__stat-bar">
                                            <div class="character-hero__stat-fill character-hero__stat-fill--lp" id="characterHeroLpBar" style="width: 100%"></div>
                                        </div>
                                        <span class="character-hero__stat-value" id="characterHeroLpValue">--</span>
                                    </div>
                                    <div class="character-hero__stat">
                                        <span class="character-hero__stat-icon character-hero__stat-icon--moral">
                                            <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="currentColor"><path d="M12 23c-6.627 0-12-4.925-12-11c0-3.073 1.152-5.881 3.051-8.009a1 1 0 0 1 1.47 -.076l2.121 2.121c.603 .603 1.572 .705 2.3 .242l1.894 -1.205a1 1 0 0 1 1.197 .054l2.042 1.701c.68 .567 1.678 .593 2.389 .062l1.724 -1.29a1 1 0 0 1 1.448 .196c1.565 2.091 2.364 4.678 2.364 7.204c0 6.075-5.373 11-12 11z"/></svg>
                                        </span>
                                        <div class="character-hero__stat-bar">
                                            <div class="character-hero__stat-fill character-hero__stat-fill--moral" id="characterHeroMoralBar" style="width: 100%"></div>
                                        </div>
                                        <span class="character-hero__stat-value" id="characterHeroMoralValue">--</span>
                                    </div>
                                </div>
                            </div>
                        </a>
                        
                        <!-- Session Hero Card (rechts) -->
                        <a href="#" class="session-hero" id="sessionHeroCard" style="display: none;">
                            <div class="session-hero__cover" id="sessionHeroCover">
                                <!-- Cover image or placeholder -->
                            </div>
                            <div class="session-hero__content">
                                <div class="session-hero__header">
                                    <span class="session-hero__label">Weiterspielen</span>
                                    <div class="session-hero__gm-badge" id="sessionHeroGmBadge" style="display: none;">
                                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                            <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/>
                                            <circle cx="12" cy="7" r="4"/>
                                        </svg>
                                        <span>Game Master</span>
                                    </div>
                                </div>
                                <h2 class="session-hero__title" id="sessionHeroTitle">Session Name</h2>
                                <p class="session-hero__subtitle" id="sessionHeroSubtitle"></p>
                                <div class="session-hero__meta">
                                    <span class="session-hero__ruleset" id="sessionHeroRuleset">
                                        <img src="" alt="">
                                        <span></span>
                                    </span>
                                    <span class="session-hero__session-num" id="sessionHeroSessionNum">Session 1/2</span>
                                </div>
                                <div class="session-hero__tags" id="sessionHeroTags"></div>
                                <div class="session-hero__footer">
                                    <span class="session-hero__btn">
                                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                            <path d="M15 3h4a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2h-4"/>
                                            <polyline points="10 17 15 12 10 7"/>
                                            <line x1="15" y1="12" x2="3" y2="12"/>
                                        </svg>
                                        Session √∂ffnen
                                    </span>
                                </div>
                            </div>
                            <div class="session-hero__calendar">
                                <span class="session-hero__calendar-label">N√§chste Session</span>
                                <div class="session-hero__date-box" id="sessionHeroDateBox">
                                    <span class="session-hero__day" id="sessionHeroDay">--</span>
                                    <span class="session-hero__num" id="sessionHeroNum">--</span>
                                    <span class="session-hero__month" id="sessionHeroMonth">---</span>
                                </div>
                                <span class="session-hero__time" id="sessionHeroTime">--:-- Uhr</span>
                                <div class="session-hero__countdown" id="sessionHeroCountdown">
                                    <span class="session-hero__countdown-value" id="heroCountdownDays">-</span>
                                    <span class="session-hero__countdown-label">T</span>
                                    <span class="session-hero__countdown-sep">:</span>
                                    <span class="session-hero__countdown-value" id="heroCountdownHours">-</span>
                                    <span class="session-hero__countdown-label">Std</span>
                                    <span class="session-hero__countdown-sep">:</span>
                                    <span class="session-hero__countdown-value" id="heroCountdownMins">-</span>
                                    <span class="session-hero__countdown-label">Min</span>
                                </div>
                                <div class="session-hero__no-date" id="sessionHeroNoDate" style="display: none;">
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <rect x="3" y="4" width="18" height="18" rx="2" ry="2"/>
                                        <line x1="16" y1="2" x2="16" y2="6"/>
                                        <line x1="8" y1="2" x2="8" y2="6"/>
                                        <line x1="3" y1="10" x2="21" y2="10"/>
                                    </svg>
                                    <span>Kein Termin</span>
                                </div>
                            </div>
                        </a>
                    </div>
                    
                    <!-- N√§chste Session Card (legacy - f√ºr Fallback wenn keine aktive Session) -->
                    <a href="/sessions" class="next-session-card" id="nextSessionCard" style="display: none;">
                        <div class="next-session-card__header">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <rect x="3" y="4" width="18" height="18" rx="2" ry="2"/>
                                <line x1="16" y1="2" x2="16" y2="6"/>
                                <line x1="8" y1="2" x2="8" y2="6"/>
                                <line x1="3" y1="10" x2="21" y2="10"/>
                            </svg>
                            <span>N√§chste Session</span>
                        </div>
                        <div class="next-session-card__date">
                            <span class="next-session-card__day" id="nextSessionDay">--</span>
                            <span class="next-session-card__num" id="nextSessionNum">--</span>
                            <span class="next-session-card__month" id="nextSessionMonth">---</span>
                        </div>
                        <div class="next-session-card__time" id="nextSessionTime">--:-- Uhr</div>
                        <div class="next-session-card__countdown" id="sessionCountdown">
                            <span class="countdown__value" id="countdownDays">-</span>
                            <span class="countdown__label">Tage</span>
                            <span class="countdown__sep">:</span>
                            <span class="countdown__value" id="countdownHours">-</span>
                            <span class="countdown__label">Std</span>
                            <span class="countdown__sep">:</span>
                            <span class="countdown__value" id="countdownMins">-</span>
                            <span class="countdown__label">Min</span>
                        </div>
                    </a>
                </div>
                </div><!-- Ende hub-section--cards -->
                
                <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
                     3. NEUIGKEITEN (mit dunklem Hintergrund)
                     ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
                <div class="hub-section hub-section--dark">
                    <div class="hub-section__inner">
                        
                        <!-- News + Feature Showcase Row -->
                        <div class="hub-showcase">
                    
                    <!-- LEFT: News Section -->
                    <section class="news-section" id="newsSection">
                        <header class="news-section__header">
                            <h2 class="news-section__title">
                                <span class="news-section__icon">‚óÜ</span>
                                Neuigkeiten
                            </h2>
                            <a href="roadmap.html" class="news-section__link">
                                Alle Beitr√§ge
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M5 12h14M12 5l7 7-7 7"/>
                                </svg>
                            </a>
                        </header>
                        
                        <!-- Category Tabs -->
                        <nav class="news-tabs" id="newsTabs">
                            <button class="news-tab active" data-category="all">Alle</button>
                            <button class="news-tab" data-category="news">News</button>
                            <button class="news-tab" data-category="update">Updates</button>
                            <button class="news-tab" data-category="guide">Guides</button>
                        </nav>
                        
                        <!-- Loading State -->
                        <div class="news-layout news-layout--loading" id="newsLoading">
                            <div class="news-featured news-featured--skeleton">
                                <div class="skeleton"></div>
                            </div>
                            <div class="news-list">
                                <div class="news-list-item news-list-item--skeleton"><div class="skeleton"></div></div>
                                <div class="news-list-item news-list-item--skeleton"><div class="skeleton"></div></div>
                                <div class="news-list-item news-list-item--skeleton"><div class="skeleton"></div></div>
                            </div>
                        </div>
                        
                        <!-- News Layout (filled by JS) -->
                        <div class="news-layout" id="newsLayout" style="display: none;">
                            <a class="news-featured" id="newsFeatured" href="#"></a>
                            <div class="news-list" id="newsList"></div>
                        </div>
                        
                        <!-- Empty State -->
                        <div class="news-empty" id="newsEmpty" style="display: none;">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                                <path d="M19 20H5a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h10a2 2 0 0 1 2 2v1m2 13a2 2 0 0 1-2-2V9a2 2 0 0 1 2-2h2a2 2 0 0 1 2 2v9a2 2 0 0 1-2 2h-2z"/>
                            </svg>
                            <p>Bald gibt's Neuigkeiten!</p>
                        </div>
                    </section>
                    
                    </div><!-- Ende hub-showcase -->
                    </div><!-- Ende hub-section__inner -->
                </div><!-- Ende hub-section--dark -->
                
                <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
                     5. FEATURE SHOWCASE
                     ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
                <div class="hub-section hub-section--features">
                    <section class="feature-showcase feature-showcase--fullwidth" id="featureShowcase">
                        <!-- Feature Content -->
                        <div class="feature-content" id="featureContent">
                            <!-- Charsheet Tab -->
                            <div class="feature-panel active" data-panel="charsheet">
                                <div class="feature-panel__inner">
                                    <div class="feature-panel__image feature-panel__image--placeholder">
                                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                                            <rect x="3" y="3" width="18" height="18" rx="2"/>
                                            <circle cx="8.5" cy="8.5" r="1.5"/>
                                            <polyline points="21 15 16 10 5 21"/>
                                        </svg>
                                    </div>
                                    <div class="feature-panel__text">
                                        <nav class="feature-tabs" id="featureTabs">
                                            <button class="feature-tab active" data-feature="charsheet">Charakterbogen</button>
                                            <button class="feature-tab" data-feature="dice">W√ºrfel</button>
                                            <button class="feature-tab" data-feature="maps">Maps VTT</button>
                                        </nav>
                                        <h3 class="feature-panel__title">Erschaffe jeden Helden, den du dir vorstellen kannst</h3>
                                        <p class="feature-panel__desc">Mit RIFTs digitalem Charakterbogen hast du alle Werte, F√§higkeiten und Ausr√ºstung immer griffbereit. Unterst√ºtzt mehrere Regelwerke und synchronisiert in Echtzeit.</p>
                                        <ul class="feature-panel__list">
                                            <li>Charakter in Sekunden erstellen</li>
                                            <li>D&D 5e, Worlds Apart, HTBAH & mehr</li>
                                            <li>√úberall spielen ‚Äì Desktop & Mobile</li>
                                        </ul>
                                        <a href="characters.html" class="feature-panel__cta">
                                            Charakter erstellen
                                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                                <path d="M5 12h14M12 5l7 7-7 7"/>
                                            </svg>
                                        </a>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Dice Tab -->
                            <div class="feature-panel" data-panel="dice">
                                <div class="feature-panel__inner">
                                    <div class="feature-panel__image feature-panel__image--placeholder">
                                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                                            <rect x="3" y="3" width="18" height="18" rx="2"/>
                                            <circle cx="8.5" cy="8.5" r="1.5"/>
                                            <polyline points="21 15 16 10 5 21"/>
                                        </svg>
                                    </div>
                                    <div class="feature-panel__text">
                                        <nav class="feature-tabs">
                                            <button class="feature-tab" data-feature="charsheet">Charakterbogen</button>
                                            <button class="feature-tab active" data-feature="dice">W√ºrfel</button>
                                            <button class="feature-tab" data-feature="maps">Maps VTT</button>
                                        </nav>
                                        <h3 class="feature-panel__title">W√ºrfle mit Stil</h3>
                                        <p class="feature-panel__desc">3D-W√ºrfel mit Physik-Simulation, synchronisiert f√ºr alle Spieler in Echtzeit. Jeder Wurf wird f√ºr die ganze Gruppe sichtbar.</p>
                                        <ul class="feature-panel__list">
                                            <li>Alle g√§ngigen W√ºrfeltypen</li>
                                            <li>Benutzerdefinierte W√ºrfelsets</li>
                                            <li>Geteilte W√ºrfelhistorie</li>
                                        </ul>
                                        <a href="dice.html" class="feature-panel__cta">
                                            W√ºrfel ausprobieren
                                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                                <path d="M5 12h14M12 5l7 7-7 7"/>
                                            </svg>
                                        </a>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Maps Tab -->
                            <div class="feature-panel" data-panel="maps">
                                <div class="feature-panel__inner">
                                    <div class="feature-panel__image feature-panel__image--placeholder">
                                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                                            <rect x="3" y="3" width="18" height="18" rx="2"/>
                                            <circle cx="8.5" cy="8.5" r="1.5"/>
                                            <polyline points="21 15 16 10 5 21"/>
                                        </svg>
                                    </div>
                                    <div class="feature-panel__text">
                                        <nav class="feature-tabs">
                                            <button class="feature-tab" data-feature="charsheet">Charakterbogen</button>
                                            <button class="feature-tab" data-feature="dice">W√ºrfel</button>
                                            <button class="feature-tab active" data-feature="maps">Maps VTT</button>
                                        </nav>
                                        <h3 class="feature-panel__title">Bringe deine Welt zum Leben</h3>
                                        <p class="feature-panel__desc">Interaktive Karten mit Fog of War, Markern und Echtzeit-Synchronisation f√ºr immersive Sessions.</p>
                                        <ul class="feature-panel__list">
                                            <li>Eigene Karten hochladen</li>
                                            <li>Fog of War f√ºr Spannung</li>
                                            <li>Token & Marker System</li>
                                        </ul>
                                        <a href="maps.html" class="feature-panel__cta">
                                            Maps entdecken
                                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                                <path d="M5 12h14M12 5l7 7-7 7"/>
                                            </svg>
                                        </a>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </section>
                </div>

                <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
                     4. QUOTE OF THE DAY
                     ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
                <div class="hub-section hub-section--quote">
                    <div class="quote-of-day" id="quoteOfDay">
                        
                        <div class="quote-of-day__label">
                            <svg viewBox="0 0 24 24" fill="currentColor"><path d="M12 2l3.09 6.26l6.91 1.01l-5 4.87l1.18 6.86l-6.18 -3.25l-6.18 3.25l1.18 -6.86l-5 -4.87l6.91 -1.01l3.09 -6.26z"/></svg>
                            Zitat des Tages
                        </div>
                        <p class="quote-of-day__text" id="quoteText">‚ÄûEin wahrer Held ist nicht der, der keine Angst kennt, sondern der, der trotz seiner Angst handelt."</p>
                        <div class="quote-of-day__footer">
                            <div class="quote-of-day__author">
                                <span class="quote-of-day__name" id="quoteAuthor">Gandalf der Graue</span>
                                <span class="quote-of-day__source" id="quoteSource">Der Herr der Ringe</span>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
                     6. INFO CARDS (Widgets)
                     ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
                <div class="hub-section hub-section--widgets">
                    <!-- Widget Grid -->
                    <div class="widgets">
                    
                    <!-- Widget: Letzte Sessions -->
                    <div class="widget">
                        <div class="widget__header">
                            <h2 class="widget__title">Letzte Sessions</h2>
                            <a href="/sessions" class="widget__action">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
                                Neu
                            </a>
                        </div>
                        <div class="widget__content">
                            <div class="widget__list" id="recentSessionsList">
                                <!-- Dynamisch bef√ºllt -->
                            </div>
                            <!-- Empty State -->
                            <div class="widget__empty" id="sessionsEmpty">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                                    <rect x="3" y="4" width="18" height="18" rx="2" ry="2"/>
                                    <line x1="16" y1="2" x2="16" y2="6"/>
                                    <line x1="8" y1="2" x2="8" y2="6"/>
                                    <line x1="3" y1="10" x2="21" y2="10"/>
                                </svg>
                                <p>Noch keine Sessions</p>
                                <a href="/sessions" class="widget__empty-btn">Session erstellen</a>
                            </div>
                        </div>
                        <div class="widget__footer" id="sessionsFooter" style="display: none;">
                            <a href="/sessions" class="widget__link">
                                Alle Sessions anzeigen
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="9 18 15 12 9 6"/></svg>
                            </a>
                        </div>
                    </div>
                    
                    <!-- Widget: Aktive Charaktere -->
                    <div class="widget">
                        <div class="widget__header">
                            <h2 class="widget__title">Aktive Charaktere</h2>
                            <a href="/sheet" class="widget__action">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
                                Neu
                            </a>
                        </div>
                        <div class="widget__content">
                            <div class="widget__list" id="charactersList">
                                <!-- Dynamisch bef√ºllt -->
                            </div>
                            <!-- Empty State -->
                            <div class="widget__empty" id="charactersEmpty">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                                    <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/>
                                    <circle cx="12" cy="7" r="4"/>
                                </svg>
                                <p>Noch keine Charaktere</p>
                                <a href="/sheet" class="widget__empty-btn">Charakter erstellen</a>
                            </div>
                        </div>
                        <div class="widget__footer" id="charactersFooter" style="display: none;">
                            <a href="/sheet" class="widget__link">
                                Alle Charaktere
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="9 18 15 12 9 6"/></svg>
                            </a>
                        </div>
                    </div>
                    
                    <!-- Widget: Deine Party -->
                    <div class="widget">
                        <div class="widget__header">
                            <h2 class="widget__title">Deine Party</h2>
                            <button class="widget__action" id="invitePartyBtn">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M16 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="8.5" cy="7" r="4"/><line x1="20" y1="8" x2="20" y2="14"/><line x1="23" y1="11" x2="17" y2="11"/></svg>
                                Einladen
                            </button>
                        </div>
                        <div class="widget__content">
                            <div class="widget__list" id="partyList">
                                <!-- Dynamisch bef√ºllt -->
                            </div>
                            <!-- Empty State -->
                            <div class="widget__empty" id="partyEmpty">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                                    <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/>
                                    <circle cx="9" cy="7" r="4"/>
                                    <path d="M23 21v-2a4 4 0 0 0-3-3.87"/>
                                    <path d="M16 3.13a4 4 0 0 1 0 7.75"/>
                                </svg>
                                <p>Noch keine Mitspieler</p>
                                <span class="widget__empty-hint">Teile deinen Raum-Code um Spieler einzuladen</span>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Widget: Session Timer -->
                    <div class="widget widget--compact" id="sessionTimerWidget" style="display: none;">
                        <div class="widget__header">
                            <h2 class="widget__title">Session l√§uft</h2>
                            <span class="session-timer__live">‚óè Live</span>
                        </div>
                        <div class="widget__content">
                            <div class="session-timer">
                                <div class="session-timer__display">
                                    <span class="session-timer__value" id="sessionTimerValue">0:00:00</span>
                                </div>
                                <div class="session-timer__controls">
                                    <button class="session-timer__btn" id="pauseSessionBtn" title="Pause">
                                        <svg viewBox="0 0 24 24" fill="currentColor"><rect x="6" y="4" width="4" height="16"/><rect x="14" y="4" width="4" height="16"/></svg>
                                    </button>
                                    <button class="session-timer__btn session-timer__btn--stop" id="stopSessionBtn" title="Session beenden">
                                        <svg viewBox="0 0 24 24" fill="currentColor"><rect x="4" y="4" width="16" height="16" rx="2"/></svg>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Widget: Achievements -->
                    <div class="widget widget--compact">
                        <div class="widget__header">
                            <h2 class="widget__title">Achievements</h2>
                        </div>
                        <div class="widget__content">
                            <div class="achievements">
                                <div class="achievement achievement--unlocked" title="Erste Schritte: Erste Session gespielt">
                                    <div class="achievement__icon">üé≤</div>
                                </div>
                                <div class="achievement achievement--unlocked" title="W√ºrfelmeister: 100 W√ºrfe">
                                    <div class="achievement__icon">üéØ</div>
                                </div>
                                <div class="achievement achievement--unlocked" title="Kritischer Treffer: Nat 20 gew√ºrfelt">
                                    <div class="achievement__icon">‚öîÔ∏è</div>
                                </div>
                                <div class="achievement achievement--unlocked" title="Geschichtenerz√§hler: 10 Sessions">
                                    <div class="achievement__icon">üìñ</div>
                                </div>
                                <div class="achievement" title="Veteran: 50 Sessions">
                                    <div class="achievement__icon">üèÜ</div>
                                </div>
                                <div class="achievement" title="Gl√ºckspilz: 5 Nat 20s in einer Session">
                                    <div class="achievement__icon">üçÄ</div>
                                </div>
                            </div>
                            <a href="#" class="widget__link widget__link--small">
                                Alle anzeigen (12/24)
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="9 18 15 12 9 6"/></svg>
                            </a>
                        </div>
                    </div>
                    
                </div>
                
            </div>
        </main>
        
        <!-- GM Floating Action Button -->
        <a href="gm.html" class="gm-fab" id="gmFab" style="display: none;" title="GM Optionen">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <circle cx="12" cy="12" r="3"/>
                <path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"/>
            </svg>
            <span>GM</span>
        </a>
    </div>
    
    <!-- Scripts -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.6.1/cropper.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/marked/11.1.1/marked.min.js"></script>
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    
    <!-- RIFT Services -->
    <script src="assets/js/firebase-config.js"></script>
    <script src="assets/js/room-service.js"></script>
    <script src="assets/js/user-service.js"></script>
    <script src="assets/js/character-storage.js"></script>
    
    <script src="assets/js/auth.js"></script>
    <script src="assets/js/ui.js"></script>
    <script src="assets/js/layout.js"></script>
    <script src="assets/js/settings.js"></script>
    <script src="assets/js/admin.js"></script>
    <script src="assets/js/news.js"></script>
    <script src="assets/js/data-manager.js"></script>
    <script src="assets/js/transitions.js"></script>
    <script src="assets/js/app.js"></script>
    <script>
        initLayout();
        
        // Get current room code for filtering
        var currentRoomCode = localStorage.getItem('rift_current_room') || null;
        
        // ========================================
        // PARTY MEMBERS (Realtime from Firebase)
        // ========================================
        (function() {
            const partyList = document.getElementById('partyList');
            const partyEmpty = document.getElementById('partyEmpty');
            let unsubscribe = null;
            
            function renderPartyMembers(members) {
                if (!partyList || !partyEmpty) return;
                
                const currentUserId = firebase.auth()?.currentUser?.uid;
                const currentUserData = window.currentUser || JSON.parse(localStorage.getItem('rift_user') || '{}');
                
                if (members.length === 0) {
                    partyList.style.display = 'none';
                    partyEmpty.style.display = 'flex';
                    return;
                }
                
                partyEmpty.style.display = 'none';
                partyList.style.display = 'flex';
                
                partyList.innerHTML = members.map(member => {
                    const isYou = member.id === currentUserId || member.id === currentUserData.uid;
                    
                    let name = member.displayName || member.name;
                    if (!name && isYou) name = currentUserData.displayName || currentUserData.name;
                    name = name || 'Unbekannt';
                    
                    const displayName = isYou ? name + ' (Du)' : name;
                    const color = (isYou ? currentUserData.color : member.color) || '#8B5CF6';
                    const initial = name.charAt(0).toUpperCase();
                    const avatar = member.avatar || member.photoURL || (isYou ? (currentUserData.avatar || currentUserData.photoURL) : null);
                    const isOnline = member.online === true;
                    const role = member.role === 'gm' ? 'Spielleiter' : 'Spieler';
                    
                    return `
                        <div style="display:flex;align-items:center;gap:12px;padding:10px 12px;background:rgba(255,255,255,0.03);border-radius:10px;border:1px solid rgba(255,255,255,0.06);">
                            <div style="position:relative;flex-shrink:0;">
                                <div style="width:38px;height:38px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:15px;font-weight:700;color:white;overflow:hidden;background:${color};">
                                    ${avatar ? `<img src="${avatar}" style="width:100%;height:100%;object-fit:cover;">` : initial}
                                </div>
                                <span style="position:absolute;bottom:-2px;right:-2px;width:12px;height:12px;border-radius:50%;border:2px solid #1a1a1a;background:${isOnline ? '#22c55e' : '#6b7280'};"></span>
                            </div>
                            <div style="display:flex;flex-direction:column;gap:2px;min-width:0;flex:1;">
                                <span style="font-size:14px;font-weight:600;color:white;">${displayName}</span>
                                <span style="font-size:12px;color:rgba(255,255,255,0.5);">${role}</span>
                            </div>
                        </div>
                    `;
                }).join('');
            }
            
            function subscribeToParty() {
                const roomCode = localStorage.getItem('rift_current_room');
                if (!roomCode) {
                    console.log('[Hub] No room code, skipping party subscription');
                    return;
                }
                
                // Wait for Firebase and RIFT.rooms
                if (typeof RIFT === 'undefined' || !RIFT.rooms) {
                    setTimeout(subscribeToParty, 500);
                    return;
                }
                
                console.log('[Hub] Subscribing to party members for room:', roomCode);
                
                // Unsubscribe from previous if exists
                if (unsubscribe) unsubscribe();
                
                // Subscribe to realtime updates
                unsubscribe = RIFT.rooms.subscribeToMembers(roomCode, (members) => {
                    console.log('[Hub] Received members update:', members);
                    renderPartyMembers(members);
                });
            }
            
            // Start subscription after a delay to ensure Firebase is ready
            setTimeout(subscribeToParty, 1000);
            
            // Cleanup on page unload
            window.addEventListener('beforeunload', () => {
                if (unsubscribe) unsubscribe();
            });
        })();
        
        // Show GM elements and adjust UI based on role
        (function() {
            const userData = JSON.parse(localStorage.getItem('rift_user') || '{}');
            let isGM = userData.isGM === true;
            
            function updateGMUI(gmStatus) {
                // GM FAB
                const gmFab = document.getElementById('gmFab');
                if (gmFab) {
                    gmFab.style.display = gmStatus ? 'flex' : 'none';
                }
                
                // Quick Action Primary - different for GM vs Player
                const quickActionPrimary = document.getElementById('quickActionPrimary');
                if (quickActionPrimary && gmStatus) {
                    // GM: First action is "Neue Session"
                    quickActionPrimary.href = 'sessions.html?create=true';
                    quickActionPrimary.innerHTML = `
                        <div class="quick-action__icon quick-action__icon--red">
                            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <rect x="3" y="4" width="18" height="18" rx="2" ry="2"/>
                                <line x1="16" y1="2" x2="16" y2="6"/>
                                <line x1="8" y1="2" x2="8" y2="6"/>
                                <line x1="3" y1="10" x2="21" y2="10"/>
                                <line x1="12" y1="14" x2="12" y2="18"/>
                                <line x1="10" y1="16" x2="14" y2="16"/>
                            </svg>
                        </div>
                        <span class="quick-action__label">Neue Session</span>
                    `;
                }
                
                console.log('[Hub] User isGM:', gmStatus);
            }
            
            // Initial update from localStorage
            updateGMUI(isGM);
            
            // Check room membership after Firebase is ready
            async function checkRoomMembership() {
                if (typeof RIFT === 'undefined' || !RIFT.rooms || !RIFT.user) {
                    return false; // Services not loaded yet
                }
                
                const roomCode = RIFT.user.getCurrentRoom();
                if (!roomCode) return true; // No room, done
                
                try {
                    const membership = await RIFT.rooms.getCurrentMembership(roomCode);
                    if (membership) {
                        const roomIsGM = membership.isGM === true;
                        if (roomIsGM !== isGM) {
                            console.log('[Hub] Updated isGM from room membership:', roomIsGM);
                            isGM = roomIsGM;
                            updateGMUI(isGM);
                            
                            // Also update localStorage
                            userData.isGM = isGM;
                            localStorage.setItem('rift_user', JSON.stringify(userData));
                        }
                        return true; // Done
                    }
                } catch (e) {
                    console.warn('[Hub] Could not check room membership:', e);
                }
                return false;
            }
            
            // Try to check membership after delays (Firebase init takes time)
            setTimeout(async () => {
                const done = await checkRoomMembership();
                if (!done) setTimeout(checkRoomMembership, 1000);
            }, 500);
        })();
        
        // Random background image
        (function() {
            const bgNum = String(Math.floor(Math.random() * 12) + 1).padStart(3, '0');
            const style = document.createElement('style');
            style.textContent = `.main--hub::before { background-image: url('assets/bg/bg_${bgNum}.jpg'); }`;
            document.head.appendChild(style);
        })();
        
        // News Edit Button Handler
        (function() {
            document.querySelectorAll('.news-card__edit').forEach(editBtn => {
                editBtn.addEventListener('click', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    const newsId = this.dataset.news;
                    window.location.href = `news${newsId}.html?edit=true`;
                });
            });
        })();
        
        // ========================================
        // DYNAMIC NEWS SYSTEM - Featured + List
        // ========================================
        (async function() {
            const newsLayout = document.getElementById('newsLayout');
            const newsLoading = document.getElementById('newsLoading');
            const newsEmpty = document.getElementById('newsEmpty');
            const newsFeatured = document.getElementById('newsFeatured');
            const newsList = document.getElementById('newsList');
            const newsTabs = document.getElementById('newsTabs');
            
            let allArticles = [];
            let currentCategory = 'all';
            
            // Wait for Firebase
            const waitForFirebase = () => new Promise(resolve => {
                const check = () => {
                    if (typeof firebase !== 'undefined' && firebase.firestore && firebase.apps?.length > 0) {
                        resolve();
                    } else {
                        setTimeout(check, 100);
                    }
                };
                check();
            });
            
            await waitForFirebase();
            
            // Category config
            const categoryConfig = {
                update: { label: 'Update', color: '#4ADE80' },
                news: { label: 'News', color: '#F87171' },
                guide: { label: 'Guide', color: '#60A5FA' }
            };
            
            // Format date
            function formatDate(timestamp) {
                const date = timestamp?.toDate?.() || new Date();
                return date.toLocaleDateString('de-DE', { day: '2-digit', month: 'short', year: 'numeric' });
            }
            
            // Render featured article
            function renderFeatured(article) {
                if (!article) {
                    newsFeatured.style.display = 'none';
                    return;
                }
                
                const cat = categoryConfig[article.category] || categoryConfig.news;
                newsFeatured.href = `news.html?id=${article.id}`;
                newsFeatured.style.display = 'block';
                newsFeatured.innerHTML = `
                    <div class="news-featured__image" style="background-image: url('${article.imageUrl || ''}');">
                        ${!article.imageUrl ? '<div class="news-featured__placeholder"></div>' : ''}
                        <div class="news-featured__overlay"></div>
                    </div>
                    <div class="news-featured__content">
                        <span class="news-featured__category" style="background: ${cat.color}20; color: ${cat.color};">${cat.label}</span>
                        <h3 class="news-featured__title">${article.title || 'Ohne Titel'}</h3>
                        <p class="news-featured__excerpt">${article.excerpt || ''}</p>
                        <div class="news-featured__arrow">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M5 12h14M12 5l7 7-7 7"/>
                            </svg>
                        </div>
                    </div>
                `;
            }
            
            // Render list item
            function createListItem(article) {
                const cat = categoryConfig[article.category] || categoryConfig.news;
                const item = document.createElement('a');
                item.href = `news.html?id=${article.id}`;
                item.className = 'news-list-item';
                item.innerHTML = `
                    <div class="news-list-item__image" style="background-image: url('${article.imageUrl || ''}');">
                        ${!article.imageUrl ? '<div class="news-list-item__placeholder"></div>' : ''}
                    </div>
                    <div class="news-list-item__content">
                        <span class="news-list-item__category" style="color: ${cat.color};">${cat.label}</span>
                        <h4 class="news-list-item__title">${article.title || 'Ohne Titel'}</h4>
                    </div>
                `;
                return item;
            }
            
            // Render all articles based on filter
            function renderArticles() {
                // Filter by category
                const filtered = currentCategory === 'all' 
                    ? allArticles 
                    : allArticles.filter(a => a.category === currentCategory);
                
                if (filtered.length === 0) {
                    newsLayout.style.display = 'none';
                    newsEmpty.style.display = 'flex';
                    return;
                }
                
                newsEmpty.style.display = 'none';
                newsLayout.style.display = 'grid';
                
                // Featured = first article (or first with featured flag)
                const featuredIndex = filtered.findIndex(a => a.featured);
                const featured = featuredIndex >= 0 ? filtered[featuredIndex] : filtered[0];
                const listArticles = filtered.filter(a => a.id !== featured.id).slice(0, 5);
                
                renderFeatured(featured);
                
                // Render list
                newsList.innerHTML = '';
                listArticles.forEach(article => {
                    newsList.appendChild(createListItem(article));
                });
            }
            
            // Tab click handler
            newsTabs?.addEventListener('click', (e) => {
                const tab = e.target.closest('.news-tab');
                if (!tab) return;
                
                // Update active state
                newsTabs.querySelectorAll('.news-tab').forEach(t => t.classList.remove('active'));
                tab.classList.add('active');
                
                // Filter
                currentCategory = tab.dataset.category;
                renderArticles();
            });
            
            // Load news from Firestore
            async function loadNews() {
                try {
                    const db = firebase.firestore();
                    const snapshot = await db.collection('hub_news')
                        .where('published', '==', true)
                        .get();
                    
                    console.log('[Hub] Loaded', snapshot.size, 'news articles');
                    
                    // Hide loading
                    if (newsLoading) newsLoading.style.display = 'none';
                    
                    if (snapshot.empty) {
                        newsEmpty.style.display = 'flex';
                        return;
                    }
                    
                    // Sort by date (newest first)
                    allArticles = snapshot.docs
                        .map(doc => ({ id: doc.id, ...doc.data() }))
                        .sort((a, b) => {
                            const aTime = a.publishedAt?.toMillis?.() || a.createdAt?.toMillis?.() || 0;
                            const bTime = b.publishedAt?.toMillis?.() || b.createdAt?.toMillis?.() || 0;
                            return bTime - aTime;
                        });
                    
                    renderArticles();
                    
                } catch (e) {
                    console.error('[Hub] News load error:', e);
                    if (newsLoading) newsLoading.style.display = 'none';
                    newsEmpty.style.display = 'flex';
                }
            }
            
            // Initialize
            await loadNews();
        })();
        
        // ========================================
        // FEATURE SHOWCASE TABS
        // ========================================
        (function() {
            const showcase = document.getElementById('featureShowcase');
            const panels = document.querySelectorAll('.feature-panel');
            
            showcase?.addEventListener('click', (e) => {
                const tab = e.target.closest('.feature-tab');
                if (!tab) return;
                
                const feature = tab.dataset.feature;
                
                // Update all tabs across all panels
                showcase.querySelectorAll('.feature-tab').forEach(t => {
                    t.classList.toggle('active', t.dataset.feature === feature);
                });
                
                // Update active panel
                panels.forEach(p => {
                    p.classList.toggle('active', p.dataset.panel === feature);
                });
            });
        })();
        
        // Random Character Image for Continue Cards
        (function() {
            const characterImages = {
                'dnd5e': ['char_5e2024_01', 'char_5e2024_02', 'char_5e2024_03', 'char_5e2024_04', 'char_5e2024_05', 'char_5e2024_06', 'char_5e2024_07'],
                'worldsapart': ['char_worldsapart_01', 'char_worldsapart_02', 'char_worldsapart_03', 'char_worldsapart_04', 'char_worldsapart_05', 'char_worldsapart_06', 'char_worldsapart_07'],
                'htbah': ['char_htbah_01', 'char_htbah_02', 'char_htbah_03', 'char_htbah_04', 'char_htbah_05', 'char_htbah_06', 'char_htbah_07'],
                'cyberpunkred': ['char_cyberpunk_01', 'char_cyberpunk_02', 'char_cyberpunk_03', 'char_cyberpunk_04']
            };
            
            // Load images for all continue cards
            document.querySelectorAll('.continue-card[data-rulebook]').forEach(card => {
                const rulebookId = card.dataset.rulebook;
                const images = characterImages[rulebookId];
                
                if (images && images.length > 0) {
                    const randomImg = images[Math.floor(Math.random() * images.length)];
                    const imgEl = card.querySelector('.continue-card__character img');
                    
                    if (imgEl) {
                        imgEl.onload = () => imgEl.classList.add('loaded');
                        imgEl.onerror = () => imgEl.style.display = 'none';
                        imgEl.src = `assets/img/rift_chars/hero_card/${randomImg}.png`;
                    }
                }
            });
        })();
        
        // Session Timer (for active sessions)
        (function() {
            let sessionStartTime = null;
            let timerInterval = null;
            const timerWidget = document.getElementById('sessionTimerWidget');
            const timerValue = document.getElementById('sessionTimerValue');
            const pauseBtn = document.getElementById('pauseSessionBtn');
            const stopBtn = document.getElementById('stopSessionBtn');
            let isPaused = false;
            let pausedTime = 0;
            
            // Check if there's an active session
            const activeSession = JSON.parse(localStorage.getItem('rift_active_session') || 'null');
            if (activeSession && timerWidget) {
                sessionStartTime = new Date(activeSession.startTime);
                pausedTime = activeSession.pausedTime || 0;
                timerWidget.style.display = 'block';
                startTimer();
            }
            
            function startTimer() {
                timerInterval = setInterval(updateTimer, 1000);
            }
            
            function updateTimer() {
                if (isPaused) return;
                const now = new Date();
                const elapsed = now - sessionStartTime - pausedTime;
                const hours = Math.floor(elapsed / (1000 * 60 * 60));
                const mins = Math.floor((elapsed % (1000 * 60 * 60)) / (1000 * 60));
                const secs = Math.floor((elapsed % (1000 * 60)) / 1000);
                if (timerValue) {
                    timerValue.textContent = `${hours}:${String(mins).padStart(2, '0')}:${String(secs).padStart(2, '0')}`;
                }
            }
            
            if (pauseBtn) {
                pauseBtn.addEventListener('click', () => {
                    isPaused = !isPaused;
                    pauseBtn.classList.toggle('active', isPaused);
                });
            }
            
            if (stopBtn) {
                stopBtn.addEventListener('click', () => {
                    if (confirm('Session wirklich beenden?')) {
                        clearInterval(timerInterval);
                        localStorage.removeItem('rift_active_session');
                        if (timerWidget) timerWidget.style.display = 'none';
                    }
                });
            }
        })();
        
        // Service Worker deaktiviert - verursachte Caching-Probleme
        // Falls ein alter SW noch l√§uft, deregistrieren:
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.getRegistrations().then(registrations => {
                registrations.forEach(registration => {
                    registration.unregister();
                    console.log('[SW] Alte Registrierung entfernt');
                });
            });
        }
        
        // ========================================
        // LOAD DASHBOARD DATA
        // ========================================
        
        // Use var to avoid re-declaration errors on View Transitions
        var firebaseSessions = window._firebaseSessions || [];
        var sessionsUnsubscribe = window._sessionsUnsubscribe || null;
        var heroSkeletonRemoved = window._heroSkeletonRemoved || false;
        
        // Failsafe: Remove hero skeleton after 800ms
        setTimeout(() => {
            if (!heroSkeletonRemoved) {
                const heroLoading = document.getElementById('heroLoading');
                if (heroLoading) heroLoading.style.display = 'none';
                console.log('[Hub] Hero skeleton removed by timeout');
            }
        }, 800);
        
        // Initialize Firebase Sessions for Hub
        let initRetries = 0; // Local counter, resets on each page load
        
        function initFirebaseSessions() {
            if (!currentRoomCode) {
                console.log('[Hub] No room code - using localStorage for sessions');
                window._firebaseSessions = firebaseSessions = JSON.parse(localStorage.getItem('rift_sessions') || '[]');
                loadDashboardData();
                return;
            }
            
            // Wait for RIFT.rooms (max 20 attempts = 2 seconds)
            if (typeof RIFT === 'undefined' || !RIFT.rooms) {
                initRetries++;
                
                if (initRetries > 20) {
                    console.warn('[Hub] RIFT.rooms not available after 2s, loading with empty sessions');
                    window._firebaseSessions = firebaseSessions = [];
                    loadDashboardData();
                    return;
                }
                
                setTimeout(initFirebaseSessions, 100);
                return;
            }
            
            console.log('[Hub] Subscribing to Firebase sessions for room:', currentRoomCode);
            
            // Subscribe to realtime session updates
            let hasReceivedData = false;
            window._sessionsUnsubscribe = sessionsUnsubscribe = RIFT.rooms.subscribeToSessions(currentRoomCode, (sessions) => {
                console.log('[Hub] Firebase sessions update:', sessions.length);
                hasReceivedData = true;
                window._firebaseSessions = firebaseSessions = sessions;
                loadDashboardData();
            });
            
            // Fallback: If no data received after 1 second, load anyway with empty/cached sessions
            setTimeout(() => {
                if (!hasReceivedData) {
                    console.warn('[Hub] No Firebase sessions received after 1s, loading with cache');
                    window._firebaseSessions = firebaseSessions = JSON.parse(localStorage.getItem('rift_sessions') || '[]');
                    loadDashboardData();
                }
            }, 1000);
        }
        
        // Start quickly
        setTimeout(initFirebaseSessions, 100);
        
        // Cleanup
        window.addEventListener('beforeunload', () => {
            if (sessionsUnsubscribe) sessionsUnsubscribe();
        });
        
        async function loadDashboardData() {
            // Hide loading skeleton
            const heroLoading = document.getElementById('heroLoading');
            if (heroLoading) heroLoading.style.display = 'none';
            heroSkeletonRemoved = true;
            window._heroSkeletonRemoved = true;
            
            // Use Firebase sessions (already filtered by room)
            const sessions = firebaseSessions;
            
            // Use CharacterStorage format (object) and convert to array
            const characterData = JSON.parse(localStorage.getItem('rift_characters') || '{}');
            const characters = Object.values(characterData);
            const now = new Date();
            const currentUserId = window.currentUser?.uid || null;
            
            // Check data state
            const hasCharacters = characters.length > 0;
            const hasSessions = sessions.filter(s => s.status !== 'ended').length > 0;
            
            console.log('[Hub] Dashboard data: sessions=', sessions.length, 'characters=', characters.length);
            
            // Status Banner (4 Varianten)
            const statusBanner = document.getElementById('statusBanner');
            const statusIcon = document.getElementById('statusIcon');
            const statusTitle = document.getElementById('statusTitle');
            const statusText = document.getElementById('statusText');
            const statusActions = document.getElementById('statusActions');
            const continueContainer = document.getElementById('continueCardsContainer');
            const nextSessionCard = document.getElementById('nextSessionCard');
            
            // Banner-Konfiguration basierend auf Zustand
            const bannerConfig = {
                // 1. Keine Session, kein Charakter
                noSessionNoChar: {
                    icon: `<svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                        <path d="M12 2L2 7l10 5 10-5-10-5z"/>
                        <path d="M2 17l10 5 10-5"/>
                        <path d="M2 12l10 5 10-5"/>
                    </svg>`,
                    title: 'Willkommen bei RIFT!',
                    text: 'Erstelle deinen ersten Charakter oder plane eine Session um loszulegen.',
                    actions: `
                        <a href="/sheet" class="status-banner__btn status-banner__btn--primary">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 5v14M5 12h14"/></svg>
                            Charakter erstellen
                        </a>
                        <a href="/sessions" class="status-banner__btn status-banner__btn--secondary">Session planen</a>
                    `
                },
                // 2. Keine Session, aber Charakter vorhanden
                noSessionHasChar: {
                    icon: `<svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                        <rect x="3" y="4" width="18" height="18" rx="2" ry="2"/>
                        <line x1="16" y1="2" x2="16" y2="6"/>
                        <line x1="8" y1="2" x2="8" y2="6"/>
                        <line x1="3" y1="10" x2="21" y2="10"/>
                    </svg>`,
                    title: 'Bereit f√ºr ein Abenteuer?',
                    text: `Du hast ${characters.length} Charakter${characters.length > 1 ? 'e' : ''}. Plane jetzt deine erste Session!`,
                    actions: `
                        <a href="/sessions" class="status-banner__btn status-banner__btn--primary">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 5v14M5 12h14"/></svg>
                            Session planen
                        </a>
                    `
                },
                // 3. Session vorhanden, aber kein Charakter
                hasSessionNoChar: {
                    icon: `<svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                        <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/>
                        <circle cx="12" cy="7" r="4"/>
                    </svg>`,
                    title: 'Session geplant!',
                    text: 'Erstelle jetzt einen Charakter, um mitzuspielen.',
                    actions: `
                        <a href="/sheet" class="status-banner__btn status-banner__btn--primary">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 5v14M5 12h14"/></svg>
                            Charakter erstellen
                        </a>
                    `
                }
                // 4. Beides vorhanden ‚Üí Banner wird nicht angezeigt
            };
            
            // Bestimme welche Variante angezeigt werden soll
            let currentConfig = null;
            if (!hasSessions && !hasCharacters) {
                currentConfig = bannerConfig.noSessionNoChar;
            } else if (!hasSessions && hasCharacters) {
                currentConfig = bannerConfig.noSessionHasChar;
            }
            // hasSessionNoChar wird jetzt von der Character Hero Card Empty State behandelt
            // Wenn beides vorhanden ‚Üí kein Banner
            
            if (currentConfig) {
                statusBanner.style.display = 'flex';
                statusIcon.innerHTML = currentConfig.icon;
                statusTitle.textContent = currentConfig.title;
                statusText.textContent = currentConfig.text;
                statusActions.innerHTML = currentConfig.actions;
            } else {
                statusBanner.style.display = 'none';
            }
            
            // Update Quick Action Bar based on session status
            const quickActionPrimary = document.getElementById('quickActionPrimary');
            if (quickActionPrimary) {
                if (!hasSessions) {
                    // Keine Session - zeige "Session beitreten"
                    quickActionPrimary.href = 'sessions.html';
                    quickActionPrimary.querySelector('.quick-action__icon').innerHTML = `
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M15 3h4a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2h-4"/>
                            <polyline points="10 17 15 12 10 7"/>
                            <line x1="15" y1="12" x2="3" y2="12"/>
                        </svg>`;
                    quickActionPrimary.querySelector('.quick-action__label').textContent = 'Session beitreten';
                }
            }
                
                // Find next upcoming session
                const upcomingSessions = sessions.filter(s => {
                    const sessionDate = new Date(s.date + 'T' + (s.time || '00:00'));
                    return sessionDate >= now && s.status !== 'ended';
                }).sort((a, b) => new Date(a.date) - new Date(b.date));
                
                // Ruleset Configuration
                const rulesetConfig = {
                    '5e2024': { name: 'D&D 5E', class: '5e', icon: 'ruleset_5e_2024.svg' },
                    'worldsapart': { name: 'WORLDS APART', class: 'worldsapart', icon: 'ruleset_worldsapart.svg' },
                    'htbah': { name: 'HTBAH', class: 'htbah', icon: 'ruleset_htbah.svg' },
                    'cyberpunk': { name: 'CYBERPUNK', class: 'cyberpunk', icon: 'ruleset_cyberpunkred.svg' }
                };
                
                const weekdays = ['SO', 'MO', 'DI', 'MI', 'DO', 'FR', 'SA'];
                const months = ['Jan', 'Feb', 'M√§r', 'Apr', 'Mai', 'Jun', 'Jul', 'Aug', 'Sep', 'Okt', 'Nov', 'Dez'];
                
                // ============================================
                // CHARACTER HERO CARD - Always show if character exists
                // ============================================
                const heroCardsContainer = document.getElementById('heroCardsContainer');
                const characterHeroCard = document.getElementById('characterHeroCard');
                const sessionHeroCard = document.getElementById('sessionHeroCard');
                
                // Filter to only show non-ended sessions
                const activeSessions = sessions.filter(s => s.status !== 'ended');
                const heroSession = activeSessions.length > 0 ? activeSessions[0] : null;
                
                // Determine ruleset (from session or from character)
                let ruleset = rulesetConfig['worldsapart']; // default
                if (heroSession) {
                    ruleset = rulesetConfig[heroSession.ruleset] || rulesetConfig['worldsapart'];
                } else if (characters.length > 0) {
                    ruleset = rulesetConfig[characters[0].ruleset] || rulesetConfig['worldsapart'];
                }
                
                // Find Main Character
                let selectedChar = null;
                
                // 1. Try Main Character from CharacterStorage (for session ruleset or any)
                if (typeof CharacterStorage !== 'undefined') {
                    if (heroSession) {
                        selectedChar = CharacterStorage.getMainCharacter(heroSession.ruleset);
                    }
                    if (!selectedChar && characters.length > 0) {
                        // Try to get main character for first character's ruleset, or just use first character
                        const firstRuleset = characters[0].ruleset || 'worldsapart';
                        selectedChar = CharacterStorage.getMainCharacter(firstRuleset);
                        if (!selectedChar) {
                            selectedChar = characters[0];
                        }
                    }
                    console.log('[Hub] Main character:', selectedChar?.name || 'none');
                }
                
                // 2. Fallback: session's selected character
                if (!selectedChar && heroSession?.selectedCharacterId) {
                    selectedChar = characters.find(c => c.id === heroSession.selectedCharacterId);
                }
                
                // 3. Fallback: any character with matching ruleset
                if (!selectedChar && heroSession) {
                    selectedChar = characters.find(c => c.ruleset === heroSession.ruleset);
                }
                
                // 4. Last fallback: first character
                if (!selectedChar && characters.length > 0) {
                    selectedChar = characters[0];
                }
                
                // Show hero cards container if we have EITHER character OR session
                if (selectedChar || heroSession) {
                    heroCardsContainer.style.display = 'flex';
                }
                
                // ============================================
                // CHARACTER HERO CARD (left side) - Show if character exists
                // ============================================
                if (selectedChar) {
                    const charRuleset = rulesetConfig[selectedChar.ruleset] || ruleset;
                    
                    characterHeroCard.style.display = 'flex';
                    characterHeroCard.href = `sheet-${selectedChar.ruleset || 'worldsapart'}.html?id=${selectedChar.id}`;
                    characterHeroCard.className = `character-hero character-hero--${charRuleset.class}`;
                    
                    // Portrait
                    const portraitEl = document.getElementById('characterHeroPortrait');
                    if (selectedChar.portrait) {
                        // Check if it's a base64 image or a preset name
                        const portraitSrc = selectedChar.portrait.startsWith('data:') 
                            ? selectedChar.portrait 
                            : `assets/img/rift_chars/hero_card/${selectedChar.portrait}.png`;
                        portraitEl.innerHTML = `<img src="${portraitSrc}" alt="${selectedChar.name}" class="character-hero__portrait-img">`;
                    } else {
                        const initial = (selectedChar.name || 'C').charAt(0).toUpperCase();
                        portraitEl.innerHTML = `
                            <div class="character-hero__portrait-placeholder">
                                <span class="character-hero__portrait-initial">${initial}</span>
                            </div>`;
                    }
                    
                    // Name
                    document.getElementById('characterHeroName').textContent = selectedChar.name || 'Charakter';
                    
                    // Class
                    const classEl = document.getElementById('characterHeroClass');
                    if (selectedChar.class || selectedChar.role) {
                        classEl.textContent = selectedChar.class || selectedChar.role || '';
                        classEl.style.display = 'inline';
                    } else {
                        classEl.style.display = 'none';
                    }
                    
                    // LP & Moral Stats - Load from Room Characters (Multi-Char Support)
                    const lpBarEl = document.getElementById('characterHeroLpBar');
                    const lpValueEl = document.getElementById('characterHeroLpValue');
                    const moralBarEl = document.getElementById('characterHeroMoralBar');
                    const moralValueEl = document.getElementById('characterHeroMoralValue');
                    
                    const userId = window.currentUser?.uid || null;
                    const roomCode = currentRoomCode;
                    
                    console.log('[Hub] Loading character stats - roomCode:', roomCode, 'userId:', userId);
                    
                    let lpValue = null;
                    let moralValue = null;
                    let lpMax = 100;
                    let moralMax = 100;
                    
                    // Try Room Characters first (Firestore) - Multi-Char Ready!
                    if (roomCode && userId && typeof RIFT !== 'undefined' && RIFT.rooms?.getActiveCharacter) {
                        try {
                            const activeChar = await RIFT.rooms.getActiveCharacter(roomCode, userId);
                            console.log('[Hub] Active character from Room:', activeChar ? activeChar.name : 'none');
                            
                            if (activeChar && activeChar.data) {
                                // Worlds Apart structure: data.status.health/moral
                                lpValue = activeChar.data.status?.health ?? activeChar.data.health?.current ?? null;
                                moralValue = activeChar.data.status?.moral ?? activeChar.data.moral?.current ?? null;
                                
                                // Also check for max values
                                lpMax = activeChar.data.health?.max || 100;
                                moralMax = activeChar.data.moral?.max || 100;
                                
                                console.log('[Hub] Room Character stats:', { lpValue, moralValue, lpMax, moralMax });
                            }
                        } catch (e) {
                            console.warn('[Hub] Room Character error:', e);
                        }
                    }
                    
                    // Fallback 1: Try selected character's data directly
                    if (lpValue === null && selectedChar?.data) {
                        lpValue = selectedChar.data.status?.health ?? selectedChar.data.health?.current ?? null;
                        moralValue = selectedChar.data.status?.moral ?? selectedChar.data.moral?.current ?? null;
                        console.log('[Hub] Selected char stats:', { lpValue, moralValue });
                    }
                    
                    // Fallback 2: Try localStorage (worldsapart_character_v5)
                    if (lpValue === null) {
                        try {
                            const localData = JSON.parse(localStorage.getItem('worldsapart_character_v5') || 'null');
                            if (localData) {
                                lpValue = localData.health?.current ?? null;
                                moralValue = localData.moral?.current ?? null;
                                lpMax = localData.health?.max || 100;
                                moralMax = localData.moral?.max || 100;
                                console.log('[Hub] LocalStorage stats:', { lpValue, moralValue });
                            }
                        } catch (e) {
                            console.warn('[Hub] LocalStorage error:', e);
                        }
                    }
                    
                    // Update UI
                    if (lpValue !== null) {
                        const lpPercent = Math.min(100, Math.max(0, (lpValue / lpMax) * 100));
                        lpBarEl.style.width = `${lpPercent}%`;
                        lpValueEl.textContent = `${lpValue}`;
                    }
                    
                    if (moralValue !== null) {
                        const moralPercent = Math.min(100, Math.max(0, (moralValue / moralMax) * 100));
                        moralBarEl.style.width = `${moralPercent}%`;
                        moralValueEl.textContent = `${moralValue}`;
                    }
                } else if (heroSession) {
                    // No character but have session - show empty state prompting to create
                    characterHeroCard.style.display = 'flex';
                    characterHeroCard.href = 'sheet.html';
                    characterHeroCard.className = `character-hero character-hero--${ruleset.class} character-hero--empty`;
                    
                    // Empty Portrait with icon
                    const portraitEl = document.getElementById('characterHeroPortrait');
                    portraitEl.innerHTML = `
                        <div class="character-hero__portrait-placeholder">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                                <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/>
                                <circle cx="12" cy="7" r="4"/>
                            </svg>
                        </div>`;
                    
                    // Empty State Text
                    document.getElementById('characterHeroName').textContent = 'Charakter erstellen';
                    
                    const classEl = document.getElementById('characterHeroClass');
                    classEl.textContent = 'Um mitzuspielen';
                    classEl.style.display = 'inline';
                    
                    // Hide stats, show CTA hint
                    document.getElementById('characterHeroStats').innerHTML = `
                        <div class="character-hero__cta">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <line x1="12" y1="5" x2="12" y2="19"/>
                                <line x1="5" y1="12" x2="19" y2="12"/>
                            </svg>
                            <span>Jetzt erstellen</span>
                        </div>
                    `;
                } else {
                    // No session and no character - hide character card
                    characterHeroCard.style.display = 'none';
                }
                
                // ============================================
                // SESSION HERO CARD (right side) - Only if active session exists
                // ============================================
                if (heroSession) {
                    const sessionHeroCover = document.getElementById('sessionHeroCover');
                    
                    // Show and configure the card
                    sessionHeroCard.style.display = 'flex';
                    sessionHeroCard.href = `session.html?id=${heroSession.id}`;
                    sessionHeroCard.className = `session-hero session-hero--${ruleset.class}`;
                    
                    // Cover Image
                    if (heroSession.coverUrl) {
                        sessionHeroCover.innerHTML = `<img src="${heroSession.coverUrl}" alt="${heroSession.name}" class="session-hero__cover-img">`;
                    } else {
                        sessionHeroCover.innerHTML = `
                            <div class="session-hero__cover-placeholder">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                                    <rect x="3" y="3" width="18" height="18" rx="2"/>
                                    <circle cx="8.5" cy="8.5" r="1.5"/>
                                    <path d="M21 15l-5-5L5 21"/>
                                </svg>
                            </div>`;
                    }
                    
                    // Title & Subtitle
                    document.getElementById('sessionHeroTitle').textContent = heroSession.name || 'Unbenannte Session';
                    document.getElementById('sessionHeroSubtitle').textContent = heroSession.subtitle || '';
                    document.getElementById('sessionHeroSubtitle').style.display = heroSession.subtitle ? 'block' : 'none';
                    
                    // GM Badge (show if user is GM)
                    const gmBadge = document.getElementById('sessionHeroGmBadge');
                    if (heroSession.isGM || heroSession.gmId === currentUserId) {
                        gmBadge.style.display = 'flex';
                    } else {
                        gmBadge.style.display = 'none';
                    }
                    
                    // Ruleset
                    const rulesetEl = document.getElementById('sessionHeroRuleset');
                    rulesetEl.innerHTML = `
                        <img src="assets/img/rulesets/${ruleset.icon}" alt="${ruleset.name}">
                        <span>${ruleset.name}</span>`;
                    
                    // Session Number
                    const sessionNum = heroSession.currentSession || 1;
                    const totalSessions = heroSession.sessionCount || '?';
                    document.getElementById('sessionHeroSessionNum').textContent = `Session ${sessionNum}/${totalSessions}`;
                    
                    // Tags (capitalize via CSS)
                    const tagsContainer = document.getElementById('sessionHeroTags');
                    if (heroSession.tags && heroSession.tags.length > 0) {
                        tagsContainer.innerHTML = heroSession.tags.slice(0, 3).map(tag => 
                            `<span class="session-hero__tag">${tag}</span>`
                        ).join('');
                        tagsContainer.style.display = 'flex';
                    } else {
                        tagsContainer.style.display = 'none';
                    }
                    
                    // Calendar / Date
                    const dateBox = document.getElementById('sessionHeroDateBox');
                    const noDate = document.getElementById('sessionHeroNoDate');
                    const countdown = document.getElementById('sessionHeroCountdown');
                    const timeEl = document.getElementById('sessionHeroTime');
                    
                    if (heroSession.date) {
                        const sessionDate = new Date(heroSession.date);
                        dateBox.style.display = 'flex';
                        noDate.style.display = 'none';
                        countdown.style.display = 'flex';
                        timeEl.style.display = 'block';
                        
                        document.getElementById('sessionHeroDay').textContent = weekdays[sessionDate.getDay()];
                        document.getElementById('sessionHeroNum').textContent = String(sessionDate.getDate()).padStart(2, '0');
                        document.getElementById('sessionHeroMonth').textContent = months[sessionDate.getMonth()];
                        document.getElementById('sessionHeroTime').textContent = `${heroSession.time || '20:00'} Uhr`;
                        
                        // Countdown
                        const sessionDateTime = new Date(heroSession.date + 'T' + (heroSession.time || '20:00'));
                        updateHeroCountdown(sessionDateTime);
                        setInterval(() => updateHeroCountdown(sessionDateTime), 60000);
                    } else {
                        dateBox.style.display = 'none';
                        noDate.style.display = 'flex';
                        countdown.style.display = 'none';
                        timeEl.style.display = 'none';
                    }
                    
                    // Hide old continue cards container
                    continueContainer.style.display = 'none';
                    
                    // Hide old next session card (we have the unified hero now)
                    nextSessionCard.style.display = 'none';
                } else {
                    // No active session - hide session hero card
                    sessionHeroCard.style.display = 'none';
                }
                
                // Fallback: Show old next session card if we have upcoming but no active sessions and no character
                if (!heroSession && !selectedChar && upcomingSessions.length > 0) {
                    const next = upcomingSessions[0];
                    const date = new Date(next.date);
                    
                    nextSessionCard.style.display = 'flex';
                    nextSessionCard.href = `session.html?id=${next.id}`;
                    document.getElementById('nextSessionDay').textContent = weekdays[date.getDay()];
                    document.getElementById('nextSessionNum').textContent = String(date.getDate()).padStart(2, '0');
                    document.getElementById('nextSessionMonth').textContent = months[date.getMonth()];
                    document.getElementById('nextSessionTime').textContent = `${next.time || '20:00'} Uhr`;
                    
                    // Countdown
                    const sessionDateTime = new Date(next.date + 'T' + (next.time || '20:00'));
                    updateCountdown(sessionDateTime);
                    setInterval(() => updateCountdown(sessionDateTime), 60000);
                }
            
            // Sessions Widget
            const recentSessions = sessions.slice(-3).reverse();
            const sessionsList = document.getElementById('recentSessionsList');
            const sessionsEmpty = document.getElementById('sessionsEmpty');
            const sessionsFooter = document.getElementById('sessionsFooter');
            
            if (recentSessions.length > 0) {
                sessionsEmpty.style.display = 'none';
                sessionsFooter.style.display = 'block';
                sessionsList.innerHTML = recentSessions.map(renderSessionItem).join('');
            } else {
                sessionsEmpty.style.display = 'flex';
                sessionsFooter.style.display = 'none';
            }
            
            // Characters Widget
            const charactersList = document.getElementById('charactersList');
            const charactersEmpty = document.getElementById('charactersEmpty');
            const charactersFooter = document.getElementById('charactersFooter');
            
            if (characters.length > 0) {
                charactersEmpty.style.display = 'none';
                charactersFooter.style.display = 'block';
                
                // Sort: main characters first
                const sortedChars = [...characters].sort((a, b) => {
                    const aIsMain = typeof CharacterStorage !== 'undefined' && CharacterStorage.isMainCharacter(a.id);
                    const bIsMain = typeof CharacterStorage !== 'undefined' && CharacterStorage.isMainCharacter(b.id);
                    if (aIsMain && !bIsMain) return -1;
                    if (!aIsMain && bIsMain) return 1;
                    return 0;
                });
                
                charactersList.innerHTML = sortedChars.slice(0, 3).map(renderCharacterItem).join('');
            } else {
                charactersEmpty.style.display = 'flex';
                charactersFooter.style.display = 'none';
            }
        }
        
        function updateCountdown(targetDate) {
            const now = new Date();
            const diff = targetDate - now;
            
            if (diff <= 0) {
                document.getElementById('countdownDays').textContent = '0';
                document.getElementById('countdownHours').textContent = '0';
                document.getElementById('countdownMins').textContent = '0';
                return;
            }
            
            const days = Math.floor(diff / (1000 * 60 * 60 * 24));
            const hours = Math.floor((diff % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
            const mins = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
            
            document.getElementById('countdownDays').textContent = days;
            document.getElementById('countdownHours').textContent = hours;
            document.getElementById('countdownMins').textContent = mins;
        }
        
        // Hero Countdown for the new Session Hero Card
        function updateHeroCountdown(targetDate) {
            const now = new Date();
            const diff = targetDate - now;
            
            const daysEl = document.getElementById('heroCountdownDays');
            const hoursEl = document.getElementById('heroCountdownHours');
            const minsEl = document.getElementById('heroCountdownMins');
            
            if (!daysEl || !hoursEl || !minsEl) return;
            
            if (diff <= 0) {
                daysEl.textContent = '0';
                hoursEl.textContent = '0';
                minsEl.textContent = '0';
                return;
            }
            
            const days = Math.floor(diff / (1000 * 60 * 60 * 24));
            const hours = Math.floor((diff % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
            const mins = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
            
            daysEl.textContent = days;
            hoursEl.textContent = hours;
            minsEl.textContent = mins;
        }
        
        function renderSessionItem(session) {
            const rulesetConfig = {
                '5e2024': { name: 'D&D 5e', badge: '5e', icon: 'assets/img/rulesets/ruleset_5e_2024.svg' },
                'worldsapart': { name: 'Worlds Apart', badge: 'worldsapart', icon: 'assets/img/rulesets/ruleset_worldsapart.svg' },
                'htbah': { name: 'How To Be A Hero', badge: 'htbah', icon: 'assets/img/rulesets/ruleset_htbah.svg' },
                'cyberpunk': { name: 'Cyberpunk Red', badge: 'cyberpunk', icon: 'assets/img/rulesets/ruleset_cyberpunkred.svg' }
            };
            const ruleset = rulesetConfig[session.ruleset] || { name: session.ruleset, badge: '', icon: '' };
            
            return `
                <a href="session.html?id=${session.id}" class="widget__item session-item">
                    <div class="session-item__left">
                        <div class="ruleset-badge ruleset-badge--${ruleset.badge}">
                            <img src="${ruleset.icon}" alt="">
                            <span>${ruleset.name}</span>
                        </div>
                        <span class="session-item__title">${session.name}</span>
                        <span class="session-item__meta">${session.date} ¬∑ ${session.maxPlayers || 4} Spieler</span>
                    </div>
                </a>
            `;
        }
        
        function renderCharacterItem(char) {
            // Check if this is the main character for its ruleset
            const isMain = typeof CharacterStorage !== 'undefined' && CharacterStorage.isMainCharacter(char.id);
            
            // Get correct sheet URL based on ruleset
            const sheetUrl = {
                'worldsapart': 'sheet-worldsapart.html',
                'dnd5e': 'sheet-5e.html',
                '5e': 'sheet-5e-en.html',
                '5e-de': 'sheet-5e-de.html',
                'htbah': 'sheet-htbah.html',
                'cyberpunk': 'sheet-cyberpunk.html'
            }[char.ruleset] || 'sheet-worldsapart.html';
            
            return `
                <a href="${sheetUrl}?id=${char.id}" class="widget__item character-item ${isMain ? 'character-item--main' : ''}">
                    <div class="character-item__portrait" style="background: linear-gradient(135deg, ${isMain ? '#FFC107' : '#7c3aed'} 0%, ${isMain ? '#FF8F00' : '#4c1d95'} 100%);">
                        <span class="character-item__initial">${isMain ? '‚òÖ' : (char.name ? char.name.charAt(0).toUpperCase() : '?')}</span>
                    </div>
                    <div class="widget__item-info">
                        <span class="character-item__name">${isMain ? '‚òÖ ' : ''}${char.name || 'Unbenannt'}</span>
                        <span class="widget__item-meta">${char.race || char.class || char.data?.role || ''}</span>
                    </div>
                </a>
            `;
        }
        
        // Reload dashboard when coming back via browser Back button (bfcache)
        window.addEventListener('pageshow', function(event) {
            if (event.persisted) {
                console.log('[Hub] Page restored from bfcache, reloading dashboard');
                loadDashboardData();
            }
        });
        
        // Reload dashboard when tab becomes visible again
        document.addEventListener('visibilitychange', function() {
            if (document.visibilityState === 'visible' && window._heroSkeletonRemoved) {
                console.log('[Hub] Tab became visible, refreshing dashboard');
                loadDashboardData();
            }
        });
        
        // Final safety net: ensure dashboard loads within 3 seconds no matter what
        setTimeout(() => {
            if (!window._heroSkeletonRemoved) {
                console.warn('[Hub] Safety net triggered - forcing dashboard load');
                loadDashboardData();
            }
        }, 3000);
        
        // Dashboard wird von initFirebaseSessions geladen
        // (nicht direkt aufrufen - verhindert Flash des falschen Contents)
    </script>
    <script src="assets/js/hub-features.js"></script>
    <script src="assets/js/broadcast.js"></script>
</body>
</html>
