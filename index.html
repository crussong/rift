<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="PnP Companion - Dein digitaler Begleiter für Pen and Paper">
    <meta name="theme-color" content="#6750a4">
    <title>RIFT - Tabletop Companion</title>
    <script>(function(){var t=localStorage.getItem('pnp_theme')||'dark';document.documentElement.setAttribute('data-theme',t)})();</script>
    <link rel="icon" type="image/png" href="assets/icons/icon_favicon.png">
    <link rel="manifest" href="manifest.json">
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;600;700;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="assets/css/global.css">
    
    <style>
        body {
            display: flex;
            flex-direction: column;
            min-height: 100vh;
        }

        /* ===== PARTICLES ===== */
        .particles-container {
            position: fixed;
            top: 48px; /* Below top-bar */
            left: 0;
            right: 0;
            bottom: 0;
            z-index: 0;
            pointer-events: none;
            overflow: hidden;
        }

        .particle {
            position: absolute;
            background: var(--md-primary);
            border-radius: 50%;
            opacity: 0;
            animation: floatParticle linear infinite;
            box-shadow: 0 0 6px var(--md-primary);
        }

        @keyframes floatParticle {
            0% {
                opacity: 0;
                transform: translateY(100vh) scale(0.5);
            }
            15% {
                opacity: 0.7;
            }
            85% {
                opacity: 0.7;
            }
            100% {
                opacity: 0;
                transform: translateY(-100px) scale(1);
            }
        }

        /* ===== TOP-BAR (exakt wie nav.js) ===== */
        .top-bar {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            height: 60px;
            background: var(--md-surface-container);
            box-shadow: var(--elevation-2);
            z-index: 400;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 16px;
        }

        .top-bar-left {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .module-name {
            font-size: 18px;
            font-weight: 500;
            color: var(--md-on-surface);
            margin: 0;
            white-space: nowrap;
        }

        .hamburger-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 40px;
            height: 40px;
            padding: 0;
            background: transparent;
            border: none;
            border-radius: 50%;
            color: var(--md-on-surface-variant);
            cursor: pointer;
            transition: all 200ms cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
        }

        .hamburger-btn::before {
            content: '';
            position: absolute;
            inset: 0;
            border-radius: inherit;
            background: currentColor;
            opacity: 0;
            transition: opacity 200ms;
        }

        .hamburger-btn:hover {
            color: var(--md-on-surface);
        }

        .hamburger-btn:hover::before {
            opacity: 0.08;
        }

        .hamburger-btn svg {
            width: 24px;
            height: 24px;
            position: relative;
            z-index: 1;
        }

        .top-bar-right {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .user-chip {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 6px 14px;
            background: var(--md-surface-container-high);
            border-radius: 100px;
            font-size: 14px;
            font-weight: 500;
            color: var(--md-on-surface);
        }

        .user-chip .user-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            flex-shrink: 0;
        }

        .icon-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 40px;
            height: 40px;
            padding: 0;
            background: transparent;
            border: none;
            border-radius: 50%;
            color: var(--md-on-surface-variant);
            cursor: pointer;
            transition: all 200ms cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
        }

        .icon-btn::before {
            content: '';
            position: absolute;
            inset: 0;
            border-radius: inherit;
            background: currentColor;
            opacity: 0;
            transition: opacity 200ms;
        }

        .icon-btn:hover {
            color: var(--md-on-surface);
        }

        .icon-btn:hover::before {
            opacity: 0.08;
        }

        .icon-btn svg {
            width: 24px;
            height: 24px;
            position: relative;
            z-index: 1;
        }
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background 200ms ease;
            position: relative;
        }

        .icon-btn:hover {
            background: var(--md-surface-container-high);
        }

        .icon-btn svg {
            width: 22px;
            height: 22px;
        }

        /* Theme Dropdown */
        .theme-dropdown {
            position: absolute;
            top: 100%;
            right: 0;
            margin-top: 8px;
            background: var(--md-surface-container-high);
            border: 1px solid var(--md-outline-variant);
            border-radius: 12px;
            box-shadow: var(--elevation-3);
            min-width: 160px;
            opacity: 0;
            visibility: hidden;
            transform: translateY(-10px);
            transition: all 200ms ease;
            z-index: 1000;
            overflow: hidden;
        }

        .theme-dropdown.active {
            opacity: 1;
            visibility: visible;
            transform: translateY(0);
        }

        .theme-option {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 12px 16px;
            color: var(--md-on-surface);
            cursor: pointer;
            transition: background 150ms ease;
            font-size: 14px;
        }

        .theme-option:hover {
            background: var(--md-surface-container-highest);
        }

        .theme-option.active {
            background: color-mix(in srgb, var(--md-primary) 15%, transparent);
            color: var(--md-primary);
        }

        /* Main Container */
        .container {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: var(--space-2xl) var(--space-lg);
            padding-top: 120px;
        }

        /* Logo Section */
        .logo-section {
            display: flex;
            flex-direction: column;
            align-items: center;
            margin-bottom: var(--space-xl);
        }

        .logo {
            width: 320px;
            height: auto;
            margin-bottom: var(--space-sm);
            animation: logoPulse 1s ease-out;
        }

        @keyframes logoPulse {
            0% {
                filter: drop-shadow(0 0 0 transparent);
                transform: scale(0.95);
                opacity: 0;
            }
            30% {
                filter: drop-shadow(0 0 30px rgba(103, 80, 164, 0.8));
                transform: scale(1.02);
                opacity: 1;
            }
            60% {
                filter: drop-shadow(0 0 20px rgba(103, 80, 164, 0.5));
                transform: scale(1);
            }
            100% {
                filter: drop-shadow(0 0 0 transparent);
                transform: scale(1);
                opacity: 1;
            }
        }

        .logo img {
            width: 100%;
            height: auto;
            object-fit: contain;
        }

        /* Show white logo by default (dark themes), hide black */
        .logo-white { display: block; }
        .logo-black { display: none; }
        
        /* Light theme: show black logo, hide white */
        [data-theme="light"] .logo-white { display: none; }
        [data-theme="light"] .logo-black { display: block; }

        .app-subtitle {
            font-size: var(--body-large);
            color: var(--md-on-surface-variant);
            font-weight: 400;
        }

        /* Module Grid */
        .module-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: var(--space-lg);
            max-width: 560px;
            width: 100%;
        }

        /* Module Cards - Theme aware */
        .module-card {
            background: var(--md-surface-container);
            border-radius: var(--shape-lg);
            padding: var(--space-lg) var(--space-md);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: var(--space-sm);
            cursor: pointer;
            transition: all 300ms cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: var(--elevation-1);
            position: relative;
            overflow: hidden;
            text-decoration: none;
            color: inherit;
            border: 1px solid var(--md-outline-variant);
            min-height: 160px;
        }

        /* Subtle glow effect on hover */
        .module-card::before {
            content: '';
            position: absolute;
            inset: 0;
            background: radial-gradient(circle at 50% 0%, var(--md-primary), transparent 70%);
            opacity: 0;
            transition: opacity 300ms ease;
        }

        .module-card:hover {
            border-color: var(--md-primary);
            box-shadow: 0 8px 32px color-mix(in srgb, var(--md-primary) 25%, transparent);
            transform: translateY(-4px);
        }

        .module-card:hover::before {
            opacity: 0.08;
        }

        .module-card:hover .module-icon {
            transform: scale(1.1);
            box-shadow: 0 4px 20px color-mix(in srgb, var(--md-primary) 40%, transparent);
        }

        .module-card:hover .module-title {
            color: var(--md-primary);
        }

        .module-card:active {
            transform: translateY(-2px) scale(0.98);
            transition: all 100ms ease;
        }

        /* Disabled state */
        .module-card.disabled {
            cursor: default;
            opacity: 0.6;
        }

        .module-card.disabled:hover {
            border-color: var(--md-outline-variant);
            box-shadow: var(--elevation-1);
            transform: none;
        }

        .module-card.disabled:hover::before {
            opacity: 0;
        }

        .module-card.disabled:hover .module-icon {
            transform: none;
            box-shadow: none;
        }

        .module-card.disabled:hover .module-title {
            color: var(--md-on-surface);
        }

        .module-card.disabled:active {
            transform: none;
        }

        /* GM Disabled Hint */
        .module-disabled-hint {
            position: absolute;
            bottom: 8px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 10px;
            color: var(--md-on-surface-variant);
            opacity: 0.7;
            white-space: nowrap;
        }

        /* Module Icon */
        .module-icon {
            width: 56px;
            height: 56px;
            background: var(--md-primary);
            border-radius: var(--shape-md);
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            z-index: 1;
            transition: all 300ms cubic-bezier(0.4, 0, 0.2, 1);
        }

        .module-icon img {
            width: 32px;
            height: 32px;
            object-fit: contain;
            filter: brightness(0) invert(1);
        }

        /* Module Text */
        .module-title {
            font-size: var(--body-large);
            font-weight: 500;
            color: var(--md-on-surface);
            text-align: center;
            transition: color 300ms ease;
        }

        .module-subtitle {
            font-size: var(--body-small);
            color: var(--md-on-surface-variant);
            text-align: center;
            opacity: 0.8;
        }

        /* Badge */
        .module-badge {
            position: absolute;
            top: 8px;
            right: 8px;
            background: var(--md-surface-container-highest);
            color: var(--md-on-surface-variant);
            font-size: 9px;
            font-weight: 600;
            padding: 3px 6px;
            border-radius: var(--shape-sm);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        /* Animations */
        @keyframes fadeIn {
            from {
                opacity: 0;
            }
            to {
                opacity: 1;
            }
        }

        .logo-section {
            animation: fadeIn 0.5s ease-out;
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(30px) scale(0.95);
            }
            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }

        .module-card {
            animation: slideUp 0.3s cubic-bezier(0.2, 0, 0, 1) backwards;
            pointer-events: auto;
        }
        .module-card.ready {
            pointer-events: auto;
        }
        .module-card.disabled {
            pointer-events: none !important;
        }
        .module-card:nth-child(1) { animation-delay: 0.05s; }
        .module-card:nth-child(2) { animation-delay: 0.075s; }
        .module-card:nth-child(3) { animation-delay: 0.1s; }
        .module-card:nth-child(4) { animation-delay: 0.125s; }
        .module-card:nth-child(5) { animation-delay: 0.15s; }
        .module-card:nth-child(6) { animation-delay: 0.175s; }

        /* Room Badge */
        .room-badge {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            padding: var(--space-xs) var(--space-md);
            background: var(--md-surface-container);
            border: 1px solid var(--md-outline-variant);
            border-radius: var(--shape-full);
            font-size: var(--label-small);
            color: var(--md-on-surface-variant);
            cursor: pointer;
            transition: all 200ms ease;
            animation: fadeIn 0.5s ease-out 0.4s backwards;
            min-width: 180px;
        }

        .room-badge:hover {
            background: var(--md-surface-container-high);
            border-color: var(--md-primary);
        }

        .room-badge:active {
            transform: scale(0.97);
        }

        .room-badge > svg {
            width: 16px;
            height: 16px;
            opacity: 0.7;
            flex-shrink: 0;
        }

        .room-badge > span {
            position: relative;
            top: 1px;
        }

        .room-badge code {
            font-family: 'Roboto Mono', monospace;
            font-weight: 600;
            color: var(--md-primary);
            letter-spacing: 1px;
            position: relative;
            top: 1px;
        }

        .room-badge.copied {
            border-color: var(--md-success, #4caf50);
            color: var(--md-success, #4caf50);
        }

        .room-badge.copied code {
            color: var(--md-success, #4caf50);
        }

        /* Hub Badges Container */
        .hub-badges {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: var(--space-sm);
            margin-top: var(--space-xl);
            position: relative;
            z-index: 50;
        }

        .hub-badges > * {
            animation: slideUp 0.3s cubic-bezier(0.2, 0, 0, 1) backwards;
        }
        .hub-badges > *:nth-child(1) { animation-delay: 0.2s; }
        .hub-badges > *:nth-child(2) { animation-delay: 0.225s; }
        .hub-badges > *:nth-child(3) { animation-delay: 0.25s; }
        .hub-badges > *:nth-child(4) { animation-delay: 0.275s; }

        .hub-badges .room-badge {
            margin-top: 0;
        }

        /* Regelwerk Badge */
        .ruleset-badge {
            position: relative;
            padding: 0;
        }

        .ruleset-badge-content {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            padding: var(--space-xs) var(--space-md);
            cursor: pointer;
        }

        .ruleset-badge-content img {
            width: 16px;
            height: 16px;
            object-fit: contain;
            opacity: 0.7;
        }

        .ruleset-badge-content span {
            position: relative;
            top: 1px;
        }

        .ruleset-badge .dropdown-arrow {
            transition: transform 200ms ease;
            opacity: 0.7;
        }

        .ruleset-badge.open .dropdown-arrow {
            transform: rotate(180deg);
        }

        /* Ruleset Dropdown */
        .ruleset-dropdown {
            position: absolute;
            top: calc(100% + 4px);
            left: 50%;
            transform: translateX(-50%);
            background: var(--md-surface-container);
            border: 1px solid var(--md-outline-variant);
            border-radius: var(--shape-lg);
            box-shadow: var(--elevation-2);
            min-width: 200px;
            padding: 4px;
            opacity: 0;
            visibility: hidden;
            transition: all 200ms ease;
            z-index: 1000;
        }

        .ruleset-dropdown.active {
            opacity: 1;
            visibility: visible;
        }

        .ruleset-option {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 8px 12px;
            border-radius: var(--shape-sm);
            cursor: pointer;
            transition: background 150ms ease;
            color: var(--md-on-surface-variant);
            font-size: var(--label-small);
        }

        .ruleset-option:hover {
            background: var(--md-surface-container-high);
        }

        .ruleset-option.active {
            background: var(--md-surface-container-highest);
            color: var(--md-on-surface);
        }

        .ruleset-option img {
            width: 18px;
            height: 18px;
            opacity: 0.8;
        }

        .ruleset-option.disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .ruleset-gm-note {
            padding: 6px 12px;
            font-size: 11px;
            color: var(--md-on-surface-variant);
            opacity: 0.7;
            text-align: center;
            border-bottom: 1px solid var(--md-outline-variant);
            margin-bottom: 4px;
        }

        /* Theme Badge */
        .theme-badge {
            position: relative;
            padding: 0;
        }

        .theme-badge-content {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            padding: var(--space-xs) var(--space-md);
            cursor: pointer;
        }

        .theme-badge-content svg:first-child {
            width: 16px;
            height: 16px;
            opacity: 0.7;
        }

        .theme-badge-content span {
            position: relative;
            top: 1px;
        }

        .theme-badge .dropdown-arrow {
            transition: transform 200ms ease;
            opacity: 0.7;
        }

        .theme-badge.open .dropdown-arrow {
            transform: rotate(180deg);
        }

        /* Hub Theme Dropdown */
        .hub-theme-dropdown {
            position: absolute;
            top: calc(100% + 4px);
            left: 50%;
            transform: translateX(-50%);
            background: var(--md-surface-container);
            border: 1px solid var(--md-outline-variant);
            border-radius: var(--shape-lg);
            box-shadow: var(--elevation-2);
            min-width: 160px;
            padding: 4px;
            opacity: 0;
            visibility: hidden;
            transition: all 200ms ease;
            z-index: 1000;
        }

        .hub-theme-dropdown.active {
            opacity: 1;
            visibility: visible;
        }

        .hub-theme-option {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 6px 12px;
            border-radius: var(--shape-sm);
            cursor: pointer;
            transition: background 150ms ease;
            color: var(--md-on-surface-variant);
            font-size: var(--label-small);
        }

        .hub-theme-option:hover {
            background: var(--md-surface-container-high);
            color: var(--md-on-surface);
        }

        .hub-theme-option.active {
            background: var(--md-primary);
            color: var(--md-on-primary);
        }

        .hub-theme-option .theme-icon {
            font-size: 14px;
            width: 18px;
            text-align: center;
        }

        /* GM Badge */
        .gm-badge {
            text-decoration: none;
            border-color: #4CAF50;
            color: #4CAF50;
        }

        .gm-badge:hover {
            background: color-mix(in srgb, #4CAF50 15%, var(--md-surface-container));
            border-color: #4CAF50;
        }

        .gm-badge svg {
            color: #4CAF50;
            opacity: 1 !important;
        }

        .gm-badge span {
            position: relative;
            top: 1px;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .user-name { display: none; }
            
            .container {
                padding-top: 100px;
            }
            
            .logo-section {
                margin-bottom: var(--space-xl);
            }
            
            .logo { 
                width: 200px; 
                margin-bottom: var(--space-md);
            }
            
            .app-subtitle {
                font-size: var(--body-large);
            }
            
            .module-grid {
                gap: var(--space-md);
            }

            .hub-badges {
                margin-top: var(--space-xl);
            }

            .quote-section {
                margin-top: var(--space-md);
                padding: var(--space-sm);
            }

            .quote-text {
                font-size: var(--body-medium);
                margin-bottom: 4px;
            }

            .quote-author {
                font-size: 11px;
            }
        }

        @media (max-width: 480px) {
            .container {
                padding: var(--space-md) var(--space-md);
                padding-top: 90px;
            }
            
            .logo-section {
                margin-bottom: var(--space-lg);
            }
            
            .logo { 
                width: 170px; 
                margin-bottom: var(--space-sm);
            }
            
            .app-subtitle { 
                font-size: var(--body-medium); 
            }
            
            .module-grid {
                grid-template-columns: 1fr 1fr;
                gap: var(--space-sm);
            }
            
            .module-card {
                padding: var(--space-md) var(--space-sm);
                min-height: 140px;
            }
            
            .module-icon {
                width: 48px;
                height: 48px;
            }
            
            .module-icon img {
                width: 28px;
                height: 28px;
            }
            
            .module-title {
                font-size: var(--body-medium);
            }
            
            .module-subtitle {
                font-size: var(--label-small);
            }
        }

        /* Quote Section */
        .quote-section {
            margin-top: var(--space-2xl);
            padding: var(--space-lg);
            text-align: center;
            max-width: 500px;
            position: relative;
            z-index: 1;
        }

        .quote-text {
            font-size: var(--body-large);
            font-style: italic;
            color: var(--md-on-surface-variant);
            margin-bottom: var(--space-sm);
            line-height: 1.6;
            opacity: 0.8;
        }

        .quote-text::before {
            content: '„';
            color: var(--md-primary);
            font-size: 1.5em;
            margin-right: 2px;
        }

        .quote-text::after {
            content: '"';
            color: var(--md-primary);
            font-size: 1.5em;
            margin-left: 2px;
        }

        .quote-author {
            font-size: var(--body-small);
            color: var(--md-outline);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: var(--space-sm);
        }

        .quote-author::before,
        .quote-author::after {
            content: '—';
            opacity: 0.5;
        }

        /* ===== SIDEBAR ===== */
        .sidebar-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 999;
            opacity: 0;
            visibility: hidden;
            transition: all 300ms ease;
        }

        .sidebar-overlay.active {
            opacity: 1;
            visibility: visible;
        }

        .sidebar {
            position: fixed;
            top: 0;
            left: 0;
            bottom: 0;
            width: 280px;
            background: var(--md-surface-container);
            z-index: 1000;
            transform: translateX(-100%);
            transition: transform 300ms cubic-bezier(0.4, 0, 0.2, 1);
            display: flex;
            flex-direction: column;
            box-shadow: var(--elevation-3);
        }

        .sidebar.open {
            transform: translateX(0);
        }

        .sidebar-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 16px;
            border-bottom: 1px solid var(--md-outline-variant);
        }

        .sidebar-logo {
            height: 32px;
        }

        .sidebar-logo img {
            height: 100%;
            width: auto;
        }

        .sidebar-close {
            width: 40px;
            height: 40px;
            background: transparent;
            border: none;
            border-radius: 50%;
            color: var(--md-on-surface);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .sidebar-close:hover {
            background: var(--md-surface-container-high);
        }

        .sidebar-close svg {
            width: 24px;
            height: 24px;
        }

        .sidebar-players-section {
            padding: 8px 0;
            border-bottom: 1px solid var(--md-outline-variant);
        }

        .sidebar-section-title {
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: var(--md-on-surface-variant);
            padding: 12px 20px 8px;
        }

        .sidebar-players-list {
            padding: 0 12px;
            display: flex;
            flex-direction: column;
            gap: 4px;
            max-height: 200px;
            overflow-y: auto;
        }

        .sidebar-players-loading {
            font-size: 12px;
            color: var(--md-on-surface-variant);
            padding: 8px 12px;
        }

        .sidebar-player-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 8px 12px;
            border-radius: 8px;
            background: var(--md-surface-container-high);
        }

        .sidebar-player-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            flex-shrink: 0;
        }

        .sidebar-player-name {
            font-size: 13px;
            color: var(--md-on-surface);
            flex: 1;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .sidebar-player-badge {
            font-size: 9px;
            font-weight: 600;
            background: var(--md-primary);
            color: var(--md-on-primary);
            padding: 2px 6px;
            border-radius: 4px;
            text-transform: uppercase;
        }

        .sidebar-player-badge.gm {
            background: #f44336;
        }

        .sidebar-nav {
            flex: 1;
            overflow-y: auto;
            padding: 8px 0;
        }

        .sidebar-link {
            display: flex;
            align-items: center;
            gap: 16px;
            padding: 14px 20px;
            color: var(--md-on-surface);
            text-decoration: none;
            font-size: 15px;
            font-weight: 500;
            transition: all 200ms ease;
            border: none;
            background: none;
            width: 100%;
            cursor: pointer;
            text-align: left;
        }

        .sidebar-link:hover {
            background: var(--md-surface-container-high);
        }

        .sidebar-link img {
            width: 24px;
            height: 24px;
            opacity: 0.8;
        }

        .sidebar-link svg {
            width: 24px;
            height: 24px;
            opacity: 0.8;
        }

        .sidebar-footer {
            border-top: 1px solid var(--md-outline-variant);
            padding: 8px 0;
        }

        /* Einheitliches Footer Item */
        .sidebar-footer-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 20px;
            color: var(--md-on-surface-variant);
            font-size: 14px;
            text-decoration: none;
            border: none;
            background: none;
            width: 100%;
            cursor: pointer;
            transition: background 150ms ease;
        }

        .sidebar-footer-item:hover {
            background: var(--md-surface-container-high);
        }

        .sidebar-footer-item svg {
            flex-shrink: 0;
            opacity: 0.8;
        }

        .sidebar-footer-item span {
            flex: 1;
            text-align: left;
        }

        /* Toggle Row */
        .sidebar-toggle-row {
            cursor: default;
        }

        .sidebar-toggle-row:hover {
            background: transparent;
        }

        .sidebar-toggle {
            display: flex;
            background: var(--md-surface-container-high);
            border-radius: 8px;
            overflow: hidden;
            margin-left: auto;
        }

        .sidebar-toggle-btn {
            padding: 6px 12px;
            border: none;
            background: transparent;
            color: var(--md-on-surface-variant);
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: all 200ms ease;
            font-family: inherit;
        }

        .sidebar-toggle-btn:hover {
            background: var(--md-surface-container-highest);
        }

        .sidebar-toggle-btn.active {
            background: var(--md-primary);
            color: var(--md-on-primary);
        }

        /* Logout */
        .sidebar-logout {
            color: var(--md-error) !important;
        }

        .sidebar-logout:hover {
            background: color-mix(in srgb, var(--md-error) 10%, transparent) !important;
        }

        .sidebar-logout svg {
            color: var(--md-error);
        }

        /* GM Options */
        .sidebar-gm-options {
            color: #4CAF50 !important;
            display: none;
        }

        .sidebar-gm-options.visible {
            display: flex;
        }

        .sidebar-gm-options:hover {
            background: color-mix(in srgb, #4CAF50 12%, transparent) !important;
        }

        .sidebar-gm-options svg {
            color: #4CAF50;
            opacity: 1;
        }

        .sidebar-legal {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 8px;
            padding: 16px 12px 8px;
            border-top: 1px solid var(--md-outline-variant);
            margin-top: 8px;
        }

        .sidebar-legal a {
            color: var(--md-on-surface-variant);
            text-decoration: none;
            font-size: 12px;
            opacity: 0.7;
            transition: opacity 200ms ease;
        }

        .sidebar-legal a:hover {
            opacity: 1;
            color: var(--md-primary);
        }

        .sidebar-legal span {
            color: var(--md-on-surface-variant);
            opacity: 0.5;
            font-size: 12px;
        }

        /* Hub Language Switcher */
        .hub-lang-switcher {
            display: flex;
            justify-content: center;
            padding: var(--space-lg) 0 var(--space-2xl);
        }

        .hub-lang-btn {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 14px;
            background: var(--md-surface-container-high);
            border: 1px solid var(--md-outline-variant);
            border-radius: var(--shape-full);
            color: var(--md-on-surface-variant);
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            transition: all 200ms ease;
        }

        .hub-lang-btn:hover {
            background: var(--md-surface-container-highest);
            border-color: var(--md-primary);
            color: var(--md-on-surface);
        }

        .hub-lang-btn svg {
            opacity: 0.8;
        }

  </style>
</head>
<body>
    <!-- Particles -->
    <div class="particles-container" id="particlesContainer"></div>

    <!-- Sidebar Overlay -->
    <div class="sidebar-overlay" id="sidebarOverlay" onclick="closeSidebar()"></div>

    <!-- Sidebar -->
    <aside class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <div class="sidebar-logo">
                <img src="assets/images/logo_rift_white_400px.png" alt="RIFT" class="logo-white">
                <img src="assets/images/logo_rift_black_400px.png" alt="RIFT" class="logo-black">
            </div>
            <button class="sidebar-close" onclick="closeSidebar()">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <line x1="18" y1="6" x2="6" y2="18"></line>
                    <line x1="6" y1="6" x2="18" y2="18"></line>
                </svg>
            </button>
        </div>
        
        <div class="sidebar-players-section">
            <div class="sidebar-section-title" data-i18n="sidebar.in_room">Im Raum</div>
            <div class="sidebar-players-list" id="sidebarPlayersList">
                <div class="sidebar-players-loading" data-i18n="sidebar.loading">Lade...</div>
            </div>
        </div>
        
        <nav class="sidebar-nav">
            <div class="sidebar-section-title" data-i18n="sidebar.modules">Module</div>
            <a href="charakterbogen.html" class="sidebar-link">
                <img src="assets/icons/icon_character.png" alt="">
                <span data-i18n="module.character">Charakter-Bogen</span>
            </a>
            <a href="wuerfel.html" class="sidebar-link">
                <img src="assets/icons/icon_dice.png" alt="">
                <span data-i18n="module.dice">Würfel</span>
            </a>
            <a href="karte.html" class="sidebar-link">
                <img src="assets/icons/icon_map.png" alt="">
                <span data-i18n="module.map">Karte</span>
            </a>
            <a href="notizen.html" class="sidebar-link">
                <img src="assets/icons/icon_notes.png" alt="">
                <span data-i18n="module.notes">Notizen</span>
            </a>
            <a href="whiteboard.html" class="sidebar-link">
                <img src="assets/icons/icon_whiteboard.png" alt="">
                <span data-i18n="module.whiteboard">Whiteboard</span>
            </a>
            <a href="chat.html" class="sidebar-link">
                <img src="assets/icons/icon_chat.png" alt="">
                <span data-i18n="module.chat">Chat</span>
            </a>
        </nav>
        
        <div class="sidebar-footer">
            <!-- Sound Toggle -->
            <div class="sidebar-footer-item sidebar-toggle-row">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"/>
                    <path d="M15.54 8.46a5 5 0 0 1 0 7.07"/>
                    <path d="M19.07 4.93a10 10 0 0 1 0 14.14"/>
                </svg>
                <span data-i18n="sidebar.sound">Sound</span>
                <div class="sidebar-toggle">
                    <button class="sidebar-toggle-btn" id="indexSoundOn" onclick="setSoundSetting(true)">AN</button>
                    <button class="sidebar-toggle-btn" id="indexSoundOff" onclick="setSoundSetting(false)">AUS</button>
                </div>
            </div>
            
            <!-- Sprache Toggle -->
            <div class="sidebar-footer-item sidebar-toggle-row">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <circle cx="12" cy="12" r="10"/>
                    <line x1="2" y1="12" x2="22" y2="12"/>
                    <path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"/>
                </svg>
                <span data-i18n="sidebar.language">Sprache</span>
                <div class="sidebar-toggle">
                    <button class="sidebar-toggle-btn" id="indexLangDe" onclick="setLanguage('de')">DE</button>
                    <button class="sidebar-toggle-btn" id="indexLangEn" onclick="setLanguage('en')">EN</button>
                </div>
            </div>
            
            <!-- Ausloggen -->
            <button class="sidebar-link sidebar-footer-item sidebar-logout" onclick="handleLogout()">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/>
                    <polyline points="16 17 21 12 16 7"/>
                    <line x1="21" y1="12" x2="9" y2="12"/>
                </svg>
                <span data-i18n="sidebar.logout">Ausloggen</span>
            </button>
            
            <!-- GM Optionen -->
            <a href="gm-options.html" class="sidebar-link sidebar-footer-item sidebar-gm-options" id="indexGmOptions">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.39a2 2 0 0 0-.73-2.73l-.15-.08a2 2 0 0 1-1-1.74v-.5a2 2 0 0 1 1-1.74l.15-.09a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z"/>
                    <circle cx="12" cy="12" r="3"/>
                </svg>
                <span data-i18n="sidebar.gm_options">GM Optionen</span>
            </a>
            
            <!-- Legal -->
            <div class="sidebar-legal">
                <a href="impressum.html" data-i18n="footer.imprint">Impressum</a>
                <span>·</span>
                <a href="privacy.html" data-i18n="footer.privacy">Datenschutz</a>
            </div>
        </div>
    </aside>

    <header class="top-bar">
        <div class="top-bar-left">
            <button class="hamburger-btn" onclick="toggleSidebar()" title="Menü" aria-label="Menü öffnen">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <line x1="3" y1="6" x2="21" y2="6"></line>
                    <line x1="3" y1="12" x2="21" y2="12"></line>
                    <line x1="3" y1="18" x2="21" y2="18"></line>
                </svg>
            </button>
            <span class="module-name">Hub</span>
        </div>
        <div class="top-bar-right">
            <div class="user-chip">
                <span class="user-dot" id="userDot"></span>
                <span id="userName"></span>
            </div>
            <button class="icon-btn" onclick="handleLogout()" title="" data-i18n-title="sidebar.logout">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path>
                    <polyline points="16 17 21 12 16 7"></polyline>
                    <line x1="21" y1="12" x2="9" y2="12"></line>
                </svg>
            </button>
        </div>
    </header>

    <main class="container">
        <!-- Logo Section -->
        <div class="logo-section">
            <a href="index.html" class="logo" title="Refresh" style="text-decoration: none;">
                <img src="assets/images/logo_rift_white_400px.png" alt="RIFT" class="logo-white">
                <img src="assets/images/logo_rift_black_400px.png" alt="RIFT" class="logo-black">
            </a>
            <p class="app-subtitle" data-i18n="hub.tagline">Ohne Umwege direkt ins Spiel</p>
        </div>

        <!-- Module Grid -->
        <div class="module-grid" id="moduleGrid"></div>

        <!-- Hub Badges -->
        <div class="hub-badges">
            <!-- Room Badge -->
            <div class="room-badge" id="roomBadge" onclick="copyRoomCode()">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" style="width: 16px; height: 16px; opacity: 0.7;">
                    <path d="M15 3h4a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2h-4"/>
                    <polyline points="10 17 15 12 10 7"/>
                    <line x1="15" y1="12" x2="3" y2="12"/>
                </svg>
                <span data-i18n="hub.room">Raum:</span>
                <code id="roomCode">-----</code>
            </div>

            <!-- Regelwerk Badge -->
            <div class="room-badge ruleset-badge" id="rulesetBadge">
                <div class="ruleset-badge-content" onclick="toggleRulesetDropdown()">
                    <img src="assets/icons/icon_ruleset_rumundrache.svg" alt="Regelwerk" id="rulesetIcon">
                    <span id="rulesetName">Rum & Rache</span>
                    <svg class="dropdown-arrow" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width: 12px; height: 12px;">
                        <polyline points="6 9 12 15 18 9"/>
                    </svg>
                </div>
                <div class="ruleset-dropdown" id="rulesetDropdown">
                    <div class="ruleset-gm-note" id="rulesetGmNote" style="display: none;">Nur GM kann ändern</div>
                    <!-- Options werden dynamisch geladen -->
                </div>
            </div>

            <!-- Theme Auswahl -->
            <div class="room-badge theme-badge" id="themeBadge">
                <div class="theme-badge-content" onclick="toggleHubThemeDropdown()">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" style="width: 16px; height: 16px; opacity: 0.7;">
                        <circle cx="12" cy="12" r="4"/>
                        <line x1="12" y1="2" x2="12" y2="4"/>
                        <line x1="12" y1="20" x2="12" y2="22"/>
                        <line x1="4.93" y1="4.93" x2="6.34" y2="6.34"/>
                        <line x1="17.66" y1="17.66" x2="19.07" y2="19.07"/>
                        <line x1="2" y1="12" x2="4" y2="12"/>
                        <line x1="20" y1="12" x2="22" y2="12"/>
                        <line x1="4.93" y1="19.07" x2="6.34" y2="17.66"/>
                        <line x1="17.66" y1="6.34" x2="19.07" y2="4.93"/>
                    </svg>
                    <span id="currentThemeName">Theme</span>
                    <svg class="dropdown-arrow" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width: 12px; height: 12px; opacity: 0.7;">
                        <polyline points="6 9 12 15 18 9"/>
                    </svg>
                </div>
                <div class="hub-theme-dropdown" id="hubThemeDropdown"></div>
            </div>

            <!-- GM Options Badge (nur für GMs sichtbar) -->
            <a href="gm-options.html" class="room-badge gm-badge" id="gmBadge" style="display: none;">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" style="width: 16px; height: 16px;">
                    <path d="M12 15a3 3 0 1 0 0-6 3 3 0 0 0 0 6Z"/>
                    <path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1Z"/>
                </svg>
                <span>GM</span>
            </a>
        </div>


        <!-- Quote Section -->
        <div class="quote-section">
            <p class="quote-text" id="quoteText">Würfle oder stirb.</p>
            <p class="quote-author" id="quoteAuthor">Unbekannter Abenteurer</p>
        </div>

        <!-- Footer -->
        <footer class="site-footer">
            <div class="footer-divider"></div>
            <div class="footer-content">
                <nav class="footer-primary">
                    <a href="about.html" data-i18n="footer.about">Über RIFT</a>
                    <span class="footer-dot">·</span>
                    <a href="branding.html" data-i18n="footer.branding">Branding Guide</a>
                    <span class="footer-dot">·</span>
                    <a href="contact.html" data-i18n="footer.contact">Kontakt</a>
                </nav>
                <nav class="footer-secondary">
                    <a href="privacy.html" data-i18n="footer.privacy">Datenschutz</a>
                    <span class="footer-dot">·</span>
                    <a href="impressum.html" data-i18n="footer.imprint">Impressum</a>
                </nav>
                <div class="footer-tertiary">
                    <a href="donation.html" data-i18n="footer.donate">Spenden</a>
                </div>
                <p class="footer-copyright">© 2025 RIFT – Tabletop Companion</p>
            </div>
        </footer>

        <!-- Language Switcher -->
        <div class="hub-lang-switcher">
            <button class="hub-lang-btn" onclick="setLanguage(currentLang === 'de' ? 'en' : 'de')">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <circle cx="12" cy="12" r="10"></circle>
                    <line x1="2" y1="12" x2="22" y2="12"></line>
                    <path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"></path>
                </svg>
                <span id="hubLangToggleLabel"></span>
            </button>
        </div>
    </main>

    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
    <script src="assets/js/lang.js"></script>
    <script src="assets/js/i18n.js"></script>
    <script src="assets/js/quotes.js"></script>
    <script src="assets/js/auth.js"></script>
    <script src="assets/js/firebase-sync.js"></script>
    <script>
        // ===== SOUND SETTINGS =====
        function isSoundMuted() {
            return localStorage.getItem('pnp_sound_muted') === 'true';
        }
        
        function setSoundSetting(enabled) {
            localStorage.setItem('pnp_sound_muted', !enabled);
            updateSidebarToggles();
        }
        
        function updateSidebarToggles() {
            // Sound Toggle
            const soundOn = document.getElementById('indexSoundOn');
            const soundOff = document.getElementById('indexSoundOff');
            if (soundOn && soundOff) {
                const muted = isSoundMuted();
                soundOn.classList.toggle('active', !muted);
                soundOff.classList.toggle('active', muted);
            }
            
            // Language Toggle
            const langDe = document.getElementById('indexLangDe');
            const langEn = document.getElementById('indexLangEn');
            if (langDe && langEn) {
                langDe.classList.toggle('active', currentLang === 'de');
                langEn.classList.toggle('active', currentLang === 'en');
            }
        }

        const MODULES = [
            { id: 'charakterbogen', title: t('module.character'), subtitle: t('module.character.subtitle'), icon: 'assets/icons/icon_character.png', href: 'charakterbogen.html', active: true },
            { id: 'wuerfel', title: t('module.dice'), subtitle: t('module.dice.subtitle'), icon: 'assets/icons/icon_dice.png', href: 'wuerfel.html', active: true },
            { id: 'karte', title: t('module.map'), subtitle: t('module.map.subtitle'), icon: 'assets/icons/icon_map.png', href: 'karte.html', active: true },
            { id: 'notizen', title: t('module.notes'), subtitle: t('module.notes.subtitle'), icon: 'assets/icons/icon_notes.png', href: 'notizen.html', active: true },
            { id: 'whiteboard', title: t('module.whiteboard'), subtitle: t('module.whiteboard.subtitle'), icon: 'assets/icons/icon_whiteboard.png', href: 'whiteboard.html', active: true },
            { id: 'chat', title: t('module.chat'), subtitle: t('module.chat.subtitle'), icon: 'assets/icons/icon_chat.png', href: 'chat.html', active: true }
        ];

        document.addEventListener('DOMContentLoaded', () => {
            if (!requireAuth()) return;
            
            // Initialize Sidebar Toggles
            updateSidebarToggles();
            
            // Update Hub Lang Switcher Label
            const hubLangLabel = document.getElementById('hubLangToggleLabel');
            if (hubLangLabel) {
                hubLangLabel.textContent = currentLang === 'de' ? 'DE' : 'EN';
            }
            
            // Create particles
            createParticles();
            
            // User Info
            const user = getCurrentUser();
            if (user) {
                document.getElementById('userName').textContent = user.username;
                const dot = document.getElementById('userDot');
                dot.style.backgroundColor = user.color;
                dot.style.boxShadow = `0 0 6px ${user.color}`;
            }
            
            // Room Code
            const room = getRoom();
            if (room && room.id) {
                document.getElementById('roomCode').textContent = room.id;
            }

            // Render Modules
            const grid = document.getElementById('moduleGrid');
            MODULES.forEach(m => {
                const card = document.createElement(m.active ? 'a' : 'div');
                card.className = `module-card${m.active ? '' : ' disabled'}`;
                if (m.active) card.href = m.href;
                card.innerHTML = `
                    ${!m.active ? '<span class="module-badge">Soon</span>' : ''}
                    <div class="module-icon"><img src="${m.icon}" alt="${m.title}"></div>
                    <div class="module-title">${m.title}</div>
                    <div class="module-subtitle">${m.subtitle}</div>
                `;
                grid.appendChild(card);
            });

            // Build Hub Theme Dropdown
            buildHubThemeDropdown();

            // Early GM Badge check (before Firebase)
            if (user?.isGM) {
                const gmBadge = document.getElementById('gmBadge');
                if (gmBadge) gmBadge.style.display = 'inline-flex';
                
                // Show GM Options in sidebar
                const gmOptions = document.getElementById('indexGmOptions');
                if (gmOptions) gmOptions.classList.add('visible');
            }

            // Load Random Quote
            loadRandomQuote();
            
            // Init Firebase for player list and catalog
            initFirebase().then(() => {
                onPlayersChange(updateSidebarPlayers);
                loadCatalogFromFirebase();
                updateRulesetBadgeForRole();
                listenForModuleStates();
            });
        });

        // Listen for module state changes from GM
        function listenForModuleStates() {
            if (!isFirebaseOnline()) return;
            
            const user = getCurrentUser();
            const isGM = user?.isGM || false;
            
            // GM can always access all modules - but show hint for disabled ones
            if (isGM) {
                let firstLoadGM = true;
                
                getRef('modules').on('value', (snapshot) => {
                    const modules = snapshot.val() || {};
                    const moduleIds = ['karte', 'whiteboard', 'notizen', 'chat'];
                    
                    const applyGMState = () => {
                        moduleIds.forEach(moduleId => {
                            const enabled = modules[moduleId] !== false;
                            const card = document.querySelector(`.module-card[href="${moduleId}.html"]`);
                            
                            if (card) {
                                // Remove existing hint if any
                                const existingHint = card.querySelector('.module-disabled-hint');
                                if (existingHint) existingHint.remove();
                                
                                // GM always has access, but show hint if disabled for players
                                card.classList.add('ready');
                                card.classList.remove('disabled', 'gm-disabled');
                                card.style.opacity = '';
                                
                                if (!enabled) {
                                    // Add hint for GM
                                    const hint = document.createElement('div');
                                    hint.className = 'module-disabled-hint';
                                    hint.textContent = t('hub.disabled_for_players');
                                    card.appendChild(hint);
                                }
                            }
                        });
                        
                        // Also make charakterbogen and wuerfel ready
                        document.querySelectorAll('.module-card[href="charakterbogen.html"], .module-card[href="wuerfel.html"]').forEach(card => {
                            card.classList.add('ready');
                        });
                    };
                    
                    if (firstLoadGM) {
                        firstLoadGM = false;
                        setTimeout(applyGMState, 50);
                    } else {
                        applyGMState();
                    }
                });
                return;
            }
            
            // Make charakterbogen and wuerfel ready after animation (always enabled)
            setTimeout(() => {
                document.querySelectorAll('.module-card[href="charakterbogen.html"], .module-card[href="wuerfel.html"]').forEach(card => {
                    card.classList.add('ready');
                });
            }, 50);
            
            let firstLoad = true;
            
            getRef('modules').on('value', (snapshot) => {
                const modules = snapshot.val() || {};
                
                // Update module cards based on state
                const moduleIds = ['karte', 'whiteboard', 'notizen', 'chat'];
                
                const applyState = () => {
                    moduleIds.forEach(moduleId => {
                        const enabled = modules[moduleId] !== false; // default to enabled
                        const card = document.querySelector(`.module-card[href="${moduleId}.html"]`);
                        
                        if (card) {
                            // Remove existing hint if any
                            const existingHint = card.querySelector('.module-disabled-hint');
                            if (existingHint) existingHint.remove();
                            
                            if (enabled) {
                                card.classList.remove('disabled', 'gm-disabled');
                                card.classList.add('ready');
                                card.style.opacity = '';
                            } else {
                                card.classList.add('disabled', 'gm-disabled');
                                card.classList.remove('ready');
                                card.style.opacity = '0.5';
                                
                                // Add subtle hint
                                const hint = document.createElement('div');
                                hint.className = 'module-disabled-hint';
                                hint.textContent = t('hub.disabled_by_gm');
                                card.appendChild(hint);
                            }
                        }
                    });
                };
                
                // First load: wait for animation, then apply
                if (firstLoad) {
                    firstLoad = false;
                    setTimeout(applyState, 50);
                } else {
                    // Subsequent updates: apply immediately
                    applyState();
                }
            });
        }

        // Update ruleset badge based on GM status
        function updateRulesetBadgeForRole() {
            const user = getCurrentUser();
            const isGM = user?.isGM || false;
            const badge = document.getElementById('rulesetBadge');
            const arrow = badge?.querySelector('.dropdown-arrow');
            const gmBadge = document.getElementById('gmBadge');
            
            if (!isGM) {
                // Non-GMs: kein Arrow, nicht klickbar aussehen
                if (arrow) arrow.style.display = 'none';
                badge.style.cursor = 'default';
                badge.title = 'Nur der GM kann das Abenteuer ändern';
                // GM Badge verstecken
                if (gmBadge) gmBadge.style.display = 'none';
            } else {
                // GMs: Arrow zeigen, klickbar
                if (arrow) arrow.style.display = '';
                badge.style.cursor = 'pointer';
                badge.title = 'Abenteuer-Katalog auswählen';
                // GM Badge zeigen
                if (gmBadge) gmBadge.style.display = 'inline-flex';
            }
        }

        // Update sidebar players
        function updateSidebarPlayers(players) {
            const list = document.getElementById('sidebarPlayersList');
            if (!list) return;
            
            if (!players || Object.keys(players).length === 0) {
                list.innerHTML = `<div class="sidebar-players-loading">${t('hub.no_players')}</div>`;
                return;
            }
            
            const currentUser = getCurrentUser();
            const isCurrentUserGM = currentUser?.isGM || false;
            
            // Sort: GM first, then alphabetically
            const sortedPlayers = Object.values(players).sort((a, b) => {
                if (a.isGM && !b.isGM) return -1;
                if (!a.isGM && b.isGM) return 1;
                return (a.username || '').localeCompare(b.username || '', 'de');
            });
            
            list.innerHTML = sortedPlayers.map(player => {
                const isMe = player.username === currentUser?.username;
                const isGM = player.isGM;
                const clickable = isCurrentUserGM && !isMe;
                
                return `
                    <div class="sidebar-player-item ${clickable ? 'gm-clickable' : ''}" 
                         ${clickable ? `onclick="openPlayerManagePopup('${player.username}', '${player.color}', ${isGM}, ${player.isRoomCreator || false})"` : ''}>
                        <span class="sidebar-player-dot" style="background: ${player.color}; box-shadow: 0 0 6px ${player.color};"></span>
                        <span class="sidebar-player-name">${player.username}${isMe ? ' (Du)' : ''}</span>
                        ${isGM ? '<span class="sidebar-player-badge gm">GM</span>' : ''}
                    </div>
                `;
            }).join('');
        }

        // ===== PARTICLES =====
        function createParticles() {
            const container = document.getElementById('particlesContainer');
            const particleCount = 25;
            
            for (let i = 0; i < particleCount; i++) {
                const particle = document.createElement('div');
                particle.className = 'particle';
                
                particle.style.left = Math.random() * 100 + '%';
                
                const size = 2 + Math.random() * 3;
                particle.style.width = size + 'px';
                particle.style.height = size + 'px';
                
                const duration = 18 + Math.random() * 25;
                const delay = Math.random() * 20;
                particle.style.animationDuration = duration + 's';
                particle.style.animationDelay = delay + 's';
                
                container.appendChild(particle);
            }
        }

        // Copy Room Code
        function copyRoomCode() {
            const room = getRoom();
            if (!room || !room.id) return;
            
            navigator.clipboard.writeText(room.id).then(() => {
                const badge = document.getElementById('roomBadge');
                badge.classList.add('copied');
                document.getElementById('roomCode').textContent = 'Kopiert!';
                
                setTimeout(() => {
                    badge.classList.remove('copied');
                    document.getElementById('roomCode').textContent = room.id;
                }, 1500);
            });
        }

        function loadRandomQuote() {
            const quotes = QUOTES[currentLang] || QUOTES.de;
            const quote = quotes[Math.floor(Math.random() * quotes.length)];
            document.getElementById('quoteText').textContent = quote[0];
            document.getElementById('quoteAuthor').textContent = quote[1];
        }

        function buildHubThemeDropdown() {
            const dropdown = document.getElementById('hubThemeDropdown');
            const themes = getThemes();
            const current = getCurrentTheme();
            
            // Update current theme name display
            const currentTheme = themes.find(t => t.id === current);
            if (currentTheme) {
                document.getElementById('currentThemeName').textContent = currentTheme.name;
            }
            
            dropdown.innerHTML = themes.map(t => `
                <div class="hub-theme-option${t.id === current ? ' active' : ''}" data-theme-id="${t.id}">
                    <span class="theme-icon">${t.icon}</span>
                    <span class="theme-name">${t.name}</span>
                </div>
            `).join('');
        }
        
        // Single event handler for theme dropdown
        document.addEventListener('click', function(e) {
            const themeBadge = document.getElementById('themeBadge');
            const themeOption = e.target.closest('.hub-theme-option');
            
            // Handle theme option click
            if (themeOption) {
                e.stopPropagation();
                const themeId = themeOption.getAttribute('data-theme-id');
                console.log('[Theme] Clicked:', themeId);
                if (themeId) {
                    setTheme(themeId);
                    buildHubThemeDropdown();
                    if (themeBadge) {
                        themeBadge.classList.remove('open');
                        document.getElementById('hubThemeDropdown').classList.remove('active');
                    }
                }
                return;
            }
            
            // Close dropdowns on outside click
            const rulesetBadge = document.getElementById('rulesetBadge');
            if (rulesetBadge && !rulesetBadge.contains(e.target)) {
                rulesetBadge.classList.remove('open');
                document.getElementById('rulesetDropdown').classList.remove('active');
            }
            
            if (themeBadge && !themeBadge.contains(e.target)) {
                themeBadge.classList.remove('open');
                document.getElementById('hubThemeDropdown').classList.remove('active');
            }
        });

        function toggleHubThemeDropdown() {
            const badge = document.getElementById('themeBadge');
            const dropdown = document.getElementById('hubThemeDropdown');
            
            // Close ruleset dropdown if open
            document.getElementById('rulesetBadge').classList.remove('open');
            document.getElementById('rulesetDropdown').classList.remove('active');
            
            badge.classList.toggle('open');
            dropdown.classList.toggle('active');
        }

        function handleLogout() {
            if (confirm(t('logout_confirm'))) {
                logout(true);
            }
        }

        // ===== SIDEBAR =====
        let sidebarOpen = false;

        function toggleSidebar() {
            sidebarOpen ? closeSidebar() : openSidebar();
        }

        function openSidebar() {
            sidebarOpen = true;
            document.getElementById('sidebar').classList.add('open');
            document.getElementById('sidebarOverlay').classList.add('active');
            document.body.style.overflow = 'hidden';
        }

        function closeSidebar() {
            sidebarOpen = false;
            document.getElementById('sidebar').classList.remove('open');
            document.getElementById('sidebarOverlay').classList.remove('active');
            document.body.style.overflow = '';
        }

        // Close sidebar with escape key
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape' && sidebarOpen) closeSidebar();
            if (e.key === 'Escape') closeRulesetDropdown();
        });

        // ===== CATALOG SELECTOR (DROPDOWN) =====
        const CATALOGS = [
            {
                id: 'rum-und-rache',
                name: 'Rum & Rache',
                icon: 'assets/icons/icon_ruleset_rumundrache.svg'
            },
            {
                id: 'fantasy-classic',
                name: 'Fantasy Classic',
                icon: 'assets/icons/icon_ruleset_fantasy.svg'
            },
            {
                id: 'neon-abyss',
                name: 'Neon Abyss',
                icon: 'assets/icons/icon_ruleset_neon.svg'
            },
            {
                id: 'basis',
                name: 'Basis',
                icon: 'assets/icons/icon_ruleset_basis.svg'
            }
        ];

        let selectedCatalogId = 'rum-und-rache';

        function toggleRulesetDropdown() {
            const user = getCurrentUser();
            const isGM = user?.isGM || false;
            
            // Non-GMs können das Dropdown nicht öffnen
            if (!isGM) {
                return;
            }
            
            const badge = document.getElementById('rulesetBadge');
            const dropdown = document.getElementById('rulesetDropdown');
            const isOpen = badge.classList.contains('open');
            
            // Close theme dropdown if open
            document.getElementById('themeBadge').classList.remove('open');
            document.getElementById('hubThemeDropdown').classList.remove('active');
            
            if (isOpen) {
                closeRulesetDropdown();
            } else {
                badge.classList.add('open');
                dropdown.classList.add('active');
                renderRulesetDropdown();
            }
        }

        function closeRulesetDropdown() {
            document.getElementById('rulesetBadge').classList.remove('open');
            document.getElementById('rulesetDropdown').classList.remove('active');
        }

        function renderRulesetDropdown() {
            const user = getCurrentUser();
            const isGM = user?.isGM || false;
            const dropdown = document.getElementById('rulesetDropdown');
            const gmNote = document.getElementById('rulesetGmNote');
            
            // Show/hide GM note
            gmNote.style.display = isGM ? 'none' : 'block';
            
            // Clear existing options (keep gmNote)
            dropdown.querySelectorAll('.ruleset-option').forEach(el => el.remove());
            
            CATALOGS.forEach(catalog => {
                const option = document.createElement('div');
                option.className = `ruleset-option${catalog.id === selectedCatalogId ? ' active' : ''}${!isGM ? ' disabled' : ''}`;
                option.innerHTML = `
                    <img src="${catalog.icon}" alt="${catalog.name}" onerror="this.style.display='none'">
                    <span>${catalog.name}</span>
                `;
                
                if (isGM) {
                    // Use addEventListener with captured catalogId
                    const catId = catalog.id;
                    option.addEventListener('click', function(e) {
                        e.preventDefault();
                        e.stopPropagation();
                        selectCatalog(catId);
                    });
                }
                
                dropdown.appendChild(option);
            });
        }

        function selectCatalog(catalogId) {
            const user = getCurrentUser();
            if (!user?.isGM) return;
            
            selectedCatalogId = catalogId;
            updateRulesetBadge();
            saveCatalogToFirebase();
            closeRulesetDropdown();
        }

        function updateRulesetBadge() {
            const catalog = CATALOGS.find(c => c.id === selectedCatalogId) || CATALOGS[0];
            document.getElementById('rulesetName').textContent = catalog.name;
            document.getElementById('rulesetIcon').src = catalog.icon;
            
            // Store locally as well
            localStorage.setItem('rift_active_catalog', selectedCatalogId);
        }

        function saveCatalogToFirebase() {
            if (!isFirebaseOnline()) return;
            
            const ref = getRef('settings/catalog');
            if (ref) {
                ref.set(selectedCatalogId);
                console.log('[Catalog] Saved to Firebase:', selectedCatalogId);
            }
        }

        function loadCatalogFromFirebase() {
            if (!isFirebaseOnline()) {
                // Load from localStorage as fallback
                const stored = localStorage.getItem('rift_active_catalog');
                if (stored) {
                    selectedCatalogId = stored;
                    updateRulesetBadge();
                }
                return;
            }
            
            const ref = getRef('settings/catalog');
            if (ref) {
                ref.on('value', (snapshot) => {
                    const catalogId = snapshot.val();
                    if (catalogId && CATALOGS.find(c => c.id === catalogId)) {
                        selectedCatalogId = catalogId;
                        updateRulesetBadge();
                        console.log('[Catalog] Loaded from Firebase:', selectedCatalogId);
                    }
                });
            }
        }

        // Load catalog after Firebase init - integrated in main DOMContentLoaded

</script>
</body>
</html>
