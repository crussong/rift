<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Charakterbogen | Worlds Apart | RIFT</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Rounded:opsz,wght,FILL,GRAD@24,400,1,0" rel="stylesheet">
    <!-- V2 Layout -->
    <link rel="stylesheet" href="assets/css/sheet-layout.css">
    <link rel="stylesheet" href="assets/css/rift.css">
    <link rel="stylesheet" href="assets/css/core.css">
    <link rel="stylesheet" href="assets/css/ui.css">
    <link rel="stylesheet" href="assets/css/sidebar.css">
    <link rel="stylesheet" href="assets/css/topbar.css">
    <link rel="stylesheet" href="assets/css/footer.css">
    <style>
        :root {
            /* Map local variables to core.css variables for sidebar/topbar compatibility */
            --bg-darkest: var(--black, #161616);
            --bg-dark: var(--bg, #1a1a1a);
            --bg-card-hover: #252525;
            --bg-input: var(--black, #161616);
            
            /* Ensure hover-bg is defined for sidebar */
            --hover-bg: rgba(255, 255, 255, 0.06);
            
            /* Primary Accent - RIFT Red */
            --accent-primary: var(--accent, #FF4655);
            --accent-primary-light: #ff6b77;
            --accent-primary-dim: var(--red-dim, rgba(255, 70, 85, 0.12));
            --accent-primary-glow: var(--red-glow, rgba(255, 70, 85, 0.4));
            
            /* Gold for special elements */
            --accent-gold: #fbbf24;
            --accent-gold-dim: rgba(251, 191, 36, 0.12);
            
            /* Status Colors */
            --color-health: #22c55e;
            --color-moral: #3b82f6;
            --color-resonanz: #8b5cf6;
            --color-green: #22c55e;
            
            /* Text - map to core.css */
            --text-primary: var(--text, #dedede);
            --text-secondary: var(--text-muted, #bebebe);
            
            /* Borders - map to core.css */
            --border-subtle: var(--border, rgba(255, 255, 255, 0.06));
            --border-default: var(--border-hover, rgba(255, 255, 255, 0.1));
            
            /* Spacing */
            --gap-xs: 4px;
            --gap-sm: 8px;
            --gap-md: 12px;
            --gap-lg: 16px;
            --gap-xl: 24px;
        }

        /* ===== PAGE HEADER (RIFT Style) ===== */
        .page-header {
            display: flex;
            align-items: center;
            gap: 16px;
            padding: 24px 24px 0 24px;
            margin-bottom: 0;
        }
        
        .wa-back-btn {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 8px 14px;
            margin-left: 8px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            color: var(--text-secondary, #999);
            font-size: 13px;
            font-weight: 500;
            text-decoration: none;
            transition: all 0.2s ease;
            white-space: nowrap;
        }
        
        .wa-back-btn:first-of-type {
            margin-left: auto;
        }
        
        .wa-back-btn:hover {
            background: rgba(255, 255, 255, 0.1);
            border-color: rgba(255, 255, 255, 0.2);
            color: var(--text-primary, #fff);
        }
        
        .wa-back-btn svg {
            width: 14px;
            height: 14px;
            flex-shrink: 0;
        }

        .page-header__icon {
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--text-secondary);
        }

        .page-header__icon svg {
            width: 20px;
            height: 20px;
            fill: currentColor;
        }

        .page-header__divider {
            width: 1px;
            height: 28px;
            background: rgba(255, 255, 255, 0.2);
        }

        .page-header__title {
            font-family: 'Dharma Gothic', sans-serif;
            font-size: 56px;
            font-weight: 700;
            font-style: italic;
            color: var(--text-primary);
            margin: 0;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .page-header__tagline {
            color: var(--accent-primary);
            font-family: 'Dharma Gothic', sans-serif;
            font-size: 24px;
            font-weight: 400;
            font-style: italic;
        }

        .section-divider {
            height: 1px;
            background: linear-gradient(90deg, transparent, var(--border-default), transparent);
            margin: 16px 24px 24px 24px;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            color: var(--text-primary);
            min-height: 100vh;
            line-height: 1.5;
            font-size: 14px;
            background: var(--bg-darkest);
        }

        /* RIFT App Container */
        .app {
            display: flex;
            min-height: 100vh;
        }

        /* ===== FOOTER STYLES ===== */
        .site-footer {
            background: transparent;
            border-top: 1px solid var(--border-subtle);
            margin-top: var(--gap-xl);
            padding: var(--gap-xl) 16px;
        }

        .footer-divider {
            display: none;
        }

        .footer-content {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: var(--gap-sm);
            opacity: 0.7;
            transition: opacity 0.2s;
        }

        .footer-content:hover {
            opacity: 1;
        }

        .footer-primary,
        .footer-secondary,
        .footer-tertiary {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: var(--gap-sm);
        }

        .footer-primary a,
        .footer-secondary a,
        .footer-tertiary a {
            color: var(--text-secondary);
            text-decoration: none;
            font-size: 13px;
            transition: color 0.15s;
        }

        .footer-primary a:hover,
        .footer-secondary a:hover,
        .footer-tertiary a:hover {
            color: var(--text-primary);
        }

        .footer-dot {
            color: var(--text-muted);
            font-size: 13px;
        }

        .footer-copyright {
            color: var(--text-muted);
            font-size: 12px;
            margin-top: var(--gap-sm);
        }

        .footer-lang-btn {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            margin-top: var(--gap-md);
            padding: 8px 16px;
            background: var(--bg-elevated);
            border: 1px solid var(--border-subtle);
            border-radius: 20px;
            color: var(--text-secondary);
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.15s;
        }

        .footer-lang-btn:hover {
            background: var(--bg-card-hover);
            border-color: var(--accent-primary);
            color: var(--text-primary);
        }

        /* Background Image - handled by rift.css */

        /* ===== LAYOUT ===== */
        .sheet-container {
            max-width: 1400px;
            margin: 0 auto;
            padding: var(--gap-lg);
            padding-bottom: 80px;
        }

        /* 2x2 Grid */
        .main-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: var(--gap-lg) 40px;
            margin-bottom: var(--gap-lg);
        }

        .grid-section {
            position: relative;
        }

        /* Grid dividers removed for cleaner RIFT look */

        /* ===== CARDS ===== */
        .card {
            background: var(--bg-card);
            border-radius: var(--radius-lg);
            border: 1px solid var(--border-subtle);
            overflow: hidden;
        }

        .card-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: var(--gap-md) var(--gap-lg);
            border-bottom: 1px solid var(--border-subtle);
            background: var(--bg-elevated);
        }

        .card-title {
            font-family: 'Dharma Gothic', sans-serif;
            font-size: 16px;
            font-weight: 700;
            font-style: italic;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: rgba(255, 255, 255, 0.5);
            display: flex;
            align-items: center;
            gap: var(--gap-sm);
        }

        .card-title-icon {
            font-family: 'Material Symbols Rounded';
            font-size: 20px;
            font-weight: normal;
            font-style: normal;
            line-height: 1;
            letter-spacing: normal;
            text-transform: none;
            display: inline-block;
            white-space: nowrap;
            word-wrap: normal;
            direction: ltr;
            -webkit-font-smoothing: antialiased;
        }

        .card-actions {
            display: flex;
            gap: var(--gap-sm);
        }

        .card-action-btn {
            width: 28px;
            height: 28px;
            border-radius: var(--radius-sm);
            background: var(--bg-elevated);
            border: none;
            color: var(--text-muted);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.15s;
            position: relative;
            z-index: 10;
        }

        .card-action-btn:hover {
            background: var(--bg-card-hover);
            color: var(--accent-primary);
            animation: diceWobble 0.5s ease;
        }

        .card-action-btn:active {
            animation: diceClick 0.15s ease;
        }

        .card-action-btn svg {
            width: 14px;
            height: 14px;
            pointer-events: none;
        }

        /* GM-only elements - hidden by default */
        .gm-only {
            display: none !important;
        }

        .gm-mode .gm-only {
            display: flex !important;
        }

        .card-action-btn.gm-only {
            background: rgba(139, 92, 246, 0.15);
            border-color: rgba(139, 92, 246, 0.3);
            color: #a78bfa;
        }

        .card-action-btn.gm-only:hover {
            background: rgba(139, 92, 246, 0.25);
            border-color: rgba(139, 92, 246, 0.5);
        }

        .card-body {
            padding: var(--gap-lg);
        }

        /* ===== CHARACTER CARD ===== */
        .character-layout {
            display: grid;
            grid-template-columns: auto 1fr;
            gap: var(--gap-xl);
        }

        .character-visual {
            display: flex;
            flex-direction: column;
            gap: var(--gap-sm);
            align-items: center;
        }

        .portrait-container {
            position: relative;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
        }

        .portrait {
            width: 140px;
            height: 140px;
            border-radius: var(--radius-md);
            background: var(--bg-elevated);
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
            transition: all 0.2s;
            border: 1px solid var(--border-subtle);
            position: relative;
        }

        .portrait:hover {
            border-color: var(--border-default);
        }

        .portrait img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .portrait-placeholder {
            color: var(--text-muted);
            font-size: 10px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .portrait-health-overlay {
            position: absolute;
            inset: 0;
            pointer-events: none;
            z-index: 3;
            border-radius: var(--radius-md);
            transition: all 0.3s;
        }

        .portrait-health-overlay.critical {
            box-shadow: inset 0 0 15px rgba(220, 38, 38, 0.4);
            animation: pulse-critical 2s infinite;
        }

        .portrait-health-overlay.low {
            box-shadow: inset 0 0 12px rgba(245, 158, 11, 0.3);
        }

        .portrait-health-overlay.dead {
            background: rgba(0, 0, 0, 0.6);
        }

        /* healthy = no effect */
        .portrait-health-overlay.healthy {
            /* Intentionally empty - no vignette when healthy */
        }

        @keyframes pulse-critical {
            0%, 100% { box-shadow: inset 0 0 15px rgba(220, 38, 38, 0.4); }
            50% { box-shadow: inset 0 0 20px rgba(220, 38, 38, 0.5); }
        }

        .portrait-controls-row {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .portrait-controls-row .img-control-btn {
            opacity: 0;
            transition: opacity 0.2s ease;
        }

        .portrait-container:hover .portrait-controls-row .img-control-btn {
            opacity: 1;
        }

        .level-badge {
            background: var(--accent-primary);
            color: white;
            font-size: 14px;
            font-weight: 700;
            width: 32px;
            height: 32px;
            border-radius: 50%;
            display: grid;
            place-items: center;
            cursor: pointer;
            transition: all 0.2s;
            line-height: 1;
            padding: 0;
            margin: 0;
        }

        .level-badge:hover {
            transform: scale(1.1);
        }

        .crew-flag-controls {
            position: absolute;
            bottom: 4px;
            right: 4px;
            display: none;
            gap: 4px;
            z-index: 10;
        }

        .crew-flag-container:hover .crew-flag-controls {
            display: flex;
        }

        .img-control-btn {
            width: 24px;
            height: 24px;
            border-radius: var(--radius-sm);
            background: rgba(0, 0, 0, 0.7);
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.15s;
        }

        .img-control-btn .card-title-icon {
            font-size: 14px;
            color: white;
        }

        .img-control-btn:hover {
            background: var(--accent-primary);
        }

        .img-control-btn.delete:hover {
            background: #dc2626;
        }

        .img-control-btn.small {
            width: 20px;
            height: 20px;
        }

        .img-control-btn.small .card-title-icon {
            font-size: 12px;
        }

        .crew-flag-container {
            position: relative;
            margin-top: var(--gap-sm);
        }

        .crew-flag {
            width: 140px;
            height: 80px; /* ~7:4 ratio for crew flags */
            border-radius: var(--radius-sm);
            background: var(--bg-elevated);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
            border: 1px solid var(--border-subtle);
            transition: all 0.2s;
        }

        .crew-flag:hover {
            border-color: var(--accent-primary);
        }

        .crew-flag img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .crew-flag-placeholder {
            color: var(--text-muted);
            font-size: 9px;
            text-transform: uppercase;
        }

        .character-info {
            display: flex;
            flex-direction: column;
            gap: var(--gap-md);
            height: 100%;
        }

        .character-name {
            background: transparent;
            border: none;
            font-family: 'Dharma Gothic', sans-serif;
            font-size: 42px;
            font-weight: 700;
            font-style: italic;
            letter-spacing: 1px;
            color: var(--text-primary);
            outline: none;
            padding: 0;
            width: 100%;
            padding-bottom: var(--gap-sm);
            border-bottom: 1px solid var(--border-subtle);
        }

        .character-name:focus {
            border-color: var(--accent-primary);
        }

        .character-name::placeholder {
            color: var(--text-muted);
        }

        .character-meta {
            display: flex;
            gap: var(--gap-md);
            color: var(--text-secondary);
            font-size: 13px;
        }

        .character-meta-item {
            display: flex;
            align-items: center;
            gap: var(--gap-xs);
        }

        .character-meta-item input {
            background: transparent;
            border: none;
            color: var(--text-secondary);
            font-size: 13px;
            outline: none;
            width: 80px;
        }

        .character-meta-item select {
            background: var(--bg-input);
            border: 1px solid var(--border-subtle);
            border-radius: var(--radius-sm);
            color: var(--text-secondary);
            font-size: 12px;
            padding: 6px 10px;
            outline: none;
            cursor: pointer;
            appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 24 24' fill='none' stroke='%23888' stroke-width='2'%3E%3Cpath d='M6 9l6 6 6-6'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 8px center;
            padding-right: 28px;
            min-width: 100px;
        }

        .character-meta-item select:hover {
            border-color: var(--border-hover);
        }

        .character-meta-item select:focus {
            border-color: var(--accent-primary);
        }

        .character-meta-item select option {
            background: var(--bg-card);
            color: var(--text-primary);
        }

        .character-fields {
            display: grid;
            grid-template-columns: 1fr 2fr;
            gap: var(--gap-sm);
            flex: 1;
        }

        .field-group {
            display: flex;
            flex-direction: column;
            gap: var(--gap-xs);
        }

        .field-label {
            font-size: 10px;
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: var(--text-muted);
        }

        .field-input {
            background: var(--bg-input);
            border: 1px solid var(--border-subtle);
            border-radius: var(--radius-sm);
            padding: var(--gap-sm) var(--gap-md);
            font-size: 13px;
            color: var(--text-primary);
            outline: none;
            transition: border-color 0.2s;
        }

        .field-input:focus {
            border-color: var(--border-default);
        }

        .field-textarea {
            background: var(--bg-input);
            border: 1px solid var(--border-subtle);
            border-radius: var(--radius-sm);
            padding: var(--gap-sm) var(--gap-md);
            font-size: 12px;
            color: var(--text-primary);
            outline: none;
            resize: none;
            min-height: 88px;
            font-family: inherit;
            grid-column: 1 / -1;
            align-self: stretch;
        }

        .field-textarea:focus {
            border-color: var(--border-default);
        }

        /* ===== ATTRIBUTES CARD ===== */
        .attributes-top-row {
            display: flex;
            justify-content: center;
            gap: var(--gap-lg);
        }

        .attributes-bottom-row {
            display: flex;
            justify-content: center;
            gap: var(--gap-lg);
            margin-top: var(--gap-md);
        }

        .attribute-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 2px;
            cursor: pointer;
            transition: transform 0.15s;
            padding: 0 var(--gap-sm);
        }

        .attribute-item:hover {
            transform: translateY(-2px);
        }

        .attribute-item:hover .attribute-box {
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
        }

        .attribute-item:hover .attribute-box::before {
            filter: invert(1) brightness(0.9);
            opacity: 1;
        }

        .attribute-box {
            background-color: transparent;
            border: none;
            border-radius: 0;
            padding: var(--gap-lg) var(--gap-xl);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 2px;
            width: 100px;
            min-width: 100px;
            max-width: 100px;
            transition: all 0.2s;
            position: relative;
            z-index: 1;
        }

        .attribute-box::before {
            content: '';
            position: absolute;
            inset: -4px;
            background-image: url('assets/img/sheet_frame.png');
            background-size: 100% 100%;
            background-repeat: no-repeat;
            opacity: 0.6;
            z-index: -1;
            transition: opacity 0.2s, filter 0.2s;
            filter: invert(1);
        }

        .attribute-box:hover::before {
            opacity: 1;
            filter: invert(1) drop-shadow(0 0 4px var(--accent-primary));
        }

        .attribute-modifier {
            font-size: 26px;
            font-weight: 700;
            color: var(--text-primary);
            line-height: 1;
            text-align: center;
            width: 100%;
        }

        .attribute-modifier.positive {
            color: var(--color-green);
        }

        .attribute-modifier.negative {
            color: var(--color-health);
        }

        .attribute-modifier input {
            background: transparent;
            border: none;
            width: 100%;
            text-align: center;
            font-size: 26px;
            font-weight: 700;
            color: inherit;
            outline: none;
            -moz-appearance: textfield;
            padding: 0;
            margin: 0;
        }

        .attribute-modifier input::-webkit-outer-spin-button,
        .attribute-modifier input::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }

        .attribute-name {
            font-size: 10px;
            font-weight: 500;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .attribute-base {
            background: var(--bg-card);
            border-radius: var(--radius-sm);
            padding: 2px 8px;
            font-size: 11px;
            font-weight: 600;
            color: var(--text-secondary);
            margin-top: 2px;
        }

        .attr-points-row {
            display: flex;
            justify-content: center;
            margin-bottom: var(--gap-md);
        }

        .attr-points-badge {
            font-size: 11px;
            font-weight: 600;
            color: var(--color-green);
            padding: 6px 14px;
            background: rgba(34, 197, 94, 0.15);
            border-radius: 20px;
            transition: all 0.2s;
        }

        /* ===== STATUS CARD ===== */
        .status-layout {
            display: flex;
            flex-direction: column;
            gap: var(--gap-md);
        }

        .status-bars {
            display: flex;
            flex-direction: column;
            gap: var(--gap-md);
        }

        .status-item {
            display: flex;
            align-items: center;
            gap: var(--gap-md);
        }

        .status-values {
            display: flex;
            align-items: baseline;
            gap: 2px;
            min-width: 120px;
            flex-shrink: 0;
        }

        .status-current {
            font-size: 24px;
            font-weight: 700;
            background: transparent;
            border: none;
            color: var(--text-primary);
            width: 55px;
            outline: none;
            text-align: right;
            -moz-appearance: textfield;
        }

        .status-current::-webkit-outer-spin-button,
        .status-current::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }

        .status-current-display {
            font-size: 24px;
            font-weight: 700;
            color: var(--text-primary);
            width: 55px;
            text-align: right;
            display: inline-block;
        }

        .status-separator {
            color: var(--text-muted);
            font-size: 16px;
        }

        .status-max {
            font-size: 14px;
            color: var(--text-muted);
            width: 30px;
        }

        .status-bar-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .status-label {
            font-size: 10px;
            font-weight: 500;
            text-transform: uppercase;
            color: var(--text-muted);
        }

        .status-bar {
            height: 8px;
            background: var(--bg-input);
            border-radius: 4px;
            overflow: hidden;
        }

        .status-bar.draggable {
            cursor: ew-resize;
            transition: transform 0.1s ease;
        }

        .status-bar.draggable:hover {
            transform: scaleY(1.3);
        }

        .status-bar.draggable:active {
            transform: scaleY(1.5);
        }

        .status-bar-fill {
            height: 100%;
            border-radius: 4px;
            transition: width 0.3s ease;
            background-size: 200% 100%;
            animation: gradient-shift 8s ease infinite;
        }

        @keyframes gradient-shift {
            0%, 100% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
        }

        .status-bar-fill.health { background: linear-gradient(90deg, #166534, #22c55e, #166534); background-size: 200% 100%; }
        .status-bar-fill.moral { background: linear-gradient(90deg, #1d4ed8, #60a5fa, #1d4ed8); background-size: 200% 100%; }
        .status-bar-fill.resonanz { background: linear-gradient(90deg, #6d28d9, #a78bfa, #6d28d9); background-size: 200% 100%; }

        /* Critical pulse animations for low HP/Moral */
        @keyframes bar-pulse-red {
            0%, 100% { 
                box-shadow: 0 0 8px rgba(220, 38, 38, 0.6);
                filter: brightness(1);
            }
            50% { 
                box-shadow: 0 0 16px rgba(220, 38, 38, 0.9);
                filter: brightness(1.2);
            }
        }

        @keyframes bar-pulse-blue {
            0%, 100% { 
                box-shadow: 0 0 8px rgba(59, 130, 246, 0.6);
                filter: brightness(1);
            }
            50% { 
                box-shadow: 0 0 16px rgba(59, 130, 246, 0.9);
                filter: brightness(1.2);
            }
        }

        .status-bar-fill.health.critical {
            animation: bar-pulse-red 1.5s ease-in-out infinite;
        }

        .status-bar-fill.moral.critical {
            animation: bar-pulse-blue 1.5s ease-in-out infinite;
        }

        .status-info-box {
            margin-top: var(--gap-md);
            padding-top: var(--gap-md);
            border-top: 1px solid var(--border-subtle);
            display: flex;
            flex-direction: column;
            gap: var(--gap-xs);
        }

        .status-info-item {
            display: flex;
            align-items: center;
            gap: var(--gap-sm);
        }

        .status-info-row {
            display: flex;
            align-items: center;
            gap: var(--gap-sm);
        }

        .status-info-icon {
            font-size: 6px;
            flex-shrink: 0;
        }

        .status-info-text {
            font-size: 9px;
            color: var(--text-muted);
            line-height: 1.4;
        }

        .status-extras {
            display: none;
        }

        /* Dice / Second Chance */
        .dice-section {
            background: var(--bg-elevated);
            border-radius: var(--radius-md);
            padding: var(--gap-md);
        }

        .dice-section-title {
            font-size: 10px;
            font-weight: 500;
            text-transform: uppercase;
            color: var(--text-muted);
            margin-bottom: var(--gap-sm);
        }

        .dice-row {
            display: flex;
            gap: var(--gap-sm);
        }

        .dice-row-large {
            display: flex;
            gap: var(--gap-md);
            justify-content: center;
            padding: var(--gap-sm) 0;
        }

        .dice-check {
            width: 36px;
            height: 36px;
            background: var(--bg-card);
            border: 1px solid var(--border-default);
            border-radius: var(--radius-sm);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.15s;
        }

        .dice-check-large {
            width: 64px;
            height: 64px;
            background: var(--bg-elevated);
            border: 2px solid var(--border-default);
            border-radius: var(--radius-md);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .dice-check:hover, .dice-check-large:hover {
            border-color: var(--accent-primary);
            transform: scale(1.05);
        }

        .dice-check-large:not(.used):active {
            transform: scale(0.95);
        }

        /* Dissolve animation keyframes */
        @keyframes dice-dissolve {
            0% {
                opacity: 1;
                transform: scale(1);
                filter: blur(0) saturate(1);
            }
            30% {
                opacity: 0.8;
                transform: scale(1.1);
                filter: blur(1px) saturate(0.5);
            }
            60% {
                opacity: 0.4;
                transform: scale(0.9);
                filter: blur(3px) saturate(0.2);
            }
            100% {
                opacity: 0.3;
                transform: scale(1);
                filter: blur(0) saturate(0.3);
            }
        }

        @keyframes dice-particles {
            0% {
                box-shadow: 
                    0 0 0 rgba(239, 68, 68, 0),
                    inset 0 0 0 rgba(239, 68, 68, 0);
            }
            50% {
                box-shadow: 
                    0 0 20px rgba(239, 68, 68, 0.6),
                    inset 0 0 15px rgba(239, 68, 68, 0.4);
            }
            100% {
                box-shadow: 
                    0 0 5px rgba(239, 68, 68, 0.2),
                    inset 0 0 5px rgba(239, 68, 68, 0.1);
            }
        }

        .dice-check-large.dissolving {
            animation: dice-dissolve 0.8s ease-out forwards, dice-particles 0.8s ease-out forwards;
            pointer-events: none;
        }

        /* Restore animation for GM reset */
        @keyframes dice-restore {
            0% {
                opacity: 0.35;
                transform: scale(0.9);
                filter: blur(2px);
                box-shadow: 0 0 20px rgba(139, 92, 246, 0);
            }
            50% {
                opacity: 0.7;
                transform: scale(1.1);
                filter: blur(0);
                box-shadow: 0 0 25px rgba(139, 92, 246, 0.8);
            }
            100% {
                opacity: 1;
                transform: scale(1);
                filter: blur(0);
                box-shadow: 0 0 0 rgba(139, 92, 246, 0);
            }
        }

        .dice-check-large.restoring {
            animation: dice-restore 0.4s ease-out forwards;
            pointer-events: none;
        }

        .dice-check.used, .dice-check-large.used {
            background: rgba(239, 68, 68, 0.15);
            border-color: rgba(239, 68, 68, 0.4);
            opacity: 0.35;
            cursor: not-allowed;
        }

        .dice-check-large.used svg {
            fill: rgba(239, 68, 68, 0.5);
        }

        .dice-check svg {
            width: 20px;
            height: 20px;
            fill: var(--text-secondary);
        }

        .dice-check-large svg {
            width: 42px;
            height: 42px;
            fill: var(--text-secondary);
            transition: fill 0.3s ease;
        }

        /* Currency - inline in inventory */
        .currency-row-inline {
            display: flex;
            align-items: center;
            gap: var(--gap-sm);
            padding: var(--gap-sm) var(--gap-md);
            background: var(--bg-elevated);
            border-radius: var(--radius-md);
            margin-bottom: var(--gap-md);
        }

        .currency-label {
            font-size: 10px;
            font-weight: 500;
            text-transform: uppercase;
            color: var(--text-muted);
            min-width: 55px;
        }

        .currency-icon {
            width: 24px;
            height: 24px;
            cursor: pointer;
            transition: opacity 0.15s, filter 0.15s;
            filter: brightness(0) saturate(100%) invert(58%) sepia(6%) saturate(70%) hue-rotate(202deg);
        }

        .currency-icon:hover {
            filter: none;
        }

        .weapon-icon {
            width: 24px;
            height: 24px;
            font-size: 24px;
            color: #868688;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .currency-input-inline {
            flex: 1;
            max-width: 120px;
            background: var(--bg-card);
            border: 1px solid var(--border-subtle);
            border-radius: var(--radius-sm);
            padding: 6px var(--gap-sm);
            font-size: 14px;
            font-weight: 600;
            color: var(--accent-gold);
            outline: none;
            -moz-appearance: textfield;
        }

        .currency-input-inline::-webkit-outer-spin-button,
        .currency-input-inline::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }

        .weapon-input {
            max-width: none;
            flex: 1;
            color: var(--text-primary);
            font-weight: 500;
        }

        /* Text areas row */
        .text-areas-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: var(--gap-md);
        }

        /* Currency Section - old styles kept for compatibility */
        .currency-section {
            background: var(--bg-elevated);
            border-radius: var(--radius-md);
            padding: var(--gap-md);
        }

        .currency-row {
            display: flex;
            align-items: center;
            gap: var(--gap-sm);
        }

        .currency-input {
            flex: 1;
            background: var(--bg-card);
            border: 1px solid var(--border-subtle);
            border-radius: var(--radius-sm);
            padding: 6px var(--gap-sm);
            font-size: 14px;
            font-weight: 600;
            color: var(--accent-gold);
            outline: none;
        }

        /* ===== FOKUS CARD ===== */

        .fokus-layout {
            display: flex;
            flex-direction: column;
            gap: var(--gap-md);
            position: relative;
            overflow: hidden;
            padding-top: 80px;
            margin-top: -80px;
        }

        .fokus-header {
            display: flex;
            align-items: flex-start;
            gap: var(--gap-md);
            cursor: pointer;
            padding: var(--gap-sm);
            padding-left: 0;
            border-radius: var(--radius-md);
            transition: background 0.15s;
            position: relative;
            z-index: 2;
        }

        .fokus-header:hover {
            background: var(--bg-elevated);
        }

        .fokus-icon {
            width: 56px;
            height: 56px;
            border-radius: var(--radius-md);
            background: var(--bg-elevated);
            display: flex;
            align-items: center;
            justify-content: center;
            border: 2px solid var(--border-default);
            flex-shrink: 0;
            transition: all 0.3s;
            margin-top: 2px;
            position: relative;
        }

        .fokus-icon img {
            width: 36px;
            height: 36px;
        }

        .fokus-particles {
            position: absolute;
            top: 0;
            left: 8px;
            width: 56px;
            height: 80px;
            pointer-events: none;
            z-index: 1;
        }

        .fokus-particle {
            position: absolute;
            bottom: 0;
            width: 4px;
            height: 4px;
            border-radius: 50%;
            opacity: 0;
            animation: particle-float 4s infinite ease-out;
        }

        .fokus-particle:nth-child(1) { left: 10%; animation-delay: 0s; }
        .fokus-particle:nth-child(2) { left: 30%; animation-delay: 0.6s; }
        .fokus-particle:nth-child(3) { left: 50%; animation-delay: 1.2s; }
        .fokus-particle:nth-child(4) { left: 70%; animation-delay: 1.8s; }
        .fokus-particle:nth-child(5) { left: 90%; animation-delay: 2.4s; }
        .fokus-particle:nth-child(6) { left: 20%; animation-delay: 3s; }
        .fokus-particle:nth-child(7) { left: 60%; animation-delay: 3.3s; }
        .fokus-particle:nth-child(8) { left: 40%; animation-delay: 0.3s; }

        @keyframes particle-float {
            0% {
                opacity: 0;
                transform: translateY(0) scale(1);
            }
            10% {
                opacity: 0.9;
            }
            100% {
                opacity: 0;
                transform: translateY(-70px) scale(0.3);
            }
        }

        .fokus-info {
            flex: 1;
        }

        .fokus-name {
            font-size: 18px;
            font-weight: 600;
            color: var(--text-primary);
        }

        .fokus-attr {
            font-size: 12px;
            color: var(--accent-primary);
            margin-top: 2px;
        }

        .fokus-dice {
            text-align: right;
        }

        .fokus-dice-label {
            font-size: 9px;
            color: var(--text-muted);
            text-transform: uppercase;
        }

        .fokus-dice-value {
            font-size: 18px;
            font-weight: 700;
            color: var(--accent-primary);
        }

        .fokus-abilities {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: var(--gap-sm);
        }

        .fokus-ability {
            background: var(--bg-elevated);
            border-radius: var(--radius-md);
            padding: var(--gap-md);
            border: 1px solid var(--border-subtle);
            cursor: pointer;
            transition: all 0.15s;
        }

        .fokus-ability:hover {
            border-color: var(--accent-primary);
        }

        .fokus-ability.empty {
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 70px;
        }

        .fokus-ability.empty span {
            color: var(--text-muted);
            font-size: 12px;
        }

        .fokus-ability.no-fokus-message {
            grid-column: 1 / -1;
            background: var(--bg-input);
            text-align: center;
            padding: var(--gap-lg);
        }

        .no-fokus-text {
            color: var(--text-muted);
            font-size: 13px;
            font-style: italic;
        }

        .fokus-ability-type {
            font-size: 9px;
            font-weight: 600;
            text-transform: uppercase;
            color: var(--accent-primary);
            margin-bottom: 2px;
        }

        .fokus-ability-name {
            font-size: 13px;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 4px;
        }

        .fokus-ability-desc {
            font-size: 11px;
            color: var(--text-secondary);
            line-height: 1.4;
        }

        /* ===== SCHWÄCHE & RAST ===== */
        .schwaeche-rast-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: var(--gap-lg) 40px;
            margin-bottom: var(--gap-lg);
            align-items: stretch;
        }

        .schwaeche-rast-row .card {
            display: flex;
            flex-direction: column;
        }

        .schwaeche-rast-row .card-body {
            flex: 1;
            display: flex;
            flex-direction: column;
        }

        .schwaeche-display {
            cursor: pointer;
            padding: var(--gap-sm);
            border-radius: var(--radius-md);
            transition: background 0.15s;
            flex: 1;
        }

        .schwaeche-display:hover {
            background: var(--bg-elevated);
        }

        .schwaeche-empty {
            color: var(--text-muted);
            font-size: 13px;
            text-align: center;
            padding: var(--gap-md);
            border: 1px dashed var(--border-subtle);
            border-radius: var(--radius-md);
            display: flex;
            align-items: center;
            justify-content: center;
            flex: 1;
        }

        .schwaeche-selected {
            display: flex;
            flex-direction: column;
            gap: var(--gap-xs);
        }

        .schwaeche-name {
            font-size: 15px;
            font-weight: 600;
            color: var(--text-primary);
        }

        .schwaeche-bedeutung {
            font-size: 11px;
            color: var(--text-secondary);
        }

        .schwaeche-wuerfel {
            font-size: 10px;
            color: #f59e0b;
            font-style: italic;
        }

        .schwaeche-trigger {
            font-size: 10px;
            color: var(--text-muted);
        }

        .rast-buttons {
            display: flex;
            gap: var(--gap-md);
            flex: 1;
            align-items: stretch;
        }

        .rast-btn {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: var(--gap-xs);
            padding: var(--gap-md);
            background: var(--bg-elevated);
            border: 1px solid var(--border-subtle);
            border-radius: var(--radius-md);
            cursor: pointer;
            transition: all 0.15s;
        }

        .rast-btn:hover {
            border-color: var(--accent-primary);
            background: var(--accent-primary-dim);
        }

        .rast-btn.lange:hover {
            border-color: #22c55e;
            background: rgba(34, 197, 94, 0.15);
        }

        .rast-btn.kurze:hover {
            border-color: #3b82f6;
            background: rgba(59, 130, 246, 0.15);
        }

        .rast-btn-title {
            font-size: 13px;
            font-weight: 600;
            color: var(--text-primary);
        }

        .rast-btn-info {
            font-size: 10px;
            color: var(--text-muted);
        }

        .rast-btn.lange:hover .rast-btn-info {
            color: #22c55e;
        }

        .rast-btn.kurze:hover .rast-btn-info {
            color: #3b82f6;
        }

        .rast-btn-icon {
            width: 24px;
            height: 24px;
            color: var(--text-secondary);
            transition: color 0.15s, transform 0.3s;
        }

        .rast-btn.lange:hover .rast-btn-icon {
            color: #22c55e;
        }

        .rast-btn.kurze:hover .rast-btn-icon {
            color: #3b82f6;
        }

        /* Rast Animation */
        @keyframes rastSpin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        @keyframes rastPulse {
            0% { box-shadow: 0 0 0 0 var(--rast-color); }
            50% { box-shadow: 0 0 20px 5px var(--rast-color); }
            100% { box-shadow: 0 0 0 0 var(--rast-color); }
        }

        @keyframes rastSuccess {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }

        .rast-btn.animating {
            pointer-events: none;
            animation: rastSuccess 0.8s ease-out, rastPulse 0.8s ease-out;
        }

        .rast-btn.animating.lange {
            --rast-color: rgba(34, 197, 94, 0.5);
            border-color: #22c55e;
            background: rgba(34, 197, 94, 0.15);
        }

        .rast-btn.animating.kurze {
            --rast-color: rgba(59, 130, 246, 0.5);
            border-color: #3b82f6;
            background: rgba(59, 130, 246, 0.15);
        }

        .rast-btn.animating .rast-btn-icon {
            animation: rastSpin 0.8s ease-out;
        }

        .rast-btn.animating.lange .rast-btn-icon {
            color: #22c55e;
        }

        .rast-btn.animating.kurze .rast-btn-icon {
            color: #3b82f6;
        }

        /* Fullscreen Vignette Flash */
        .rast-vignette {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            pointer-events: none;
            z-index: 9999;
            opacity: 0;
            transition: opacity 0.1s;
        }

        .rast-vignette.flash {
            animation: vignetteFlash 0.8s ease-out forwards;
        }

        .rast-vignette.lange {
            background: radial-gradient(ellipse at center, transparent 0%, transparent 40%, rgba(34, 197, 94, 0.4) 100%);
        }

        .rast-vignette.kurze {
            background: radial-gradient(ellipse at center, transparent 0%, transparent 40%, rgba(59, 130, 246, 0.4) 100%);
        }

        @keyframes vignetteFlash {
            0% { opacity: 0; }
            20% { opacity: 1; }
            100% { opacity: 0; }
        }

        /* Schwäche Popup */
        .schwaeche-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: var(--gap-sm);
        }

        .schwaeche-option {
            background: var(--bg-elevated);
            border: 1px solid var(--border-subtle);
            border-radius: var(--radius-md);
            padding: var(--gap-md);
            cursor: pointer;
            transition: all 0.15s;
        }

        .schwaeche-option:hover {
            border-color: #f59e0b;
        }

        .schwaeche-option.selected {
            border-color: #f59e0b;
            background: rgba(245, 158, 11, 0.15);
        }

        .schwaeche-option-name {
            font-size: 13px;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 4px;
        }

        .schwaeche-option-bedeutung {
            font-size: 10px;
            color: var(--text-secondary);
            margin-bottom: 4px;
        }

        .schwaeche-option-wuerfel {
            font-size: 9px;
            color: #f59e0b;
            font-style: italic;
            margin-bottom: 2px;
        }

        .schwaeche-option-trigger {
            font-size: 9px;
            color: var(--text-muted);
        }

        /* Skills */
        .skill-points-badge {
            font-size: 11px;
            font-weight: 600;
            color: var(--color-green);
            padding: 4px 12px;
            background: rgba(34, 197, 94, 0.15);
            border-radius: 20px;
            transition: all 0.2s;
        }

        .skills-tabs {
            display: flex;
            background: var(--bg-dark);
            overflow: hidden;
        }

        .skill-tab {
            flex: 1;
            padding: var(--gap-md);
            background: transparent;
            border: none;
            cursor: pointer;
            text-align: center;
            transition: all 0.15s;
            position: relative;
        }

        .skill-tab::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: transparent;
        }

        .skill-tab:hover {
            background: var(--bg-elevated);
        }

        .skill-tab.active {
            background: var(--bg-card);
        }

        /* Handeln - Rot */
        .skill-tab[data-category="handeln"].active::after {
            background: #dc2626;
        }
        .skill-tab[data-category="handeln"].active .skill-tab-name {
            color: #dc2626;
        }

        /* Wissen - Blau */
        .skill-tab[data-category="wissen"].active::after {
            background: #2563eb;
        }
        .skill-tab[data-category="wissen"].active .skill-tab-name {
            color: #2563eb;
        }

        /* Soziales - Grün */
        .skill-tab[data-category="soziales"].active::after {
            background: #16a34a;
        }
        .skill-tab[data-category="soziales"].active .skill-tab-name {
            color: #16a34a;
        }

        .skill-tab-name {
            font-size: 14px;
            font-weight: 600;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .skill-tab-attrs {
            font-size: 10px;
            color: var(--text-muted);
            margin-top: 2px;
        }

        .skill-panel {
            display: none;
        }

        .skill-panel.active {
            display: block;
        }

        .skills-list-header {
            display: grid;
            grid-template-columns: 24px 1fr 60px 50px 30px;
            gap: var(--gap-sm);
            padding: var(--gap-sm) var(--gap-md);
            font-size: 9px;
            font-weight: 600;
            text-transform: uppercase;
            color: var(--text-muted);
            background: var(--bg-elevated);
        }

        .skill-row {
            display: grid;
            grid-template-columns: 24px 1fr 60px 50px 28px 28px;
            gap: var(--gap-sm);
            padding: var(--gap-sm) var(--gap-md);
            align-items: center;
            border-bottom: 1px solid var(--border-subtle);
        }

        .skill-row:hover {
            background: var(--bg-elevated);
        }

        .skill-roll-btn {
            width: 24px;
            height: 24px;
            background: transparent;
            border: none;
            color: var(--text-muted);
            cursor: pointer;
            border-radius: var(--radius-sm);
            transition: all 0.15s;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0.4;
        }

        .skill-row:hover .skill-roll-btn {
            opacity: 1;
        }

        .skill-roll-btn:hover {
            background: var(--accent-primary-dim);
            color: var(--accent-primary);
        }

        .skill-delete-btn {
            width: 24px;
            height: 24px;
            background: transparent;
            border: none;
            color: var(--text-muted);
            font-size: 18px;
            cursor: pointer;
            border-radius: var(--radius-sm);
            transition: all 0.15s;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .skill-delete-btn:hover {
            background: var(--accent-primary-dim);
            color: var(--accent-primary);
        }

        .skill-prof {
            width: 16px;
            height: 16px;
            border: 2px solid var(--text-muted);
            border-radius: 50%;
            cursor: pointer;
            transition: all 0.15s;
            flex-shrink: 0;
        }

        .skill-prof:hover {
            border-color: var(--text-secondary);
        }

        .skill-prof.active {
            background: var(--accent-primary);
            border-color: var(--accent-primary);
        }

        /* Category-specific colors */
        #panel-handeln .skill-prof.active {
            background: #dc2626;
            border-color: #dc2626;
        }
        #panel-handeln .skill-bonus {
            color: #dc2626;
        }

        #panel-wissen .skill-prof.active {
            background: #2563eb;
            border-color: #2563eb;
        }
        #panel-wissen .skill-bonus {
            color: #2563eb;
        }

        #panel-soziales .skill-prof.active {
            background: #16a34a;
            border-color: #16a34a;
        }
        #panel-soziales .skill-bonus {
            color: #16a34a;
        }

        .skill-name-input {
            background: transparent;
            border: none;
            font-size: 12px;
            color: var(--text-primary);
            outline: none;
        }

        .skill-value-input {
            background: var(--bg-input);
            border: 1px solid var(--border-subtle);
            border-radius: var(--radius-sm);
            padding: 4px;
            font-size: 12px;
            font-weight: 600;
            color: var(--text-primary);
            text-align: center;
            outline: none;
            width: 100%;
        }

        .skill-bonus {
            font-size: 12px;
            font-weight: 600;
            color: var(--accent-primary);
            text-align: center;
        }

        .add-skill-btn {
            flex: 1;
            padding: var(--gap-sm);
            background: transparent;
            border: 1px dashed var(--border-default);
            border-radius: var(--radius-sm);
            color: var(--text-muted);
            font-size: 11px;
            cursor: pointer;
            transition: all 0.15s;
        }

        .add-skill-btn:hover {
            border-color: var(--accent-primary);
            color: var(--accent-primary);
        }

        .skill-btn-row {
            display: flex;
            gap: var(--gap-sm);
            padding: var(--gap-sm) var(--gap-md);
        }

        .catalog-skill-btn {
            padding: var(--gap-sm) var(--gap-md);
            background: var(--bg-elevated);
            border: 1px solid var(--border-subtle);
            border-radius: var(--radius-sm);
            color: var(--text-secondary);
            font-size: 11px;
            cursor: pointer;
            transition: all 0.15s;
            white-space: nowrap;
        }

        .catalog-skill-btn:hover {
            border-color: var(--accent-primary);
            color: var(--accent-primary);
        }

        .skill-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: var(--gap-sm) var(--gap-md);
            background: var(--bg-elevated);
        }

        .skill-footer-label {
            font-size: 10px;
            color: var(--text-muted);
        }

        .skill-footer-value {
            font-size: 16px;
            font-weight: 700;
            color: var(--text-primary);
        }

        .skill-footer-bonus {
            color: var(--accent-primary);
            font-size: 12px;
            font-weight: 600;
        }

        /* Bottom Section - Skills full width, side by side boxes */
        .bottom-section {
            margin-top: var(--gap-lg);
            display: grid;
            grid-template-columns: 1fr;
            gap: var(--gap-lg);
        }

        .bottom-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: var(--gap-lg) 40px;
            position: relative;
        }

        .bottom-row::after {
            content: '';
            position: absolute;
            top: 0;
            left: 50%;
            transform: translateX(-50%);
            width: 2px;
            height: 100%;
            background: rgba(120, 120, 130, 0.6);
            pointer-events: none;
        }

        .bottom-row .card {
            display: flex;
            flex-direction: column;
        }

        .bottom-row .card-body {
            flex: 1;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }

        /* Inventory & Notes */
        .side-card {
            display: flex;
            flex-direction: column;
            gap: var(--gap-md);
        }

        .inventory-textarea, .notes-textarea {
            background: var(--bg-input);
            border: 1px solid var(--border-subtle);
            border-radius: var(--radius-md);
            padding: var(--gap-md);
            font-size: 12px;
            color: var(--text-primary);
            resize: vertical;
            min-height: 80px;
            font-family: inherit;
            outline: none;
        }

        .inventory-textarea:focus, .notes-textarea:focus {
            border-color: var(--border-default);
        }

        /* Dice History */
        .dice-history-list {
            display: flex;
            flex-direction: column;
            gap: 6px;
            max-height: 200px;
            overflow-y: auto;
        }

        .dice-history-empty {
            color: var(--text-muted);
            font-size: 12px;
            text-align: center;
            padding: var(--gap-md);
        }

        .dice-history-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 8px 12px;
            background: var(--bg-elevated);
            border-radius: var(--radius-sm);
            border-left: 3px solid var(--border-subtle);
        }

        .dice-history-item.success {
            border-left-color: var(--color-green);
        }

        .dice-history-item.failure {
            border-left-color: var(--color-red);
        }

        .dice-history-item.critical {
            border-left-color: #fbbf24;
        }

        .dice-history-label {
            flex: 1;
            font-size: 12px;
            color: var(--text-primary);
            font-weight: 500;
        }

        .dice-history-result {
            font-family: 'Dharma Gothic', sans-serif;
            font-size: 20px;
            font-weight: 700;
            min-width: 40px;
            text-align: center;
        }

        .dice-history-result.success {
            color: var(--color-green);
        }

        .dice-history-result.failure {
            color: var(--color-red);
        }

        .dice-history-outcome {
            font-size: 10px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            font-weight: 600;
            padding: 2px 6px;
            border-radius: 3px;
        }

        .dice-history-outcome.success {
            background: rgba(34, 197, 94, 0.2);
            color: var(--color-green);
        }

        .dice-history-outcome.failure {
            background: rgba(239, 68, 68, 0.2);
            color: var(--color-red);
        }

        .dice-history-time {
            font-size: 10px;
            color: var(--text-muted);
        }

        .action-buttons {
            display: flex;
            gap: var(--gap-sm);
            margin-top: var(--gap-md);
        }

        .action-btn {
            flex: 1;
            padding: var(--gap-sm);
            background: var(--bg-elevated);
            border: 1px solid var(--border-subtle);
            border-radius: var(--radius-sm);
            color: var(--text-muted);
            font-size: 10px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.15s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 4px;
        }

        .action-btn:hover {
            background: var(--bg-card-hover);
            color: var(--text-secondary);
        }

        .action-btn.danger:hover {
            background: var(--accent-primary-dim);
            border-color: var(--accent-primary);
            color: var(--accent-primary);
        }

        .action-btn.primary {
            background: var(--gold-dim);
            border-color: var(--gold);
            color: var(--gold);
        }

        .action-btn.primary:hover {
            background: var(--gold);
            color: var(--bg-primary);
        }

        .action-btn.primary.active {
            background: var(--gold);
            color: var(--bg-primary);
            cursor: default;
        }

        .action-btn svg {
            width: 12px;
            height: 12px;
        }

        /* Skills */
        .popup-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.85);
            backdrop-filter: blur(8px);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: all 0.25s ease;
        }

        .popup-overlay.active {
            opacity: 1;
            visibility: visible;
        }

        .popup {
            background: var(--bg-card);
            border-radius: var(--radius-lg);
            border: 1px solid var(--accent-primary);
            width: 90%;
            max-width: 650px;
            max-height: 85vh;
            display: flex;
            flex-direction: column;
            transform: scale(0.95);
            transition: transform 0.25s ease;
        }

        .popup.popup-wide {
            max-width: 800px;
        }

        .popup-overlay.active .popup {
            transform: scale(1);
        }

        .catalog-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: var(--gap-xs);
        }

        .catalog-item {
            background: var(--bg-elevated);
            border: 1px solid var(--border-subtle);
            border-radius: var(--radius-sm);
            padding: var(--gap-sm);
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: var(--gap-xs);
        }

        .catalog-item.added {
            border-color: var(--color-green);
            background: rgba(34, 197, 94, 0.1);
        }

        .catalog-item-name {
            font-size: 11px;
            font-weight: 500;
            color: var(--text-primary);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .catalog-item-btn {
            padding: 3px 6px;
            border-radius: var(--radius-sm);
            border: none;
            font-size: 9px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.15s;
            flex-shrink: 0;
        }

        .catalog-item-btn.add {
            background: var(--color-green);
            color: white;
        }

        .catalog-item-btn.add:hover {
            background: #16a34a;
        }

        .catalog-item-btn.remove {
            background: var(--accent-primary);
            color: white;
        }

        .catalog-item-btn.remove:hover {
            background: #b91c1c;
        }

        @media (max-width: 700px) {
            .catalog-grid {
                grid-template-columns: repeat(3, 1fr);
            }
        }

        @media (max-width: 500px) {
            .catalog-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        .popup-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: var(--gap-lg);
            border-bottom: 1px solid var(--border-subtle);
        }

        .popup-title {
            font-size: 16px;
            font-weight: 600;
            color: var(--text-primary);
        }

        .popup-close {
            width: 32px;
            height: 32px;
            border: none;
            background: var(--bg-elevated);
            border-radius: var(--radius-sm);
            color: var(--text-secondary);
            font-size: 18px;
            cursor: pointer;
        }

        .popup-close:hover {
            background: var(--accent-primary);
            color: white;
        }

        .popup-body {
            flex: 1;
            overflow-y: auto;
            padding: var(--gap-lg);
        }

        .popup-footer {
            padding: var(--gap-lg);
            border-top: 1px solid var(--border-subtle);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .fokus-type-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: var(--gap-sm);
            margin-bottom: var(--gap-lg);
        }

        .fokus-type-btn {
            aspect-ratio: 1;
            background: var(--bg-elevated);
            border: 2px solid var(--border-subtle);
            border-radius: var(--radius-md);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: var(--gap-xs);
            cursor: pointer;
            transition: all 0.15s;
        }

        .fokus-type-btn:hover {
            border-color: var(--text-secondary);
        }

        .fokus-type-btn.active {
            /* Colors set via inline styles for element-specific colors */
        }

        .fokus-type-btn img {
            width: 36px;
            height: 36px;
        }

        .fokus-type-btn span {
            font-size: 9px;
            color: var(--text-secondary);
            text-transform: uppercase;
        }

        .fokus-type-btn.active span {
            /* Color set via inline styles for element-specific colors */
        }

        .fokus-section-title {
            font-size: 11px;
            font-weight: 600;
            color: var(--accent-primary);
            margin: var(--gap-md) 0 var(--gap-sm);
            text-transform: uppercase;
        }

        .fokus-ability-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: var(--gap-xs);
            margin-bottom: var(--gap-md);
        }

        .fokus-ability-option {
            background: var(--bg-elevated);
            border: 1px solid var(--border-subtle);
            border-radius: var(--radius-sm);
            padding: var(--gap-sm);
            cursor: pointer;
            transition: all 0.15s;
        }

        .fokus-ability-option:hover:not(.disabled) {
            border-color: var(--text-secondary);
        }

        .fokus-ability-option.selected {
            /* Colors set via inline styles for element-specific colors */
        }

        .fokus-ability-option.disabled {
            opacity: 0.4;
            cursor: not-allowed;
        }

        .fokus-ability-option-name {
            font-size: 12px;
            font-weight: 600;
            margin-bottom: 2px;
        }

        .fokus-ability-option-desc {
            font-size: 10px;
            color: var(--text-secondary);
            line-height: 1.3;
        }

        .fokus-section-title {
            font-size: 12px;
            font-weight: 600;
            color: var(--text-secondary);
            margin-bottom: var(--gap-sm);
            margin-top: var(--gap-sm);
        }

        .fokus-attr-info + .fokus-section-title {
            margin-top: 0;
        }

        .fokus-attr-info {
            font-size: 12px;
            color: var(--text-muted);
            text-align: center;
            padding: var(--gap-sm) var(--gap-md);
            background: var(--bg-elevated);
            border-radius: var(--radius-sm);
            margin-bottom: var(--gap-md);
        }

        .fokus-attr-info strong {
            color: var(--accent-primary);
        }

        .popup-btn {
            padding: 10px 20px;
            border: none;
            border-radius: var(--radius-md);
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
        }

        .popup-btn-primary {
            background: var(--accent-primary);
            color: white;
        }

        .popup-btn-primary:hover:not(:disabled) {
            background: var(--accent-primary-light);
        }

        .popup-btn-primary:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .popup-info {
            font-size: 12px;
            color: var(--text-muted);
        }

        /* Save Indicator */
        .save-indicator {
            position: fixed;
            bottom: 24px;
            right: 24px;
            background: var(--bg-elevated);
            color: var(--text-primary);
            padding: 8px 14px;
            border-radius: var(--radius-md);
            font-size: 12px;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 6px;
            opacity: 0;
            transform: translateY(8px) scale(0.95);
            transition: all 0.25s ease;
            pointer-events: none;
            z-index: 1000;
            border: 1px solid var(--border-subtle);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        }

        .save-indicator.show {
            opacity: 1;
            transform: translateY(0) scale(1);
        }

        .save-indicator svg {
            width: 14px;
            height: 14px;
            color: var(--accent-primary);
        }

        .hidden-input {
            display: none;
        }

        /* ===== RESPONSIVE ===== */
        @media (max-width: 1100px) {
            .main-grid {
                grid-template-columns: 1fr;
            }
            
            .schwaeche-rast-row {
                grid-template-columns: 1fr;
            }
            
            .bottom-row {
                grid-template-columns: 1fr;
            }
            
            /* Hide vertical dividers on single column */
            .grid-section::before,
            .grid-section::after,
            .bottom-row::after {
                display: none;
            }
        }

        @media (max-width: 900px) {
            body {
                padding-top: 56px;
            }
            
            .character-layout {
                grid-template-columns: 1fr;
            }
            
            .character-visual {
                flex-direction: row;
                justify-content: center;
            }
            
            .text-areas-row {
                grid-template-columns: 1fr;
            }
        }

        @media (max-width: 650px) {
            .attributes-top-row,
            .attributes-bottom-row {
                gap: var(--gap-sm);
            }
            
            .attribute-item {
                padding: 0;
            }
            
            .attribute-box {
                width: 70px;
                min-width: 70px;
                max-width: 70px;
                padding: var(--gap-md) var(--gap-md);
            }
            
            .attribute-modifier {
                font-size: 20px;
            }
            
            .fokus-abilities {
                grid-template-columns: 1fr;
            }
            
            .character-fields {
                grid-template-columns: 1fr;
            }
            
            .dice-row-large {
                gap: var(--gap-sm);
            }
            
            .dice-check-large {
                width: 56px;
                height: 56px;
            }
            
            .dice-check-large svg {
                width: 36px;
                height: 36px;
            }
        }

        /* ===== GM PLAYER SWITCHER BAR ===== */
        .gm-player-bar {
            display: none;
            align-items: center;
            gap: var(--gap-md);
            padding: 10px var(--gap-lg);
            background: var(--bg-elevated);
            border-radius: var(--radius-lg);
            margin-bottom: var(--gap-md);
        }

        .gm-player-bar.visible {
            display: flex;
        }

        .gm-player-bar-label {
            font-size: 13px;
            color: var(--text-secondary);
            font-weight: 500;
            white-space: nowrap;
        }

        .gm-player-list {
            display: flex;
            gap: var(--gap-sm);
            flex-wrap: wrap;
        }

        .gm-player-btn {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 6px 12px;
            background: var(--bg-card);
            border: 1px solid var(--border-subtle);
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.15s ease;
            font-size: 13px;
            color: var(--text-primary);
            font-weight: 500;
        }

        .gm-player-btn:hover {
            background: var(--bg-card-hover);
            border-color: var(--border-default);
        }

        .gm-player-btn.active {
            background: var(--accent-primary-dim);
            border-color: var(--accent-primary);
            color: var(--accent-primary);
        }

        .gm-player-btn .player-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            flex-shrink: 0;
        }

        .gm-player-btn .own-char-badge {
            font-size: 10px;
            opacity: 0.7;
            margin-left: 2px;
        }

        .gm-viewing-badge {
            display: none;
            align-items: center;
            gap: 6px;
            margin-left: auto;
            padding: 6px 12px;
            background: rgba(251, 191, 36, 0.15);
            border: 1px solid rgba(251, 191, 36, 0.3);
            border-radius: 20px;
            font-size: 12px;
            color: #fbbf24;
            font-weight: 500;
        }

        .gm-viewing-badge.visible {
            display: flex;
        }

        .gm-viewing-badge svg {
            width: 14px;
            height: 14px;
            fill: currentColor;
        }

        /* ===== ADVENTURE BAR ===== */
        .adventure-bar {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: var(--gap-lg);
            padding: 12px var(--gap-lg);
            background: var(--bg-elevated);
            border-radius: var(--radius-lg);
            margin-bottom: var(--gap-lg);
            position: relative;
        }

        .adventure-bar-label {
            font-size: 13px;
            color: var(--text-secondary);
            font-weight: 500;
            white-space: nowrap;
            margin-right: auto;
            padding-left: var(--gap-sm);
        }

        .adventure-bar-icon {
            position: absolute;
            left: 50%;
            top: 50%;
            transform: translate(-50%, -50%);
            width: 36px;
            height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
            text-decoration: none;
            transition: all 0.2s ease;
            border-radius: var(--radius-sm);
            padding: 6px;
        }

        .adventure-bar-icon:hover {
            background: var(--bg-card-hover);
        }

        .adventure-bar-icon img {
            width: 100%;
            height: 100%;
            object-fit: contain;
            filter: brightness(0) invert(1);
            transition: filter 0.2s ease;
        }

        .adventure-bar-icon:hover img {
            filter: invert(48%) sepia(79%) saturate(1000%) hue-rotate(332deg) brightness(90%) contrast(95%);
        }

        .adventure-name-input {
            background: transparent;
            border: none;
            border-bottom: 1px solid transparent;
            color: var(--text-primary);
            font-size: 15px;
            font-weight: 600;
            padding: 4px 8px;
            min-width: 180px;
            max-width: 300px;
            text-align: left;
            margin-left: auto;
            padding-right: var(--gap-sm);
            transition: border-color 0.15s ease;
        }

        .adventure-name-input:hover {
            border-bottom-color: var(--border-default);
        }

        .adventure-name-input:focus {
            outline: none;
            border-bottom-color: var(--border-default);
        }

        .adventure-name-input::placeholder {
            color: var(--text-muted);
            font-weight: 400;
        }

        /* Read-only mode indicator */
        .sheet-readonly-overlay {
            display: none;
            position: fixed;
            top: 70px;
            left: 50%;
            transform: translateX(-50%);
            padding: 8px 16px;
            background: rgba(251, 191, 36, 0.9);
            color: #000;
            font-size: 13px;
            font-weight: 600;
            border-radius: 20px;
            z-index: 1000;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        }

        .sheet-readonly-overlay.visible {
            display: block;
        }

        @media (max-width: 768px) {
            .gm-player-bar {
                flex-direction: column;
                align-items: flex-start;
            }

            .gm-viewing-badge {
                margin-left: 0;
                margin-top: var(--gap-sm);
            }

            .adventure-bar {
                flex-wrap: wrap;
            }

            .adventure-name-input {
                min-width: 120px;
            }
        }

        /* ═══════════════════════════════════════════════════════════════
           ANIMATIONS & MICRO-INTERACTIONS
           ═══════════════════════════════════════════════════════════════ */

        /* === KEYFRAMES === */
        @keyframes fadeSlideIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes pulseGlow {
            0%, 100% {
                box-shadow: 0 0 5px currentColor;
            }
            50% {
                box-shadow: 0 0 20px currentColor, 0 0 30px currentColor;
            }
        }

        @keyframes criticalPulse {
            0%, 100% {
                opacity: 1;
            }
            50% {
                opacity: 0.6;
            }
        }

        @keyframes diceWobble {
            0%, 100% {
                transform: rotate(0deg) scale(1);
            }
            25% {
                transform: rotate(-8deg) scale(1.1);
            }
            75% {
                transform: rotate(8deg) scale(1.1);
            }
        }

        @keyframes diceClick {
            0% {
                transform: scale(1);
            }
            50% {
                transform: scale(0.85);
            }
            100% {
                transform: scale(1);
            }
        }

        @keyframes checkToggle {
            0% {
                transform: scale(1);
            }
            30% {
                transform: scale(0.8);
            }
            60% {
                transform: scale(1.15);
            }
            100% {
                transform: scale(1);
            }
        }

        @keyframes levelPulse {
            0%, 100% {
                box-shadow: 0 0 0 0 var(--accent-primary-glow);
            }
            50% {
                box-shadow: 0 0 0 8px transparent;
            }
        }

        @keyframes saveFlash {
            0% {
                opacity: 0;
                transform: translateY(10px);
            }
            20% {
                opacity: 1;
                transform: translateY(0);
            }
            80% {
                opacity: 1;
                transform: translateY(0);
            }
            100% {
                opacity: 0;
                transform: translateY(-10px);
            }
        }

        @keyframes valueFlash {
            0%, 100% {
                background: transparent;
            }
            50% {
                background: var(--accent-primary-dim);
            }
        }

        @keyframes barShimmer {
            0% {
                background-position: -200% center;
            }
            100% {
                background-position: 200% center;
            }
        }

        @keyframes slideInLeft {
            from {
                opacity: 0;
                transform: translateX(-10px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        /* === STAGGERED CARD ENTRANCE === */
        .card {
            opacity: 0;
            animation: fadeSlideIn 0.5s ease forwards;
        }

        .main-grid .card:nth-child(1) { animation-delay: 0.05s; }
        .main-grid .card:nth-child(2) { animation-delay: 0.1s; }
        .main-grid .card:nth-child(3) { animation-delay: 0.15s; }
        .main-grid .card:nth-child(4) { animation-delay: 0.2s; }

        .bottom-row .card:nth-child(1) { animation-delay: 0.25s; }
        .bottom-row .card:nth-child(2) { animation-delay: 0.3s; }
        .bottom-row .card:nth-child(3) { animation-delay: 0.35s; }

        /* === CARD HOVER STATES === */
        .card {
            transition: transform 0.25s ease, box-shadow 0.25s ease, border-color 0.25s ease;
        }

        .card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 30px rgba(0, 0, 0, 0.3);
            border-color: var(--border-default);
        }

        /* === WÜRFEL-BUTTONS === */
        .dice-btn,
        .roll-btn,
        [class*="dice"],
        button[onclick*="roll"],
        .skill-roll-btn {
            transition: all 0.2s ease;
            position: relative;
        }

        .dice-btn:hover,
        .roll-btn:hover,
        .skill-roll-btn:hover {
            animation: diceWobble 0.5s ease;
        }

        .dice-btn:active,
        .roll-btn:active,
        .skill-roll-btn:active {
            animation: diceClick 0.15s ease;
        }

        /* === STATUS BARS === */
        .stat-bar,
        .status-bar,
        .progress-bar,
        [class*="health"],
        [class*="moral"],
        [class*="resonanz"] {
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .stat-bar-fill,
        .status-fill,
        .bar-fill {
            transition: width 0.5s cubic-bezier(0.4, 0, 0.2, 1), background 0.3s ease;
            background-size: 200% 100%;
            position: relative;
        }

        /* Critical State - Pulsing */
        .stat-bar-fill.critical,
        .status-bar.critical .bar-fill {
            animation: criticalPulse 1s ease-in-out infinite;
        }

        .stat-bar.critical,
        .status-bar.critical {
            box-shadow: 0 0 10px rgba(239, 68, 68, 0.5);
        }

        /* === SKILL ROWS === */
        .skill-row,
        .skill-item,
        [class*="skill-entry"] {
            position: relative;
            transition: all 0.2s ease;
        }

        .skill-row::before,
        .skill-item::before {
            content: '';
            position: absolute;
            left: 0;
            top: 0;
            height: 100%;
            width: 3px;
            background: var(--accent-primary);
            transform: scaleY(0);
            transition: transform 0.2s ease;
            border-radius: 0 2px 2px 0;
        }

        .skill-row:hover,
        .skill-item:hover {
            background: rgba(255, 70, 85, 0.05);
            padding-left: calc(var(--gap-md) + 5px);
        }

        .skill-row:hover::before,
        .skill-item:hover::before {
            transform: scaleY(1);
        }

        .skill-row .roll-btn,
        .skill-row .dice-btn,
        .skill-roll-btn {
            opacity: 0.5;
            transform: scale(0.9);
            transition: all 0.2s ease;
        }

        .skill-row:hover .roll-btn,
        .skill-row:hover .dice-btn,
        .skill-row:hover .skill-roll-btn {
            opacity: 1;
            transform: scale(1);
        }

        /* === ATTRIBUTE INPUTS === */
        .attr-input,
        .attribute-value,
        [class*="attr"] input[type="number"] {
            transition: all 0.2s ease;
            position: relative;
        }

        .attr-input:focus,
        .attribute-value:focus,
        [class*="attr"] input[type="number"]:focus {
            outline: none;
            border-color: var(--border-default);
        }

        .attr-input.value-changed,
        .attribute-value.value-changed {
            animation: valueFlash 0.4s ease;
        }

        /* === PORTRAIT === */
        .portrait,
        #portrait-box {
            position: relative;
            overflow: hidden;
            transition: all 0.3s ease;
        }

        .portrait-container {
            overflow: visible !important;
        }

        .portrait img,
        #portrait-img {
            transition: transform 0.4s ease;
        }

        .portrait:hover img,
        #portrait-box:hover #portrait-img {
            transform: scale(1.08);
        }

        /* Portrait Health Vignette */

        /* === ZWEITE CHANCE CHECKBOXES === */
        .chance-checkbox,
        .zweite-chance-btn,
        [class*="chance"] input[type="checkbox"] + label,
        [class*="chance"] .checkbox {
            transition: all 0.2s ease;
            cursor: pointer;
        }

        .chance-checkbox:hover,
        .zweite-chance-btn:hover {
            transform: scale(1.1);
        }

        .chance-checkbox.checked,
        .zweite-chance-btn.used {
            animation: checkToggle 0.3s ease;
        }

        .chance-checkbox.toggle-animation {
            animation: checkToggle 0.3s ease;
        }

        /* === SAVE INDICATOR === */
        /* === GENERAL INPUT FOCUS === */
        input, textarea, select {
            transition: border-color 0.2s ease, box-shadow 0.2s ease, background 0.2s ease;
        }

        input:focus, textarea:focus, select:focus {
            border-color: var(--border-default) !important;
            outline: none;
        }

        /* === BUTTON HOVER POLISH === */
        button, .btn {
            transition: all 0.2s ease;
        }

        button:hover:not(:disabled), .btn:hover:not(:disabled) {
            transform: translateY(-1px);
        }

        button:active:not(:disabled), .btn:active:not(:disabled) {
            transform: translateY(0) scale(0.98);
        }

        /* === REDUCED MOTION === */
        @media (prefers-reduced-motion: reduce) {
            *, *::before, *::after {
                animation-duration: 0.01ms !important;
                animation-iteration-count: 1 !important;
                transition-duration: 0.01ms !important;
            }
        }

        /* ===== PRINT STYLESHEET (A4) ===== */
        @media print {
            @page {
                size: A4;
                margin: 10mm;
            }

            /* Reset dark theme to print-friendly */
            *, *::before, *::after {
                background: transparent !important;
                color: #000 !important;
                box-shadow: none !important;
                text-shadow: none !important;
                animation: none !important;
                transition: none !important;
            }

            body {
                background: #fff !important;
                font-size: 10pt !important;
                line-height: 1.3 !important;
            }

            /* Hide non-essential elements */
            .navigation,
            .nav-bar,
            footer,
            .footer,
            .save-indicator,
            .toast-container,
            .popup,
            .modal,
            .btn,
            .icon-btn,
            .dice-btn,
            .img-control-btn,
            .portrait-controls-row,
            .add-skill-btn,
            .skill-delete,
            .hidden-input,
            #portrait-upload,
            #jolly-upload,
            #import-file,
            .status-bar.draggable::after {
                display: none !important;
            }

            /* Main container */
            .main-content {
                padding: 0 !important;
                max-width: 100% !important;
            }

            .sheet-container {
                padding: 0 !important;
                gap: 8pt !important;
            }

            /* Character header */
            .character-header {
                border: 1px solid #ccc !important;
                padding: 8pt !important;
                page-break-inside: avoid;
            }

            .portrait-container {
                width: 80px !important;
                height: 100px !important;
            }

            .portrait-frame {
                border: 1px solid #000 !important;
            }

            .character-name {
                font-size: 16pt !important;
                border-bottom: 1px solid #000 !important;
            }

            /* Attributes */
            .attributes-section {
                page-break-inside: avoid;
            }

            .attribute-box {
                border: 1px solid #000 !important;
                padding: 4pt !important;
                min-width: 60px !important;
                width: 60px !important;
                max-width: 60px !important;
            }

            .attribute-box::before {
                display: none !important;
            }

            .attribute-modifier {
                font-size: 14pt !important;
            }

            .attribute-name {
                font-size: 8pt !important;
            }

            .attribute-abbr {
                font-size: 7pt !important;
                color: #666 !important;
            }

            /* Status bars */
            .status-bars {
                page-break-inside: avoid;
            }

            .status-bar {
                border: 1px solid #000 !important;
                height: 12px !important;
            }

            .status-bar-fill {
                background: #333 !important;
                print-color-adjust: exact;
                -webkit-print-color-adjust: exact;
            }

            .status-bar-fill.health {
                background: #22c55e !important;
            }

            .status-bar-fill.moral {
                background: #3b82f6 !important;
            }

            .status-bar-fill.resonanz {
                background: #8b5cf6 !important;
            }

            /* Skills */
            .skills-grid {
                gap: 8pt !important;
            }

            .skill-category {
                border: 1px solid #ccc !important;
                padding: 6pt !important;
                page-break-inside: avoid;
            }

            .skill-row {
                border-bottom: 1px dotted #ccc !important;
                padding: 2pt 0 !important;
            }

            .skill-name-input,
            .skill-value-input {
                border: none !important;
                background: transparent !important;
                font-size: 9pt !important;
            }

            /* Fokus section */
            .fokus-card {
                border: 1px solid #000 !important;
                padding: 8pt !important;
                page-break-inside: avoid;
            }

            .fokus-element-icon {
                filter: none !important;
                width: 40px !important;
                height: 40px !important;
            }

            .fokus-abilities {
                border: 1px solid #ccc !important;
            }

            /* Inventory & Notes */
            .inventory-section,
            .notes-section {
                page-break-inside: avoid;
            }

            textarea {
                border: 1px solid #ccc !important;
                min-height: 60px !important;
            }

            /* Section headers */
            .section-header,
            .category-header {
                border-bottom: 1px solid #000 !important;
                font-size: 11pt !important;
                font-weight: bold !important;
            }

            /* Page breaks */
            .fokus-card {
                page-break-before: auto;
            }

            .notes-section {
                page-break-before: auto;
            }

            /* Print header */
            .sheet-container::before {
                content: "Worlds Apart - Charakterbogen";
                display: block;
                text-align: center;
                font-size: 8pt;
                color: #999 !important;
                margin-bottom: 8pt;
                border-bottom: 1px solid #ccc;
                padding-bottom: 4pt;
            }
        }
    </style>
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    
    <!-- RIFT Services -->
    <script src="assets/js/firebase-config.js"></script>
    <script>
        // Auth Guard - redirect to login if not authenticated
        (function() {
            function waitForAuth() {
                if (typeof firebase === 'undefined' || !firebase.auth) {
                    return setTimeout(waitForAuth, 50);
                }
                firebase.auth().onAuthStateChanged(function(user) {
                    if (!user) {
                        window.location.href = 'login.html';
                    } else {
                        document.body.classList.add('auth-ready');
                    }
                });
            }
            waitForAuth();
        })();
    </script>

    <script src="assets/js/room-service.js"></script>
    <script src="assets/js/user-service.js"></script>
    
    <script src="assets/js/auth.js"></script>

    <!-- Auth Guard: Hide until authenticated -->
    <style>
        body:not(.auth-ready) .app { opacity: 0; pointer-events: none; }
        body:not(.auth-ready) .sheet-container { opacity: 0; pointer-events: none; }
        body:not(.auth-ready) main { opacity: 0; pointer-events: none; }
        body.auth-ready .app { opacity: 1; transition: opacity 0.15s ease; }
        body.auth-ready .sheet-container { opacity: 1; transition: opacity 0.15s ease; }
        body.auth-ready main { opacity: 1; transition: opacity 0.15s ease; }
    </style>
</head>
<body>
    <div class="app">
        <main class="main">
            <div class="main__content">
                
                <!-- Page Header with Back Button -->
                <div class="page-header">
                    <div class="page-header__icon">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                            <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-1 17.93c-3.95-.49-7-3.85-7-7.93 0-.62.08-1.21.21-1.79L9 15v1c0 1.1.9 2 2 2v1.93zm6.9-2.54c-.26-.81-1-1.39-1.9-1.39h-1v-3c0-.55-.45-1-1-1H8v-2h2c.55 0 1-.45 1-1V7h2c1.1 0 2-.9 2-2v-.41c2.93 1.19 5 4.06 5 7.41 0 2.08-.8 3.97-2.1 5.39z"/>
                        </svg>
                    </div>
                    <div class="page-header__divider"></div>
                    <h1 class="page-header__title">Charakterbogen</h1>
                    <span class="page-header__tagline">Worlds Apart</span>
                    
                    <a href="sheet.html" id="backToCharSelect" class="wa-back-btn">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M19 12H5M12 19l-7-7 7-7"/>
                        </svg>
                        Charakterauswahl
                    </a>
                    <a href="session.html" id="backToSession" class="wa-back-btn">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M19 12H5M12 19l-7-7 7-7"/>
                        </svg>
                        Session
                    </a>
                </div>

    <!-- Background Image -->
    <div class="bg-container" id="bgContainer"></div>

    <!-- Read-only Mode Overlay -->
    <div class="sheet-readonly-overlay" id="readonlyOverlay">👁 Nur-Lesen-Modus</div>

    <div class="sheet-container">
        <!-- Adventure Bar -->
        <div class="adventure-bar" id="adventureBar">
            <span class="adventure-bar-label">Aktuelles Abenteuer:</span>
            <a href="worldsapart.html" class="adventure-bar-icon" id="adventureIcon" title="Worlds Apart Regelwerk">
                <img src="assets/img/rulesets/ruleset_worldsapart.svg" alt="Worlds Apart">
            </a>
            <input type="text" class="adventure-name-input" id="adventureName" placeholder="Name des Abenteuers...">
        </div>

        <!-- GRID SECTION WITH VERTICAL DIVIDER -->
        <div class="grid-section">
            <!-- 2x2 MAIN GRID -->
            <div class="main-grid">
            <!-- CHARACTER -->
            <div class="card">
                <div class="card-header">
                    <span class="card-title"><span class="card-title-icon">person</span> Charakter</span>
                </div>
                <div class="card-body">
                    <div class="character-layout">
                        <div class="character-visual">
                            <div class="portrait-container">
                                <div class="portrait" id="portrait-box">
                                    <div class="portrait-health-overlay" id="portrait-health-overlay"></div>
                                    <span class="portrait-placeholder" id="portrait-placeholder">Portrait</span>
                                    <img id="portrait-img" style="display: none;">
                                </div>
                                <div class="portrait-controls-row">
                                    <button class="img-control-btn" onclick="document.getElementById('portrait-upload').click()" title="Bild ändern">
                                        <span class="card-title-icon">edit</span>
                                    </button>
                                    <div class="level-badge" id="level-badge" onclick="openLevelPopup()" title="Level">1</div>
                                    <button class="img-control-btn delete" onclick="removePortrait()" title="Bild löschen">
                                        <span class="card-title-icon">delete</span>
                                    </button>
                                </div>
                            </div>
                            <div class="crew-flag-container">
                                <div class="crew-flag" onclick="document.getElementById('jolly-upload').click()">
                                    <span class="crew-flag-placeholder" id="crew-flag-placeholder">Crew Flagge</span>
                                    <img id="crew-flag-img" style="display: none;">
                                </div>
                                <div class="crew-flag-controls" id="crew-flag-controls">
                                    <button class="img-control-btn small" onclick="document.getElementById('jolly-upload').click()" title="Bild ändern">
                                        <span class="card-title-icon">edit</span>
                                    </button>
                                    <button class="img-control-btn small delete" onclick="removeCrewFlag()" title="Bild löschen">
                                        <span class="card-title-icon">delete</span>
                                    </button>
                                </div>
                            </div>
                        </div>
                        <div class="character-info">
                            <input type="text" class="character-name" id="char-name" placeholder="Charaktername">
                            <div class="character-meta">
                                <div class="character-meta-item">
                                    <select id="char-race">
                                        <option value="">Rasse wählen...</option>
                                        <option value="Mensch">Mensch</option>
                                        <option value="Velaryn">Velaryn</option>
                                        <option value="Brûnk">Brûnk</option>
                                        <option value="Kabat">Kabat</option>
                                    </select>
                                </div>
                                <div class="character-meta-item">
                                    <select id="char-age">
                                        <option value="">Alter...</option>
                                        <option value="15">15 Jahre</option>
                                        <option value="16">16 Jahre</option>
                                        <option value="17">17 Jahre</option>
                                        <option value="18">18 Jahre</option>
                                        <option value="19">19 Jahre</option>
                                        <option value="20">20 Jahre</option>
                                        <option value="21">21 Jahre</option>
                                        <option value="22">22 Jahre</option>
                                        <option value="23">23 Jahre</option>
                                        <option value="24">24 Jahre</option>
                                        <option value="25">25 Jahre</option>
                                        <option value="26">26 Jahre</option>
                                        <option value="27">27 Jahre</option>
                                        <option value="28">28 Jahre</option>
                                        <option value="29">29 Jahre</option>
                                        <option value="30">30 Jahre</option>
                                        <option value="31">31 Jahre</option>
                                        <option value="32">32 Jahre</option>
                                        <option value="33">33 Jahre</option>
                                        <option value="34">34 Jahre</option>
                                        <option value="35">35 Jahre</option>
                                        <option value="36">36 Jahre</option>
                                        <option value="37">37 Jahre</option>
                                        <option value="38">38 Jahre</option>
                                        <option value="39">39 Jahre</option>
                                        <option value="40">40 Jahre</option>
                                        <option value="41">41 Jahre</option>
                                        <option value="42">42 Jahre</option>
                                        <option value="43">43 Jahre</option>
                                        <option value="44">44 Jahre</option>
                                        <option value="45">45 Jahre</option>
                                        <option value="46">46 Jahre</option>
                                        <option value="47">47 Jahre</option>
                                        <option value="48">48 Jahre</option>
                                        <option value="49">49 Jahre</option>
                                        <option value="50">50 Jahre</option>
                                        <option value="51">51 Jahre</option>
                                        <option value="52">52 Jahre</option>
                                        <option value="53">53 Jahre</option>
                                        <option value="54">54 Jahre</option>
                                        <option value="55">55 Jahre</option>
                                        <option value="56">56 Jahre</option>
                                        <option value="57">57 Jahre</option>
                                        <option value="58">58 Jahre</option>
                                        <option value="59">59 Jahre</option>
                                        <option value="60">60 Jahre</option>
                                        <option value="61">61 Jahre</option>
                                        <option value="62">62 Jahre</option>
                                        <option value="63">63 Jahre</option>
                                        <option value="64">64 Jahre</option>
                                        <option value="65">65 Jahre</option>
                                        <option value="66">66 Jahre</option>
                                        <option value="67">67 Jahre</option>
                                        <option value="68">68 Jahre</option>
                                        <option value="69">69 Jahre</option>
                                        <option value="70">70 Jahre</option>
                                        <option value="71">71 Jahre</option>
                                        <option value="72">72 Jahre</option>
                                        <option value="73">73 Jahre</option>
                                        <option value="74">74 Jahre</option>
                                        <option value="75">75 Jahre</option>
                                        <option value="76">76 Jahre</option>
                                        <option value="77">77 Jahre</option>
                                        <option value="78">78 Jahre</option>
                                        <option value="79">79 Jahre</option>
                                        <option value="80">80 Jahre</option>
                                    </select>
                                </div>
                                <div class="character-meta-item">
                                    <select id="char-gender">
                                        <option value="">Geschlecht...</option>
                                        <option value="Männlich">Männlich</option>
                                        <option value="Weiblich">Weiblich</option>
                                        <option value="Divers">Divers</option>
                                        <option value="Irrelevant">Irrelevant</option>
                                    </select>
                                </div>
                            </div>
                            <div class="character-fields">
                                <div class="field-group">
                                    <label class="field-label">Crew</label>
                                    <input type="text" class="field-input" id="char-crew" placeholder="Name der Crew">
                                </div>
                                <div class="field-group">
                                    <label class="field-label">Rolle</label>
                                    <input type="text" class="field-input" id="char-role" placeholder="z.B. Kapitän, Navigator...">
                                </div>
                                <textarea class="field-textarea" id="char-appearance" placeholder="Kurze Charakterbeschreibung..."></textarea>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ATTRIBUTES -->
            <div class="card">
                <div class="card-header">
                    <span class="card-title"><span class="card-title-icon">fitness_center</span> Attribute</span>
                </div>
                <div class="card-body">
                    <div class="attr-points-row">
                        <div class="attr-points-badge" id="attr-points">
                            <span id="attr-points-text">15 / 15 Attributs-Punkte zu verteilen</span>
                        </div>
                    </div>
                    <div class="attributes-top-row">
                        <div class="attribute-item" title="Kraft - Feuer, Blitz">
                            <div class="attribute-box">
                                <div class="attribute-modifier">
                                    <input type="number" id="attr-power" value="0" min="0" max="10" onfocus="this.select()">
                                </div>
                                <div class="attribute-name">Kraft</div>
                            </div>
                            <div class="attribute-base">KRF</div>
                        </div>
                        <div class="attribute-item" title="Geschick - Wasser, Wind">
                            <div class="attribute-box">
                                <div class="attribute-modifier">
                                    <input type="number" id="attr-agility" value="0" min="0" max="10" onfocus="this.select()">
                                </div>
                                <div class="attribute-name">Geschick</div>
                            </div>
                            <div class="attribute-base">GES</div>
                        </div>
                        <div class="attribute-item" title="Zähigkeit - Erde">
                            <div class="attribute-box">
                                <div class="attribute-modifier">
                                    <input type="number" id="attr-endurance" value="0" min="0" max="10" onfocus="this.select()">
                                </div>
                                <div class="attribute-name">Zähigkeit</div>
                            </div>
                            <div class="attribute-base">ZÄH</div>
                        </div>
                    </div>
                    <div class="attributes-bottom-row">
                        <div class="attribute-item" title="Verstand - Raum">
                            <div class="attribute-box">
                                <div class="attribute-modifier">
                                    <input type="number" id="attr-mind" value="0" min="0" max="10" onfocus="this.select()">
                                </div>
                                <div class="attribute-name">Verstand</div>
                            </div>
                            <div class="attribute-base">VER</div>
                        </div>
                        <div class="attribute-item" title="Präsenz - Illusion">
                            <div class="attribute-box">
                                <div class="attribute-modifier">
                                    <input type="number" id="attr-presence" value="0" min="0" max="10" onfocus="this.select()">
                                </div>
                                <div class="attribute-name">Präsenz</div>
                            </div>
                            <div class="attribute-base">PRÄ</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- STATUS -->
            <div class="card">
                <div class="card-header">
                    <span class="card-title"><span class="card-title-icon">favorite</span> Status</span>
                </div>
                <div class="card-body">
                    <div class="status-layout">
                        <div class="status-bars">
                            <div class="status-item">
                                <div class="status-values">
                                    <input type="number" class="status-current" id="health-current" value="100" min="0" onfocus="this.select()">
                                    <span class="status-separator">/</span>
                                    <span class="status-max">100</span>
                                </div>
                                <div class="status-bar-container">
                                    <span class="status-label">Lebenspunkte</span>
                                    <div class="status-bar draggable" data-status="health">
                                        <div class="status-bar-fill health" id="health-bar" style="width: 100%;"></div>
                                    </div>
                                </div>
                            </div>
                            <div class="status-item">
                                <div class="status-values">
                                    <input type="number" class="status-current" id="moral-current" value="100" min="0" onfocus="this.select()">
                                    <span class="status-separator">/</span>
                                    <span class="status-max">100</span>
                                </div>
                                <div class="status-bar-container">
                                    <span class="status-label">Moral</span>
                                    <div class="status-bar draggable" data-status="moral">
                                        <div class="status-bar-fill moral" id="moral-bar" style="width: 100%"></div>
                                    </div>
                                </div>
                            </div>
                            <div class="status-item">
                                <div class="status-values">
                                    <span class="status-current-display" id="resonanz-display">10</span>
                                    <span class="status-separator">/</span>
                                    <span class="status-max">100</span>
                                </div>
                                <div class="status-bar-container" id="resonanz-container" title="10 + (KRF × PRÄ) = 10">
                                    <span class="status-label">Resonanz (10 + KRF × PRÄ)</span>
                                    <div class="status-bar">
                                        <div class="status-bar-fill resonanz" id="resonanz-bar" style="width: 10%"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="status-info-box">
                            <div class="status-info-row">
                                <span class="status-info-icon" style="color: var(--color-health);">●</span>
                                <span class="status-info-text">0 = Tot | 5 und weniger = Bewusstlos | 20 und weniger = Stark handlungseingeschränkt</span>
                            </div>
                            <div class="status-info-row">
                                <span class="status-info-icon" style="color: var(--color-moral);">●</span>
                                <span class="status-info-text">0 = Handlungsunfähig | 20 und weniger = Würfelproben massiv erschwert | 50 und weniger = Würfelproben leicht erschwert</span>
                            </div>
                            <div class="status-info-row">
                                <span class="status-info-icon" style="color: var(--color-resonanz);">●</span>
                                <span class="status-info-text">Bestimmt Bonus für Fokus-Fähigkeiten Würfelproben</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- FOKUS -->
            <div class="card">
                <div class="card-header">
                    <span class="card-title"><span class="card-title-icon">auto_awesome</span> Fokus</span>
                    <button class="card-action-btn" id="fokus-roll-btn" onclick="rollFokus()" title="Fokus würfeln (W20)">
                        <svg viewBox="0 0 24 24" fill="currentColor" width="16" height="16"><path d="M5 3h14a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2m3 12a2 2 0 0 0-2 2 2 2 0 0 0 2 2 2 2 0 0 0 2-2 2 2 0 0 0-2-2m8-8a2 2 0 0 0-2 2 2 2 0 0 0 2 2 2 2 0 0 0 2-2 2 2 0 0 0-2-2m0 8a2 2 0 0 0-2 2 2 2 0 0 0 2 2 2 2 0 0 0 2-2 2 2 0 0 0-2-2m-4-4a2 2 0 0 0-2 2 2 2 0 0 0 2 2 2 2 0 0 0 2-2 2 2 0 0 0-2-2m-4-4a2 2 0 0 0-2 2 2 2 0 0 0 2 2 2 2 0 0 0 2-2 2 2 0 0 0-2-2Z"/></svg>
                    </button>
                </div>
                <div class="card-body">
                    <div class="fokus-layout">
                        <div class="fokus-header" onclick="openFokusPopup()">
                            <div class="fokus-icon" id="fokus-icon">
                                <span style="color: var(--text-muted); font-size: 24px;">?</span>
                            </div>
                            <div class="fokus-info">
                                <div class="fokus-name" id="fokus-name">Kein Fokus gewählt</div>
                                <div class="fokus-attr" id="fokus-attr">Klicke um zu wählen</div>
                            </div>
                            <div class="fokus-dice" id="fokus-dice" style="display: none;">
                                <div class="fokus-dice-label">Würfel</div>
                                <div class="fokus-dice-value" id="fokus-formula">W20</div>
                            </div>
                        </div>
                        <div class="fokus-abilities" id="fokus-abilities">
                            <div class="fokus-ability empty" onclick="openFokusPopup()">
                                <span>Fähigkeit 1</span>
                            </div>
                            <div class="fokus-ability empty" onclick="openFokusPopup()">
                                <span>Fähigkeit 2</span>
                            </div>
                        </div>
                        <div class="status-info-box" style="margin-top: var(--gap-sm);">
                            <div class="status-info-row">
                                <span class="status-info-icon" style="color: var(--text-muted);">●</span>
                                <span class="status-info-text">Würfelprobe Fokusfähigkeit (D20): ≤ 10 ist ein Fehlschlag, ≥ 11 ist ein Erfolg</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

            <!-- SCHWÄCHE & RAST ROW -->
            <div class="schwaeche-rast-row">
                <!-- SCHWÄCHE -->
                <div class="card">
                <div class="card-header">
                    <span class="card-title"><span class="card-title-icon">warning</span> Schwäche</span>
                </div>
                <div class="card-body">
                    <div class="schwaeche-display" id="schwaeche-display" onclick="openSchwaechePopup()">
                        <div class="schwaeche-empty">Keine Schwäche gewählt</div>
                    </div>
                </div>
            </div>

            <!-- RAST -->
            <div class="card">
                <div class="card-header">
                    <span class="card-title"><span class="card-title-icon">hotel</span> Rast</span>
                </div>
                <div class="card-body">
                    <div class="rast-buttons">
                        <button class="rast-btn lange" onclick="langeRast()">
                            <svg class="rast-btn-icon" viewBox="0 0 24 24"><path fill="currentColor" d="M12 22q-2.075 0-3.9-.788t-3.175-2.137T2.788 15.9T2 12t.788-3.9t2.137-3.175T8.1 2.788T12 2t3.9.788t3.175 2.137T21.213 8.1T22 12t-.788 3.9t-2.137 3.175t-3.175 2.138T12 22m0-2q1.6 0 3.075-.6t2.6-1.725L12 12V4Q8.65 4 6.325 6.325T4 12t2.325 5.675T12 20"/></svg>
                            <span class="rast-btn-title">Lange Rast</span>
                            <span class="rast-btn-info">+20 LP, +10 Moral</span>
                        </button>
                        <button class="rast-btn kurze" onclick="kurzeRast()">
                            <svg class="rast-btn-icon" viewBox="0 0 24 24"><path fill="currentColor" d="M12 22q-2.075 0-3.9-.788t-3.175-2.137T2.788 15.9T2 12t.788-3.9t2.137-3.175T8.1 2.788T12 2t3.9.788t3.175 2.137T21.213 8.1T22 12t-.788 3.9t-2.137 3.175t-3.175 2.138T12 22m0-2q3.35 0 5.675-2.325T20 12q0-1.6-.6-3.075t-1.725-2.6L12 12V4Q8.65 4 6.325 6.325T4 12t2.325 5.675T12 20"/></svg>
                            <span class="rast-btn-title">Kurze Rast</span>
                            <span class="rast-btn-info">+10 LP, +5 Moral</span>
                        </button>
                    </div>
                </div>
            </div>
        </div>
        </div>
        <!-- END GRID SECTION -->

        <!-- BOTTOM SECTION -->
        <div class="bottom-section">
            <!-- SKILLS - Full Width -->
            <div class="card">
                <div class="card-header">
                    <span class="card-title"><span class="card-title-icon">menu_book</span> Fähigkeiten</span>
                    <div class="skill-points-badge" id="skill-points">
                        <span id="skill-points-text">500 / 500 Punkte verfügbar</span>
                    </div>
                </div>
                <div class="skills-tabs">
                    <button class="skill-tab active" data-category="handeln" onclick="switchSkillTab('handeln')">
                        <div class="skill-tab-name">Handeln</div>
                        <div class="skill-tab-attrs">KRF + GES + ZÄH</div>
                    </button>
                    <button class="skill-tab" data-category="wissen" onclick="switchSkillTab('wissen')">
                        <div class="skill-tab-name">Wissen</div>
                        <div class="skill-tab-attrs">VER + ZÄH</div>
                    </button>
                    <button class="skill-tab" data-category="soziales" onclick="switchSkillTab('soziales')">
                        <div class="skill-tab-name">Soziales</div>
                        <div class="skill-tab-attrs">PRÄ + VER</div>
                    </button>
                </div>
                
                <div class="skill-panel active" id="panel-handeln">
                    <div class="skills-list-header">
                        <span></span><span>Fähigkeit</span><span>Pkt</span><span>Bonus</span><span></span>
                    </div>
                    <div id="skills-handeln"></div>
                    <div class="skill-btn-row">
                        <button class="add-skill-btn" onclick="addSkill('handeln')">+ Hinzufügen</button>
                        <button class="catalog-skill-btn" onclick="openSkillCatalog('handeln')">📖 Katalog</button>
                    </div>
                    <div class="skill-footer">
                        <span class="skill-footer-label">Klassen-Fallback</span>
                        <div>
                            <span class="skill-footer-value" id="handeln-total">0</span>
                            <span class="skill-footer-bonus" id="handeln-bonus">+0</span>
                        </div>
                    </div>
                </div>
                
                <div class="skill-panel" id="panel-wissen">
                    <div class="skills-list-header">
                        <span></span><span>Fähigkeit</span><span>Pkt</span><span>Bonus</span><span></span>
                    </div>
                    <div id="skills-wissen"></div>
                    <div class="skill-btn-row">
                        <button class="add-skill-btn" onclick="addSkill('wissen')">+ Hinzufügen</button>
                        <button class="catalog-skill-btn" onclick="openSkillCatalog('wissen')">📖 Katalog</button>
                    </div>
                    <div class="skill-footer">
                        <span class="skill-footer-label">Klassen-Fallback</span>
                        <div>
                            <span class="skill-footer-value" id="wissen-total">0</span>
                            <span class="skill-footer-bonus" id="wissen-bonus">+0</span>
                        </div>
                    </div>
                </div>
                
                <div class="skill-panel" id="panel-soziales">
                    <div class="skills-list-header">
                        <span></span><span>Fähigkeit</span><span>Pkt</span><span>Bonus</span><span></span>
                    </div>
                    <div id="skills-soziales"></div>
                    <div class="skill-btn-row">
                        <button class="add-skill-btn" onclick="addSkill('soziales')">+ Hinzufügen</button>
                        <button class="catalog-skill-btn" onclick="openSkillCatalog('soziales')">📖 Katalog</button>
                    </div>
                    <div class="skill-footer">
                        <span class="skill-footer-label">Klassen-Fallback</span>
                        <div>
                            <span class="skill-footer-value" id="soziales-total">0</span>
                            <span class="skill-footer-bonus" id="soziales-bonus">+0</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Bottom Row: Zweite Chance + Währung/Waffe -->
            <div class="bottom-row">
                <!-- ZWEITE CHANCE -->
                <div class="card">
                    <div class="card-header">
                        <span class="card-title"><span class="card-title-icon">casino</span> Zweite Chance</span>
                        <button class="card-action-btn gm-only" id="reset-zweite-chance-btn" onclick="resetZweiteChance()" title="Zweite Chance wiederherstellen (GM)">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8"/>
                                <path d="M21 3v5h-5"/>
                                <path d="M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16"/>
                                <path d="M8 16H3v5"/>
                            </svg>
                        </button>
                    </div>
                    <div class="card-body">
                        <div class="dice-row-large">
                            <div class="dice-check-large" id="dice-1" onclick="rollZweiteChance(0)" title="Klicken um Zweite Chance zu nutzen">
                                <svg viewBox="0 0 100 100"><path d="m49.355 99.528c-0.24708-0.25657-1.6214-1.7492-3.0541-3.317-2.3047-2.5219-3.516-3.8292-5.2938-5.7131-0.2773-0.29384-1.5251-1.6542-2.773-3.0229-2.3561-2.5844-5.1488-5.6429-7.9097-8.6624-0.88412-0.96693-2.926-3.1848-4.5376-4.9285-1.6116-1.7438-2.9553-3.2374-2.9861-3.3192-0.03234-0.0858 11.461-0.14867 27.183-0.14867 14.982 0 27.24 0.0489 27.24 0.10862 0 0.0597-0.35576 0.49459-0.79058 0.96634-0.43482 0.47174-1.5941 1.7274-2.5761 2.7904-2.0061 2.1714-6.6115 7.1835-16.129 17.553-7.9441 8.6552-7.4759 8.1604-7.7209 8.1604-0.11174 0-0.40531-0.20993-0.65239-0.46651zm-3.7748-13.817c0.39727-2e-3 0.81169-0.3825 3.5099-3.2228 2.3664-2.491 2.4207-2.5693 2.4207-3.4926 0-0.64199-0.08645-0.869-0.47136-1.2378-0.47061-0.45088-0.47552-0.4516-3.1091-0.4516h-2.6377v-0.58029c0-0.77677-0.29798-1.3867-0.73474-1.5039-0.66048-0.17724-2.2232-0.10269-2.5286 0.12063-0.23999 0.1755-0.29005 0.40128-0.24219 1.0925l0.06032 0.87127-0.72189-1e-4c-0.54246-8e-5-0.82442 0.10243-1.1344 0.4124-0.46236 0.46236-0.49288 0.65126-0.22801 1.4111 0.17624 0.50555 0.22516 0.52926 1.0924 0.52926h0.90788l0.0018 2.0587c0.0024 2.6671 0.10714 3.2727 0.62472 3.6118 0.53088 0.34786 1.4868 0.54218 2.2304 0.45344 0.32351-0.0386 0.75546-0.071 0.95989-0.072zm-0.45571-4.4549v-1.597h2.7298l-0.8107 0.96633c-0.44588 0.53148-1.0601 1.2502-1.3649 1.597l-0.55419 0.6307zm12.321 4.2144c0.8131-0.22371 1.6667-0.53017 1.897-0.68103 0.80329-0.52633 0.85761-1.4792 0.12208-2.1415-0.29264-0.26347-0.39883-0.26725-1.2377-0.044-0.50468 0.1343-0.97433 0.24508-1.0437 0.24618-0.06933 1e-3-0.12605-1.54-0.12605-3.4246 0-4.0332-0.0313-4.1238-1.4718-4.2622-0.4742-0.0456-1.1311-0.0324-1.4598 0.0293l-0.59765 0.11213v4.625c0 4.7022 0.05332 5.1523 0.65475 5.5273 0.78945 0.49217 1.5119 0.49514 3.2628 0.0134zm-15.934 10.222c-1.4789-0.86882-3.3696-1.9615-4.2015-2.4283-0.83189-0.46671-2.231-1.269-3.1091-1.783-0.87811-0.5139-2.1638-1.2552-2.857-1.6474-1.1159-0.63127-6.3995-3.7016-7.0585-4.1017-0.16478-0.10005 0.01413-0.12419 0.51658-0.0697 1.0579 0.11473 2.0979-0.40834 2.2576-1.1355 0.18747-0.85356-0.60997-2.1791-2.2134-3.6793-1.6671-1.5597-2.903-2.2412-3.9281-2.1659-0.87311 0.0642-1.0924 0.35849-0.9267 1.2436 0.09952 0.53145 0.40876 0.93983 1.6115 2.1282 0.85734 0.84704 1.3737 1.4705 1.2179 1.4705-0.53059 0-1.7144-0.8545-2.7635-1.9948-1.1112-1.2078-1.7484-1.5858-1.9198-1.139-0.14181 0.36954 0.20176 0.9087 1.326 2.0809l1.0049 1.0478-3.1753-1.8243c-7.5298-4.3261-9.5448-5.5157-9.5908-5.6619-0.0413-0.13126 11.913-5.2904 12.243-5.2835 0.06231 1e-3 2.5958 2.7035 5.63 6.0049 3.0342 3.3014 7.3653 8.0091 9.6247 10.462 2.2594 2.4525 4.8266 5.2532 5.7049 6.2237 0.87829 0.97054 2.0525 2.2373 2.6094 2.815 0.55691 0.57771 0.93912 1.043 0.84935 1.034-0.08977-9e-3-1.3732-0.72718-2.8521-1.596zm-11.008-11.851c0-0.16876-3.1603-3.806-4.474-5.1492-0.56794-0.58069-1.1402-0.69509-1.6419-0.32824-0.27162 0.19861-0.11049 0.43344 1.8161 2.6469 1.1628 1.3359 2.3223 2.5609 2.5767 2.7222 0.51342 0.32542 1.7231 0.40145 1.7231 0.10829zm27.785 10.48c2.7071-2.9298 5.6036-6.0821 16.292-17.73 2.9473-3.212 5.4213-5.84 5.4977-5.84 0.1134 0 3.2765 1.3251 11.923 4.9947l0.57582 0.24439-0.49178 0.29554c-0.50069 0.30087-2.6666 1.5541-7.6343 4.4173-1.5251 0.87902-4.7393 2.7344-7.1425 4.123-2.4032 1.3886-6.5627 3.789-9.2432 5.3342-6.2842 3.6225-7.7929 4.4953-10.283 5.9487-1.1263 0.6575-2.0933 1.1954-2.1488 1.1954s1.1393-1.3424 2.6553-2.983zm15.411-11.055 0.6075-0.5932 1.5614 0.603c1.3194 0.50957 1.6385 0.57613 2.0591 0.42951 0.62617-0.21829 1.4067-0.85993 2.1111-1.7354l0.54619-0.67886v-2.4934c0-2.486-1e-3-2.4942-0.42777-2.7736-0.78128-0.51191-1.4935-0.12225-3.4114 1.8664l-1.6992 1.7619-0.76243-0.1045c-0.74918-0.10269-0.77844-0.0885-1.6843 0.81741-0.50705 0.50706-0.92192 1.0017-0.92192 1.0991 0 0.0975 0.22688 0.25627 0.50418 0.35295 0.61346 0.21385 0.62719 0.3552 0.084 0.86547-0.40713 0.38248-0.53797 0.8345-0.3081 1.0644 0.31743 0.31743 1.1631 0.0838 1.7417-0.48117zm3.5547-2.4184c-0.3991-0.15832-0.70984-0.35845-0.69053-0.44474 0.0193-0.0863 0.3602-0.52851 0.75753-0.98272 0.69095-0.78986 0.72626-0.80816 0.81051-0.42015 0.17368 0.79996 0.18398 2.1705 0.0162 2.153-0.09239-0.01-0.4946-0.14706-0.8937-0.30538zm-53.622 1.7656c-0.59744-0.44078-1.1959-1.1577-1.1959-1.4326 0-0.30204 0.44464-0.38937 0.86918-0.17069 0.67218 0.34622 1.3156 1.0477 1.3156 1.4344 0 0.53897-0.39574 0.60657-0.98891 0.16895zm-17.324-9.1625c-0.11287-0.2109-0.17397-3.1085-0.17397-8.2498v-7.9247l0.50912 0.4284c1.0142 0.85342 2.3042 0.68805 3.5028-0.44905 1.2455-1.1815 1.6707-3.079 1.1375-5.0753-0.51715-1.936-1.3598-2.941-2.4657-2.941-0.51111 0-0.73028 0.11175-1.1446 0.5836-0.49742 0.56653-0.86402 1.4963-0.86593 2.1961-0.0018 0.67533 0.5256 2.3576 0.93316 2.9763 0.38976 0.59168 0.39529 0.63021 0.09039 0.63021-0.58952 0-0.86637-0.20134-1.2417-0.90303l-0.37097-0.69352-0.04109-11.764-0.04109-11.764 6.3853 19.067c3.5119 10.487 6.3853 19.115 6.3853 19.175 0 0.1797-11.598 5.0334-12.027 5.0334-0.22101 0-0.47476-0.14434-0.57149-0.32507zm4.0067-8.3049c0.32316-0.38938 0.2724-1.0265-0.13421-1.6844-0.3788-0.61291-0.38116-0.63946-0.07596-0.85607 0.17323-0.12294 0.9956-0.74527 1.8275-1.3829 1.2903-0.98907 1.5203-1.2395 1.5657-1.7046 0.07311-0.74938-0.44134-2.26-0.7317-2.1485-0.57858 0.22203-4.7593 3.5317-4.9276 3.9008-0.27481 0.60315 0.01779 1.7125 0.75989 2.881 0.33868 0.53331 0.69792 1.0252 0.79831 1.0931 0.28795 0.19479 0.71242 0.14927 0.91801-0.0985zm79.765 7.5155c-1.2016-0.5139-3.6973-1.5786-5.5459-2.366-1.8486-0.78738-3.3839-1.452-3.4117-1.477-0.0278-0.025 2.8281-8.6566 6.3464-19.182l6.397-19.136-0.06 10.84c-0.033 5.9619-0.12851 11.178-0.21227 11.592l-0.15227 0.75199-1.7414-1.6763c-0.95776-0.92197-1.8841-1.7306-2.0584-1.7968-0.38352-0.1458-0.70716 0.29355-0.98047 1.331l-0.18608 0.7063 1.3908 1.3237c0.76496 0.72806 1.9721 1.8471 2.6826 2.4868l1.2917 1.1631 0.0107 7.9147c0.0101 7.4619-7e-3 7.9306-0.29662 8.1928-0.49632 0.44916-1.1594 0.3216-3.474-0.66831zm1.6041-8.3049c1.0338-1.1067 1.5617-3.5073 1.1101-5.0482-0.34817-1.1879-0.9474-1.8341-1.7007-1.8341-0.54457 0-0.58106-0.0398-0.83396-0.90978-0.33762-1.1613-1.0873-1.8581-1.8377-1.708-0.70051 0.1401-1.0076 0.46438-1.5191 1.6042-1.0771 2.4001-0.96085 4.6927 0.2976 5.8683 0.3466 0.32377 0.55376 0.38448 1.0739 0.31473 0.63184-0.0848 0.64862-0.0729 0.85904 0.60719 0.48345 1.5625 1.6513 2.0687 2.5508 1.1057zm-1.2637-2.6725c-0.3569-0.69018-0.32033-1.1206 0.12173-1.4325 0.35419-0.2499 0.39775-0.24277 0.68804 0.11264 0.47659 0.58351 0.18698 1.8-0.43163 1.8131-0.067 1e-3-0.23712-0.22055-0.37814-0.49325zm-2.3094-1.813c-0.42602-0.48504-0.49804-0.99099-0.23178-1.6282 0.29224-0.69943 0.65516-0.76742 1.0314-0.19324 0.6004 0.91632-0.13107 2.5826-0.79959 1.8215zm-65.842 8.4009c9.25e-4-0.16654 1.2582-2.3568 13.868-24.158 1.9246-3.3276 4.2341-7.3358 5.1322-8.9071s1.7738-3.0986 1.946-3.3939c0.17212-0.2953 1.7499-3.0342 3.5061-6.0865 1.7562-3.0523 3.2309-5.5499 3.2771-5.5504 0.04622-5e-4 0.72189 1.1125 1.5015 2.4732 0.77961 1.3607 2.072 3.6084 2.872 4.9949 0.8 1.3865 2.3457 4.0712 3.435 5.9661 1.0892 1.8948 2.2297 3.8611 2.5343 4.3695 0.30461 0.50839 2.9918 5.1594 5.9715 10.336 2.9797 5.1762 6.7672 11.743 8.4165 14.593 1.6494 2.8498 2.9989 5.251 2.9989 5.3359 0 0.0931-10.996 0.15436-27.73 0.15436-15.251 0-27.729-0.0567-27.729-0.12605zm37.606-8.4356c2.4648-1.3188 3.6068-3.7111 3.6144-7.572 0.0045-2.2651-0.29676-3.6156-1.1483-5.1478-0.6781-1.2201-1.4817-1.9684-2.7557-2.5659-0.80918-0.37954-1.1534-0.43714-2.6126-0.43714-1.495 0-1.785 0.0513-2.6258 0.46421-1.0411 0.51129-2.2839 1.7306-2.805 2.7521-0.73197 1.4348-0.94808 2.5596-0.94808 4.9345 0 3.1865 0.50517 4.7607 2.0617 6.4248 1.3064 1.3966 2.4489 1.8284 4.6533 1.7587 1.3454-0.0426 1.6289-0.11012 2.566-0.61148zm-3.9838-3.2286c-0.72061-0.67135-1.0689-1.7672-1.1531-3.6285-0.12287-2.7142 0.44092-4.7874 1.4237-5.2352 1.1673-0.53187 2.1977 0.0116 2.7626 1.4571 0.31808 0.81391 0.37614 1.2867 0.37614 3.0632 0 1.7765-0.05805 2.2493-0.37616 3.0632-0.20689 0.52938-0.57063 1.1155-0.80832 1.3024-0.5968 0.46945-1.7089 0.4583-2.2248-0.0223zm-7.8519 3.3688c0.76638-0.3492 1.0157-1.6194 0.54091-2.7557l-0.2418-0.57869-5.587-0.0922 1.9373-1.6493c2.1184-1.8035 2.7247-2.4823 3.3773-3.7816 1.2918-2.572 0.24707-5.451-2.4002-6.6139-1.7596-0.77292-5.36-0.53586-6.3971 0.4212-1.0543 0.97293-1.1503 2.2908-0.24282 3.3331 0.22626 0.25984 0.32044 0.24441 1.2809-0.20995 2.2631-1.0706 4.5125-0.29409 4.0847 1.4102-0.18523 0.73803-1.1046 1.7742-3.528 3.9764-1.4466 1.3146-2.5495 2.4567-2.7208 2.8177-0.33213 0.69991-0.36926 2.1791-0.06928 2.7601 0.11165 0.2162 0.35798 0.56327 0.5474 0.77125 0.34015 0.37345 0.39804 0.37813 4.6767 0.37813 2.8171 0 4.4756-0.0653 4.7418-0.18659zm-27.525 6.5688c-0.13758-0.37024-8.3083-24.636-11.307-33.58-2.1982-6.5563-2.5743-7.8215-2.3794-8.0036 0.13592-0.12697 1.9313-0.43792 4.3489-0.75321 2.2646-0.29532 4.9115-0.64726 5.8821-0.78208 5.8415-0.81144 30.822-4.0903 30.861-4.0508 0.02619 0.0262-0.27791 0.61163-0.67577 1.301-0.39786 0.68936-1.6153 2.8037-2.7055 4.6986-1.0901 1.8949-2.7 4.693-3.5774 6.2182-0.87745 1.5251-1.7177 2.9778-1.8672 3.2281-0.37435 0.62667-6.1822 10.663-7.6631 13.242-0.66341 1.1554-1.775 3.0839-2.4701 4.2855-0.69517 1.2016-2.7223 4.7182-4.5047 7.8147-4.0974 7.1182-3.8295 6.6845-3.9418 6.3822zm6.3119-25.215c1.5533-0.79245 3.4705-3.2576 4.1865-5.3831 0.45858-1.3613 0.43758-2.8954-0.05144-3.7588-0.81309-1.4355-2.4884-2.0759-3.9872-1.5241-1.1979 0.44108-1.2065 0.43729-1.4233-0.62702-0.31339-1.5388-1.4533-2.5163-2.9344-2.5163-1.0921 0-1.8935 0.39035-3.0329 1.4772-1.7199 1.6405-2.7727 3.7723-2.7754 5.6201-0.0019 1.323 0.38702 2.189 1.3162 2.9302 0.56334 0.4494 0.77734 0.51484 1.6806 0.51389 0.56928-6.7e-4 1.2325-0.0629 1.4739-0.13841 0.42633-0.13342 0.44219-0.11228 0.55521 0.73971 0.06399 0.48237 0.2578 1.1543 0.43068 1.4932 0.28181 0.55239 1.1741 1.3144 1.8524 1.5819 0.48186 0.19003 1.9782-0.0356 2.7091-0.40844zm-1.2994-3.3412c-0.54897-0.23164-1.0737-1.0079-1.0726-1.5869 2e-3-1.1103 0.31406-1.7664 1.0088-2.1208 1.1097-0.56611 2.2445-0.31639 2.6548 0.58422 0.28411 0.62356 0.25096 1.0554-0.14359 1.8704-0.5158 1.0655-1.5893 1.6152-2.4474 1.2531zm-4.8971-3.4612c-0.62581-0.26313-0.88216-0.69558-0.88216-1.4881 0-0.45709 0.14742-0.74715 0.64621-1.2715 0.66086-0.69471 1.0266-0.80174 1.7716-0.51848 0.98922 0.37611 1.2372 2.3857 0.36495 2.9572-0.6811 0.44628-1.3384 0.55724-1.9007 0.32085zm55.728 27.013c-4.2797-7.4421-9.6077-16.68-10.633-18.435-0.48578-0.83188-2.0813-3.5922-3.5456-6.1341-1.4643-2.5419-4.17-7.2307-6.0128-10.42-4.3995-7.6135-4.1825-7.2265-4.052-7.2265 0.06271 0 3.7527 0.48721 8.1999 1.0827 4.4473 0.59547 13.569 1.8106 20.27 2.7004 9.8763 1.3113 12.241 1.6732 12.484 1.9107 0.28709 0.28062 0.17877 0.65513-2.5609 8.8536-1.5734 4.7083-3.2113 9.5816-3.6398 10.829-0.42849 1.2478-2.2501 6.6551-4.0481 12.016-1.7979 5.3611-3.32 9.8-3.3824 9.8643-0.0624 0.0643-1.4483-2.2045-3.08-5.0418zm-0.6831-18.782c0.20596-0.14426 0.48383-0.47375 0.61748-0.73222 0.23687-0.45804 0.21139-0.51585-1.0084-2.2875-0.68827-0.99968-1.2226-1.8464-1.1875-1.8815 0.0352-0.0352 0.77211 0.2368 1.6376 0.60438 2.3724 1.0075 3.8182 1.1734 4.9388 0.56652 0.60712-0.32878 1.2251-1.1247 1.4069-1.812 0.68407-2.586-2.5419-7.8037-4.827-7.8072-0.77149-1e-3-1.5433 0.77246-1.5371 1.5408 4e-3 0.47233 0.1116 0.62433 0.69441 0.97926 0.7699 0.46887 1.8899 1.8608 2.0524 2.5507 0.0986 0.41846-0.21118 0.98219-0.53653 0.9765-0.38385-7e-3-2.112-0.5896-4.1721-1.4072-1.3076-0.51898-2.5946-0.94359-2.86-0.94359-0.76381 0-1.6638 0.71293-1.856 1.4703-0.0906 0.35691-0.10447 0.81181-0.03083 1.0109 0.1587 0.429 4.4627 6.7054 4.8939 7.1365 0.36801 0.36802 1.2732 0.38611 1.7738 0.0355zm-66.841 11.332c-0.18989-0.31146-0.34554-0.75745-0.34588-0.99108-7.48e-4-0.50612 0.4285-1.1718 0.75564-1.1718 0.36936 0 0.75626 0.69198 0.75626 1.3526 0 0.42478-0.12251 0.72064-0.41038 0.99108l-0.41038 0.38553zm6.1237-34.604c6.481-3.7574 12.198-7.0611 21.932-12.674 5.6139-3.2373 7.522-4.3435 10.197-5.9112 0.84788-0.49697 1.6231-0.90359 1.7226-0.90359 0.12692 0 0.181 2.5498 0.181 8.5332v8.5332l-18.781 2.4947c-10.329 1.3721-19.045 2.531-19.369 2.5754-0.42039 0.0577 0.75433-0.69769 4.1174-2.6474zm17.554-2.361c0.46671-0.1001 0.84856-0.25079 0.84856-0.33488 0-0.0841 0.75626-1.7156 1.6806-3.6255 0.92432-1.9099 1.6806-3.6418 1.6806-3.8486 0-0.71758-0.8024-0.65481-2.6991 0.21112-1.1814 0.53938-1.8385 1.1957-1.8385 1.8364 0 0.46471 0.22903 0.4953 1.0719 0.14314 0.3348-0.13989 0.60873-0.22338 0.60873-0.18554 0 0.0378-0.52777 1.1347-1.1728 2.4375-1.2266 2.4773-1.4521 3.0759-1.2699 3.3707 0.13362 0.21621 0.06014 0.2165 1.09-4e-3zm7.1297-1.2433c2.0115-1.0177 4.2078-4.0854 4.4197-6.1731 0.07545-0.74333 0.03038-0.96402-0.27579-1.3507-0.32344-0.40845-0.47861-0.46216-1.3353-0.46216-0.74049 0-1.2072 0.11886-1.977 0.50353-2.2007 1.0997-4.3741 4.1083-4.5499 6.2983-0.07471 0.93071-0.04058 1.0984 0.29119 1.4301 0.53978 0.53978 2.0946 0.42818 3.4271-0.246zm-1.4509-1.4737c-0.21502-0.63193 1.1111-3.3774 2.0145-4.1706 0.76453-0.67127 1.4482-0.63661 1.5297 0.0776 0.07592 0.66519-1.01 2.8208-1.8383 3.649-0.66814 0.66814-1.5514 0.89804-1.7059 0.44401zm31.975 5.2273c-10.306-1.3797-18.833-2.5412-18.949-2.5812-0.16433-0.0568-0.21007-1.9218-0.21007-8.5648 0-5.1598 0.0617-8.4922 0.15724-8.4922 0.08648 0 2.3364 1.2583 4.9997 2.7962 2.6634 1.5379 5.8635 3.3807 7.1113 4.0951 3.0313 1.7356 13.647 7.8684 15.545 8.9805 0.83189 0.48743 3.5922 2.0802 6.1341 3.5396 2.5419 1.4594 4.6531 2.6802 4.6916 2.7129 0.15612 0.13263-1.4784-0.076-19.481-2.486zm0.12998-2.6748c0.02739-0.14224-0.12571-0.51951-0.34023-0.83836-0.37147-0.55214-0.47575-0.59568-2.1906-0.91456-0.99032-0.18414-1.8005-0.37321-1.8003-0.42014 1.65e-4-0.0469 0.34043-0.30021 0.75615-0.56285 1.456-0.91986 1.7099-1.6077 1.0764-2.9163-0.82295-1.7-3.8199-3.2142-6.0343-3.0488-0.67445 0.0504-0.76181 0.1043-0.8075 0.49854-0.03275 0.28256 0.09793 0.61548 0.36216 0.92267 0.38128 0.44326 0.49163 0.47673 1.4203 0.4307 1.1795-0.0585 2.0663 0.25334 2.4691 0.8682 0.37256 0.56859 0.1918 0.87015-1.1721 1.9554-1.3514 1.0753-1.431 1.5086-0.46535 2.5323 0.62072 0.65803 0.67202 0.67671 3.4032 1.239 3.0193 0.62167 3.2489 0.63923 3.3231 0.25419zm-8.0287-1.0942c0-0.053-0.6824-1.6978-1.5164-3.6553-1.6304-3.8264-1.969-4.3228-3.1697-4.6461-0.37368-0.10063-1.0956-0.13107-1.6452-0.0694-1.5473 0.17368-1.7417 0.5029-0.87785 1.4868 0.45977 0.52365 0.61631 0.59405 1.3209 0.59405h0.79929l1.1389 2.6469c0.6264 1.4558 1.2678 2.784 1.4254 2.9516 0.47308 0.50325 2.5247 1.0651 2.5247 0.69137z"/></svg>
                            </div>
                            <div class="dice-check-large" id="dice-2" onclick="rollZweiteChance(1)" title="Klicken um Zweite Chance zu nutzen">
                                <svg viewBox="0 0 100 100"><path d="m49.355 99.528c-0.24708-0.25657-1.6214-1.7492-3.0541-3.317-2.3047-2.5219-3.516-3.8292-5.2938-5.7131-0.2773-0.29384-1.5251-1.6542-2.773-3.0229-2.3561-2.5844-5.1488-5.6429-7.9097-8.6624-0.88412-0.96693-2.926-3.1848-4.5376-4.9285-1.6116-1.7438-2.9553-3.2374-2.9861-3.3192-0.03234-0.0858 11.461-0.14867 27.183-0.14867 14.982 0 27.24 0.0489 27.24 0.10862 0 0.0597-0.35576 0.49459-0.79058 0.96634-0.43482 0.47174-1.5941 1.7274-2.5761 2.7904-2.0061 2.1714-6.6115 7.1835-16.129 17.553-7.9441 8.6552-7.4759 8.1604-7.7209 8.1604-0.11174 0-0.40531-0.20993-0.65239-0.46651zm-3.7748-13.817c0.39727-2e-3 0.81169-0.3825 3.5099-3.2228 2.3664-2.491 2.4207-2.5693 2.4207-3.4926 0-0.64199-0.08645-0.869-0.47136-1.2378-0.47061-0.45088-0.47552-0.4516-3.1091-0.4516h-2.6377v-0.58029c0-0.77677-0.29798-1.3867-0.73474-1.5039-0.66048-0.17724-2.2232-0.10269-2.5286 0.12063-0.23999 0.1755-0.29005 0.40128-0.24219 1.0925l0.06032 0.87127-0.72189-1e-4c-0.54246-8e-5-0.82442 0.10243-1.1344 0.4124-0.46236 0.46236-0.49288 0.65126-0.22801 1.4111 0.17624 0.50555 0.22516 0.52926 1.0924 0.52926h0.90788l0.0018 2.0587c0.0024 2.6671 0.10714 3.2727 0.62472 3.6118 0.53088 0.34786 1.4868 0.54218 2.2304 0.45344 0.32351-0.0386 0.75546-0.071 0.95989-0.072zm-0.45571-4.4549v-1.597h2.7298l-0.8107 0.96633c-0.44588 0.53148-1.0601 1.2502-1.3649 1.597l-0.55419 0.6307zm12.321 4.2144c0.8131-0.22371 1.6667-0.53017 1.897-0.68103 0.80329-0.52633 0.85761-1.4792 0.12208-2.1415-0.29264-0.26347-0.39883-0.26725-1.2377-0.044-0.50468 0.1343-0.97433 0.24508-1.0437 0.24618-0.06933 1e-3-0.12605-1.54-0.12605-3.4246 0-4.0332-0.0313-4.1238-1.4718-4.2622-0.4742-0.0456-1.1311-0.0324-1.4598 0.0293l-0.59765 0.11213v4.625c0 4.7022 0.05332 5.1523 0.65475 5.5273 0.78945 0.49217 1.5119 0.49514 3.2628 0.0134zm-15.934 10.222c-1.4789-0.86882-3.3696-1.9615-4.2015-2.4283-0.83189-0.46671-2.231-1.269-3.1091-1.783-0.87811-0.5139-2.1638-1.2552-2.857-1.6474-1.1159-0.63127-6.3995-3.7016-7.0585-4.1017-0.16478-0.10005 0.01413-0.12419 0.51658-0.0697 1.0579 0.11473 2.0979-0.40834 2.2576-1.1355 0.18747-0.85356-0.60997-2.1791-2.2134-3.6793-1.6671-1.5597-2.903-2.2412-3.9281-2.1659-0.87311 0.0642-1.0924 0.35849-0.9267 1.2436 0.09952 0.53145 0.40876 0.93983 1.6115 2.1282 0.85734 0.84704 1.3737 1.4705 1.2179 1.4705-0.53059 0-1.7144-0.8545-2.7635-1.9948-1.1112-1.2078-1.7484-1.5858-1.9198-1.139-0.14181 0.36954 0.20176 0.9087 1.326 2.0809l1.0049 1.0478-3.1753-1.8243c-7.5298-4.3261-9.5448-5.5157-9.5908-5.6619-0.0413-0.13126 11.913-5.2904 12.243-5.2835 0.06231 1e-3 2.5958 2.7035 5.63 6.0049 3.0342 3.3014 7.3653 8.0091 9.6247 10.462 2.2594 2.4525 4.8266 5.2532 5.7049 6.2237 0.87829 0.97054 2.0525 2.2373 2.6094 2.815 0.55691 0.57771 0.93912 1.043 0.84935 1.034-0.08977-9e-3-1.3732-0.72718-2.8521-1.596zm-11.008-11.851c0-0.16876-3.1603-3.806-4.474-5.1492-0.56794-0.58069-1.1402-0.69509-1.6419-0.32824-0.27162 0.19861-0.11049 0.43344 1.8161 2.6469 1.1628 1.3359 2.3223 2.5609 2.5767 2.7222 0.51342 0.32542 1.7231 0.40145 1.7231 0.10829zm27.785 10.48c2.7071-2.9298 5.6036-6.0821 16.292-17.73 2.9473-3.212 5.4213-5.84 5.4977-5.84 0.1134 0 3.2765 1.3251 11.923 4.9947l0.57582 0.24439-0.49178 0.29554c-0.50069 0.30087-2.6666 1.5541-7.6343 4.4173-1.5251 0.87902-4.7393 2.7344-7.1425 4.123-2.4032 1.3886-6.5627 3.789-9.2432 5.3342-6.2842 3.6225-7.7929 4.4953-10.283 5.9487-1.1263 0.6575-2.0933 1.1954-2.1488 1.1954s1.1393-1.3424 2.6553-2.983zm15.411-11.055 0.6075-0.5932 1.5614 0.603c1.3194 0.50957 1.6385 0.57613 2.0591 0.42951 0.62617-0.21829 1.4067-0.85993 2.1111-1.7354l0.54619-0.67886v-2.4934c0-2.486-1e-3-2.4942-0.42777-2.7736-0.78128-0.51191-1.4935-0.12225-3.4114 1.8664l-1.6992 1.7619-0.76243-0.1045c-0.74918-0.10269-0.77844-0.0885-1.6843 0.81741-0.50705 0.50706-0.92192 1.0017-0.92192 1.0991 0 0.0975 0.22688 0.25627 0.50418 0.35295 0.61346 0.21385 0.62719 0.3552 0.084 0.86547-0.40713 0.38248-0.53797 0.8345-0.3081 1.0644 0.31743 0.31743 1.1631 0.0838 1.7417-0.48117zm3.5547-2.4184c-0.3991-0.15832-0.70984-0.35845-0.69053-0.44474 0.0193-0.0863 0.3602-0.52851 0.75753-0.98272 0.69095-0.78986 0.72626-0.80816 0.81051-0.42015 0.17368 0.79996 0.18398 2.1705 0.0162 2.153-0.09239-0.01-0.4946-0.14706-0.8937-0.30538zm-53.622 1.7656c-0.59744-0.44078-1.1959-1.1577-1.1959-1.4326 0-0.30204 0.44464-0.38937 0.86918-0.17069 0.67218 0.34622 1.3156 1.0477 1.3156 1.4344 0 0.53897-0.39574 0.60657-0.98891 0.16895zm-17.324-9.1625c-0.11287-0.2109-0.17397-3.1085-0.17397-8.2498v-7.9247l0.50912 0.4284c1.0142 0.85342 2.3042 0.68805 3.5028-0.44905 1.2455-1.1815 1.6707-3.079 1.1375-5.0753-0.51715-1.936-1.3598-2.941-2.4657-2.941-0.51111 0-0.73028 0.11175-1.1446 0.5836-0.49742 0.56653-0.86402 1.4963-0.86593 2.1961-0.0018 0.67533 0.5256 2.3576 0.93316 2.9763 0.38976 0.59168 0.39529 0.63021 0.09039 0.63021-0.58952 0-0.86637-0.20134-1.2417-0.90303l-0.37097-0.69352-0.04109-11.764-0.04109-11.764 6.3853 19.067c3.5119 10.487 6.3853 19.115 6.3853 19.175 0 0.1797-11.598 5.0334-12.027 5.0334-0.22101 0-0.47476-0.14434-0.57149-0.32507zm4.0067-8.3049c0.32316-0.38938 0.2724-1.0265-0.13421-1.6844-0.3788-0.61291-0.38116-0.63946-0.07596-0.85607 0.17323-0.12294 0.9956-0.74527 1.8275-1.3829 1.2903-0.98907 1.5203-1.2395 1.5657-1.7046 0.07311-0.74938-0.44134-2.26-0.7317-2.1485-0.57858 0.22203-4.7593 3.5317-4.9276 3.9008-0.27481 0.60315 0.01779 1.7125 0.75989 2.881 0.33868 0.53331 0.69792 1.0252 0.79831 1.0931 0.28795 0.19479 0.71242 0.14927 0.91801-0.0985zm79.765 7.5155c-1.2016-0.5139-3.6973-1.5786-5.5459-2.366-1.8486-0.78738-3.3839-1.452-3.4117-1.477-0.0278-0.025 2.8281-8.6566 6.3464-19.182l6.397-19.136-0.06 10.84c-0.033 5.9619-0.12851 11.178-0.21227 11.592l-0.15227 0.75199-1.7414-1.6763c-0.95776-0.92197-1.8841-1.7306-2.0584-1.7968-0.38352-0.1458-0.70716 0.29355-0.98047 1.331l-0.18608 0.7063 1.3908 1.3237c0.76496 0.72806 1.9721 1.8471 2.6826 2.4868l1.2917 1.1631 0.0107 7.9147c0.0101 7.4619-7e-3 7.9306-0.29662 8.1928-0.49632 0.44916-1.1594 0.3216-3.474-0.66831zm1.6041-8.3049c1.0338-1.1067 1.5617-3.5073 1.1101-5.0482-0.34817-1.1879-0.9474-1.8341-1.7007-1.8341-0.54457 0-0.58106-0.0398-0.83396-0.90978-0.33762-1.1613-1.0873-1.8581-1.8377-1.708-0.70051 0.1401-1.0076 0.46438-1.5191 1.6042-1.0771 2.4001-0.96085 4.6927 0.2976 5.8683 0.3466 0.32377 0.55376 0.38448 1.0739 0.31473 0.63184-0.0848 0.64862-0.0729 0.85904 0.60719 0.48345 1.5625 1.6513 2.0687 2.5508 1.1057zm-1.2637-2.6725c-0.3569-0.69018-0.32033-1.1206 0.12173-1.4325 0.35419-0.2499 0.39775-0.24277 0.68804 0.11264 0.47659 0.58351 0.18698 1.8-0.43163 1.8131-0.067 1e-3-0.23712-0.22055-0.37814-0.49325zm-2.3094-1.813c-0.42602-0.48504-0.49804-0.99099-0.23178-1.6282 0.29224-0.69943 0.65516-0.76742 1.0314-0.19324 0.6004 0.91632-0.13107 2.5826-0.79959 1.8215zm-65.842 8.4009c9.25e-4-0.16654 1.2582-2.3568 13.868-24.158 1.9246-3.3276 4.2341-7.3358 5.1322-8.9071s1.7738-3.0986 1.946-3.3939c0.17212-0.2953 1.7499-3.0342 3.5061-6.0865 1.7562-3.0523 3.2309-5.5499 3.2771-5.5504 0.04622-5e-4 0.72189 1.1125 1.5015 2.4732 0.77961 1.3607 2.072 3.6084 2.872 4.9949 0.8 1.3865 2.3457 4.0712 3.435 5.9661 1.0892 1.8948 2.2297 3.8611 2.5343 4.3695 0.30461 0.50839 2.9918 5.1594 5.9715 10.336 2.9797 5.1762 6.7672 11.743 8.4165 14.593 1.6494 2.8498 2.9989 5.251 2.9989 5.3359 0 0.0931-10.996 0.15436-27.73 0.15436-15.251 0-27.729-0.0567-27.729-0.12605zm37.606-8.4356c2.4648-1.3188 3.6068-3.7111 3.6144-7.572 0.0045-2.2651-0.29676-3.6156-1.1483-5.1478-0.6781-1.2201-1.4817-1.9684-2.7557-2.5659-0.80918-0.37954-1.1534-0.43714-2.6126-0.43714-1.495 0-1.785 0.0513-2.6258 0.46421-1.0411 0.51129-2.2839 1.7306-2.805 2.7521-0.73197 1.4348-0.94808 2.5596-0.94808 4.9345 0 3.1865 0.50517 4.7607 2.0617 6.4248 1.3064 1.3966 2.4489 1.8284 4.6533 1.7587 1.3454-0.0426 1.6289-0.11012 2.566-0.61148zm-3.9838-3.2286c-0.72061-0.67135-1.0689-1.7672-1.1531-3.6285-0.12287-2.7142 0.44092-4.7874 1.4237-5.2352 1.1673-0.53187 2.1977 0.0116 2.7626 1.4571 0.31808 0.81391 0.37614 1.2867 0.37614 3.0632 0 1.7765-0.05805 2.2493-0.37616 3.0632-0.20689 0.52938-0.57063 1.1155-0.80832 1.3024-0.5968 0.46945-1.7089 0.4583-2.2248-0.0223zm-7.8519 3.3688c0.76638-0.3492 1.0157-1.6194 0.54091-2.7557l-0.2418-0.57869-5.587-0.0922 1.9373-1.6493c2.1184-1.8035 2.7247-2.4823 3.3773-3.7816 1.2918-2.572 0.24707-5.451-2.4002-6.6139-1.7596-0.77292-5.36-0.53586-6.3971 0.4212-1.0543 0.97293-1.1503 2.2908-0.24282 3.3331 0.22626 0.25984 0.32044 0.24441 1.2809-0.20995 2.2631-1.0706 4.5125-0.29409 4.0847 1.4102-0.18523 0.73803-1.1046 1.7742-3.528 3.9764-1.4466 1.3146-2.5495 2.4567-2.7208 2.8177-0.33213 0.69991-0.36926 2.1791-0.06928 2.7601 0.11165 0.2162 0.35798 0.56327 0.5474 0.77125 0.34015 0.37345 0.39804 0.37813 4.6767 0.37813 2.8171 0 4.4756-0.0653 4.7418-0.18659zm-27.525 6.5688c-0.13758-0.37024-8.3083-24.636-11.307-33.58-2.1982-6.5563-2.5743-7.8215-2.3794-8.0036 0.13592-0.12697 1.9313-0.43792 4.3489-0.75321 2.2646-0.29532 4.9115-0.64726 5.8821-0.78208 5.8415-0.81144 30.822-4.0903 30.861-4.0508 0.02619 0.0262-0.27791 0.61163-0.67577 1.301-0.39786 0.68936-1.6153 2.8037-2.7055 4.6986-1.0901 1.8949-2.7 4.693-3.5774 6.2182-0.87745 1.5251-1.7177 2.9778-1.8672 3.2281-0.37435 0.62667-6.1822 10.663-7.6631 13.242-0.66341 1.1554-1.775 3.0839-2.4701 4.2855-0.69517 1.2016-2.7223 4.7182-4.5047 7.8147-4.0974 7.1182-3.8295 6.6845-3.9418 6.3822zm6.3119-25.215c1.5533-0.79245 3.4705-3.2576 4.1865-5.3831 0.45858-1.3613 0.43758-2.8954-0.05144-3.7588-0.81309-1.4355-2.4884-2.0759-3.9872-1.5241-1.1979 0.44108-1.2065 0.43729-1.4233-0.62702-0.31339-1.5388-1.4533-2.5163-2.9344-2.5163-1.0921 0-1.8935 0.39035-3.0329 1.4772-1.7199 1.6405-2.7727 3.7723-2.7754 5.6201-0.0019 1.323 0.38702 2.189 1.3162 2.9302 0.56334 0.4494 0.77734 0.51484 1.6806 0.51389 0.56928-6.7e-4 1.2325-0.0629 1.4739-0.13841 0.42633-0.13342 0.44219-0.11228 0.55521 0.73971 0.06399 0.48237 0.2578 1.1543 0.43068 1.4932 0.28181 0.55239 1.1741 1.3144 1.8524 1.5819 0.48186 0.19003 1.9782-0.0356 2.7091-0.40844zm-1.2994-3.3412c-0.54897-0.23164-1.0737-1.0079-1.0726-1.5869 2e-3-1.1103 0.31406-1.7664 1.0088-2.1208 1.1097-0.56611 2.2445-0.31639 2.6548 0.58422 0.28411 0.62356 0.25096 1.0554-0.14359 1.8704-0.5158 1.0655-1.5893 1.6152-2.4474 1.2531zm-4.8971-3.4612c-0.62581-0.26313-0.88216-0.69558-0.88216-1.4881 0-0.45709 0.14742-0.74715 0.64621-1.2715 0.66086-0.69471 1.0266-0.80174 1.7716-0.51848 0.98922 0.37611 1.2372 2.3857 0.36495 2.9572-0.6811 0.44628-1.3384 0.55724-1.9007 0.32085zm55.728 27.013c-4.2797-7.4421-9.6077-16.68-10.633-18.435-0.48578-0.83188-2.0813-3.5922-3.5456-6.1341-1.4643-2.5419-4.17-7.2307-6.0128-10.42-4.3995-7.6135-4.1825-7.2265-4.052-7.2265 0.06271 0 3.7527 0.48721 8.1999 1.0827 4.4473 0.59547 13.569 1.8106 20.27 2.7004 9.8763 1.3113 12.241 1.6732 12.484 1.9107 0.28709 0.28062 0.17877 0.65513-2.5609 8.8536-1.5734 4.7083-3.2113 9.5816-3.6398 10.829-0.42849 1.2478-2.2501 6.6551-4.0481 12.016-1.7979 5.3611-3.32 9.8-3.3824 9.8643-0.0624 0.0643-1.4483-2.2045-3.08-5.0418zm-0.6831-18.782c0.20596-0.14426 0.48383-0.47375 0.61748-0.73222 0.23687-0.45804 0.21139-0.51585-1.0084-2.2875-0.68827-0.99968-1.2226-1.8464-1.1875-1.8815 0.0352-0.0352 0.77211 0.2368 1.6376 0.60438 2.3724 1.0075 3.8182 1.1734 4.9388 0.56652 0.60712-0.32878 1.2251-1.1247 1.4069-1.812 0.68407-2.586-2.5419-7.8037-4.827-7.8072-0.77149-1e-3-1.5433 0.77246-1.5371 1.5408 4e-3 0.47233 0.1116 0.62433 0.69441 0.97926 0.7699 0.46887 1.8899 1.8608 2.0524 2.5507 0.0986 0.41846-0.21118 0.98219-0.53653 0.9765-0.38385-7e-3-2.112-0.5896-4.1721-1.4072-1.3076-0.51898-2.5946-0.94359-2.86-0.94359-0.76381 0-1.6638 0.71293-1.856 1.4703-0.0906 0.35691-0.10447 0.81181-0.03083 1.0109 0.1587 0.429 4.4627 6.7054 4.8939 7.1365 0.36801 0.36802 1.2732 0.38611 1.7738 0.0355zm-66.841 11.332c-0.18989-0.31146-0.34554-0.75745-0.34588-0.99108-7.48e-4-0.50612 0.4285-1.1718 0.75564-1.1718 0.36936 0 0.75626 0.69198 0.75626 1.3526 0 0.42478-0.12251 0.72064-0.41038 0.99108l-0.41038 0.38553zm6.1237-34.604c6.481-3.7574 12.198-7.0611 21.932-12.674 5.6139-3.2373 7.522-4.3435 10.197-5.9112 0.84788-0.49697 1.6231-0.90359 1.7226-0.90359 0.12692 0 0.181 2.5498 0.181 8.5332v8.5332l-18.781 2.4947c-10.329 1.3721-19.045 2.531-19.369 2.5754-0.42039 0.0577 0.75433-0.69769 4.1174-2.6474zm17.554-2.361c0.46671-0.1001 0.84856-0.25079 0.84856-0.33488 0-0.0841 0.75626-1.7156 1.6806-3.6255 0.92432-1.9099 1.6806-3.6418 1.6806-3.8486 0-0.71758-0.8024-0.65481-2.6991 0.21112-1.1814 0.53938-1.8385 1.1957-1.8385 1.8364 0 0.46471 0.22903 0.4953 1.0719 0.14314 0.3348-0.13989 0.60873-0.22338 0.60873-0.18554 0 0.0378-0.52777 1.1347-1.1728 2.4375-1.2266 2.4773-1.4521 3.0759-1.2699 3.3707 0.13362 0.21621 0.06014 0.2165 1.09-4e-3zm7.1297-1.2433c2.0115-1.0177 4.2078-4.0854 4.4197-6.1731 0.07545-0.74333 0.03038-0.96402-0.27579-1.3507-0.32344-0.40845-0.47861-0.46216-1.3353-0.46216-0.74049 0-1.2072 0.11886-1.977 0.50353-2.2007 1.0997-4.3741 4.1083-4.5499 6.2983-0.07471 0.93071-0.04058 1.0984 0.29119 1.4301 0.53978 0.53978 2.0946 0.42818 3.4271-0.246zm-1.4509-1.4737c-0.21502-0.63193 1.1111-3.3774 2.0145-4.1706 0.76453-0.67127 1.4482-0.63661 1.5297 0.0776 0.07592 0.66519-1.01 2.8208-1.8383 3.649-0.66814 0.66814-1.5514 0.89804-1.7059 0.44401zm31.975 5.2273c-10.306-1.3797-18.833-2.5412-18.949-2.5812-0.16433-0.0568-0.21007-1.9218-0.21007-8.5648 0-5.1598 0.0617-8.4922 0.15724-8.4922 0.08648 0 2.3364 1.2583 4.9997 2.7962 2.6634 1.5379 5.8635 3.3807 7.1113 4.0951 3.0313 1.7356 13.647 7.8684 15.545 8.9805 0.83189 0.48743 3.5922 2.0802 6.1341 3.5396 2.5419 1.4594 4.6531 2.6802 4.6916 2.7129 0.15612 0.13263-1.4784-0.076-19.481-2.486zm0.12998-2.6748c0.02739-0.14224-0.12571-0.51951-0.34023-0.83836-0.37147-0.55214-0.47575-0.59568-2.1906-0.91456-0.99032-0.18414-1.8005-0.37321-1.8003-0.42014 1.65e-4-0.0469 0.34043-0.30021 0.75615-0.56285 1.456-0.91986 1.7099-1.6077 1.0764-2.9163-0.82295-1.7-3.8199-3.2142-6.0343-3.0488-0.67445 0.0504-0.76181 0.1043-0.8075 0.49854-0.03275 0.28256 0.09793 0.61548 0.36216 0.92267 0.38128 0.44326 0.49163 0.47673 1.4203 0.4307 1.1795-0.0585 2.0663 0.25334 2.4691 0.8682 0.37256 0.56859 0.1918 0.87015-1.1721 1.9554-1.3514 1.0753-1.431 1.5086-0.46535 2.5323 0.62072 0.65803 0.67202 0.67671 3.4032 1.239 3.0193 0.62167 3.2489 0.63923 3.3231 0.25419zm-8.0287-1.0942c0-0.053-0.6824-1.6978-1.5164-3.6553-1.6304-3.8264-1.969-4.3228-3.1697-4.6461-0.37368-0.10063-1.0956-0.13107-1.6452-0.0694-1.5473 0.17368-1.7417 0.5029-0.87785 1.4868 0.45977 0.52365 0.61631 0.59405 1.3209 0.59405h0.79929l1.1389 2.6469c0.6264 1.4558 1.2678 2.784 1.4254 2.9516 0.47308 0.50325 2.5247 1.0651 2.5247 0.69137z"/></svg>
                            </div>
                            <div class="dice-check-large" id="dice-3" onclick="rollZweiteChance(2)" title="Klicken um Zweite Chance zu nutzen">
                                <svg viewBox="0 0 100 100"><path d="m49.355 99.528c-0.24708-0.25657-1.6214-1.7492-3.0541-3.317-2.3047-2.5219-3.516-3.8292-5.2938-5.7131-0.2773-0.29384-1.5251-1.6542-2.773-3.0229-2.3561-2.5844-5.1488-5.6429-7.9097-8.6624-0.88412-0.96693-2.926-3.1848-4.5376-4.9285-1.6116-1.7438-2.9553-3.2374-2.9861-3.3192-0.03234-0.0858 11.461-0.14867 27.183-0.14867 14.982 0 27.24 0.0489 27.24 0.10862 0 0.0597-0.35576 0.49459-0.79058 0.96634-0.43482 0.47174-1.5941 1.7274-2.5761 2.7904-2.0061 2.1714-6.6115 7.1835-16.129 17.553-7.9441 8.6552-7.4759 8.1604-7.7209 8.1604-0.11174 0-0.40531-0.20993-0.65239-0.46651zm-3.7748-13.817c0.39727-2e-3 0.81169-0.3825 3.5099-3.2228 2.3664-2.491 2.4207-2.5693 2.4207-3.4926 0-0.64199-0.08645-0.869-0.47136-1.2378-0.47061-0.45088-0.47552-0.4516-3.1091-0.4516h-2.6377v-0.58029c0-0.77677-0.29798-1.3867-0.73474-1.5039-0.66048-0.17724-2.2232-0.10269-2.5286 0.12063-0.23999 0.1755-0.29005 0.40128-0.24219 1.0925l0.06032 0.87127-0.72189-1e-4c-0.54246-8e-5-0.82442 0.10243-1.1344 0.4124-0.46236 0.46236-0.49288 0.65126-0.22801 1.4111 0.17624 0.50555 0.22516 0.52926 1.0924 0.52926h0.90788l0.0018 2.0587c0.0024 2.6671 0.10714 3.2727 0.62472 3.6118 0.53088 0.34786 1.4868 0.54218 2.2304 0.45344 0.32351-0.0386 0.75546-0.071 0.95989-0.072zm-0.45571-4.4549v-1.597h2.7298l-0.8107 0.96633c-0.44588 0.53148-1.0601 1.2502-1.3649 1.597l-0.55419 0.6307zm12.321 4.2144c0.8131-0.22371 1.6667-0.53017 1.897-0.68103 0.80329-0.52633 0.85761-1.4792 0.12208-2.1415-0.29264-0.26347-0.39883-0.26725-1.2377-0.044-0.50468 0.1343-0.97433 0.24508-1.0437 0.24618-0.06933 1e-3-0.12605-1.54-0.12605-3.4246 0-4.0332-0.0313-4.1238-1.4718-4.2622-0.4742-0.0456-1.1311-0.0324-1.4598 0.0293l-0.59765 0.11213v4.625c0 4.7022 0.05332 5.1523 0.65475 5.5273 0.78945 0.49217 1.5119 0.49514 3.2628 0.0134zm-15.934 10.222c-1.4789-0.86882-3.3696-1.9615-4.2015-2.4283-0.83189-0.46671-2.231-1.269-3.1091-1.783-0.87811-0.5139-2.1638-1.2552-2.857-1.6474-1.1159-0.63127-6.3995-3.7016-7.0585-4.1017-0.16478-0.10005 0.01413-0.12419 0.51658-0.0697 1.0579 0.11473 2.0979-0.40834 2.2576-1.1355 0.18747-0.85356-0.60997-2.1791-2.2134-3.6793-1.6671-1.5597-2.903-2.2412-3.9281-2.1659-0.87311 0.0642-1.0924 0.35849-0.9267 1.2436 0.09952 0.53145 0.40876 0.93983 1.6115 2.1282 0.85734 0.84704 1.3737 1.4705 1.2179 1.4705-0.53059 0-1.7144-0.8545-2.7635-1.9948-1.1112-1.2078-1.7484-1.5858-1.9198-1.139-0.14181 0.36954 0.20176 0.9087 1.326 2.0809l1.0049 1.0478-3.1753-1.8243c-7.5298-4.3261-9.5448-5.5157-9.5908-5.6619-0.0413-0.13126 11.913-5.2904 12.243-5.2835 0.06231 1e-3 2.5958 2.7035 5.63 6.0049 3.0342 3.3014 7.3653 8.0091 9.6247 10.462 2.2594 2.4525 4.8266 5.2532 5.7049 6.2237 0.87829 0.97054 2.0525 2.2373 2.6094 2.815 0.55691 0.57771 0.93912 1.043 0.84935 1.034-0.08977-9e-3-1.3732-0.72718-2.8521-1.596zm-11.008-11.851c0-0.16876-3.1603-3.806-4.474-5.1492-0.56794-0.58069-1.1402-0.69509-1.6419-0.32824-0.27162 0.19861-0.11049 0.43344 1.8161 2.6469 1.1628 1.3359 2.3223 2.5609 2.5767 2.7222 0.51342 0.32542 1.7231 0.40145 1.7231 0.10829zm27.785 10.48c2.7071-2.9298 5.6036-6.0821 16.292-17.73 2.9473-3.212 5.4213-5.84 5.4977-5.84 0.1134 0 3.2765 1.3251 11.923 4.9947l0.57582 0.24439-0.49178 0.29554c-0.50069 0.30087-2.6666 1.5541-7.6343 4.4173-1.5251 0.87902-4.7393 2.7344-7.1425 4.123-2.4032 1.3886-6.5627 3.789-9.2432 5.3342-6.2842 3.6225-7.7929 4.4953-10.283 5.9487-1.1263 0.6575-2.0933 1.1954-2.1488 1.1954s1.1393-1.3424 2.6553-2.983zm15.411-11.055 0.6075-0.5932 1.5614 0.603c1.3194 0.50957 1.6385 0.57613 2.0591 0.42951 0.62617-0.21829 1.4067-0.85993 2.1111-1.7354l0.54619-0.67886v-2.4934c0-2.486-1e-3-2.4942-0.42777-2.7736-0.78128-0.51191-1.4935-0.12225-3.4114 1.8664l-1.6992 1.7619-0.76243-0.1045c-0.74918-0.10269-0.77844-0.0885-1.6843 0.81741-0.50705 0.50706-0.92192 1.0017-0.92192 1.0991 0 0.0975 0.22688 0.25627 0.50418 0.35295 0.61346 0.21385 0.62719 0.3552 0.084 0.86547-0.40713 0.38248-0.53797 0.8345-0.3081 1.0644 0.31743 0.31743 1.1631 0.0838 1.7417-0.48117zm3.5547-2.4184c-0.3991-0.15832-0.70984-0.35845-0.69053-0.44474 0.0193-0.0863 0.3602-0.52851 0.75753-0.98272 0.69095-0.78986 0.72626-0.80816 0.81051-0.42015 0.17368 0.79996 0.18398 2.1705 0.0162 2.153-0.09239-0.01-0.4946-0.14706-0.8937-0.30538zm-53.622 1.7656c-0.59744-0.44078-1.1959-1.1577-1.1959-1.4326 0-0.30204 0.44464-0.38937 0.86918-0.17069 0.67218 0.34622 1.3156 1.0477 1.3156 1.4344 0 0.53897-0.39574 0.60657-0.98891 0.16895zm-17.324-9.1625c-0.11287-0.2109-0.17397-3.1085-0.17397-8.2498v-7.9247l0.50912 0.4284c1.0142 0.85342 2.3042 0.68805 3.5028-0.44905 1.2455-1.1815 1.6707-3.079 1.1375-5.0753-0.51715-1.936-1.3598-2.941-2.4657-2.941-0.51111 0-0.73028 0.11175-1.1446 0.5836-0.49742 0.56653-0.86402 1.4963-0.86593 2.1961-0.0018 0.67533 0.5256 2.3576 0.93316 2.9763 0.38976 0.59168 0.39529 0.63021 0.09039 0.63021-0.58952 0-0.86637-0.20134-1.2417-0.90303l-0.37097-0.69352-0.04109-11.764-0.04109-11.764 6.3853 19.067c3.5119 10.487 6.3853 19.115 6.3853 19.175 0 0.1797-11.598 5.0334-12.027 5.0334-0.22101 0-0.47476-0.14434-0.57149-0.32507zm4.0067-8.3049c0.32316-0.38938 0.2724-1.0265-0.13421-1.6844-0.3788-0.61291-0.38116-0.63946-0.07596-0.85607 0.17323-0.12294 0.9956-0.74527 1.8275-1.3829 1.2903-0.98907 1.5203-1.2395 1.5657-1.7046 0.07311-0.74938-0.44134-2.26-0.7317-2.1485-0.57858 0.22203-4.7593 3.5317-4.9276 3.9008-0.27481 0.60315 0.01779 1.7125 0.75989 2.881 0.33868 0.53331 0.69792 1.0252 0.79831 1.0931 0.28795 0.19479 0.71242 0.14927 0.91801-0.0985zm79.765 7.5155c-1.2016-0.5139-3.6973-1.5786-5.5459-2.366-1.8486-0.78738-3.3839-1.452-3.4117-1.477-0.0278-0.025 2.8281-8.6566 6.3464-19.182l6.397-19.136-0.06 10.84c-0.033 5.9619-0.12851 11.178-0.21227 11.592l-0.15227 0.75199-1.7414-1.6763c-0.95776-0.92197-1.8841-1.7306-2.0584-1.7968-0.38352-0.1458-0.70716 0.29355-0.98047 1.331l-0.18608 0.7063 1.3908 1.3237c0.76496 0.72806 1.9721 1.8471 2.6826 2.4868l1.2917 1.1631 0.0107 7.9147c0.0101 7.4619-7e-3 7.9306-0.29662 8.1928-0.49632 0.44916-1.1594 0.3216-3.474-0.66831zm1.6041-8.3049c1.0338-1.1067 1.5617-3.5073 1.1101-5.0482-0.34817-1.1879-0.9474-1.8341-1.7007-1.8341-0.54457 0-0.58106-0.0398-0.83396-0.90978-0.33762-1.1613-1.0873-1.8581-1.8377-1.708-0.70051 0.1401-1.0076 0.46438-1.5191 1.6042-1.0771 2.4001-0.96085 4.6927 0.2976 5.8683 0.3466 0.32377 0.55376 0.38448 1.0739 0.31473 0.63184-0.0848 0.64862-0.0729 0.85904 0.60719 0.48345 1.5625 1.6513 2.0687 2.5508 1.1057zm-1.2637-2.6725c-0.3569-0.69018-0.32033-1.1206 0.12173-1.4325 0.35419-0.2499 0.39775-0.24277 0.68804 0.11264 0.47659 0.58351 0.18698 1.8-0.43163 1.8131-0.067 1e-3-0.23712-0.22055-0.37814-0.49325zm-2.3094-1.813c-0.42602-0.48504-0.49804-0.99099-0.23178-1.6282 0.29224-0.69943 0.65516-0.76742 1.0314-0.19324 0.6004 0.91632-0.13107 2.5826-0.79959 1.8215zm-65.842 8.4009c9.25e-4-0.16654 1.2582-2.3568 13.868-24.158 1.9246-3.3276 4.2341-7.3358 5.1322-8.9071s1.7738-3.0986 1.946-3.3939c0.17212-0.2953 1.7499-3.0342 3.5061-6.0865 1.7562-3.0523 3.2309-5.5499 3.2771-5.5504 0.04622-5e-4 0.72189 1.1125 1.5015 2.4732 0.77961 1.3607 2.072 3.6084 2.872 4.9949 0.8 1.3865 2.3457 4.0712 3.435 5.9661 1.0892 1.8948 2.2297 3.8611 2.5343 4.3695 0.30461 0.50839 2.9918 5.1594 5.9715 10.336 2.9797 5.1762 6.7672 11.743 8.4165 14.593 1.6494 2.8498 2.9989 5.251 2.9989 5.3359 0 0.0931-10.996 0.15436-27.73 0.15436-15.251 0-27.729-0.0567-27.729-0.12605zm37.606-8.4356c2.4648-1.3188 3.6068-3.7111 3.6144-7.572 0.0045-2.2651-0.29676-3.6156-1.1483-5.1478-0.6781-1.2201-1.4817-1.9684-2.7557-2.5659-0.80918-0.37954-1.1534-0.43714-2.6126-0.43714-1.495 0-1.785 0.0513-2.6258 0.46421-1.0411 0.51129-2.2839 1.7306-2.805 2.7521-0.73197 1.4348-0.94808 2.5596-0.94808 4.9345 0 3.1865 0.50517 4.7607 2.0617 6.4248 1.3064 1.3966 2.4489 1.8284 4.6533 1.7587 1.3454-0.0426 1.6289-0.11012 2.566-0.61148zm-3.9838-3.2286c-0.72061-0.67135-1.0689-1.7672-1.1531-3.6285-0.12287-2.7142 0.44092-4.7874 1.4237-5.2352 1.1673-0.53187 2.1977 0.0116 2.7626 1.4571 0.31808 0.81391 0.37614 1.2867 0.37614 3.0632 0 1.7765-0.05805 2.2493-0.37616 3.0632-0.20689 0.52938-0.57063 1.1155-0.80832 1.3024-0.5968 0.46945-1.7089 0.4583-2.2248-0.0223zm-7.8519 3.3688c0.76638-0.3492 1.0157-1.6194 0.54091-2.7557l-0.2418-0.57869-5.587-0.0922 1.9373-1.6493c2.1184-1.8035 2.7247-2.4823 3.3773-3.7816 1.2918-2.572 0.24707-5.451-2.4002-6.6139-1.7596-0.77292-5.36-0.53586-6.3971 0.4212-1.0543 0.97293-1.1503 2.2908-0.24282 3.3331 0.22626 0.25984 0.32044 0.24441 1.2809-0.20995 2.2631-1.0706 4.5125-0.29409 4.0847 1.4102-0.18523 0.73803-1.1046 1.7742-3.528 3.9764-1.4466 1.3146-2.5495 2.4567-2.7208 2.8177-0.33213 0.69991-0.36926 2.1791-0.06928 2.7601 0.11165 0.2162 0.35798 0.56327 0.5474 0.77125 0.34015 0.37345 0.39804 0.37813 4.6767 0.37813 2.8171 0 4.4756-0.0653 4.7418-0.18659zm-27.525 6.5688c-0.13758-0.37024-8.3083-24.636-11.307-33.58-2.1982-6.5563-2.5743-7.8215-2.3794-8.0036 0.13592-0.12697 1.9313-0.43792 4.3489-0.75321 2.2646-0.29532 4.9115-0.64726 5.8821-0.78208 5.8415-0.81144 30.822-4.0903 30.861-4.0508 0.02619 0.0262-0.27791 0.61163-0.67577 1.301-0.39786 0.68936-1.6153 2.8037-2.7055 4.6986-1.0901 1.8949-2.7 4.693-3.5774 6.2182-0.87745 1.5251-1.7177 2.9778-1.8672 3.2281-0.37435 0.62667-6.1822 10.663-7.6631 13.242-0.66341 1.1554-1.775 3.0839-2.4701 4.2855-0.69517 1.2016-2.7223 4.7182-4.5047 7.8147-4.0974 7.1182-3.8295 6.6845-3.9418 6.3822zm6.3119-25.215c1.5533-0.79245 3.4705-3.2576 4.1865-5.3831 0.45858-1.3613 0.43758-2.8954-0.05144-3.7588-0.81309-1.4355-2.4884-2.0759-3.9872-1.5241-1.1979 0.44108-1.2065 0.43729-1.4233-0.62702-0.31339-1.5388-1.4533-2.5163-2.9344-2.5163-1.0921 0-1.8935 0.39035-3.0329 1.4772-1.7199 1.6405-2.7727 3.7723-2.7754 5.6201-0.0019 1.323 0.38702 2.189 1.3162 2.9302 0.56334 0.4494 0.77734 0.51484 1.6806 0.51389 0.56928-6.7e-4 1.2325-0.0629 1.4739-0.13841 0.42633-0.13342 0.44219-0.11228 0.55521 0.73971 0.06399 0.48237 0.2578 1.1543 0.43068 1.4932 0.28181 0.55239 1.1741 1.3144 1.8524 1.5819 0.48186 0.19003 1.9782-0.0356 2.7091-0.40844zm-1.2994-3.3412c-0.54897-0.23164-1.0737-1.0079-1.0726-1.5869 2e-3-1.1103 0.31406-1.7664 1.0088-2.1208 1.1097-0.56611 2.2445-0.31639 2.6548 0.58422 0.28411 0.62356 0.25096 1.0554-0.14359 1.8704-0.5158 1.0655-1.5893 1.6152-2.4474 1.2531zm-4.8971-3.4612c-0.62581-0.26313-0.88216-0.69558-0.88216-1.4881 0-0.45709 0.14742-0.74715 0.64621-1.2715 0.66086-0.69471 1.0266-0.80174 1.7716-0.51848 0.98922 0.37611 1.2372 2.3857 0.36495 2.9572-0.6811 0.44628-1.3384 0.55724-1.9007 0.32085zm55.728 27.013c-4.2797-7.4421-9.6077-16.68-10.633-18.435-0.48578-0.83188-2.0813-3.5922-3.5456-6.1341-1.4643-2.5419-4.17-7.2307-6.0128-10.42-4.3995-7.6135-4.1825-7.2265-4.052-7.2265 0.06271 0 3.7527 0.48721 8.1999 1.0827 4.4473 0.59547 13.569 1.8106 20.27 2.7004 9.8763 1.3113 12.241 1.6732 12.484 1.9107 0.28709 0.28062 0.17877 0.65513-2.5609 8.8536-1.5734 4.7083-3.2113 9.5816-3.6398 10.829-0.42849 1.2478-2.2501 6.6551-4.0481 12.016-1.7979 5.3611-3.32 9.8-3.3824 9.8643-0.0624 0.0643-1.4483-2.2045-3.08-5.0418zm-0.6831-18.782c0.20596-0.14426 0.48383-0.47375 0.61748-0.73222 0.23687-0.45804 0.21139-0.51585-1.0084-2.2875-0.68827-0.99968-1.2226-1.8464-1.1875-1.8815 0.0352-0.0352 0.77211 0.2368 1.6376 0.60438 2.3724 1.0075 3.8182 1.1734 4.9388 0.56652 0.60712-0.32878 1.2251-1.1247 1.4069-1.812 0.68407-2.586-2.5419-7.8037-4.827-7.8072-0.77149-1e-3-1.5433 0.77246-1.5371 1.5408 4e-3 0.47233 0.1116 0.62433 0.69441 0.97926 0.7699 0.46887 1.8899 1.8608 2.0524 2.5507 0.0986 0.41846-0.21118 0.98219-0.53653 0.9765-0.38385-7e-3-2.112-0.5896-4.1721-1.4072-1.3076-0.51898-2.5946-0.94359-2.86-0.94359-0.76381 0-1.6638 0.71293-1.856 1.4703-0.0906 0.35691-0.10447 0.81181-0.03083 1.0109 0.1587 0.429 4.4627 6.7054 4.8939 7.1365 0.36801 0.36802 1.2732 0.38611 1.7738 0.0355zm-66.841 11.332c-0.18989-0.31146-0.34554-0.75745-0.34588-0.99108-7.48e-4-0.50612 0.4285-1.1718 0.75564-1.1718 0.36936 0 0.75626 0.69198 0.75626 1.3526 0 0.42478-0.12251 0.72064-0.41038 0.99108l-0.41038 0.38553zm6.1237-34.604c6.481-3.7574 12.198-7.0611 21.932-12.674 5.6139-3.2373 7.522-4.3435 10.197-5.9112 0.84788-0.49697 1.6231-0.90359 1.7226-0.90359 0.12692 0 0.181 2.5498 0.181 8.5332v8.5332l-18.781 2.4947c-10.329 1.3721-19.045 2.531-19.369 2.5754-0.42039 0.0577 0.75433-0.69769 4.1174-2.6474zm17.554-2.361c0.46671-0.1001 0.84856-0.25079 0.84856-0.33488 0-0.0841 0.75626-1.7156 1.6806-3.6255 0.92432-1.9099 1.6806-3.6418 1.6806-3.8486 0-0.71758-0.8024-0.65481-2.6991 0.21112-1.1814 0.53938-1.8385 1.1957-1.8385 1.8364 0 0.46471 0.22903 0.4953 1.0719 0.14314 0.3348-0.13989 0.60873-0.22338 0.60873-0.18554 0 0.0378-0.52777 1.1347-1.1728 2.4375-1.2266 2.4773-1.4521 3.0759-1.2699 3.3707 0.13362 0.21621 0.06014 0.2165 1.09-4e-3zm7.1297-1.2433c2.0115-1.0177 4.2078-4.0854 4.4197-6.1731 0.07545-0.74333 0.03038-0.96402-0.27579-1.3507-0.32344-0.40845-0.47861-0.46216-1.3353-0.46216-0.74049 0-1.2072 0.11886-1.977 0.50353-2.2007 1.0997-4.3741 4.1083-4.5499 6.2983-0.07471 0.93071-0.04058 1.0984 0.29119 1.4301 0.53978 0.53978 2.0946 0.42818 3.4271-0.246zm-1.4509-1.4737c-0.21502-0.63193 1.1111-3.3774 2.0145-4.1706 0.76453-0.67127 1.4482-0.63661 1.5297 0.0776 0.07592 0.66519-1.01 2.8208-1.8383 3.649-0.66814 0.66814-1.5514 0.89804-1.7059 0.44401zm31.975 5.2273c-10.306-1.3797-18.833-2.5412-18.949-2.5812-0.16433-0.0568-0.21007-1.9218-0.21007-8.5648 0-5.1598 0.0617-8.4922 0.15724-8.4922 0.08648 0 2.3364 1.2583 4.9997 2.7962 2.6634 1.5379 5.8635 3.3807 7.1113 4.0951 3.0313 1.7356 13.647 7.8684 15.545 8.9805 0.83189 0.48743 3.5922 2.0802 6.1341 3.5396 2.5419 1.4594 4.6531 2.6802 4.6916 2.7129 0.15612 0.13263-1.4784-0.076-19.481-2.486zm0.12998-2.6748c0.02739-0.14224-0.12571-0.51951-0.34023-0.83836-0.37147-0.55214-0.47575-0.59568-2.1906-0.91456-0.99032-0.18414-1.8005-0.37321-1.8003-0.42014 1.65e-4-0.0469 0.34043-0.30021 0.75615-0.56285 1.456-0.91986 1.7099-1.6077 1.0764-2.9163-0.82295-1.7-3.8199-3.2142-6.0343-3.0488-0.67445 0.0504-0.76181 0.1043-0.8075 0.49854-0.03275 0.28256 0.09793 0.61548 0.36216 0.92267 0.38128 0.44326 0.49163 0.47673 1.4203 0.4307 1.1795-0.0585 2.0663 0.25334 2.4691 0.8682 0.37256 0.56859 0.1918 0.87015-1.1721 1.9554-1.3514 1.0753-1.431 1.5086-0.46535 2.5323 0.62072 0.65803 0.67202 0.67671 3.4032 1.239 3.0193 0.62167 3.2489 0.63923 3.3231 0.25419zm-8.0287-1.0942c0-0.053-0.6824-1.6978-1.5164-3.6553-1.6304-3.8264-1.969-4.3228-3.1697-4.6461-0.37368-0.10063-1.0956-0.13107-1.6452-0.0694-1.5473 0.17368-1.7417 0.5029-0.87785 1.4868 0.45977 0.52365 0.61631 0.59405 1.3209 0.59405h0.79929l1.1389 2.6469c0.6264 1.4558 1.2678 2.784 1.4254 2.9516 0.47308 0.50325 2.5247 1.0651 2.5247 0.69137z"/></svg>
                            </div>
                        </div>
                        <div class="status-info-box" style="margin-top: var(--gap-sm);">
                            <div class="status-info-row">
                                <span class="status-info-icon" style="color: var(--text-muted);">●</span>
                                <span class="status-info-text">Wenn du eine Probe verfehlst, darfst du einen W20 werfen</span>
                            </div>
                            <div class="status-info-row">
                                <span class="status-info-icon" style="color: var(--accent-primary);">●</span>
                                <span class="status-info-text">1–5 = Der Fehlschlag bleibt bestehen</span>
                            </div>
                            <div class="status-info-row">
                                <span class="status-info-icon" style="color: var(--color-green);">●</span>
                                <span class="status-info-text">6–20 = Du darfst die ursprüngliche Probe einmal wiederholen</span>
                            </div>
                            <div class="status-info-row">
                                <span class="status-info-icon" style="color: var(--text-muted);">●</span>
                                <span class="status-info-text" style="font-style: italic;">Nur unmittelbar nach dem Fehlschlag einsetzbar</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- WÄHRUNG & WAFFE -->
                <div class="card">
                    <div class="card-header">
                        <span class="card-title"><span class="card-title-icon">paid</span> Währung & Waffe</span>
                    </div>
                    <div class="card-body side-card">
                        <div class="currency-row-inline">
                            <span class="currency-label">Währung</span>
                            <img src="assets/icons/icon_dollar.png" alt="Currency" class="currency-icon" id="currency-icon" onclick="rotateCurrency()">
                            <input type="text" class="currency-input-inline" id="char-currency" placeholder="0" oninput="formatCurrency(this)">
                        </div>
                        <div class="currency-row-inline">
                            <span class="currency-label">Waffe</span>
                            <span class="card-title-icon weapon-icon">swords</span>
                            <input type="text" class="currency-input-inline weapon-input" id="char-weapon" placeholder="z.B. Schwert, Pistole...">
                        </div>
                    </div>
                </div>
            </div>

            <!-- INVENTAR & NOTIZEN - Full Width -->
            <div class="card">
                <div class="card-header">
                    <span class="card-title"><span class="card-title-icon">backpack</span> Inventar & Notizen</span>
                </div>
                <div class="card-body">
                    <div class="text-areas-row">
                        <textarea class="inventory-textarea" id="char-inventory" placeholder="Inventar..."></textarea>
                        <textarea class="notes-textarea" id="char-notes" placeholder="Notizen..."></textarea>
                    </div>
                    <div class="action-buttons">
                        <button class="action-btn primary" id="mainCharBtn" onclick="toggleMainCharacter()">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/>
                            </svg>
                            <span id="mainCharBtnText">Hauptcharakter</span>
                        </button>
                        <button class="action-btn" onclick="document.getElementById('import-file').click()">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                                <polyline points="17 8 12 3 7 8"/>
                                <line x1="12" y1="3" x2="12" y2="15"/>
                            </svg>
                            Importieren
                        </button>
                        <button class="action-btn" onclick="exportCharacter()">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                                <polyline points="7 10 12 15 17 10"/>
                                <line x1="12" y1="15" x2="12" y2="3"/>
                            </svg>
                            Exportieren
                        </button>
                        <button class="action-btn danger" onclick="resetCharacter()">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <polyline points="3 6 5 6 21 6"/>
                                <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/>
                            </svg>
                            Reset
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- WÜRFEL-VERLAUF -->
            <div class="card">
                <div class="card-header">
                    <span class="card-title"><span class="card-title-icon">casino</span> Würfel-Verlauf</span>
                    <button class="card-action-btn" onclick="clearDiceHistory()" title="Verlauf löschen">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M3 6h18"/>
                            <path d="M8 6V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/>
                            <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6"/>
                            <path d="M10 11v6"/>
                            <path d="M14 11v6"/>
                        </svg>
                    </button>
                </div>
                <div class="card-body">
                    <div class="dice-history-list" id="dice-history-list">
                        <div class="dice-history-empty">Noch keine Würfe in dieser Session</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Fokus Popup -->
    <div class="popup-overlay" id="fokus-popup">
        <div class="popup">
            <div class="popup-header">
                <span class="popup-title">Fokus wählen</span>
                <button class="popup-close" onclick="closeFokusPopup()">×</button>
            </div>
            <div class="popup-body">
                <div class="fokus-type-grid" id="fokus-type-grid"></div>
                <div id="fokus-abilities-container"></div>
            </div>
            <div class="popup-footer">
                <span class="popup-info" id="fokus-selection-info">Wähle einen Fokus-Typ</span>
                <button class="popup-btn popup-btn-primary" id="fokus-confirm-btn" onclick="confirmFokusSelection()" disabled>Bestätigen</button>
            </div>
        </div>
    </div>

    <!-- Schwäche Popup -->
    <div class="popup-overlay" id="schwaeche-popup">
        <div class="popup">
            <div class="popup-header">
                <span class="popup-title">Schwäche wählen</span>
                <button class="popup-close" onclick="closeSchwaechePopup()">×</button>
            </div>
            <div class="popup-body">
                <div class="schwaeche-grid" id="schwaeche-grid"></div>
            </div>
            <div class="popup-footer">
                <button class="popup-btn" onclick="clearSchwaeche()">Keine Schwäche</button>
                <button class="popup-btn popup-btn-primary" id="schwaeche-confirm-btn" onclick="confirmSchwaecheSelection()">Bestätigen</button>
            </div>
        </div>
    </div>

    <!-- Skill Catalog Popup -->
    <div class="popup-overlay" id="skill-catalog-popup">
        <div class="popup popup-wide">
            <div class="popup-header">
                <span class="popup-title">Fähigkeiten-Katalog</span>
                <button class="popup-close" onclick="closeSkillCatalog()">×</button>
            </div>
            <div class="popup-body">
                <div class="catalog-grid" id="catalog-grid"></div>
            </div>
        </div>
    </div>

    <!-- Hidden Inputs -->
    <input type="file" id="portrait-upload" class="hidden-input" accept="image/*" onchange="uploadPortrait(event)">
    <input type="file" id="jolly-upload" class="hidden-input" accept="image/*" onchange="uploadJolly(event)">
    <input type="file" id="import-file" class="hidden-input" accept=".json" onchange="importCharacter(event)">

    <!-- Save Indicator -->
    <div class="save-indicator" id="save-indicator">
        <svg viewBox="0 0 24 24" fill="currentColor"><path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/></svg>
        Gespeichert
    </div>

    <script>
        'use strict';
        
        // ===== AUTH & NAVIGATION =====
        if (typeof requireAuth === 'function') {
            requireAuth();
        }
        
        // Initialize RIFT Layout (Sidebar, Topbar, Footer)
        document.addEventListener('DOMContentLoaded', function() {
            if (typeof initLayout === 'function') {
                initLayout();
            }
        });

        // ===== BACKGROUND IMAGE =====
        const bgNumber = String(Math.floor(Math.random() * 11) + 1).padStart(3, '0');
        document.getElementById('bgContainer').style.backgroundImage = `url('assets/bg/bg_${bgNumber}.webp')`;

        // ===== GM FLY BUTTON VISIBILITY =====
        function updateGMButtonVisibility() {
            const gmBtn = document.getElementById('gmFlyBtn');
            
            // STRICT GM CHECK - Spieler dürfen NIEMALS den GM Button sehen
            let isGM = false;
            try {
                let user = typeof getCurrentUser === 'function' ? getCurrentUser() : null;
                if (!user) {
                    const userData = localStorage.getItem('pnp_companion_user');
                    if (userData) {
                        user = JSON.parse(userData);
                    }
                }
                // Strict boolean check
                isGM = user?.isGM === true || user?.isGM === 'true';
            } catch(e) {
                isGM = false; // Bei Fehler: NIEMALS anzeigen
            }
            
            // Show/hide GM button
            if (gmBtn) {
                gmBtn.style.display = isGM ? 'flex' : 'none';
            }
            
            // Add/remove gm-mode class on body for GM-only elements
            if (isGM) {
                document.body.classList.add('gm-mode');
            } else {
                document.body.classList.remove('gm-mode');
            }
        }
        
        // Check on load and with small delay (auth might load async)
        document.addEventListener('DOMContentLoaded', () => {
            updateGMButtonVisibility();
            setTimeout(updateGMButtonVisibility, 500);
            setTimeout(updateGMButtonVisibility, 1500);
        });
        
        // Also check when auth changes
        if (typeof window !== 'undefined') {
            window.addEventListener('authStateChanged', updateGMButtonVisibility);
        }

        // ===== CONSTANTS =====
        const STORAGE_KEY = 'worldsapart_character_v5';
        const ATTR_TOTAL = 15;
        const SKILL_TOTAL = 500;
        
        // Skill Catalog with example skills
        const SKILL_CATALOG = {
            handeln: [
                // Athletik & Bewegung
                'Klettern', 'Akrobatik', 'Schwimmen', 'Tauchen', 'Springen', 'Balance', 'Ausdauer', 'Sprinten',
                // Kraft & Körper
                'Kraft', 'Ringen', 'Festhalten', 'Einschüchtern',
                // Kampf
                'Nahkampf', 'Fernkampf', 'Waffenhandhabung', 'Ausweichen', 'Blocken', 'Entwaffnen', 'Werfen', 'Improvisierte Waffen',
                // Heimlichkeit
                'Schleichen', 'Verbergen', 'Taschendiebstahl', 'Spuren verwischen', 'Verstecken',
                // Handwerk & Technik
                'Handwerk', 'Mechanik', 'Reparieren', 'Schlösser öffnen', 'Sabotage', 'Feinarbeit', 'Knoten binden', 'Fesseln', 'Entfesseln',
                // Seefahrt
                'Segeln', 'Steuern', 'Rudern', 'Takelage', 'Ankern',
                // Überleben & Wildnis
                'Überleben', 'Jagen', 'Fischen', 'Fallen stellen', 'Feuer machen', 'Spurenlesen', 'Entern',
                // Fortbewegung
                'Reiten', 'Fahren', 'Kutschieren'
            ],
            wissen: [
                // Akademisch & Allgemein
                'Sprachen', 'Geschichte', 'Geographie', 'Philosophie', 'Literatur', 'Mathematik',
                // Naturwissenschaften
                'Naturkunde', 'Chemie', 'Physik',
                // Medizin
                'Heilkunde', 'Erste Hilfe', 'Gifte & Gegenmittel', 'Krankheiten',
                // Navigation & Seefahrt
                'Navigation', 'Astronomie', 'Wetterkunde', 'Kartographie', 'Seefahrt', 'Schiffsbau', 'Gezeitenkunde',
                // Gesellschaft & Recht
                'Politik', 'Recht', 'Religion', 'Mythologie', 'Piratenkodex', 'Etikette', 'Adelshäuser',
                // Handel & Wirtschaft
                'Handel', 'Schätze bewerten', 'Fälschungen erkennen', 'Schmuggelrouten',
                // Kriegswesen
                'Kriegsführung', 'Belagerung', 'Festungsbau', 'Waffenkunde',
                // Handwerk-Wissen
                'Architektur', 'Metallurgie', 'Bergbau',
                // Spezialwissen
                'Kryptographie', 'Menschenkenntnis', 'Gerüchte & Legenden', 'Hafenstädte', 'Unterwelt', 'Okkultismus',
                'Kunst', 'Musik', 'Glücksspiel', 'Alkoholkunde'
            ],
            soziales: [
                // Überzeugung & Rhetorik
                'Überzeugen', 'Verhandeln', 'Schmeicheln', 'Feilschen', 'Reden halten', 'Auftreten',
                // Führung & Autorität
                'Anführen', 'Motivieren', 'Befehlen', 'Kapitänsautorität', 'Crew zusammenhalten', 'Meuterei anzetteln',
                // Täuschung & Manipulation
                'Lügen', 'Täuschen', 'Bluffen', 'Manipulieren', 'Irreführen', 'Falsche Identität',
                // Einschüchterung & Druck
                'Drohen', 'Provozieren', 'Verhören', 'Foltern', 'Verunsichern',
                // Empathie & Diplomatie
                'Beruhigen', 'Trösten', 'Empathie', 'Schlichten', 'Vermitteln',
                // Soziale Interaktion
                'Flirten', 'Spotten', 'Beleidigen', 'Bestechen', 'Netzwerken', 'Gerüchte verbreiten',
                // Unterhaltung & Kultur
                'Seemannsgarn', 'Shanties singen', 'Geschichten erzählen', 'Witze erzählen', 'Trinkgelage',
                // Informationsbeschaffung
                'Aushorchen', 'Abhören', 'Informanten führen', 'Geheimnisse entlocken',
                // Gruppeninteraktion
                'Vertrauen gewinnen', 'Respekt verschaffen', 'Loyalität sichern'
            ]
        };
        const ATTRIBUTES = ['power', 'agility', 'endurance', 'mind', 'presence'];
        const CURRENCY_TYPES = ['dollar', 'euro', 'yen', 'berry'];
        
        const CLASS_ATTRIBUTE_MAP = {
            handeln: ['power', 'agility', 'endurance'],
            wissen: ['mind', 'endurance'],
            soziales: ['presence', 'mind']
        };
        
        const FOKUS_DATA = {
            fire: { 
                name: 'Feuer', 
                icon: 'icon_focus_fire.png', 
                attr: 'KRF',
                color: '#ff6b35',
                attacks: [
                    { name: 'Feuerball', desc: 'Eine kompakte Flammenkugel explodiert beim Aufprall.' },
                    { name: 'Flammenstrahl', desc: 'Dauerhafter Feuerstoß mit hoher Durchschlagskraft.' },
                    { name: 'Explosionsschlag', desc: 'Ein Nahkampftreffer mit detonierender Hitze.' },
                    { name: 'Feuerregen', desc: 'Mehrere Flammen fallen großflächig vom Himmel.' },
                    { name: 'Hitzewelle', desc: 'Verbrennt alles in einem Bereich ohne direkten Treffer.' },
                    { name: 'Flammenlanze', desc: 'Ein gebündelter Feuerstoß mit hoher Reichweite.' },
                    { name: 'Lavaausbruch', desc: 'Der Boden bricht auf und speit Feuer.' },
                    { name: 'Feuerwirbel', desc: 'Rotierende Flammen reißen Gegner mit.' },
                    { name: 'Selbstentzündung', desc: 'Kurzzeitige massive Angriffsstärkung.' },
                    { name: 'Brandmarke', desc: 'Gegner erleidet anhaltenden Feuerschaden.' }
                ], 
                defenses: [
                    { name: 'Flammenhülle', desc: 'Feuer umgibt den Körper und schreckt Angriffe ab.' },
                    { name: 'Hitzeschild', desc: 'Verdampft Projektile durch extreme Hitze.' },
                    { name: 'Explosionsstoß', desc: 'Gegner werden durch Druckwelle zurückgedrängt.' },
                    { name: 'Feuerwand', desc: 'Eine brennende Barriere blockiert den Weg.' },
                    { name: 'Aschevorhang', desc: 'Rauch erschwert Sicht und Zielerfassung.' },
                    { name: 'Hitzeresistenz', desc: 'Stark verringerter Feuerschaden.' },
                    { name: 'Feuerabsorption', desc: 'Eigene Flammen werden zur Energiequelle.' },
                    { name: 'Flammenausbruch', desc: 'Defensiver Ausbruch bei Bedrohung.' },
                    { name: 'Bodenverkohlung', desc: 'Gegner verlieren Halt.' },
                    { name: 'Notzündung', desc: 'Schneller Flammenschub zum Ausweichen.' }
                ]
            },
            water: { 
                name: 'Wasser', 
                icon: 'icon_focus_water.png', 
                attr: 'GES',
                color: '#4dabf7',
                attacks: [
                    { name: 'Wasserstrahl', desc: 'Schneidender Hochdruckangriff.' },
                    { name: 'Wasserpeitsche', desc: 'Flexibler Angriff auf mittlere Distanz.' },
                    { name: 'Eislanze', desc: 'Gefrierender Durchstoßangriff.' },
                    { name: 'Eisfläche', desc: 'Gegner rutschen unkontrolliert.' },
                    { name: 'Druckstoß', desc: 'Wasserwelle schleudert Gegner zurück.' },
                    { name: 'Wassergefängnis', desc: 'Gegner wird fest eingeschlossen.' },
                    { name: 'Froststoß', desc: 'Friert getroffene Ziele ein.' },
                    { name: 'Flutwelle', desc: 'Großflächiger Angriff mit Verdrängung.' },
                    { name: 'Nebelstoß', desc: 'Angriff aus verdeckter Position.' },
                    { name: 'Wasserprojektil', desc: 'Präziser Fernangriff.' }
                ], 
                defenses: [
                    { name: 'Wasserwand', desc: 'Massive flüssige Schutzbarriere.' },
                    { name: 'Eisblock', desc: 'Kurzzeitige vollständige Abschirmung.' },
                    { name: 'Nebelzone', desc: 'Starke Sichtbehinderung.' },
                    { name: 'Strömungsumlenkung', desc: 'Lenkt Angriffe ab.' },
                    { name: 'Gleiten', desc: 'Flüssige Ausweichbewegung.' },
                    { name: 'Wasserhaut', desc: 'Reduziert physischen Schaden.' },
                    { name: 'Eisrüstung', desc: 'Erhöhte Verteidigung.' },
                    { name: 'Flusslauf', desc: 'Schnelle Positionsverlagerung.' },
                    { name: 'Untertauchen', desc: 'Kurzzeitiges Entziehen aus Gefahren.' },
                    { name: 'Druckentladung', desc: 'Gegner werden weggestoßen.' }
                ]
            },
            wind: { 
                name: 'Wind', 
                icon: 'icon_focus_wind.png', 
                attr: 'GES',
                color: '#69db7c',
                attacks: [
                    { name: 'Windklinge', desc: 'Scharfer Luftschnitt.' },
                    { name: 'Druckstoß', desc: 'Unsichtbarer Schlag aus der Distanz.' },
                    { name: 'Tornado', desc: 'Gegner werden hochgerissen.' },
                    { name: 'Luftschnitt-Serie', desc: 'Mehrere schnelle Schnitte.' },
                    { name: 'Fallwind', desc: 'Gegner werden zu Boden gedrückt.' },
                    { name: 'Wirbelwurf', desc: 'Gegner rotieren unkontrolliert.' },
                    { name: 'Stoßfront', desc: 'Breiter Luftangriff.' },
                    { name: 'Windlanze', desc: 'Gebündelter Durchstoß.' },
                    { name: 'Luftschock', desc: 'Plötzlicher Druckimpuls.' },
                    { name: 'Überschallstoß', desc: 'Extrem schneller Angriff.' }
                ], 
                defenses: [
                    { name: 'Luftschild', desc: 'Abprallende Luftbarriere.' },
                    { name: 'Seitenstoß', desc: 'Umlenken von Angriffen.' },
                    { name: 'Sprungverstärkung', desc: 'Schnelles Ausweichen.' },
                    { name: 'Gleitbewegung', desc: 'Reduziert Fallschaden.' },
                    { name: 'Rückstoß', desc: 'Gegner werden ferngehalten.' },
                    { name: 'Windtunnel', desc: 'Projektile verlieren Kraft.' },
                    { name: 'Luftpolster', desc: 'Sanftes Abfedern.' },
                    { name: 'Richtungsbruch', desc: 'Sofortige Bewegungsänderung.' },
                    { name: 'Druckneutralisierung', desc: 'Abschwächen von Einschlägen.' },
                    { name: 'Schweben', desc: 'Entzug aus Bodengefahren.' }
                ]
            },
            earth: { 
                name: 'Erde', 
                icon: 'icon_focus_earth.png', 
                attr: 'ZÄH',
                color: '#a9845b',
                attacks: [
                    { name: 'Erdspieß', desc: 'Stein bricht aus dem Boden.' },
                    { name: 'Felswurf', desc: 'Massive Projektilattacke.' },
                    { name: 'Bodenbruch', desc: 'Gegner verlieren Halt.' },
                    { name: 'Erdstampfer', desc: 'Stoßwelle aus dem Boden.' },
                    { name: 'Steinschlag', desc: 'Herabfallende Brocken.' },
                    { name: 'Metallfaust', desc: 'Verstärkter Nahkampfangriff.' },
                    { name: 'Sandlawine', desc: 'Begräbt Gegner.' },
                    { name: 'Felsramme', desc: 'Durchbruchangriff.' },
                    { name: 'Erdgreifer', desc: 'Boden hält Gegner fest.' },
                    { name: 'Bebenstoß', desc: 'Weiträumiger Erschütterungsangriff.' }
                ], 
                defenses: [
                    { name: 'Steinrüstung', desc: 'Stark erhöhte Abwehr.' },
                    { name: 'Felswand', desc: 'Massive Deckung.' },
                    { name: 'Bodenschild', desc: 'Schutz aus dem Untergrund.' },
                    { name: 'Erdverankerung', desc: 'Immun gegen Wegstoßen.' },
                    { name: 'Sandbarriere', desc: 'Dämpft Angriffe.' },
                    { name: 'Metallhaut', desc: 'Kurzzeitige Unverwundbarkeit.' },
                    { name: 'Erdabsorption', desc: 'Reduziert Schaden.' },
                    { name: 'Schutzwall', desc: 'Halbkreisförmige Deckung.' },
                    { name: 'Bodenerhöhung', desc: 'Höhenvorteil.' },
                    { name: 'Erdpanzer', desc: 'Bewegliche Verteidigung.' }
                ]
            },
            lightning: { 
                name: 'Blitz', 
                icon: 'icon_focus_lightning.png', 
                attr: 'KRF',
                color: '#ffd93d',
                attacks: [
                    { name: 'Blitzschlag', desc: 'Direkter Energiestoß.' },
                    { name: 'Kettenblitz', desc: 'Springt zwischen Zielen.' },
                    { name: 'Elektroschock', desc: 'Lähmt Gegner.' },
                    { name: 'Energiehieb', desc: 'Verstärkter Nahkampf.' },
                    { name: 'Überladung', desc: 'Erhöhter Schaden für kurze Zeit.' },
                    { name: 'Blitzzone', desc: 'Elektrisiertes Gebiet.' },
                    { name: 'Impulsstoß', desc: 'Schneller Energieschub.' },
                    { name: 'Nervenstörung', desc: 'Verlangsamt Gegner.' },
                    { name: 'Entladungswelle', desc: 'Rundumangriff.' },
                    { name: 'Präzisionsblitz', desc: 'Zielgenauer Treffer.' }
                ], 
                defenses: [
                    { name: 'Blitztempo', desc: 'Extrem schnelles Ausweichen.' },
                    { name: 'Energiehülle', desc: 'Elektrische Schutzschicht.' },
                    { name: 'Reizunterdrückung', desc: 'Immun gegen Lähmung.' },
                    { name: 'Stromableitung', desc: 'Leitet Angriffe ab.' },
                    { name: 'Kurzteleport', desc: 'Blitzartige Bewegung.' },
                    { name: 'Reaktionsboost', desc: 'Verbesserte Reflexe.' },
                    { name: 'Energieschild', desc: 'Elektrische Barriere.' },
                    { name: 'Überladungsstoß', desc: 'Gegner zurückdrängen.' },
                    { name: 'Nervenschild', desc: 'Schutz vor Kontrollverlust.' },
                    { name: 'Energieabsorption', desc: 'Blitz stärkt den Nutzer.' }
                ]
            },
            room: { 
                name: 'Raum', 
                icon: 'icon_focus_room.png', 
                attr: 'VER',
                color: '#9775fa',
                attacks: [
                    { name: 'Kurzteleport-Schlag', desc: 'Angriff aus dem Nichts.' },
                    { name: 'Positionswechsel', desc: 'Tauscht Plätze mit Gegner.' },
                    { name: 'Raumschnitt', desc: 'Schneidet durch Distanz.' },
                    { name: 'Distanzbruch', desc: 'Verkürzt oder verlängert Wege.' },
                    { name: 'Raumstoß', desc: 'Unsichtbarer Druckangriff.' },
                    { name: 'Fixierung', desc: 'Gegner kann sich nicht bewegen.' },
                    { name: 'Umlenkung', desc: 'Angriffe treffen andere Ziele.' },
                    { name: 'Miniportal', desc: 'Angriff aus ungewöhnlichem Winkel.' },
                    { name: 'Fallverzerrung', desc: 'Gegner stürzt unkontrolliert.' },
                    { name: 'Raumkompression', desc: 'Erhöhter Schaden im Nahbereich.' }
                ], 
                defenses: [
                    { name: 'Sofort-Teleport', desc: 'Ausweichen ohne Bewegung.' },
                    { name: 'Distanzvergrößerung', desc: 'Gegner kommen nicht heran.' },
                    { name: 'Positionsanker', desc: 'Eigene Position bleibt stabil.' },
                    { name: 'Raumverschiebung', desc: 'Treffer gehen ins Leere.' },
                    { name: 'Umlenkfeld', desc: 'Projektile ändern Richtung.' },
                    { name: 'Phasenversatz', desc: 'Kurzzeitige Unangreifbarkeit.' },
                    { name: 'Raumblockade', desc: 'Bereich ist unpassierbar.' },
                    { name: 'Fallneutralisierung', desc: 'Kein Sturzschaden.' },
                    { name: 'Schutzportal', desc: 'Angriffe verschwinden.' },
                    { name: 'Eigenverzerrung', desc: 'Körper weicht Treffern aus.' }
                ]
            },
            illusion: { 
                name: 'Illusion', 
                icon: 'icon_focus_illusion.png', 
                attr: 'PRÄ',
                color: '#f06595',
                attacks: [
                    { name: 'Trugbild', desc: 'Gegner greift falsches Ziel an.' },
                    { name: 'Doppelgänger', desc: 'Verwirrt Gegner.' },
                    { name: 'Blendillusion', desc: 'Sicht wird blockiert.' },
                    { name: 'Geräuschfalle', desc: 'Falsche Positionshinweise.' },
                    { name: 'Angriffsillusion', desc: 'Gegner reagiert zu früh.' },
                    { name: 'Angstbild', desc: 'Gegner verliert Kontrolle.' },
                    { name: 'Verzerrte Umgebung', desc: 'Orientierung bricht zusammen.' },
                    { name: 'Unsichtbarer Schlag', desc: 'Angriff bleibt unbemerkt.' },
                    { name: 'Phantomhieb', desc: 'Psychischer Schaden.' },
                    { name: 'Scheinexplosion', desc: 'Gegner weicht falsch aus.' }
                ], 
                defenses: [
                    { name: 'Unsichtbarkeit', desc: 'Gegner verlieren Ziel.' },
                    { name: 'Illusionsschild', desc: 'Treffer gehen ins Leere.' },
                    { name: 'Mehrfachbilder', desc: 'Gegner verfehlt Angriffe.' },
                    { name: 'Verhüllung', desc: 'Verbündete werden verborgen.' },
                    { name: 'Täuschbewegung', desc: 'Schein-Ausweichen.' },
                    { name: 'Wahrnehmungsbruch', desc: 'Gegner reagiert zu spät.' },
                    { name: 'Falsche Trefferanzeige', desc: 'Gegner glaubt zu treffen.' },
                    { name: 'Illusionszone', desc: 'Kontrolle über Sichtbereich.' },
                    { name: 'Sinnesrauschen', desc: 'Gegner verliert Fokus.' },
                    { name: 'Identitätsverschleierung', desc: 'Nutzer wird nicht erkannt.' }
                ]
            },
            shadow: { 
                name: 'Schatten', 
                icon: 'icon_focus_shadow.png', 
                attr: 'GES',
                color: '#4a4a6a',
                attacks: [
                    { name: 'Schattenklinge', desc: 'Schnitt aus purer Dunkelheit.' },
                    { name: 'Schattenpfeil', desc: 'Lautloser Fernkampfangriff.' },
                    { name: 'Dunkler Griff', desc: 'Schatten packen und halten das Ziel.' },
                    { name: 'Schattenexplosion', desc: 'Dunkelheit bricht aus dem Nutzer hervor.' },
                    { name: 'Erstickende Finsternis', desc: 'Schatten dringen in Lungen ein.' },
                    { name: 'Schattendoppelgänger-Angriff', desc: 'Klon greift zeitgleich an.' },
                    { name: 'Nachtbiss', desc: 'Verstärkter Nahkampf aus dem Verborgenen.' },
                    { name: 'Schattenketten', desc: 'Fesseln aus Dunkelheit.' },
                    { name: 'Seelenschatten', desc: 'Greift den Geist statt den Körper an.' },
                    { name: 'Totale Finsternis', desc: 'Großflächige Blindheit und Schaden.' }
                ], 
                defenses: [
                    { name: 'Schattenmantel', desc: 'Angriffe gleiten durch Dunkelheit.' },
                    { name: 'Schattenschritt', desc: 'Teleport durch verbundene Schatten.' },
                    { name: 'Auflösung', desc: 'Körper wird kurzzeitig zu Schatten.' },
                    { name: 'Dunkelheitstarnung', desc: 'Unsichtbar in Schatten.' },
                    { name: 'Schattenbarriere', desc: 'Wand aus verdichteter Finsternis.' },
                    { name: 'Dunkle Spiegelung', desc: 'Angriff wird zum Angreifer zurückgeworfen.' },
                    { name: 'Schattenflimmern', desc: 'Schwer zu treffen durch flackernde Präsenz.' },
                    { name: 'Nachtauge', desc: 'Perfekte Sicht in Dunkelheit.' },
                    { name: 'Schattenreise', desc: 'Flucht durch den Schatten.' },
                    { name: 'Leere Hülle', desc: 'Schatten absorbiert einen Treffer komplett.' }
                ]
            },
            time: { 
                name: 'Zeit', 
                icon: 'icon_focus_time.png', 
                attr: 'VER',
                color: '#d4a574',
                attacks: [
                    { name: 'Zeitriss', desc: 'Schnitt der Vergangenheit und Zukunft trennt.' },
                    { name: 'Alterung', desc: 'Ziel altert schlagartig.' },
                    { name: 'Stillstand-Schlag', desc: 'Gegner wird im Moment des Treffers eingefroren.' },
                    { name: 'Beschleunigter Ansturm', desc: 'Dutzende Schläge in einer Sekunde.' },
                    { name: 'Echo-Schaden', desc: 'Vergangene Wunden öffnen sich erneut.' },
                    { name: 'Zeitschleife-Falle', desc: 'Gegner wiederholt dieselbe schmerzhafte Sekunde.' },
                    { name: 'Zukunftsvision', desc: 'Angriff trifft bevor er ausgeführt wird.' },
                    { name: 'Verfall', desc: 'Ausrüstung und Waffen altern und brechen.' },
                    { name: 'Verzögerter Schlag', desc: 'Schaden tritt zeitversetzt ein.' },
                    { name: 'Zeitexplosion', desc: 'Aufgestaute Zeit entlädt sich zerstörerisch.' }
                ], 
                defenses: [
                    { name: 'Zeitsprung', desc: 'Kurzer Sprung in die nahe Zukunft.' },
                    { name: 'Rückspulen', desc: 'Letzte Sekunden ungeschehen machen.' },
                    { name: 'Verlangsamungsfeld', desc: 'Angriffe werden träge.' },
                    { name: 'Zeitblase', desc: 'Geschützte Zone außerhalb der Zeit.' },
                    { name: 'Moment der Klarheit', desc: 'Zeit verlangsamt, perfektes Ausweichen.' },
                    { name: 'Reparatur', desc: 'Schaden wird in der Zeit zurückgedreht.' },
                    { name: 'Prophezeiung', desc: 'Angriffe werden vorhergesehen.' },
                    { name: 'Zeitanker', desc: 'Position wird gespeichert, Rückkehr möglich.' },
                    { name: 'Beschleunigte Heilung', desc: 'Regeneration in Sekunden statt Tagen.' },
                    { name: 'Zeitstillstand', desc: 'Alles außer dem Nutzer friert ein.' }
                ]
            },
            poison: { 
                name: 'Gift', 
                icon: 'icon_focus_poison.png', 
                attr: 'ZÄH',
                color: '#7cb342',
                attacks: [
                    { name: 'Giftspucke', desc: 'Säure-Fernkampf.' },
                    { name: 'Giftklinge', desc: 'Vergiftete Nahkampfwaffe.' },
                    { name: 'Sporenwolke', desc: 'Großflächige Vergiftung.' },
                    { name: 'Säurespritzer', desc: 'Ätzender Flächenschaden.' },
                    { name: 'Lähmsporen', desc: 'Ziel wird bewegungsunfähig.' },
                    { name: 'Nekrose', desc: 'Gewebe stirbt langsam ab.' },
                    { name: 'Toxischer Griff', desc: 'Gift dringt durch Berührung ein.' },
                    { name: 'Blutgift', desc: 'Vergiftet das Blut, Schaden über Zeit.' },
                    { name: 'Giftexplosion', desc: 'Innere Giftstoffe entladen sich.' },
                    { name: 'Seuchenatem', desc: 'Verbreitet Krankheit und Schwäche.' }
                ], 
                defenses: [
                    { name: 'Giftimmunität', desc: 'Eigene Gifte können nicht schaden.' },
                    { name: 'Gifthaut', desc: 'Angreifer vergiften sich bei Berührung.' },
                    { name: 'Säurepanzer', desc: 'Projektile werden aufgelöst.' },
                    { name: 'Sporenschild', desc: 'Angreifer atmen Gift ein.' },
                    { name: 'Giftblut', desc: 'Wunden vergiften Angreifer.' },
                    { name: 'Reinigung', desc: 'Eigene Gifte aus dem Körper stoßen.' },
                    { name: 'Resistenz', desc: 'Reduzierter Schaden durch alle Substanzen.' },
                    { name: 'Giftschleier', desc: 'Umgebende Giftwolke schreckt ab.' },
                    { name: 'Parasitäre Heilung', desc: 'Entzieht Gegnern Lebenskraft.' },
                    { name: 'Toxische Explosion', desc: 'Bei kritischem Schaden: Giftaustritt.' }
                ]
            },
            sound: { 
                name: 'Schall', 
                icon: 'icon_focus_sound.png', 
                attr: 'PRÄ',
                color: '#26c6da',
                attacks: [
                    { name: 'Schallwelle', desc: 'Druckwelle trifft und wirft Gegner zurück.' },
                    { name: 'Donnerschlag', desc: 'Massiver Knall verursacht Schaden.' },
                    { name: 'Schrei', desc: 'Betäubender Schrei lähmt Gegner.' },
                    { name: 'Resonanzbruch', desc: 'Frequenz die Material zerstört.' },
                    { name: 'Echoschlag', desc: 'Angriff hallt nach und trifft mehrfach.' },
                    { name: 'Stille', desc: 'Entzieht Gegnern Gehör und Orientierung.' },
                    { name: 'Dissonanz', desc: 'Störende Frequenz verursacht Schmerzen.' },
                    { name: 'Schallklinge', desc: 'Fokussierte Schallwelle schneidet.' },
                    { name: 'Infraschall', desc: 'Tiefe Frequenz erzeugt Panik und Übelkeit.' },
                    { name: 'Überschallstoß', desc: 'Durchbricht die Schallmauer, verheerender Treffer.' }
                ], 
                defenses: [
                    { name: 'Schallschild', desc: 'Schallwellen lenken Angriffe ab.' },
                    { name: 'Stille-Zone', desc: 'Lautloser Bereich desorientiert Angreifer.' },
                    { name: 'Echo-Ortung', desc: 'Perfekte Wahrnehmung durch Schall.' },
                    { name: 'Frequenzstörung', desc: 'Angreifer verlieren Koordination.' },
                    { name: 'Dämpfungsfeld', desc: 'Absorbiert eingehende Energie.' },
                    { name: 'Schallreflektion', desc: 'Angriffe werden akustisch zurückgeworfen.' },
                    { name: 'Vibrationsresistenz', desc: 'Immun gegen Erschütterungen.' },
                    { name: 'Harmonie', desc: 'Stärkender Klang heilt und schützt.' },
                    { name: 'Schalltarnung', desc: 'Eigene Geräusche werden unterdrückt.' },
                    { name: 'Druckausgleich', desc: 'Explosionen und Schockwellen neutralisiert.' }
                ]
            },
            none: { name: 'Ohne Fokus', icon: 'icon_nofocus.png', attr: '', color: '#6c757d', attacks: [], defenses: [] }
        };
        
        const FOKUS_ATTRIBUTE_MAP = {
            fire: 'power', lightning: 'power', water: 'agility', wind: 'agility',
            earth: 'endurance', room: 'mind', illusion: 'presence',
            shadow: 'agility', time: 'mind', poison: 'endurance', sound: 'presence'
        };

        const SCHWAECHE_DATA = [
            { id: 'hoehenangst', name: 'Höhenangst', bedeutung: 'Probleme mit exponierten Höhen, Abgründen, Seilwegen.', wuerfel: 'Erschwerte Proben bei Klettern, Balancieren, Abseilen.', trigger: 'Brücken, Masten, Klippen, Luftschiffe, Dächer.' },
            { id: 'platzangst', name: 'Platzangst', bedeutung: 'Enge, schlecht einsehbare Räume beeinträchtigen Handlungen.', wuerfel: 'Erschwerte Proben in Schächten, Tunneln, Wracks.', trigger: 'Höhlen, Gefängnisse, Geheimgänge, Trümmer.' },
            { id: 'seekrank', name: 'Seekrank', bedeutung: 'Instabil auf schwankendem Untergrund.', wuerfel: 'Erschwerte Proben auf Schiffen oder Plattformen bei Wellengang.', trigger: 'Seereisen, Sturm, Gefechte auf Deck.' },
            { id: 'schlechte-sicht', name: 'Schlechte Sicht', bedeutung: 'Eingeschränkte Wahrnehmung von Details und Entfernungen.', wuerfel: 'Erschwertes Zielen, Entdecken, präzise Aktionen.', trigger: 'Dämmerung, Rauch, Nebel, Regen, Dunkelheit.' },
            { id: 'gleichgewicht', name: 'Schlechter Gleichgewichtssinn', bedeutung: 'Instabil auf unebenem oder schmalem Untergrund.', wuerfel: 'Erschwerte Balance- und Akrobatikproben.', trigger: 'Seile, schmale Stege, vereiste Flächen, Decks.' },
            { id: 'ausdauer', name: 'Geringe Ausdauer', bedeutung: 'Erschöpfung tritt schneller ein als bei anderen.', wuerfel: 'Nach längeren Aktionen zusätzliche Erschwernisse.', trigger: 'Verfolgungen, Märsche, Dauerbelastung, Hitze.' },
            { id: 'reaktion', name: 'Langsame Reaktion', bedeutung: 'Verzögertes Handeln in plötzlichen Situationen.', wuerfel: 'Nachteil bei Reaktionen auf überraschende Ereignisse.', trigger: 'Hinterhalte, einstürzende Gebäude, plötzliche Angriffe.' },
            { id: 'feinmotorik', name: 'Ungeschickte Feinmotorik', bedeutung: 'Probleme bei sehr präzisen, filigranen Tätigkeiten.', wuerfel: 'Erschwerte Proben bei Schlössern, Fallen, Mechanik.', trigger: 'Zeitkritische Infiltration, Sabotage, Entschärfen.' },
            { id: 'zittrig', name: 'Zittrige Hände unter Stress', bedeutung: 'Präzision leidet bei Gefahr oder Zeitdruck.', wuerfel: 'Erschwertes Zielen oder Arbeiten unter Bedrohung.', trigger: 'Gefechte, Tickende Fallen, Countdown-Situationen.' },
            { id: 'verletzungen', name: 'Anfällig für Verletzungen', bedeutung: 'Treffer oder Stürze haben stärkere Folgen.', wuerfel: 'Zusätzliche Konsequenzen bei Fehlschlägen.', trigger: 'Kämpfe, Stürze, Explosionen, schwere Treffer.' },
            { id: 'hitze', name: 'Hitzeempfindlich', bedeutung: 'Leistung sinkt bei hohen Temperaturen.', wuerfel: 'Erschwerte körperliche Proben bei Hitze.', trigger: 'Wüsten, Maschinenräume, Feuer, Tropen.' },
            { id: 'kaelte', name: 'Kälteempfindlich', bedeutung: 'Steife Bewegungen und schnellere Erschöpfung.', wuerfel: 'Erschwerte Proben bei Kälte oder Nässe.', trigger: 'Schnee, Eis, Regen, Nachtwachen.' },
            { id: 'reizueberflutung', name: 'Reizüberflutung', bedeutung: 'Viele Eindrücke gleichzeitig überfordern.', wuerfel: 'Erschwerte Wahrnehmungs- und Reaktionsproben bei Chaos.', trigger: 'Schlachten, Märkte, Explosionen, Panik.' },
            { id: 'orientierung', name: 'Schlechte Orientierung', bedeutung: 'Schwierigkeiten, Wege und Richtungen zu behalten.', wuerfel: 'Erschwerte Orientierung und Navigation.', trigger: 'Dschungel, Städte, Nebel, unbekanntes Terrain.' },
            { id: 'geraeusch', name: 'Geräuschempfindlich', bedeutung: 'Lärm stört Konzentration massiv.', wuerfel: 'Erschwerte Proben bei Krach oder Echo.', trigger: 'Maschinen, Schlachten/Kämpfe, Gewitter, Werkstätten.' },
            { id: 'griff', name: 'Schwacher Griff', bedeutung: 'Probleme, Halt zu bewahren oder etwas festzuhalten.', wuerfel: 'Erschwerte Proben bei Klettern, Festhalten, Abfangen.', trigger: 'Stürze, Seilaktionen, Kämpfe an Abgründen.' }
        ];

        // ===== STATE =====
        let characterData = {};
        let currencyIndex = 0;
        let selectedFokusType = null;
        let selectedFokusAbilities = [];
        let selectedSchwaeche = null;
        let saveTimeout = null;

        // ===== INIT =====
        const EMPTY_SKILL = () => ({ name: '', value: 0, proficient: true });
        const DEFAULT_SKILLS_COUNT = 8;
        
        function getDefaultCharacter() {
            return {
                name: '', race: '', age: '', gender: '', role: '', crew: '',
                portrait: null, jollyRoger: null,
                attributes: { power: 0, agility: 0, endurance: 0, mind: 0, presence: 0 },
                health: { current: 100, max: 100 },
                moral: { current: 100, max: 100 },
                secondChance: [false, false, false],
                skills: { 
                    handeln: Array(DEFAULT_SKILLS_COUNT).fill(null).map(EMPTY_SKILL),
                    wissen: Array(DEFAULT_SKILLS_COUNT).fill(null).map(EMPTY_SKILL),
                    soziales: Array(DEFAULT_SKILLS_COUNT).fill(null).map(EMPTY_SKILL)
                },
                fokus: { type: null, abilities: [] },
                schwaeche: null,
                appearance: '', inventory: '', currency: '', currencyType: 'dollar', weapon: '', notes: ''
            };
        }

        function init() {
            loadCharacter();
            populateFields();
            initializeSkills();
            updateAllCalculations();
            
            // Update main character button state
            setTimeout(() => updateMainCharButton(), 100);
            
            // Initialize Firestore sync AFTER loading character
            setTimeout(() => {
                initializeFirestoreSync();
            }, 1000);
        }
        
        // Global variable for Firestore unsubscribe
        let firestoreCharListener = null;
        
        async function initializeFirestoreSync() {
            // Get room code from URL or localStorage
            const urlParams = new URLSearchParams(window.location.search);
            let roomCode = urlParams.get('room') || localStorage.getItem('rift_current_room');
            const charId = urlParams.get('id') || window.currentCharId;
            
            // Save roomCode to localStorage if from URL
            if (urlParams.get('room')) {
                localStorage.setItem('rift_current_room', urlParams.get('room'));
                console.log('[WA-Sheet] Saved roomCode to localStorage:', urlParams.get('room'));
            }
            
            console.log('[WA-Sheet] initializeFirestoreSync - roomCode:', roomCode, 'charId:', charId);
            
            if (!roomCode) {
                console.log('[WA-Sheet] No roomCode, Firestore sync disabled');
                return;
            }
            
            if (!charId) {
                console.log('[WA-Sheet] No charId yet, will retry...');
                setTimeout(() => initializeFirestoreSync(), 500);
                return;
            }
            
            // Initialize Firebase via RIFT if available
            if (window.RIFT?.firebase?.init) {
                try {
                    await window.RIFT.firebase.init();
                    console.log('[WA-Sheet] Firebase initialized via RIFT');
                } catch (e) {
                    console.warn('[WA-Sheet] RIFT.firebase.init failed:', e);
                }
            }
            
            // Wait for Firebase to be FULLY initialized (not just loaded)
            if (typeof firebase === 'undefined' || !firebase.apps || firebase.apps.length === 0) {
                console.log('[WA-Sheet] Firebase not initialized yet, retrying in 500ms...');
                setTimeout(() => initializeFirestoreSync(), 500);
                return;
            }
            
            // Now we can safely use firestore
            try {
                const db = firebase.firestore();
                
                // Check auth state
                const user = firebase.auth().currentUser;
                if (user) {
                    setupCharacterListener(roomCode, charId);
                } else {
                    // Wait for auth
                    console.log('[WA-Sheet] Waiting for auth...');
                    const unsubAuth = firebase.auth().onAuthStateChanged(authUser => {
                        if (authUser && !firestoreCharListener) {
                            setupCharacterListener(roomCode, charId);
                            unsubAuth(); // Unsubscribe after first auth
                        }
                    });
                }
            } catch (e) {
                console.error('[WA-Sheet] Firebase error, retrying...', e);
                setTimeout(() => initializeFirestoreSync(), 1000);
            }
        }
        
        function setupCharacterListener(roomCode, charId) {
            const normalizedCode = roomCode.replace(/-/g, '').toUpperCase();
            const db = firebase.firestore();
            
            console.log('[WA-Sheet] Setting up Firestore listener:', normalizedCode, charId);
            
            // Unsubscribe from previous
            if (firestoreCharListener) {
                firestoreCharListener();
            }
            
            // Listen to character document in room
            firestoreCharListener = db.collection('rooms').doc(normalizedCode)
                .collection('characters').doc(charId)
                .onSnapshot(doc => {
                    if (!doc.exists) {
                        console.log('[WA-Sheet] Character doc does not exist in room');
                        return;
                    }
                    
                    const serverData = doc.data();
                    console.log('[WA-Sheet] Received Firestore update:', serverData);
                    
                    handleServerUpdate(serverData);
                    
                }, error => {
                    console.error('[WA-Sheet] Firestore listener error:', error);
                });
            
            console.log('[WA-Sheet] Firestore listener active');
        }
        
        // Track if this is the first update (to skip initial sync)
        let isFirstUpdate = true;
        let lastServerHealth = null;
        let lastServerMoral = null;
        let gmModeListener = null;
        
        // Setup GM Mode bidirectional listener
        function setupGMModeBidirectionalListener() {
            if (!window.isGMViewMode) return;
            
            const roomCode = window.gmViewRoomCode;
            const charId = window.gmViewCharId;
            
            if (!roomCode || !charId) return;
            
            console.log('[WA-Sheet GM] Setting up bidirectional listener');
            
            const db = firebase.firestore();
            
            // Listen for player changes
            gmModeListener = db.collection('rooms').doc(roomCode)
                .collection('characters').doc(charId)
                .onSnapshot(doc => {
                    if (!doc.exists) return;
                    
                    const serverData = doc.data();
                    
                    // Only update if change was from player, not GM
                    if (serverData.lastModifiedBy !== 'gm') {
                        console.log('[WA-Sheet GM] Player made change - updating view');
                        handleGMViewUpdate(serverData);
                    }
                }, err => {
                    console.error('[WA-Sheet GM] Listener error:', err);
                });
        }
        
        // Handle updates when GM is viewing player sheet
        function handleGMViewUpdate(serverData) {
            const d = serverData.data || {};
            let updated = false;
            
            // Update health
            if (d.status?.health !== undefined && d.status.health !== characterData.health.current) {
                characterData.health.current = d.status.health;
                const healthInput = document.getElementById('health-current');
                const healthBar = document.getElementById('health-bar');
                if (healthInput) healthInput.value = d.status.health;
                if (healthBar) healthBar.style.width = `${Math.min(100, Math.max(0, d.status.health))}%`;
                updated = true;
            }
            
            // Update moral
            if (d.status?.moral !== undefined && d.status.moral !== characterData.moral.current) {
                characterData.moral.current = d.status.moral;
                const moralInput = document.getElementById('moral-current');
                const moralBar = document.getElementById('moral-bar');
                if (moralInput) moralInput.value = d.status.moral;
                if (moralBar) moralBar.style.width = `${Math.min(100, Math.max(0, d.status.moral))}%`;
                updated = true;
            }
            
            // Update attributes
            if (d.attributes) {
                ['power', 'agility', 'endurance', 'mind', 'presence'].forEach(attr => {
                    if (d.attributes[attr] !== undefined && d.attributes[attr] !== characterData.attributes[attr]) {
                        characterData.attributes[attr] = d.attributes[attr];
                        const input = document.getElementById(`attr-${attr}`);
                        if (input) input.value = d.attributes[attr];
                        updated = true;
                    }
                });
            }
            
            // Update other fields
            if (d.currency !== undefined && d.currency !== characterData.currency) {
                characterData.currency = d.currency;
                const currInput = document.getElementById('char-currency');
                if (currInput) currInput.value = d.currency;
                updated = true;
            }
            
            if (d.inventory !== undefined && d.inventory !== characterData.inventory) {
                characterData.inventory = d.inventory;
                const invInput = document.getElementById('char-inventory');
                if (invInput) invInput.value = d.inventory;
                updated = true;
            }
            
            if (d.notes !== undefined && d.notes !== characterData.notes) {
                characterData.notes = d.notes;
                const notesInput = document.getElementById('char-notes');
                if (notesInput) notesInput.value = d.notes;
                updated = true;
            }
            
            if (d.weapon !== undefined && d.weapon !== characterData.weapon) {
                characterData.weapon = d.weapon;
                const weaponInput = document.getElementById('char-weapon');
                if (weaponInput) weaponInput.value = d.weapon;
                updated = true;
            }
            
            if (updated) {
                console.log('[WA-Sheet GM] View updated with player changes');
                if (typeof updateAllCalculations === 'function') {
                    updateAllCalculations();
                }
                
                // Flash the banner to show update
                const banner = document.querySelector('[style*="GM-Ansicht"]');
                if (banner) {
                    banner.style.background = 'rgba(59, 130, 246, 0.9)';
                    banner.innerHTML = '🔄 Spieler hat geändert!';
                    setTimeout(() => {
                        banner.style.background = 'rgba(139,92,246,0.9)';
                        banner.innerHTML = '👑 GM-Ansicht (Live-Sync aktiv)';
                    }, 2000);
                }
            }
        }
        
        function handleServerUpdate(serverData) {
            const d = serverData.data || {};
            
            // Get HP/Health from multiple possible locations
            let serverHealth = null;
            if (d.status?.health !== undefined) {
                serverHealth = parseInt(d.status.health);
            } else if (serverData.hp !== undefined) {
                serverHealth = parseInt(serverData.hp);
            }
            
            // Get Moral from multiple possible locations  
            let serverMoral = null;
            if (d.status?.moral !== undefined) {
                serverMoral = parseInt(d.status.moral);
            } else if (serverData.moral !== undefined) {
                serverMoral = parseInt(serverData.moral);
            }
            
            console.log('[WA-Sheet] handleServerUpdate:', {
                isFirstUpdate,
                serverHealth,
                serverMoral,
                lastServerHealth,
                lastServerMoral,
                localHealth: characterData.health.current,
                localMoral: characterData.moral.current
            });
            
            // On first update, just record the values
            if (isFirstUpdate) {
                console.log('[WA-Sheet] First update - recording baseline');
                lastServerHealth = serverHealth;
                lastServerMoral = serverMoral;
                isFirstUpdate = false;
                return;
            }
            
            let updated = false;
            let changes = [];
            
            // Update health if server value differs from local OR from last server value
            const localHealth = characterData.health.current;
            if (serverHealth !== null && (serverHealth !== lastServerHealth || serverHealth !== localHealth)) {
                console.log('[WA-Sheet] ⚡ Health update:', { lastServer: lastServerHealth, server: serverHealth, local: localHealth });
                characterData.health.current = serverHealth;
                
                const healthInput = document.getElementById('health-current');
                const healthBar = document.getElementById('health-bar');
                console.log('[WA-Sheet] Health elements:', { input: !!healthInput, bar: !!healthBar });
                if (healthInput) {
                    healthInput.value = serverHealth;
                    console.log('[WA-Sheet] Set health input to:', serverHealth);
                }
                if (healthBar) healthBar.style.width = `${Math.min(100, Math.max(0, serverHealth))}%`;
                
                lastServerHealth = serverHealth;
                updated = true;
                changes.push('LP');
            }
            
            // Update moral if server value differs from local OR from last server value
            const localMoral = characterData.moral.current;
            if (serverMoral !== null && (serverMoral !== lastServerMoral || serverMoral !== localMoral)) {
                console.log('[WA-Sheet] ⚡ Moral update:', { lastServer: lastServerMoral, server: serverMoral, local: localMoral });
                characterData.moral.current = serverMoral;
                
                const moralInput = document.getElementById('moral-current');
                const moralBar = document.getElementById('moral-bar');
                console.log('[WA-Sheet] Moral elements:', { input: !!moralInput, bar: !!moralBar });
                if (moralInput) {
                    moralInput.value = serverMoral;
                    console.log('[WA-Sheet] Set moral input to:', serverMoral);
                }
                if (moralBar) moralBar.style.width = `${Math.min(100, Math.max(0, serverMoral))}%`;
                
                lastServerMoral = serverMoral;
                updated = true;
                changes.push('Moral');
            }
            
            // Check if this update was from GM (full sync)
            if (serverData.lastModifiedBy === 'gm') {
                console.log('[WA-Sheet] ⚡ GM modification detected - full sync');
                
                // Always update health/moral from GM regardless of comparison
                if (d.status?.health !== undefined) {
                    const gmHealth = parseInt(d.status.health);
                    if (gmHealth !== characterData.health.current) {
                        console.log('[WA-Sheet] GM Health force update:', characterData.health.current, '->', gmHealth);
                        characterData.health.current = gmHealth;
                        const healthInput = document.getElementById('health-current');
                        const healthBar = document.getElementById('health-bar');
                        if (healthInput) healthInput.value = gmHealth;
                        if (healthBar) healthBar.style.width = `${Math.min(100, Math.max(0, gmHealth))}%`;
                        lastServerHealth = gmHealth;
                        if (!changes.includes('LP')) changes.push('LP');
                        updated = true;
                    }
                }
                
                if (d.status?.moral !== undefined) {
                    const gmMoral = parseInt(d.status.moral);
                    if (gmMoral !== characterData.moral.current) {
                        console.log('[WA-Sheet] GM Moral force update:', characterData.moral.current, '->', gmMoral);
                        characterData.moral.current = gmMoral;
                        const moralInput = document.getElementById('moral-current');
                        const moralBar = document.getElementById('moral-bar');
                        if (moralInput) moralInput.value = gmMoral;
                        if (moralBar) moralBar.style.width = `${Math.min(100, Math.max(0, gmMoral))}%`;
                        lastServerMoral = gmMoral;
                        if (!changes.includes('Moral')) changes.push('Moral');
                        updated = true;
                    }
                }
                
                // Sync attributes
                if (d.attributes) {
                    const attrChanged = JSON.stringify(d.attributes) !== JSON.stringify(characterData.attributes);
                    if (attrChanged) {
                        characterData.attributes = { ...d.attributes };
                        changes.push('Attribute');
                        updated = true;
                        
                        // Update attribute inputs
                        ['power', 'agility', 'endurance', 'mind', 'presence'].forEach(attr => {
                            const input = document.getElementById(`attr-${attr}`);
                            if (input && d.attributes[attr] !== undefined) {
                                input.value = d.attributes[attr];
                            }
                        });
                    }
                }
                
                // Sync currency
                if (d.currency !== undefined && d.currency !== characterData.currency) {
                    characterData.currency = d.currency;
                    const currInput = document.getElementById('currency-amount');
                    if (currInput) currInput.value = d.currency;
                    changes.push('Währung');
                    updated = true;
                }
                
                // Sync inventory
                if (d.inventory && JSON.stringify(d.inventory) !== JSON.stringify(characterData.inventory)) {
                    characterData.inventory = [...d.inventory];
                    if (typeof renderInventory === 'function') renderInventory();
                    changes.push('Inventar');
                    updated = true;
                }
                
                // Sync notes
                if (d.notes !== undefined && d.notes !== characterData.notes) {
                    characterData.notes = d.notes;
                    const notesEl = document.getElementById('notes');
                    if (notesEl) notesEl.value = d.notes;
                    changes.push('Notizen');
                    updated = true;
                }
                
                // Sync Second Chance
                if (d.secondChance && JSON.stringify(d.secondChance) !== JSON.stringify(characterData.secondChance)) {
                    characterData.secondChance = [...d.secondChance];
                    if (typeof updateSecondChanceUI === 'function') updateSecondChanceUI();
                    changes.push('Zweite Chance');
                    updated = true;
                }
            }
            
            // Track if this was a GM change for the notification
            const isGMChange = serverData.lastModifiedBy === 'gm';
            
            if (updated) {
                console.log('[WA-Sheet] ✅ UI updated! Changes:', changes.join(', '), 'From GM:', isGMChange);
                
                // Update calculations
                if (typeof updateAllCalculations === 'function') {
                    updateAllCalculations();
                }
                
                // Update visual status bars
                if (typeof updateStatusBars === 'function') {
                    updateStatusBars();
                }
                
                // Only show flash effect and toast if change was from GM
                if (isGMChange) {
                    // Flash effect to show update - find the status section
                    const statusSection = document.querySelector('.status-section') || document.querySelector('.status-bars') || document.querySelector('[class*="status"]');
                    if (statusSection) {
                        statusSection.style.transition = 'box-shadow 0.3s, transform 0.3s';
                        statusSection.style.boxShadow = '0 0 30px rgba(139,92,246,0.9)';
                        statusSection.style.transform = 'scale(1.02)';
                        setTimeout(() => {
                            statusSection.style.boxShadow = '';
                            statusSection.style.transform = '';
                        }, 1500);
                    }
                    
                    // Toast notification - more specific message
                    const changeMsg = changes.length > 0 ? ` (${changes.join(', ')})` : '';
                    if (window.RIFT?.ui?.Toast) {
                        RIFT.ui.Toast.info(`👑 GM hat geändert:${changeMsg}`);
                    } else {
                        // Fallback: create a simple toast
                        const toast = document.createElement('div');
                        toast.style.cssText = 'position:fixed;bottom:20px;left:50%;transform:translateX(-50%);background:#8b5cf6;color:white;padding:12px 24px;border-radius:8px;font-size:14px;z-index:100000;box-shadow:0 4px 12px rgba(0,0,0,0.3);';
                        toast.textContent = `👑 GM hat geändert:${changeMsg}`;
                        document.body.appendChild(toast);
                        setTimeout(() => toast.remove(), 3000);
                    }
                }
                
                // Save to localStorage
                localStorage.setItem(STORAGE_KEY, JSON.stringify(characterData));
            }
        }

        function loadCharacter() {
            // URL-Parameter auslesen
            const urlParams = new URLSearchParams(window.location.search);
            const paramId = urlParams.get('id');
            const isNew = urlParams.get('new') === 'true';
            const isGM = urlParams.get('gm') === 'true';
            const roomCode = urlParams.get('room') || localStorage.getItem('rift_current_room');
            
            if (isNew) {
                // Neuer Charakter - leerer Bogen
                console.log('[WA-Sheet] Creating new character');
                characterData = getDefaultCharacter();
                // Alten localStorage löschen
                localStorage.removeItem(STORAGE_KEY);
                
                if (window.RIFT?.ui?.Toast) {
                    setTimeout(() => RIFT.ui.Toast.info('Neuer Worlds Apart Charakter'), 500);
                }
                return;
            }
            
            if (paramId) {
                // Erst aus CharacterStorage laden versuchen
                console.log('[WA-Sheet] Loading character from storage:', paramId);
                const char = CharacterStorage.getById(paramId);
                
                if (char && char.data) {
                    // Daten aus CharacterStorage in characterData konvertieren
                    loadCharacterFromData(char);
                    return;
                } else if (roomCode) {
                    // Nicht in localStorage gefunden - versuche aus Firestore zu laden (für GM-Ansicht)
                    console.log('[WA-Sheet] Character not in localStorage, trying Firestore...', paramId, roomCode);
                    loadCharacterFromFirestore(paramId, roomCode, isGM);
                    return;
                } else {
                    console.error('[WA-Sheet] Character not found:', paramId);
                    if (window.RIFT?.ui?.Toast) {
                        setTimeout(() => RIFT.ui.Toast.error('Charakter nicht gefunden'), 500);
                    }
                    // Zurück zur Übersicht
                    setTimeout(() => window.location.href = 'sheet.html', 2000);
                    characterData = getDefaultCharacter();
                    return;
                }
            }
            
            // Fallback: Altes localStorage System (für Kompatibilität)
            const saved = localStorage.getItem(STORAGE_KEY);
            characterData = saved ? { ...getDefaultCharacter(), ...JSON.parse(saved) } : getDefaultCharacter();
            
            // Ensure minimum skills exist
            ['handeln', 'wissen', 'soziales'].forEach(cat => {
                if (!characterData.skills[cat]) characterData.skills[cat] = [];
                while (characterData.skills[cat].length < DEFAULT_SKILLS_COUNT) {
                    characterData.skills[cat].push(EMPTY_SKILL());
                }
            });
        }
        
        function loadCharacterFromData(char) {
            // Daten aus CharacterStorage in characterData konvertieren
            characterData = getDefaultCharacter();
            characterData.name = char.name || '';
            
            // data-Felder übernehmen
            const d = char.data;
            characterData.race = d.race || char.race || '';
            characterData.age = d.age || '';
            characterData.gender = d.gender || '';
            characterData.role = d.role || char.class || '';
            characterData.crew = d.crew || '';
            characterData.appearance = d.appearance || '';
            characterData.inventory = d.inventory || '';
            characterData.currency = d.currency || '';
            characterData.weapon = d.weapon || '';
            characterData.notes = d.notes || '';
            
            if (d.attributes) {
                characterData.attributes = { ...characterData.attributes, ...d.attributes };
            }
            if (d.status) {
                characterData.health.current = d.status.health || 100;
                characterData.moral.current = d.status.moral || 100;
            }
            if (d.skills) {
                characterData.skills = d.skills;
            }
            if (d.fokus) {
                characterData.fokus = d.fokus;
            }
            if (d.schwaeche) {
                characterData.schwaeche = d.schwaeche;
            }
            if (d.portrait) {
                characterData.portrait = d.portrait;
            }
            if (d.jollyRoger) {
                characterData.jollyRoger = d.jollyRoger;
            }
            if (d.secondChance) {
                characterData.secondChance = d.secondChance;
            }
            
            // Charakter-ID merken für späteren Save
            window.currentCharId = char.id;
            CharacterStorage.updateLastPlayed(char.id);
            
            if (window.RIFT?.ui?.Toast) {
                setTimeout(() => RIFT.ui.Toast.success(`${char.name} geladen`), 500);
            }
        }
        
        async function loadCharacterFromFirestore(charId, roomCode, isGM) {
            console.log('[WA-Sheet] Loading from Firestore:', charId, roomCode, 'isGM:', isGM);
            
            // Set GM view mode globally
            if (isGM) {
                window.isGMViewMode = true;
                window.gmViewRoomCode = roomCode;
                window.gmViewCharId = charId;
                console.log('[WA-Sheet] GM View Mode enabled');
            }
            
            // Wait for Firebase to be ready
            if (window.RIFT?.firebase?.init) {
                try {
                    await window.RIFT.firebase.init();
                } catch (e) {
                    console.warn('[WA-Sheet] Firebase init error:', e);
                }
            }
            
            // Check if Firebase is available
            if (typeof firebase === 'undefined' || !firebase.apps || firebase.apps.length === 0) {
                console.error('[WA-Sheet] Firebase not available');
                if (window.RIFT?.ui?.Toast) {
                    RIFT.ui.Toast.error('Firebase nicht verfügbar');
                }
                characterData = getDefaultCharacter();
                populateFields();
                return;
            }
            
            try {
                const db = firebase.firestore();
                const normalizedCode = roomCode.replace(/-/g, '').toUpperCase();
                window.gmViewRoomCode = normalizedCode; // Store normalized version
                
                const charDoc = await db.collection('rooms').doc(normalizedCode)
                    .collection('characters').doc(charId).get();
                
                if (charDoc.exists) {
                    const charData = charDoc.data();
                    console.log('[WA-Sheet] Loaded from Firestore:', charData);
                    
                    // Store original ownerId for GM mode
                    if (isGM) {
                        window.gmViewOwnerId = charData.ownerId;
                    }
                    
                    // Convert to expected format and load
                    loadCharacterFromData({
                        id: charId,
                        name: charData.name,
                        data: charData.data || charData,
                        class: charData.class
                    });
                    
                    // Re-populate fields after async load
                    populateFields();
                    initializeSkills();
                    updateAllCalculations();
                    
                    // GM mode indicator and listener
                    if (isGM) {
                        // Add GM popup mode class to hide navigation/footer
                        document.body.classList.add('gm-popup-mode');
                        
                        // Add CSS to hide sidebar, topbar, footer, page-header
                        const gmStyle = document.createElement('style');
                        gmStyle.textContent = `
                            .gm-popup-mode .nav-sidebar,
                            .gm-popup-mode .topbar,
                            .gm-popup-mode .site-footer,
                            .gm-popup-mode footer,
                            .gm-popup-mode #gmPlayerBar,
                            .gm-popup-mode .adventure-bar,
                            .gm-popup-mode .page-header,
                            .gm-popup-mode [class*="sidebar"],
                            .gm-popup-mode [class*="topbar"],
                            .gm-popup-mode [class*="footer"]:not(.card-footer) {
                                display: none !important;
                            }
                            .gm-popup-mode .main-content,
                            .gm-popup-mode .sheet-container,
                            .gm-popup-mode .main,
                            .gm-popup-mode .main__content,
                            .gm-popup-mode main {
                                margin-left: 0 !important;
                                padding-left: 16px !important;
                                padding-right: 16px !important;
                                padding-top: 16px !important;
                                margin-top: 0 !important;
                                max-width: 100% !important;
                                width: 100% !important;
                            }
                            .gm-popup-mode .app {
                                padding-left: 0 !important;
                            }
                            .gm-popup-mode body,
                            .gm-popup-mode {
                                padding-top: 0 !important;
                                overflow-x: hidden;
                            }
                            /* Banner oben links statt oben rechts */
                            .gm-popup-mode .gm-banner {
                                position: fixed;
                                top: 8px;
                                left: 8px;
                                right: auto;
                            }
                        `;
                        document.head.appendChild(gmStyle);
                        
                        const gmBanner = document.createElement('div');
                        gmBanner.className = 'gm-banner';
                        gmBanner.style.cssText = 'position:fixed;top:10px;right:10px;background:rgba(139,92,246,0.9);color:white;padding:8px 16px;border-radius:8px;font-size:13px;z-index:1000;pointer-events:none;';
                        gmBanner.innerHTML = '👑 GM-Ansicht';
                        document.body.appendChild(gmBanner);
                        
                        // Start bidirectional listener for GM
                        setupGMModeBidirectionalListener();
                    }
                } else {
                    console.error('[WA-Sheet] Character not found in Firestore:', charId);
                    if (window.RIFT?.ui?.Toast) {
                        RIFT.ui.Toast.error('Charakter nicht gefunden');
                    }
                    characterData = getDefaultCharacter();
                    populateFields();
                }
            } catch (e) {
                console.error('[WA-Sheet] Firestore error:', e);
                if (window.RIFT?.ui?.Toast) {
                    RIFT.ui.Toast.error('Fehler beim Laden');
                }
                characterData = getDefaultCharacter();
                populateFields();
            }
        }

        function saveCharacter() {
            // Legacy: Speichere auch ins alte localStorage für Kompatibilität
            localStorage.setItem(STORAGE_KEY, JSON.stringify(characterData));
            
            // GM View Mode: Speichere direkt nach Firestore
            if (window.isGMViewMode && window.gmViewRoomCode && window.gmViewCharId) {
                console.log('[WA-Sheet] GM Mode - saving to Firestore');
                saveCharacterToFirestore();
                // NICHT returnen - auch lokal speichern für Fallback
            }
            
            // Ins neue CharacterStorage System speichern (falls vorhanden)
            if (typeof CharacterStorage !== 'undefined' && !window.isGMViewMode) {
                // Check if portrait is custom (base64) or use a preset
                let portraitValue = characterData.portrait;
                if (!portraitValue) {
                    // No custom portrait - use random preset
                    portraitValue = 'char_worldsapart_0' + (Math.floor(Math.random() * 7) + 1);
                }
                
                const charForStorage = {
                    id: window.currentCharId || null,
                    ruleset: 'worldsapart',
                    name: characterData.name || 'Unbenannt',
                    class: characterData.role || 'Pirat',
                    race: characterData.race || '',
                    level: 1,
                    portrait: portraitValue,
                    data: {
                        race: characterData.race,
                        age: characterData.age,
                        gender: characterData.gender,
                        crew: characterData.crew,
                        role: characterData.role,
                        appearance: characterData.appearance,
                        attributes: characterData.attributes,
                        status: {
                            health: characterData.health.current,
                            moral: characterData.moral.current
                        },
                        currency: characterData.currency,
                        weapon: characterData.weapon,
                        inventory: characterData.inventory,
                        notes: characterData.notes,
                        skills: characterData.skills,
                        fokus: characterData.fokus,
                        schwaeche: characterData.schwaeche,
                        portrait: characterData.portrait || null,
                        jollyRoger: characterData.jollyRoger || null,
                        secondChance: characterData.secondChance || [false, false, false]
                    }
                };
                
                // Nur speichern wenn Name vorhanden
                if (characterData.name && characterData.name.trim() !== '') {
                    const saved = CharacterStorage.save(charForStorage);
                    if (saved && !window.currentCharId) {
                        window.currentCharId = saved.id;
                        // URL aktualisieren
                        const newUrl = `sheet-worldsapart.html?id=${saved.id}`;
                        window.history.replaceState({}, '', newUrl);
                    }
                    // Note: CharacterStorage.save() already calls syncToRoom() automatically
                    // for Multi-Character Support via Firestore
                }
            }
        }
        
        // GM Mode: Speichere Änderungen direkt nach Firestore
        async function saveCharacterToFirestore() {
            if (!window.isGMViewMode) {
                console.log('[WA-Sheet GM] Not in GM mode, skipping');
                return;
            }
            
            const roomCode = window.gmViewRoomCode;
            const charId = window.gmViewCharId;
            
            console.log('[WA-Sheet GM] Saving to Firestore:', roomCode, charId);
            
            // Ensure Firebase is initialized
            if (typeof firebase === 'undefined') {
                console.error('[WA-Sheet GM] Firebase SDK not loaded');
                return;
            }
            
            // Initialize Firebase if needed
            if (!firebase.apps || firebase.apps.length === 0) {
                console.log('[WA-Sheet GM] Initializing Firebase...');
                if (window.RIFT?.firebase?.init) {
                    try {
                        await window.RIFT.firebase.init();
                    } catch (e) {
                        console.error('[WA-Sheet GM] Firebase init failed:', e);
                        return;
                    }
                } else {
                    console.error('[WA-Sheet GM] No Firebase init function');
                    return;
                }
            }
            
            try {
                const db = firebase.firestore();
                const charRef = db.collection('rooms').doc(roomCode)
                                 .collection('characters').doc(charId);
                
                // Build complete data object with ALL fields
                const updateData = {
                    name: characterData.name || 'Unbenannt',
                    class: characterData.role || 'Pirat',
                    data: {
                        age: characterData.age,
                        gender: characterData.gender,
                        crew: characterData.crew,
                        role: characterData.role,
                        appearance: characterData.appearance,
                        attributes: characterData.attributes,
                        status: {
                            health: characterData.health.current,
                            moral: characterData.moral.current
                        },
                        currency: characterData.currency,
                        weapon: characterData.weapon,
                        inventory: characterData.inventory,
                        notes: characterData.notes,
                        skills: characterData.skills,
                        fokus: characterData.fokus,
                        schwaeche: characterData.schwaeche,
                        portrait: characterData.portrait || null,
                        jollyRoger: characterData.jollyRoger || null,
                        secondChance: characterData.secondChance || [false, false, false]
                    },
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp(),
                    lastModifiedBy: 'gm'
                };
                
                await charRef.update(updateData);
                console.log('[WA-Sheet GM] ✅ Saved to Firestore successfully');
                
                // Visual feedback
                const banner = document.querySelector('[style*="GM-Ansicht"]');
                if (banner) {
                    banner.style.background = 'rgba(34, 197, 94, 0.9)';
                    banner.innerHTML = '👑 Gespeichert!';
                    setTimeout(() => {
                        banner.style.background = 'rgba(139,92,246,0.9)';
                        banner.innerHTML = '👑 GM-Ansicht (Live-Sync aktiv)';
                    }, 1000);
                }
                
            } catch (e) {
                console.error('[WA-Sheet GM] Firestore save error:', e);
                // Show error
                const banner = document.querySelector('[style*="GM-Ansicht"]');
                if (banner) {
                    banner.style.background = 'rgba(239, 68, 68, 0.9)';
                    banner.innerHTML = '❌ Speicherfehler!';
                    setTimeout(() => {
                        banner.style.background = 'rgba(139,92,246,0.9)';
                        banner.innerHTML = '👑 GM-Ansicht (Live-Sync aktiv)';
                    }, 2000);
                }
            }
        }

        function autoSave() {
            if (saveTimeout) clearTimeout(saveTimeout);
            saveTimeout = setTimeout(() => {
                saveCharacter();
                showSaveIndicator();
            }, 500);
        }

        function showSaveIndicator() {
            const indicator = document.getElementById('save-indicator');
            indicator.classList.add('show');
            setTimeout(() => indicator.classList.remove('show'), 1500);
        }

        function populateFields() {
            document.getElementById('char-name').value = characterData.name || '';
            document.getElementById('char-race').value = characterData.race || '';
            document.getElementById('char-age').value = characterData.age || '';
            document.getElementById('char-gender').value = characterData.gender || '';
            document.getElementById('char-role').value = characterData.role || '';
            document.getElementById('char-crew').value = characterData.crew || '';
            document.getElementById('char-appearance').value = characterData.appearance || '';
            document.getElementById('char-inventory').value = characterData.inventory || '';
            document.getElementById('char-currency').value = characterData.currency || '';
            document.getElementById('char-weapon').value = characterData.weapon || '';
            document.getElementById('char-notes').value = characterData.notes || '';
            
            ATTRIBUTES.forEach(attr => {
                document.getElementById(`attr-${attr}`).value = characterData.attributes[attr] || 0;
            });
            
            document.getElementById('health-current').value = characterData.health.current;
            document.getElementById('moral-current').value = characterData.moral.current;
            
            characterData.secondChance.forEach((used, i) => {
                if (used) document.getElementById(`dice-${i+1}`).classList.add('used');
            });
            
            if (characterData.portrait) {
                document.getElementById('portrait-img').src = characterData.portrait;
                document.getElementById('portrait-img').style.display = 'block';
                document.getElementById('portrait-placeholder').style.display = 'none';
            }
            
            if (characterData.jollyRoger) {
                document.getElementById('crew-flag-img').src = characterData.jollyRoger;
                document.getElementById('crew-flag-img').style.display = 'block';
                document.getElementById('crew-flag-placeholder').style.display = 'none';
            }
            
            updateFokusDisplay();
            updateSchwaecheDisplay();
            
            if (characterData.currencyType) {
                currencyIndex = CURRENCY_TYPES.indexOf(characterData.currencyType);
                if (currencyIndex === -1) currencyIndex = 0;
                document.getElementById('currency-icon').src = `assets/icons/icon_${CURRENCY_TYPES[currencyIndex]}.png`;
            }
        }

        // ===== EVENT LISTENERS =====
        document.addEventListener('DOMContentLoaded', function() {
            init();
            
            // Text inputs
            ['char-name', 'char-role', 'char-crew', 'char-appearance', 'char-inventory', 'char-weapon', 'char-notes'].forEach(id => {
                document.getElementById(id).addEventListener('input', (e) => {
                    const key = id.replace('char-', '');
                    characterData[key] = e.target.value;
                    autoSave();
                });
            });
            
            // Select dropdowns
            ['char-race', 'char-age', 'char-gender'].forEach(id => {
                document.getElementById(id).addEventListener('change', (e) => {
                    const key = id.replace('char-', '');
                    characterData[key] = e.target.value;
                    autoSave();
                });
            });
            
            ATTRIBUTES.forEach(attr => {
                document.getElementById(`attr-${attr}`).addEventListener('input', (e) => {
                    let value = parseInt(e.target.value) || 0;
                    value = Math.max(0, Math.min(10, value));
                    e.target.value = value;
                    characterData.attributes[attr] = value;
                    updateAllCalculations();
                    autoSave();
                });
            });
            
            document.getElementById('health-current').addEventListener('input', (e) => {
                let value = parseInt(e.target.value) || 0;
                value = Math.max(0, Math.min(100, value));
                e.target.value = value;
                characterData.health.current = value;
                updateStatBars();
                autoSave();
            });
            
            document.getElementById('moral-current').addEventListener('input', (e) => {
                let value = parseInt(e.target.value) || 0;
                value = Math.max(0, Math.min(100, value));
                e.target.value = value;
                characterData.moral.current = value;
                updateStatBars();
                autoSave();
            });
            
            // ===== STATUS BAR DRAG FUNCTIONALITY =====
            const draggableBars = document.querySelectorAll('.status-bar.draggable');
            let isDragging = false;
            let currentBar = null;
            
            function updateStatusFromPosition(bar, clientX) {
                const rect = bar.getBoundingClientRect();
                let percent = ((clientX - rect.left) / rect.width) * 100;
                percent = Math.max(0, Math.min(100, Math.round(percent)));
                
                const statusType = bar.dataset.status;
                if (statusType === 'health') {
                    characterData.health.current = percent;
                    document.getElementById('health-current').value = percent;
                    document.getElementById('health-bar').style.width = `${percent}%`;
                } else if (statusType === 'moral') {
                    characterData.moral.current = percent;
                    document.getElementById('moral-current').value = percent;
                    document.getElementById('moral-bar').style.width = `${percent}%`;
                }
                updateStatBars();
            }
            
            draggableBars.forEach(bar => {
                // Mouse events
                bar.addEventListener('mousedown', (e) => {
                    isDragging = true;
                    currentBar = bar;
                    updateStatusFromPosition(bar, e.clientX);
                    e.preventDefault();
                });
                
                // Touch events
                bar.addEventListener('touchstart', (e) => {
                    isDragging = true;
                    currentBar = bar;
                    updateStatusFromPosition(bar, e.touches[0].clientX);
                    e.preventDefault();
                }, { passive: false });
            });
            
            document.addEventListener('mousemove', (e) => {
                if (isDragging && currentBar) {
                    updateStatusFromPosition(currentBar, e.clientX);
                }
            });
            
            document.addEventListener('touchmove', (e) => {
                if (isDragging && currentBar) {
                    updateStatusFromPosition(currentBar, e.touches[0].clientX);
                }
            }, { passive: true });
            
            document.addEventListener('mouseup', () => {
                if (isDragging) {
                    isDragging = false;
                    currentBar = null;
                    autoSave();
                }
            });
            
            document.addEventListener('touchend', () => {
                if (isDragging) {
                    isDragging = false;
                    currentBar = null;
                    autoSave();
                }
            });
            
            // Initialize dice history
            setTimeout(() => {
                checkForDiceResult();
                renderDiceHistory();
            }, 100);
        }); // End DOMContentLoaded

        // ===== CALCULATIONS =====
        function updateAllCalculations() {
            updateAttributePoints();
            updateResonanz();
            updateStatBars();
            updateSkillBonuses();
            updateFokusDice();
        }
        
        // ===== DICE HISTORY =====
        const DICE_HISTORY_KEY = 'rift_dice_history';
        const MAX_HISTORY_ITEMS = 10;
        
        function getDiceHistory() {
            const charId = window.currentCharId;
            if (!charId) return [];
            const key = `${DICE_HISTORY_KEY}_${charId}`;
            const stored = localStorage.getItem(key);
            return stored ? JSON.parse(stored) : [];
        }
        
        function saveDiceHistory(history) {
            const charId = window.currentCharId;
            if (!charId) return;
            const key = `${DICE_HISTORY_KEY}_${charId}`;
            localStorage.setItem(key, JSON.stringify(history.slice(0, MAX_HISTORY_ITEMS)));
        }
        
        function addDiceHistoryEntry(entry) {
            const history = getDiceHistory();
            history.unshift({
                ...entry,
                timestamp: Date.now()
            });
            saveDiceHistory(history);
            renderDiceHistory();
        }
        window.addDiceHistoryEntry = addDiceHistoryEntry;
        
        function clearDiceHistory() {
            const charId = window.currentCharId;
            if (!charId) return;
            const key = `${DICE_HISTORY_KEY}_${charId}`;
            localStorage.removeItem(key);
            renderDiceHistory();
            if (window.RIFT?.ui?.Toast) {
                RIFT.ui.Toast.info('Würfel-Verlauf gelöscht');
            }
        }
        window.clearDiceHistory = clearDiceHistory;
        
        function renderDiceHistory() {
            const container = document.getElementById('dice-history-list');
            if (!container) return;
            
            const history = getDiceHistory();
            
            if (history.length === 0) {
                container.innerHTML = '<div class="dice-history-empty">Noch keine Würfe in dieser Session</div>';
                return;
            }
            
            container.innerHTML = history.map(entry => {
                const timeAgo = getTimeAgo(entry.timestamp);
                const resultClass = entry.success ? 'success' : 'failure';
                const itemClass = entry.critical ? 'critical' : resultClass;
                
                return `
                    <div class="dice-history-item ${itemClass}">
                        <span class="dice-history-label">${entry.label}</span>
                        <span class="dice-history-result ${resultClass}">${entry.result}</span>
                        <span class="dice-history-outcome ${resultClass}">${entry.outcome}</span>
                        <span class="dice-history-time">${timeAgo}</span>
                    </div>
                `;
            }).join('');
        }
        
        function getTimeAgo(timestamp) {
            const diff = Date.now() - timestamp;
            const mins = Math.floor(diff / 60000);
            const hours = Math.floor(diff / 3600000);
            
            if (mins < 1) return 'gerade';
            if (mins < 60) return `${mins}m`;
            if (hours < 24) return `${hours}h`;
            return new Date(timestamp).toLocaleDateString('de-DE');
        }
        
        // Check for returning dice result
        function checkForDiceResult() {
            const params = new URLSearchParams(window.location.search);
            const result = params.get('result');
            const label = params.get('label');
            const success = params.get('success');
            const outcome = params.get('outcome');
            const critical = params.get('critical');
            const zweiteChance = params.get('zweiteChance');
            const diceIndex = params.get('diceIndex');
            
            if (result && label) {
                // Handle Zweite Chance result
                if (zweiteChance === 'true' && diceIndex !== null) {
                    const idx = parseInt(diceIndex);
                    markDiceAsUsed(idx);
                    
                    // Show toast with result
                    if (window.RIFT?.ui?.Toast) {
                        if (success === 'true') {
                            RIFT.ui.Toast.success(`Zweite Chance: ${result} - Wiederholen erlaubt!`);
                        } else {
                            RIFT.ui.Toast.error(`Zweite Chance: ${result} - Fehlschlag bleibt!`);
                        }
                    }
                }
                
                addDiceHistoryEntry({
                    label: decodeURIComponent(label),
                    result: parseInt(result),
                    success: success === 'true',
                    outcome: decodeURIComponent(outcome || (success === 'true' ? 'Erfolg' : 'Fehlschlag')),
                    critical: critical === 'true'
                });
                
                // Clean URL
                const cleanUrl = window.location.pathname + (window.currentCharId ? `?id=${window.currentCharId}` : '');
                window.history.replaceState({}, document.title, cleanUrl);
            }
        }
        
        // Mark a Zweite Chance dice as used with dissolve animation
        function markDiceAsUsed(index) {
            const diceEl = document.getElementById(`dice-${index + 1}`);
            if (!diceEl || diceEl.classList.contains('used')) return;
            
            // Add dissolving animation
            diceEl.classList.add('dissolving');
            
            // After animation, add used class
            setTimeout(() => {
                diceEl.classList.remove('dissolving');
                diceEl.classList.add('used');
                
                // Update characterData
                characterData.secondChance[index] = true;
                autoSave();
            }, 800);
        }
        window.markDiceAsUsed = markDiceAsUsed;
        
        // GM Function: Reset all Zweite Chance dice
        function resetZweiteChance() {
            // Check if user is GM
            let isGM = false;
            try {
                let user = typeof getCurrentUser === 'function' ? getCurrentUser() : null;
                if (!user) {
                    const userData = localStorage.getItem('pnp_companion_user');
                    if (userData) user = JSON.parse(userData);
                }
                isGM = user?.isGM === true || user?.isGM === 'true';
            } catch(e) {
                isGM = false;
            }
            
            if (!isGM) {
                if (window.RIFT?.ui?.Toast) {
                    RIFT.ui.Toast.error('Nur der GM kann Zweite Chance wiederherstellen');
                }
                return;
            }
            
            // Reset all dice with restore animation
            for (let i = 0; i < 3; i++) {
                const diceEl = document.getElementById(`dice-${i + 1}`);
                if (diceEl && diceEl.classList.contains('used')) {
                    // Add restore animation
                    diceEl.classList.add('restoring');
                    
                    setTimeout(() => {
                        diceEl.classList.remove('used', 'restoring');
                    }, 400);
                }
            }
            
            // Update characterData
            characterData.secondChance = [false, false, false];
            autoSave();
            
            if (window.RIFT?.ui?.Toast) {
                RIFT.ui.Toast.success('Zweite Chance wiederhergestellt!');
            }
        }
        window.resetZweiteChance = resetZweiteChance;
        
        function updateAttributePoints() {
            let total = ATTRIBUTES.reduce((sum, attr) => sum + (characterData.attributes[attr] || 0), 0);
            const remaining = ATTR_TOTAL - total;
            const el = document.getElementById('attr-points');
            const textEl = document.getElementById('attr-points-text');
            
            if (remaining === 0) {
                textEl.textContent = 'Alle Attributs-Punkte verteilt';
                el.style.background = 'var(--accent-primary-dim)';
                el.style.color = 'var(--accent-primary)';
            } else if (remaining < 0) {
                textEl.textContent = `${Math.abs(remaining)} Punkte zu viel vergeben!`;
                el.style.background = 'var(--accent-primary-dim)';
                el.style.color = 'var(--accent-primary)';
            } else {
                textEl.textContent = `${remaining} / ${ATTR_TOTAL} Attributs-Punkte zu verteilen`;
                el.style.background = 'rgba(34, 197, 94, 0.15)';
                el.style.color = 'var(--color-green)';
            }
        }
        
        function updateResonanz() {
            const power = characterData.attributes.power || 0;
            const presence = characterData.attributes.presence || 0;
            const resonanz = 10 + (power * presence);
            document.getElementById('resonanz-display').textContent = resonanz;
            document.getElementById('resonanz-bar').style.width = `${Math.min(resonanz, 100)}%`;
            
            // Update tooltip with formula
            const container = document.getElementById('resonanz-container');
            if (container) {
                container.title = `10 + (${power} × ${presence}) = ${resonanz}`;
            }
        }
        
        function updateStatBars() {
            const healthPercent = characterData.health.current;
            const healthBar = document.getElementById('health-bar');
            healthBar.style.width = `${healthPercent}%`;
            
            // Dynamic health bar color: 100-51 Green, 50-16 Orange, 15-1 Red, 0 Black
            if (healthPercent === 0) {
                healthBar.style.background = '#1a1a1a';
                healthBar.style.backgroundSize = '100% 100%';
            } else if (healthPercent <= 15) {
                healthBar.style.background = 'linear-gradient(90deg, #8b0000, #dc2626, #8b0000)';
                healthBar.style.backgroundSize = '200% 100%';
            } else if (healthPercent <= 50) {
                healthBar.style.background = 'linear-gradient(90deg, #b45309, #f59e0b, #b45309)';
                healthBar.style.backgroundSize = '200% 100%';
            } else {
                healthBar.style.background = 'linear-gradient(90deg, #166534, #22c55e, #166534)';
                healthBar.style.backgroundSize = '200% 100%';
            }
            
            // Update portrait health overlay
            const overlay = document.getElementById('portrait-health-overlay');
            overlay.classList.remove('dead', 'critical', 'low', 'healthy');
            if (healthPercent === 0) {
                overlay.classList.add('dead');
            } else if (healthPercent <= 15) {
                overlay.classList.add('critical');
            } else if (healthPercent <= 50) {
                overlay.classList.add('low');
            } else {
                overlay.classList.add('healthy');
            }
            
            // Update status bar critical states
            if (healthBar) {
                healthBar.classList.toggle('critical', healthPercent <= 20 && healthPercent > 0);
            }
            
            const moralPercent = characterData.moral.current;
            const moralBar = document.getElementById('moral-bar');
            moralBar.style.width = `${moralPercent}%`;
            
            // Add critical pulse for low moral
            if (moralBar) {
                moralBar.classList.toggle('critical', moralPercent <= 20 && moralPercent > 0);
            }
        }
        
        function calculateClassBonus(category) {
            return (CLASS_ATTRIBUTE_MAP[category] || []).reduce((sum, attr) => sum + (characterData.attributes[attr] || 0), 0);
        }
        
        function updateSkillBonuses() {
            let totalSkillPoints = 0;
            
            ['handeln', 'wissen', 'soziales'].forEach(category => {
                const skills = characterData.skills[category] || [];
                const categorySpent = skills.reduce((sum, s) => sum + (parseInt(s.value) || 0), 0);
                totalSkillPoints += categorySpent;
                const classBonus = calculateClassBonus(category);
                const classTotal = Math.min(Math.floor(categorySpent / 10) + classBonus, 95);
                
                document.getElementById(`${category}-total`).textContent = classTotal;
                document.getElementById(`${category}-bonus`).textContent = `+${classBonus}`;
                
                document.querySelectorAll(`#skills-${category} .skill-bonus`).forEach(el => {
                    el.textContent = `+${classBonus}`;
                });
            });
            
            // Update total skill points display
            const remaining = SKILL_TOTAL - totalSkillPoints;
            const el = document.getElementById('skill-points');
            const textEl = document.getElementById('skill-points-text');
            
            if (remaining <= 0) {
                textEl.textContent = remaining === 0 ? 'Alle Punkte verteilt' : `${Math.abs(remaining)} Punkte zu viel!`;
                el.style.background = 'var(--accent-primary-dim)';
                el.style.color = 'var(--accent-primary)';
            } else {
                textEl.textContent = `${remaining} / ${SKILL_TOTAL} Punkte verfügbar`;
                el.style.background = 'rgba(34, 197, 94, 0.15)';
                el.style.color = 'var(--color-green)';
            }
        }

        // ===== SKILLS =====
        function initializeSkills() {
            ['handeln', 'wissen', 'soziales'].forEach(renderSkills);
        }
        
        function renderSkills(category) {
            const container = document.getElementById(`skills-${category}`);
            const skills = characterData.skills[category] || [];
            const bonus = calculateClassBonus(category);
            
            container.innerHTML = skills.map((skill, i) => `
                <div class="skill-row">
                    <div class="skill-prof ${skill.proficient ? 'active' : ''}" onclick="toggleSkillProf('${category}', ${i})"></div>
                    <input type="text" class="skill-name-input" value="${skill.name}" placeholder="Fähigkeit..." onchange="updateSkillName('${category}', ${i}, this.value)">
                    <input type="number" class="skill-value-input" value="${skill.value}" min="0" max="100" onchange="updateSkillValue('${category}', ${i}, this.value)" onfocus="this.select()">
                    <span class="skill-bonus">+${bonus}</span>
                    <button class="skill-roll-btn" onclick="rollSkill('${category}', ${i})" title="Würfeln">
                        <svg viewBox="0 0 24 24" fill="currentColor" width="14" height="14"><path d="M5 3h14a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2m3 12a2 2 0 0 0-2 2 2 2 0 0 0 2 2 2 2 0 0 0 2-2 2 2 0 0 0-2-2m8-8a2 2 0 0 0-2 2 2 2 0 0 0 2 2 2 2 0 0 0 2-2 2 2 0 0 0-2-2m0 8a2 2 0 0 0-2 2 2 2 0 0 0 2 2 2 2 0 0 0 2-2 2 2 0 0 0-2-2m-4-4a2 2 0 0 0-2 2 2 2 0 0 0 2 2 2 2 0 0 0 2-2 2 2 0 0 0-2-2m-4-4a2 2 0 0 0-2 2 2 2 0 0 0 2 2 2 2 0 0 0 2-2 2 2 0 0 0-2-2Z"/></svg>
                    </button>
                    <button class="skill-delete-btn" onclick="deleteSkill('${category}', ${i})" title="Löschen">×</button>
                </div>
            `).join('');
        }
        
        function rollSkill(category, index) {
            const skill = characterData.skills[category][index];
            const bonus = calculateClassBonus(category);
            const totalValue = (parseInt(skill.value) || 0) + bonus;
            const skillName = skill.name || 'Skill';
            
            // Navigate to dice.html with parameters for d100 roll
            const params = new URLSearchParams({
                dice: 'd100',
                mod: totalValue,
                label: skillName,
                roll: '1',
                return: window.location.pathname.split('/').pop() + window.location.search
            });
            
            window.location.href = `dice.html?${params.toString()}`;
        }
        window.rollSkill = rollSkill;
        
        function rollZweiteChance(diceIndex) {
            // Check if this die is already used
            if (characterData.secondChance[diceIndex]) {
                if (window.RIFT?.ui?.Toast) {
                    RIFT.ui.Toast.warning('Diese Zweite Chance wurde bereits genutzt');
                }
                return;
            }
            
            // Check if any dice left
            const remaining = characterData.secondChance.filter(used => !used).length;
            if (remaining === 0) {
                if (window.RIFT?.ui?.Toast) {
                    RIFT.ui.Toast.error('Alle Zweite Chance Versuche aufgebraucht');
                }
                return;
            }
            
            // Navigate to dice.html for d20 roll
            const params = new URLSearchParams({
                dice: 'd20',
                mod: 0,
                label: 'Zweite Chance',
                check: 'zweitechance',
                diceIndex: diceIndex,
                roll: '1',
                return: window.location.pathname.split('/').pop() + window.location.search
            });
            
            window.location.href = `dice.html?${params.toString()}`;
        }
        window.rollZweiteChance = rollZweiteChance;
        
        function rollFokus() {
            const fokusType = characterData.fokus?.type;
            if (!fokusType || fokusType === 'none') {
                if (window.RIFT?.ui?.Toast) {
                    RIFT.ui.Toast.warning('Kein Fokus gewählt');
                }
                return;
            }
            
            // Get Fokus data
            const fokusData = FOKUS_DATA[fokusType];
            const fokusName = fokusData?.name || 'Fokus';
            
            // Calculate full Fokus bonus: Attribute + Resonanz/10
            const attrKey = FOKUS_ATTRIBUTE_MAP[fokusType];
            const attrValue = characterData.attributes[attrKey] || 0;
            const resonanz = 10 + ((characterData.attributes.power || 0) * (characterData.attributes.presence || 0));
            const resonanzBonus = Math.floor(resonanz / 10);
            const totalBonus = attrValue + resonanzBonus;
            
            // Navigate to dice.html for d20 roll with Fokus check
            const params = new URLSearchParams({
                dice: 'd20',
                mod: totalBonus,
                label: fokusName,
                check: 'fokus',
                roll: '1',
                return: window.location.pathname.split('/').pop() + window.location.search
            });
            
            window.location.href = `dice.html?${params.toString()}`;
        }
        window.rollFokus = rollFokus;
        
        function deleteSkill(category, index) {
            characterData.skills[category].splice(index, 1);
            renderSkills(category);
            updateSkillBonuses();
            autoSave();
        }
        
        function toggleSkillProf(category, index) {
            characterData.skills[category][index].proficient = !characterData.skills[category][index].proficient;
            renderSkills(category);
            autoSave();
        }
        
        function addSkill(category) {
            characterData.skills[category].push({ name: '', value: 0, proficient: true });
            renderSkills(category);
            autoSave();
        }
        
        // Skill Catalog Functions
        let currentCatalogCategory = null;
        
        function openSkillCatalog(category) {
            currentCatalogCategory = category;
            renderSkillCatalog();
            document.getElementById('skill-catalog-popup').classList.add('active');
        }
        
        function closeSkillCatalog() {
            document.getElementById('skill-catalog-popup').classList.remove('active');
            currentCatalogCategory = null;
        }
        
        function renderSkillCatalog() {
            const container = document.getElementById('catalog-grid');
            const catalogSkills = SKILL_CATALOG[currentCatalogCategory] || [];
            const existingSkills = characterData.skills[currentCatalogCategory].map(s => s.name);
            
            container.innerHTML = catalogSkills.map(skill => {
                const isAdded = existingSkills.includes(skill);
                return `
                    <div class="catalog-item ${isAdded ? 'added' : ''}">
                        <span class="catalog-item-name">${skill}</span>
                        ${isAdded 
                            ? `<button class="catalog-item-btn remove" onclick="removeSkillFromCatalog('${skill}')">Entfernen</button>`
                            : `<button class="catalog-item-btn add" onclick="addSkillFromCatalog('${skill}')">Übernehmen</button>`
                        }
                    </div>
                `;
            }).join('');
        }
        
        function addSkillFromCatalog(skillName) {
            // Find first empty slot
            const emptyIndex = characterData.skills[currentCatalogCategory].findIndex(s => !s.name || s.name.trim() === '');
            
            if (emptyIndex !== -1) {
                // Fill empty slot
                characterData.skills[currentCatalogCategory][emptyIndex] = { name: skillName, value: 0, proficient: true };
            } else {
                // No empty slot, add new
                characterData.skills[currentCatalogCategory].push({ name: skillName, value: 0, proficient: true });
            }
            
            renderSkills(currentCatalogCategory);
            renderSkillCatalog();
            updateSkillBonuses();
            autoSave();
        }
        
        function removeSkillFromCatalog(skillName) {
            const index = characterData.skills[currentCatalogCategory].findIndex(s => s.name === skillName);
            if (index !== -1) {
                characterData.skills[currentCatalogCategory].splice(index, 1);
                renderSkills(currentCatalogCategory);
                renderSkillCatalog();
                updateSkillBonuses();
                autoSave();
            }
        }
        
        function updateSkillName(category, index, value) {
            characterData.skills[category][index].name = value;
            autoSave();
        }
        
        function updateSkillValue(category, index, value) {
            let val = parseInt(value) || 0;
            val = Math.max(0, Math.min(100, val)); // Cap at 100
            characterData.skills[category][index].value = val;
            // Update input if capped
            const inputs = document.querySelectorAll(`#skills-${category} .skill-value-input`);
            if (inputs[index]) inputs[index].value = val;
            updateSkillBonuses();
            autoSave();
        }
        
        function switchSkillTab(category) {
            document.querySelectorAll('.skill-tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.skill-panel').forEach(p => p.classList.remove('active'));
            document.querySelector(`.skill-tab[data-category="${category}"]`).classList.add('active');
            document.getElementById(`panel-${category}`).classList.add('active');
        }

        // ===== FOKUS =====
        function updateFokusDisplay() {
            const fokusType = characterData.fokus?.type;
            const iconEl = document.getElementById('fokus-icon');
            const nameEl = document.getElementById('fokus-name');
            const attrEl = document.getElementById('fokus-attr');
            const diceEl = document.getElementById('fokus-dice');
            const abilitiesEl = document.getElementById('fokus-abilities');
            const layoutEl = document.querySelector('.fokus-layout');
            
            // Remove existing particles
            const existingParticles = layoutEl.querySelector('.fokus-particles');
            if (existingParticles) existingParticles.remove();
            
            if (fokusType && fokusType !== 'none' && FOKUS_DATA[fokusType]) {
                const data = FOKUS_DATA[fokusType];
                // Colored icon based on element
                const iconColor = data.color || 'var(--text-secondary)';
                iconEl.innerHTML = `<img src="assets/icons/${data.icon}" alt="${data.name}" style="filter: drop-shadow(0 0 6px ${iconColor});">`;
                iconEl.style.borderColor = iconColor;
                iconEl.style.boxShadow = `0 0 12px ${iconColor}40`;
                
                // Add particles to layout
                const particlesHtml = `<div class="fokus-particles">
                    <div class="fokus-particle" style="background: ${iconColor}; box-shadow: 0 0 6px ${iconColor};"></div>
                    <div class="fokus-particle" style="background: ${iconColor}; box-shadow: 0 0 6px ${iconColor};"></div>
                    <div class="fokus-particle" style="background: ${iconColor}; box-shadow: 0 0 6px ${iconColor};"></div>
                    <div class="fokus-particle" style="background: ${iconColor}; box-shadow: 0 0 6px ${iconColor};"></div>
                    <div class="fokus-particle" style="background: ${iconColor}; box-shadow: 0 0 6px ${iconColor};"></div>
                    <div class="fokus-particle" style="background: ${iconColor}; box-shadow: 0 0 6px ${iconColor};"></div>
                    <div class="fokus-particle" style="background: ${iconColor}; box-shadow: 0 0 6px ${iconColor};"></div>
                    <div class="fokus-particle" style="background: ${iconColor}; box-shadow: 0 0 6px ${iconColor};"></div>
                </div>`;
                layoutEl.insertAdjacentHTML('afterbegin', particlesHtml);
                
                nameEl.textContent = data.name;
                
                // Calculate and display attribute + resonanz bonus
                const attrKey = FOKUS_ATTRIBUTE_MAP[fokusType];
                const attrValue = characterData.attributes[attrKey] || 0;
                const resonanz = 10 + ((characterData.attributes.power || 0) * (characterData.attributes.presence || 0));
                const resonanzBonus = Math.floor(resonanz / 10);
                const totalBonus = attrValue + resonanzBonus;
                attrEl.innerHTML = `${data.attr} (${attrValue}) + RES (${resonanzBonus}) = <strong>+${totalBonus}</strong>`;
                
                diceEl.style.display = 'block';
                updateFokusDice();
                
                const abilities = characterData.fokus.abilities || [];
                const allAbilities = [...data.attacks, ...data.defenses];
                
                abilitiesEl.innerHTML = abilities.length > 0 
                    ? abilities.map(name => {
                        const ab = allAbilities.find(a => a.name === name);
                        const isAttack = data.attacks.some(a => a.name === name);
                        return `<div class="fokus-ability" onclick="openFokusPopup()">
                            <div class="fokus-ability-type">${isAttack ? '⚔️ Angriff' : '🛡️ Verteidigung'}</div>
                            <div class="fokus-ability-name">${name}</div>
                            <div class="fokus-ability-desc">${ab?.desc || ''}</div>
                        </div>`;
                    }).join('') + (abilities.length < 2 ? `<div class="fokus-ability empty" onclick="openFokusPopup()"><span>+ Fähigkeit</span></div>` : '')
                    : `<div class="fokus-ability empty" onclick="openFokusPopup()"><span>Fähigkeit 1</span></div><div class="fokus-ability empty" onclick="openFokusPopup()"><span>Fähigkeit 2</span></div>`;
            } else if (fokusType === 'none') {
                iconEl.innerHTML = `<img src="assets/icons/icon_nofocus.png" style="opacity: 0.5;">`;
                iconEl.style.borderColor = 'var(--border-default)';
                iconEl.style.boxShadow = 'none';
                nameEl.textContent = 'Ohne Fokus';
                attrEl.textContent = 'Keine magischen Fähigkeiten';
                diceEl.style.display = 'none';
                abilitiesEl.innerHTML = `<div class="fokus-ability no-fokus-message" onclick="openFokusPopup()">
                    <div class="no-fokus-text">Du hast dich entschieden, das Abenteuer ohne Fokus-Fähigkeiten zu spielen.</div>
                </div>`;
            } else {
                iconEl.innerHTML = '<span style="color: var(--text-muted); font-size: 24px;">?</span>';
                iconEl.style.borderColor = 'var(--border-default)';
                iconEl.style.boxShadow = 'none';
                nameEl.textContent = 'Kein Fokus gewählt';
                attrEl.textContent = 'Klicke um zu wählen';
                diceEl.style.display = 'none';
                abilitiesEl.innerHTML = `<div class="fokus-ability empty" onclick="openFokusPopup()"><span>Fähigkeit 1</span></div><div class="fokus-ability empty" onclick="openFokusPopup()"><span>Fähigkeit 2</span></div>`;
            }
        }
        
        function updateFokusDice() {
            const fokusType = characterData.fokus?.type;
            if (!fokusType || fokusType === 'none') return;
            const attrValue = characterData.attributes[FOKUS_ATTRIBUTE_MAP[fokusType]] || 0;
            // Resonanz = 10 + (power * presence)
            const resonanz = 10 + ((characterData.attributes.power || 0) * (characterData.attributes.presence || 0));
            const resonanzBonus = Math.floor(resonanz / 10);
            const totalBonus = attrValue + resonanzBonus;
            document.getElementById('fokus-formula').textContent = `W20+${totalBonus}`;
        }
        
        function openFokusPopup() {
            selectedFokusType = characterData.fokus?.type || null;
            selectedFokusAbilities = [...(characterData.fokus?.abilities || [])];
            renderFokusTypeGrid();
            renderFokusAbilities();
            updateFokusPopupInfo();
            document.getElementById('fokus-popup').classList.add('active');
        }
        
        function closeFokusPopup() {
            document.getElementById('fokus-popup').classList.remove('active');
        }
        
        function renderFokusTypeGrid() {
            document.getElementById('fokus-type-grid').innerHTML = Object.entries(FOKUS_DATA).map(([key, data]) => {
                const isActive = selectedFokusType === key;
                const elementColor = data.color || 'var(--accent-primary)';
                const activeStyle = isActive ? `style="border-color: ${elementColor}; background: ${elementColor}20;"` : '';
                return `
                <button class="fokus-type-btn ${isActive ? 'active' : ''}" ${activeStyle} onclick="selectFokusType('${key}')" data-color="${elementColor}">
                    <img src="assets/icons/${data.icon}" alt="${data.name}">
                    <span ${isActive ? `style="color: ${elementColor};"` : ''}>${data.name}</span>
                </button>
            `;
            }).join('');
        }
        
        function selectFokusType(type) {
            if (selectedFokusType !== type) {
                selectedFokusType = type;
                selectedFokusAbilities = [];
            }
            renderFokusTypeGrid();
            renderFokusAbilities();
            updateFokusPopupInfo();
        }
        
        function renderFokusAbilities() {
            const container = document.getElementById('fokus-abilities-container');
            if (!selectedFokusType || selectedFokusType === 'none') {
                container.innerHTML = selectedFokusType === 'none' ? '<p style="color: var(--text-muted); text-align: center; padding: 20px;">Ohne magische Fähigkeiten spielen.</p>' : '';
                return;
            }
            
            const data = FOKUS_DATA[selectedFokusType];
            const elementColor = data.color || 'var(--accent-primary)';
            
            // Calculate attribute + resonanz bonus for display
            const attrKey = FOKUS_ATTRIBUTE_MAP[selectedFokusType];
            const attrValue = characterData.attributes[attrKey] || 0;
            const resonanz = 10 + ((characterData.attributes.power || 0) * (characterData.attributes.presence || 0));
            const resonanzBonus = Math.floor(resonanz / 10);
            const totalBonus = attrValue + resonanzBonus;
            
            container.innerHTML = `
                <div class="fokus-attr-info">${data.attr} (${attrValue}) + RES (${resonanzBonus}) = <strong style="color: ${elementColor};">+${totalBonus}</strong></div>
                <div class="fokus-section-title" style="color: ${elementColor};">⚔️ Angriffe</div>
                <div class="fokus-ability-grid">
                    ${data.attacks.map(ab => {
                        const sel = selectedFokusAbilities.includes(ab.name);
                        const dis = !sel && selectedFokusAbilities.length >= 2;
                        const selStyle = sel ? `style="border-color: ${elementColor}; background: ${elementColor}20;"` : '';
                        return `<div class="fokus-ability-option ${sel ? 'selected' : ''} ${dis ? 'disabled' : ''}" ${selStyle} onclick="toggleFokusAbility('${ab.name}', ${dis})">
                            <div class="fokus-ability-option-name">${ab.name}</div>
                            <div class="fokus-ability-option-desc">${ab.desc}</div>
                        </div>`;
                    }).join('')}
                </div>
                <div class="fokus-section-title" style="color: ${elementColor};">🛡️ Verteidigung</div>
                <div class="fokus-ability-grid">
                    ${data.defenses.map(ab => {
                        const sel = selectedFokusAbilities.includes(ab.name);
                        const dis = !sel && selectedFokusAbilities.length >= 2;
                        const selStyle = sel ? `style="border-color: ${elementColor}; background: ${elementColor}20;"` : '';
                        return `<div class="fokus-ability-option ${sel ? 'selected' : ''} ${dis ? 'disabled' : ''}" ${selStyle} onclick="toggleFokusAbility('${ab.name}', ${dis})">
                            <div class="fokus-ability-option-name">${ab.name}</div>
                            <div class="fokus-ability-option-desc">${ab.desc}</div>
                        </div>`;
                    }).join('')}
                </div>
            `;
        }
        
        function toggleFokusAbility(name, disabled) {
            if (disabled) return;
            const idx = selectedFokusAbilities.indexOf(name);
            if (idx > -1) selectedFokusAbilities.splice(idx, 1);
            else if (selectedFokusAbilities.length < 2) selectedFokusAbilities.push(name);
            renderFokusAbilities();
            updateFokusPopupInfo();
        }
        
        function updateFokusPopupInfo() {
            const info = document.getElementById('fokus-selection-info');
            const btn = document.getElementById('fokus-confirm-btn');
            if (!selectedFokusType) { info.textContent = 'Wähle einen Fokus-Typ'; btn.disabled = true; }
            else if (selectedFokusType === 'none') { info.textContent = 'Ohne Fokus spielen'; btn.disabled = false; }
            else { info.textContent = `${selectedFokusAbilities.length} / 2 Fähigkeiten`; btn.disabled = selectedFokusAbilities.length === 0; }
        }
        
        function confirmFokusSelection() {
            characterData.fokus = { type: selectedFokusType, abilities: selectedFokusType === 'none' ? [] : selectedFokusAbilities };
            updateFokusDisplay();
            closeFokusPopup();
            autoSave();
        }

        // ===== SCHWÄCHE =====
        function openSchwaechePopup() {
            selectedSchwaeche = characterData.schwaeche || null;
            renderSchwaecheGrid();
            document.getElementById('schwaeche-popup').classList.add('active');
        }

        function closeSchwaechePopup() {
            document.getElementById('schwaeche-popup').classList.remove('active');
        }

        function renderSchwaecheGrid() {
            const grid = document.getElementById('schwaeche-grid');
            grid.innerHTML = SCHWAECHE_DATA.map(s => `
                <div class="schwaeche-option ${selectedSchwaeche === s.id ? 'selected' : ''}" onclick="selectSchwaeche('${s.id}')">
                    <div class="schwaeche-option-name">${s.name}</div>
                    <div class="schwaeche-option-bedeutung">${s.bedeutung}</div>
                    <div class="schwaeche-option-wuerfel">${s.wuerfel}</div>
                    <div class="schwaeche-option-trigger">Trigger: ${s.trigger}</div>
                </div>
            `).join('');
        }

        function selectSchwaeche(id) {
            selectedSchwaeche = selectedSchwaeche === id ? null : id;
            renderSchwaecheGrid();
        }

        function clearSchwaeche() {
            selectedSchwaeche = null;
            characterData.schwaeche = null;
            updateSchwaecheDisplay();
            closeSchwaechePopup();
            autoSave();
        }

        function confirmSchwaecheSelection() {
            characterData.schwaeche = selectedSchwaeche;
            updateSchwaecheDisplay();
            closeSchwaechePopup();
            autoSave();
        }

        function updateSchwaecheDisplay() {
            const display = document.getElementById('schwaeche-display');
            const schwaeche = SCHWAECHE_DATA.find(s => s.id === characterData.schwaeche);
            
            if (schwaeche) {
                display.innerHTML = `
                    <div class="schwaeche-selected">
                        <div class="schwaeche-name">${schwaeche.name}</div>
                        <div class="schwaeche-bedeutung">${schwaeche.bedeutung}</div>
                        <div class="schwaeche-wuerfel">${schwaeche.wuerfel}</div>
                        <div class="schwaeche-trigger">Trigger: ${schwaeche.trigger}</div>
                    </div>
                `;
            } else {
                display.innerHTML = '<div class="schwaeche-empty">Keine Schwäche gewählt</div>';
            }
        }

        // ===== RAST =====
        function langeRast() {
            const btn = document.querySelector('.rast-btn.lange');
            const vignette = document.getElementById('vignette-lange');
            btn.classList.add('animating');
            vignette.classList.add('flash');
            setTimeout(() => {
                btn.classList.remove('animating');
                vignette.classList.remove('flash');
            }, 800);
            
            characterData.health.current = Math.min(100, characterData.health.current + 20);
            characterData.moral.current = Math.min(100, characterData.moral.current + 10);
            document.getElementById('health-current').value = characterData.health.current;
            document.getElementById('moral-current').value = characterData.moral.current;
            updateStatBars();
            autoSave();
            showRastNotification('Lange Rast: +20 LP, +10 Moral');
        }

        function kurzeRast() {
            const btn = document.querySelector('.rast-btn.kurze');
            const vignette = document.getElementById('vignette-kurze');
            btn.classList.add('animating');
            vignette.classList.add('flash');
            setTimeout(() => {
                btn.classList.remove('animating');
                vignette.classList.remove('flash');
            }, 800);
            
            characterData.health.current = Math.min(100, characterData.health.current + 10);
            characterData.moral.current = Math.min(100, characterData.moral.current + 5);
            document.getElementById('health-current').value = characterData.health.current;
            document.getElementById('moral-current').value = characterData.moral.current;
            updateStatBars();
            autoSave();
            showRastNotification('Kurze Rast: +10 LP, +5 Moral');
        }

        function showRastNotification(message) {
            const indicator = document.getElementById('save-indicator');
            indicator.textContent = message;
            indicator.classList.add('active');
            setTimeout(() => indicator.classList.remove('active'), 2000);
            setTimeout(() => indicator.textContent = '✓ Gespeichert', 2500);
        }

        // ===== DICE =====
        function toggleDice(index) {
            characterData.secondChance[index] = !characterData.secondChance[index];
            document.getElementById(`dice-${index+1}`).classList.toggle('used');
            autoSave();
        }

        // ===== CURRENCY =====
        function rotateCurrency() {
            currencyIndex = (currencyIndex + 1) % CURRENCY_TYPES.length;
            characterData.currencyType = CURRENCY_TYPES[currencyIndex];
            document.getElementById('currency-icon').src = `assets/icons/icon_${CURRENCY_TYPES[currencyIndex]}.png`;
            autoSave();
        }
        
        function formatCurrency(input) {
            // Remove all non-digits
            let value = input.value.replace(/\D/g, '');
            // Format with thousands separator (dots)
            if (value) {
                value = parseInt(value, 10).toLocaleString('de-DE');
            }
            input.value = value;
            // Store raw number in characterData
            characterData.currency = value;
            autoSave();
        }

        // ===== FILE UPLOADS =====
        function compressImage(dataUrl, maxWidth, maxHeight, quality) {
            return new Promise((resolve) => {
                const img = new Image();
                img.onload = () => {
                    const canvas = document.createElement('canvas');
                    let width = img.width;
                    let height = img.height;
                    
                    // Calculate new dimensions
                    if (width > maxWidth) {
                        height = (height * maxWidth) / width;
                        width = maxWidth;
                    }
                    if (height > maxHeight) {
                        width = (width * maxHeight) / height;
                        height = maxHeight;
                    }
                    
                    canvas.width = width;
                    canvas.height = height;
                    const ctx = canvas.getContext('2d');
                    ctx.drawImage(img, 0, 0, width, height);
                    resolve(canvas.toDataURL('image/jpeg', quality));
                };
                img.src = dataUrl;
            });
        }
        
        function uploadPortrait(event) {
            const file = event.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = async (e) => {
                // Compress image to max 200x250, 70% quality
                const compressed = await compressImage(e.target.result, 200, 250, 0.85);
                characterData.portrait = compressed;
                document.getElementById('portrait-img').src = compressed;
                document.getElementById('portrait-img').style.display = 'block';
                document.getElementById('portrait-placeholder').style.display = 'none';
                autoSave();
            };
            reader.readAsDataURL(file);
        }
        
        function uploadJolly(event) {
            const file = event.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = async (e) => {
                // Compress image to max 60x60, 70% quality
                const compressed = await compressImage(e.target.result, 150, 150, 0.85);
                characterData.jollyRoger = compressed;
                document.getElementById('crew-flag-img').src = compressed;
                document.getElementById('crew-flag-img').style.display = 'block';
                document.getElementById('crew-flag-placeholder').style.display = 'none';
                autoSave();
            };
            reader.readAsDataURL(file);
        }
        
        function removePortrait() {
            event.stopPropagation();
            characterData.portrait = null;
            document.getElementById('portrait-img').src = '';
            document.getElementById('portrait-img').style.display = 'none';
            document.getElementById('portrait-placeholder').style.display = 'block';
            autoSave();
        }
        
        function removeCrewFlag() {
            event.stopPropagation();
            characterData.jollyRoger = null;
            document.getElementById('crew-flag-img').src = '';
            document.getElementById('crew-flag-img').style.display = 'none';
            document.getElementById('crew-flag-placeholder').style.display = 'block';
            autoSave();
        }

        // ===== HAUPTCHARAKTER =====
        function toggleMainCharacter() {
            if (!window.currentCharId) {
                // Character not saved yet - save first
                saveCharacter();
                if (!window.currentCharId) {
                    alert('Bitte speichere zuerst den Charakter (gib ihm einen Namen).');
                    return;
                }
            }
            
            if (typeof CharacterStorage === 'undefined') {
                console.error('[WA-Sheet] CharacterStorage not available');
                return;
            }
            
            const isMain = CharacterStorage.isMainCharacter(window.currentCharId);
            
            if (!isMain) {
                // Set as main
                CharacterStorage.setMainCharacter(window.currentCharId, 'worldsapart');
                updateMainCharButton(true);
                
                // Show toast if available
                if (window.RIFT?.ui?.Toast) {
                    RIFT.ui.Toast.success('Als Hauptcharakter gesetzt!');
                }
            }
            // Already main - do nothing (can't "unset" main, only set another)
        }
        
        function updateMainCharButton(isMain = null) {
            const btn = document.getElementById('mainCharBtn');
            const text = document.getElementById('mainCharBtnText');
            if (!btn || !text) return;
            
            // Check if main
            if (isMain === null && window.currentCharId && typeof CharacterStorage !== 'undefined') {
                isMain = CharacterStorage.isMainCharacter(window.currentCharId);
            }
            
            if (isMain) {
                btn.classList.add('active');
                text.textContent = '★ Hauptcharakter';
            } else {
                btn.classList.remove('active');
                text.textContent = 'Hauptcharakter';
            }
        }

        // ===== EXPORT / IMPORT / RESET =====
        function exportCharacter() {
            const blob = new Blob([JSON.stringify(characterData, null, 2)], { type: 'application/json' });
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = `${characterData.name || 'charakter'}_worldsapart.json`;
            a.click();
        }
        
        function importCharacter(event) {
            const file = event.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    characterData = { ...getDefaultCharacter(), ...JSON.parse(e.target.result) };
                    saveCharacter();
                    populateFields();
                    initializeSkills();
                    updateAllCalculations();
                    showSaveIndicator();
                } catch(err) { alert('Fehler beim Import'); }
            };
            reader.readAsText(file);
            event.target.value = '';
        }
        
        function resetCharacter() {
            if (confirm('Charakter wirklich zurücksetzen?')) {
                localStorage.removeItem(STORAGE_KEY);
                characterData = getDefaultCharacter();
                populateFields();
                initializeSkills();
                updateAllCalculations();
                document.getElementById('portrait-img').style.display = 'none';
                document.getElementById('portrait-placeholder').style.display = 'block';
                document.getElementById('crew-flag-img').style.display = 'none';
                document.getElementById('crew-flag-placeholder').style.display = 'block';
                document.querySelectorAll('.dice-check-large').forEach(d => d.classList.remove('used'));
            }
        }

        // ===== GM PLAYER SWITCHER & ADVENTURE BAR =====
        
        let isViewingOther = false;
        let currentViewingPlayer = null;
        let originalCharacterData = null;
        
        // Initialize GM Player Bar and Adventure Bar
        document.addEventListener('DOMContentLoaded', function() {
            // Delay initialization to ensure Firebase and auth are ready
            setTimeout(() => {
                initGMPlayerBar();
                initAdventureBar();
            }, 1500);
            
            // Bind dice roll buttons
            const fokusRollBtn = document.getElementById('fokus-roll-btn');
            if (fokusRollBtn) {
                fokusRollBtn.addEventListener('click', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    rollFokus();
                });
            }
            
            const zweiteChanceRollBtn = document.getElementById('zweite-chance-roll-btn');
            if (zweiteChanceRollBtn) {
                zweiteChanceRollBtn.addEventListener('click', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    rollZweiteChance();
                });
            }
        });
        
        function initGMPlayerBar() {
            const gmPlayerBar = document.getElementById('gmPlayerBar');
            if (!gmPlayerBar) return;
            
            // Check for GM status
            let user = null;
            try {
                user = typeof getCurrentUser === 'function' ? getCurrentUser() : null;
                if (!user) {
                    const userData = localStorage.getItem('pnp_companion_user');
                    if (userData) user = JSON.parse(userData);
                }
            } catch(e) {
                console.log('[GM Bar] Could not get user:', e);
            }
            
            console.log('[GM Bar] User check:', user);
            
            if (!user?.isGM) {
                console.log('[GM Bar] Not a GM, hiding bar');
                return;
            }
            
            // Show GM bar
            gmPlayerBar.classList.add('visible');
            
            // Get room code (try multiple sources)
            const roomCode = localStorage.getItem('rift_current_room')?.replace(/-/g, '').toUpperCase();
            
            if (!roomCode) {
                console.log('[GM Bar] No room code');
                renderPlayerButtons([], user.username, firebase?.auth?.()?.currentUser?.uid);
                return;
            }
            
            // Check for Firestore availability
            if (typeof RIFT === 'undefined' || !RIFT.rooms) {
                console.log('[GM Bar] RIFT.rooms not ready, trying Firestore directly...');
                
                // Fallback to direct Firestore
                if (typeof firebase !== 'undefined' && firebase.firestore) {
                    const db = firebase.firestore();
                    db.collection('rooms').doc(roomCode).collection('characters')
                        .onSnapshot(snapshot => {
                            const characters = snapshot.docs.map(doc => ({
                                characterId: doc.id,
                                ...doc.data()
                            }));
                            console.log('[GM Bar] Characters from Firestore:', characters.length);
                            renderPlayerButtons(characters, user.username, firebase?.auth?.()?.currentUser?.uid);
                        }, err => {
                            console.warn('[GM Bar] Firestore error:', err);
                            renderPlayerButtons([], user.username, firebase?.auth?.()?.currentUser?.uid);
                        });
                } else {
                    renderPlayerButtons([], user.username, null);
                }
                return;
            }
            
            // Use RIFT.rooms subscription (Firestore-based, Multi-Character Support)
            RIFT.rooms.subscribeToCharacters(roomCode, (characters) => {
                console.log('[GM Bar] Characters update:', characters.length, 'characters');
                const charsWithId = characters.map(c => ({ ...c, characterId: c.id }));
                renderPlayerButtons(charsWithId, user.username, firebase?.auth?.()?.currentUser?.uid);
            });
        }
        
        function renderPlayerButtons(characters, currentUsername, currentUserId) {
            const container = document.getElementById('gmPlayerList');
            if (!container) return;
            
            container.innerHTML = '';
            
            // Add "Eigener Charakter" button first
            const ownBtn = document.createElement('button');
            ownBtn.className = 'gm-player-btn' + (!isViewingOther ? ' active' : '');
            ownBtn.innerHTML = `
                <span class="player-dot" style="background: var(--accent-primary);"></span>
                Eigener Charakter
            `;
            ownBtn.onclick = () => switchToOwnCharacter();
            container.appendChild(ownBtn);
            
            // Add other players' characters (Multi-Character Support)
            characters.forEach(char => {
                // Skip own characters
                if (char.ownerId === currentUserId) return;
                
                const charName = char.name || char.data?.name || 'Unbenannt';
                const ownerName = char.ownerName || 'Spieler';
                
                const btn = document.createElement('button');
                btn.className = 'gm-player-btn' + (currentViewingCharId === char.characterId ? ' active' : '');
                btn.innerHTML = `
                    <span class="player-dot" style="background: ${char.color || '#888'};"></span>
                    ${charName} <span style="opacity: 0.6; font-size: 11px;">(${ownerName})</span>
                `;
                btn.onclick = () => switchToCharacter(char.characterId, charName, ownerName, char);
                container.appendChild(btn);
            });
        }
        
        // Track current viewing character ID for multi-char support
        let currentViewingCharId = null;
        
        function switchToCharacter(characterId, charName, ownerName, charData) {
            if (!characterId) return;
            
            // Save original data if first switch
            if (!isViewingOther) {
                originalCharacterData = JSON.parse(JSON.stringify(characterData));
            }
            
            isViewingOther = true;
            currentViewingPlayer = ownerName;
            currentViewingCharId = characterId;
            
            // Show viewing badge
            const badge = document.getElementById('gmViewingBadge');
            const nameSpan = document.getElementById('viewingPlayerName');
            if (badge && nameSpan) {
                badge.classList.add('visible');
                nameSpan.textContent = `Ansicht: ${charName} (${ownerName})`;
            }
            
            // Show readonly overlay
            const overlay = document.getElementById('readonlyOverlay');
            if (overlay) overlay.classList.add('visible');
            
            // Make all inputs readonly
            setSheetReadonly(true);
            
            // Load character data from charData (already have it from Firestore)
            if (charData && charData.data) {
                const data = charData.data;
                // Merge into characterData format
                if (data.health || data.status?.health) {
                    characterData.health = data.health || { current: data.status.health, max: 100 };
                }
                if (data.moral || data.status?.moral) {
                    characterData.moral = data.moral || { current: data.status.moral, max: 100 };
                }
                if (data.name) characterData.name = data.name;
                if (data.role) characterData.role = data.role;
                if (data.attributes) characterData.attributes = data.attributes;
                if (data.skills) characterData.skills = data.skills;
                if (data.fokus) characterData.fokus = data.fokus;
                if (data.schwaeche) characterData.schwaeche = data.schwaeche;
                if (data.age) characterData.age = data.age;
                if (data.gender) characterData.gender = data.gender;
                if (data.crew) characterData.crew = data.crew;
                if (data.appearance) characterData.appearance = data.appearance;
                if (data.inventory) characterData.inventory = data.inventory;
                if (data.currency) characterData.currency = data.currency;
                if (data.weapon) characterData.weapon = data.weapon;
                if (data.notes) characterData.notes = data.notes;
                if (data.portrait) characterData.portrait = data.portrait;
                if (data.jollyRoger) characterData.jollyRoger = data.jollyRoger;
                if (data.secondChance) characterData.secondChance = data.secondChance;
                
                populateFields();
                initializeSkills();
                updateAllCalculations();
            }
            
            // Update button states
            updatePlayerButtonStates();
        }
        
        // Legacy function for backwards compatibility
        function switchToPlayerCharacter(username, color) {
            console.log('[GM Bar] Legacy switchToPlayerCharacter called, searching by username:', username);
            // This function searches by ownerName in the existing character list
            const container = document.getElementById('gmPlayerList');
            if (!container) return;
            
            // Find matching button and click it
            const buttons = container.querySelectorAll('.gm-player-btn');
            buttons.forEach(btn => {
                if (btn.textContent.includes(username)) {
                    btn.click();
                }
            });
        }
        
        function switchToOwnCharacter() {
            if (!isViewingOther) return;
            
            isViewingOther = false;
            currentViewingPlayer = null;
            currentViewingCharId = null;
            
            // Hide viewing badge
            const badge = document.getElementById('gmViewingBadge');
            if (badge) badge.classList.remove('visible');
            
            // Hide readonly overlay
            const overlay = document.getElementById('readonlyOverlay');
            if (overlay) overlay.classList.remove('visible');
            
            // Make inputs editable again
            setSheetReadonly(false);
            
            // Restore original data
            if (originalCharacterData) {
                characterData = originalCharacterData;
                populateFields();
                initializeSkills();
                updateAllCalculations();
                originalCharacterData = null;
            }
            
            // Update button states
            updatePlayerButtonStates();
        }
        
        function setSheetReadonly(readonly) {
            const inputs = document.querySelectorAll('input, textarea, select');
            inputs.forEach(input => {
                if (input.id === 'adventureName') return; // Adventure name stays editable
                if (readonly) {
                    input.setAttribute('readonly', true);
                    input.setAttribute('disabled', true);
                    input.style.pointerEvents = 'none';
                } else {
                    input.removeAttribute('readonly');
                    input.removeAttribute('disabled');
                    input.style.pointerEvents = '';
                }
            });
            
            // Disable buttons too
            const buttons = document.querySelectorAll('.card-action-btn, .img-control-btn, .dice-check-large');
            buttons.forEach(btn => {
                if (readonly) {
                    btn.style.pointerEvents = 'none';
                    btn.style.opacity = '0.5';
                } else {
                    btn.style.pointerEvents = '';
                    btn.style.opacity = '';
                }
            });
        }
        
        function updatePlayerButtonStates() {
            const buttons = document.querySelectorAll('.gm-player-btn');
            buttons.forEach(btn => {
                const isOwn = btn.textContent.includes('Eigener Charakter');
                const isCurrentViewing = btn.textContent.includes(currentViewingPlayer);
                
                btn.classList.remove('active');
                if ((!isViewingOther && isOwn) || (isViewingOther && isCurrentViewing)) {
                    btn.classList.add('active');
                }
            });
        }
        
        // ===== ADVENTURE BAR =====
        
        function initAdventureBar() {
            const sessionId = localStorage.getItem('pnp_session_id');
            const adventureInput = document.getElementById('adventureName');
            
            if (!sessionId || !adventureInput || typeof firebase === 'undefined') return;
            
            // Check if user is GM
            let isGM = false;
            try {
                const user = typeof getCurrentUser === 'function' ? getCurrentUser() : null;
                if (!user) {
                    const userData = localStorage.getItem('pnp_companion_user');
                    if (userData) {
                        const parsed = JSON.parse(userData);
                        isGM = parsed.isGM === true || parsed.isGM === 'true';
                    }
                } else {
                    isGM = user.isGM === true || user.isGM === 'true';
                }
            } catch(e) {
                console.log('[Adventure Bar] Could not check GM status:', e);
            }
            
            // If not GM, make input readonly
            if (!isGM) {
                adventureInput.setAttribute('readonly', true);
                adventureInput.style.cursor = 'default';
                adventureInput.style.borderBottom = 'none';
                adventureInput.title = 'Nur der GM kann den Abenteuernamen ändern';
            }
            
            const adventureRef = firebase.database().ref(`sessions/${sessionId}/adventure`);
            
            // Load current adventure name and listen for changes (for ALL users)
            adventureRef.child('name').on('value', (snapshot) => {
                const name = snapshot.val();
                if (document.activeElement !== adventureInput) {
                    adventureInput.value = name || '';
                }
            });
            
            // Only GMs can save changes
            if (isGM) {
                let saveTimeout;
                adventureInput.addEventListener('input', () => {
                    clearTimeout(saveTimeout);
                    saveTimeout = setTimeout(() => {
                        adventureRef.child('name').set(adventureInput.value);
                    }, 500);
                });
                
                // Save on blur immediately
                adventureInput.addEventListener('blur', () => {
                    clearTimeout(saveTimeout);
                    adventureRef.child('name').set(adventureInput.value);
                });
            }
        }
    </script>
    
    <!-- RIFT Layout Script -->
    <script src="assets/js/layout.js"></script>
    <script src="assets/js/character-storage.js"></script>
    
    <!-- Animation & Micro-Interaction Script -->
    <script>
    (function() {
        'use strict';
        
        // === ATTRIBUTE VALUE CHANGE ANIMATION ===
        document.querySelectorAll('[id^="attr-"]').forEach(input => {
            if (input.type === 'number') {
                let lastValue = input.value;
                input.addEventListener('change', function() {
                    if (this.value !== lastValue) {
                        this.classList.add('value-changed');
                        setTimeout(() => this.classList.remove('value-changed'), 400);
                        lastValue = this.value;
                    }
                });
            }
        });
        
        // === ZWEITE CHANCE TOGGLE ANIMATION ===
        document.querySelectorAll('[id^="dice-"]').forEach(checkbox => {
            checkbox.addEventListener('click', function() {
                this.classList.add('toggle-animation');
                setTimeout(() => this.classList.remove('toggle-animation'), 300);
            });
        });
        
        // === SKILL ROW HOVER ENHANCEMENT ===
        document.querySelectorAll('.skill-item, .skill-row').forEach(row => {
            const rollBtn = row.querySelector('.roll-btn, .dice-btn, .skill-roll-btn');
            if (rollBtn) {
                row.addEventListener('mouseenter', () => {
                    rollBtn.style.opacity = '1';
                    rollBtn.style.transform = 'scale(1)';
                });
                row.addEventListener('mouseleave', () => {
                    rollBtn.style.opacity = '0.5';
                    rollBtn.style.transform = 'scale(0.9)';
                });
            }
        });
        
        // === DICE BUTTON CLICK FEEDBACK ===
        document.querySelectorAll('.dice-btn, .roll-btn, [onclick*="roll"]').forEach(btn => {
            btn.addEventListener('click', function() {
                this.style.animation = 'none';
                this.offsetHeight; // Trigger reflow
                this.style.animation = 'diceClick 0.15s ease';
            });
        });
        
        // === LEVEL BADGE HOVER ===
        const levelBadge = document.querySelector('.level-badge');
        if (levelBadge) {
            levelBadge.addEventListener('mouseenter', function() {
                this.style.animation = 'none';
            });
            levelBadge.addEventListener('mouseleave', function() {
                this.style.animation = 'levelPulse 3s ease-in-out infinite';
            });
        }
        
        // === ENHANCED SAVE INDICATOR ===
        const originalSaveIndicator = window.showSaveIndicator;
        window.showSaveIndicator = function() {
            const indicator = document.getElementById('save-indicator');
            if (indicator) {
                indicator.classList.remove('show');
                void indicator.offsetWidth; // Trigger reflow
                indicator.classList.add('show');
                setTimeout(() => indicator.classList.remove('show'), 2000);
            }
        };
        
        // === STATUS BAR SHIMMER ON CHANGE ===
        const healthInput = document.getElementById('health-current');
        const moralInput = document.getElementById('moral-current');
        
        [healthInput, moralInput].forEach(input => {
            if (input) {
                input.addEventListener('change', function() {
                    const bar = this.id.includes('health') 
                        ? document.getElementById('health-bar')
                        : document.getElementById('moral-bar');
                    if (bar) {
                        bar.style.animation = 'none';
                        void bar.offsetWidth;
                        bar.style.animation = 'barShimmer 1s ease';
                    }
                });
            }
        });
        
        console.log('🎨 RIFT Animations loaded');
    })();
    </script>
    
            </div><!-- end main__content -->
        </main><!-- end main -->
    </div><!-- end app -->
    
    <!-- Rast Vignette Overlays (außerhalb app für fullscreen) -->
    <div class="rast-vignette lange" id="vignette-lange"></div>
    <div class="rast-vignette kurze" id="vignette-kurze"></div>
    <script src="assets/js/broadcast.js"></script>
</body>
</html>
