<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <meta name="view-transition" content="same-origin">
    <title>Einstellungen – RIFT</title>
    
    <!-- Open Graph -->
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://rift-app.com/user-settings">
    <meta property="og:title" content="Einstellungen - RIFT">
    <meta property="og:description" content="Dein digitaler Begleiter für Pen & Paper Rollenspiele.">
    <meta property="og:image" content="https://i.imgur.com/VrFzMx6.png">
    
    <!-- PWA -->
    <link rel="manifest" href="manifest.json">
    <link rel="icon" href="assets/icons/icon_rift_r.svg" type="image/svg+xml">
    <link rel="apple-touch-icon" href="assets/icons/icon-192.png">
    
    <!-- Core Styles -->
    <link rel="stylesheet" href="assets/css/core.css">
    <link rel="stylesheet" href="assets/css/ui.css">
    <link rel="stylesheet" href="assets/css/dock.css">
    <link rel="stylesheet" href="assets/css/settings.css">
    
    <!-- Cropper.js -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.6.1/cropper.min.css">
    
    <style>
        /* Global link fix */
        .us-page a {
            text-decoration: none !important;
        }
        
        /* User Settings Page Styles */
        .us-page {
            max-width: 1000px;
            margin: 0 auto;
            padding: 32px 24px;
        }
        
        .us-header {
            display: flex;
            align-items: center;
            gap: 16px;
            margin-bottom: 32px;
        }
        
        .us-header__back {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 40px;
            height: 40px;
            background: rgba(255,255,255,0.05);
            border-radius: 10px;
            color: var(--text-muted);
            text-decoration: none;
            transition: all 0.2s;
        }
        
        .us-header__back:hover {
            background: rgba(255,255,255,0.1);
            color: var(--text-primary);
        }
        
        .us-header__back svg {
            width: 20px;
            height: 20px;
        }
        
        .us-header__title {
            font-family: 'Dharma Gothic', sans-serif;
            font-size: 42px;
            font-weight: 700;
            color: var(--text-primary);
            margin: 0;
            text-transform: uppercase;
            letter-spacing: 2px;
        }
        
        /* Layout */
        .us-layout {
            display: grid;
            grid-template-columns: 220px 1fr;
            gap: 32px;
        }
        
        @media (max-width: 768px) {
            .us-layout {
                grid-template-columns: 1fr;
            }
        }
        
        /* Sidebar Nav */
        .us-nav {
            position: sticky;
            top: 24px;
            height: fit-content;
        }
        
        .us-nav__group {
            margin-bottom: 24px;
        }
        
        .us-nav__label {
            font-size: 11px;
            font-weight: 600;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 1px;
            padding: 0 12px;
            margin-bottom: 8px;
        }
        
        .us-nav__link {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px 12px;
            color: var(--text-secondary);
            text-decoration: none !important;
            font-size: 14px;
            font-weight: 500;
            border-radius: 8px;
            transition: all 0.2s;
        }
        
        .us-nav__link:hover {
            background: rgba(255,255,255,0.05);
            color: var(--text-primary);
            text-decoration: none !important;
        }
        
        .us-nav__link.active {
            background: rgba(255,70,85,0.15);
            color: var(--accent);
            text-decoration: none !important;
        }
        
        .us-nav__link svg {
            width: 18px;
            height: 18px;
            flex-shrink: 0;
        }
        
        /* Content Sections */
        .us-section {
            display: none;
        }
        
        .us-section.active {
            display: block;
            animation: fadeInSection 0.3s ease;
        }
        
        @keyframes fadeInSection {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .us-section__title {
            font-size: 24px;
            font-weight: 600;
            color: var(--text-primary);
            margin: 0 0 8px 0;
        }
        
        .us-section__desc {
            font-size: 14px;
            color: var(--text-muted);
            margin: 0 0 24px 0;
        }
        
        /* Cards */
        .us-card {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 16px;
            padding: 24px;
            margin-bottom: 20px;
        }
        
        .us-card--danger {
            border-color: rgba(239, 68, 68, 0.3);
            background: rgba(239, 68, 68, 0.05);
        }
        
        .us-card__header {
            display: flex;
            align-items: center;
            gap: 14px;
            margin-bottom: 20px;
            padding-bottom: 16px;
            border-bottom: 1px solid var(--border);
        }
        
        .us-card__icon {
            width: 44px;
            height: 44px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(255,70,85,0.1);
            border-radius: 12px;
            color: var(--accent);
        }
        
        .us-card--danger .us-card__icon {
            background: rgba(239, 68, 68, 0.15);
            color: #ef4444;
        }
        
        .us-card__icon svg {
            width: 22px;
            height: 22px;
        }
        
        .us-card__title {
            font-size: 16px;
            font-weight: 600;
            color: var(--text-primary);
            margin: 0;
        }
        
        .us-card__subtitle {
            font-size: 13px;
            color: var(--text-muted);
            margin: 2px 0 0 0;
        }
        
        /* Setting Rows */
        .us-row {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 14px 0;
            border-bottom: 1px solid rgba(255,255,255,0.05);
        }
        
        .us-row:last-child {
            border-bottom: none;
            padding-bottom: 0;
        }
        
        .us-row:first-of-type {
            padding-top: 0;
        }
        
        .us-row__info {
            flex: 1;
            min-width: 0;
        }
        
        .us-row__label {
            font-size: 14px;
            font-weight: 500;
            color: var(--text-primary);
        }
        
        .us-row__hint {
            font-size: 12px;
            color: var(--text-muted);
            margin-top: 2px;
        }
        
        .us-row__control {
            flex-shrink: 0;
            margin-left: 16px;
            min-width: 220px;
        }
        
        /* Toggle Switch */
        .us-toggle {
            position: relative;
            width: 44px;
            height: 24px;
            background: rgba(255,255,255,0.1);
            border-radius: 12px;
            cursor: pointer;
            transition: background 0.2s;
        }
        
        .us-toggle.active {
            background: var(--accent);
        }
        
        .us-toggle__knob {
            position: absolute;
            top: 2px;
            left: 2px;
            width: 20px;
            height: 20px;
            background: white;
            border-radius: 50%;
            transition: transform 0.2s;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }
        
        .us-toggle.active .us-toggle__knob {
            transform: translateX(20px);
        }
        
        /* Input */
        .us-input {
            padding: 10px 14px;
            background: rgba(255,255,255,0.05);
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 8px;
            color: var(--text-primary);
            font-size: 14px;
            transition: all 0.2s;
            width: 100%;
            max-width: 280px;
        }
        
        .us-input:focus {
            outline: none;
            border-color: var(--accent);
            background: rgba(255,255,255,0.08);
        }
        
        .us-input::placeholder {
            color: var(--text-muted);
        }
        
        /* Select */
        .us-select {
            padding: 10px 36px 10px 14px;
            background: rgba(255,255,255,0.05);
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 8px;
            color: var(--text-primary);
            font-size: 14px;
            cursor: pointer;
            appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' viewBox='0 0 24 24' fill='none' stroke='rgba(255,255,255,0.5)' stroke-width='2'%3E%3Cpolyline points='6 9 12 15 18 9'%3E%3C/polyline%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 10px center;
        }
        
        .us-select:focus {
            outline: none;
            border-color: var(--accent);
        }
        
        .us-select option {
            background: var(--bg-elevated);
        }
        
        /* Buttons */
        .us-btn {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 10px 18px;
            background: rgba(255,255,255,0.05);
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 8px;
            color: var(--text-primary);
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .us-btn:hover {
            background: rgba(255,255,255,0.1);
        }
        
        .us-btn svg {
            width: 16px;
            height: 16px;
        }
        
        .us-btn--primary {
            background: var(--accent);
            border-color: var(--accent);
            color: white;
        }
        
        .us-btn--primary:hover {
            background: #ff5a6a;
        }
        
        .us-btn--danger {
            background: rgba(239, 68, 68, 0.1);
            border-color: rgba(239, 68, 68, 0.3);
            color: #ef4444;
        }
        
        .us-btn--danger:hover {
            background: rgba(239, 68, 68, 0.2);
        }
        
        /* Profile Preview */
        .us-profile {
            display: flex;
            align-items: center;
            gap: 20px;
            padding: 20px;
            background: rgba(255,255,255,0.02);
            border-radius: 14px;
            margin-bottom: 24px;
        }
        
        .us-profile__avatar {
            position: relative;
            width: 80px;
            height: 80px;
            border-radius: 50%;
            overflow: hidden;
            cursor: pointer;
            flex-shrink: 0;
        }
        
        .us-profile__avatar-img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .us-profile__avatar-placeholder {
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 32px;
            font-weight: 600;
            color: white;
            background: var(--accent);
        }
        
        .us-profile__avatar-overlay {
            position: absolute;
            inset: 0;
            background: rgba(0,0,0,0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            transition: opacity 0.2s;
        }
        
        .us-profile__avatar:hover .us-profile__avatar-overlay {
            opacity: 1;
        }
        
        .us-profile__avatar-overlay svg {
            width: 24px;
            height: 24px;
            color: white;
        }
        
        .us-profile__info {
            flex: 1;
            min-width: 0;
        }
        
        .us-profile__name {
            font-size: 22px;
            font-weight: 600;
            color: var(--text-primary);
        }
        
        .us-profile__email {
            font-size: 14px;
            color: var(--text-muted);
            margin-top: 2px;
        }
        
        .us-profile__badge {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 4px 12px;
            background: rgba(255,70,85,0.15);
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            color: var(--accent);
            margin-top: 8px;
        }
        
        .us-profile__badge svg {
            width: 14px;
            height: 14px;
        }
        
        /* Color Picker */
        .us-colors {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }
        
        .us-color {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            cursor: pointer;
            border: 2px solid transparent;
            transition: all 0.2s;
        }
        
        .us-color:hover {
            transform: scale(1.1);
        }
        
        .us-color.active {
            border-color: white;
            box-shadow: 0 0 0 2px var(--bg), 0 0 0 4px currentColor;
        }
        
        /* Volume Slider */
        .us-slider-row {
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .us-slider {
            flex: 1;
            max-width: 200px;
            height: 6px;
            -webkit-appearance: none;
            background: rgba(255,255,255,0.1);
            border-radius: 3px;
            outline: none;
        }
        
        .us-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 16px;
            height: 16px;
            background: var(--accent);
            border-radius: 50%;
            cursor: pointer;
        }
        
        .us-slider-value {
            min-width: 40px;
            text-align: right;
            font-size: 13px;
            color: var(--text-muted);
        }
        
        /* Shortcut */
        .us-shortcut {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 10px 0;
            border-bottom: 1px solid rgba(255,255,255,0.05);
        }
        
        .us-shortcut:last-child {
            border-bottom: none;
        }
        
        .us-shortcut__label {
            font-size: 14px;
            color: var(--text-primary);
        }
        
        .us-shortcut__keys {
            display: flex;
            gap: 4px;
        }
        
        .us-key {
            padding: 4px 8px;
            background: rgba(255,255,255,0.1);
            border: 1px solid rgba(255,255,255,0.15);
            border-radius: 4px;
            font-family: monospace;
            font-size: 12px;
            color: var(--text-primary);
        }
        
        /* Stats Grid */
        .us-stats {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 12px;
            margin-bottom: 24px;
        }
        
        @media (max-width: 600px) {
            .us-stats {
                grid-template-columns: repeat(2, 1fr);
            }
        }
        
        .us-stat {
            text-align: center;
            padding: 16px;
            background: rgba(255,255,255,0.03);
            border-radius: 12px;
        }
        
        .us-stat__value {
            font-size: 28px;
            font-weight: 700;
            color: var(--text-primary);
        }
        
        .us-stat__label {
            font-size: 12px;
            color: var(--text-muted);
            margin-top: 4px;
        }
        
        /* Connected Account */
        .us-account {
            display: flex;
            align-items: center;
            gap: 14px;
            padding: 14px;
            background: rgba(255,255,255,0.03);
            border-radius: 10px;
            margin-bottom: 10px;
        }
        
        .us-account:last-child {
            margin-bottom: 0;
        }
        
        .us-account__icon {
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(255,255,255,0.05);
            border-radius: 8px;
        }
        
        .us-account__icon img, .us-account__icon svg {
            width: 24px;
            height: 24px;
        }
        
        .us-account__info {
            flex: 1;
        }
        
        .us-account__name {
            font-size: 14px;
            font-weight: 500;
            color: var(--text-primary);
        }
        
        .us-account__status {
            font-size: 12px;
            color: var(--text-muted);
        }
        
        .us-account__status--connected {
            color: #22c55e;
        }
        
        /* Toast */
        .us-toast {
            position: fixed;
            bottom: 24px;
            left: 50%;
            transform: translateX(-50%) translateY(100px);
            padding: 14px 24px;
            background: var(--bg-elevated);
            border: 1px solid var(--border);
            border-radius: 12px;
            font-size: 14px;
            font-weight: 500;
            color: var(--text-primary);
            box-shadow: 0 8px 32px rgba(0,0,0,0.3);
            opacity: 0;
            transition: all 0.3s;
            z-index: 10000;
        }
        
        .us-toast.show {
            transform: translateX(-50%) translateY(0);
            opacity: 1;
        }
        
        .us-toast--success { border-color: rgba(34, 197, 94, 0.4); }
        .us-toast--error { border-color: rgba(239, 68, 68, 0.4); }
        
        /* Mobile nav */
        @media (max-width: 768px) {
            .us-nav {
                position: relative;
                top: 0;
                display: flex;
                gap: 8px;
                overflow-x: auto;
                padding-bottom: 16px;
                margin-bottom: 16px;
                border-bottom: 1px solid var(--border);
            }
            
            .us-nav__group {
                display: flex;
                gap: 8px;
                margin-bottom: 0;
            }
            
            .us-nav__label {
                display: none;
            }
            
            .us-nav__link {
                white-space: nowrap;
                padding: 8px 14px;
            }
            
            .us-nav__link span {
                display: none;
            }
        }
    </style>

    <!-- Auth Guard: Hide until authenticated -->
    <style>
        body:not(.auth-ready) .app { opacity: 0; pointer-events: none; }
        body:not(.auth-ready) .sheet-container { opacity: 0; pointer-events: none; }
        body:not(.auth-ready) main { opacity: 0; pointer-events: none; }
        body.auth-ready .app { opacity: 1; transition: opacity 0.15s ease; }
        body.auth-ready .sheet-container { opacity: 1; transition: opacity 0.15s ease; }
        body.auth-ready main { opacity: 1; transition: opacity 0.15s ease; }
        
        /* Functional: Animations off */
        body.rift-no-animations *, body.rift-no-animations *::before, body.rift-no-animations *::after {
            animation-duration: 0.01ms !important;
            transition-duration: 0.01ms !important;
        }
        /* Functional: Compact mode */
        body.rift-compact .us-card { padding: 16px; margin-bottom: 12px; }
        body.rift-compact .us-row { padding: 8px 0; }
        body.rift-compact .us-card__header { margin-bottom: 12px; padding-bottom: 10px; }
        body.rift-compact .us-profile { padding: 14px; gap: 14px; }
        
        /* Disabled toggle */
        .us-toggle--disabled { opacity: 0.4; pointer-events: none; }
        .us-row--disabled .us-row__label { color: var(--text-muted); }
        .us-row--disabled .us-row__hint { opacity: 0.6; }
        .us-badge--soon {
            display: inline-block;
            padding: 2px 8px;
            background: rgba(255,255,255,0.08);
            border-radius: 4px;
            font-size: 10px;
            font-weight: 600;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-left: 8px;
        }
        
        /* Theme Picker */
        .us-theme-tabs {
            display: flex;
            gap: 4px;
            margin-bottom: 16px;
            background: rgba(255,255,255,0.04);
            border-radius: 8px;
            padding: 4px;
        }
        .us-theme-tab {
            flex: 1;
            padding: 8px 16px;
            background: none;
            border: none;
            border-radius: 6px;
            color: var(--text-muted);
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
        }
        .us-theme-tab:hover { color: var(--text-primary); background: rgba(255,255,255,0.04); }
        .us-theme-tab.active { color: var(--text-primary); background: rgba(255,255,255,0.1); }
        .us-theme-content { display: none; }
        .us-theme-content.active { display: block; }
        
        .us-theme-tier {
            margin-bottom: 16px;
        }
        .us-theme-tier__header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 10px;
        }
        .us-theme-tier__badge {
            padding: 3px 10px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 700;
            letter-spacing: 0.5px;
        }
        .us-theme-tier__badge--free { background: rgba(255,255,255,0.1); color: var(--text-secondary); }
        .us-theme-tier__badge--silver { background: rgba(192,192,192,0.15); color: #c0c0c0; }
        .us-theme-tier__badge--gold { background: rgba(255,191,0,0.15); color: #ffbf00; }
        .us-theme-tier__count { font-size: 12px; color: var(--text-muted); }
        
        .us-theme-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(70px, 1fr));
            gap: 8px;
        }
        .us-theme-swatch {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
            padding: 6px;
            border: 2px solid transparent;
            border-radius: 8px;
            cursor: pointer;
            background: none;
            transition: all 0.15s;
        }
        .us-theme-swatch:hover { border-color: rgba(255,255,255,0.2); background: rgba(255,255,255,0.03); }
        .us-theme-swatch.active { border-color: var(--accent); background: rgba(255,70,85,0.08); }
        .us-theme-swatch__color {
            width: 42px;
            height: 42px;
            border-radius: 50%;
            border: 2px solid rgba(255,255,255,0.1);
        }
        .us-theme-swatch__name {
            font-size: 10px;
            color: var(--text-muted);
            text-align: center;
            line-height: 1.2;
        }
        .us-theme-swatch.active .us-theme-swatch__name { color: var(--text-primary); }
        
        /* Arena theme swatches are wider */
        .us-arena-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
            gap: 8px;
        }
        .us-arena-swatch {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
            padding: 6px;
            border: 2px solid transparent;
            border-radius: 8px;
            cursor: pointer;
            background: none;
            transition: all 0.15s;
        }
        .us-arena-swatch:hover { border-color: rgba(255,255,255,0.2); }
        .us-arena-swatch.active { border-color: var(--accent); background: rgba(255,70,85,0.08); }
        .us-arena-swatch__preview {
            width: 100%;
            aspect-ratio: 16/9;
            border-radius: 6px;
            border: 1px solid rgba(255,255,255,0.1);
            background-size: cover;
            background-position: center;
        }
        .us-arena-swatch__name {
            font-size: 10px;
            color: var(--text-muted);
            text-align: center;
        }
        .us-arena-swatch.active .us-arena-swatch__name { color: var(--text-primary); }
        
        /* Security Info */
        .us-security-info { display: flex; flex-direction: column; gap: 2px; }
        .us-security-item {
            display: flex;
            align-items: flex-start;
            gap: 12px;
            padding: 12px 0;
            border-bottom: 1px solid rgba(255,255,255,0.04);
        }
        .us-security-item:last-child { border-bottom: none; }
        .us-security-icon { flex-shrink: 0; margin-top: 1px; }
        .us-security-label { font-size: 14px; color: var(--text-primary); font-weight: 500; margin-bottom: 2px; }
        .us-security-desc { font-size: 12px; color: var(--text-muted); line-height: 1.4; }
        
        /* Audio test button */
        .us-audio-test {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 6px 14px;
            background: rgba(255,255,255,0.06);
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 6px;
            color: var(--text-secondary);
            font-size: 12px;
            cursor: pointer;
            transition: all 0.2s;
        }
        .us-audio-test:hover { background: rgba(255,255,255,0.1); color: var(--text-primary); }
        
        /* Spinner */
        .us-spinner {
            width: 24px; height: 24px;
            border: 2px solid rgba(255,255,255,0.1);
            border-top-color: var(--accent);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }
        @keyframes spin { to { transform: rotate(360deg); } }
    </style>
</head>
<body>
    <!-- Unified Layout Placeholders -->
    <div id="topnav-placeholder"></div>
    <div id="meganav-placeholder"></div>
    
    <div class="app">
        <main class="main">
            <div class="main__content">
                <div class="us-page">
                    
                    <!-- Header -->
                    <div class="us-header">
                        <a href="index.html" class="us-header__back">
                            <svg viewBox="0 0 24 24" fill="currentColor">
                                <path d="M10.586 12l4.95 -4.95a1 1 0 1 0 -1.414 -1.414l-5.657 5.657a1 1 0 0 0 0 1.414l5.657 5.657a1 1 0 0 0 1.414 -1.414l-4.95 -4.95z"/>
                            </svg>
                        </a>
                        <h1 class="us-header__title">Einstellungen</h1>
                    </div>
                    
                    <div class="us-layout">
                        <!-- Sidebar Navigation -->
                        <nav class="us-nav">
                            <div class="us-nav__group">
                                <div class="us-nav__label">Konto</div>
                                <a href="#profile" class="us-nav__link active" data-section="profile">
                                    <svg viewBox="0 0 24 24" fill="currentColor"><path d="M12 2a5 5 0 1 1 -5 5l.005 -.217a5 5 0 0 1 4.995 -4.783z"/><path d="M14 14a5 5 0 0 1 5 5v1a2 2 0 0 1 -2 2h-10a2 2 0 0 1 -2 -2v-1a5 5 0 0 1 5 -5h4z"/></svg>
                                    <span>Profil</span>
                                </a>
                                <a href="#pro" class="us-nav__link" data-section="pro">
                                    <svg viewBox="0 0 24 24" fill="currentColor"><path d="M12 2L15.09 8.26L22 9.27L17 14.14L18.18 21.02L12 17.77L5.82 21.02L7 14.14L2 9.27L8.91 8.26L12 2Z"/></svg>
                                    <span>RIFT Pro</span>
                                </a>
                                <a href="#security" class="us-nav__link" data-section="security">
                                    <svg viewBox="0 0 24 24" fill="currentColor"><path d="M12 2c1.845 0 3.373 1.402 3.563 3.2l.007 .151l-.001 .652l.004 -.001c1.21 .014 2.067 .096 2.818 .403a5 5 0 0 1 2.203 2.204c.415 .86 .455 1.88 .455 3.906v2.971c0 2.026 -.04 3.046 -.455 3.906a5 5 0 0 1 -2.203 2.204c-.86 .415 -1.88 .455 -3.906 .455h-4.971c-2.026 0 -3.046 -.04 -3.906 -.455a5 5 0 0 1 -2.204 -2.203c-.415 -.86 -.455 -1.88 -.455 -3.906v-2.971c0 -2.026 .04 -3.046 .455 -3.906a5 5 0 0 1 2.204 -2.204c.75 -.307 1.608 -.389 2.818 -.403l.004 .001l-.001 -.652a3.57 3.57 0 0 1 3.407 -3.35l.156 -.001zm0 12a2 2 0 0 0 -1.995 1.85l-.005 .15a2 2 0 1 0 2 -2zm0 -10c-.815 0 -1.496 .581 -1.65 1.352l-.014 .1l-.007 .099l-.001 .652l1.675 -.003l1.672 .003l-.001 -.652a1.57 1.57 0 0 0 -1.407 -1.545l-.117 -.006z"/></svg>
                                    <span>Sicherheit</span>
                                </a>
                            </div>
                            
                            <div class="us-nav__group">
                                <div class="us-nav__label">Anpassung</div>
                                <a href="#appearance" class="us-nav__link" data-section="appearance">
                                    <svg viewBox="0 0 24 24" fill="currentColor"><path d="M12 2c5.523 0 10 4.477 10 10s-4.477 10 -10 10a10 10 0 1 1 0 -20zm0 2a8 8 0 0 0 -7.994 7.634l-.006 .201l.007 .166h1.993a6 6 0 0 1 5.83 -5.994l.17 -.006v-2zm0 14a8 8 0 0 0 7.994 -7.634l.006 -.201l-.007 -.166h-1.993a6 6 0 0 1 -5.83 5.994l-.17 .006v2z"/></svg>
                                    <span>Darstellung</span>
                                </a>
                                <a href="#notifications" class="us-nav__link" data-section="notifications">
                                    <svg viewBox="0 0 24 24" fill="currentColor"><path d="M14.235 19c.865 0 1.322 1.024 .745 1.668a3.992 3.992 0 0 1 -2.98 1.332a3.992 3.992 0 0 1 -2.98 -1.332c-.552 -.616 -.158 -1.579 .634 -1.661l.11 -.006h4.47zm-2.235 -17c4.97 0 8 3.03 8 7v3l.005 .158a2 2 0 0 0 1.3 1.77l.195 .072v2h-19v-2a2 2 0 0 0 1.275 -1.776l.025 -.224v-3c0 -3.97 3.03 -7 7 -7z"/></svg>
                                    <span>Benachrichtigungen</span>
                                </a>
                                <a href="#audio" class="us-nav__link" data-section="audio">
                                    <svg viewBox="0 0 24 24" fill="currentColor"><path d="M14 3.226v17.548c0 1.011 -1.153 1.575 -1.923 .967l-.077 -.074l-5 -5.333l-3 .001a3 3 0 0 1 -2.995 -2.824l-.005 -.176v-2.67a3 3 0 0 1 2.824 -2.995l.176 -.005l3 .001l5 -5.333c.723 -.77 1.94 -.346 2 .607l.001 .066l-.001 .22z"/><path d="M17.186 4.232a1 1 0 0 1 1.378 -.318c2.46 1.527 4.037 4.169 4.428 7.041l.008 .083v.024a10.14 10.14 0 0 1 -4.323 7.03l-.113 .074a1 1 0 1 1 -1.06 -1.696a8.14 8.14 0 0 0 3.476 -5.603l.01 -.104l-.001 -.112a8.13 8.13 0 0 0 -3.474 -5.64l-.011 -.007a1 1 0 0 1 -.318 -1.378z"/></svg>
                                    <span>Audio</span>
                                </a>
                            </div>
                            
                            <div class="us-nav__group">
                                <div class="us-nav__label">Spiel</div>
                                <a href="#game" class="us-nav__link" data-section="game">
                                    <svg viewBox="0 0 24 24" fill="currentColor"><path d="M10.425 1.414l-6.775 3.996a3.21 3.21 0 0 0 -1.65 2.807v7.285a3.226 3.226 0 0 0 1.678 2.826l6.695 4.237c1.034 .57 2.22 .57 3.2 .032l6.804 -4.302c.98 -.537 1.623 -1.618 1.623 -2.793v-7.284l-.005 -.204a3.223 3.223 0 0 0 -1.284 -2.39l-.107 -.075l-.007 -.007a1.074 1.074 0 0 0 -.181 -.133l-6.776 -3.995a3.33 3.33 0 0 0 -3.216 0z"/></svg>
                                    <span>Spieleinstellungen</span>
                                </a>
                            </div>
                            
                            <div class="us-nav__group">
                                <div class="us-nav__label">Daten</div>
                                <a href="#data" class="us-nav__link" data-section="data">
                                    <svg viewBox="0 0 24 24" fill="currentColor"><path d="M12 2c5.523 0 10 2.015 10 4.5v11c0 2.485 -4.477 4.5 -10 4.5s-10 -2.015 -10 -4.5v-11c0 -2.485 4.477 -4.5 10 -4.5zm0 13c-3.88 0 -7.273 -1.153 -8.997 -2.857l-.003 5.357c0 1.372 3.883 2.5 9 2.5s9 -1.128 9 -2.5v-5.357c-1.724 1.704 -5.117 2.857 -8.997 2.857l-.003 -.001zm0 -5c-3.88 0 -7.273 -1.153 -8.997 -2.857l-.003 5.357c0 1.372 3.883 2.5 9 2.5s9 -1.128 9 -2.5v-5.357c-1.724 1.704 -5.117 2.857 -8.997 2.857l-.003 -.001zm0 -6c-5.117 0 -9 1.128 -9 2.5s3.883 2.5 9 2.5s9 -1.128 9 -2.5s-3.883 -2.5 -9 -2.5z"/></svg>
                                    <span>Daten & Speicher</span>
                                </a>
                            </div>
                        </nav>
                        
                        <!-- Content Area -->
                        <div class="us-content">
                            
                            <!-- ========== PROFILE ========== -->
                            <section class="us-section active" id="section-profile">
                                <h2 class="us-section__title">Profil</h2>
                                <p class="us-section__desc">Verwalte dein öffentliches Profil</p>
                                
                                <!-- Profile Preview -->
                                <div class="us-profile">
                                    <div class="us-profile__avatar" onclick="document.getElementById('avatarInput').click()">
                                        <div class="us-profile__avatar-placeholder" id="avatarPlaceholder">?</div>
                                        <img class="us-profile__avatar-img" id="avatarImg" src="" alt="" style="display:none;">
                                        <div class="us-profile__avatar-overlay">
                                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z"/><circle cx="12" cy="13" r="4"/></svg>
                                        </div>
                                    </div>
                                    <div class="us-profile__info">
                                        <div class="us-profile__name" id="profileName">Lädt...</div>
                                        <div class="us-profile__email" id="profileEmail">—</div>
                                        <div class="us-profile__badge">
                                            <svg viewBox="0 0 24 24" fill="currentColor"><path d="M12 2L15.09 8.26L22 9.27L17 14.14L18.18 21.02L12 17.77L5.82 21.02L7 14.14L2 9.27L8.91 8.26L12 2Z"/></svg>
                                            Alpha Tester
                                        </div>
                                    </div>
                                    <button class="us-btn" onclick="document.getElementById('avatarInput').click()">
                                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg>
                                        Bild ändern
                                    </button>
                                    <input type="file" id="avatarInput" accept="image/*" style="display:none;" onchange="handleAvatarUpload(this)">
                                </div>
                                
                                <!-- Personal Info -->
                                <div class="us-card">
                                    <div class="us-card__header">
                                        <div class="us-card__icon">
                                            <svg viewBox="0 0 24 24" fill="currentColor"><path d="M12 2a5 5 0 1 1 -5 5l.005 -.217a5 5 0 0 1 4.995 -4.783z"/><path d="M14 14a5 5 0 0 1 5 5v1a2 2 0 0 1 -2 2h-10a2 2 0 0 1 -2 -2v-1a5 5 0 0 1 5 -5h4z"/></svg>
                                        </div>
                                        <div>
                                            <h3 class="us-card__title">Persönliche Informationen</h3>
                                            <p class="us-card__subtitle">Wie andere dich in RIFT sehen</p>
                                        </div>
                                    </div>
                                    
                                    <div class="us-row">
                                        <div class="us-row__info">
                                            <div class="us-row__label">Anzeigename</div>
                                            <div class="us-row__hint">Sichtbar für andere Spieler</div>
                                        </div>
                                        <div class="us-row__control">
                                            <input type="text" class="us-input" id="displayNameInput" placeholder="Dein Name" maxlength="24">
                                        </div>
                                    </div>
                                    
                                    <div class="us-row">
                                        <div class="us-row__info">
                                            <div class="us-row__label">Profilfarbe</div>
                                            <div class="us-row__hint">Deine Profilfarbe für den Avatar</div>
                                        </div>
                                        <div class="us-row__control">
                                            <div class="us-colors" id="profileColors">
                                                <div class="us-color" style="background:#ef4444" data-color="#ef4444"></div>
                                                <div class="us-color" style="background:#f97316" data-color="#f97316"></div>
                                                <div class="us-color" style="background:#eab308" data-color="#eab308"></div>
                                                <div class="us-color" style="background:#22c55e" data-color="#22c55e"></div>
                                                <div class="us-color" style="background:#14b8a6" data-color="#14b8a6"></div>
                                                <div class="us-color" style="background:#3b82f6" data-color="#3b82f6"></div>
                                                <div class="us-color active" style="background:#8b5cf6" data-color="#8b5cf6"></div>
                                                <div class="us-color" style="background:#ec4899" data-color="#ec4899"></div>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div class="us-row">
                                        <div class="us-row__info">
                                            <div class="us-row__label">Bio</div>
                                            <div class="us-row__hint">Kurze Beschreibung (optional)</div>
                                        </div>
                                        <div class="us-row__control">
                                            <textarea class="us-input" id="bioInput" placeholder="Erzähl etwas über dich..." rows="2" style="resize:vertical; min-width:220px;"></textarea>
                                        </div>
                                    </div>
                                    
                                    <div style="margin-top:16px; text-align:right;">
                                        <button class="us-btn us-btn--primary" onclick="saveProfile()">
                                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/><polyline points="17 21 17 13 7 13 7 21"/><polyline points="7 3 7 8 15 8"/></svg>
                                            Speichern
                                        </button>
                                    </div>
                                </div>
                                
                                <!-- Connected Accounts -->
                                <div class="us-card">
                                    <div class="us-card__header">
                                        <div class="us-card__icon">
                                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"/><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"/></svg>
                                        </div>
                                        <div>
                                            <h3 class="us-card__title">Verknüpfte Konten</h3>
                                            <p class="us-card__subtitle">Login-Methoden und Verknüpfungen</p>
                                        </div>
                                    </div>
                                    
                                    <div class="us-account">
                                        <div class="us-account__icon">
                                            <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" alt="Google">
                                        </div>
                                        <div class="us-account__info">
                                            <div class="us-account__name">Google</div>
                                            <div class="us-account__status us-account__status--connected" id="googleStatus">Verbunden</div>
                                        </div>
                                        <button class="us-btn" disabled>Verbunden</button>
                                    </div>
                                    
                                    <div class="us-account">
                                        <div class="us-account__icon">
                                            <svg viewBox="0 0 24 24" fill="#5865F2"><path d="M20.317 4.37a19.791 19.791 0 0 0-4.885-1.515.074.074 0 0 0-.079.037c-.21.375-.444.864-.608 1.25a18.27 18.27 0 0 0-5.487 0 12.64 12.64 0 0 0-.617-1.25.077.077 0 0 0-.079-.037A19.736 19.736 0 0 0 3.677 4.37a.07.07 0 0 0-.032.027C.533 9.046-.32 13.58.099 18.057a.082.082 0 0 0 .031.057 19.9 19.9 0 0 0 5.993 3.03.078.078 0 0 0 .084-.028c.462-.63.874-1.295 1.226-1.994a.076.076 0 0 0-.041-.106 13.107 13.107 0 0 1-1.872-.892.077.077 0 0 1-.008-.128 10.2 10.2 0 0 0 .372-.292.074.074 0 0 1 .077-.01c3.928 1.793 8.18 1.793 12.062 0a.074.074 0 0 1 .078.01c.12.098.246.198.373.292a.077.077 0 0 1-.006.127 12.299 12.299 0 0 1-1.873.892.077.077 0 0 0-.041.107c.36.698.772 1.362 1.225 1.993a.076.076 0 0 0 .084.028 19.839 19.839 0 0 0 6.002-3.03.077.077 0 0 0 .032-.054c.5-5.177-.838-9.674-3.549-13.66a.061.061 0 0 0-.031-.03zM8.02 15.33c-1.183 0-2.157-1.085-2.157-2.419 0-1.333.956-2.419 2.157-2.419 1.21 0 2.176 1.096 2.157 2.42 0 1.333-.956 2.418-2.157 2.418zm7.975 0c-1.183 0-2.157-1.085-2.157-2.419 0-1.333.955-2.419 2.157-2.419 1.21 0 2.176 1.096 2.157 2.42 0 1.333-.946 2.418-2.157 2.418z"/></svg>
                                        </div>
                                        <div class="us-account__info">
                                            <div class="us-account__name">Discord</div>
                                            <div class="us-account__status">Nicht verbunden</div>
                                        </div>
                                        <button class="us-btn" onclick="showToast('Discord-Integration kommt bald!')">Verbinden</button>
                                    </div>
                                </div>
                            </section>
                            
                            <!-- ========== RIFT PRO ========== -->
                            <section class="us-section" id="section-pro">
                                <h2 class="us-section__title">RIFT Pro</h2>
                                <p class="us-section__desc">Schalte alle Premium-Features frei</p>
                                
                                <div class="us-card" style="border: 1px solid rgba(255,191,0,0.2); background: linear-gradient(135deg, rgba(255,191,0,0.03) 0%, rgba(62,180,137,0.03) 100%);">
                                    <div style="text-align:center; padding: 32px 16px;">
                                        <div style="font-size:48px; margin-bottom:16px;">⭐</div>
                                        <h3 style="font-size:22px; font-weight:700; color:var(--text-primary); margin:0 0 8px 0;">RIFT Pro</h3>
                                        <p style="font-size:14px; color:var(--text-muted); margin:0 0 24px 0; max-width:360px; margin-left:auto; margin-right:auto; line-height:1.5;">
                                            Premium Würfel-Themes, Arena-Hintergründe, erweiterte GM-Tools und mehr. Dein aktueller Status:
                                        </p>
                                        <div style="display:inline-block; padding:8px 20px; background:rgba(255,255,255,0.06); border:1px solid rgba(255,255,255,0.1); border-radius:8px; margin-bottom:24px;">
                                            <span style="font-size:13px; color:var(--text-muted);" id="proStatusLabel">Free</span>
                                        </div>
                                        <div>
                                            <span class="us-badge--soon" style="font-size:12px; padding:6px 16px;">Kommt bald</span>
                                        </div>
                                    </div>
                                </div>
                            </section>
                            
                            <!-- ========== SECURITY ========== -->
                            <section class="us-section" id="section-security">
                                <h2 class="us-section__title">Sicherheit</h2>
                                <p class="us-section__desc">Kontosicherheit und Anmeldung</p>
                                
                                <div class="us-card">
                                    <div class="us-card__header">
                                        <div class="us-card__icon">
                                            <svg viewBox="0 0 24 24" fill="currentColor"><path d="M11.884 2.007l.114 -.007l.118 .007l.059 .008l.061 .013l.111 .034a.993 .993 0 0 1 .217 .112l.104 .082l.255 .218a11 11 0 0 0 7.189 2.537l.342 -.01a1 1 0 0 1 1.005 .717a13 13 0 0 1 -9.208 16.25a1 1 0 0 1 -.502 0a13 13 0 0 1 -9.209 -16.25a1 1 0 0 1 1.005 -.717a11 11 0 0 0 7.531 -2.527l.263 -.225l.096 -.075a.993 .993 0 0 1 .217 -.112l.112 -.034a.97 .97 0 0 1 .119 -.021z"/></svg>
                                        </div>
                                        <div>
                                            <h3 class="us-card__title">Konto-Informationen</h3>
                                            <p class="us-card__subtitle">Details zu deinem Konto</p>
                                        </div>
                                    </div>
                                    
                                    <div class="us-row">
                                        <div class="us-row__info">
                                            <div class="us-row__label">E-Mail Adresse</div>
                                            <div class="us-row__hint" id="securityEmail">—</div>
                                        </div>
                                        <div class="us-row__control">
                                            <span id="emailVerifiedBadge" style="font-size: 13px;">—</span>
                                        </div>
                                    </div>
                                    
                                    <div class="us-row">
                                        <div class="us-row__info">
                                            <div class="us-row__label">Benutzer-ID</div>
                                            <div class="us-row__hint" id="securityUid" style="font-family: monospace; font-size: 11px;">—</div>
                                        </div>
                                        <div class="us-row__control">
                                            <button class="us-btn" onclick="copyUserId()">Kopieren</button>
                                        </div>
                                    </div>
                                    
                                    <div class="us-row">
                                        <div class="us-row__info">
                                            <div class="us-row__label">Login-Methode</div>
                                            <div class="us-row__hint" id="securityProvider">—</div>
                                        </div>
                                    </div>
                                    
                                    <div class="us-row">
                                        <div class="us-row__info">
                                            <div class="us-row__label">Konto erstellt</div>
                                            <div class="us-row__hint" id="securityCreated">—</div>
                                        </div>
                                    </div>
                                    
                                    <div class="us-row">
                                        <div class="us-row__info">
                                            <div class="us-row__label">Letzte Anmeldung</div>
                                            <div class="us-row__hint" id="securityLastLogin">—</div>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="us-card">
                                    <div class="us-card__header">
                                        <div class="us-card__icon">
                                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="11" width="18" height="11" rx="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/></svg>
                                        </div>
                                        <div>
                                            <h3 class="us-card__title">Passwort & Login</h3>
                                            <p class="us-card__subtitle">Zugang verwalten</p>
                                        </div>
                                    </div>
                                    
                                    <div class="us-row" id="passwordChangeRow">
                                        <div class="us-row__info">
                                            <div class="us-row__label">Passwort ändern</div>
                                            <div class="us-row__hint" id="passwordChangeHint">E-Mail zum Zurücksetzen senden</div>
                                        </div>
                                        <div class="us-row__control">
                                            <button class="us-btn" id="passwordChangeBtn" onclick="sendPasswordReset()">Zurücksetzen</button>
                                        </div>
                                    </div>
                                    
                                    <div class="us-row us-row--disabled">
                                        <div class="us-row__info">
                                            <div class="us-row__label">Zwei-Faktor-Authentifizierung <span class="us-badge--soon">Bald</span></div>
                                            <div class="us-row__hint">Zusätzlicher Schutz per Authenticator-App</div>
                                        </div>
                                        <div class="us-row__control">
                                            <button class="us-btn" disabled>Einrichten</button>
                                        </div>
                                    </div>
                                    
                                    <div class="us-row us-row--disabled">
                                        <div class="us-row__info">
                                            <div class="us-row__label">Aktive Sessions <span class="us-badge--soon">Bald</span></div>
                                            <div class="us-row__hint">Geräte, auf denen du angemeldet bist</div>
                                        </div>
                                        <div class="us-row__control">
                                            <button class="us-btn" disabled>Verwalten</button>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="us-card">
                                    <div class="us-card__header">
                                        <div class="us-card__icon">
                                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/></svg>
                                        </div>
                                        <div>
                                            <h3 class="us-card__title">Datensicherheit</h3>
                                            <p class="us-card__subtitle">So schützt RIFT deine Daten</p>
                                        </div>
                                    </div>
                                    
                                    <div class="us-security-info">
                                        <div class="us-security-item">
                                            <div class="us-security-icon" style="color:#22c55e;">
                                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="20" height="20"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></svg>
                                            </div>
                                            <div>
                                                <div class="us-security-label">SSL/TLS-Verschlüsselung</div>
                                                <div class="us-security-desc">Alle Daten werden verschlüsselt übertragen (HTTPS)</div>
                                            </div>
                                        </div>
                                        <div class="us-security-item">
                                            <div class="us-security-icon" style="color:#22c55e;">
                                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="20" height="20"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></svg>
                                            </div>
                                            <div>
                                                <div class="us-security-label">Firebase Authentication</div>
                                                <div class="us-security-desc">Branchenstandard von Google für sichere Anmeldung</div>
                                            </div>
                                        </div>
                                        <div class="us-security-item">
                                            <div class="us-security-icon" style="color:#22c55e;">
                                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="20" height="20"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></svg>
                                            </div>
                                            <div>
                                                <div class="us-security-label">Firestore Security Rules</div>
                                                <div class="us-security-desc">Datenzugriff nur für autorisierte Nutzer im jeweiligen Raum</div>
                                            </div>
                                        </div>
                                        <div class="us-security-item">
                                            <div class="us-security-icon" style="color:#22c55e;">
                                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="20" height="20"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></svg>
                                            </div>
                                            <div>
                                                <div class="us-security-label">Keine Tracking-Cookies</div>
                                                <div class="us-security-desc">RIFT nutzt keine Werbe-Tracker oder Analytics von Drittanbietern</div>
                                            </div>
                                        </div>
                                        <div class="us-security-item">
                                            <div class="us-security-icon" style="color:#22c55e;">
                                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="20" height="20"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></svg>
                                            </div>
                                            <div>
                                                <div class="us-security-label">EU-Hosting</div>
                                                <div class="us-security-desc">Daten werden DSGVO-konform in Europa gespeichert</div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </section>
                            
                            <!-- ========== APPEARANCE ========== -->
                            <section class="us-section" id="section-appearance">
                                <h2 class="us-section__title">Darstellung</h2>
                                <p class="us-section__desc">Passe das Aussehen von RIFT an</p>
                                
                                <div class="us-card">
                                    <div class="us-card__header">
                                        <div class="us-card__icon">
                                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="5"/><path d="M12 1v2M12 21v2M4.22 4.22l1.42 1.42M18.36 18.36l1.42 1.42M1 12h2M21 12h2M4.22 19.78l1.42-1.42M18.36 5.64l1.42-1.42"/></svg>
                                        </div>
                                        <div>
                                            <h3 class="us-card__title">Theme</h3>
                                            <p class="us-card__subtitle">Farbschema der Oberfläche</p>
                                        </div>
                                    </div>
                                    
                                    <div class="us-row">
                                        <div class="us-row__info">
                                            <div class="us-row__label">Design</div>
                                            <div class="us-row__hint">Hell oder Dunkel</div>
                                        </div>
                                        <div class="us-row__control">
                                            <select class="us-select" id="themeSelect">
                                                <option value="dark">Dunkel</option>
                                                <option value="light" disabled>Hell (Bald verfügbar)</option>
                                                <option value="system" disabled>System (Bald)</option>
                                            </select>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="us-card">
                                    <div class="us-card__header">
                                        <div class="us-card__icon">
                                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><line x1="2" y1="12" x2="22" y2="12"/><path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"/></svg>
                                        </div>
                                        <div>
                                            <h3 class="us-card__title">Sprache & Format</h3>
                                            <p class="us-card__subtitle">Lokalisierung</p>
                                        </div>
                                    </div>
                                    
                                    <div class="us-row">
                                        <div class="us-row__info">
                                            <div class="us-row__label">Sprache</div>
                                        </div>
                                        <div class="us-row__control">
                                            <select class="us-select" id="languageSelect">
                                                <option value="de">Deutsch</option>
                                                <option value="en">English</option>
                                            </select>
                                        </div>
                                    </div>
                                    
                                    <div class="us-row">
                                        <div class="us-row__info">
                                            <div class="us-row__label">Datumsformat</div>
                                        </div>
                                        <div class="us-row__control">
                                            <select class="us-select" id="dateFormatSelect">
                                                <option value="DD.MM.YYYY">25.01.2026</option>
                                                <option value="MM/DD/YYYY">01/25/2026</option>
                                                <option value="YYYY-MM-DD">2026-01-25</option>
                                            </select>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="us-card">
                                    <div class="us-card__header">
                                        <div class="us-card__icon">
                                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="22 12 18 12 15 21 9 3 6 12 2 12"/></svg>
                                        </div>
                                        <div>
                                            <h3 class="us-card__title">Animationen</h3>
                                            <p class="us-card__subtitle">Bewegungen und Effekte</p>
                                        </div>
                                    </div>
                                    
                                    <div class="us-row">
                                        <div class="us-row__info">
                                            <div class="us-row__label">Animationen aktivieren</div>
                                            <div class="us-row__hint">Übergänge und visuelle Effekte</div>
                                        </div>
                                        <div class="us-row__control">
                                            <div class="us-toggle active" id="animationsToggle" onclick="toggleSwitch(this)">
                                                <div class="us-toggle__knob"></div>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div class="us-row">
                                        <div class="us-row__info">
                                            <div class="us-row__label">Kompakter Modus</div>
                                            <div class="us-row__hint">Weniger Abstände, mehr Inhalt</div>
                                        </div>
                                        <div class="us-row__control">
                                            <div class="us-toggle" id="compactToggle" onclick="toggleSwitch(this)">
                                                <div class="us-toggle__knob"></div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </section>
                            
                            <!-- ========== NOTIFICATIONS ========== -->
                            <section class="us-section" id="section-notifications">
                                <h2 class="us-section__title">Benachrichtigungen</h2>
                                <p class="us-section__desc">Wann und wie du informiert wirst</p>
                                
                                <div class="us-card">
                                    <div class="us-card__header">
                                        <div class="us-card__icon">
                                            <svg viewBox="0 0 24 24" fill="currentColor"><path d="M14.235 19c.865 0 1.322 1.024 .745 1.668a3.992 3.992 0 0 1 -2.98 1.332a3.992 3.992 0 0 1 -2.98 -1.332c-.552 -.616 -.158 -1.579 .634 -1.661l.11 -.006h4.47zm-2.235 -17c4.97 0 8 3.03 8 7v3l.005 .158a2 2 0 0 0 1.3 1.77l.195 .072v2h-19v-2a2 2 0 0 0 1.275 -1.776l.025 -.224v-3c0 -3.97 3.03 -7 7 -7z"/></svg>
                                        </div>
                                        <div>
                                            <h3 class="us-card__title">Push-Benachrichtigungen <span class="us-badge--soon">Bald</span></h3>
                                            <p class="us-card__subtitle">Benachrichtigungen auf deinem Gerät</p>
                                        </div>
                                    </div>
                                    
                                    <div class="us-row us-row--disabled">
                                        <div class="us-row__info">
                                            <div class="us-row__label">Session-Erinnerungen</div>
                                            <div class="us-row__hint">Vor geplanten Sessions erinnern</div>
                                        </div>
                                        <div class="us-row__control">
                                            <div class="us-toggle us-toggle--disabled">
                                                <div class="us-toggle__knob"></div>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div class="us-row us-row--disabled">
                                        <div class="us-row__info">
                                            <div class="us-row__label">Erinnerungszeit</div>
                                        </div>
                                        <div class="us-row__control">
                                            <select class="us-select" disabled>
                                                <option>1 Std. vorher</option>
                                            </select>
                                        </div>
                                    </div>
                                    
                                    <div class="us-row us-row--disabled">
                                        <div class="us-row__info">
                                            <div class="us-row__label">Chat-Nachrichten</div>
                                            <div class="us-row__hint">Neue Nachrichten im Gruppen-Chat</div>
                                        </div>
                                        <div class="us-row__control">
                                            <div class="us-toggle us-toggle--disabled">
                                                <div class="us-toggle__knob"></div>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div class="us-row us-row--disabled">
                                        <div class="us-row__info">
                                            <div class="us-row__label">GM-Broadcasts</div>
                                            <div class="us-row__hint">Wichtige Nachrichten vom Spielleiter</div>
                                        </div>
                                        <div class="us-row__control">
                                            <div class="us-toggle us-toggle--disabled">
                                                <div class="us-toggle__knob"></div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="us-card">
                                    <div class="us-card__header">
                                        <div class="us-card__icon">
                                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="2" y="3" width="20" height="14" rx="2"/><line x1="8" y1="21" x2="16" y2="21"/><line x1="12" y1="17" x2="12" y2="21"/></svg>
                                        </div>
                                        <div>
                                            <h3 class="us-card__title">In-App</h3>
                                            <p class="us-card__subtitle">Toasts und Pop-ups</p>
                                        </div>
                                    </div>
                                    
                                    <div class="us-row">
                                        <div class="us-row__info">
                                            <div class="us-row__label">Toast-Benachrichtigungen</div>
                                            <div class="us-row__hint">Kleine Pop-up Nachrichten</div>
                                        </div>
                                        <div class="us-row__control">
                                            <div class="us-toggle active" id="toastToggle" onclick="toggleSwitch(this)">
                                                <div class="us-toggle__knob"></div>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div class="us-row">
                                        <div class="us-row__info">
                                            <div class="us-row__label">Spieler-Aktivitäten</div>
                                            <div class="us-row__hint">Beitritt/Verlassen anzeigen</div>
                                        </div>
                                        <div class="us-row__control">
                                            <div class="us-toggle active" id="playerActivityToggle" onclick="toggleSwitch(this)">
                                                <div class="us-toggle__knob"></div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </section>
                            
                            <!-- ========== AUDIO ========== -->
                            <section class="us-section" id="section-audio">
                                <h2 class="us-section__title">Audio</h2>
                                <p class="us-section__desc">Lautstärke und Sound-Einstellungen</p>
                                
                                <div class="us-card">
                                    <div class="us-card__header">
                                        <div class="us-card__icon">
                                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"/><path d="M19.07 4.93a10 10 0 0 1 0 14.14"/></svg>
                                        </div>
                                        <div>
                                            <h3 class="us-card__title">Lautstärke</h3>
                                            <p class="us-card__subtitle">Individuelle Lautstärkeregler</p>
                                        </div>
                                    </div>
                                    
                                    <div class="us-row">
                                        <div class="us-row__info">
                                            <div class="us-row__label">Master-Lautstärke</div>
                                        </div>
                                        <div class="us-row__control">
                                            <div class="us-slider-row">
                                                <input type="range" class="us-slider" id="masterVolume" min="0" max="100" value="80">
                                                <span class="us-slider-value" id="masterVolumeValue">80%</span>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div class="us-row">
                                        <div class="us-row__info">
                                            <div class="us-row__label">Würfel-Sounds</div>
                                        </div>
                                        <div class="us-row__control">
                                            <div class="us-slider-row">
                                                <input type="range" class="us-slider" id="diceVolume" min="0" max="100" value="100">
                                                <span class="us-slider-value" id="diceVolumeValue">100%</span>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div class="us-row">
                                        <div class="us-row__info">
                                            <div class="us-row__label">Benachrichtigungen</div>
                                        </div>
                                        <div class="us-row__control">
                                            <div class="us-slider-row">
                                                <input type="range" class="us-slider" id="notificationVolume" min="0" max="100" value="70">
                                                <span class="us-slider-value" id="notificationVolumeValue">70%</span>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div class="us-row">
                                        <div class="us-row__info">
                                            <div class="us-row__label">Alle Sounds stummschalten</div>
                                        </div>
                                        <div class="us-row__control">
                                            <div class="us-toggle" id="muteAllToggle" onclick="toggleSwitch(this)">
                                                <div class="us-toggle__knob"></div>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div style="padding: 12px 0 4px; text-align:right;">
                                        <button class="us-audio-test" onclick="playTestSound()">
                                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="14" height="14"><polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"/><path d="M19.07 4.93a10 10 0 0 1 0 14.14M15.54 8.46a5 5 0 0 1 0 7.07"/></svg>
                                            Test-Sound abspielen
                                        </button>
                                    </div>
                                </div>
                            </section>
                            
                            <!-- ========== GAME ========== -->
                            <section class="us-section" id="section-game">
                                <h2 class="us-section__title">Spieleinstellungen</h2>
                                <p class="us-section__desc">Würfel, Charaktere und mehr</p>
                                
                                <div class="us-card">
                                    <div class="us-card__header">
                                        <div class="us-card__icon">
                                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"/></svg>
                                        </div>
                                        <div>
                                            <h3 class="us-card__title">Würfel</h3>
                                            <p class="us-card__subtitle">Theme und Hintergrund anpassen</p>
                                        </div>
                                    </div>
                                    
                                    <!-- Theme Picker Tabs -->
                                    <div class="us-theme-tabs">
                                        <button class="us-theme-tab active" data-tab="diceThemes">Würfel-Farben</button>
                                        <button class="us-theme-tab" data-tab="arenaThemes">Arena-Hintergrund</button>
                                    </div>
                                    
                                    <!-- Dice Themes Content -->
                                    <div class="us-theme-content active" id="diceThemesContent">
                                        <div id="diceThemeGrid"></div>
                                    </div>
                                    
                                    <!-- Arena Themes Content -->
                                    <div class="us-theme-content" id="arenaThemesContent">
                                        <div id="arenaThemeGrid" style="text-align:center; padding:20px; color:var(--text-muted);">
                                            <div class="us-spinner" style="margin:0 auto 12px;"></div>
                                            Lade Arena-Themes...
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="us-card">
                                    <div class="us-card__header">
                                        <div class="us-card__icon">
                                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/></svg>
                                        </div>
                                        <div>
                                            <h3 class="us-card__title">Charakterbogen</h3>
                                            <p class="us-card__subtitle">Standard-Einstellungen</p>
                                        </div>
                                    </div>
                                    
                                    <div class="us-row">
                                        <div class="us-row__info">
                                            <div class="us-row__label">Bevorzugtes Regelwerk</div>
                                        </div>
                                        <div class="us-row__control">
                                            <select class="us-select" id="defaultRulebookSelect">
                                                <option value="dnd5e">D&D 5e (2024)</option>
                                                <option value="worldsapart">Worlds Apart</option>
                                                <option value="htbah">How To Be A Hero</option>
                                                <option value="cyberpunkred">Cyberpunk Red</option>
                                            </select>
                                        </div>
                                    </div>
                                    
                                    <div class="us-row">
                                        <div class="us-row__info">
                                            <div class="us-row__label">Auto-Save</div>
                                            <div class="us-row__hint">Änderungen automatisch speichern</div>
                                        </div>
                                        <div class="us-row__control">
                                            <div class="us-toggle active" id="autoSaveToggle" onclick="toggleSwitch(this)">
                                                <div class="us-toggle__knob"></div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </section>
                            
                            <!-- ========== DATA ========== -->
                            <section class="us-section" id="section-data">
                                <h2 class="us-section__title">Daten & Speicher</h2>
                                <p class="us-section__desc">Verwalte deine Daten</p>
                                
                                <!-- Stats -->
                                <div class="us-stats">
                                    <div class="us-stat">
                                        <div class="us-stat__value" id="statCharacters">0</div>
                                        <div class="us-stat__label">Charaktere</div>
                                    </div>
                                    <div class="us-stat">
                                        <div class="us-stat__value" id="statSessions">0</div>
                                        <div class="us-stat__label">Sessions</div>
                                    </div>
                                    <div class="us-stat">
                                        <div class="us-stat__value" id="statDiceRolls">0</div>
                                        <div class="us-stat__label">Würfe</div>
                                    </div>
                                    <div class="us-stat">
                                        <div class="us-stat__value" id="statPlaytime">0h</div>
                                        <div class="us-stat__label">Spielzeit</div>
                                    </div>
                                </div>
                                
                                <div class="us-card">
                                    <div class="us-card__header">
                                        <div class="us-card__icon">
                                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>
                                        </div>
                                        <div>
                                            <h3 class="us-card__title">Export & Import</h3>
                                            <p class="us-card__subtitle">Daten sichern und wiederherstellen</p>
                                        </div>
                                    </div>
                                    
                                    <div class="us-row">
                                        <div class="us-row__info">
                                            <div class="us-row__label">Charaktere exportieren</div>
                                            <div class="us-row__hint">Als JSON-Datei herunterladen</div>
                                        </div>
                                        <div class="us-row__control">
                                            <button class="us-btn" onclick="exportCharacters()">
                                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>
                                                Export
                                            </button>
                                        </div>
                                    </div>
                                    
                                    <div class="us-row">
                                        <div class="us-row__info">
                                            <div class="us-row__label">Alle Daten exportieren</div>
                                            <div class="us-row__hint">Kompletter Backup</div>
                                        </div>
                                        <div class="us-row__control">
                                            <button class="us-btn" onclick="exportAllData()">
                                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>
                                                Export
                                            </button>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="us-card">
                                    <div class="us-card__header">
                                        <div class="us-card__icon">
                                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="16 16 12 12 8 16"/><line x1="12" y1="12" x2="12" y2="21"/><path d="M20.39 18.39A5 5 0 0 0 18 9h-1.26A8 8 0 1 0 3 16.3"/></svg>
                                        </div>
                                        <div>
                                            <h3 class="us-card__title">Speicher</h3>
                                            <p class="us-card__subtitle">Lokaler Browser-Speicher</p>
                                        </div>
                                    </div>
                                    
                                    <div class="us-row">
                                        <div class="us-row__info">
                                            <div class="us-row__label">Speicherverbrauch</div>
                                            <div class="us-row__hint" id="storageUsage">Berechne...</div>
                                        </div>
                                        <div class="us-row__control">
                                            <button class="us-btn" onclick="clearCache()">Cache leeren</button>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Danger Zone -->
                                <div class="us-card us-card--danger">
                                    <div class="us-card__header">
                                        <div class="us-card__icon">
                                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"/><line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg>
                                        </div>
                                        <div>
                                            <h3 class="us-card__title">Gefahrenzone</h3>
                                            <p class="us-card__subtitle">Irreversible Aktionen</p>
                                        </div>
                                    </div>
                                    
                                    <div class="us-row">
                                        <div class="us-row__info">
                                            <div class="us-row__label">Alle lokalen Daten löschen</div>
                                            <div class="us-row__hint">Entfernt alle Daten aus diesem Browser</div>
                                        </div>
                                        <div class="us-row__control">
                                            <button class="us-btn us-btn--danger" onclick="deleteAllData()">Löschen</button>
                                        </div>
                                    </div>
                                    
                                    <div class="us-row">
                                        <div class="us-row__info">
                                            <div class="us-row__label">Konto löschen</div>
                                            <div class="us-row__hint">RIFT-Konto permanent löschen</div>
                                        </div>
                                        <div class="us-row__control">
                                            <button class="us-btn us-btn--danger" onclick="deleteAccount()">Konto löschen</button>
                                        </div>
                                    </div>
                                </div>
                            </section>
                            
                        </div>
                    </div>
                </div>
                
                <!-- Footer Placeholder -->
                <div id="footer-placeholder"></div>
                
            </div>
        </main>
    </div>
    
    <!-- Dock Placeholder -->
    <div id="dock-placeholder"></div>
    
    <!-- Toast -->
    <div class="us-toast" id="toast"></div>
    
    <!-- Scripts -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.6.1/cropper.min.js"></script>
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    
    <!-- RIFT Services -->
    <script src="assets/js/firebase-config.js"></script>
    <script>
        // Auth Guard - wait for Firebase properly then set auth-ready
        (async function boot() {
            if (window.RIFT?.firebase?.init) {
                try { await window.RIFT.firebase.init(); } catch(e) {}
            }
            await new Promise((resolve) => {
                const start = Date.now();
                const check = () => {
                    try {
                        if (typeof firebase !== 'undefined' && firebase.apps && firebase.apps.length > 0) { resolve(); return; }
                    } catch(e) {}
                    if (Date.now() - start > 10000) { resolve(); return; }
                    setTimeout(check, 100);
                };
                check();
            });
            const user = await new Promise((resolve) => {
                try {
                    const unsub = firebase.auth().onAuthStateChanged(function(u) { unsub(); resolve(u); });
                } catch(e) { resolve(null); }
                setTimeout(() => resolve(null), 5000);
            });
            if (user) {
                document.body.classList.add('auth-ready');
            } else {
                window.location.href = '/login';
            }
        })();
    </script>

    <script src="assets/js/room-service.js"></script>
    <script src="assets/js/user-service.js"></script>
    <script src="assets/js/character-storage.js"></script>
    
    <script src="assets/js/auth.js"></script>
    <script src="assets/js/ui.js"></script>
    <script src="assets/js/layout.js"></script>
    <script src="assets/js/layout-unified.js"></script>
    <script src="assets/js/settings.js"></script>
    <script src="assets/js/transitions.js"></script>
    <script src="assets/js/app.js"></script>
    
    <script>
        // Initialize unified layout
        initUnifiedLayout();

        // ══════════════════════════════════════════════════════
        //  RIFT USER SETTINGS — Fully Functional
        //  Saves to localStorage + Firestore users/{uid}
        //  Exposes window.RIFT_USER_SETTINGS for other modules
        // ══════════════════════════════════════════════════════

        const DEFAULTS = {
            // Appearance
            language: 'de',
            dateFormat: 'DD.MM.YYYY',
            animations: true,
            compact: false,
            // In-App Notifications
            toastNotifications: true,
            playerActivity: true,
            // Audio
            masterVolume: 80,
            diceVolume: 100,
            notificationVolume: 70,
            muteAll: false,
            // Game
            defaultRulebook: 'dnd5e',
            autoSave: true
        };

        let _authUser = null;
        let currentSettings = { ...DEFAULTS };
        let saveTimer = null;

        // ========== GLOBAL SETTINGS API ==========
        // Readable by any module on any page via localStorage
        window.RIFT_USER_SETTINGS = {
            get(key) { 
                try {
                    const s = JSON.parse(localStorage.getItem('rift_settings') || '{}');
                    return s[key] ?? DEFAULTS[key];
                } catch(e) { return DEFAULTS[key]; }
            },
            getAll() {
                try {
                    return { ...DEFAULTS, ...JSON.parse(localStorage.getItem('rift_settings') || '{}') };
                } catch(e) { return { ...DEFAULTS }; }
            },
            getAudio() {
                const s = this.getAll();
                return {
                    master: s.muteAll ? 0 : s.masterVolume / 100,
                    dice: s.muteAll ? 0 : (s.masterVolume / 100) * (s.diceVolume / 100),
                    notification: s.muteAll ? 0 : (s.masterVolume / 100) * (s.notificationVolume / 100),
                    muted: s.muteAll
                };
            }
        };

        // ========== SETTINGS PERSISTENCE ==========
        function loadSettingsFromStorage() {
            try {
                const local = JSON.parse(localStorage.getItem('rift_settings') || '{}');
                currentSettings = { ...DEFAULTS, ...local };
            } catch(e) {
                currentSettings = { ...DEFAULTS };
            }
        }

        async function loadSettingsFromFirestore() {
            if (!_authUser) return;
            try {
                const db = firebase.firestore();
                const doc = await db.collection('users').doc(_authUser.uid).get();
                if (doc.exists && doc.data().settings) {
                    currentSettings = { ...DEFAULTS, ...doc.data().settings };
                    // Sync to localStorage
                    localStorage.setItem('rift_settings', JSON.stringify(currentSettings));
                }
            } catch(e) {
                console.warn('[UserSettings] Firestore load failed, using local:', e.message);
            }
        }

        function saveSettings() {
            // Debounce saves
            clearTimeout(saveTimer);
            saveTimer = setTimeout(() => {
                // Always save to localStorage immediately
                localStorage.setItem('rift_settings', JSON.stringify(currentSettings));
                // Sync to Firestore
                saveSettingsToFirestore();
            }, 300);
        }

        async function saveSettingsToFirestore() {
            if (!_authUser) return;
            try {
                const db = firebase.firestore();
                await db.collection('users').doc(_authUser.uid).set({
                    settings: currentSettings,
                    lastSeen: firebase.firestore.FieldValue.serverTimestamp()
                }, { merge: true });
                console.log('[UserSettings] Saved to Firestore');
            } catch(e) {
                console.warn('[UserSettings] Firestore save failed:', e.message);
            }
        }

        // ========== APPLY SETTINGS TO DOM ==========
        function applySettingsToDOM() {
            // Body classes for animations & compact
            document.body.classList.toggle('rift-no-animations', !currentSettings.animations);
            document.body.classList.toggle('rift-compact', currentSettings.compact);

            // Toggles
            setToggleState('animationsToggle', currentSettings.animations);
            setToggleState('compactToggle', currentSettings.compact);
            setToggleState('toastToggle', currentSettings.toastNotifications);
            setToggleState('playerActivityToggle', currentSettings.playerActivity);
            setToggleState('muteAllToggle', currentSettings.muteAll);
            setToggleState('autoSaveToggle', currentSettings.autoSave);

            // Selects
            setSelectValue('languageSelect', currentSettings.language);
            setSelectValue('dateFormatSelect', currentSettings.dateFormat);
            setSelectValue('defaultRulebookSelect', currentSettings.defaultRulebook);

            // Sliders
            setSliderValue('masterVolume', currentSettings.masterVolume);
            setSliderValue('diceVolume', currentSettings.diceVolume);
            setSliderValue('notificationVolume', currentSettings.notificationVolume);
        }

        // ========== HELPERS ==========
        function setToggleState(id, active) {
            const el = document.getElementById(id);
            if (el) el.classList.toggle('active', active);
        }
        function setSelectValue(id, value) {
            const el = document.getElementById(id);
            if (el) el.value = value;
        }
        function setSliderValue(id, value) {
            const el = document.getElementById(id);
            if (el) {
                el.value = value;
                const valEl = document.getElementById(id + 'Value');
                if (valEl) valEl.textContent = value + '%';
            }
        }

        // ========== TOGGLE HANDLER ==========
        function toggleSwitch(el) {
            el.classList.toggle('active');
            const id = el.id;
            const active = el.classList.contains('active');

            // Map toggle IDs to settings keys
            const map = {
                'animationsToggle': 'animations',
                'compactToggle': 'compact',
                'toastToggle': 'toastNotifications',
                'playerActivityToggle': 'playerActivity',
                'muteAllToggle': 'muteAll',
                'autoSaveToggle': 'autoSave'
            };

            const key = map[id];
            if (key) {
                currentSettings[key] = active;
                saveSettings();

                // Immediate effects
                if (key === 'animations') {
                    document.body.classList.toggle('rift-no-animations', !active);
                }
                if (key === 'compact') {
                    document.body.classList.toggle('rift-compact', active);
                }
                if (key === 'muteAll') {
                    // Update slider visuals
                    document.querySelectorAll('.us-slider').forEach(s => {
                        s.style.opacity = active ? '0.4' : '1';
                    });
                }
            }
        }

        // ========== NAVIGATION ==========
        document.querySelectorAll('.us-nav__link').forEach(link => {
            link.addEventListener('click', (e) => {
                e.preventDefault();
                const section = link.dataset.section;
                document.querySelectorAll('.us-nav__link').forEach(l => l.classList.remove('active'));
                link.classList.add('active');
                document.querySelectorAll('.us-section').forEach(s => s.classList.remove('active'));
                document.getElementById('section-' + section).classList.add('active');
                history.replaceState(null, '', '#' + section);
            });
        });
        if (window.location.hash) {
            const section = window.location.hash.slice(1);
            const link = document.querySelector(`[data-section="${section}"]`);
            if (link) link.click();
        }

        // ========== COLOR PICKERS ==========
        document.querySelectorAll('.us-colors').forEach(picker => {
            picker.querySelectorAll('.us-color').forEach(color => {
                color.addEventListener('click', () => {
                    picker.querySelectorAll('.us-color').forEach(c => c.classList.remove('active'));
                    color.classList.add('active');

                    if (picker.id === 'profileColors') {
                        document.getElementById('avatarPlaceholder').style.backgroundColor = color.dataset.color;
                    }
                });
            });
        });

        // ========== THEME TABS ==========
        document.querySelectorAll('.us-theme-tab').forEach(tab => {
            tab.addEventListener('click', () => {
                document.querySelectorAll('.us-theme-tab').forEach(t => t.classList.remove('active'));
                document.querySelectorAll('.us-theme-content').forEach(c => c.classList.remove('active'));
                tab.classList.add('active');
                const content = document.getElementById(tab.dataset.tab + 'Content');
                if (content) content.classList.add('active');
            });
        });

        // ========== SELECT HANDLERS ==========
        ['languageSelect', 'dateFormatSelect', 'defaultRulebookSelect'].forEach(id => {
            const el = document.getElementById(id);
            if (!el) return;
            el.addEventListener('change', () => {
                const map = {
                    'languageSelect': 'language',
                    'dateFormatSelect': 'dateFormat',
                    'defaultRulebookSelect': 'defaultRulebook'
                };
                const key = map[id];
                if (key) {
                    currentSettings[key] = el.value;
                    saveSettings();
                    if (key === 'language') {
                        showToast('Sprachänderung wird beim nächsten Laden wirksam', 'success');
                    }
                }
            });
        });

        // ========== VOLUME SLIDERS ==========
        document.querySelectorAll('.us-slider').forEach(slider => {
            slider.addEventListener('input', () => {
                const valEl = document.getElementById(slider.id + 'Value');
                if (valEl) valEl.textContent = slider.value + '%';

                const map = {
                    'masterVolume': 'masterVolume',
                    'diceVolume': 'diceVolume',
                    'notificationVolume': 'notificationVolume'
                };
                const key = map[slider.id];
                if (key) {
                    currentSettings[key] = parseInt(slider.value);
                    saveSettings();
                }
            });
        });

        // ========== LOAD PROFILE ==========
        async function loadProfile() {
            if (!_authUser) return;

            // Get data from multiple sources
            const localData = JSON.parse(localStorage.getItem('rift_user') || '{}');
            let firestoreData = {};

            try {
                const db = firebase.firestore();
                const doc = await db.collection('users').doc(_authUser.uid).get();
                if (doc.exists) firestoreData = doc.data();
            } catch(e) {
                console.warn('[UserSettings] Firestore profile load failed:', e.message);
            }

            // Merge: Firestore > localStorage > auth fallback
            const name = firestoreData.displayName || localData.displayName || localData.name || _authUser.displayName || 'Unbekannt';
            const email = firestoreData.email || localData.email || _authUser.email || '—';
            const color = firestoreData.color || localData.color || '#8b5cf6';
            const bio = firestoreData.bio || localData.bio || '';
            const avatar = firestoreData.avatar || firestoreData.photoURL || localData.avatar || _authUser.photoURL || null;

            // Populate UI
            document.getElementById('profileName').textContent = name;
            document.getElementById('displayNameInput').value = name;
            document.getElementById('profileEmail').textContent = email;
            document.getElementById('bioInput').value = bio;

            // Avatar
            const placeholder = document.getElementById('avatarPlaceholder');
            const img = document.getElementById('avatarImg');
            placeholder.textContent = name.charAt(0).toUpperCase();
            placeholder.style.backgroundColor = color;

            if (avatar) {
                img.src = avatar;
                img.style.display = 'block';
                placeholder.style.display = 'none';
            }

            // Profile color picker
            const colorEl = document.querySelector(`#profileColors [data-color="${color}"]`);
            if (colorEl) {
                document.querySelectorAll('#profileColors .us-color').forEach(c => c.classList.remove('active'));
                colorEl.classList.add('active');
            }

            // Google connection status
            const providers = _authUser.providerData.map(p => p.providerId);
            if (providers.includes('google.com')) {
                document.getElementById('googleStatus').textContent = _authUser.email;
                document.getElementById('googleStatus').classList.add('us-account__status--connected');
            }
        }

        // ========== SAVE PROFILE ==========
        async function saveProfile() {
            const name = document.getElementById('displayNameInput').value.trim();
            const colorEl = document.querySelector('#profileColors .us-color.active');
            const color = colorEl ? colorEl.dataset.color : '#8b5cf6';
            const bio = document.getElementById('bioInput')?.value || '';

            if (!name) {
                showToast('Bitte gib einen Namen ein', 'error');
                return;
            }

            // Save to localStorage
            const userData = JSON.parse(localStorage.getItem('rift_user') || '{}');
            userData.displayName = name;
            userData.name = name;
            userData.color = color;
            userData.bio = bio;
            localStorage.setItem('rift_user', JSON.stringify(userData));

            // Update UI
            document.getElementById('profileName').textContent = name;
            document.getElementById('avatarPlaceholder').textContent = name.charAt(0).toUpperCase();
            document.getElementById('avatarPlaceholder').style.backgroundColor = color;

            // Save to Firestore user profile
            if (_authUser) {
                try {
                    const db = firebase.firestore();
                    await db.collection('users').doc(_authUser.uid).set({
                        displayName: name,
                        name: name,
                        color: color,
                        bio: bio,
                        lastSeen: firebase.firestore.FieldValue.serverTimestamp()
                    }, { merge: true });
                    console.log('[UserSettings] Profile saved to Firestore');
                } catch(e) {
                    console.warn('[UserSettings] Firestore profile save failed:', e.message);
                }

                // Also update room member if in a room
                const roomCode = localStorage.getItem('rift_current_room');
                if (roomCode && window.RIFT?.rooms) {
                    try {
                        const db = firebase.firestore();
                        await db.collection('rooms').doc(roomCode.toUpperCase().replace(/[^A-Z0-9]/g, ''))
                            .collection('members').doc(_authUser.uid)
                            .update({ displayName: name, color: color });
                    } catch(e) {
                        console.warn('[UserSettings] Room member update failed:', e.message);
                    }
                }
            }

            showToast('Profil gespeichert!', 'success');
        }

        // ========== LOAD SECURITY ==========
        function loadSecurity() {
            if (!_authUser) return;
            document.getElementById('securityEmail').textContent = _authUser.email || '—';
            document.getElementById('securityUid').textContent = _authUser.uid;

            if (_authUser.metadata) {
                if (_authUser.metadata.creationTime) {
                    document.getElementById('securityCreated').textContent = new Date(_authUser.metadata.creationTime).toLocaleDateString('de-DE', { day: '2-digit', month: '2-digit', year: 'numeric' });
                }
                if (_authUser.metadata.lastSignInTime) {
                    document.getElementById('securityLastLogin').textContent = new Date(_authUser.metadata.lastSignInTime).toLocaleString('de-DE', { day: '2-digit', month: '2-digit', year: 'numeric', hour: '2-digit', minute: '2-digit' });
                }
            }

            // Email verification
            const verifiedEl = document.getElementById('emailVerifiedBadge');
            const providers = _authUser.providerData.map(p => p.providerId);
            if (_authUser.emailVerified || providers.includes('google.com')) {
                verifiedEl.innerHTML = '<span style="color:#22c55e;">✓ Verifiziert</span>';
            } else {
                verifiedEl.innerHTML = '<span style="color:#eab308;">⚠ Nicht verifiziert</span>';
            }
            
            // Login provider
            const providerEl = document.getElementById('securityProvider');
            if (providers.includes('google.com')) {
                providerEl.innerHTML = '<span style="display:inline-flex;align-items:center;gap:6px;"><svg width="14" height="14" viewBox="0 0 24 24"><path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92a5.06 5.06 0 0 1-2.2 3.32v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.1z"/><path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/><path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/><path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/></svg> Google</span>';
                // Google-only: Password managed by Google
                const pwHint = document.getElementById('passwordChangeHint');
                const pwBtn = document.getElementById('passwordChangeBtn');
                pwHint.textContent = 'Wird über dein Google-Konto verwaltet';
                pwBtn.textContent = 'Google-Konto';
                pwBtn.onclick = () => window.open('https://myaccount.google.com/security', '_blank');
            } else if (providers.includes('password')) {
                providerEl.textContent = 'E-Mail & Passwort';
            } else {
                providerEl.textContent = providers.join(', ') || '—';
            }
        }

        async function sendPasswordReset() {
            if (!_authUser || !_authUser.email) return;
            const providers = _authUser.providerData.map(p => p.providerId);
            if (providers.includes('google.com') && !providers.includes('password')) {
                window.open('https://myaccount.google.com/security', '_blank');
                return;
            }
            try {
                await firebase.auth().sendPasswordResetEmail(_authUser.email);
                showToast('Reset-E-Mail gesendet an ' + _authUser.email, 'success');
            } catch(e) {
                console.error('[Security] Password reset error:', e);
                showToast('Fehler: ' + e.message, 'error');
            }
        }

        function playTestSound() {
            try {
                const s = JSON.parse(localStorage.getItem('rift_settings') || '{}');
                if (s.muteAll === true) {
                    showToast('Alle Sounds sind stummgeschaltet', 'warning');
                    return;
                }
                const master = (s.masterVolume != null ? s.masterVolume : 80) / 100;
                const dice = (s.diceVolume != null ? s.diceVolume : 100) / 100;
                const vol = Math.min(master * dice, 1);
                if (vol <= 0) {
                    showToast('Lautstärke ist auf 0', 'warning');
                    return;
                }
                const audio = new Audio('assets/libs/dice/assets/nc93322.mp3');
                audio.volume = vol;
                audio.play().catch(() => showToast('Audio konnte nicht abgespielt werden', 'error'));
            } catch(e) {
                showToast('Audio-Fehler', 'error');
            }
        }

        function copyUserId() {
            const uid = document.getElementById('securityUid').textContent;
            navigator.clipboard.writeText(uid).then(() => {
                showToast('User-ID kopiert!', 'success');
            }).catch(() => {
                // Fallback
                const ta = document.createElement('textarea');
                ta.value = uid;
                document.body.appendChild(ta);
                ta.select();
                document.execCommand('copy');
                document.body.removeChild(ta);
                showToast('User-ID kopiert!', 'success');
            });
        }

        // ========== DICE THEME PICKER ==========
        const DICE_THEMES = {
            free: {
                label: 'RIFT Free', badge: 'free', themes: [
                    { id:'black', bg:'#1a1a1a', name:'Schwarz' },
                    { id:'white', bg:'#f5f5f5', name:'Weiß' },
                    { id:'red', bg:'#cc0000', name:'Rot' },
                    { id:'blue', bg:'#0000d4', name:'Blau' },
                    { id:'green', bg:'#00d400', name:'Grün' },
                    { id:'yellow', bg:'#e6e600', name:'Gelb' },
                    { id:'orange', bg:'#e07800', name:'Orange' },
                    { id:'purple', bg:'#660066', name:'Lila' },
                    { id:'pink', bg:'#e8aeb8', name:'Pink' },
                    { id:'silver', bg:'#a8a8a8', name:'Silber' }
                ]
            },
            silver: {
                label: 'RIFT Silver', badge: 'silver', themes: [
                    { id:'onyx', bg:'#1f1f1f', name:'Onyx' },
                    { id:'charcoal', bg:'#2d2d2d', name:'Kohle' },
                    { id:'graphite', bg:'#363636', name:'Graphit' },
                    { id:'slate', bg:'#455a64', name:'Schiefer' },
                    { id:'pearl', bg:'#d4d4d4', name:'Perle' },
                    { id:'crimson', bg:'#b21030', name:'Karmesin' },
                    { id:'scarlet', bg:'#d41f00', name:'Scharlach' },
                    { id:'cherry', bg:'#b8264f', name:'Kirsche' },
                    { id:'coral', bg:'#e56b3e', name:'Koralle' },
                    { id:'gold', bg:'#d4b000', name:'Gold' },
                    { id:'amber', bg:'#d4a000', name:'Bernstein' },
                    { id:'honey', bg:'#c88005', name:'Honig' },
                    { id:'forest', bg:'#1a6b1a', name:'Wald' },
                    { id:'emerald', bg:'#40a060', name:'Smaragd' },
                    { id:'lime', bg:'#28a828', name:'Limette' },
                    { id:'mint', bg:'#7de87d', name:'Minze' },
                    { id:'teal', bg:'#006666', name:'Petrol' },
                    { id:'cyan', bg:'#00d4d4', name:'Cyan' },
                    { id:'turquoise', bg:'#35b8aa', name:'Türkis' },
                    { id:'navy', bg:'#000066', name:'Marine' },
                    { id:'royal', bg:'#3555c0', name:'Königsblau' },
                    { id:'sky', bg:'#6eb8d8', name:'Himmel' },
                    { id:'indigo', bg:'#3c0068', name:'Indigo' },
                    { id:'violet', bg:'#7400d4', name:'Violett' },
                    { id:'amethyst', bg:'#7d54ab', name:'Amethyst' },
                    { id:'lavender', bg:'#9668ba', name:'Lavendel' },
                    { id:'magenta', bg:'#d400d4', name:'Magenta' },
                    { id:'hotPink', bg:'#e05a9c', name:'Hot Pink' },
                    { id:'brown', bg:'#724010', name:'Braun' },
                    { id:'chocolate', bg:'#653400', name:'Schokolade' }
                ]
            },
            gold: {
                label: 'RIFT Gold', badge: 'gold', themes: [
                    { id:'ruby', bg:'radial-gradient(circle at 30% 30%, #ff1a5c, #b80e4d 50%, #8a0a3a)', name:'Rubin' },
                    { id:'sapphire', bg:'radial-gradient(circle at 30% 30%, #1a5cff, #0047ab 50%, #002d6e)', name:'Saphir' },
                    { id:'rose', bg:'linear-gradient(135deg, #e8b4b8, #b76e79, #e8b4b8)', name:'Roségold' },
                    { id:'platinum', bg:'linear-gradient(135deg, #e8e8e8, #a0a0a0, #e8e8e8)', name:'Platin' },
                    { id:'chrome', bg:'linear-gradient(135deg, #f0f0f0, #888, #f0f0f0, #666)', name:'Chrom' },
                    { id:'copper', bg:'linear-gradient(135deg, #da8a67, #96602a, #da8a67)', name:'Kupfer' },
                    { id:'bronze', bg:'linear-gradient(135deg, #d4a574, #a86828, #d4a574)', name:'Bronze' },
                    { id:'gunmetal', bg:'linear-gradient(135deg, #4a5568, #232a2e, #4a5568)', name:'Anthrazit' },
                    { id:'bloodmoon', bg:'radial-gradient(circle at 40% 40%, #8b0000, #4a0000 60%, #1a0000)', name:'Blutmond' },
                    { id:'nebula', bg:'linear-gradient(135deg, #00ff87, #60efff, #b967ff)', name:'Nordlicht' },
                    { id:'void', bg:'linear-gradient(135deg, #f0f0f0, #e8e8e8, #f5f5f5, #ddd, #f0f0f0)', name:'Weißmarmor' },
                    { id:'marbleBlack', bg:'linear-gradient(135deg, #1a1a1a, #333, #1a1a1a, #444, #1a1a1a)', name:'Schwarzmarmor' },
                    { id:'marbleGreen', bg:'linear-gradient(135deg, #1a3a1a, #2d4a2d, #1a3a1a, #4a8a4a, #1a3a1a)', name:'Grünmarmor' },
                    { id:'woodOak', bg:'repeating-linear-gradient(90deg, #8d6e63, #8d6e63 3px, #6d5045 3px, #6d5045 6px)', name:'Eiche' },
                    { id:'woodEbony', bg:'repeating-linear-gradient(90deg, #1a1510, #1a1510 3px, #0d0a08 3px, #0d0a08 6px)', name:'Ebenholz' },
                    { id:'stoneGranite', bg:'linear-gradient(135deg, #757575, #616161, #757575, #616161, #757575)', name:'Granit' },
                    { id:'ice', bg:'linear-gradient(135deg, #e0f7fa, #80deea, #e0f7fa)', name:'Eis' },
                    { id:'lava', bg:'linear-gradient(135deg, #ff6b00, #cc0000, #ff6b00)', name:'Lava' }
                ]
            }
        };

        function renderDiceThemes() {
            const grid = document.getElementById('diceThemeGrid');
            if (!grid) return;
            const current = localStorage.getItem('rift_dice_theme') || 'onyx';
            let html = '';
            
            ['free', 'silver', 'gold'].forEach(tierKey => {
                const tier = DICE_THEMES[tierKey];
                html += `<div class="us-theme-tier">
                    <div class="us-theme-tier__header">
                        <span class="us-theme-tier__badge us-theme-tier__badge--${tier.badge}">${tier.label}</span>
                        <span class="us-theme-tier__count">${tier.themes.length} Farben</span>
                    </div>
                    <div class="us-theme-grid">`;
                
                tier.themes.forEach(t => {
                    const active = t.id === current ? ' active' : '';
                    html += `<button class="us-theme-swatch${active}" data-dice-theme="${t.id}" onclick="selectDiceTheme('${t.id}')">
                        <div class="us-theme-swatch__color" style="background:${t.bg};"></div>
                        <span class="us-theme-swatch__name">${t.name}</span>
                    </button>`;
                });
                
                html += `</div></div>`;
            });
            
            grid.innerHTML = html;
        }

        function selectDiceTheme(themeId) {
            localStorage.setItem('rift_dice_theme', themeId);
            document.querySelectorAll('.us-theme-swatch').forEach(s => s.classList.remove('active'));
            const el = document.querySelector(`[data-dice-theme="${themeId}"]`);
            if (el) el.classList.add('active');
            showToast('Würfel-Theme gespeichert!', 'success');
        }

        async function loadArenaThemes() {
            const grid = document.getElementById('arenaThemeGrid');
            if (!grid) return;
            
            try {
                const db = firebase.firestore();
                const snapshot = await db.collection('arenaThemes').orderBy('order', 'asc').get();
                
                if (snapshot.empty) {
                    grid.innerHTML = '<div style="text-align:center;padding:20px;color:var(--text-muted);">Keine Arena-Themes verfügbar</div>';
                    return;
                }
                
                const themes = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                const current = localStorage.getItem('rift_dice_arena_theme') || 'rift';
                
                // Group by tier
                const tiers = { free: [], silver: [], gold: [] };
                themes.forEach(t => {
                    const tier = t.tier || 'free';
                    if (tiers[tier]) tiers[tier].push(t);
                });
                
                let html = '';
                const tierLabels = { free: 'RIFT Free', silver: 'RIFT Silver', gold: 'RIFT Gold' };
                
                ['free', 'silver', 'gold'].forEach(tierKey => {
                    if (tiers[tierKey].length === 0) return;
                    html += `<div class="us-theme-tier">
                        <div class="us-theme-tier__header">
                            <span class="us-theme-tier__badge us-theme-tier__badge--${tierKey}">${tierLabels[tierKey]}</span>
                            <span class="us-theme-tier__count">${tiers[tierKey].length} Themes</span>
                        </div>
                        <div class="us-arena-grid">`;
                    
                    tiers[tierKey].forEach(t => {
                        const active = t.themeId === current ? ' active' : '';
                        const bgStyle = t.imageUrl 
                            ? `background-image:url('${t.imageUrl}');` 
                            : `background:${t.backgroundColor || '#1a1a1a'};`;
                        html += `<button class="us-arena-swatch${active}" data-arena-theme="${t.themeId}" onclick="selectArenaTheme('${t.themeId}')">
                            <div class="us-arena-swatch__preview" style="${bgStyle}"></div>
                            <span class="us-arena-swatch__name">${t.name || t.themeId}</span>
                        </button>`;
                    });
                    
                    html += `</div></div>`;
                });
                
                grid.innerHTML = html;
            } catch(e) {
                console.warn('[UserSettings] Arena themes load failed:', e.message);
                grid.innerHTML = '<div style="text-align:center;padding:20px;color:var(--text-muted);">Arena-Themes konnten nicht geladen werden</div>';
            }
        }

        function selectArenaTheme(themeId) {
            localStorage.setItem('rift_dice_arena_theme', themeId);
            document.querySelectorAll('.us-arena-swatch').forEach(s => s.classList.remove('active'));
            const el = document.querySelector(`[data-arena-theme="${themeId}"]`);
            if (el) el.classList.add('active');
            showToast('Arena-Theme gespeichert!', 'success');
        }

        // ========== AVATAR ==========
        function handleAvatarUpload(input) {
            const file = input.files[0];
            if (!file) return;

            if (file.size > 2 * 1024 * 1024) {
                showToast('Bild zu groß (max 2MB)', 'error');
                return;
            }

            const reader = new FileReader();
            reader.onload = async (e) => {
                // Resize to 128x128 thumbnail to avoid localStorage quota
                const img = new Image();
                img.onload = async () => {
                    const canvas = document.createElement('canvas');
                    const size = 128;
                    canvas.width = size;
                    canvas.height = size;
                    const ctx = canvas.getContext('2d');
                    // Center crop
                    const min = Math.min(img.width, img.height);
                    const sx = (img.width - min) / 2;
                    const sy = (img.height - min) / 2;
                    ctx.drawImage(img, sx, sy, min, min, 0, 0, size, size);
                    const thumbnail = canvas.toDataURL('image/jpeg', 0.7);

                    // Update UI
                    const avatarImg = document.getElementById('avatarImg');
                    const placeholder = document.getElementById('avatarPlaceholder');
                    avatarImg.src = thumbnail;
                    avatarImg.style.display = 'block';
                    placeholder.style.display = 'none';

                    // Save small thumbnail to localStorage (safe for quota)
                    try {
                        const userData = JSON.parse(localStorage.getItem('rift_user') || '{}');
                        userData.avatar = thumbnail;
                        localStorage.setItem('rift_user', JSON.stringify(userData));
                    } catch(e) {
                        console.warn('[UserSettings] localStorage avatar save failed:', e.message);
                    }

                    // Save to Firestore
                    if (_authUser) {
                        try {
                            const db = firebase.firestore();
                            await db.collection('users').doc(_authUser.uid).set({
                                avatar: thumbnail,
                                photoURL: thumbnail,
                                lastSeen: firebase.firestore.FieldValue.serverTimestamp()
                            }, { merge: true });
                        } catch(e) {
                            console.warn('[UserSettings] Avatar Firestore save failed:', e.message);
                        }
                    }

                    showToast('Profilbild aktualisiert!', 'success');
                };
                img.src = e.target.result;
            };
            reader.readAsDataURL(file);
        }

        // ========== STATS ==========
        async function loadStats() {
            // Characters: check localStorage + Firestore room characters
            const localChars = JSON.parse(localStorage.getItem('rift_characters') || '{}');
            let charCount = Object.keys(localChars).length;

            // Try getting Firestore character count from current room
            if (_authUser) {
                try {
                    const roomCode = localStorage.getItem('rift_current_room');
                    if (roomCode) {
                        const db = firebase.firestore();
                        const normalized = roomCode.toUpperCase().replace(/[^A-Z0-9]/g, '');
                        const charSnap = await db.collection('rooms').doc(normalized)
                            .collection('characters')
                            .where('createdBy', '==', _authUser.uid)
                            .get();
                        if (!charSnap.empty) charCount = Math.max(charCount, charSnap.size);
                    }
                } catch(e) { /* ignore */ }
            }

            document.getElementById('statCharacters').textContent = charCount || '—';

            // Sessions from Firestore
            let sessionCount = 0;
            if (_authUser) {
                try {
                    const roomCode = localStorage.getItem('rift_current_room');
                    if (roomCode) {
                        const db = firebase.firestore();
                        const normalized = roomCode.toUpperCase().replace(/[^A-Z0-9]/g, '');
                        const sessSnap = await db.collection('rooms').doc(normalized)
                            .collection('sessions').get();
                        sessionCount = sessSnap.size;
                    }
                } catch(e) { /* ignore */ }
            }
            document.getElementById('statSessions').textContent = sessionCount || '—';

            // Dice stats from localStorage
            const diceStats = JSON.parse(localStorage.getItem('rift_dice_stats') || '{}');
            document.getElementById('statDiceRolls').textContent = diceStats.totalRolls || '—';

            // Playtime
            const playtime = parseInt(localStorage.getItem('rift_playtime') || '0');
            document.getElementById('statPlaytime').textContent = playtime > 0 ? Math.floor(playtime / 60) + 'h' : '—';
        }

        // ========== STORAGE ==========
        function calculateStorage() {
            let total = 0;
            for (let key in localStorage) {
                if (localStorage.hasOwnProperty(key)) {
                    total += (localStorage[key].length || 0) * 2;
                }
            }
            const kb = (total / 1024).toFixed(1);
            const mb = (total / 1024 / 1024).toFixed(2);
            document.getElementById('storageUsage').textContent = total > 1048576 ? `${mb} MB verwendet` : `${kb} KB verwendet`;
        }

        // ========== EXPORT ==========
        async function exportCharacters() {
            let data = {};
            
            // From localStorage
            const local = JSON.parse(localStorage.getItem('rift_characters') || '{}');
            data = { ...local };

            // From Firestore (current room)
            if (_authUser) {
                try {
                    const roomCode = localStorage.getItem('rift_current_room');
                    if (roomCode) {
                        const db = firebase.firestore();
                        const normalized = roomCode.toUpperCase().replace(/[^A-Z0-9]/g, '');
                        const snap = await db.collection('rooms').doc(normalized)
                            .collection('characters')
                            .where('createdBy', '==', _authUser.uid)
                            .get();
                        snap.forEach(doc => {
                            data[doc.id] = doc.data();
                        });
                    }
                } catch(e) {
                    console.warn('[Export] Firestore character fetch failed:', e.message);
                }
            }

            if (Object.keys(data).length === 0) {
                showToast('Keine Charaktere zum Exportieren', 'error');
                return;
            }

            download(JSON.stringify(data, null, 2), `rift_characters_${new Date().toISOString().split('T')[0]}.json`);
            showToast(`${Object.keys(data).length} Charakter(e) exportiert!`, 'success');
        }

        async function exportAllData() {
            const data = {
                exportedAt: new Date().toISOString(),
                exportVersion: '2.0',
                user: JSON.parse(localStorage.getItem('rift_user') || '{}'),
                settings: currentSettings,
                characters: JSON.parse(localStorage.getItem('rift_characters') || '{}')
            };

            // Add Firestore profile
            if (_authUser) {
                try {
                    const db = firebase.firestore();
                    const doc = await db.collection('users').doc(_authUser.uid).get();
                    if (doc.exists) {
                        data.firestoreProfile = doc.data();
                    }
                } catch(e) { /* ignore */ }
            }

            download(JSON.stringify(data, null, 2), `rift_backup_${new Date().toISOString().split('T')[0]}.json`);
            showToast('Backup exportiert!', 'success');
        }

        function download(data, filename) {
            const blob = new Blob([data], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            a.click();
            URL.revokeObjectURL(url);
        }

        // ========== DANGER ZONE ==========
        function clearCache() {
            const keep = ['rift_user', 'rift_characters', 'rift_current_room', 'rift_settings', 'rift_dice_stats'];
            const keysToRemove = [];
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                if (!keep.includes(key) && key.startsWith('rift_')) {
                    keysToRemove.push(key);
                }
            }
            keysToRemove.forEach(k => localStorage.removeItem(k));
            calculateStorage();
            showToast(`${keysToRemove.length} Cache-Einträge geleert!`, 'success');
        }

        function deleteAllData() {
            // Custom confirm dialog instead of browser confirm()
            showConfirmDialog(
                'Alle lokalen Daten löschen',
                'Dies entfernt alle RIFT-Daten aus diesem Browser. Dein Konto und Firestore-Daten bleiben erhalten. Fortfahren?',
                () => {
                    const keysToRemove = [];
                    for (let i = 0; i < localStorage.length; i++) {
                        const key = localStorage.key(i);
                        if (key && key.startsWith('rift_')) keysToRemove.push(key);
                    }
                    keysToRemove.forEach(k => localStorage.removeItem(k));
                    showToast('Lokale Daten gelöscht', 'success');
                    setTimeout(() => window.location.href = 'index.html', 1500);
                }
            );
        }

        function deleteAccount() {
            showConfirmDialog(
                'Konto löschen',
                'Die Kontolöschung ist endgültig und kann nicht rückgängig gemacht werden. Kontaktiere contact@rift-app.com um dein Konto zu löschen.',
                null, // no action, just info
                'Verstanden'
            );
        }

        // Custom confirm dialog
        function showConfirmDialog(title, message, onConfirm, confirmText = 'Löschen') {
            const existing = document.getElementById('usConfirmDialog');
            if (existing) existing.remove();

            const overlay = document.createElement('div');
            overlay.id = 'usConfirmDialog';
            overlay.style.cssText = 'position:fixed;inset:0;background:rgba(0,0,0,0.6);display:flex;align-items:center;justify-content:center;z-index:10001;animation:fadeInSection 0.2s ease;';

            const dialog = document.createElement('div');
            dialog.style.cssText = 'background:#1a1a1a;border:1px solid rgba(255,255,255,0.1);border-radius:16px;padding:28px;max-width:400px;width:90%;';
            dialog.innerHTML = `
                <h3 style="font-size:18px;font-weight:600;color:var(--text-primary);margin:0 0 12px 0;">${title}</h3>
                <p style="font-size:14px;color:var(--text-muted);margin:0 0 24px 0;line-height:1.5;">${message}</p>
                <div style="display:flex;gap:10px;justify-content:flex-end;">
                    <button class="us-btn" id="usConfirmCancel">Abbrechen</button>
                    ${onConfirm ? `<button class="us-btn us-btn--danger" id="usConfirmOk">${confirmText}</button>` : `<button class="us-btn us-btn--primary" id="usConfirmOk">${confirmText}</button>`}
                </div>
            `;

            overlay.appendChild(dialog);
            document.body.appendChild(overlay);

            overlay.addEventListener('click', (e) => { if (e.target === overlay) overlay.remove(); });
            document.getElementById('usConfirmCancel').addEventListener('click', () => overlay.remove());
            document.getElementById('usConfirmOk').addEventListener('click', () => {
                overlay.remove();
                if (onConfirm) onConfirm();
            });
        }

        // ========== TOAST ==========
        function showToast(message, type = 'info') {
            const toast = document.getElementById('toast');
            if (!toast) return;

            // Respect toast setting (but always show errors)
            if (type !== 'error' && !currentSettings.toastNotifications) return;

            toast.textContent = message;
            toast.className = 'us-toast';
            if (type === 'success') toast.classList.add('us-toast--success');
            if (type === 'error') toast.classList.add('us-toast--error');
            toast.classList.add('show');
            setTimeout(() => toast.classList.remove('show'), 3000);
        }

        // ========== INIT ==========
        (async function init() {
            // Load settings from localStorage first (instant)
            loadSettingsFromStorage();
            applySettingsToDOM();

            // Wait for auth to be ready
            const waitForUser = () => new Promise(resolve => {
                const check = () => {
                    try {
                        const u = firebase.auth().currentUser;
                        if (u) { resolve(u); return; }
                    } catch(e) {}
                    if (document.body.classList.contains('auth-ready')) {
                        try { resolve(firebase.auth().currentUser); return; } catch(e) {}
                    }
                    setTimeout(check, 100);
                };
                check();
                setTimeout(() => resolve(null), 8000);
            });

            _authUser = await waitForUser();
            if (!_authUser) return;

            // Load from Firestore (may override localStorage)
            await loadSettingsFromFirestore();
            applySettingsToDOM();

            // Load all sections
            loadProfile();
            loadSecurity();
            loadStats();
            renderDiceThemes();
            loadArenaThemes();
            calculateStorage();

            console.log('[UserSettings] Initialized for', _authUser.email);
        })();
    </script>
</body>
</html>
