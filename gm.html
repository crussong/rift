<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <meta name="view-transition" content="same-origin">
    <title>RIFT – GM Optionen</title>
    
    <link rel="stylesheet" href="assets/css/core.css">
    <link rel="stylesheet" href="assets/css/ui.css">
    <link rel="stylesheet" href="assets/css/sidebar.css">
    <link rel="stylesheet" href="assets/css/topbar.css">
    <link rel="stylesheet" href="assets/css/footer.css">
    <link rel="stylesheet" href="assets/css/settings.css">
    <link rel="stylesheet" href="assets/css/gm.css">
</head>
<body>
    <div class="app">
        <main class="main">
            <div class="main__content">
                
                <!-- GM Dashboard -->
                <div class="gm-dashboard" id="gmContent" style="display: none;">
                    
                    <!-- Hero Section -->
                    <div class="gm-hero">
                        <div class="gm-hero__info">
                            <div class="gm-hero__badge">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/>
                                </svg>
                                Game Master
                            </div>
                            <h1 class="gm-hero__title">GM Optionen</h1>
                            <p class="gm-hero__session">Raum: <strong id="roomCodeDisplay">---</strong></p>
                        </div>
                        <div class="gm-hero__actions">
                            <button class="gm-code-btn" id="copyCodeBtn">
                                <span id="roomCodeCopy">---</span>
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <rect x="9" y="9" width="13" height="13" rx="2" ry="2"/>
                                    <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"/>
                                </svg>
                            </button>
                            <button class="gm-code-btn" id="copyInviteBtn" style="background: var(--accent);">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width:18px;height:18px;">
                                    <path d="M16 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/>
                                    <circle cx="8.5" cy="7" r="4"/>
                                    <line x1="20" y1="8" x2="20" y2="14"/>
                                    <line x1="23" y1="11" x2="17" y2="11"/>
                                </svg>
                                Einladen
                            </button>
                        </div>
                    </div>
                    
                    <!-- Bento Grid -->
                    <div class="gm-grid">
                        
                        <!-- Room Info Card -->
                        <div class="gm-card gm-card--wide">
                            <div class="gm-card__header">
                                <div class="gm-card__icon gm-card__icon--blue">
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/>
                                        <polyline points="9 22 9 12 15 12 15 22"/>
                                    </svg>
                                </div>
                                <span class="gm-card__title">Raum-Info</span>
                            </div>
                            <div class="room-info-grid">
                                <div class="room-info-item">
                                    <span class="room-info-item__label">Erstellt am</span>
                                    <span class="room-info-item__value" id="roomCreated">Lädt...</span>
                                </div>
                                <div class="room-info-item">
                                    <span class="room-info-item__label">Regelwerk</span>
                                    <span class="room-info-item__value" id="roomRuleset">-</span>
                                </div>
                                <div class="room-info-item">
                                    <span class="room-info-item__label">Spieler</span>
                                    <span class="room-info-item__value room-info-item__value--success" id="roomPlayers">0 / 0</span>
                                </div>
                                <div class="room-info-item">
                                    <span class="room-info-item__label">Sessions</span>
                                    <span class="room-info-item__value" id="roomSessions">0</span>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Players Card -->
                        <div class="gm-card gm-card--tall">
                            <div class="gm-card__header">
                                <div class="gm-card__icon gm-card__icon--green">
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/>
                                        <circle cx="9" cy="7" r="4"/>
                                        <path d="M23 21v-2a4 4 0 0 0-3-3.87"/>
                                        <path d="M16 3.13a4 4 0 0 1 0 7.75"/>
                                    </svg>
                                </div>
                                <span class="gm-card__title">Spieler <span id="playerCount" style="opacity:0.5;font-weight:400;">(0)</span></span>
                            </div>
                            <div class="players-list" id="playersList">
                                <div class="players-loading" style="padding: 40px 20px; text-align: center; color: rgba(255,255,255,0.4);">
                                    <div class="spinner" style="width:24px;height:24px;border:2px solid rgba(255,255,255,0.1);border-top-color:var(--accent);border-radius:50%;animation:spin 1s linear infinite;margin:0 auto 12px;"></div>
                                    Spieler werden geladen...
                                </div>
                            </div>
                            <button class="invite-row" id="invitePlayerBtn">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <line x1="12" y1="5" x2="12" y2="19"/>
                                    <line x1="5" y1="12" x2="19" y2="12"/>
                                </svg>
                                Spieler einladen
                            </button>
                        </div>
                        
                        <!-- Sessions Card -->
                        <div class="gm-card gm-card--tall">
                            <div class="gm-card__header">
                                <div class="gm-card__icon gm-card__icon--purple">
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <rect x="3" y="4" width="18" height="18" rx="2" ry="2"/>
                                        <line x1="16" y1="2" x2="16" y2="6"/>
                                        <line x1="8" y1="2" x2="8" y2="6"/>
                                        <line x1="3" y1="10" x2="21" y2="10"/>
                                    </svg>
                                </div>
                                <span class="gm-card__title">Sessions <span id="sessionCount" style="opacity:0.5;font-weight:400;">(0)</span></span>
                            </div>
                            <div class="sessions-list" id="sessionsList">
                                <div class="sessions-loading" style="padding: 40px 20px; text-align: center; color: rgba(255,255,255,0.4);">
                                    <div class="spinner" style="width:24px;height:24px;border:2px solid rgba(255,255,255,0.1);border-top-color:var(--accent);border-radius:50%;animation:spin 1s linear infinite;margin:0 auto 12px;"></div>
                                    Sessions werden geladen...
                                </div>
                            </div>
                            <a href="sessions.html?create=true" class="invite-row">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <line x1="12" y1="5" x2="12" y2="19"/>
                                    <line x1="5" y1="12" x2="19" y2="12"/>
                                </svg>
                                Neue Session erstellen
                            </a>
                        </div>
                        
                        <!-- Quick Actions Card -->
                        <div class="gm-card gm-card--wide">
                            <div class="gm-card__header">
                                <div class="gm-card__icon gm-card__icon--yellow">
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"/>
                                    </svg>
                                </div>
                                <span class="gm-card__title">Schnellaktionen</span>
                            </div>
                            <div class="quick-actions-grid">
                                <a href="sessions.html" class="quick-action-btn">
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <rect x="3" y="4" width="18" height="18" rx="2" ry="2"/>
                                        <line x1="16" y1="2" x2="16" y2="6"/>
                                        <line x1="8" y1="2" x2="8" y2="6"/>
                                        <line x1="3" y1="10" x2="21" y2="10"/>
                                    </svg>
                                    Sessions verwalten
                                </a>
                                <a href="dice.html" class="quick-action-btn">
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <rect x="2" y="2" width="20" height="20" rx="2"/>
                                        <circle cx="8" cy="8" r="1.5" fill="currentColor"/>
                                        <circle cx="16" cy="8" r="1.5" fill="currentColor"/>
                                        <circle cx="8" cy="16" r="1.5" fill="currentColor"/>
                                        <circle cx="16" cy="16" r="1.5" fill="currentColor"/>
                                        <circle cx="12" cy="12" r="1.5" fill="currentColor"/>
                                    </svg>
                                    Würfeln
                                </a>
                                <a href="chat.html" class="quick-action-btn">
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/>
                                    </svg>
                                    Chat öffnen
                                </a>
                                <a href="map.html" class="quick-action-btn">
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <polygon points="1 6 1 22 8 18 16 22 23 18 23 2 16 6 8 2 1 6"/>
                                        <line x1="8" y1="2" x2="8" y2="18"/>
                                        <line x1="16" y1="6" x2="16" y2="22"/>
                                    </svg>
                                    Karte öffnen
                                </a>
                            </div>
                        </div>
                        
                        <!-- Danger Zone Card -->
                        <div class="gm-card gm-card--wide gm-card--danger">
                            <div class="gm-card__header">
                                <div class="gm-card__icon gm-card__icon--red">
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"/>
                                        <line x1="12" y1="9" x2="12" y2="13"/>
                                        <line x1="12" y1="17" x2="12.01" y2="17"/>
                                    </svg>
                                </div>
                                <span class="gm-card__title">Gefahrenzone</span>
                            </div>
                            <div class="danger-zone">
                                <div class="danger-item">
                                    <div class="danger-item__info">
                                        <strong>Raum verlassen</strong>
                                        <p>Du verlässt den Raum. Ein anderer Spieler wird zum GM.</p>
                                    </div>
                                    <button class="danger-btn danger-btn--warning" id="leaveRoomBtn">Verlassen</button>
                                </div>
                                <div class="danger-item">
                                    <div class="danger-item__info">
                                        <strong>Raum löschen</strong>
                                        <p>Der Raum und alle Daten werden unwiderruflich gelöscht.</p>
                                    </div>
                                    <button class="danger-btn danger-btn--danger" id="deleteRoomBtn">Löschen</button>
                                </div>
                            </div>
                        </div>
                        
                    </div>
                </div>
                
                <!-- Access Denied -->
                <div class="access-denied" id="accessDenied" style="display: none;">
                    <div class="access-denied__icon">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                            <rect x="3" y="11" width="18" height="11" rx="2" ry="2"/>
                            <path d="M7 11V7a5 5 0 0 1 10 0v4"/>
                        </svg>
                    </div>
                    <h2 class="access-denied__title">Zugriff verweigert</h2>
                    <p class="access-denied__text">Diese Seite ist nur für den Spielleiter (GM) zugänglich.</p>
                    <a href="index.html" class="access-denied__btn">Zurück zum Hub</a>
                </div>
                
                <!-- Loading State -->
                <div class="gm-loading" id="loadingState">
                    <div class="spinner" style="width:32px;height:32px;border:3px solid rgba(255,255,255,0.1);border-top-color:var(--accent);border-radius:50%;animation:spin 1s linear infinite;"></div>
                    <p style="margin-top:16px;color:rgba(255,255,255,0.5);">Lade GM Optionen...</p>
                </div>
                
            </div>
        </main>
    </div>
    
    <style>
        @keyframes spin { to { transform: rotate(360deg); } }
        
        .gm-loading {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 60vh;
        }
        
        .quick-actions-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
        }
        
        .quick-action-btn {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
            padding: 20px 16px;
            background: rgba(255,255,255,0.03);
            border: 1px solid rgba(255,255,255,0.06);
            border-radius: 12px;
            color: rgba(255,255,255,0.7);
            text-decoration: none;
            font-size: 13px;
            transition: all 0.2s ease;
        }
        
        .quick-action-btn:hover {
            background: rgba(255,255,255,0.06);
            border-color: rgba(255,255,255,0.1);
            color: white;
        }
        
        .quick-action-btn svg {
            width: 24px;
            height: 24px;
            opacity: 0.7;
        }
        
        .danger-zone {
            display: flex;
            flex-direction: column;
            gap: 16px;
        }
        
        .danger-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 16px;
            padding: 16px;
            background: rgba(255,70,85,0.05);
            border: 1px solid rgba(255,70,85,0.1);
            border-radius: 12px;
        }
        
        .danger-item__info strong {
            display: block;
            color: white;
            margin-bottom: 4px;
        }
        
        .danger-item__info p {
            color: rgba(255,255,255,0.5);
            font-size: 13px;
            margin: 0;
        }
        
        .danger-btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            white-space: nowrap;
        }
        
        .danger-btn--warning {
            background: rgba(255,200,0,0.1);
            color: #ffc800;
        }
        
        .danger-btn--warning:hover {
            background: rgba(255,200,0,0.2);
        }
        
        .danger-btn--danger {
            background: rgba(255,70,85,0.1);
            color: var(--accent);
        }
        
        .danger-btn--danger:hover {
            background: rgba(255,70,85,0.2);
        }
        
        .gm-card--danger {
            border-color: rgba(255,70,85,0.2);
        }
        
        .sessions-list, .players-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
            max-height: 300px;
            overflow-y: auto;
        }
        
        .session-row {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px;
            background: rgba(255,255,255,0.03);
            border-radius: 10px;
            text-decoration: none;
            color: white;
            transition: background 0.2s ease;
        }
        
        .session-row:hover {
            background: rgba(255,255,255,0.06);
        }
        
        .session-row__date {
            display: flex;
            flex-direction: column;
            align-items: center;
            min-width: 45px;
            padding: 6px 8px;
            background: rgba(255,255,255,0.05);
            border-radius: 8px;
            font-size: 11px;
            line-height: 1.3;
        }
        
        .session-row__date-day {
            font-weight: 700;
            font-size: 16px;
        }
        
        .session-row__info {
            flex: 1;
            min-width: 0;
        }
        
        .session-row__name {
            font-weight: 600;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .session-row__meta {
            font-size: 12px;
            color: rgba(255,255,255,0.5);
        }
        
        .session-row__status {
            padding: 4px 8px;
            border-radius: 6px;
            font-size: 11px;
            font-weight: 600;
        }
        
        .session-row__status--planned { background: rgba(139,92,246,0.2); color: #a78bfa; }
        .session-row__status--live { background: rgba(34,197,94,0.2); color: #22c55e; }
        
        .sessions-empty, .players-empty {
            padding: 40px 20px;
            text-align: center;
            color: rgba(255,255,255,0.4);
        }
        
        .sessions-empty svg, .players-empty svg {
            width: 48px;
            height: 48px;
            margin-bottom: 12px;
            opacity: 0.3;
        }
        
        .gm-card__icon--purple {
            background: rgba(139, 92, 246, 0.15);
            color: #a78bfa;
        }
    </style>
    
    <!-- Firebase Scripts -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    <script src="assets/js/firebase-config.js"></script>
    <script src="assets/js/app.js"></script>
    <script src="assets/js/user-service.js"></script>
    <script src="assets/js/room-service.js"></script>
    <script src="assets/js/layout.js"></script>
    
    <script>
        // ========================================
        // GM DASHBOARD - FUNKTIONAL
        // ========================================
        
        const GMDash = {
            roomCode: null,
            members: [],
            sessions: [],
            room: null,
            unsubscribeMembers: null,
            unsubscribeSessions: null,
            
            // ----------------------------------------
            // INITIALIZATION
            // ----------------------------------------
            async init() {
                console.log('[GM] Initializing...');
                
                this.roomCode = localStorage.getItem('rift_current_room');
                if (!this.roomCode) {
                    console.error('[GM] No room code!');
                    return;
                }
                
                // Update room code displays
                const formatted = this.roomCode.replace(/(.{3})(.{3})/, '$1-$2');
                document.getElementById('roomCodeDisplay').textContent = formatted;
                document.getElementById('roomCodeCopy').textContent = formatted;
                
                // Setup event listeners
                this.setupEventListeners();
                
                // Wait for Firebase to be ready
                await this.waitForFirebase();
                
                // Load data
                await this.loadRoomInfo();
                this.subscribeToMembers();
                this.subscribeToSessions();
            },
            
            // ----------------------------------------
            // WAIT FOR FIREBASE
            // ----------------------------------------
            waitForFirebase(timeout = 5000) {
                return new Promise((resolve) => {
                    const start = Date.now();
                    const check = () => {
                        const db = RIFT?.firebase?.getFirestore?.();
                        if (db) {
                            console.log('[GM] Firebase ready');
                            resolve(true);
                        } else if (Date.now() - start > timeout) {
                            console.warn('[GM] Firebase timeout, proceeding anyway');
                            resolve(false);
                        } else {
                            setTimeout(check, 100);
                        }
                    };
                    check();
                });
            },
            
            // ----------------------------------------
            // EVENT LISTENERS
            // ----------------------------------------
            setupEventListeners() {
                // Copy code button
                document.getElementById('copyCodeBtn')?.addEventListener('click', () => {
                    navigator.clipboard.writeText(this.roomCode).then(() => {
                        this.showToast('Raum-Code kopiert!', 'success');
                    });
                });
                
                // Copy invite link button
                document.getElementById('copyInviteBtn')?.addEventListener('click', () => {
                    const url = `${window.location.origin}/login.html?room=${this.roomCode}`;
                    navigator.clipboard.writeText(url).then(() => {
                        this.showToast('Einladungslink kopiert!', 'success');
                    });
                });
                
                // Invite player button
                document.getElementById('invitePlayerBtn')?.addEventListener('click', () => {
                    const url = `${window.location.origin}/login.html?room=${this.roomCode}`;
                    navigator.clipboard.writeText(url).then(() => {
                        this.showToast('Einladungslink kopiert!', 'success');
                    });
                });
                
                // Leave room button
                document.getElementById('leaveRoomBtn')?.addEventListener('click', () => this.leaveRoom());
                
                // Delete room button
                document.getElementById('deleteRoomBtn')?.addEventListener('click', () => this.deleteRoom());
            },
            
            // ----------------------------------------
            // LOAD ROOM INFO
            // ----------------------------------------
            async loadRoomInfo() {
                try {
                    const room = await RIFT.rooms.getRoom(this.roomCode);
                    if (!room) {
                        console.error('[GM] Room not found');
                        return;
                    }
                    
                    this.room = room;
                    
                    // Created date
                    if (room.createdAt) {
                        const date = room.createdAt.toDate ? room.createdAt.toDate() : new Date(room.createdAt);
                        document.getElementById('roomCreated').textContent = date.toLocaleDateString('de-DE', {
                            day: '2-digit', month: '2-digit', year: 'numeric', hour: '2-digit', minute: '2-digit'
                        });
                    }
                    
                    // Ruleset
                    const rulesetNames = {
                        '5e2024': 'D&D 5E (2024)',
                        'worldsapart': 'Worlds Apart',
                        'htbah': 'How To Be A Hero',
                        'cyberpunk': 'Cyberpunk Red'
                    };
                    document.getElementById('roomRuleset').textContent = rulesetNames[room.ruleset] || room.ruleset || '-';
                    
                    console.log('[GM] Room loaded:', room.name);
                } catch (e) {
                    console.error('[GM] Failed to load room:', e);
                }
            },
            
            // ----------------------------------------
            // MEMBERS SUBSCRIPTION
            // ----------------------------------------
            subscribeToMembers() {
                if (this.unsubscribeMembers) this.unsubscribeMembers();
                
                console.log('[GM] Subscribing to members...');
                
                this.unsubscribeMembers = RIFT.rooms.subscribeToMembers(this.roomCode, (members) => {
                    console.log('[GM] Members update:', members.length, members);
                    this.members = members;
                    this.renderPlayers(members);
                    
                    // Update counts
                    const onlineCount = members.filter(m => m.online === true).length;
                    document.getElementById('roomPlayers').textContent = `${onlineCount} / ${members.length}`;
                    document.getElementById('playerCount').textContent = `(${members.length})`;
                });
            },
            
            // ----------------------------------------
            // RENDER PLAYERS
            // ----------------------------------------
            renderPlayers(members) {
                const list = document.getElementById('playersList');
                if (!list) return;
                
                const currentUserId = firebase?.auth()?.currentUser?.uid;
                
                if (members.length === 0) {
                    list.innerHTML = `
                        <div class="players-empty">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                                <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/>
                                <circle cx="9" cy="7" r="4"/>
                                <path d="M23 21v-2a4 4 0 0 0-3-3.87"/>
                                <path d="M16 3.13a4 4 0 0 1 0 7.75"/>
                            </svg>
                            <p>Noch keine Spieler im Raum</p>
                        </div>
                    `;
                    return;
                }
                
                list.innerHTML = members.map(member => {
                    const name = member.displayName || member.name || 'Unbekannt';
                    const color = member.color || '#8B5CF6';
                    const initial = name.charAt(0).toUpperCase();
                    const isGM = member.role === 'gm';
                    const isYou = member.id === currentUserId;
                    const isOnline = member.online === true;
                    
                    return `
                        <div class="player-row">
                            <div class="player-row__avatar ${isOnline ? '' : 'player-row__avatar--offline'}" style="background: ${color};">${initial}</div>
                            <div class="player-row__info">
                                <div class="player-row__name">${name}</div>
                                <div class="player-row__role">${isGM ? 'Game Master' : 'Spieler'}${isOnline ? '' : ' · Offline'}</div>
                            </div>
                            ${isGM ? '<span class="player-row__badge player-row__badge--gm">GM</span>' : ''}
                            ${isYou ? '<span class="player-row__badge player-row__badge--you">Du</span>' : ''}
                            ${!isGM && !isYou ? `
                                <button class="player-row__action" onclick="GMDash.kickPlayer('${member.id}', '${name.replace(/'/g, "\\'")}')" title="Spieler entfernen">
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <line x1="18" y1="6" x2="6" y2="18"/>
                                        <line x1="6" y1="6" x2="18" y2="18"/>
                                    </svg>
                                </button>
                            ` : ''}
                        </div>
                    `;
                }).join('');
            },
            
            // ----------------------------------------
            // SESSIONS SUBSCRIPTION
            // ----------------------------------------
            subscribeToSessions() {
                if (this.unsubscribeSessions) this.unsubscribeSessions();
                
                console.log('[GM] Subscribing to sessions...');
                
                this.unsubscribeSessions = RIFT.rooms.subscribeToSessions(this.roomCode, (sessions) => {
                    console.log('[GM] Sessions update:', sessions.length);
                    this.sessions = sessions;
                    this.renderSessions(sessions);
                    
                    // Update count
                    document.getElementById('roomSessions').textContent = sessions.length;
                    document.getElementById('sessionCount').textContent = `(${sessions.length})`;
                });
            },
            
            // ----------------------------------------
            // RENDER SESSIONS
            // ----------------------------------------
            renderSessions(sessions) {
                const list = document.getElementById('sessionsList');
                if (!list) return;
                
                if (sessions.length === 0) {
                    list.innerHTML = `
                        <div class="sessions-empty">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                                <rect x="3" y="4" width="18" height="18" rx="2" ry="2"/>
                                <line x1="16" y1="2" x2="16" y2="6"/>
                                <line x1="8" y1="2" x2="8" y2="6"/>
                                <line x1="3" y1="10" x2="21" y2="10"/>
                            </svg>
                            <p>Noch keine Sessions erstellt</p>
                        </div>
                    `;
                    return;
                }
                
                // Sort by date (upcoming first)
                const sorted = [...sessions].sort((a, b) => new Date(a.date) - new Date(b.date));
                const months = ['Jan', 'Feb', 'Mär', 'Apr', 'Mai', 'Jun', 'Jul', 'Aug', 'Sep', 'Okt', 'Nov', 'Dez'];
                
                list.innerHTML = sorted.map(session => {
                    const date = new Date(session.date);
                    const day = date.getDate();
                    const month = months[date.getMonth()];
                    const statusClass = session.status === 'live' ? 'live' : 'planned';
                    const statusText = session.status === 'live' ? 'Live' : 'Geplant';
                    
                    return `
                        <a href="session.html?id=${session.id}" class="session-row">
                            <div class="session-row__date">
                                <span class="session-row__date-day">${day}</span>
                                <span>${month}</span>
                            </div>
                            <div class="session-row__info">
                                <div class="session-row__name">${session.name || 'Unbenannte Session'}</div>
                                <div class="session-row__meta">${session.time || '20:00'} Uhr</div>
                            </div>
                            <span class="session-row__status session-row__status--${statusClass}">${statusText}</span>
                        </a>
                    `;
                }).join('');
            },
            
            // ----------------------------------------
            // KICK PLAYER
            // ----------------------------------------
            async kickPlayer(oderId, name) {
                if (!confirm(`${name} wirklich aus dem Raum entfernen?`)) return;
                
                try {
                    const db = RIFT.firebase.getFirestore();
                    const normalizedCode = this.roomCode.replace('-', '').toUpperCase();
                    
                    await db.collection('rooms').doc(normalizedCode)
                        .collection('members').doc(oderId).delete();
                    
                    this.showToast(`${name} wurde entfernt`, 'success');
                } catch (e) {
                    console.error('[GM] Failed to kick player:', e);
                    this.showToast('Fehler beim Entfernen', 'error');
                }
            },
            
            // ----------------------------------------
            // LEAVE ROOM
            // ----------------------------------------
            async leaveRoom() {
                if (!confirm('Raum wirklich verlassen? Du verlierst deine GM-Rechte.')) return;
                
                try {
                    const currentUserId = firebase.auth().currentUser?.uid;
                    if (!currentUserId) return;
                    
                    const db = RIFT.firebase.getFirestore();
                    const normalizedCode = this.roomCode.replace('-', '').toUpperCase();
                    
                    // Remove self from members
                    await db.collection('rooms').doc(normalizedCode)
                        .collection('members').doc(currentUserId).delete();
                    
                    // Clear local storage
                    localStorage.removeItem('rift_current_room');
                    const userData = JSON.parse(localStorage.getItem('rift_user') || '{}');
                    userData.isGM = false;
                    localStorage.setItem('rift_user', JSON.stringify(userData));
                    
                    this.showToast('Raum verlassen', 'success');
                    setTimeout(() => window.location.href = 'login.html', 1000);
                } catch (e) {
                    console.error('[GM] Failed to leave room:', e);
                    this.showToast('Fehler beim Verlassen', 'error');
                }
            },
            
            // ----------------------------------------
            // DELETE ROOM
            // ----------------------------------------
            async deleteRoom() {
                if (!confirm('⚠️ ACHTUNG!\n\nDer Raum und ALLE Daten werden unwiderruflich gelöscht!\n\nDiese Aktion kann NICHT rückgängig gemacht werden.\n\nFortfahren?')) return;
                
                try {
                    const db = RIFT.firebase.getFirestore();
                    const normalizedCode = this.roomCode.replace('-', '').toUpperCase();
                    const roomRef = db.collection('rooms').doc(normalizedCode);
                    
                    this.showToast('Raum wird gelöscht...', 'info');
                    
                    // Delete all subcollections
                    const subcollections = ['members', 'sessions', 'characters', 'chat', 'dice', 'notes', 'whiteboard', 'markers'];
                    
                    for (const subcol of subcollections) {
                        const snapshot = await roomRef.collection(subcol).get();
                        const batch = db.batch();
                        snapshot.docs.forEach(doc => batch.delete(doc.ref));
                        if (snapshot.docs.length > 0) await batch.commit();
                    }
                    
                    // Delete room document
                    await roomRef.delete();
                    
                    // Clear local storage
                    localStorage.removeItem('rift_current_room');
                    localStorage.removeItem('rift_active_session');
                    const userData = JSON.parse(localStorage.getItem('rift_user') || '{}');
                    userData.isGM = false;
                    localStorage.setItem('rift_user', JSON.stringify(userData));
                    
                    this.showToast('Raum gelöscht!', 'success');
                    setTimeout(() => window.location.href = 'login.html', 1500);
                } catch (e) {
                    console.error('[GM] Failed to delete room:', e);
                    this.showToast('Fehler beim Löschen', 'error');
                }
            },
            
            // ----------------------------------------
            // TOAST HELPER
            // ----------------------------------------
            showToast(message, type = 'info') {
                if (window.RIFT?.ui?.Toast) {
                    RIFT.ui.Toast[type]?.(message) || RIFT.ui.Toast.info(message);
                } else {
                    console.log(`[Toast] ${type}: ${message}`);
                }
            },
            
            // ----------------------------------------
            // CLEANUP
            // ----------------------------------------
            cleanup() {
                if (this.unsubscribeMembers) this.unsubscribeMembers();
                if (this.unsubscribeSessions) this.unsubscribeSessions();
            }
        };
        
        // Cleanup on page unload
        window.addEventListener('beforeunload', () => GMDash.cleanup());
        
        // ========================================
        // ACCESS CHECK & INITIALIZATION
        // ========================================
        
        (async function() {
            const gmContent = document.getElementById('gmContent');
            const accessDenied = document.getElementById('accessDenied');
            const loadingState = document.getElementById('loadingState');
            const currentRoomCode = localStorage.getItem('rift_current_room');
            const userData = JSON.parse(localStorage.getItem('rift_user') || '{}');
            
            // Debug: Check if elements exist
            console.log('[GM] Elements found:', {
                gmContent: !!gmContent,
                accessDenied: !!accessDenied,
                loadingState: !!loadingState
            });
            
            if (!gmContent || !loadingState) {
                console.error('[GM] Required elements not found!');
                return;
            }
            
            function showLoading() {
                console.log('[GM] showLoading');
                loadingState.style.display = 'flex';
                gmContent.style.display = 'none';
                accessDenied.style.display = 'none';
            }
            
            function showContent() {
                console.log('[GM] showContent - FORCING DISPLAY');
                loadingState.style.setProperty('display', 'none', 'important');
                gmContent.style.setProperty('display', 'block', 'important');
                accessDenied.style.setProperty('display', 'none', 'important');
                console.log('[GM] After setProperty - gmContent.style.display:', gmContent.style.display);
            }
            
            function showDenied() {
                console.log('[GM] showDenied');
                loadingState.style.setProperty('display', 'none', 'important');
                gmContent.style.setProperty('display', 'none', 'important');
                accessDenied.style.setProperty('display', 'flex', 'important');
            }
            
            // Start with loading
            showLoading();
            
            // Wait for RIFT with timeout
            function waitForRIFT(timeout = 8000) {
                return new Promise((resolve, reject) => {
                    const start = Date.now();
                    const check = () => {
                        // Check if RIFT, rooms, firebase, AND getFirestore() returns something
                        const db = RIFT?.firebase?.getFirestore?.();
                        if (typeof RIFT !== 'undefined' && RIFT.rooms && RIFT.firebase && db) {
                            console.log('[GM] RIFT fully ready with Firestore');
                            resolve(true);
                        } else if (Date.now() - start > timeout) {
                            reject(new Error('Timeout'));
                        } else {
                            setTimeout(check, 100);
                        }
                    };
                    check();
                });
            }
            
            // Wait for Firebase Auth
            function waitForAuth(timeout = 5000) {
                return new Promise((resolve) => {
                    if (firebase?.auth()?.currentUser) {
                        resolve(firebase.auth().currentUser);
                        return;
                    }
                    
                    const unsubscribe = firebase.auth().onAuthStateChanged(user => {
                        unsubscribe();
                        resolve(user);
                    });
                    
                    setTimeout(() => resolve(null), timeout);
                });
            }
            
            try {
                await waitForRIFT();
                console.log('[GM] RIFT ready');
                
                // Wait for auth
                const user = await waitForAuth();
                console.log('[GM] Auth user:', user?.uid);
                
                if (!currentRoomCode) {
                    console.log('[GM] No room code');
                    showDenied();
                    return;
                }
                
                if (!user) {
                    console.log('[GM] No authenticated user');
                    showDenied();
                    return;
                }
                
                // Check if user is GM
                let isGM = false;
                
                try {
                    isGM = await RIFT.rooms.isUserGM(currentRoomCode);
                    console.log('[GM] Firebase GM check result:', isGM);
                } catch (e) {
                    console.warn('[GM] Firebase check failed, using localStorage:', e);
                    isGM = userData.isGM === true;
                }
                
                if (isGM) {
                    // Update localStorage
                    userData.isGM = true;
                    localStorage.setItem('rift_user', JSON.stringify(userData));
                    
                    // Show content and init
                    showContent();
                    GMDash.init();
                } else {
                    showDenied();
                }
            } catch (e) {
                console.error('[GM] Init failed:', e);
                
                // Fallback to localStorage
                if (userData.isGM === true && currentRoomCode) {
                    showContent();
                    GMDash.init();
                } else {
                    showDenied();
                }
            }
        })();
        
        // Initialize layout
        initLayout();
    </script>
</body>
</html>
