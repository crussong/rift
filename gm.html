<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title>RIFT ‚Äì GM Kontrollzentrum</title>
    
    <link rel="stylesheet" href="assets/css/core.css">
    <link rel="stylesheet" href="assets/css/ui.css">
    <link rel="stylesheet" href="assets/css/sidebar.css">
    <link rel="stylesheet" href="assets/css/topbar.css">
    <link rel="stylesheet" href="assets/css/footer.css">
    
    <style>
        .gm { max-width: 900px; margin: 0 auto; padding: 20px; }
        
        /* Header */
        .gm-header { display: flex; align-items: center; gap: 16px; margin-bottom: 24px; padding-bottom: 20px; border-bottom: 1px solid rgba(255,255,255,0.08); }
        .gm-header__icon { width: 48px; height: 48px; display: flex; align-items: center; justify-content: center; background: rgba(255,70,85,0.15); border-radius: 12px; color: var(--accent); }
        .gm-header__icon svg { width: 28px; height: 28px; }
        .gm-header__info { flex: 1; }
        .gm-header__title { font-size: 24px; font-weight: 700; color: white; margin: 0 0 4px 0; }
        .gm-header__room { font-size: 14px; color: rgba(255,255,255,0.5); margin: 0; }
        .gm-header__room code { background: rgba(255,255,255,0.1); padding: 2px 8px; border-radius: 4px; font-family: monospace; color: var(--accent); cursor: pointer; }
        .gm-header__room code:hover { background: rgba(255,255,255,0.15); }
        
        /* Tabs */
        .gm-tabs { display: flex; gap: 4px; margin-bottom: 24px; padding: 4px; background: rgba(255,255,255,0.03); border-radius: 12px; overflow-x: auto; }
        .gm-tab { flex: 1; min-width: 70px; padding: 12px 14px; background: transparent; border: none; border-radius: 8px; color: rgba(255,255,255,0.5); font-size: 13px; font-weight: 500; cursor: pointer; transition: all 0.2s; white-space: nowrap; }
        .gm-tab:hover { color: rgba(255,255,255,0.8); background: rgba(255,255,255,0.05); }
        .gm-tab--active { color: white; background: rgba(255,70,85,0.15); }
        
        /* Content */
        .gm-content { display: none; }
        .gm-content--active { display: block; animation: fadeIn 0.2s ease; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        /* Section */
        .gm-section { background: rgba(255,255,255,0.02); border: 1px solid rgba(255,255,255,0.06); border-radius: 12px; padding: 20px; margin-bottom: 16px; }
        .gm-section__title { font-size: 12px; font-weight: 600; color: rgba(255,255,255,0.4); text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 16px; display: flex; align-items: center; gap: 8px; }
        .gm-section__header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 16px; }
        .gm-section__header .gm-section__title { margin-bottom: 0; }
        
        /* Stats */
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(100px, 1fr)); gap: 12px; }
        .stat-card { background: rgba(255,255,255,0.03); border-radius: 10px; padding: 16px; text-align: center; }
        .stat-card__value { font-size: 28px; font-weight: 700; color: white; line-height: 1; }
        .stat-card__value--green { color: #22c55e; }
        .stat-card__value--purple { color: #a78bfa; }
        .stat-card__value--orange { color: #f97316; }
        .stat-card__label { font-size: 11px; color: rgba(255,255,255,0.5); margin-top: 6px; }
        
        /* Session Timer */
        .session-timer { display: flex; align-items: center; gap: 16px; padding: 16px 20px; background: linear-gradient(135deg, rgba(34,197,94,0.15), rgba(34,197,94,0.05)); border: 1px solid rgba(34,197,94,0.3); border-radius: 12px; margin-bottom: 16px; }
        .session-timer__pulse { width: 12px; height: 12px; background: #22c55e; border-radius: 50%; animation: pulse 2s infinite; }
        @keyframes pulse { 0%, 100% { box-shadow: 0 0 0 0 rgba(34,197,94,0.4); } 50% { box-shadow: 0 0 0 8px rgba(34,197,94,0); } }
        .session-timer__info { flex: 1; }
        .session-timer__label { font-size: 11px; font-weight: 700; color: #22c55e; letter-spacing: 1px; }
        .session-timer__name { font-size: 16px; font-weight: 600; color: white; }
        .session-timer__time { font-size: 28px; font-weight: 700; color: white; font-family: monospace; }
        .session-timer__stop { padding: 10px 20px; background: rgba(255,70,85,0.15); border: none; border-radius: 8px; color: var(--accent); font-weight: 600; cursor: pointer; }
        .session-timer__stop:hover { background: rgba(255,70,85,0.25); }
        
        /* Quick Actions */
        .quick-actions { display: grid; grid-template-columns: repeat(auto-fit, minmax(100px, 1fr)); gap: 10px; }
        .quick-action { display: flex; flex-direction: column; align-items: center; gap: 8px; padding: 16px 12px; background: rgba(255,255,255,0.03); border: 1px solid rgba(255,255,255,0.06); border-radius: 10px; color: rgba(255,255,255,0.7); text-decoration: none; font-size: 13px; transition: all 0.2s; }
        .quick-action:hover { background: rgba(255,255,255,0.06); color: white; }
        .quick-action svg { width: 24px; height: 24px; opacity: 0.6; }
        
        /* Character Cards */
        .char-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(260px, 1fr)); gap: 12px; }
        .char-card { background: rgba(255,255,255,0.03); border: 1px solid rgba(255,255,255,0.06); border-radius: 12px; padding: 16px; }
        .char-card__header { display: flex; align-items: center; gap: 12px; margin-bottom: 12px; }
        .char-card__avatar { width: 44px; height: 44px; border-radius: 10px; display: flex; align-items: center; justify-content: center; font-weight: 700; font-size: 18px; color: white; }
        .char-card__info { flex: 1; min-width: 0; }
        .char-card__name { font-weight: 600; color: white; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .char-card__meta { font-size: 12px; color: rgba(255,255,255,0.5); }
        .char-card__online { width: 10px; height: 10px; border-radius: 50%; background: #22c55e; }
        .char-card__online--offline { background: rgba(255,255,255,0.2); }
        
        /* HP Bar */
        .hp-section { margin-top: 12px; }
        .hp-header { display: flex; justify-content: space-between; font-size: 12px; margin-bottom: 4px; }
        .hp-header__label { color: rgba(255,255,255,0.5); }
        .hp-header__value { color: white; font-weight: 600; }
        .hp-bar { height: 8px; background: rgba(255,255,255,0.1); border-radius: 4px; overflow: hidden; }
        .hp-bar__fill { height: 100%; border-radius: 4px; transition: width 0.3s, background 0.3s; }
        .hp-bar__fill--high { background: #22c55e; }
        .hp-bar__fill--mid { background: #f97316; }
        .hp-bar__fill--low { background: #ef4444; }
        .hp-controls { display: flex; gap: 6px; margin-top: 10px; }
        .hp-controls input { width: 50px; padding: 6px; background: rgba(0,0,0,0.3); border: 1px solid rgba(255,255,255,0.1); border-radius: 6px; color: white; text-align: center; font-size: 13px; }
        .hp-controls input:focus { outline: none; border-color: var(--accent); }
        .hp-btn { padding: 6px 10px; border: none; border-radius: 6px; font-weight: 600; font-size: 12px; cursor: pointer; }
        .hp-btn--dmg { background: rgba(239,68,68,0.2); color: #ef4444; }
        .hp-btn--dmg:hover { background: rgba(239,68,68,0.3); }
        .hp-btn--heal { background: rgba(34,197,94,0.2); color: #22c55e; }
        .hp-btn--heal:hover { background: rgba(34,197,94,0.3); }
        
        /* Log List */
        .log-list { max-height: 350px; overflow-y: auto; display: flex; flex-direction: column; gap: 6px; }
        .log-item { display: flex; align-items: center; gap: 10px; padding: 10px 12px; background: rgba(255,255,255,0.02); border-radius: 8px; font-size: 13px; }
        .log-item__time { font-size: 11px; color: rgba(255,255,255,0.3); min-width: 45px; }
        .log-item__icon { width: 28px; height: 28px; display: flex; align-items: center; justify-content: center; border-radius: 6px; flex-shrink: 0; font-size: 14px; }
        .log-item__icon--dice { background: rgba(139,92,246,0.2); }
        .log-item__icon--chat { background: rgba(59,130,246,0.2); }
        .log-item__icon--join { background: rgba(34,197,94,0.2); }
        .log-item__icon--leave { background: rgba(239,68,68,0.2); }
        .log-item__icon--edit { background: rgba(251,191,36,0.2); }
        .log-item__content { flex: 1; min-width: 0; color: rgba(255,255,255,0.8); }
        .log-item__user { font-weight: 600; color: white; }
        .log-item__result { font-weight: 700; color: #a78bfa; margin-left: 4px; }
        
        /* Poll */
        .poll-create { display: flex; flex-direction: column; gap: 12px; }
        .poll-create > input { padding: 12px; background: rgba(0,0,0,0.3); border: 1px solid rgba(255,255,255,0.1); border-radius: 8px; color: white; font-size: 14px; }
        .poll-create > input:focus { outline: none; border-color: var(--accent); }
        .poll-create > input::placeholder { color: rgba(255,255,255,0.3); }
        .poll-types { display: flex; gap: 8px; flex-wrap: wrap; }
        .poll-types label { display: flex; align-items: center; gap: 6px; padding: 8px 12px; background: rgba(255,255,255,0.05); border-radius: 6px; font-size: 13px; color: rgba(255,255,255,0.7); cursor: pointer; }
        .poll-types input[type="radio"] { accent-color: var(--accent); }
        .poll-settings { display: flex; align-items: center; gap: 16px; padding: 10px 0; }
        .poll-settings label { display: flex; align-items: center; gap: 8px; font-size: 13px; color: rgba(255,255,255,0.7); cursor: pointer; }
        .poll-settings input[type="checkbox"] { accent-color: var(--accent); width: 16px; height: 16px; }
        .poll-btn { padding: 12px 24px; background: var(--accent); border: none; border-radius: 8px; color: white; font-weight: 600; cursor: pointer; align-self: flex-end; }
        .poll-btn:hover { filter: brightness(1.1); }
        .poll-custom { display: flex; flex-direction: column; gap: 10px; margin-top: 8px; padding: 14px; background: rgba(255,255,255,0.03); border-radius: 8px; }
        
        /* Poll Image Upload */
        .poll-image-upload { display: flex; flex-direction: column; gap: 10px; margin-bottom: 8px; }
        .poll-image-upload__label { font-size: 12px; color: rgba(255,255,255,0.5); }
        .poll-image-upload__area { position: relative; width: 100%; aspect-ratio: 350/160; background: rgba(0,0,0,0.3); border: 2px dashed rgba(255,255,255,0.15); border-radius: 8px; display: flex; flex-direction: column; align-items: center; justify-content: center; cursor: pointer; overflow: hidden; transition: border-color 0.2s; }
        .poll-image-upload__area:hover { border-color: rgba(139,92,246,0.5); }
        .poll-image-upload__area.has-image { border-style: solid; border-color: rgba(139,92,246,0.3); }
        .poll-image-upload__placeholder { display: flex; flex-direction: column; align-items: center; gap: 8px; color: rgba(255,255,255,0.4); }
        .poll-image-upload__placeholder svg { width: 32px; height: 32px; }
        .poll-image-upload__placeholder span { font-size: 12px; }
        .poll-image-upload__preview { position: absolute; inset: 0; object-fit: cover; }
        .poll-image-upload__remove { position: absolute; top: 8px; right: 8px; width: 28px; height: 28px; background: rgba(0,0,0,0.7); border: none; border-radius: 6px; color: white; cursor: pointer; display: flex; align-items: center; justify-content: center; }
        .poll-image-upload__remove:hover { background: var(--accent); }
        .poll-image-upload input[type="file"] { display: none; }
        
        /* Poll Option Row */
        .poll-option-row { display: flex; align-items: center; gap: 8px; }
        .poll-option-row__emoji { position: relative; }
        .poll-option-row__emoji-btn { width: 40px; height: 40px; background: rgba(0,0,0,0.3); border: 1px solid rgba(255,255,255,0.1); border-radius: 6px; font-size: 18px; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: all 0.2s; }
        .poll-option-row__emoji-btn:hover { border-color: rgba(139,92,246,0.5); background: rgba(139,92,246,0.1); }
        .poll-option-row__input { flex: 1; padding: 10px 12px; background: rgba(0,0,0,0.3); border: 1px solid rgba(255,255,255,0.1); border-radius: 6px; color: white; font-size: 13px; }
        .poll-option-row__input:focus { outline: none; border-color: var(--accent); }
        .poll-option-row__input::placeholder { color: rgba(255,255,255,0.3); }
        .poll-option-row__remove { width: 32px; height: 32px; background: transparent; border: none; color: rgba(255,255,255,0.3); cursor: pointer; display: flex; align-items: center; justify-content: center; border-radius: 6px; }
        .poll-option-row__remove:hover { color: var(--accent); background: rgba(255,70,85,0.1); }
        
        /* Emoji Picker */
        .emoji-picker { position: absolute; top: 100%; left: 0; z-index: 100; background: #1a1a1a; border: 1px solid rgba(255,255,255,0.1); border-radius: 10px; padding: 10px; box-shadow: 0 10px 40px rgba(0,0,0,0.5); display: none; }
        .emoji-picker.visible { display: block; }
        .emoji-picker__grid { display: grid; grid-template-columns: repeat(8, 1fr); gap: 4px; }
        .emoji-picker__btn { width: 32px; height: 32px; background: transparent; border: none; border-radius: 6px; font-size: 18px; cursor: pointer; transition: background 0.15s; }
        .emoji-picker__btn:hover { background: rgba(255,255,255,0.1); }
        
        /* Add Option Button */
        .poll-add-option { display: flex; align-items: center; justify-content: center; gap: 6px; padding: 10px; background: transparent; border: 1px dashed rgba(255,255,255,0.15); border-radius: 6px; color: rgba(255,255,255,0.5); font-size: 13px; cursor: pointer; transition: all 0.2s; }
        .poll-add-option:hover { border-color: rgba(139,92,246,0.5); color: rgba(255,255,255,0.8); background: rgba(139,92,246,0.05); }
        .poll-add-option svg { width: 16px; height: 16px; }
        
        /* Image Cropper Modal */
        .cropper-modal { position: fixed; inset: 0; z-index: 10000; background: rgba(0,0,0,0.9); display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 20px; }
        .cropper-modal__container { position: relative; width: 100%; max-width: 600px; background: #1a1a1a; border-radius: 12px; overflow: hidden; }
        .cropper-modal__header { padding: 16px; border-bottom: 1px solid rgba(255,255,255,0.1); display: flex; justify-content: space-between; align-items: center; }
        .cropper-modal__title { font-weight: 600; color: white; }
        .cropper-modal__close { background: transparent; border: none; color: rgba(255,255,255,0.5); cursor: pointer; padding: 4px; }
        .cropper-modal__close:hover { color: white; }
        .cropper-modal__canvas-wrap { position: relative; width: 100%; aspect-ratio: 350/160; background: #000; overflow: hidden; cursor: move; }
        .cropper-modal__canvas { position: absolute; top: 0; left: 0; transform-origin: 0 0; pointer-events: none; }
        .cropper-modal__controls { padding: 16px; display: flex; gap: 12px; align-items: center; }
        .cropper-modal__zoom { flex: 1; accent-color: var(--accent); }
        .cropper-modal__actions { display: flex; gap: 10px; padding: 16px; border-top: 1px solid rgba(255,255,255,0.1); justify-content: flex-end; }
        .cropper-modal__btn { padding: 10px 20px; border: none; border-radius: 8px; font-weight: 600; cursor: pointer; }
        .cropper-modal__btn--cancel { background: rgba(255,255,255,0.1); color: white; }
        .cropper-modal__btn--apply { background: var(--accent); color: white; }
        
        /* Active Poll */
        .poll-active { padding: 16px; background: rgba(139,92,246,0.1); border: 1px solid rgba(139,92,246,0.2); border-radius: 12px; margin-bottom: 16px; }
        .poll-active__header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 12px; gap: 12px; }
        .poll-active__label { font-size: 11px; font-weight: 700; color: #a78bfa; letter-spacing: 1px; }
        .poll-active__question { font-size: 16px; font-weight: 600; color: white; margin-top: 4px; }
        .poll-active__actions { display: flex; gap: 8px; flex-shrink: 0; }
        .poll-active__resolve { padding: 8px 14px; background: rgba(34,197,94,0.2); border: none; border-radius: 6px; color: #22c55e; font-size: 12px; font-weight: 600; cursor: pointer; transition: all 0.2s; }
        .poll-active__resolve:hover { background: rgba(34,197,94,0.3); }
        .poll-active__close { width: 32px; height: 32px; background: rgba(255,255,255,0.1); border: none; border-radius: 6px; color: rgba(255,255,255,0.6); font-size: 14px; cursor: pointer; display: flex; align-items: center; justify-content: center; }
        .poll-active__close:hover { background: rgba(255,70,85,0.2); color: var(--accent); }
        .poll-results { display: flex; flex-direction: column; gap: 8px; }
        .poll-result { display: flex; align-items: center; gap: 10px; }
        .poll-result__label { min-width: 60px; font-size: 14px; color: rgba(255,255,255,0.8); }
        .poll-result__bar { flex: 1; height: 28px; background: rgba(255,255,255,0.1); border-radius: 6px; overflow: hidden; position: relative; }
        .poll-result__fill { height: 100%; background: linear-gradient(90deg, #8b5cf6, #a78bfa); transition: width 0.3s; }
        .poll-result__fill--winner { background: linear-gradient(90deg, #22c55e, #4ade80); }
        .poll-result__count { position: absolute; right: 10px; top: 50%; transform: translateY(-50%); font-size: 13px; font-weight: 600; color: white; }
        
        /* Broadcast */
        .broadcast-box textarea { width: 100%; min-height: 80px; padding: 14px; background: rgba(0,0,0,0.3); border: 1px solid rgba(255,255,255,0.1); border-radius: 10px; color: white; font-size: 14px; font-family: inherit; resize: vertical; }
        .broadcast-box textarea:focus { outline: none; border-color: var(--accent); }
        .broadcast-box textarea::placeholder { color: rgba(255,255,255,0.3); }
        .broadcast-actions { display: flex; align-items: center; justify-content: space-between; margin-top: 12px; }
        .broadcast-check { display: flex; align-items: center; gap: 8px; font-size: 14px; color: rgba(255,255,255,0.6); cursor: pointer; }
        .broadcast-check input { accent-color: var(--accent); }
        .broadcast-btn { display: flex; align-items: center; gap: 8px; padding: 12px 24px; background: var(--accent); border: none; border-radius: 8px; color: white; font-weight: 600; cursor: pointer; }
        .broadcast-btn:hover { filter: brightness(1.1); }
        .broadcast-btn svg { width: 18px; height: 18px; }
        
        /* Notes */
        .notes-box { position: relative; }
        .notes-box textarea { width: 100%; min-height: 150px; padding: 14px; background: rgba(0,0,0,0.3); border: 1px solid rgba(255,255,255,0.1); border-radius: 10px; color: white; font-size: 14px; font-family: inherit; line-height: 1.6; resize: vertical; }
        .notes-box textarea:focus { outline: none; border-color: rgba(6,182,212,0.5); }
        .notes-box__status { position: absolute; top: 12px; right: 12px; font-size: 12px; }
        .notes-box__status--saving { color: #fbbf24; }
        .notes-box__status--saved { color: #22c55e; }
        
        /* Session List */
        .session-list { display: flex; flex-direction: column; gap: 8px; }
        .session-item { display: flex; align-items: center; gap: 12px; padding: 12px; background: rgba(255,255,255,0.03); border-radius: 10px; }
        .session-item__date { display: flex; flex-direction: column; align-items: center; min-width: 50px; padding: 8px; background: rgba(255,255,255,0.05); border-radius: 8px; }
        .session-item__day { font-size: 20px; font-weight: 700; line-height: 1; color: white; }
        .session-item__month { font-size: 11px; color: rgba(255,255,255,0.5); }
        .session-item__info { flex: 1; }
        .session-item__name { font-weight: 600; color: white; }
        .session-item__time { font-size: 12px; color: rgba(255,255,255,0.5); }
        .session-item__live { padding: 4px 10px; border-radius: 6px; font-size: 11px; font-weight: 600; background: rgba(34,197,94,0.2); color: #22c55e; }
        .session-item__start { width: 36px; height: 36px; display: flex; align-items: center; justify-content: center; background: rgba(34,197,94,0.15); border: none; border-radius: 8px; color: #22c55e; cursor: pointer; }
        .session-item__start:hover:not(:disabled) { background: rgba(34,197,94,0.25); }
        .session-item__start:disabled { opacity: 0.3; cursor: not-allowed; }
        .session-item__start svg { width: 16px; height: 16px; }
        
        /* Transfer */
        .transfer-box { display: flex; gap: 10px; padding: 16px; background: rgba(139,92,246,0.05); border: 1px solid rgba(139,92,246,0.15); border-radius: 10px; }
        .transfer-box select { flex: 1; padding: 10px; background: rgba(0,0,0,0.3); border: 1px solid rgba(255,255,255,0.1); border-radius: 8px; color: white; font-size: 14px; }
        .transfer-box select option { background: #1a1a1a; }
        .transfer-box button { padding: 10px 20px; background: rgba(139,92,246,0.2); border: none; border-radius: 8px; color: #a78bfa; font-weight: 600; cursor: pointer; }
        .transfer-box button:disabled { opacity: 0.4; cursor: not-allowed; }
        
        /* Danger Zone */
        .danger-section { background: rgba(255,70,85,0.03); border-color: rgba(255,70,85,0.15); }
        .danger-item { display: flex; align-items: center; justify-content: space-between; gap: 16px; padding: 16px; background: rgba(255,70,85,0.05); border: 1px solid rgba(255,70,85,0.1); border-radius: 10px; margin-bottom: 12px; }
        .danger-item:last-child { margin-bottom: 0; }
        .danger-item__info h4 { margin: 0 0 4px 0; color: white; font-size: 15px; }
        .danger-item__info p { margin: 0; font-size: 13px; color: rgba(255,255,255,0.5); }
        .danger-btn { padding: 10px 20px; border: none; border-radius: 8px; font-weight: 600; cursor: pointer; }
        .danger-btn--warning { background: rgba(255,200,0,0.15); color: #ffc800; }
        .danger-btn--danger { background: rgba(255,70,85,0.15); color: var(--accent); }
        
        /* Empty & Loading */
        .empty { text-align: center; padding: 30px 20px; color: rgba(255,255,255,0.4); }
        .spinner { width: 24px; height: 24px; border: 2px solid rgba(255,255,255,0.1); border-top-color: var(--accent); border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto 12px; }
        @keyframes spin { to { transform: rotate(360deg); } }
        
        /* Create Link */
        .create-link { display: flex; align-items: center; justify-content: center; gap: 8px; padding: 14px; background: rgba(255,255,255,0.03); border: 1px dashed rgba(255,255,255,0.15); border-radius: 10px; color: rgba(255,255,255,0.6); text-decoration: none; margin-top: 12px; }
        .create-link:hover { background: rgba(255,255,255,0.06); color: white; }
        .create-link svg { width: 18px; height: 18px; }
        
        /* Access Denied */
        .access-denied { display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 60vh; text-align: center; padding: 40px; }
        .access-denied svg { width: 64px; height: 64px; color: rgba(255,255,255,0.2); margin-bottom: 20px; }
        .access-denied h2 { margin: 0 0 8px 0; color: white; }
        .access-denied p { color: rgba(255,255,255,0.5); margin: 0 0 24px 0; }
        .access-denied a { padding: 12px 24px; background: var(--accent); border-radius: 8px; color: white; text-decoration: none; font-weight: 600; }
        
        /* Mobile */
        @media (max-width: 600px) {
            .gm-tab { min-width: 55px; padding: 10px 8px; font-size: 11px; }
            .stats-grid { grid-template-columns: repeat(2, 1fr); }
            .char-grid { grid-template-columns: 1fr; }
            .transfer-box, .danger-item { flex-direction: column; align-items: stretch; }
            .session-timer { flex-wrap: wrap; }
            .session-timer__time { width: 100%; text-align: center; margin-top: 8px; }
        }
    </style>
</head>
<body>
    <div class="app">
        <main class="main">
            <div class="main__content">
                
                <div class="gm" id="gmContent">
                    
                    <!-- Header -->
                    <div class="gm-header">
                        <div class="gm-header__icon">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/></svg>
                        </div>
                        <div class="gm-header__info">
                            <h1 class="gm-header__title">GM Kontrollzentrum</h1>
                            <p class="gm-header__room">Raum: <code id="roomCodeDisplay" onclick="GM.copyCode()">---</code></p>
                        </div>
                    </div>
                    
                    <!-- Tabs -->
                    <div class="gm-tabs">
                        <button class="gm-tab gm-tab--active" data-tab="overview">√úbersicht</button>
                        <button class="gm-tab" data-tab="players">Spieler</button>
                        <button class="gm-tab" data-tab="logs">Logs</button>
                        <button class="gm-tab" data-tab="sessions">Sessions</button>
                        <button class="gm-tab" data-tab="tools">Tools</button>
                        <button class="gm-tab" data-tab="settings">‚öôÔ∏è</button>
                    </div>
                    
                    <!-- ==================== √úBERSICHT ==================== -->
                    <div class="gm-content gm-content--active" id="tab-overview">
                        
                        <!-- Session Timer -->
                        <div class="session-timer" id="sessionTimer" style="display:none;">
                            <div class="session-timer__pulse"></div>
                            <div class="session-timer__info">
                                <div class="session-timer__label">LIVE SESSION</div>
                                <div class="session-timer__name" id="timerName">-</div>
                            </div>
                            <div class="session-timer__time" id="timerDisplay">00:00:00</div>
                            <button class="session-timer__stop" onclick="GM.stopSession()">Beenden</button>
                        </div>
                        
                        <!-- Stats -->
                        <div class="gm-section">
                            <div class="gm-section__title">üìä Statistiken</div>
                            <div class="stats-grid">
                                <div class="stat-card">
                                    <div class="stat-card__value stat-card__value--green" id="statOnline">0</div>
                                    <div class="stat-card__label">Online</div>
                                </div>
                                <div class="stat-card">
                                    <div class="stat-card__value" id="statPlayers">0</div>
                                    <div class="stat-card__label">Spieler</div>
                                </div>
                                <div class="stat-card">
                                    <div class="stat-card__value stat-card__value--purple" id="statChars">0</div>
                                    <div class="stat-card__label">Charaktere</div>
                                </div>
                                <div class="stat-card">
                                    <div class="stat-card__value stat-card__value--orange" id="statDice">0</div>
                                    <div class="stat-card__label">W√ºrfe heute</div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Quick Actions -->
                        <div class="gm-section">
                            <div class="gm-section__title">‚ö° Schnellzugriff</div>
                            <div class="quick-actions">
                                <a href="dice.html" class="quick-action">
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="2" y="2" width="20" height="20" rx="2"/><circle cx="8" cy="8" r="1.5" fill="currentColor"/><circle cx="16" cy="16" r="1.5" fill="currentColor"/></svg>
                                    W√ºrfeln
                                </a>
                                <a href="chat.html" class="quick-action">
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/></svg>
                                    Chat
                                </a>
                                <a href="map.html" class="quick-action">
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polygon points="1 6 1 22 8 18 16 22 23 18 23 2 16 6 8 2 1 6"/></svg>
                                    Karte
                                </a>
                                <a href="notes.html" class="quick-action">
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/></svg>
                                    Notizen
                                </a>
                            </div>
                        </div>
                        
                    </div>
                    
                    <!-- ==================== SPIELER ==================== -->
                    <div class="gm-content" id="tab-players">
                        
                        <!-- Charakter-√úbersicht mit HP -->
                        <div class="gm-section">
                            <div class="gm-section__title">üé≠ Charaktere & HP</div>
                            <div class="char-grid" id="charGrid">
                                <div class="empty"><div class="spinner"></div><p>Lade Charaktere...</p></div>
                            </div>
                        </div>
                        
                        <!-- GM Transfer -->
                        <div class="gm-section">
                            <div class="gm-section__title">üëë GM √ºbertragen</div>
                            <div class="transfer-box">
                                <select id="transferSelect"><option value="">Spieler w√§hlen...</option></select>
                                <button id="transferBtn" onclick="GM.transferGM()" disabled>√úbertragen</button>
                            </div>
                        </div>
                        
                    </div>
                    
                    <!-- ==================== LOGS ==================== -->
                    <div class="gm-content" id="tab-logs">
                        
                        <!-- W√ºrfel-Log -->
                        <div class="gm-section">
                            <div class="gm-section__title">üé≤ W√ºrfel-Log</div>
                            <div class="log-list" id="diceLog">
                                <div class="empty"><p>Noch keine W√ºrfe</p></div>
                            </div>
                        </div>
                        
                        <!-- Chat-Log -->
                        <div class="gm-section">
                            <div class="gm-section__title">üí¨ Chat-Log</div>
                            <div class="log-list" id="chatLog">
                                <div class="empty"><p>Noch keine Nachrichten</p></div>
                            </div>
                        </div>
                        
                        <!-- Anwesenheits-Log -->
                        <div class="gm-section">
                            <div class="gm-section__title">üö™ Anwesenheits-Log</div>
                            <div class="log-list" id="presenceLog">
                                <div class="empty"><p>Keine Aktivit√§t</p></div>
                            </div>
                        </div>
                        
                        <!-- Charakterbogen-Log -->
                        <div class="gm-section">
                            <div class="gm-section__title">üìù Charakterbogen-√Ñnderungen</div>
                            <div class="log-list" id="changeLog">
                                <div class="empty"><p>Keine √Ñnderungen<br><small style="opacity:0.6">Braucht Charakterbogen-Update f√ºr Logging</small></p></div>
                            </div>
                        </div>
                        
                    </div>
                    
                    <!-- ==================== SESSIONS ==================== -->
                    <div class="gm-content" id="tab-sessions">
                        
                        <div class="gm-section">
                            <div class="gm-section__title">üìÖ Sessions</div>
                            <div class="session-list" id="sessionList">
                                <div class="empty"><div class="spinner"></div><p>Lade Sessions...</p></div>
                            </div>
                            <a href="sessions.html?create=true" class="create-link">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
                                Neue Session
                            </a>
                        </div>
                        
                    </div>
                    
                    <!-- ==================== TOOLS ==================== -->
                    <div class="gm-content" id="tab-tools">
                        
                        <!-- Broadcast -->
                        <div class="gm-section">
                            <div class="gm-section__title">üì¢ Broadcast</div>
                            <div class="broadcast-box">
                                <textarea id="broadcastInput" placeholder="Nachricht an alle Spieler..."></textarea>
                                <div class="broadcast-actions">
                                    <label class="broadcast-check"><input type="checkbox" id="broadcastSound"> üîî Mit Sound</label>
                                    <button class="broadcast-btn" onclick="GM.sendBroadcast()">
                                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="22" y1="2" x2="11" y2="13"/><polygon points="22 2 15 22 11 13 2 9 22 2"/></svg>
                                        Senden
                                    </button>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Quick-Poll -->
                        <div class="gm-section">
                            <div class="gm-section__title">üìä Quick-Poll</div>
                            
                            <!-- Active Poll -->
                            <div class="poll-active" id="pollActive" style="display:none;">
                                <div class="poll-active__header">
                                    <div>
                                        <div class="poll-active__label">AKTIVE UMFRAGE</div>
                                        <div class="poll-active__question" id="pollQuestion">-</div>
                                    </div>
                                    <div class="poll-active__actions">
                                        <button class="poll-active__resolve" onclick="GM.resolvePoll()">üèÜ Aufl√∂sen</button>
                                        <button class="poll-active__close" onclick="GM.closePoll()">‚úï</button>
                                    </div>
                                </div>
                                <div id="pollActiveImage" style="display:none; margin-bottom: 12px;">
                                    <img src="" alt="Poll Image" style="width:100%; border-radius:8px;">
                                </div>
                                <div class="poll-results" id="pollResults"></div>
                            </div>
                            
                            <!-- Create Poll -->
                            <div class="poll-create" id="pollCreate">
                                <input type="text" id="pollInput" placeholder="Frage eingeben...">
                                <div class="poll-types">
                                    <label><input type="radio" name="pollType" value="yesno" checked onchange="GM.toggleCustomOptions()"> Ja / Nein</label>
                                    <label><input type="radio" name="pollType" value="abc" onchange="GM.toggleCustomOptions()"> A / B / C</label>
                                    <label><input type="radio" name="pollType" value="numbers" onchange="GM.toggleCustomOptions()"> 1-5</label>
                                    <label><input type="radio" name="pollType" value="custom" onchange="GM.toggleCustomOptions()"> ‚úèÔ∏è Custom</label>
                                </div>
                                
                                <!-- Sound Toggle -->
                                <div class="poll-settings">
                                    <label><input type="checkbox" id="pollSound" checked> üîî Mit Sound</label>
                                </div>
                                
                                <!-- Custom Options -->
                                <div class="poll-custom" id="pollCustomOptions" style="display:none;">
                                    
                                    <!-- Image Upload -->
                                    <div class="poll-image-upload">
                                        <span class="poll-image-upload__label">Bild (optional, 350√ó160)</span>
                                        <div class="poll-image-upload__area" id="pollImageArea" onclick="document.getElementById('pollImageInput').click()">
                                            <div class="poll-image-upload__placeholder" id="pollImagePlaceholder">
                                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><rect x="3" y="3" width="18" height="18" rx="2"/><circle cx="8.5" cy="8.5" r="1.5"/><path d="M21 15l-5-5L5 21"/></svg>
                                                <span>Klicken zum Hochladen</span>
                                            </div>
                                            <img id="pollImagePreview" class="poll-image-upload__preview" style="display:none;">
                                            <button type="button" class="poll-image-upload__remove" id="pollImageRemove" style="display:none;" onclick="event.stopPropagation(); GM.removePollImage()">‚úï</button>
                                        </div>
                                        <input type="file" id="pollImageInput" accept="image/*" onchange="GM.handlePollImage(event)">
                                    </div>
                                    
                                    <!-- Options Container -->
                                    <div id="pollOptionsContainer">
                                        <!-- Option 1 -->
                                        <div class="poll-option-row" data-index="0">
                                            <div class="poll-option-row__emoji">
                                                <button type="button" class="poll-option-row__emoji-btn" onclick="GM.toggleEmojiPicker(0)">‚ûä</button>
                                                <div class="emoji-picker" id="emojiPicker0"></div>
                                            </div>
                                            <input type="text" class="poll-option-row__input" placeholder="Option 1" data-option="0">
                                        </div>
                                        <!-- Option 2 -->
                                        <div class="poll-option-row" data-index="1">
                                            <div class="poll-option-row__emoji">
                                                <button type="button" class="poll-option-row__emoji-btn" onclick="GM.toggleEmojiPicker(1)">‚ûã</button>
                                                <div class="emoji-picker" id="emojiPicker1"></div>
                                            </div>
                                            <input type="text" class="poll-option-row__input" placeholder="Option 2" data-option="1">
                                        </div>
                                    </div>
                                    
                                    <!-- Add Option Button -->
                                    <button type="button" class="poll-add-option" id="pollAddOption" onclick="GM.addPollOption()">
                                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
                                        Option hinzuf√ºgen
                                    </button>
                                </div>
                                
                                <button class="poll-btn" onclick="GM.startPoll()">Poll starten</button>
                            </div>
                        </div>
                        
                        <!-- GM Notizen -->
                        <div class="gm-section">
                            <div class="gm-section__title">üìù GM Notizen</div>
                            <div class="notes-box">
                                <textarea id="gmNotes" placeholder="Geheime Plot-Twists, NPC-Geheimnisse..."></textarea>
                                <span class="notes-box__status" id="notesStatus"></span>
                            </div>
                        </div>
                        
                    </div>
                    
                    <!-- ==================== SETTINGS ==================== -->
                    <div class="gm-content" id="tab-settings">
                        
                        <div class="gm-section danger-section">
                            <div class="gm-section__title" style="color:var(--accent);">‚ö†Ô∏è Gefahrenzone</div>
                            <div class="danger-item">
                                <div class="danger-item__info">
                                    <h4>Raum verlassen</h4>
                                    <p>Du verlierst deine GM-Rechte.</p>
                                </div>
                                <button class="danger-btn danger-btn--warning" onclick="GM.leaveRoom()">Verlassen</button>
                            </div>
                            <div class="danger-item">
                                <div class="danger-item__info">
                                    <h4>Raum l√∂schen</h4>
                                    <p>Alle Daten werden gel√∂scht.</p>
                                </div>
                                <button class="danger-btn danger-btn--danger" onclick="GM.deleteRoom()">L√∂schen</button>
                            </div>
                        </div>
                        
                    </div>
                    
                </div>
                
                <!-- Access Denied -->
                <div class="access-denied" id="accessDenied" style="display:none;">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><rect x="3" y="11" width="18" height="11" rx="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/></svg>
                    <h2>Zugriff verweigert</h2>
                    <p>Nur f√ºr den GM zug√§nglich.</p>
                    <a href="index.html">Zur√ºck</a>
                </div>
                
            </div>
        </main>
    </div>
    
    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    <script src="assets/js/firebase-config.js"></script>
    <script src="assets/js/app.js"></script>
    <script src="assets/js/room-service.js"></script>
    <script src="assets/js/layout.js"></script>
    
    <script>
        const GM = {
            roomCode: null,
            db: null,
            unsubs: [],
            members: [],
            characters: [],
            liveSession: null,
            timerInterval: null,
            presenceLog: [],
            
            // ============ INIT ============
            async init() {
                this.roomCode = localStorage.getItem('rift_current_room');
                if (!this.roomCode) return;
                
                document.getElementById('roomCodeDisplay').textContent = this.roomCode.replace(/(.{3})(.{3})/, '$1-$2');
                this.setupTabs();
                this.setupEvents();
                
                await this.waitForFirebase();
                this.db = RIFT.firebase.getFirestore();
                
                this.subMembers();
                this.subSessions();
                this.subCharacters();
                this.subDice();
                this.subChat();
                this.subPoll();
                this.subChangelog();
                this.loadNotes();
            },
            
            waitForFirebase(t=8000) {
                return new Promise(r => {
                    const s = Date.now();
                    const c = () => RIFT?.firebase?.getFirestore?.() ? r(true) : Date.now()-s>t ? r(false) : setTimeout(c,100);
                    c();
                });
            },
            
            ref() { 
                const code = this.roomCode.replace('-','').toUpperCase();
                console.log('[GM] ref() using room code:', code);
                return this.db.collection('rooms').doc(code); 
            },
            
            // ============ TABS ============
            setupTabs() {
                document.querySelectorAll('.gm-tab').forEach(tab => {
                    tab.addEventListener('click', () => {
                        document.querySelectorAll('.gm-tab').forEach(t => t.classList.remove('gm-tab--active'));
                        tab.classList.add('gm-tab--active');
                        document.querySelectorAll('.gm-content').forEach(c => c.classList.remove('gm-content--active'));
                        document.getElementById('tab-' + tab.dataset.tab)?.classList.add('gm-content--active');
                    });
                });
            },
            
            setupEvents() {
                document.getElementById('transferSelect')?.addEventListener('change', e => {
                    document.getElementById('transferBtn').disabled = !e.target.value;
                });
                document.getElementById('broadcastInput')?.addEventListener('keydown', e => {
                    if (e.key === 'Enter' && e.ctrlKey) this.sendBroadcast();
                });
                document.getElementById('pollInput')?.addEventListener('keydown', e => {
                    if (e.key === 'Enter') this.startPoll();
                });
                let nt;
                document.getElementById('gmNotes')?.addEventListener('input', () => {
                    clearTimeout(nt);
                    document.getElementById('notesStatus').textContent = 'Speichert...';
                    document.getElementById('notesStatus').className = 'notes-box__status notes-box__status--saving';
                    nt = setTimeout(() => this.saveNotes(), 800);
                });
            },
            
            // ============ MEMBERS ============
            subMembers() {
                console.log('[GM] Subscribing to members for room:', this.roomCode);
                const u = RIFT.rooms.subscribeToMembers(this.roomCode, m => {
                    console.log('[GM] Members received:', m.length, m);
                    // Track presence changes
                    m.forEach(mem => {
                        const old = this.members.find(o => o.id === mem.id);
                        if (!old) {
                            this.addPresence(mem.displayName || mem.name || '?', 'join');
                        } else if (old.online !== mem.online) {
                            this.addPresence(mem.displayName || mem.name || '?', mem.online ? 'join' : 'leave');
                        }
                    });
                    this.members.forEach(old => {
                        if (!m.find(n => n.id === old.id)) {
                            this.addPresence(old.displayName || old.name || '?', 'leave');
                        }
                    });
                    
                    this.members = m;
                    this.updateTransfer();
                    document.getElementById('statOnline').textContent = m.filter(x => x.online).length;
                    document.getElementById('statPlayers').textContent = m.length;
                });
                this.unsubs.push(u);
            },
            
            updateTransfer() {
                const s = document.getElementById('transferSelect');
                const uid = firebase?.auth()?.currentUser?.uid;
                const list = this.members.filter(m => m.role !== 'gm' && m.id !== uid);
                s.innerHTML = '<option value="">Spieler w√§hlen...</option>' + list.map(m => `<option value="${m.id}">${m.displayName || m.name || '?'}</option>`).join('');
            },
            
            async transferGM() {
                const s = document.getElementById('transferSelect');
                if (!s.value || !confirm('GM √ºbertragen?')) return;
                try {
                    const uid = firebase.auth().currentUser?.uid;
                    await this.ref().collection('members').doc(s.value).update({ role: 'gm' });
                    await this.ref().collection('members').doc(uid).update({ role: 'player' });
                    await this.ref().update({ gmId: s.value });
                    this.toast('GM √ºbertragen!', 'success');
                    setTimeout(() => location.href = 'index.html', 1500);
                } catch (e) { this.toast('Fehler', 'error'); }
            },
            
            // ============ CHARACTERS ============
            subCharacters() {
                console.log('[GM] Subscribing to characters for room:', this.roomCode);
                const u = this.ref().collection('characters').onSnapshot(snap => {
                    console.log('[GM] Characters received:', snap.docs.length);
                    this.characters = snap.docs.map(d => {
                        const data = { id: d.id, ...d.data() };
                        console.log('[GM] Character:', data);
                        return data;
                    });
                    this.renderChars();
                    document.getElementById('statChars').textContent = this.characters.length;
                }, (err) => {
                    console.error('[GM] Characters error:', err);
                });
                this.unsubs.push(u);
            },
            
            renderChars() {
                const g = document.getElementById('charGrid');
                if (!this.characters.length) { g.innerHTML = '<div class="empty"><p>Keine Charaktere</p></div>'; return; }
                
                g.innerHTML = this.characters.map(c => {
                    const name = c.name || c.characterName || 'Unbenannt';
                    const cls = c.class || c.characterClass || c.klasse || '-';
                    const lvl = c.level || c.stufe || '-';
                    const color = c.color || '#8b5cf6';
                    const hp = c.hp ?? c.currentHP ?? c.currentHp ?? 0;
                    const max = (c.maxHp ?? c.maxHP ?? c.hpMax ?? hp) || 1;
                    const pct = Math.round((hp / max) * 100);
                    const hpClass = pct > 50 ? 'high' : pct > 25 ? 'mid' : 'low';
                    const owner = this.members.find(m => m.id === c.owner || m.id === c.userId);
                    const online = owner?.online === true;
                    
                    return `<div class="char-card">
                        <div class="char-card__header">
                            <div class="char-card__avatar" style="background:${color}">${name[0].toUpperCase()}</div>
                            <div class="char-card__info">
                                <div class="char-card__name">${name}</div>
                                <div class="char-card__meta">${cls} Lvl ${lvl}</div>
                            </div>
                            <div class="char-card__online ${online ? '' : 'char-card__online--offline'}"></div>
                        </div>
                        <div class="hp-section">
                            <div class="hp-header"><span class="hp-header__label">HP</span><span class="hp-header__value">${hp} / ${max}</span></div>
                            <div class="hp-bar"><div class="hp-bar__fill hp-bar__fill--${hpClass}" style="width:${pct}%"></div></div>
                            <div class="hp-controls">
                                <input type="number" id="hp-${c.id}" value="5" min="1" max="999">
                                <button class="hp-btn hp-btn--dmg" onclick="GM.modHP('${c.id}',-1)">‚àíDmg</button>
                                <button class="hp-btn hp-btn--heal" onclick="GM.modHP('${c.id}',1)">+Heal</button>
                            </div>
                        </div>
                    </div>`;
                }).join('');
            },
            
            async modHP(id, dir) {
                const input = document.getElementById('hp-' + id);
                const amt = parseInt(input.value) || 0;
                const c = this.characters.find(x => x.id === id);
                if (!c) return;
                const hp = c.hp ?? c.currentHP ?? c.currentHp ?? 0;
                const max = c.maxHp ?? c.maxHP ?? c.hpMax ?? 100;
                const newHP = Math.max(0, Math.min(max, hp + (amt * dir)));
                try {
                    await this.ref().collection('characters').doc(id).update({ hp: newHP, currentHP: newHP, currentHp: newHP });
                } catch (e) { this.toast('Fehler', 'error'); }
            },
            
            // ============ SESSIONS ============
            subSessions() {
                const u = RIFT.rooms.subscribeToSessions(this.roomCode, s => {
                    this.renderSessions(s);
                    const live = s.find(x => x.status === 'live');
                    this.updateTimer(live);
                });
                this.unsubs.push(u);
            },
            
            renderSessions(sessions) {
                const l = document.getElementById('sessionList');
                if (!sessions.length) { l.innerHTML = '<div class="empty"><p>Keine Sessions</p></div>'; return; }
                const sorted = [...sessions].sort((a,b) => new Date(a.date) - new Date(b.date));
                const mon = ['Jan','Feb','M√§r','Apr','Mai','Jun','Jul','Aug','Sep','Okt','Nov','Dez'];
                const hasLive = sessions.some(s => s.status === 'live');
                
                l.innerHTML = sorted.map(s => {
                    const d = new Date(s.date);
                    const live = s.status === 'live';
                    return `<div class="session-item">
                        <div class="session-item__date"><span class="session-item__day">${d.getDate()}</span><span class="session-item__month">${mon[d.getMonth()]}</span></div>
                        <div class="session-item__info"><div class="session-item__name">${s.name || 'Session'}</div><div class="session-item__time">${s.time || '20:00'} Uhr</div></div>
                        ${live ? '<span class="session-item__live">Live</span>' : `<button class="session-item__start" onclick="GM.startSession('${s.id}','${(s.name||'').replace(/'/g,"\\'")}')" ${hasLive?'disabled':''}><svg viewBox="0 0 24 24" fill="currentColor"><polygon points="5 3 19 12 5 21"/></svg></button>`}
                    </div>`;
                }).join('');
            },
            
            updateTimer(live) {
                const t = document.getElementById('sessionTimer');
                if (live) {
                    this.liveSession = live;
                    t.style.display = 'flex';
                    document.getElementById('timerName').textContent = live.name || 'Session';
                    if (this.timerInterval) clearInterval(this.timerInterval);
                    const start = live.startedAt?.toDate?.() || new Date(live.startedAt) || new Date();
                    this.timerInterval = setInterval(() => {
                        const diff = Math.floor((Date.now() - start.getTime()) / 1000);
                        const h = Math.floor(diff/3600).toString().padStart(2,'0');
                        const m = Math.floor((diff%3600)/60).toString().padStart(2,'0');
                        const s = (diff%60).toString().padStart(2,'0');
                        document.getElementById('timerDisplay').textContent = `${h}:${m}:${s}`;
                    }, 1000);
                } else {
                    t.style.display = 'none';
                    this.liveSession = null;
                    if (this.timerInterval) clearInterval(this.timerInterval);
                }
            },
            
            async startSession(id, name) {
                try {
                    await this.ref().collection('sessions').doc(id).update({ status: 'live', startedAt: firebase.firestore.FieldValue.serverTimestamp() });
                    await this.ref().update({ activeSession: id });
                    this.toast(`"${name}" gestartet!`, 'success');
                } catch (e) { this.toast('Fehler', 'error'); }
            },
            
            async stopSession() {
                if (!this.liveSession || !confirm('Session beenden?')) return;
                try {
                    await this.ref().collection('sessions').doc(this.liveSession.id).update({ status: 'completed', endedAt: firebase.firestore.FieldValue.serverTimestamp() });
                    await this.ref().update({ activeSession: null });
                    this.toast('Session beendet', 'success');
                } catch (e) { this.toast('Fehler', 'error'); }
            },
            
            // ============ DICE LOG ============
            subDice() {
                const today = new Date(); today.setHours(0,0,0,0);
                const u = this.ref().collection('dice').orderBy('timestamp','desc').limit(30).onSnapshot(snap => {
                    const rolls = snap.docs.map(d => d.data());
                    this.renderDice(rolls);
                    document.getElementById('statDice').textContent = rolls.filter(r => r.timestamp?.toDate?.() >= today).length;
                }, () => {});
                this.unsubs.push(u);
            },
            
            renderDice(rolls) {
                const el = document.getElementById('diceLog');
                if (!rolls.length) { el.innerHTML = '<div class="empty"><p>Noch keine W√ºrfe</p></div>'; return; }
                el.innerHTML = rolls.map(r => {
                    const t = r.timestamp?.toDate?.() || new Date();
                    return `<div class="log-item">
                        <span class="log-item__time">${t.toLocaleTimeString('de-DE',{hour:'2-digit',minute:'2-digit'})}</span>
                        <div class="log-item__icon log-item__icon--dice">üé≤</div>
                        <div class="log-item__content">
                            <span class="log-item__user">${r.userName || r.user || '?'}</span> w√ºrfelt ${r.diceType || r.dice || '?'}:
                            <span class="log-item__result">${r.result ?? r.total ?? '?'}</span>
                        </div>
                    </div>`;
                }).join('');
            },
            
            // ============ CHAT LOG ============
            subChat() {
                const u = this.ref().collection('chat').orderBy('timestamp','desc').limit(30).onSnapshot(snap => {
                    const msgs = snap.docs.map(d => d.data());
                    this.renderChat(msgs);
                }, () => {});
                this.unsubs.push(u);
            },
            
            renderChat(msgs) {
                const el = document.getElementById('chatLog');
                if (!msgs.length) { el.innerHTML = '<div class="empty"><p>Noch keine Nachrichten</p></div>'; return; }
                el.innerHTML = msgs.map(m => {
                    const t = m.timestamp?.toDate?.() || new Date();
                    const txt = (m.message || m.text || '').substring(0, 80);
                    return `<div class="log-item">
                        <span class="log-item__time">${t.toLocaleTimeString('de-DE',{hour:'2-digit',minute:'2-digit'})}</span>
                        <div class="log-item__icon log-item__icon--chat">üí¨</div>
                        <div class="log-item__content">
                            <span class="log-item__user">${m.userName || m.user || '?'}</span>: ${txt}${txt.length >= 80 ? '...' : ''}
                        </div>
                    </div>`;
                }).join('');
            },
            
            // ============ PRESENCE LOG ============
            addPresence(name, type) {
                this.presenceLog.unshift({ name, type, time: new Date() });
                if (this.presenceLog.length > 50) this.presenceLog.pop();
                this.renderPresence();
            },
            
            renderPresence() {
                const el = document.getElementById('presenceLog');
                if (!this.presenceLog.length) { el.innerHTML = '<div class="empty"><p>Keine Aktivit√§t</p></div>'; return; }
                el.innerHTML = this.presenceLog.map(p => {
                    const isJoin = p.type === 'join';
                    return `<div class="log-item">
                        <span class="log-item__time">${p.time.toLocaleTimeString('de-DE',{hour:'2-digit',minute:'2-digit'})}</span>
                        <div class="log-item__icon log-item__icon--${isJoin ? 'join' : 'leave'}">${isJoin ? '‚Üí' : '‚Üê'}</div>
                        <div class="log-item__content">
                            <span class="log-item__user">${p.name}</span> ist ${isJoin ? 'beigetreten' : 'gegangen'}
                        </div>
                    </div>`;
                }).join('');
            },
            
            // ============ CHANGELOG ============
            subChangelog() {
                const u = this.ref().collection('changelog').orderBy('timestamp','desc').limit(30).onSnapshot(snap => {
                    const changes = snap.docs.map(d => d.data());
                    this.renderChangelog(changes);
                }, () => {});
                this.unsubs.push(u);
            },
            
            renderChangelog(changes) {
                const el = document.getElementById('changeLog');
                if (!changes.length) { el.innerHTML = '<div class="empty"><p>Keine √Ñnderungen<br><small style="opacity:0.6">Braucht Charakterbogen-Update</small></p></div>'; return; }
                el.innerHTML = changes.map(c => {
                    const t = c.timestamp?.toDate?.() || new Date();
                    return `<div class="log-item">
                        <span class="log-item__time">${t.toLocaleTimeString('de-DE',{hour:'2-digit',minute:'2-digit'})}</span>
                        <div class="log-item__icon log-item__icon--edit">‚úèÔ∏è</div>
                        <div class="log-item__content">
                            <span class="log-item__user">${c.playerName || '?'}</span> √§nderte <strong>${c.field}</strong>: ${c.oldValue || '-'} ‚Üí ${c.newValue || '-'}
                            <br><small style="opacity:0.5">${c.characterName || ''}</small>
                        </div>
                    </div>`;
                }).join('');
            },
            
            // ============ BROADCAST ============
            async sendBroadcast() {
                const msg = document.getElementById('broadcastInput').value.trim();
                if (!msg) { this.toast('Nachricht eingeben!', 'error'); return; }
                try {
                    await this.ref().update({
                        broadcast: { message: msg, withSound: document.getElementById('broadcastSound').checked, timestamp: firebase.firestore.FieldValue.serverTimestamp(), id: Date.now() }
                    });
                    document.getElementById('broadcastInput').value = '';
                    this.toast('Gesendet!', 'success');
                } catch (e) { this.toast('Fehler', 'error'); }
            },
            
            // ============ POLL ============
            pollEmojis: ['‚ûä','‚ûã','‚ûå','‚ûç','‚ûé','‚ûè','‚ûê','‚ûë','üÖ∞Ô∏è','üÖ±Ô∏è','‚úÖ','‚ùå','üëç','üëé','‚ù§Ô∏è','‚≠ê','üî•','üíé','üéØ','üé≤','‚öîÔ∏è','üõ°Ô∏è','üíÄ','üëë','üó°Ô∏è','üèÜ','üí∞','üé≠','üßô','üêâ','üè∞','üìú','‚ö°','üåü','üí´','üîÆ'],
            pollImageData: null,
            pollOptionCount: 2,
            
            subPoll() {
                // Subscribe to room for poll config
                const u = this.ref().onSnapshot(doc => {
                    const poll = doc.data()?.poll;
                    if (poll?.active) {
                        document.getElementById('pollActive').style.display = 'block';
                        document.getElementById('pollCreate').style.display = 'none';
                        document.getElementById('pollQuestion').textContent = poll.question;
                        
                        // Show image if present
                        const imgContainer = document.getElementById('pollActiveImage');
                        if (poll.image) {
                            imgContainer.style.display = 'block';
                            imgContainer.querySelector('img').src = poll.image;
                        } else {
                            imgContainer.style.display = 'none';
                        }
                        
                        this.currentPoll = poll;
                        this.updatePollResults();
                    } else {
                        document.getElementById('pollActive').style.display = 'none';
                        document.getElementById('pollCreate').style.display = 'flex';
                        this.currentPoll = null;
                    }
                });
                this.unsubs.push(u);
                
                // Subscribe to poll_votes subcollection
                const v = this.ref().collection('poll_votes').onSnapshot(snap => {
                    this.pollVotes = snap.docs.map(d => d.data());
                    this.updatePollResults();
                });
                this.unsubs.push(v);
            },
            
            updatePollResults() {
                if (!this.currentPoll) return;
                const el = document.getElementById('pollResults');
                const options = this.currentPoll.options || [];
                const emojis = this.currentPoll.emojis || [];
                
                // Count votes from subcollection
                const voteCounts = {};
                options.forEach(opt => voteCounts[opt] = 0);
                (this.pollVotes || []).forEach(vote => {
                    if (vote.option && voteCounts.hasOwnProperty(vote.option)) {
                        voteCounts[vote.option]++;
                    }
                });
                
                const total = Object.values(voteCounts).reduce((a, b) => a + b, 0) || 1;
                
                el.innerHTML = options.map((opt, i) => {
                    const count = voteCounts[opt] || 0;
                    const pct = Math.round((count / total) * 100);
                    const emoji = emojis[i] || '';
                    const label = emoji ? `${emoji} ${opt}` : opt;
                    return `<div class="poll-result">
                        <span class="poll-result__label">${label}</span>
                        <div class="poll-result__bar">
                            <div class="poll-result__fill" style="width:${pct}%"></div>
                            <span class="poll-result__count">${count}</span>
                        </div>
                    </div>`;
                }).join('');
            },
            
            renderPollResults(poll) {
                this.updatePollResults();
            },
            
            toggleCustomOptions() {
                const type = document.querySelector('input[name="pollType"]:checked').value;
                const customBox = document.getElementById('pollCustomOptions');
                customBox.style.display = type === 'custom' ? 'flex' : 'none';
            },
            
            // Emoji Picker
            toggleEmojiPicker(index) {
                // Close all other pickers
                document.querySelectorAll('.emoji-picker').forEach(p => p.classList.remove('visible'));
                
                const picker = document.getElementById('emojiPicker' + index);
                if (!picker.innerHTML) {
                    // Initialize picker content
                    picker.innerHTML = `<div class="emoji-picker__grid">${this.pollEmojis.map(e => 
                        `<button type="button" class="emoji-picker__btn" onclick="GM.selectEmoji(${index}, '${e}')">${e}</button>`
                    ).join('')}</div>`;
                }
                picker.classList.toggle('visible');
                
                // Close on outside click
                setTimeout(() => {
                    const closeHandler = (e) => {
                        if (!picker.contains(e.target) && !e.target.classList.contains('poll-option-row__emoji-btn')) {
                            picker.classList.remove('visible');
                            document.removeEventListener('click', closeHandler);
                        }
                    };
                    document.addEventListener('click', closeHandler);
                }, 10);
            },
            
            selectEmoji(index, emoji) {
                const btn = document.querySelector(`.poll-option-row[data-index="${index}"] .poll-option-row__emoji-btn`);
                btn.textContent = emoji;
                document.getElementById('emojiPicker' + index).classList.remove('visible');
            },
            
            // Add/Remove Poll Options
            addPollOption() {
                if (this.pollOptionCount >= 8) {
                    this.toast('Maximum 8 Optionen', 'error');
                    return;
                }
                
                const container = document.getElementById('pollOptionsContainer');
                const index = this.pollOptionCount;
                const defaultEmoji = this.pollEmojis[index] || '‚≠ê';
                
                const row = document.createElement('div');
                row.className = 'poll-option-row';
                row.dataset.index = index;
                row.innerHTML = `
                    <div class="poll-option-row__emoji">
                        <button type="button" class="poll-option-row__emoji-btn" onclick="GM.toggleEmojiPicker(${index})">${defaultEmoji}</button>
                        <div class="emoji-picker" id="emojiPicker${index}"></div>
                    </div>
                    <input type="text" class="poll-option-row__input" placeholder="Option ${index + 1}" data-option="${index}">
                    <button type="button" class="poll-option-row__remove" onclick="GM.removePollOption(${index})">
                        <svg viewBox="0 0 24 24" width="18" height="18" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
                    </button>
                `;
                container.appendChild(row);
                this.pollOptionCount++;
                
                // Focus new input
                row.querySelector('input').focus();
            },
            
            removePollOption(index) {
                if (this.pollOptionCount <= 2) {
                    this.toast('Mindestens 2 Optionen', 'error');
                    return;
                }
                
                const row = document.querySelector(`.poll-option-row[data-index="${index}"]`);
                if (row) {
                    row.remove();
                    this.pollOptionCount--;
                }
            },
            
            // Image Upload & Cropper
            handlePollImage(event) {
                const file = event.target.files[0];
                if (!file) return;
                
                if (!file.type.startsWith('image/')) {
                    this.toast('Nur Bilder erlaubt', 'error');
                    return;
                }
                
                const reader = new FileReader();
                reader.onload = (e) => {
                    this.openImageCropper(e.target.result);
                };
                reader.readAsDataURL(file);
            },
            
            openImageCropper(imageSrc) {
                // Create cropper modal
                const modal = document.createElement('div');
                modal.className = 'cropper-modal';
                modal.id = 'cropperModal';
                modal.innerHTML = `
                    <div class="cropper-modal__container">
                        <div class="cropper-modal__header">
                            <span class="cropper-modal__title">Bild zuschneiden (350√ó160)</span>
                            <button class="cropper-modal__close" onclick="GM.closeCropper()">‚úï</button>
                        </div>
                        <div class="cropper-modal__canvas-wrap" id="cropperWrap">
                            <img id="cropperImage" class="cropper-modal__canvas" src="${imageSrc}">
                        </div>
                        <div class="cropper-modal__controls">
                            <span style="font-size:12px;color:rgba(255,255,255,0.5)">Zoom:</span>
                            <input type="range" class="cropper-modal__zoom" id="cropperZoom" min="1" max="3" step="0.05" value="1" oninput="GM.updateCropperZoom(this.value)">
                        </div>
                        <div class="cropper-modal__actions">
                            <button class="cropper-modal__btn cropper-modal__btn--cancel" onclick="GM.closeCropper()">Abbrechen</button>
                            <button class="cropper-modal__btn cropper-modal__btn--apply" onclick="GM.applyCrop()">√úbernehmen</button>
                        </div>
                    </div>
                `;
                document.body.appendChild(modal);
                
                // Wait for image to load
                const img = document.getElementById('cropperImage');
                const wrap = document.getElementById('cropperWrap');
                
                img.onload = () => {
                    const wrapRect = wrap.getBoundingClientRect();
                    const targetRatio = 350 / 160;
                    const imgRatio = img.naturalWidth / img.naturalHeight;
                    
                    let scale;
                    if (imgRatio > targetRatio) {
                        // Image is wider - fit height
                        scale = wrapRect.height / img.naturalHeight;
                    } else {
                        // Image is taller - fit width
                        scale = wrapRect.width / img.naturalWidth;
                    }
                    
                    this.cropperState = {
                        baseScale: scale,
                        zoom: 1,
                        offsetX: 0,
                        offsetY: 0,
                        isDragging: false,
                        startX: 0,
                        startY: 0,
                        imgWidth: img.naturalWidth,
                        imgHeight: img.naturalHeight,
                        wrapWidth: wrapRect.width,
                        wrapHeight: wrapRect.height
                    };
                    
                    // Center image initially
                    const scaledW = img.naturalWidth * scale;
                    const scaledH = img.naturalHeight * scale;
                    this.cropperState.offsetX = (wrapRect.width - scaledW) / 2;
                    this.cropperState.offsetY = (wrapRect.height - scaledH) / 2;
                    
                    this.updateCropperTransform();
                };
                
                // Drag handlers on wrap, not image
                wrap.onmousedown = (e) => {
                    e.preventDefault();
                    this.cropperState.isDragging = true;
                    this.cropperState.startX = e.clientX - this.cropperState.offsetX;
                    this.cropperState.startY = e.clientY - this.cropperState.offsetY;
                };
                
                document.onmousemove = (e) => {
                    if (!this.cropperState?.isDragging) return;
                    this.cropperState.offsetX = e.clientX - this.cropperState.startX;
                    this.cropperState.offsetY = e.clientY - this.cropperState.startY;
                    this.constrainCropper();
                    this.updateCropperTransform();
                };
                
                document.onmouseup = () => {
                    if (this.cropperState) this.cropperState.isDragging = false;
                };
            },
            
            constrainCropper() {
                const s = this.cropperState;
                if (!s) return;
                
                const currentScale = s.baseScale * s.zoom;
                const scaledW = s.imgWidth * currentScale;
                const scaledH = s.imgHeight * currentScale;
                
                // Don't allow image edges inside the wrap
                const maxX = 0;
                const minX = s.wrapWidth - scaledW;
                const maxY = 0;
                const minY = s.wrapHeight - scaledH;
                
                s.offsetX = Math.min(maxX, Math.max(minX, s.offsetX));
                s.offsetY = Math.min(maxY, Math.max(minY, s.offsetY));
            },
            
            updateCropperZoom(value) {
                if (!this.cropperState) return;
                const oldZoom = this.cropperState.zoom;
                this.cropperState.zoom = parseFloat(value);
                
                // Adjust offset to zoom towards center
                const s = this.cropperState;
                const centerX = s.wrapWidth / 2;
                const centerY = s.wrapHeight / 2;
                
                const oldScale = s.baseScale * oldZoom;
                const newScale = s.baseScale * s.zoom;
                
                // Point that was at center before zoom
                const imgCenterX = (centerX - s.offsetX) / oldScale;
                const imgCenterY = (centerY - s.offsetY) / oldScale;
                
                // New offset to keep that point at center
                s.offsetX = centerX - imgCenterX * newScale;
                s.offsetY = centerY - imgCenterY * newScale;
                
                this.constrainCropper();
                this.updateCropperTransform();
            },
            
            updateCropperTransform() {
                const img = document.getElementById('cropperImage');
                const s = this.cropperState;
                if (!img || !s) return;
                
                const scale = s.baseScale * s.zoom;
                img.style.transform = `translate(${s.offsetX}px, ${s.offsetY}px) scale(${scale})`;
            },
            
            closeCropper() {
                const modal = document.getElementById('cropperModal');
                if (modal) modal.remove();
                document.getElementById('pollImageInput').value = '';
                document.onmousemove = null;
                document.onmouseup = null;
                this.cropperState = null;
            },
            
            applyCrop() {
                const img = document.getElementById('cropperImage');
                const s = this.cropperState;
                if (!img || !s) return;
                
                // Create canvas with target dimensions
                const canvas = document.createElement('canvas');
                canvas.width = 350;
                canvas.height = 160;
                const ctx = canvas.getContext('2d');
                
                // Calculate what part of original image is visible
                const scale = s.baseScale * s.zoom;
                const sourceX = -s.offsetX / scale;
                const sourceY = -s.offsetY / scale;
                const sourceW = s.wrapWidth / scale;
                const sourceH = s.wrapHeight / scale;
                
                ctx.drawImage(img, sourceX, sourceY, sourceW, sourceH, 0, 0, 350, 160);
                
                // Get base64
                this.pollImageData = canvas.toDataURL('image/jpeg', 0.85);
                
                // Update preview
                const preview = document.getElementById('pollImagePreview');
                const placeholder = document.getElementById('pollImagePlaceholder');
                const removeBtn = document.getElementById('pollImageRemove');
                const area = document.getElementById('pollImageArea');
                
                preview.src = this.pollImageData;
                preview.style.display = 'block';
                placeholder.style.display = 'none';
                removeBtn.style.display = 'flex';
                area.classList.add('has-image');
                
                this.closeCropper();
                this.toast('Bild zugeschnitten', 'success');
            },
            
            removePollImage() {
                this.pollImageData = null;
                
                const preview = document.getElementById('pollImagePreview');
                const placeholder = document.getElementById('pollImagePlaceholder');
                const removeBtn = document.getElementById('pollImageRemove');
                const area = document.getElementById('pollImageArea');
                
                preview.style.display = 'none';
                placeholder.style.display = 'flex';
                removeBtn.style.display = 'none';
                area.classList.remove('has-image');
                document.getElementById('pollImageInput').value = '';
            },
            
            async startPoll() {
                const q = document.getElementById('pollInput').value.trim();
                if (!q) { this.toast('Frage eingeben!', 'error'); return; }
                
                const type = document.querySelector('input[name="pollType"]:checked').value;
                const withSound = document.getElementById('pollSound').checked;
                
                let options = [];
                let emojis = [];
                
                if (type === 'yesno') {
                    options = ['Ja', 'Nein'];
                    emojis = ['‚úÖ', '‚ùå'];
                }
                else if (type === 'abc') {
                    options = ['A', 'B', 'C'];
                    emojis = ['üÖ∞Ô∏è', 'üÖ±Ô∏è', '¬©Ô∏è'];
                }
                else if (type === 'numbers') {
                    options = ['1', '2', '3', '4', '5'];
                    emojis = ['‚ûä', '‚ûã', '‚ûå', '‚ûç', '‚ûé'];
                }
                else if (type === 'custom') {
                    // Collect custom options
                    const rows = document.querySelectorAll('#pollOptionsContainer .poll-option-row');
                    rows.forEach(row => {
                        const input = row.querySelector('.poll-option-row__input');
                        const emojiBtn = row.querySelector('.poll-option-row__emoji-btn');
                        const text = input.value.trim();
                        if (text) {
                            options.push(text);
                            emojis.push(emojiBtn.textContent);
                        }
                    });
                    
                    if (options.length < 2) {
                        this.toast('Mindestens 2 Optionen!', 'error');
                        return;
                    }
                }
                
                try {
                    // Delete old votes first
                    const votesSnap = await this.ref().collection('poll_votes').get();
                    const batch = this.db.batch();
                    votesSnap.docs.forEach(doc => batch.delete(doc.ref));
                    if (votesSnap.docs.length) await batch.commit();
                    
                    const pollData = { 
                        question: q, 
                        options, 
                        emojis,
                        withSound,
                        votes: {}, 
                        active: true, 
                        timestamp: firebase.firestore.FieldValue.serverTimestamp() 
                    };
                    
                    // Add image if present
                    if (type === 'custom' && this.pollImageData) {
                        pollData.image = this.pollImageData;
                    }
                    
                    await this.ref().update({ poll: pollData });
                    
                    // Reset form
                    document.getElementById('pollInput').value = '';
                    this.resetCustomPollForm();
                    
                    this.toast('Poll gestartet!', 'success');
                } catch (e) { 
                    this.toast('Fehler', 'error'); 
                    console.error(e); 
                }
            },
            
            resetCustomPollForm() {
                // Reset image
                this.removePollImage();
                
                // Reset options to 2
                const container = document.getElementById('pollOptionsContainer');
                container.innerHTML = `
                    <div class="poll-option-row" data-index="0">
                        <div class="poll-option-row__emoji">
                            <button type="button" class="poll-option-row__emoji-btn" onclick="GM.toggleEmojiPicker(0)">‚ûä</button>
                            <div class="emoji-picker" id="emojiPicker0"></div>
                        </div>
                        <input type="text" class="poll-option-row__input" placeholder="Option 1" data-option="0">
                    </div>
                    <div class="poll-option-row" data-index="1">
                        <div class="poll-option-row__emoji">
                            <button type="button" class="poll-option-row__emoji-btn" onclick="GM.toggleEmojiPicker(1)">‚ûã</button>
                            <div class="emoji-picker" id="emojiPicker1"></div>
                        </div>
                        <input type="text" class="poll-option-row__input" placeholder="Option 2" data-option="1">
                    </div>
                `;
                this.pollOptionCount = 2;
            },
            
            async closePoll() {
                try {
                    await this.ref().update({ 'poll.active': false });
                    this.toast('Poll geschlossen', 'success');
                } catch (e) { this.toast('Fehler', 'error'); }
            },
            
            async resolvePoll() {
                if (!this.currentPoll) return;
                
                try {
                    // Calculate results
                    const options = this.currentPoll.options || [];
                    const emojis = this.currentPoll.emojis || [];
                    const voteCounts = {};
                    options.forEach(opt => voteCounts[opt] = 0);
                    (this.pollVotes || []).forEach(vote => {
                        if (vote.option && voteCounts.hasOwnProperty(vote.option)) {
                            voteCounts[vote.option]++;
                        }
                    });
                    
                    // Find winner(s)
                    const maxVotes = Math.max(...Object.values(voteCounts), 0);
                    const winners = options.filter(opt => voteCounts[opt] === maxVotes);
                    
                    // Build results array
                    const results = options.map((opt, i) => ({
                        option: opt,
                        emoji: emojis[i] || '',
                        votes: voteCounts[opt],
                        isWinner: voteCounts[opt] === maxVotes && maxVotes > 0
                    }));
                    
                    // Update poll with resolved state and results
                    await this.ref().update({
                        'poll.active': false,
                        'poll.resolved': true,
                        'poll.results': results,
                        'poll.totalVotes': Object.values(voteCounts).reduce((a, b) => a + b, 0),
                        'poll.resolvedAt': firebase.firestore.FieldValue.serverTimestamp()
                    });
                    
                    this.toast('Poll aufgel√∂st!', 'success');
                } catch (e) { 
                    this.toast('Fehler', 'error'); 
                    console.error(e);
                }
            },
            
            // ============ NOTES ============
            loadNotes() {
                const saved = localStorage.getItem(`rift_gm_notes_${this.roomCode}`);
                if (saved) document.getElementById('gmNotes').value = saved;
            },
            
            saveNotes() {
                localStorage.setItem(`rift_gm_notes_${this.roomCode}`, document.getElementById('gmNotes').value);
                document.getElementById('notesStatus').textContent = '‚úì Gespeichert';
                document.getElementById('notesStatus').className = 'notes-box__status notes-box__status--saved';
                setTimeout(() => document.getElementById('notesStatus').textContent = '', 2000);
            },
            
            // ============ DANGER ZONE ============
            async leaveRoom() {
                if (!confirm('Raum verlassen?')) return;
                try {
                    await this.ref().collection('members').doc(firebase.auth().currentUser?.uid).delete();
                    localStorage.removeItem('rift_current_room');
                    this.toast('Verlassen', 'success');
                    setTimeout(() => location.href = 'login.html', 1000);
                } catch (e) { this.toast('Fehler', 'error'); }
            },
            
            async deleteRoom() {
                if (!confirm('‚ö†Ô∏è Alles l√∂schen?')) return;
                try {
                    const subs = ['members','sessions','characters','chat','dice','notes','whiteboard','markers','changelog'];
                    for (const sub of subs) {
                        const snap = await this.ref().collection(sub).get();
                        const batch = this.db.batch();
                        snap.docs.forEach(d => batch.delete(d.ref));
                        if (snap.docs.length) await batch.commit();
                    }
                    await this.ref().delete();
                    localStorage.removeItem('rift_current_room');
                    this.toast('Gel√∂scht!', 'success');
                    setTimeout(() => location.href = 'login.html', 1500);
                } catch (e) { this.toast('Fehler', 'error'); }
            },
            
            // ============ HELPERS ============
            copyCode() { navigator.clipboard.writeText(this.roomCode).then(() => this.toast('Kopiert!', 'success')); },
            toast(msg, type='info') { window.RIFT?.ui?.Toast?.[type]?.(msg) || console.log(`[${type}] ${msg}`); },
            cleanup() { this.unsubs.forEach(u => u?.()); if (this.timerInterval) clearInterval(this.timerInterval); }
        };
        
        window.addEventListener('beforeunload', () => GM.cleanup());
        
        // ============ ACCESS CHECK ============
        (async function() {
            const gm = document.getElementById('gmContent');
            const denied = document.getElementById('accessDenied');
            const code = localStorage.getItem('rift_current_room');
            const user = JSON.parse(localStorage.getItem('rift_user') || '{}');
            
            function show() { gm.style.display = 'block'; denied.style.display = 'none'; }
            function deny() { gm.style.display = 'none'; denied.style.display = 'flex'; }
            
            try {
                await new Promise((r,j) => {
                    const s = Date.now();
                    const c = () => RIFT?.rooms && RIFT?.firebase?.getFirestore?.() ? r() : Date.now()-s>8000 ? j() : setTimeout(c,100);
                    c();
                });
                await new Promise(r => firebase?.auth()?.currentUser ? r() : firebase.auth().onAuthStateChanged(u => r(u)));
                if (!code) { deny(); return; }
                let isGM = false;
                try { isGM = await RIFT.rooms.isUserGM(code); } catch { isGM = user.isGM === true; }
                if (isGM) { show(); GM.init(); } else { deny(); }
            } catch { if (user.isGM && code) { show(); GM.init(); } else { deny(); } }
        })();
        
        initLayout();
    </script>
</body>
</html>
