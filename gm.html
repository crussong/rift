<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <meta name="view-transition" content="same-origin">
    <title>RIFT ‚Äì GM Kontrollzentrum</title>
    
    <link rel="stylesheet" href="assets/css/core.css">
    <link rel="stylesheet" href="assets/css/ui.css">
    <link rel="stylesheet" href="assets/css/sidebar.css">
    <link rel="stylesheet" href="assets/css/topbar.css">
    <link rel="stylesheet" href="assets/css/footer.css">
    <link rel="stylesheet" href="assets/css/settings.css">
    
    <style>
        /* ========================================
           GM KONTROLLZENTRUM - TAB LAYOUT
           ======================================== */
        
        .gm-container {
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }
        
        /* Header */
        .gm-header {
            display: flex;
            align-items: center;
            gap: 16px;
            margin-bottom: 24px;
            padding-bottom: 20px;
            border-bottom: 1px solid rgba(255,255,255,0.08);
        }
        
        .gm-header__icon {
            width: 48px;
            height: 48px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(255,70,85,0.15);
            border-radius: 12px;
            color: var(--accent);
        }
        
        .gm-header__icon svg {
            width: 28px;
            height: 28px;
        }
        
        .gm-header__info {
            flex: 1;
        }
        
        .gm-header__title {
            font-size: 24px;
            font-weight: 700;
            color: white;
            margin: 0 0 4px 0;
        }
        
        .gm-header__room {
            font-size: 14px;
            color: rgba(255,255,255,0.5);
        }
        
        .gm-header__room code {
            background: rgba(255,255,255,0.1);
            padding: 2px 8px;
            border-radius: 4px;
            font-family: monospace;
            color: var(--accent);
            cursor: pointer;
            transition: background 0.2s;
        }
        
        .gm-header__room code:hover {
            background: rgba(255,255,255,0.15);
        }
        
        /* Tab Navigation */
        .gm-tabs {
            display: flex;
            gap: 4px;
            margin-bottom: 24px;
            padding: 4px;
            background: rgba(255,255,255,0.03);
            border-radius: 12px;
            overflow-x: auto;
        }
        
        .gm-tab {
            flex: 1;
            min-width: 100px;
            padding: 12px 16px;
            background: transparent;
            border: none;
            border-radius: 8px;
            color: rgba(255,255,255,0.5);
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            white-space: nowrap;
        }
        
        .gm-tab:hover {
            color: rgba(255,255,255,0.8);
            background: rgba(255,255,255,0.05);
        }
        
        .gm-tab--active {
            color: white;
            background: rgba(255,70,85,0.15);
        }
        
        /* Tab Content */
        .gm-content {
            display: none;
        }
        
        .gm-content--active {
            display: block;
            animation: fadeIn 0.2s ease;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        /* Section Styling */
        .gm-section {
            background: rgba(255,255,255,0.02);
            border: 1px solid rgba(255,255,255,0.06);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 16px;
        }
        
        .gm-section__title {
            font-size: 13px;
            font-weight: 600;
            color: rgba(255,255,255,0.4);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 16px;
        }
        
        /* Stats Grid */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 12px;
        }
        
        .stat-card {
            background: rgba(255,255,255,0.03);
            border-radius: 10px;
            padding: 16px;
            text-align: center;
        }
        
        .stat-card__value {
            font-size: 28px;
            font-weight: 700;
            color: white;
            line-height: 1;
        }
        
        .stat-card__value--accent { color: var(--accent); }
        .stat-card__value--green { color: #22c55e; }
        .stat-card__value--purple { color: #a78bfa; }
        
        .stat-card__label {
            font-size: 12px;
            color: rgba(255,255,255,0.5);
            margin-top: 6px;
        }
        
        /* Quick Actions */
        .quick-actions {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 10px;
        }
        
        .quick-action {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 14px 16px;
            background: rgba(255,255,255,0.03);
            border: 1px solid rgba(255,255,255,0.06);
            border-radius: 10px;
            color: rgba(255,255,255,0.8);
            text-decoration: none;
            font-size: 14px;
            transition: all 0.2s ease;
        }
        
        .quick-action:hover {
            background: rgba(255,255,255,0.06);
            border-color: rgba(255,255,255,0.1);
            color: white;
        }
        
        .quick-action svg {
            width: 20px;
            height: 20px;
            opacity: 0.6;
        }
        
        /* Player List */
        .player-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        
        .player-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px;
            background: rgba(255,255,255,0.03);
            border-radius: 10px;
        }
        
        .player-item__avatar {
            width: 40px;
            height: 40px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            color: white;
            font-size: 16px;
        }
        
        .player-item__avatar--offline { opacity: 0.4; }
        
        .player-item__info { flex: 1; min-width: 0; }
        
        .player-item__name {
            font-weight: 600;
            color: white;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .player-item__role {
            font-size: 12px;
            color: rgba(255,255,255,0.5);
        }
        
        .player-item__badge {
            padding: 4px 8px;
            border-radius: 6px;
            font-size: 11px;
            font-weight: 600;
        }
        
        .player-item__badge--gm { background: rgba(255,70,85,0.15); color: var(--accent); }
        .player-item__badge--you { background: rgba(139,92,246,0.15); color: #a78bfa; }
        
        .player-item__kick {
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(255,70,85,0.1);
            border: none;
            border-radius: 8px;
            color: var(--accent);
            cursor: pointer;
            opacity: 0;
            transition: all 0.2s ease;
        }
        
        .player-item:hover .player-item__kick { opacity: 1; }
        .player-item__kick:hover { background: rgba(255,70,85,0.2); }
        .player-item__kick svg { width: 16px; height: 16px; }
        
        /* GM Transfer */
        .transfer-box {
            display: flex;
            gap: 10px;
            padding: 16px;
            background: rgba(139,92,246,0.05);
            border: 1px solid rgba(139,92,246,0.15);
            border-radius: 10px;
            margin-top: 16px;
        }
        
        .transfer-box select {
            flex: 1;
            padding: 10px 12px;
            background: rgba(0,0,0,0.3);
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 8px;
            color: white;
            font-size: 14px;
        }
        
        .transfer-box select option { background: #1a1a1a; }
        
        .transfer-box button {
            padding: 10px 20px;
            background: rgba(139,92,246,0.2);
            border: none;
            border-radius: 8px;
            color: #a78bfa;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .transfer-box button:hover:not(:disabled) { background: rgba(139,92,246,0.3); }
        .transfer-box button:disabled { opacity: 0.4; cursor: not-allowed; }
        
        /* Session List */
        .session-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        
        .session-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px;
            background: rgba(255,255,255,0.03);
            border-radius: 10px;
        }
        
        .session-item__date {
            display: flex;
            flex-direction: column;
            align-items: center;
            min-width: 50px;
            padding: 8px;
            background: rgba(255,255,255,0.05);
            border-radius: 8px;
        }
        
        .session-item__day { font-size: 20px; font-weight: 700; line-height: 1; color: white; }
        .session-item__month { font-size: 11px; color: rgba(255,255,255,0.5); margin-top: 2px; }
        .session-item__info { flex: 1; }
        .session-item__name { font-weight: 600; color: white; }
        .session-item__time { font-size: 12px; color: rgba(255,255,255,0.5); }
        
        .session-item__status {
            padding: 4px 10px;
            border-radius: 6px;
            font-size: 11px;
            font-weight: 600;
        }
        
        .session-item__status--live { background: rgba(34,197,94,0.2); color: #22c55e; }
        
        .session-item__start {
            width: 36px;
            height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(34,197,94,0.15);
            border: none;
            border-radius: 8px;
            color: #22c55e;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .session-item__start:hover:not(:disabled) { background: rgba(34,197,94,0.25); }
        .session-item__start:disabled { opacity: 0.3; cursor: not-allowed; }
        .session-item__start svg { width: 16px; height: 16px; }
        
        /* Live Session Banner */
        .live-banner {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 16px;
            background: linear-gradient(135deg, rgba(34,197,94,0.15), rgba(34,197,94,0.05));
            border: 1px solid rgba(34,197,94,0.3);
            border-radius: 12px;
            margin-bottom: 16px;
        }
        
        .live-banner__pulse {
            width: 12px;
            height: 12px;
            background: #22c55e;
            border-radius: 50%;
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; box-shadow: 0 0 0 0 rgba(34,197,94,0.4); }
            50% { opacity: 0.8; box-shadow: 0 0 0 8px rgba(34,197,94,0); }
        }
        
        .live-banner__info { flex: 1; }
        .live-banner__label { font-size: 11px; font-weight: 700; color: #22c55e; letter-spacing: 1px; }
        .live-banner__name { font-size: 16px; font-weight: 600; color: white; }
        
        .live-banner__stop {
            padding: 10px 20px;
            background: rgba(255,70,85,0.15);
            border: none;
            border-radius: 8px;
            color: var(--accent);
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .live-banner__stop:hover { background: rgba(255,70,85,0.25); }
        
        /* Broadcast */
        .broadcast-box {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }
        
        .broadcast-box textarea {
            width: 100%;
            min-height: 100px;
            padding: 14px;
            background: rgba(0,0,0,0.3);
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 10px;
            color: white;
            font-size: 14px;
            font-family: inherit;
            resize: vertical;
        }
        
        .broadcast-box textarea:focus { outline: none; border-color: var(--accent); }
        .broadcast-box textarea::placeholder { color: rgba(255,255,255,0.3); }
        
        .broadcast-box__actions {
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        
        .broadcast-box__checkbox {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
            color: rgba(255,255,255,0.6);
            cursor: pointer;
        }
        
        .broadcast-box__checkbox input { accent-color: var(--accent); }
        
        .broadcast-box__send {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 12px 24px;
            background: var(--accent);
            border: none;
            border-radius: 8px;
            color: white;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .broadcast-box__send:hover { filter: brightness(1.1); }
        .broadcast-box__send svg { width: 18px; height: 18px; }
        
        /* GM Notes */
        .notes-box { position: relative; }
        
        .notes-box textarea {
            width: 100%;
            min-height: 200px;
            padding: 14px;
            background: rgba(0,0,0,0.3);
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 10px;
            color: white;
            font-size: 14px;
            font-family: inherit;
            line-height: 1.6;
            resize: vertical;
        }
        
        .notes-box textarea:focus { outline: none; border-color: rgba(6,182,212,0.5); }
        .notes-box textarea::placeholder { color: rgba(255,255,255,0.25); }
        
        .notes-box__status {
            position: absolute;
            top: 12px;
            right: 12px;
            font-size: 12px;
            color: rgba(255,255,255,0.4);
        }
        
        .notes-box__status--saving { color: #fbbf24; }
        .notes-box__status--saved { color: #22c55e; }
        
        /* Danger Zone */
        .danger-section { background: rgba(255,70,85,0.03); border-color: rgba(255,70,85,0.15); }
        
        .danger-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 16px;
            padding: 16px;
            background: rgba(255,70,85,0.05);
            border: 1px solid rgba(255,70,85,0.1);
            border-radius: 10px;
            margin-bottom: 12px;
        }
        
        .danger-item:last-child { margin-bottom: 0; }
        .danger-item__info h4 { margin: 0 0 4px 0; color: white; font-size: 15px; }
        .danger-item__info p { margin: 0; font-size: 13px; color: rgba(255,255,255,0.5); }
        
        .danger-item__btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            white-space: nowrap;
            transition: all 0.2s ease;
        }
        
        .danger-item__btn--warning { background: rgba(255,200,0,0.15); color: #ffc800; }
        .danger-item__btn--warning:hover { background: rgba(255,200,0,0.25); }
        .danger-item__btn--danger { background: rgba(255,70,85,0.15); color: var(--accent); }
        .danger-item__btn--danger:hover { background: rgba(255,70,85,0.25); }
        
        /* Empty States */
        .empty-state { text-align: center; padding: 40px 20px; color: rgba(255,255,255,0.4); }
        .empty-state svg { width: 48px; height: 48px; margin-bottom: 12px; opacity: 0.3; }
        .empty-state p { margin: 0; }
        
        /* Create Button */
        .create-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            width: 100%;
            padding: 14px;
            background: rgba(255,255,255,0.03);
            border: 1px dashed rgba(255,255,255,0.15);
            border-radius: 10px;
            color: rgba(255,255,255,0.6);
            font-size: 14px;
            text-decoration: none;
            transition: all 0.2s ease;
            margin-top: 12px;
        }
        
        .create-btn:hover { background: rgba(255,255,255,0.06); border-color: rgba(255,255,255,0.25); color: white; }
        .create-btn svg { width: 18px; height: 18px; }
        
        /* Access Denied */
        .access-denied {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 60vh;
            text-align: center;
            padding: 40px;
        }
        
        .access-denied svg { width: 64px; height: 64px; color: rgba(255,255,255,0.2); margin-bottom: 20px; }
        .access-denied h2 { margin: 0 0 8px 0; color: white; }
        .access-denied p { color: rgba(255,255,255,0.5); margin: 0 0 24px 0; }
        .access-denied a { padding: 12px 24px; background: var(--accent); border-radius: 8px; color: white; text-decoration: none; font-weight: 600; }
        
        /* Spinner */
        @keyframes spin { to { transform: rotate(360deg); } }
        .spinner { width: 24px; height: 24px; border: 2px solid rgba(255,255,255,0.1); border-top-color: var(--accent); border-radius: 50%; animation: spin 1s linear infinite; }
        
        /* Responsive */
        @media (max-width: 600px) {
            .gm-tabs { flex-wrap: nowrap; overflow-x: auto; -webkit-overflow-scrolling: touch; }
            .gm-tab { min-width: 80px; padding: 10px 12px; font-size: 13px; }
            .stats-grid { grid-template-columns: repeat(2, 1fr); }
            .quick-actions { grid-template-columns: 1fr; }
            .transfer-box { flex-direction: column; }
            .danger-item { flex-direction: column; align-items: stretch; text-align: center; }
        }
    </style>
</head>
<body>
    <div class="app">
        <main class="main">
            <div class="main__content">
                
                <div class="gm-container" id="gmContent">
                    
                    <div class="gm-header">
                        <div class="gm-header__icon">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/>
                            </svg>
                        </div>
                        <div class="gm-header__info">
                            <h1 class="gm-header__title">GM Kontrollzentrum</h1>
                            <p class="gm-header__room">Raum: <code id="roomCodeDisplay" onclick="GMCtrl.copyCode()">---</code></p>
                        </div>
                    </div>
                    
                    <div class="gm-tabs">
                        <button class="gm-tab gm-tab--active" data-tab="overview">√úbersicht</button>
                        <button class="gm-tab" data-tab="players">Spieler</button>
                        <button class="gm-tab" data-tab="sessions">Sessions</button>
                        <button class="gm-tab" data-tab="tools">Tools</button>
                        <button class="gm-tab" data-tab="settings">Einstellungen</button>
                    </div>
                    
                    <!-- √úBERSICHT -->
                    <div class="gm-content gm-content--active" id="tab-overview">
                        <div class="gm-section">
                            <div class="gm-section__title">Raum-Statistiken</div>
                            <div class="stats-grid">
                                <div class="stat-card">
                                    <div class="stat-card__value stat-card__value--green" id="statOnline">0</div>
                                    <div class="stat-card__label">Online</div>
                                </div>
                                <div class="stat-card">
                                    <div class="stat-card__value" id="statPlayers">0</div>
                                    <div class="stat-card__label">Spieler</div>
                                </div>
                                <div class="stat-card">
                                    <div class="stat-card__value stat-card__value--purple" id="statSessions">0</div>
                                    <div class="stat-card__label">Sessions</div>
                                </div>
                                <div class="stat-card">
                                    <div class="stat-card__value" id="statRuleset">-</div>
                                    <div class="stat-card__label">Regelwerk</div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="gm-section">
                            <div class="gm-section__title">Schnellzugriff</div>
                            <div class="quick-actions">
                                <a href="dice.html" class="quick-action">
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="2" y="2" width="20" height="20" rx="2"/><circle cx="8" cy="8" r="1.5" fill="currentColor"/><circle cx="16" cy="16" r="1.5" fill="currentColor"/></svg>
                                    W√ºrfeln
                                </a>
                                <a href="chat.html" class="quick-action">
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/></svg>
                                    Chat
                                </a>
                                <a href="map.html" class="quick-action">
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polygon points="1 6 1 22 8 18 16 22 23 18 23 2 16 6 8 2 1 6"/><line x1="8" y1="2" x2="8" y2="18"/><line x1="16" y1="6" x2="16" y2="22"/></svg>
                                    Karte
                                </a>
                                <a href="sessions.html" class="quick-action">
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>
                                    Sessions
                                </a>
                            </div>
                        </div>
                        
                        <div class="gm-section">
                            <div class="gm-section__title">Raum-Info</div>
                            <p style="margin:0;color:rgba(255,255,255,0.6);font-size:14px;">
                                <strong>Erstellt:</strong> <span id="roomCreated">-</span><br>
                                <strong>Raum-Code:</strong> <span id="roomCodeInfo">-</span>
                            </p>
                        </div>
                    </div>
                    
                    <!-- SPIELER -->
                    <div class="gm-content" id="tab-players">
                        <div class="gm-section">
                            <div class="gm-section__title">Spieler im Raum</div>
                            <div class="player-list" id="playerList">
                                <div class="empty-state"><div class="spinner" style="margin:0 auto 12px;"></div><p>Spieler werden geladen...</p></div>
                            </div>
                            <a href="#" class="create-btn" id="inviteBtn">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M16 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="8.5" cy="7" r="4"/><line x1="20" y1="8" x2="20" y2="14"/><line x1="23" y1="11" x2="17" y2="11"/></svg>
                                Spieler einladen
                            </a>
                        </div>
                        
                        <div class="gm-section">
                            <div class="gm-section__title">GM √ºbertragen</div>
                            <p style="margin:0 0 12px;color:rgba(255,255,255,0.5);font-size:13px;">√úbertrage deine GM-Rechte an einen anderen Spieler.</p>
                            <div class="transfer-box">
                                <select id="transferSelect"><option value="">Spieler ausw√§hlen...</option></select>
                                <button id="transferBtn" disabled>√úbertragen</button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- SESSIONS -->
                    <div class="gm-content" id="tab-sessions">
                        <div class="live-banner" id="liveBanner" style="display:none;">
                            <div class="live-banner__pulse"></div>
                            <div class="live-banner__info">
                                <div class="live-banner__label">LIVE SESSION</div>
                                <div class="live-banner__name" id="liveSessionName">-</div>
                            </div>
                            <button class="live-banner__stop" id="stopSessionBtn">Beenden</button>
                        </div>
                        
                        <div class="gm-section">
                            <div class="gm-section__title">Sessions</div>
                            <div class="session-list" id="sessionList">
                                <div class="empty-state"><div class="spinner" style="margin:0 auto 12px;"></div><p>Sessions werden geladen...</p></div>
                            </div>
                            <a href="sessions.html?create=true" class="create-btn">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
                                Neue Session erstellen
                            </a>
                        </div>
                    </div>
                    
                    <!-- TOOLS -->
                    <div class="gm-content" id="tab-tools">
                        <div class="gm-section">
                            <div class="gm-section__title">üì¢ Broadcast</div>
                            <p style="margin:0 0 12px;color:rgba(255,255,255,0.5);font-size:13px;">Sende eine Nachricht an alle Spieler. Ein Popup erscheint auf allen Ger√§ten.</p>
                            <div class="broadcast-box">
                                <textarea id="broadcastInput" placeholder="Nachricht an alle Spieler..."></textarea>
                                <div class="broadcast-box__actions">
                                    <label class="broadcast-box__checkbox"><input type="checkbox" id="broadcastSound"> üîî Mit Sound</label>
                                    <button class="broadcast-box__send" id="broadcastBtn">
                                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="22" y1="2" x2="11" y2="13"/><polygon points="22 2 15 22 11 13 2 9 22 2"/></svg>
                                        Senden
                                    </button>
                                </div>
                            </div>
                        </div>
                        
                        <div class="gm-section">
                            <div class="gm-section__title">üìù GM Notizen</div>
                            <p style="margin:0 0 12px;color:rgba(255,255,255,0.5);font-size:13px;">Private Notizen nur f√ºr dich. Wird automatisch lokal gespeichert.</p>
                            <div class="notes-box">
                                <textarea id="gmNotesInput" placeholder="‚Ä¢ Geheime Plot-Twists&#10;‚Ä¢ NPC-Geheimnisse&#10;‚Ä¢ Encounter-Ideen"></textarea>
                                <span class="notes-box__status" id="notesStatus"></span>
                            </div>
                        </div>
                    </div>
                    
                    <!-- EINSTELLUNGEN -->
                    <div class="gm-content" id="tab-settings">
                        <div class="gm-section danger-section">
                            <div class="gm-section__title" style="color:var(--accent);">‚ö†Ô∏è Gefahrenzone</div>
                            <div class="danger-item">
                                <div class="danger-item__info">
                                    <h4>Raum verlassen</h4>
                                    <p>Du verl√§sst den Raum. Ein anderer Spieler wird automatisch GM.</p>
                                </div>
                                <button class="danger-item__btn danger-item__btn--warning" id="leaveBtn">Verlassen</button>
                            </div>
                            <div class="danger-item">
                                <div class="danger-item__info">
                                    <h4>Raum l√∂schen</h4>
                                    <p>L√∂scht den Raum und alle Daten unwiderruflich.</p>
                                </div>
                                <button class="danger-item__btn danger-item__btn--danger" id="deleteBtn">L√∂schen</button>
                            </div>
                        </div>
                    </div>
                    
                </div>
                
                <div class="access-denied" id="accessDenied" style="display:none;">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><rect x="3" y="11" width="18" height="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/></svg>
                    <h2>Zugriff verweigert</h2>
                    <p>Diese Seite ist nur f√ºr den Spielleiter (GM) zug√§nglich.</p>
                    <a href="index.html">Zur√ºck zum Hub</a>
                </div>
                
            </div>
        </main>
    </div>
    
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    <script src="assets/js/firebase-config.js"></script>
    <script src="assets/js/app.js"></script>
    <script src="assets/js/user-service.js"></script>
    <script src="assets/js/room-service.js"></script>
    <script src="assets/js/layout.js"></script>
    
    <script>
        const GMCtrl = {
            roomCode: null,
            members: [],
            sessions: [],
            unsubscribeMembers: null,
            unsubscribeSessions: null,
            
            async init() {
                this.roomCode = localStorage.getItem('rift_current_room');
                if (!this.roomCode) return;
                
                const formatted = this.roomCode.replace(/(.{3})(.{3})/, '$1-$2');
                document.getElementById('roomCodeDisplay').textContent = formatted;
                document.getElementById('roomCodeInfo').textContent = formatted;
                
                this.setupTabs();
                this.setupEvents();
                await this.waitForFirebase();
                await this.loadRoomInfo();
                this.subscribeToMembers();
                this.subscribeToSessions();
                this.loadNotes();
            },
            
            setupTabs() {
                document.querySelectorAll('.gm-tab').forEach(tab => {
                    tab.addEventListener('click', () => {
                        document.querySelectorAll('.gm-tab').forEach(t => t.classList.remove('gm-tab--active'));
                        tab.classList.add('gm-tab--active');
                        document.querySelectorAll('.gm-content').forEach(c => c.classList.remove('gm-content--active'));
                        document.getElementById('tab-' + tab.dataset.tab).classList.add('gm-content--active');
                    });
                });
            },
            
            setupEvents() {
                document.getElementById('inviteBtn')?.addEventListener('click', (e) => { e.preventDefault(); this.copyInviteLink(); });
                document.getElementById('transferSelect')?.addEventListener('change', (e) => { document.getElementById('transferBtn').disabled = !e.target.value; });
                document.getElementById('transferBtn')?.addEventListener('click', () => this.transferGM());
                document.getElementById('stopSessionBtn')?.addEventListener('click', () => this.stopSession());
                document.getElementById('broadcastBtn')?.addEventListener('click', () => this.sendBroadcast());
                document.getElementById('broadcastInput')?.addEventListener('keydown', (e) => { if (e.key === 'Enter' && e.ctrlKey) this.sendBroadcast(); });
                let notesTimer;
                document.getElementById('gmNotesInput')?.addEventListener('input', () => {
                    clearTimeout(notesTimer);
                    document.getElementById('notesStatus').textContent = 'Speichert...';
                    document.getElementById('notesStatus').className = 'notes-box__status notes-box__status--saving';
                    notesTimer = setTimeout(() => this.saveNotes(), 800);
                });
                document.getElementById('leaveBtn')?.addEventListener('click', () => this.leaveRoom());
                document.getElementById('deleteBtn')?.addEventListener('click', () => this.deleteRoom());
            },
            
            waitForFirebase(timeout = 8000) {
                return new Promise((resolve) => {
                    const start = Date.now();
                    const check = () => {
                        if (RIFT?.firebase?.getFirestore?.()) resolve(true);
                        else if (Date.now() - start > timeout) resolve(false);
                        else setTimeout(check, 100);
                    };
                    check();
                });
            },
            
            async loadRoomInfo() {
                try {
                    const room = await RIFT.rooms.getRoom(this.roomCode);
                    if (!room) return;
                    if (room.createdAt) {
                        const date = room.createdAt.toDate ? room.createdAt.toDate() : new Date(room.createdAt);
                        document.getElementById('roomCreated').textContent = date.toLocaleDateString('de-DE', { day: '2-digit', month: '2-digit', year: 'numeric' });
                    }
                    const rulesets = { '5e2024': '5E', 'worldsapart': 'WA', 'htbah': 'HTBAH', 'cyberpunk': 'CPR' };
                    document.getElementById('statRuleset').textContent = rulesets[room.ruleset] || room.ruleset || '-';
                } catch (e) { console.error('[GM] Load room failed:', e); }
            },
            
            subscribeToMembers() {
                if (this.unsubscribeMembers) this.unsubscribeMembers();
                this.unsubscribeMembers = RIFT.rooms.subscribeToMembers(this.roomCode, (members) => {
                    this.members = members;
                    this.renderPlayers(members);
                    this.updateTransferDropdown(members);
                    document.getElementById('statOnline').textContent = members.filter(m => m.online).length;
                    document.getElementById('statPlayers').textContent = members.length;
                });
            },
            
            renderPlayers(members) {
                const list = document.getElementById('playerList');
                const uid = firebase?.auth()?.currentUser?.uid;
                if (!members.length) { list.innerHTML = '<div class="empty-state"><p>Noch keine Spieler</p></div>'; return; }
                list.innerHTML = members.map(m => {
                    const name = m.displayName || m.name || 'Unbekannt';
                    const color = m.color || '#8B5CF6';
                    const isGM = m.role === 'gm', isYou = m.id === uid, isOnline = m.online === true;
                    return `<div class="player-item">
                        <div class="player-item__avatar ${isOnline ? '' : 'player-item__avatar--offline'}" style="background:${color};">${name.charAt(0).toUpperCase()}</div>
                        <div class="player-item__info"><div class="player-item__name">${name}</div><div class="player-item__role">${isGM ? 'Game Master' : 'Spieler'}${isOnline ? '' : ' ¬∑ Offline'}</div></div>
                        ${isGM ? '<span class="player-item__badge player-item__badge--gm">GM</span>' : ''}
                        ${isYou ? '<span class="player-item__badge player-item__badge--you">Du</span>' : ''}
                        ${!isGM && !isYou ? `<button class="player-item__kick" onclick="GMCtrl.kickPlayer('${m.id}','${name.replace(/'/g, "\\'")}')"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg></button>` : ''}
                    </div>`;
                }).join('');
            },
            
            updateTransferDropdown(members) {
                const select = document.getElementById('transferSelect');
                const uid = firebase?.auth()?.currentUser?.uid;
                const nonGM = members.filter(m => m.role !== 'gm' && m.id !== uid);
                select.innerHTML = '<option value="">Spieler ausw√§hlen...</option>' + nonGM.map(m => `<option value="${m.id}">${m.displayName || m.name || 'Unbekannt'}</option>`).join('');
            },
            
            async kickPlayer(id, name) {
                if (!confirm(`${name} wirklich entfernen?`)) return;
                try {
                    const db = RIFT.firebase.getFirestore();
                    await db.collection('rooms').doc(this.roomCode.replace('-', '').toUpperCase()).collection('members').doc(id).delete();
                    this.toast(`${name} entfernt`, 'success');
                } catch (e) { this.toast('Fehler', 'error'); }
            },
            
            async transferGM() {
                const select = document.getElementById('transferSelect');
                const targetId = select.value, targetName = select.options[select.selectedIndex].text;
                if (!targetId || !confirm(`GM-Rechte an "${targetName}" √ºbertragen?`)) return;
                try {
                    const db = RIFT.firebase.getFirestore();
                    const code = this.roomCode.replace('-', '').toUpperCase();
                    const uid = firebase.auth().currentUser?.uid;
                    await db.collection('rooms').doc(code).collection('members').doc(targetId).update({ role: 'gm' });
                    await db.collection('rooms').doc(code).collection('members').doc(uid).update({ role: 'player' });
                    await db.collection('rooms').doc(code).update({ gmId: targetId });
                    const u = JSON.parse(localStorage.getItem('rift_user') || '{}'); u.isGM = false; localStorage.setItem('rift_user', JSON.stringify(u));
                    this.toast(`GM an ${targetName} √ºbertragen!`, 'success');
                    setTimeout(() => window.location.href = 'index.html', 1500);
                } catch (e) { this.toast('Fehler', 'error'); }
            },
            
            subscribeToSessions() {
                if (this.unsubscribeSessions) this.unsubscribeSessions();
                this.unsubscribeSessions = RIFT.rooms.subscribeToSessions(this.roomCode, (sessions) => {
                    this.sessions = sessions;
                    this.renderSessions(sessions);
                    document.getElementById('statSessions').textContent = sessions.length;
                    this.updateLiveBanner(sessions.find(s => s.status === 'live'));
                });
            },
            
            renderSessions(sessions) {
                const list = document.getElementById('sessionList');
                if (!sessions.length) { list.innerHTML = '<div class="empty-state"><p>Noch keine Sessions</p></div>'; return; }
                const sorted = [...sessions].sort((a, b) => new Date(a.date) - new Date(b.date));
                const months = ['Jan', 'Feb', 'M√§r', 'Apr', 'Mai', 'Jun', 'Jul', 'Aug', 'Sep', 'Okt', 'Nov', 'Dez'];
                const hasLive = sessions.some(s => s.status === 'live');
                list.innerHTML = sorted.map(s => {
                    const date = new Date(s.date);
                    const isLive = s.status === 'live';
                    return `<div class="session-item">
                        <div class="session-item__date"><span class="session-item__day">${date.getDate()}</span><span class="session-item__month">${months[date.getMonth()]}</span></div>
                        <div class="session-item__info"><div class="session-item__name">${s.name || 'Unbenannt'}</div><div class="session-item__time">${s.time || '20:00'} Uhr</div></div>
                        ${isLive ? '<span class="session-item__status session-item__status--live">Live</span>' : `<button class="session-item__start" onclick="GMCtrl.startSession('${s.id}','${(s.name || '').replace(/'/g, "\\'")}')" ${hasLive ? 'disabled' : ''}><svg viewBox="0 0 24 24" fill="currentColor"><polygon points="5 3 19 12 5 21 5 3"/></svg></button>`}
                    </div>`;
                }).join('');
            },
            
            updateLiveBanner(live) {
                const banner = document.getElementById('liveBanner');
                if (live) {
                    banner.style.display = 'flex';
                    document.getElementById('liveSessionName').textContent = live.name || 'Aktive Session';
                    localStorage.setItem('rift_active_session', live.id);
                } else {
                    banner.style.display = 'none';
                    localStorage.removeItem('rift_active_session');
                }
            },
            
            async startSession(id, name) {
                try {
                    const db = RIFT.firebase.getFirestore();
                    const code = this.roomCode.replace('-', '').toUpperCase();
                    await db.collection('rooms').doc(code).collection('sessions').doc(id).update({ status: 'live', startedAt: firebase.firestore.FieldValue.serverTimestamp() });
                    await db.collection('rooms').doc(code).update({ activeSession: id });
                    this.toast(`"${name}" gestartet!`, 'success');
                } catch (e) { this.toast('Fehler', 'error'); }
            },
            
            async stopSession() {
                const activeId = localStorage.getItem('rift_active_session');
                if (!activeId || !confirm('Session beenden?')) return;
                try {
                    const db = RIFT.firebase.getFirestore();
                    const code = this.roomCode.replace('-', '').toUpperCase();
                    await db.collection('rooms').doc(code).collection('sessions').doc(activeId).update({ status: 'completed', endedAt: firebase.firestore.FieldValue.serverTimestamp() });
                    await db.collection('rooms').doc(code).update({ activeSession: null });
                    this.toast('Session beendet', 'success');
                } catch (e) { this.toast('Fehler', 'error'); }
            },
            
            async sendBroadcast() {
                const input = document.getElementById('broadcastInput');
                const message = input.value.trim();
                if (!message) { this.toast('Nachricht eingeben!', 'error'); return; }
                try {
                    const db = RIFT.firebase.getFirestore();
                    await db.collection('rooms').doc(this.roomCode.replace('-', '').toUpperCase()).update({
                        broadcast: { message, withSound: document.getElementById('broadcastSound').checked, timestamp: firebase.firestore.FieldValue.serverTimestamp(), id: Date.now() }
                    });
                    input.value = '';
                    this.toast('Broadcast gesendet!', 'success');
                } catch (e) { this.toast('Fehler', 'error'); }
            },
            
            loadNotes() {
                const saved = localStorage.getItem(`rift_gm_notes_${this.roomCode}`);
                if (saved) document.getElementById('gmNotesInput').value = saved;
            },
            
            saveNotes() {
                localStorage.setItem(`rift_gm_notes_${this.roomCode}`, document.getElementById('gmNotesInput').value);
                document.getElementById('notesStatus').textContent = '‚úì Gespeichert';
                document.getElementById('notesStatus').className = 'notes-box__status notes-box__status--saved';
                setTimeout(() => { document.getElementById('notesStatus').textContent = ''; }, 2000);
            },
            
            async leaveRoom() {
                if (!confirm('Raum verlassen?')) return;
                try {
                    const db = RIFT.firebase.getFirestore();
                    await db.collection('rooms').doc(this.roomCode.replace('-', '').toUpperCase()).collection('members').doc(firebase.auth().currentUser?.uid).delete();
                    localStorage.removeItem('rift_current_room');
                    const u = JSON.parse(localStorage.getItem('rift_user') || '{}'); u.isGM = false; localStorage.setItem('rift_user', JSON.stringify(u));
                    this.toast('Verlassen', 'success');
                    setTimeout(() => window.location.href = 'login.html', 1000);
                } catch (e) { this.toast('Fehler', 'error'); }
            },
            
            async deleteRoom() {
                if (!confirm('‚ö†Ô∏è Raum und ALLE Daten l√∂schen?')) return;
                try {
                    const db = RIFT.firebase.getFirestore();
                    const code = this.roomCode.replace('-', '').toUpperCase();
                    const ref = db.collection('rooms').doc(code);
                    this.toast('Wird gel√∂scht...', 'info');
                    for (const sub of ['members', 'sessions', 'characters', 'chat', 'dice', 'notes', 'whiteboard', 'markers']) {
                        const snap = await ref.collection(sub).get();
                        const batch = db.batch();
                        snap.docs.forEach(d => batch.delete(d.ref));
                        if (snap.docs.length) await batch.commit();
                    }
                    await ref.delete();
                    localStorage.removeItem('rift_current_room');
                    localStorage.removeItem('rift_active_session');
                    this.toast('Gel√∂scht!', 'success');
                    setTimeout(() => window.location.href = 'login.html', 1500);
                } catch (e) { this.toast('Fehler', 'error'); }
            },
            
            copyCode() { navigator.clipboard.writeText(this.roomCode).then(() => this.toast('Code kopiert!', 'success')); },
            copyInviteLink() { navigator.clipboard.writeText(`${window.location.origin}/login.html?room=${this.roomCode}`).then(() => this.toast('Einladungslink kopiert!', 'success')); },
            toast(msg, type = 'info') { if (window.RIFT?.ui?.Toast) RIFT.ui.Toast[type]?.(msg) || RIFT.ui.Toast.info(msg); else console.log(`[Toast] ${type}: ${msg}`); },
            cleanup() { if (this.unsubscribeMembers) this.unsubscribeMembers(); if (this.unsubscribeSessions) this.unsubscribeSessions(); }
        };
        
        window.addEventListener('beforeunload', () => GMCtrl.cleanup());
        
        (async function() {
            const gmContent = document.getElementById('gmContent');
            const accessDenied = document.getElementById('accessDenied');
            const roomCode = localStorage.getItem('rift_current_room');
            const userData = JSON.parse(localStorage.getItem('rift_user') || '{}');
            
            function showContent() { gmContent.style.display = 'block'; accessDenied.style.display = 'none'; }
            function showDenied() { gmContent.style.display = 'none'; accessDenied.style.display = 'flex'; }
            
            function waitForRIFT(timeout = 8000) {
                return new Promise((resolve, reject) => {
                    const start = Date.now();
                    const check = () => {
                        if (RIFT?.rooms && RIFT?.firebase?.getFirestore?.()) resolve(true);
                        else if (Date.now() - start > timeout) reject(new Error('Timeout'));
                        else setTimeout(check, 100);
                    };
                    check();
                });
            }
            
            function waitForAuth(timeout = 5000) {
                return new Promise((resolve) => {
                    if (firebase?.auth()?.currentUser) { resolve(firebase.auth().currentUser); return; }
                    const unsub = firebase.auth().onAuthStateChanged(user => { unsub(); resolve(user); });
                    setTimeout(() => resolve(null), timeout);
                });
            }
            
            try {
                await waitForRIFT();
                const user = await waitForAuth();
                if (!roomCode || !user) { showDenied(); return; }
                let isGM = false;
                try { isGM = await RIFT.rooms.isUserGM(roomCode); } catch (e) { isGM = userData.isGM === true; }
                if (isGM) { userData.isGM = true; localStorage.setItem('rift_user', JSON.stringify(userData)); showContent(); GMCtrl.init(); }
                else { showDenied(); }
            } catch (e) {
                if (userData.isGM === true && roomCode) { showContent(); GMCtrl.init(); }
                else { showDenied(); }
            }
        })();
        
        initLayout();
    </script>
</body>
</html>
