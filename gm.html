<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <meta name="view-transition" content="same-origin">
    <title>RIFT ‚Äì GM Kontrollzentrum</title>
    
    <link rel="stylesheet" href="assets/css/core.css">
    <link rel="stylesheet" href="assets/css/ui.css">
    <link rel="stylesheet" href="assets/css/sidebar.css">
    <link rel="stylesheet" href="assets/css/topbar.css">
    <link rel="stylesheet" href="assets/css/footer.css">
    
    <style>
        /* ==================== GM CONTROL CENTER STYLES ==================== */
        .gm-page {
            padding: 24px;
            --gm-accent: #8b5cf6;
            --gm-accent-light: #a78bfa;
            --gm-bg-card: #111111;
            --gm-border: rgba(255,255,255,0.08);
        }
        .gm-container { max-width: 1200px; margin: 0 auto; }
        
        /* Header */
        .gm-header { margin-bottom: 32px; }
        .gm-header__title { font-size: 28px; font-weight: 700; color: white; margin: 0 0 8px 0; display: flex; align-items: center; gap: 12px; }
        .gm-header__title svg { width: 32px; height: 32px; color: var(--gm-accent); }
        .gm-header__subtitle { font-size: 14px; color: rgba(255,255,255,0.5); margin: 0; }
        .gm-header__subtitle code { background: rgba(139,92,246,0.15); padding: 2px 10px; border-radius: 6px; font-family: monospace; color: var(--gm-accent-light); cursor: pointer; }
        .gm-header__subtitle code:hover { background: rgba(139,92,246,0.25); }
        
        /* Tabs */
        .gm-tabs { display: flex; gap: 4px; background: #111111; padding: 6px; border-radius: 12px; margin-bottom: 24px; overflow-x: auto; }
        .gm-tab { display: flex; align-items: center; gap: 8px; padding: 12px 20px; background: transparent; border: none; border-radius: 8px; color: rgba(255,255,255,0.5); font-size: 14px; font-weight: 500; cursor: pointer; transition: all 0.2s; white-space: nowrap; }
        .gm-tab:hover { background: rgba(255,255,255,0.05); color: rgba(255,255,255,0.9); }
        .gm-tab.active { background: var(--gm-accent); color: white; }
        .gm-tab svg { width: 18px; height: 18px; }
        
        /* Panels */
        .gm-panel { display: none; animation: fadeIn 0.2s ease; }
        .gm-panel.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .gm-grid { display: grid; grid-template-columns: 1fr 380px; gap: 24px; }
        @media (max-width: 1000px) { .gm-grid { grid-template-columns: 1fr; } }
        
        /* Cards */
        .gm-card { background: #111111; border: 1px solid rgba(255,255,255,0.08); border-radius: 16px; overflow: hidden; margin-bottom: 24px; }
        .gm-card__header { padding: 20px 24px; border-bottom: 1px solid rgba(255,255,255,0.08); display: flex; justify-content: space-between; align-items: center; }
        .gm-card__title { font-size: 16px; font-weight: 600; color: white; display: flex; align-items: center; gap: 10px; }
        .gm-card__title svg { width: 20px; height: 20px; color: var(--gm-accent); }
        .gm-card__body { padding: 24px; }
        
        /* Form Elements */
        .gm-input { width: 100%; padding: 14px 16px; background: rgba(0,0,0,0.3); border: 1px solid rgba(255,255,255,0.08); border-radius: 10px; color: white; font-size: 14px; box-sizing: border-box; }
        .gm-input:focus { outline: none; border-color: var(--gm-accent); }
        .gm-input::placeholder { color: rgba(255,255,255,0.4); }
        .gm-textarea { width: 100%; min-height: 120px; padding: 14px 16px; background: rgba(0,0,0,0.3); border: 1px solid rgba(255,255,255,0.08); border-radius: 10px; color: white; font-size: 14px; font-family: inherit; resize: vertical; box-sizing: border-box; }
        .gm-textarea:focus { outline: none; border-color: var(--gm-accent); }
        
        /* Buttons */
        .gm-btn { display: inline-flex; align-items: center; justify-content: center; gap: 8px; padding: 14px 24px; background: var(--gm-accent); border: none; border-radius: 10px; color: white; font-size: 14px; font-weight: 600; cursor: pointer; transition: all 0.2s; }
        .gm-btn:hover { filter: brightness(1.1); transform: translateY(-1px); }
        .gm-btn svg { width: 18px; height: 18px; }
        .gm-btn--secondary { background: rgba(255,255,255,0.1); }
        .gm-btn--danger { background: #ef4444; }
        .gm-btn--success { background: #22c55e; }
        .gm-btn--warning { background: #f97316; }
        .gm-btn--full { width: 100%; }
        .gm-btn--small { padding: 10px 16px; font-size: 13px; }
        
        /* Session Timer */
        .session-timer { display: flex; align-items: center; gap: 16px; padding: 20px 24px; background: linear-gradient(135deg, rgba(34,197,94,0.15), rgba(34,197,94,0.05)); border: 1px solid rgba(34,197,94,0.3); border-radius: 16px; margin-bottom: 24px; }
        .session-timer__pulse { width: 12px; height: 12px; background: #22c55e; border-radius: 50%; animation: pulse 2s infinite; }
        @keyframes pulse { 0%, 100% { box-shadow: 0 0 0 0 rgba(34,197,94,0.4); } 50% { box-shadow: 0 0 0 10px rgba(34,197,94,0); } }
        .session-timer__info { flex: 1; }
        .session-timer__label { font-size: 11px; font-weight: 700; color: #22c55e; letter-spacing: 1px; }
        .session-timer__name { font-size: 16px; font-weight: 600; color: white; }
        .session-timer__time { font-size: 32px; font-weight: 700; color: white; font-family: monospace; }
        
        /* Stats Grid */
        .stats-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 16px; }
        @media (max-width: 768px) { .stats-grid { grid-template-columns: repeat(2, 1fr); } }
        .stat-card { background: rgba(255,255,255,0.03); border: 1px solid rgba(255,255,255,0.06); border-radius: 12px; padding: 20px; text-align: center; }
        .stat-card__value { font-size: 36px; font-weight: 700; color: white; line-height: 1; }
        .stat-card__value--green { color: #22c55e; }
        .stat-card__value--purple { color: var(--gm-accent-light); }
        .stat-card__value--orange { color: #f97316; }
        .stat-card__label { font-size: 12px; color: rgba(255,255,255,0.5); margin-top: 8px; text-transform: uppercase; letter-spacing: 0.5px; }
        
        /* Quick Actions */
        .quick-actions { display: grid; grid-template-columns: repeat(auto-fit, minmax(100px, 1fr)); gap: 12px; }
        .quick-action { display: flex; flex-direction: column; align-items: center; gap: 10px; padding: 20px 16px; background: rgba(255,255,255,0.03); border: 1px solid rgba(255,255,255,0.06); border-radius: 12px; color: rgba(255,255,255,0.7); text-decoration: none; font-size: 13px; font-weight: 500; transition: all 0.2s; }
        .quick-action:hover { background: rgba(139,92,246,0.1); border-color: rgba(139,92,246,0.3); color: white; }
        .quick-action svg { width: 28px; height: 28px; opacity: 0.6; }
        .quick-action:hover svg { opacity: 1; color: var(--gm-accent); }
        
        /* Character Cards */
        .char-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 16px; }
        .char-card { background: rgba(255,255,255,0.03); border: 1px solid rgba(255,255,255,0.06); border-radius: 12px; padding: 20px; transition: all 0.2s; }
        .char-card:hover { border-color: rgba(139,92,246,0.3); }
        .char-card__header { display: flex; align-items: center; gap: 12px; margin-bottom: 16px; }
        .char-card__avatar { width: 48px; height: 48px; border-radius: 12px; display: flex; align-items: center; justify-content: center; font-weight: 700; font-size: 20px; color: white; }
        .char-card__info { flex: 1; min-width: 0; }
        .char-card__name { font-weight: 600; color: white; font-size: 15px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .char-card__meta { font-size: 13px; color: rgba(255,255,255,0.5); }
        .char-card__online { width: 10px; height: 10px; border-radius: 50%; background: #22c55e; }
        .char-card__online--offline { background: rgba(255,255,255,0.2); }
        
        /* HP Bar */
        .hp-section { margin-top: 16px; }
        .hp-header { display: flex; justify-content: space-between; font-size: 12px; margin-bottom: 6px; }
        .hp-header__label { color: rgba(255,255,255,0.5); }
        .hp-header__value { color: white; font-weight: 600; }
        .hp-bar { height: 8px; background: rgba(255,255,255,0.1); border-radius: 4px; overflow: hidden; }
        .hp-bar__fill { height: 100%; border-radius: 4px; transition: width 0.3s, background 0.3s; }
        .hp-bar__fill--high { background: #22c55e; }
        .hp-bar__fill--mid { background: #f97316; }
        .hp-bar__fill--low { background: #ef4444; }
        .hp-controls { display: flex; gap: 8px; margin-top: 12px; }
        .hp-controls input { width: 60px; padding: 8px; background: rgba(0,0,0,0.3); border: 1px solid rgba(255,255,255,0.1); border-radius: 8px; color: white; text-align: center; font-size: 14px; }
        .hp-controls input:focus { outline: none; border-color: var(--gm-accent); }
        .hp-btn { padding: 8px 12px; border: none; border-radius: 8px; font-weight: 600; font-size: 13px; cursor: pointer; transition: all 0.2s; }
        .hp-btn--dmg { background: rgba(239,68,68,0.2); color: #ef4444; }
        .hp-btn--dmg:hover { background: rgba(239,68,68,0.3); }
        .hp-btn--heal { background: rgba(34,197,94,0.2); color: #22c55e; }
        .hp-btn--heal:hover { background: rgba(34,197,94,0.3); }
        
        /* Log List */
        .log-list { max-height: 400px; overflow-y: auto; display: flex; flex-direction: column; gap: 8px; }
        .log-item { display: flex; align-items: center; gap: 12px; padding: 12px 16px; background: rgba(255,255,255,0.02); border-radius: 10px; font-size: 14px; }
        .log-item__time { font-size: 12px; color: rgba(255,255,255,0.3); min-width: 50px; font-family: monospace; }
        .log-item__icon { width: 32px; height: 32px; display: flex; align-items: center; justify-content: center; border-radius: 8px; flex-shrink: 0; font-size: 16px; }
        .log-item__icon--dice { background: rgba(139,92,246,0.2); }
        .log-item__icon--chat { background: rgba(59,130,246,0.2); }
        .log-item__icon--join { background: rgba(34,197,94,0.2); }
        .log-item__icon--leave { background: rgba(239,68,68,0.2); }
        .log-item__icon--edit { background: rgba(251,191,36,0.2); }
        .log-item__content { flex: 1; min-width: 0; color: rgba(255,255,255,0.8); }
        .log-item__user { font-weight: 600; color: white; }
        .log-item__result { font-weight: 700; color: var(--gm-accent-light); margin-left: 4px; }
        
        /* Sessions */
        .session-list { display: flex; flex-direction: column; gap: 12px; }
        .session-item { display: flex; align-items: center; gap: 16px; padding: 16px; background: rgba(255,255,255,0.03); border: 1px solid rgba(255,255,255,0.06); border-radius: 12px; transition: all 0.2s; }
        .session-item:hover { border-color: rgba(139,92,246,0.3); }
        .session-item__date { display: flex; flex-direction: column; align-items: center; min-width: 56px; padding: 10px; background: rgba(139,92,246,0.1); border-radius: 10px; }
        .session-item__day { font-size: 24px; font-weight: 700; line-height: 1; color: white; }
        .session-item__month { font-size: 12px; color: var(--gm-accent-light); text-transform: uppercase; }
        .session-item__info { flex: 1; }
        .session-item__name { font-weight: 600; color: white; font-size: 15px; }
        .session-item__time { font-size: 13px; color: rgba(255,255,255,0.5); }
        .session-item__live { padding: 6px 12px; border-radius: 8px; font-size: 12px; font-weight: 600; background: rgba(34,197,94,0.2); color: #22c55e; }
        .session-item__start { width: 40px; height: 40px; display: flex; align-items: center; justify-content: center; background: rgba(34,197,94,0.15); border: none; border-radius: 10px; color: #22c55e; cursor: pointer; }
        .session-item__start:hover:not(:disabled) { background: rgba(34,197,94,0.25); }
        .session-item__start:disabled { opacity: 0.3; cursor: not-allowed; }
        .session-item__start svg { width: 18px; height: 18px; }
        .create-link { display: flex; align-items: center; justify-content: center; gap: 8px; padding: 16px; background: rgba(255,255,255,0.03); border: 1px dashed rgba(255,255,255,0.15); border-radius: 12px; color: rgba(255,255,255,0.6); text-decoration: none; font-weight: 500; margin-top: 16px; }
        .create-link:hover { background: rgba(139,92,246,0.1); border-color: rgba(139,92,246,0.3); color: white; }
        .create-link svg { width: 18px; height: 18px; }
        
        /* Broadcast */
        .broadcast-actions { display: flex; align-items: center; justify-content: space-between; margin-top: 16px; }
        .broadcast-check { display: flex; align-items: center; gap: 8px; font-size: 14px; color: rgba(255,255,255,0.6); cursor: pointer; }
        .broadcast-check input { accent-color: var(--gm-accent); width: 16px; height: 16px; }
        
        /* Poll */
        .poll-types { display: flex; gap: 8px; flex-wrap: wrap; margin-bottom: 16px; }
        .poll-types label { display: flex; align-items: center; gap: 6px; padding: 10px 14px; background: rgba(255,255,255,0.05); border-radius: 8px; font-size: 13px; color: rgba(255,255,255,0.7); cursor: pointer; }
        .poll-types label:hover { background: rgba(255,255,255,0.08); }
        .poll-types input[type="radio"] { accent-color: var(--gm-accent); }
        .poll-settings { display: flex; align-items: center; gap: 16px; padding: 12px 0; }
        .poll-settings label { display: flex; align-items: center; gap: 8px; font-size: 13px; color: rgba(255,255,255,0.7); cursor: pointer; }
        .poll-settings input[type="checkbox"] { accent-color: var(--gm-accent); width: 16px; height: 16px; }
        .poll-active { padding: 20px; background: rgba(139,92,246,0.1); border: 1px solid rgba(139,92,246,0.2); border-radius: 12px; margin-bottom: 20px; }
        .poll-active__header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 16px; gap: 16px; }
        .poll-active__label { font-size: 11px; font-weight: 700; color: var(--gm-accent-light); letter-spacing: 1px; }
        .poll-active__question { font-size: 16px; font-weight: 600; color: white; margin-top: 4px; }
        .poll-active__actions { display: flex; gap: 8px; flex-shrink: 0; }
        .poll-active__resolve { padding: 8px 14px; background: rgba(34,197,94,0.2); border: none; border-radius: 8px; color: #22c55e; font-size: 13px; font-weight: 600; cursor: pointer; }
        .poll-active__resolve:hover { background: rgba(34,197,94,0.3); }
        .poll-active__close { width: 32px; height: 32px; background: rgba(255,255,255,0.1); border: none; border-radius: 8px; color: rgba(255,255,255,0.6); cursor: pointer; display: flex; align-items: center; justify-content: center; }
        .poll-active__close:hover { background: rgba(239,68,68,0.2); color: #ef4444; }
        .poll-results { display: flex; flex-direction: column; gap: 10px; }
        .poll-result { display: flex; align-items: center; gap: 12px; }
        .poll-result__label { min-width: 80px; font-size: 14px; color: rgba(255,255,255,0.8); }
        .poll-result__bar { flex: 1; height: 32px; background: rgba(255,255,255,0.1); border-radius: 8px; overflow: hidden; position: relative; }
        .poll-result__fill { height: 100%; background: linear-gradient(90deg, #8b5cf6, #a78bfa); transition: width 0.3s; }
        .poll-result__count { position: absolute; right: 12px; top: 50%; transform: translateY(-50%); font-size: 14px; font-weight: 600; color: white; }
        .poll-custom { display: none; flex-direction: column; gap: 12px; margin-top: 12px; padding: 16px; background: rgba(255,255,255,0.03); border-radius: 10px; }
        .poll-option-row { display: flex; align-items: center; gap: 10px; }
        .poll-option-row__emoji { position: relative; }
        .poll-option-row__emoji-btn { width: 44px; height: 44px; background: rgba(0,0,0,0.3); border: 1px solid rgba(255,255,255,0.1); border-radius: 8px; font-size: 20px; cursor: pointer; display: flex; align-items: center; justify-content: center; }
        .poll-option-row__emoji-btn:hover { border-color: rgba(139,92,246,0.5); background: rgba(139,92,246,0.1); }
        .poll-option-row__input { flex: 1; padding: 12px 14px; background: rgba(0,0,0,0.3); border: 1px solid rgba(255,255,255,0.1); border-radius: 8px; color: white; font-size: 14px; }
        .poll-option-row__input:focus { outline: none; border-color: var(--gm-accent); }
        .poll-option-row__input::placeholder { color: rgba(255,255,255,0.3); }
        .poll-option-row__remove { width: 36px; height: 36px; background: transparent; border: none; color: rgba(255,255,255,0.3); cursor: pointer; display: flex; align-items: center; justify-content: center; border-radius: 8px; }
        .poll-option-row__remove:hover { color: #ef4444; background: rgba(239,68,68,0.1); }
        .poll-add-option { display: flex; align-items: center; justify-content: center; gap: 8px; padding: 12px; background: transparent; border: 1px dashed rgba(255,255,255,0.15); border-radius: 8px; color: rgba(255,255,255,0.5); font-size: 13px; cursor: pointer; }
        .poll-add-option:hover { border-color: rgba(139,92,246,0.5); color: rgba(255,255,255,0.8); }
        .poll-add-option svg { width: 16px; height: 16px; }
        .emoji-picker { position: absolute; top: 100%; left: 0; z-index: 100; background: #1a1a1a; border: 1px solid rgba(255,255,255,0.1); border-radius: 12px; padding: 12px; box-shadow: 0 10px 40px rgba(0,0,0,0.5); display: none; }
        .emoji-picker.visible { display: block; }
        .emoji-picker__grid { display: grid; grid-template-columns: repeat(8, 1fr); gap: 4px; }
        .emoji-picker__btn { width: 36px; height: 36px; background: transparent; border: none; border-radius: 8px; font-size: 20px; cursor: pointer; }
        .emoji-picker__btn:hover { background: rgba(139,92,246,0.2); }
        .poll-image-upload { display: flex; flex-direction: column; gap: 10px; margin-bottom: 12px; }
        .poll-image-upload__label { font-size: 12px; color: rgba(255,255,255,0.5); }
        .poll-image-upload__area { position: relative; width: 100%; aspect-ratio: 350/160; background: rgba(0,0,0,0.3); border: 2px dashed rgba(255,255,255,0.15); border-radius: 10px; display: flex; flex-direction: column; align-items: center; justify-content: center; cursor: pointer; overflow: hidden; }
        .poll-image-upload__area:hover { border-color: rgba(139,92,246,0.5); }
        .poll-image-upload__area.has-image { border-style: solid; border-color: rgba(139,92,246,0.3); }
        .poll-image-upload__placeholder { display: flex; flex-direction: column; align-items: center; gap: 8px; color: rgba(255,255,255,0.4); }
        .poll-image-upload__placeholder svg { width: 32px; height: 32px; }
        .poll-image-upload__placeholder span { font-size: 13px; }
        .poll-image-upload__preview { position: absolute; inset: 0; object-fit: cover; }
        .poll-image-upload__remove { position: absolute; top: 8px; right: 8px; width: 28px; height: 28px; background: rgba(0,0,0,0.7); border: none; border-radius: 6px; color: white; cursor: pointer; display: flex; align-items: center; justify-content: center; }
        .poll-image-upload__remove:hover { background: #ef4444; }
        .poll-image-upload input[type="file"] { display: none; }
        .cropper-modal { position: fixed; inset: 0; z-index: 10000; background: rgba(0,0,0,0.9); display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 20px; }
        .cropper-modal__container { position: relative; width: 100%; max-width: 600px; background: #1a1a1a; border-radius: 16px; overflow: hidden; }
        .cropper-modal__header { padding: 16px 20px; border-bottom: 1px solid rgba(255,255,255,0.1); display: flex; justify-content: space-between; align-items: center; }
        .cropper-modal__title { font-weight: 600; color: white; }
        .cropper-modal__close { background: transparent; border: none; color: rgba(255,255,255,0.5); cursor: pointer; font-size: 18px; }
        .cropper-modal__close:hover { color: white; }
        .cropper-modal__canvas-wrap { position: relative; width: 100%; aspect-ratio: 350/160; background: #000; overflow: hidden; cursor: move; }
        .cropper-modal__canvas { position: absolute; top: 0; left: 0; transform-origin: 0 0; pointer-events: none; }
        .cropper-modal__controls { padding: 16px 20px; display: flex; gap: 12px; align-items: center; }
        .cropper-modal__zoom { flex: 1; accent-color: var(--gm-accent); }
        .cropper-modal__actions { display: flex; gap: 12px; padding: 16px 20px; border-top: 1px solid rgba(255,255,255,0.1); justify-content: flex-end; }
        .cropper-modal__btn { padding: 12px 24px; border: none; border-radius: 10px; font-weight: 600; cursor: pointer; }
        .cropper-modal__btn--cancel { background: rgba(255,255,255,0.1); color: white; }
        .cropper-modal__btn--apply { background: var(--gm-accent); color: white; }
        
        /* Transfer & Notes */
        .transfer-box { display: flex; gap: 12px; padding: 20px; background: rgba(139,92,246,0.05); border: 1px solid rgba(139,92,246,0.15); border-radius: 12px; }
        .transfer-box select { flex: 1; padding: 12px 14px; background: rgba(0,0,0,0.3); border: 1px solid rgba(255,255,255,0.1); border-radius: 10px; color: white; font-size: 14px; }
        .transfer-box select option { background: #1a1a1a; }
        .transfer-box button { padding: 12px 24px; background: rgba(139,92,246,0.2); border: none; border-radius: 10px; color: var(--gm-accent-light); font-weight: 600; cursor: pointer; }
        .transfer-box button:hover:not(:disabled) { background: rgba(139,92,246,0.3); }
        .transfer-box button:disabled { opacity: 0.4; cursor: not-allowed; }
        .notes-box { position: relative; }
        .notes-box__status { position: absolute; top: 12px; right: 12px; font-size: 12px; }
        .notes-box__status--saving { color: #fbbf24; }
        .notes-box__status--saved { color: #22c55e; }
        
        /* Danger Zone */
        .danger-card { background: rgba(239,68,68,0.03); border-color: rgba(239,68,68,0.15); }
        .danger-card .gm-card__title { color: #ef4444; }
        .danger-card .gm-card__title svg { color: #ef4444; }
        .danger-item { display: flex; align-items: center; justify-content: space-between; gap: 20px; padding: 20px; background: rgba(239,68,68,0.05); border: 1px solid rgba(239,68,68,0.1); border-radius: 12px; margin-bottom: 16px; }
        .danger-item:last-child { margin-bottom: 0; }
        .danger-item__info h4 { margin: 0 0 4px 0; color: white; font-size: 15px; }
        .danger-item__info p { margin: 0; font-size: 13px; color: rgba(255,255,255,0.5); }
        
        /* Empty & Access Denied */
        .empty { text-align: center; padding: 40px 20px; color: rgba(255,255,255,0.4); }
        .empty p { margin: 8px 0 0 0; }
        .empty .spinner { width: 24px; height: 24px; border: 2px solid rgba(255,255,255,0.1); border-top-color: var(--gm-accent); border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto 12px; }
        @keyframes spin { to { transform: rotate(360deg); } }
        .access-denied { display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 60vh; text-align: center; padding: 40px; }
        .access-denied svg { width: 64px; height: 64px; color: rgba(255,255,255,0.2); margin-bottom: 20px; }
        .access-denied h2 { margin: 0 0 8px 0; color: white; }
        .access-denied p { color: rgba(255,255,255,0.5); margin: 0 0 24px 0; }
        .access-denied a { padding: 14px 28px; background: var(--gm-accent); border-radius: 10px; color: white; text-decoration: none; font-weight: 600; }
        
        /* Responsive */
        @media (max-width: 768px) {
            .gm-page { padding: 16px; }
            .gm-tab { min-width: auto; padding: 10px 14px; font-size: 13px; }
            .gm-tab span { display: none; }
            .char-grid { grid-template-columns: 1fr; }
            .transfer-box, .danger-item { flex-direction: column; align-items: stretch; }
            .session-timer { flex-wrap: wrap; }
            .session-timer__time { width: 100%; text-align: center; margin-top: 8px; }
        }
    </style>
</head>
<body>
    <div class="app">
        <main class="main">
            <div class="main__content">
                
                <div class="gm-page" id="gmContent">
                    <div class="gm-container">
                        
                        <!-- Header -->
                        <div class="gm-header">
                            <h1 class="gm-header__title">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/></svg>
                                GM Kontrollzentrum
                            </h1>
                            <p class="gm-header__subtitle">Raum: <code id="roomCodeDisplay" onclick="GM.copyCode()">---</code></p>
                        </div>
                        
                        <!-- Tab Navigation -->
                        <div class="gm-tabs">
                            <button class="gm-tab active" data-tab="overview">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="7" height="7"/><rect x="14" y="3" width="7" height="7"/><rect x="14" y="14" width="7" height="7"/><rect x="3" y="14" width="7" height="7"/></svg>
                                <span>√úbersicht</span>
                            </button>
                            <button class="gm-tab" data-tab="players">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>
                                <span>Spieler</span>
                            </button>
                            <button class="gm-tab" data-tab="logs">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/></svg>
                                <span>Logs</span>
                            </button>
                            <button class="gm-tab" data-tab="sessions">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="4" width="18" height="18" rx="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>
                                <span>Sessions</span>
                            </button>
                            <button class="gm-tab" data-tab="tools">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14.7 6.3a1 1 0 0 0 0 1.4l1.6 1.6a1 1 0 0 0 1.4 0l3.77-3.77a6 6 0 0 1-7.94 7.94l-6.91 6.91a2.12 2.12 0 0 1-3-3l6.91-6.91a6 6 0 0 1 7.94-7.94l-3.76 3.76z"/></svg>
                                <span>Tools</span>
                            </button>
                            <button class="gm-tab" data-tab="settings">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/></svg>
                            </button>
                        </div>
                        
                        <!-- ==================== √úBERSICHT ==================== -->
                        <div class="gm-panel active" id="panel-overview">
                            
                            <!-- Session Timer -->
                            <div class="session-timer" id="sessionTimer" style="display:none;">
                                <div class="session-timer__pulse"></div>
                                <div class="session-timer__info">
                                    <div class="session-timer__label">LIVE SESSION</div>
                                    <div class="session-timer__name" id="timerName">-</div>
                                </div>
                                <div class="session-timer__time" id="timerDisplay">00:00:00</div>
                                <button class="gm-btn gm-btn--danger gm-btn--small" onclick="GM.stopSession()">Beenden</button>
                            </div>
                            
                            <!-- Stats -->
                            <div class="gm-card">
                                <div class="gm-card__header">
                                    <div class="gm-card__title">
                                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 20V10M12 20V4M6 20v-6"/></svg>
                                        Statistiken
                                    </div>
                                </div>
                                <div class="gm-card__body">
                                    <div class="stats-grid">
                                        <div class="stat-card">
                                            <div class="stat-card__value stat-card__value--green" id="statOnline">0</div>
                                            <div class="stat-card__label">Online</div>
                                        </div>
                                        <div class="stat-card">
                                            <div class="stat-card__value" id="statPlayers">0</div>
                                            <div class="stat-card__label">Spieler</div>
                                        </div>
                                        <div class="stat-card">
                                            <div class="stat-card__value stat-card__value--purple" id="statChars">0</div>
                                            <div class="stat-card__label">Charaktere</div>
                                        </div>
                                        <div class="stat-card">
                                            <div class="stat-card__value stat-card__value--orange" id="statDice">0</div>
                                            <div class="stat-card__label">W√ºrfe heute</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Quick Actions -->
                            <div class="gm-card">
                                <div class="gm-card__header">
                                    <div class="gm-card__title">
                                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"/></svg>
                                        Schnellzugriff
                                    </div>
                                </div>
                                <div class="gm-card__body">
                                    <div class="quick-actions">
                                        <a href="broadcast.html" class="quick-action">
                                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 2L11 13M22 2l-7 20-4-9-9-4 20-7z"/></svg>
                                            Broadcast
                                        </a>
                                        <a href="dice.html" class="quick-action">
                                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="2" y="2" width="20" height="20" rx="2"/><circle cx="8" cy="8" r="1.5" fill="currentColor"/><circle cx="16" cy="16" r="1.5" fill="currentColor"/></svg>
                                            W√ºrfeln
                                        </a>
                                        <a href="chat.html" class="quick-action">
                                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/></svg>
                                            Chat
                                        </a>
                                        <a href="map.html" class="quick-action">
                                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polygon points="1 6 1 22 8 18 16 22 23 18 23 2 16 6 8 2 1 6"/></svg>
                                            Karte
                                        </a>
                                        <a href="notes.html" class="quick-action">
                                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/></svg>
                                            Notizen
                                        </a>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- ==================== SPIELER ==================== -->
                        <div class="gm-panel" id="panel-players">
                            <div class="gm-card">
                                <div class="gm-card__header">
                                    <div class="gm-card__title">
                                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>
                                        Charaktere & HP
                                    </div>
                                </div>
                                <div class="gm-card__body">
                                    <div class="char-grid" id="charGrid">
                                        <div class="empty"><div class="spinner"></div><p>Lade Charaktere...</p></div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="gm-card">
                                <div class="gm-card__header">
                                    <div class="gm-card__title">
                                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M16 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="8.5" cy="7" r="4"/><polyline points="17 11 19 13 23 9"/></svg>
                                        GM √ºbertragen
                                    </div>
                                </div>
                                <div class="gm-card__body">
                                    <div class="transfer-box">
                                        <select id="transferSelect"><option value="">Spieler w√§hlen...</option></select>
                                        <button id="transferBtn" onclick="GM.transferGM()" disabled>√úbertragen</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- ==================== LOGS ==================== -->
                        <div class="gm-panel" id="panel-logs">
                            <div class="gm-grid">
                                <div>
                                    <div class="gm-card">
                                        <div class="gm-card__header">
                                            <div class="gm-card__title">
                                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="2" y="2" width="20" height="20" rx="2"/></svg>
                                                W√ºrfel-Log
                                            </div>
                                        </div>
                                        <div class="gm-card__body" style="padding: 12px;">
                                            <div class="log-list" id="diceLog">
                                                <div class="empty"><p>Noch keine W√ºrfe</p></div>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div class="gm-card">
                                        <div class="gm-card__header">
                                            <div class="gm-card__title">
                                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/></svg>
                                                Chat-Log
                                            </div>
                                        </div>
                                        <div class="gm-card__body" style="padding: 12px;">
                                            <div class="log-list" id="chatLog">
                                                <div class="empty"><p>Noch keine Nachrichten</p></div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <div>
                                    <div class="gm-card">
                                        <div class="gm-card__header">
                                            <div class="gm-card__title">
                                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M15 3h4a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2h-4M10 17l5-5-5-5M15 12H3"/></svg>
                                                Anwesenheit
                                            </div>
                                        </div>
                                        <div class="gm-card__body" style="padding: 12px;">
                                            <div class="log-list" id="presenceLog">
                                                <div class="empty"><p>Keine Aktivit√§t</p></div>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div class="gm-card">
                                        <div class="gm-card__header">
                                            <div class="gm-card__title">
                                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></svg>
                                                √Ñnderungen
                                            </div>
                                        </div>
                                        <div class="gm-card__body" style="padding: 12px;">
                                            <div class="log-list" id="changeLog">
                                                <div class="empty"><p>Keine √Ñnderungen</p></div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- ==================== SESSIONS ==================== -->
                        <div class="gm-panel" id="panel-sessions">
                            <div class="gm-card">
                                <div class="gm-card__header">
                                    <div class="gm-card__title">
                                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="4" width="18" height="18" rx="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>
                                        Sessions
                                    </div>
                                </div>
                                <div class="gm-card__body">
                                    <div class="session-list" id="sessionList">
                                        <div class="empty"><div class="spinner"></div><p>Lade Sessions...</p></div>
                                    </div>
                                    <a href="sessions.html?create=true" class="create-link">
                                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
                                        Neue Session planen
                                    </a>
                                </div>
                            </div>
                        </div>
                        
                        <!-- ==================== TOOLS ==================== -->
                        <div class="gm-panel" id="panel-tools">
                            <div class="gm-grid">
                                <div>
                                    <!-- Broadcast -->
                                    <div class="gm-card">
                                        <div class="gm-card__header">
                                            <div class="gm-card__title">
                                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 2L11 13M22 2l-7 20-4-9-9-4 20-7z"/></svg>
                                                Quick Broadcast
                                            </div>
                                            <a href="broadcast.html" class="gm-btn gm-btn--secondary gm-btn--small">Broadcast Center ‚Üí</a>
                                        </div>
                                        <div class="gm-card__body">
                                            <textarea class="gm-textarea" id="broadcastInput" placeholder="Nachricht an alle Spieler..."></textarea>
                                            <div class="broadcast-actions">
                                                <label class="broadcast-check">
                                                    <input type="checkbox" id="broadcastSound">
                                                    üîî Mit Sound
                                                </label>
                                                <button class="gm-btn" onclick="GM.sendBroadcast()">
                                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="22" y1="2" x2="11" y2="13"/><polygon points="22 2 15 22 11 13 2 9 22 2"/></svg>
                                                    Senden
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <!-- Quick Poll -->
                                    <div class="gm-card">
                                        <div class="gm-card__header">
                                            <div class="gm-card__title">
                                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 20V10M12 20V4M6 20v-6"/></svg>
                                                Quick-Poll
                                            </div>
                                        </div>
                                        <div class="gm-card__body">
                                            <div class="poll-active" id="pollActive" style="display:none;">
                                                <div class="poll-active__header">
                                                    <div>
                                                        <div class="poll-active__label">AKTIVE UMFRAGE</div>
                                                        <div class="poll-active__question" id="pollQuestion">-</div>
                                                    </div>
                                                    <div class="poll-active__actions">
                                                        <button class="poll-active__resolve" onclick="GM.resolvePoll()">üèÜ Aufl√∂sen</button>
                                                        <button class="poll-active__close" onclick="GM.closePoll()">‚úï</button>
                                                    </div>
                                                </div>
                                                <div id="pollActiveImage" style="display:none; margin-bottom: 12px;">
                                                    <img src="" alt="Poll Image" style="width:100%; border-radius:8px;">
                                                </div>
                                                <div class="poll-results" id="pollResults"></div>
                                            </div>
                                            
                                            <div id="pollCreate">
                                                <input type="text" class="gm-input" id="pollInput" placeholder="Frage eingeben..." style="margin-bottom: 16px;">
                                                <div class="poll-types">
                                                    <label><input type="radio" name="pollType" value="yesno" checked onchange="GM.toggleCustomOptions()"> Ja / Nein</label>
                                                    <label><input type="radio" name="pollType" value="abc" onchange="GM.toggleCustomOptions()"> A / B / C</label>
                                                    <label><input type="radio" name="pollType" value="numbers" onchange="GM.toggleCustomOptions()"> 1-5</label>
                                                    <label><input type="radio" name="pollType" value="custom" onchange="GM.toggleCustomOptions()"> ‚úèÔ∏è Custom</label>
                                                </div>
                                                <div class="poll-settings">
                                                    <label><input type="checkbox" id="pollSound" checked> üîî Mit Sound</label>
                                                </div>
                                                <div class="poll-custom" id="pollCustomOptions">
                                                    <div class="poll-image-upload">
                                                        <span class="poll-image-upload__label">Bild (optional, 350√ó160)</span>
                                                        <div class="poll-image-upload__area" id="pollImageArea" onclick="document.getElementById('pollImageInput').click()">
                                                            <div class="poll-image-upload__placeholder" id="pollImagePlaceholder">
                                                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><rect x="3" y="3" width="18" height="18" rx="2"/><circle cx="8.5" cy="8.5" r="1.5"/><path d="M21 15l-5-5L5 21"/></svg>
                                                                <span>Klicken zum Hochladen</span>
                                                            </div>
                                                            <img id="pollImagePreview" class="poll-image-upload__preview" style="display:none;">
                                                            <button type="button" class="poll-image-upload__remove" id="pollImageRemove" style="display:none;" onclick="event.stopPropagation(); GM.removePollImage()">‚úï</button>
                                                        </div>
                                                        <input type="file" id="pollImageInput" accept="image/*" onchange="GM.handlePollImage(event)">
                                                    </div>
                                                    <div id="pollOptionsContainer">
                                                        <div class="poll-option-row" data-index="0">
                                                            <div class="poll-option-row__emoji">
                                                                <button type="button" class="poll-option-row__emoji-btn" onclick="GM.toggleEmojiPicker(0)">‚ûä</button>
                                                                <div class="emoji-picker" id="emojiPicker0"></div>
                                                            </div>
                                                            <input type="text" class="poll-option-row__input" placeholder="Option 1" data-option="0">
                                                        </div>
                                                        <div class="poll-option-row" data-index="1">
                                                            <div class="poll-option-row__emoji">
                                                                <button type="button" class="poll-option-row__emoji-btn" onclick="GM.toggleEmojiPicker(1)">‚ûã</button>
                                                                <div class="emoji-picker" id="emojiPicker1"></div>
                                                            </div>
                                                            <input type="text" class="poll-option-row__input" placeholder="Option 2" data-option="1">
                                                        </div>
                                                    </div>
                                                    <button type="button" class="poll-add-option" onclick="GM.addPollOption()">
                                                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
                                                        Option hinzuf√ºgen
                                                    </button>
                                                </div>
                                                <button class="gm-btn gm-btn--full" onclick="GM.startPoll()" style="margin-top: 16px;">Poll starten</button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <div>
                                    <!-- GM Notizen -->
                                    <div class="gm-card">
                                        <div class="gm-card__header">
                                            <div class="gm-card__title">
                                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/></svg>
                                                GM Notizen
                                            </div>
                                        </div>
                                        <div class="gm-card__body">
                                            <div class="notes-box">
                                                <textarea class="gm-textarea" id="gmNotes" placeholder="Geheime Plot-Twists, NPC-Geheimnisse..." style="min-height: 200px;"></textarea>
                                                <span class="notes-box__status" id="notesStatus"></span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- ==================== SETTINGS ==================== -->
                        <div class="gm-panel" id="panel-settings">
                            <div class="gm-card danger-card">
                                <div class="gm-card__header">
                                    <div class="gm-card__title">
                                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"/><line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg>
                                        Gefahrenzone
                                    </div>
                                </div>
                                <div class="gm-card__body">
                                    <div class="danger-item">
                                        <div class="danger-item__info">
                                            <h4>Raum verlassen</h4>
                                            <p>Du verlierst deine GM-Rechte.</p>
                                        </div>
                                        <button class="gm-btn gm-btn--warning gm-btn--small" onclick="GM.leaveRoom()">Verlassen</button>
                                    </div>
                                    <div class="danger-item">
                                        <div class="danger-item__info">
                                            <h4>Raum l√∂schen</h4>
                                            <p>Alle Daten werden unwiderruflich gel√∂scht.</p>
                                        </div>
                                        <button class="gm-btn gm-btn--danger gm-btn--small" onclick="GM.deleteRoom()">L√∂schen</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                    </div>
                </div>
                
                <!-- Access Denied -->
                <div class="access-denied" id="accessDenied" style="display:none;">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><rect x="3" y="11" width="18" height="11" rx="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/></svg>
                    <h2>Zugriff verweigert</h2>
                    <p>Nur f√ºr den Spielleiter zug√§nglich.</p>
                    <a href="index.html">Zur√ºck zur √úbersicht</a>
                </div>
                
            </div>
        </main>
    </div>
    
    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    <script src="assets/js/firebase-config.js"></script>
    <script src="assets/js/app.js"></script>
    <script src="assets/js/room-service.js"></script>
    <script src="assets/js/layout.js"></script>
    
    <script>
        const GM = {
            roomCode: null,
            db: null,
            unsubs: [],
            members: [],
            characters: [],
            liveSession: null,
            timerInterval: null,
            presenceLog: [],
            pollEmojis: ['‚ûä','‚ûã','‚ûå','‚ûç','‚ûé','‚ûè','‚ûê','‚ûë','üÖ∞Ô∏è','üÖ±Ô∏è','‚úÖ','‚ùå','üëç','üëé','‚ù§Ô∏è','‚≠ê','üî•','üíé','üéØ','üé≤','‚öîÔ∏è','üõ°Ô∏è','üíÄ','üëë','üó°Ô∏è','üèÜ','üí∞','üé≠','üßô','üêâ','üè∞','üìú','‚ö°','üåü','üí´','üîÆ'],
            pollImageData: null,
            pollOptionCount: 2,
            
            async init() {
                this.roomCode = localStorage.getItem('rift_current_room');
                if (!this.roomCode) return;
                
                document.getElementById('roomCodeDisplay').textContent = this.roomCode.replace(/(.{3})(.{3})/, '$1-$2');
                this.setupTabs();
                this.setupEvents();
                
                await this.waitForFirebase();
                this.db = RIFT.firebase.getFirestore();
                
                this.subMembers();
                this.subSessions();
                this.subCharacters();
                this.subDice();
                this.subChat();
                this.subPoll();
                this.subChangelog();
                this.loadNotes();
            },
            
            waitForFirebase(t=8000) {
                return new Promise(r => {
                    const s = Date.now();
                    const c = () => RIFT?.firebase?.getFirestore?.() ? r(true) : Date.now()-s>t ? r(false) : setTimeout(c,100);
                    c();
                });
            },
            
            ref() { 
                const code = this.roomCode.replace('-','').toUpperCase();
                return this.db.collection('rooms').doc(code); 
            },
            
            setupTabs() {
                document.querySelectorAll('.gm-tab').forEach(tab => {
                    tab.addEventListener('click', () => {
                        document.querySelectorAll('.gm-tab').forEach(t => t.classList.remove('active'));
                        tab.classList.add('active');
                        document.querySelectorAll('.gm-panel').forEach(c => c.classList.remove('active'));
                        document.getElementById('panel-' + tab.dataset.tab)?.classList.add('active');
                    });
                });
            },
            
            setupEvents() {
                document.getElementById('transferSelect')?.addEventListener('change', e => {
                    document.getElementById('transferBtn').disabled = !e.target.value;
                });
                document.getElementById('broadcastInput')?.addEventListener('keydown', e => {
                    if (e.key === 'Enter' && e.ctrlKey) this.sendBroadcast();
                });
                document.getElementById('pollInput')?.addEventListener('keydown', e => {
                    if (e.key === 'Enter') this.startPoll();
                });
                let nt;
                document.getElementById('gmNotes')?.addEventListener('input', () => {
                    clearTimeout(nt);
                    document.getElementById('notesStatus').textContent = 'Speichert...';
                    document.getElementById('notesStatus').className = 'notes-box__status notes-box__status--saving';
                    nt = setTimeout(() => this.saveNotes(), 800);
                });
            },
            
            // MEMBERS
            subMembers() {
                const u = RIFT.rooms.subscribeToMembers(this.roomCode, m => {
                    m.forEach(mem => {
                        const old = this.members.find(o => o.id === mem.id);
                        if (!old) this.addPresence(mem.displayName || mem.name || '?', 'join');
                        else if (old.online !== mem.online) this.addPresence(mem.displayName || mem.name || '?', mem.online ? 'join' : 'leave');
                    });
                    this.members.forEach(old => {
                        if (!m.find(n => n.id === old.id)) this.addPresence(old.displayName || old.name || '?', 'leave');
                    });
                    this.members = m;
                    this.updateTransfer();
                    document.getElementById('statOnline').textContent = m.filter(x => x.online).length;
                    document.getElementById('statPlayers').textContent = m.length;
                });
                this.unsubs.push(u);
            },
            
            updateTransfer() {
                const s = document.getElementById('transferSelect');
                const uid = firebase?.auth()?.currentUser?.uid;
                const list = this.members.filter(m => m.role !== 'gm' && m.id !== uid);
                s.innerHTML = '<option value="">Spieler w√§hlen...</option>' + list.map(m => `<option value="${m.id}">${m.displayName || m.name || '?'}</option>`).join('');
            },
            
            async transferGM() {
                const s = document.getElementById('transferSelect');
                if (!s.value || !confirm('GM √ºbertragen?')) return;
                try {
                    const uid = firebase.auth().currentUser?.uid;
                    await this.ref().collection('members').doc(s.value).update({ role: 'gm' });
                    await this.ref().collection('members').doc(uid).update({ role: 'player' });
                    await this.ref().update({ gmId: s.value });
                    this.toast('GM √ºbertragen!', 'success');
                    setTimeout(() => location.href = 'index.html', 1500);
                } catch (e) { this.toast('Fehler', 'error'); }
            },
            
            // CHARACTERS
            subCharacters() {
                const u = this.ref().collection('characters').onSnapshot(snap => {
                    this.characters = snap.docs.map(d => ({ id: d.id, ...d.data() }));
                    this.renderChars();
                    document.getElementById('statChars').textContent = this.characters.length;
                }, () => {});
                this.unsubs.push(u);
            },
            
            renderChars() {
                const g = document.getElementById('charGrid');
                if (!this.characters.length) { g.innerHTML = '<div class="empty"><p>Keine Charaktere</p></div>'; return; }
                
                g.innerHTML = this.characters.map(c => {
                    const name = c.name || c.characterName || 'Unbenannt';
                    const cls = c.class || c.characterClass || c.klasse || '-';
                    const lvl = c.level || c.stufe || '-';
                    const color = c.color || '#8b5cf6';
                    const hp = c.hp ?? c.currentHP ?? c.currentHp ?? 0;
                    const max = (c.maxHp ?? c.maxHP ?? c.hpMax ?? hp) || 1;
                    const pct = Math.round((hp / max) * 100);
                    const hpClass = pct > 50 ? 'high' : pct > 25 ? 'mid' : 'low';
                    const owner = this.members.find(m => m.id === c.owner || m.id === c.userId);
                    const online = owner?.online === true;
                    
                    return `<div class="char-card">
                        <div class="char-card__header">
                            <div class="char-card__avatar" style="background:${color}">${name[0].toUpperCase()}</div>
                            <div class="char-card__info">
                                <div class="char-card__name">${name}</div>
                                <div class="char-card__meta">${cls} Lvl ${lvl}</div>
                            </div>
                            <div class="char-card__online ${online ? '' : 'char-card__online--offline'}"></div>
                        </div>
                        <div class="hp-section">
                            <div class="hp-header"><span class="hp-header__label">HP</span><span class="hp-header__value">${hp} / ${max}</span></div>
                            <div class="hp-bar"><div class="hp-bar__fill hp-bar__fill--${hpClass}" style="width:${pct}%"></div></div>
                            <div class="hp-controls">
                                <input type="number" id="hp-${c.id}" value="5" min="1" max="999">
                                <button class="hp-btn hp-btn--dmg" onclick="GM.modHP('${c.id}',-1)">‚àíDmg</button>
                                <button class="hp-btn hp-btn--heal" onclick="GM.modHP('${c.id}',1)">+Heal</button>
                            </div>
                        </div>
                    </div>`;
                }).join('');
            },
            
            async modHP(id, dir) {
                const input = document.getElementById('hp-' + id);
                const amt = parseInt(input.value) || 0;
                const c = this.characters.find(x => x.id === id);
                if (!c) return;
                const hp = c.hp ?? c.currentHP ?? c.currentHp ?? 0;
                const max = c.maxHp ?? c.maxHP ?? c.hpMax ?? 100;
                const newHP = Math.max(0, Math.min(max, hp + (amt * dir)));
                try {
                    await this.ref().collection('characters').doc(id).update({ hp: newHP, currentHP: newHP, currentHp: newHP });
                } catch (e) { this.toast('Fehler', 'error'); }
            },
            
            // SESSIONS
            subSessions() {
                const u = RIFT.rooms.subscribeToSessions(this.roomCode, s => {
                    this.renderSessions(s);
                    const live = s.find(x => x.status === 'live');
                    this.updateTimer(live);
                });
                this.unsubs.push(u);
            },
            
            renderSessions(sessions) {
                const l = document.getElementById('sessionList');
                if (!sessions.length) { l.innerHTML = '<div class="empty"><p>Keine Sessions geplant</p></div>'; return; }
                const sorted = [...sessions].sort((a,b) => new Date(a.date) - new Date(b.date));
                const mon = ['Jan','Feb','M√§r','Apr','Mai','Jun','Jul','Aug','Sep','Okt','Nov','Dez'];
                const hasLive = sessions.some(s => s.status === 'live');
                
                l.innerHTML = sorted.map(s => {
                    const d = new Date(s.date);
                    const live = s.status === 'live';
                    return `<div class="session-item">
                        <div class="session-item__date"><span class="session-item__day">${d.getDate()}</span><span class="session-item__month">${mon[d.getMonth()]}</span></div>
                        <div class="session-item__info"><div class="session-item__name">${s.name || 'Session'}</div><div class="session-item__time">${s.time || '20:00'} Uhr</div></div>
                        ${live ? '<span class="session-item__live">Live</span>' : `<button class="session-item__start" onclick="GM.startSession('${s.id}','${(s.name||'').replace(/'/g,"\\'")}')" ${hasLive?'disabled':''}><svg viewBox="0 0 24 24" fill="currentColor"><polygon points="5 3 19 12 5 21"/></svg></button>`}
                    </div>`;
                }).join('');
            },
            
            updateTimer(live) {
                const t = document.getElementById('sessionTimer');
                if (live) {
                    this.liveSession = live;
                    t.style.display = 'flex';
                    document.getElementById('timerName').textContent = live.name || 'Session';
                    if (this.timerInterval) clearInterval(this.timerInterval);
                    const start = live.startedAt?.toDate?.() || new Date(live.startedAt) || new Date();
                    this.timerInterval = setInterval(() => {
                        const diff = Math.floor((Date.now() - start.getTime()) / 1000);
                        const h = Math.floor(diff / 3600).toString().padStart(2, '0');
                        const m = Math.floor((diff % 3600) / 60).toString().padStart(2, '0');
                        const s = (diff % 60).toString().padStart(2, '0');
                        document.getElementById('timerDisplay').textContent = `${h}:${m}:${s}`;
                    }, 1000);
                } else {
                    t.style.display = 'none';
                    if (this.timerInterval) { clearInterval(this.timerInterval); this.timerInterval = null; }
                }
            },
            
            async startSession(id, name) {
                if (!confirm(`"${name}" starten?`)) return;
                try {
                    await this.ref().collection('sessions').doc(id).update({ status: 'live', startedAt: firebase.firestore.FieldValue.serverTimestamp() });
                    this.toast('Session gestartet!', 'success');
                } catch (e) { this.toast('Fehler', 'error'); }
            },
            
            async stopSession() {
                if (!this.liveSession || !confirm('Session beenden?')) return;
                try {
                    await this.ref().collection('sessions').doc(this.liveSession.id).update({ status: 'completed', endedAt: firebase.firestore.FieldValue.serverTimestamp() });
                    this.toast('Session beendet!', 'success');
                } catch (e) { this.toast('Fehler', 'error'); }
            },
            
            // LOGS
            subDice() {
                const today = new Date(); today.setHours(0,0,0,0);
                const u = this.ref().collection('dice').orderBy('timestamp','desc').limit(30).onSnapshot(snap => {
                    const rolls = snap.docs.map(d => d.data());
                    this.renderDice(rolls);
                    document.getElementById('statDice').textContent = rolls.filter(r => r.timestamp?.toDate?.() >= today).length;
                }, () => {});
                this.unsubs.push(u);
            },
            
            renderDice(rolls) {
                const el = document.getElementById('diceLog');
                if (!rolls.length) { el.innerHTML = '<div class="empty"><p>Noch keine W√ºrfe</p></div>'; return; }
                el.innerHTML = rolls.map(r => {
                    const t = r.timestamp?.toDate?.() || new Date();
                    return `<div class="log-item">
                        <span class="log-item__time">${t.toLocaleTimeString('de-DE',{hour:'2-digit',minute:'2-digit'})}</span>
                        <div class="log-item__icon log-item__icon--dice">üé≤</div>
                        <div class="log-item__content"><span class="log-item__user">${r.userName || r.user || '?'}</span> w√ºrfelt ${r.diceType || r.dice || '?'}:<span class="log-item__result">${r.result ?? r.total ?? '?'}</span></div>
                    </div>`;
                }).join('');
            },
            
            subChat() {
                const u = this.ref().collection('chat').orderBy('timestamp','desc').limit(30).onSnapshot(snap => {
                    this.renderChat(snap.docs.map(d => d.data()));
                }, () => {});
                this.unsubs.push(u);
            },
            
            renderChat(msgs) {
                const el = document.getElementById('chatLog');
                if (!msgs.length) { el.innerHTML = '<div class="empty"><p>Noch keine Nachrichten</p></div>'; return; }
                el.innerHTML = msgs.map(m => {
                    const t = m.timestamp?.toDate?.() || new Date();
                    const txt = (m.message || m.text || '').substring(0, 80);
                    return `<div class="log-item">
                        <span class="log-item__time">${t.toLocaleTimeString('de-DE',{hour:'2-digit',minute:'2-digit'})}</span>
                        <div class="log-item__icon log-item__icon--chat">üí¨</div>
                        <div class="log-item__content"><span class="log-item__user">${m.userName || m.user || '?'}</span>: ${txt}${txt.length >= 80 ? '...' : ''}</div>
                    </div>`;
                }).join('');
            },
            
            addPresence(name, type) {
                this.presenceLog.unshift({ name, type, time: new Date() });
                if (this.presenceLog.length > 50) this.presenceLog.pop();
                this.renderPresence();
            },
            
            renderPresence() {
                const el = document.getElementById('presenceLog');
                if (!this.presenceLog.length) { el.innerHTML = '<div class="empty"><p>Keine Aktivit√§t</p></div>'; return; }
                el.innerHTML = this.presenceLog.map(p => {
                    const isJoin = p.type === 'join';
                    return `<div class="log-item">
                        <span class="log-item__time">${p.time.toLocaleTimeString('de-DE',{hour:'2-digit',minute:'2-digit'})}</span>
                        <div class="log-item__icon log-item__icon--${isJoin ? 'join' : 'leave'}">${isJoin ? '‚Üí' : '‚Üê'}</div>
                        <div class="log-item__content"><span class="log-item__user">${p.name}</span> ist ${isJoin ? 'beigetreten' : 'gegangen'}</div>
                    </div>`;
                }).join('');
            },
            
            subChangelog() {
                const u = this.ref().collection('changelog').orderBy('timestamp','desc').limit(30).onSnapshot(snap => {
                    this.renderChangelog(snap.docs.map(d => d.data()));
                }, () => {});
                this.unsubs.push(u);
            },
            
            renderChangelog(changes) {
                const el = document.getElementById('changeLog');
                if (!changes.length) { el.innerHTML = '<div class="empty"><p>Keine √Ñnderungen</p></div>'; return; }
                el.innerHTML = changes.map(c => {
                    const t = c.timestamp?.toDate?.() || new Date();
                    return `<div class="log-item">
                        <span class="log-item__time">${t.toLocaleTimeString('de-DE',{hour:'2-digit',minute:'2-digit'})}</span>
                        <div class="log-item__icon log-item__icon--edit">‚úèÔ∏è</div>
                        <div class="log-item__content"><span class="log-item__user">${c.playerName || '?'}</span> √§nderte <strong>${c.field}</strong><br><small style="opacity:0.5">${c.characterName || ''}</small></div>
                    </div>`;
                }).join('');
            },
            
            // BROADCAST
            async sendBroadcast() {
                const msg = document.getElementById('broadcastInput').value.trim();
                if (!msg) { this.toast('Nachricht eingeben!', 'error'); return; }
                try {
                    await this.ref().update({ broadcast: { message: msg, withSound: document.getElementById('broadcastSound').checked, timestamp: firebase.firestore.FieldValue.serverTimestamp(), id: Date.now() } });
                    document.getElementById('broadcastInput').value = '';
                    this.toast('Gesendet!', 'success');
                } catch (e) { this.toast('Fehler', 'error'); }
            },
            
            // POLL
            subPoll() {
                const u = this.ref().onSnapshot(doc => {
                    const poll = doc.data()?.poll;
                    if (poll?.active) {
                        document.getElementById('pollActive').style.display = 'block';
                        document.getElementById('pollCreate').style.display = 'none';
                        document.getElementById('pollQuestion').textContent = poll.question;
                        const imgContainer = document.getElementById('pollActiveImage');
                        if (poll.image) { imgContainer.style.display = 'block'; imgContainer.querySelector('img').src = poll.image; }
                        else { imgContainer.style.display = 'none'; }
                        this.currentPoll = poll;
                        this.updatePollResults();
                    } else {
                        document.getElementById('pollActive').style.display = 'none';
                        document.getElementById('pollCreate').style.display = 'block';
                        this.currentPoll = null;
                    }
                });
                this.unsubs.push(u);
                
                const v = this.ref().collection('poll_votes').onSnapshot(snap => {
                    this.pollVotes = snap.docs.map(d => d.data());
                    this.updatePollResults();
                });
                this.unsubs.push(v);
            },
            
            updatePollResults() {
                if (!this.currentPoll) return;
                const el = document.getElementById('pollResults');
                const options = this.currentPoll.options || [];
                const emojis = this.currentPoll.emojis || [];
                const voteCounts = {};
                options.forEach(opt => voteCounts[opt] = 0);
                (this.pollVotes || []).forEach(vote => { if (vote.option && voteCounts.hasOwnProperty(vote.option)) voteCounts[vote.option]++; });
                const total = Object.values(voteCounts).reduce((a, b) => a + b, 0) || 1;
                
                el.innerHTML = options.map((opt, i) => {
                    const count = voteCounts[opt] || 0;
                    const pct = Math.round((count / total) * 100);
                    const label = emojis[i] ? `${emojis[i]} ${opt}` : opt;
                    return `<div class="poll-result"><span class="poll-result__label">${label}</span><div class="poll-result__bar"><div class="poll-result__fill" style="width:${pct}%"></div><span class="poll-result__count">${count}</span></div></div>`;
                }).join('');
            },
            
            toggleCustomOptions() {
                const type = document.querySelector('input[name="pollType"]:checked').value;
                document.getElementById('pollCustomOptions').style.display = type === 'custom' ? 'flex' : 'none';
            },
            
            toggleEmojiPicker(index) {
                document.querySelectorAll('.emoji-picker').forEach(p => p.classList.remove('visible'));
                const picker = document.getElementById('emojiPicker' + index);
                if (!picker.innerHTML) {
                    picker.innerHTML = `<div class="emoji-picker__grid">${this.pollEmojis.map(e => `<button type="button" class="emoji-picker__btn" onclick="GM.selectEmoji(${index}, '${e}')">${e}</button>`).join('')}</div>`;
                }
                picker.classList.toggle('visible');
                setTimeout(() => {
                    const closeHandler = (e) => { if (!picker.contains(e.target) && !e.target.classList.contains('poll-option-row__emoji-btn')) { picker.classList.remove('visible'); document.removeEventListener('click', closeHandler); } };
                    document.addEventListener('click', closeHandler);
                }, 10);
            },
            
            selectEmoji(index, emoji) {
                document.querySelector(`.poll-option-row[data-index="${index}"] .poll-option-row__emoji-btn`).textContent = emoji;
                document.getElementById('emojiPicker' + index).classList.remove('visible');
            },
            
            addPollOption() {
                if (this.pollOptionCount >= 8) { this.toast('Maximum 8 Optionen', 'error'); return; }
                const container = document.getElementById('pollOptionsContainer');
                const index = this.pollOptionCount;
                const row = document.createElement('div');
                row.className = 'poll-option-row';
                row.dataset.index = index;
                row.innerHTML = `<div class="poll-option-row__emoji"><button type="button" class="poll-option-row__emoji-btn" onclick="GM.toggleEmojiPicker(${index})">${this.pollEmojis[index] || '‚≠ê'}</button><div class="emoji-picker" id="emojiPicker${index}"></div></div><input type="text" class="poll-option-row__input" placeholder="Option ${index + 1}" data-option="${index}"><button type="button" class="poll-option-row__remove" onclick="GM.removePollOption(${index})"><svg viewBox="0 0 24 24" width="18" height="18" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg></button>`;
                container.appendChild(row);
                this.pollOptionCount++;
                row.querySelector('input').focus();
            },
            
            removePollOption(index) {
                if (this.pollOptionCount <= 2) { this.toast('Mindestens 2 Optionen', 'error'); return; }
                document.querySelector(`.poll-option-row[data-index="${index}"]`)?.remove();
                this.pollOptionCount--;
            },
            
            handlePollImage(event) {
                const file = event.target.files[0];
                if (!file) return;
                if (!file.type.startsWith('image/')) { this.toast('Nur Bilder erlaubt', 'error'); return; }
                const reader = new FileReader();
                reader.onload = (e) => this.openImageCropper(e.target.result);
                reader.readAsDataURL(file);
            },
            
            openImageCropper(imageSrc) {
                const modal = document.createElement('div');
                modal.className = 'cropper-modal';
                modal.id = 'cropperModal';
                modal.innerHTML = `<div class="cropper-modal__container"><div class="cropper-modal__header"><span class="cropper-modal__title">Bild zuschneiden (350√ó160)</span><button class="cropper-modal__close" onclick="GM.closeCropper()">‚úï</button></div><div class="cropper-modal__canvas-wrap" id="cropperWrap"><img id="cropperImage" class="cropper-modal__canvas" src="${imageSrc}"></div><div class="cropper-modal__controls"><span style="font-size:12px;color:rgba(255,255,255,0.5)">Zoom:</span><input type="range" class="cropper-modal__zoom" id="cropperZoom" min="1" max="3" step="0.05" value="1" oninput="GM.updateCropperZoom(this.value)"></div><div class="cropper-modal__actions"><button class="cropper-modal__btn cropper-modal__btn--cancel" onclick="GM.closeCropper()">Abbrechen</button><button class="cropper-modal__btn cropper-modal__btn--apply" onclick="GM.applyCrop()">√úbernehmen</button></div></div>`;
                document.body.appendChild(modal);
                
                const img = document.getElementById('cropperImage');
                const wrap = document.getElementById('cropperWrap');
                img.onload = () => {
                    const wrapRect = wrap.getBoundingClientRect();
                    let scale = (img.naturalWidth / img.naturalHeight) > (350 / 160) ? wrapRect.height / img.naturalHeight : wrapRect.width / img.naturalWidth;
                    this.cropperState = { baseScale: scale, zoom: 1, offsetX: 0, offsetY: 0, isDragging: false, startX: 0, startY: 0, imgWidth: img.naturalWidth, imgHeight: img.naturalHeight, wrapWidth: wrapRect.width, wrapHeight: wrapRect.height };
                    this.cropperState.offsetX = (wrapRect.width - img.naturalWidth * scale) / 2;
                    this.cropperState.offsetY = (wrapRect.height - img.naturalHeight * scale) / 2;
                    this.updateCropperTransform();
                };
                wrap.onmousedown = (e) => { e.preventDefault(); this.cropperState.isDragging = true; this.cropperState.startX = e.clientX - this.cropperState.offsetX; this.cropperState.startY = e.clientY - this.cropperState.offsetY; };
                document.onmousemove = (e) => { if (!this.cropperState?.isDragging) return; this.cropperState.offsetX = e.clientX - this.cropperState.startX; this.cropperState.offsetY = e.clientY - this.cropperState.startY; this.constrainCropper(); this.updateCropperTransform(); };
                document.onmouseup = () => { if (this.cropperState) this.cropperState.isDragging = false; };
            },
            
            constrainCropper() {
                const s = this.cropperState; if (!s) return;
                const scaledW = s.imgWidth * s.baseScale * s.zoom, scaledH = s.imgHeight * s.baseScale * s.zoom;
                s.offsetX = Math.min(0, Math.max(s.wrapWidth - scaledW, s.offsetX));
                s.offsetY = Math.min(0, Math.max(s.wrapHeight - scaledH, s.offsetY));
            },
            
            updateCropperZoom(value) {
                if (!this.cropperState) return;
                const s = this.cropperState, oldZoom = s.zoom;
                s.zoom = parseFloat(value);
                const oldScale = s.baseScale * oldZoom, newScale = s.baseScale * s.zoom;
                const centerX = s.wrapWidth / 2, centerY = s.wrapHeight / 2;
                s.offsetX = centerX - ((centerX - s.offsetX) / oldScale) * newScale;
                s.offsetY = centerY - ((centerY - s.offsetY) / oldScale) * newScale;
                this.constrainCropper();
                this.updateCropperTransform();
            },
            
            updateCropperTransform() {
                const img = document.getElementById('cropperImage'), s = this.cropperState;
                if (img && s) img.style.transform = `translate(${s.offsetX}px, ${s.offsetY}px) scale(${s.baseScale * s.zoom})`;
            },
            
            closeCropper() {
                document.getElementById('cropperModal')?.remove();
                document.getElementById('pollImageInput').value = '';
                document.onmousemove = null; document.onmouseup = null;
                this.cropperState = null;
            },
            
            applyCrop() {
                const img = document.getElementById('cropperImage'), s = this.cropperState;
                if (!img || !s) return;
                const canvas = document.createElement('canvas');
                canvas.width = 350; canvas.height = 160;
                const ctx = canvas.getContext('2d'), scale = s.baseScale * s.zoom;
                ctx.drawImage(img, -s.offsetX / scale, -s.offsetY / scale, s.wrapWidth / scale, s.wrapHeight / scale, 0, 0, 350, 160);
                this.pollImageData = canvas.toDataURL('image/jpeg', 0.85);
                document.getElementById('pollImagePreview').src = this.pollImageData;
                document.getElementById('pollImagePreview').style.display = 'block';
                document.getElementById('pollImagePlaceholder').style.display = 'none';
                document.getElementById('pollImageRemove').style.display = 'flex';
                document.getElementById('pollImageArea').classList.add('has-image');
                this.closeCropper();
                this.toast('Bild zugeschnitten', 'success');
            },
            
            removePollImage() {
                this.pollImageData = null;
                document.getElementById('pollImagePreview').style.display = 'none';
                document.getElementById('pollImagePlaceholder').style.display = 'flex';
                document.getElementById('pollImageRemove').style.display = 'none';
                document.getElementById('pollImageArea').classList.remove('has-image');
                document.getElementById('pollImageInput').value = '';
            },
            
            async startPoll() {
                const q = document.getElementById('pollInput').value.trim();
                if (!q) { this.toast('Frage eingeben!', 'error'); return; }
                const type = document.querySelector('input[name="pollType"]:checked').value;
                const withSound = document.getElementById('pollSound').checked;
                let options = [], emojis = [];
                
                if (type === 'yesno') { options = ['Ja', 'Nein']; emojis = ['‚úÖ', '‚ùå']; }
                else if (type === 'abc') { options = ['A', 'B', 'C']; emojis = ['üÖ∞Ô∏è', 'üÖ±Ô∏è', '¬©Ô∏è']; }
                else if (type === 'numbers') { options = ['1', '2', '3', '4', '5']; emojis = ['‚ûä', '‚ûã', '‚ûå', '‚ûç', '‚ûé']; }
                else if (type === 'custom') {
                    document.querySelectorAll('#pollOptionsContainer .poll-option-row').forEach(row => {
                        const text = row.querySelector('.poll-option-row__input').value.trim();
                        if (text) { options.push(text); emojis.push(row.querySelector('.poll-option-row__emoji-btn').textContent); }
                    });
                    if (options.length < 2) { this.toast('Mindestens 2 Optionen!', 'error'); return; }
                }
                
                try {
                    const votesSnap = await this.ref().collection('poll_votes').get();
                    const batch = this.db.batch();
                    votesSnap.docs.forEach(doc => batch.delete(doc.ref));
                    if (votesSnap.docs.length) await batch.commit();
                    
                    const pollData = { question: q, options, emojis, withSound, votes: {}, active: true, timestamp: firebase.firestore.FieldValue.serverTimestamp() };
                    if (type === 'custom' && this.pollImageData) pollData.image = this.pollImageData;
                    await this.ref().update({ poll: pollData });
                    
                    document.getElementById('pollInput').value = '';
                    this.resetCustomPollForm();
                    this.toast('Poll gestartet!', 'success');
                } catch (e) { this.toast('Fehler', 'error'); console.error(e); }
            },
            
            resetCustomPollForm() {
                this.removePollImage();
                document.getElementById('pollOptionsContainer').innerHTML = `<div class="poll-option-row" data-index="0"><div class="poll-option-row__emoji"><button type="button" class="poll-option-row__emoji-btn" onclick="GM.toggleEmojiPicker(0)">‚ûä</button><div class="emoji-picker" id="emojiPicker0"></div></div><input type="text" class="poll-option-row__input" placeholder="Option 1" data-option="0"></div><div class="poll-option-row" data-index="1"><div class="poll-option-row__emoji"><button type="button" class="poll-option-row__emoji-btn" onclick="GM.toggleEmojiPicker(1)">‚ûã</button><div class="emoji-picker" id="emojiPicker1"></div></div><input type="text" class="poll-option-row__input" placeholder="Option 2" data-option="1"></div>`;
                this.pollOptionCount = 2;
            },
            
            async closePoll() {
                try {
                    // Save to history first
                    if (this.currentPoll) {
                        const options = this.currentPoll.options || [];
                        const emojis = this.currentPoll.emojis || [];
                        const voteCounts = {};
                        options.forEach(opt => voteCounts[opt] = 0);
                        (this.pollVotes || []).forEach(vote => { if (vote.option && voteCounts.hasOwnProperty(vote.option)) voteCounts[vote.option]++; });
                        const results = options.map((opt, i) => ({ option: opt, emoji: emojis[i] || '', votes: voteCounts[opt] }));
                        const historyEntry = { question: this.currentPoll.question, options, emojis, results, totalVotes: Object.values(voteCounts).reduce((a, b) => a + b, 0), resolvedAt: Date.now() };
                        const doc = await this.ref().get();
                        const currentHistory = doc.data()?.pollHistory || [];
                        await this.ref().update({ 'poll.active': false, pollHistory: [historyEntry, ...currentHistory].slice(0, 10) });
                    } else {
                        await this.ref().update({ 'poll.active': false });
                    }
                    this.toast('Poll geschlossen', 'success');
                } catch (e) { this.toast('Fehler', 'error'); }
            },
            
            async resolvePoll() {
                if (!this.currentPoll) return;
                try {
                    const options = this.currentPoll.options || [];
                    const emojis = this.currentPoll.emojis || [];
                    const voteCounts = {};
                    options.forEach(opt => voteCounts[opt] = 0);
                    (this.pollVotes || []).forEach(vote => { if (vote.option && voteCounts.hasOwnProperty(vote.option)) voteCounts[vote.option]++; });
                    const maxVotes = Math.max(...Object.values(voteCounts), 0);
                    const results = options.map((opt, i) => ({ option: opt, emoji: emojis[i] || '', votes: voteCounts[opt], isWinner: voteCounts[opt] === maxVotes && maxVotes > 0 }));
                    const totalVotes = Object.values(voteCounts).reduce((a, b) => a + b, 0);
                    
                    const historyEntry = { question: this.currentPoll.question, options, emojis, results, totalVotes, resolvedAt: Date.now() };
                    const doc = await this.ref().get();
                    const currentHistory = doc.data()?.pollHistory || [];
                    
                    await this.ref().update({ poll: { ...this.currentPoll, active: false, resolved: true, results, totalVotes, resolvedAt: Date.now() }, pollHistory: [historyEntry, ...currentHistory].slice(0, 10) });
                    this.toast('Poll aufgel√∂st!', 'success');
                } catch (e) { this.toast('Fehler', 'error'); console.error(e); }
            },
            
            // NOTES
            loadNotes() {
                const saved = localStorage.getItem(`rift_gm_notes_${this.roomCode}`);
                if (saved) document.getElementById('gmNotes').value = saved;
            },
            
            saveNotes() {
                localStorage.setItem(`rift_gm_notes_${this.roomCode}`, document.getElementById('gmNotes').value);
                document.getElementById('notesStatus').textContent = '‚úì Gespeichert';
                document.getElementById('notesStatus').className = 'notes-box__status notes-box__status--saved';
                setTimeout(() => document.getElementById('notesStatus').textContent = '', 2000);
            },
            
            // DANGER ZONE
            async leaveRoom() {
                if (!confirm('Raum verlassen?')) return;
                try {
                    await this.ref().collection('members').doc(firebase.auth().currentUser?.uid).delete();
                    localStorage.removeItem('rift_current_room');
                    this.toast('Verlassen', 'success');
                    setTimeout(() => location.href = 'login.html', 1000);
                } catch (e) { this.toast('Fehler', 'error'); }
            },
            
            async deleteRoom() {
                if (!confirm('‚ö†Ô∏è Alles unwiderruflich l√∂schen?')) return;
                try {
                    const subs = ['members','sessions','characters','chat','dice','notes','whiteboard','markers','changelog','poll_votes','status_responses'];
                    for (const sub of subs) {
                        const snap = await this.ref().collection(sub).get();
                        const batch = this.db.batch();
                        snap.docs.forEach(d => batch.delete(d.ref));
                        if (snap.docs.length) await batch.commit();
                    }
                    await this.ref().delete();
                    localStorage.removeItem('rift_current_room');
                    this.toast('Gel√∂scht!', 'success');
                    setTimeout(() => location.href = 'login.html', 1500);
                } catch (e) { this.toast('Fehler', 'error'); }
            },
            
            // HELPERS
            copyCode() { navigator.clipboard.writeText(this.roomCode).then(() => this.toast('Kopiert!', 'success')); },
            toast(msg, type='info') { window.RIFT?.ui?.Toast?.[type]?.(msg) || console.log(`[${type}] ${msg}`); },
            cleanup() { this.unsubs.forEach(u => u?.()); if (this.timerInterval) clearInterval(this.timerInterval); }
        };
        
        window.addEventListener('beforeunload', () => GM.cleanup());
        
        // ACCESS CHECK
        (async function() {
            const gm = document.getElementById('gmContent');
            const denied = document.getElementById('accessDenied');
            const code = localStorage.getItem('rift_current_room');
            const user = JSON.parse(localStorage.getItem('rift_user') || '{}');
            
            function show() { gm.style.display = 'block'; denied.style.display = 'none'; }
            function deny() { gm.style.display = 'none'; denied.style.display = 'flex'; }
            
            try {
                await new Promise((r,j) => {
                    const s = Date.now();
                    const c = () => RIFT?.rooms && RIFT?.firebase?.getFirestore?.() ? r() : Date.now()-s>8000 ? j() : setTimeout(c,100);
                    c();
                });
                await new Promise(r => firebase?.auth()?.currentUser ? r() : firebase.auth().onAuthStateChanged(u => r(u)));
                if (!code) { deny(); return; }
                let isGM = false;
                try { isGM = await RIFT.rooms.isUserGM(code); } catch { isGM = user.isGM === true; }
                if (isGM) { show(); GM.init(); } else { deny(); }
            } catch { if (user.isGM && code) { show(); GM.init(); } else { deny(); } }
        })();
        
        initLayout();
    </script>
</body>
</html>
