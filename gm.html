<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <meta name="view-transition" content="same-origin">
    <title>RIFT ‚Äì GM Optionen</title>
    
    <link rel="stylesheet" href="assets/css/core.css">
    <link rel="stylesheet" href="assets/css/ui.css">
    <link rel="stylesheet" href="assets/css/sidebar.css">
    <link rel="stylesheet" href="assets/css/topbar.css">
    <link rel="stylesheet" href="assets/css/footer.css">
    <link rel="stylesheet" href="assets/css/settings.css">
    <link rel="stylesheet" href="assets/css/gm.css">
</head>
<body>
    <div class="app">
        <main class="main">
            <div class="main__content">
                
                <!-- GM Dashboard -->
                <div class="gm-dashboard" id="gmContent">
                    
                    <!-- Hero Section -->
                    <div class="gm-hero">
                        <div class="gm-hero__info">
                            <div class="gm-hero__badge">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/>
                                </svg>
                                Game Master
                            </div>
                            <h1 class="gm-hero__title">GM Optionen</h1>
                            <p class="gm-hero__session">Raum: <strong id="roomCodeDisplay">---</strong></p>
                        </div>
                        <div class="gm-hero__actions">
                            <button class="gm-code-btn" id="copyCodeBtn">
                                <span id="roomCodeCopy">---</span>
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <rect x="9" y="9" width="13" height="13" rx="2" ry="2"/>
                                    <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"/>
                                </svg>
                            </button>
                            <button class="gm-code-btn" id="copyInviteBtn" style="background: var(--accent);">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width:18px;height:18px;">
                                    <path d="M16 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/>
                                    <circle cx="8.5" cy="7" r="4"/>
                                    <line x1="20" y1="8" x2="20" y2="14"/>
                                    <line x1="23" y1="11" x2="17" y2="11"/>
                                </svg>
                                Einladen
                            </button>
                        </div>
                    </div>
                    
                    <!-- Bento Grid -->
                    <div class="gm-grid">
                        
                        <!-- Room Info Card -->
                        <div class="gm-card gm-card--wide">
                            <div class="gm-card__header">
                                <div class="gm-card__icon gm-card__icon--blue">
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/>
                                        <polyline points="9 22 9 12 15 12 15 22"/>
                                    </svg>
                                </div>
                                <span class="gm-card__title">Raum-Info</span>
                            </div>
                            <div class="room-info-grid">
                                <div class="room-info-item">
                                    <span class="room-info-item__label">Erstellt am</span>
                                    <span class="room-info-item__value" id="roomCreated">L√§dt...</span>
                                </div>
                                <div class="room-info-item">
                                    <span class="room-info-item__label">Regelwerk</span>
                                    <span class="room-info-item__value" id="roomRuleset">-</span>
                                </div>
                                <div class="room-info-item">
                                    <span class="room-info-item__label">Spieler</span>
                                    <span class="room-info-item__value room-info-item__value--success" id="roomPlayers">0 / 0</span>
                                </div>
                                <div class="room-info-item">
                                    <span class="room-info-item__label">Sessions</span>
                                    <span class="room-info-item__value" id="roomSessions">0</span>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Players Card -->
                        <div class="gm-card gm-card--tall">
                            <div class="gm-card__header">
                                <div class="gm-card__icon gm-card__icon--green">
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/>
                                        <circle cx="9" cy="7" r="4"/>
                                        <path d="M23 21v-2a4 4 0 0 0-3-3.87"/>
                                        <path d="M16 3.13a4 4 0 0 1 0 7.75"/>
                                    </svg>
                                </div>
                                <span class="gm-card__title">Spieler <span id="playerCount" style="opacity:0.5;font-weight:400;">(0)</span></span>
                            </div>
                            <div class="players-list" id="playersList">
                                <div class="players-loading" style="padding: 40px 20px; text-align: center; color: rgba(255,255,255,0.4);">
                                    <div class="spinner" style="width:24px;height:24px;border:2px solid rgba(255,255,255,0.1);border-top-color:var(--accent);border-radius:50%;animation:spin 1s linear infinite;margin:0 auto 12px;"></div>
                                    Spieler werden geladen...
                                </div>
                            </div>
                            <button class="invite-row" id="invitePlayerBtn">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <line x1="12" y1="5" x2="12" y2="19"/>
                                    <line x1="5" y1="12" x2="19" y2="12"/>
                                </svg>
                                Spieler einladen
                            </button>
                        </div>
                        
                        <!-- Sessions Card -->
                        <div class="gm-card gm-card--tall">
                            <div class="gm-card__header">
                                <div class="gm-card__icon gm-card__icon--purple">
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <rect x="3" y="4" width="18" height="18" rx="2" ry="2"/>
                                        <line x1="16" y1="2" x2="16" y2="6"/>
                                        <line x1="8" y1="2" x2="8" y2="6"/>
                                        <line x1="3" y1="10" x2="21" y2="10"/>
                                    </svg>
                                </div>
                                <span class="gm-card__title">Sessions <span id="sessionCount" style="opacity:0.5;font-weight:400;">(0)</span></span>
                                <button class="session-control-btn" id="sessionControlBtn" style="display:none;">
                                    <span class="session-control-btn__icon" id="sessionControlIcon"></span>
                                    <span id="sessionControlText">Session starten</span>
                                </button>
                            </div>
                            <!-- Active Session Banner -->
                            <div class="active-session-banner" id="activeSessionBanner" style="display:none;">
                                <div class="active-session-banner__pulse"></div>
                                <div class="active-session-banner__info">
                                    <span class="active-session-banner__label">LIVE</span>
                                    <span class="active-session-banner__name" id="activeSessionName">-</span>
                                </div>
                                <button class="active-session-banner__stop" id="stopSessionBtn" title="Session beenden">
                                    <svg viewBox="0 0 24 24" fill="currentColor"><rect x="6" y="6" width="12" height="12" rx="2"/></svg>
                                </button>
                            </div>
                            <div class="sessions-list" id="sessionsList">
                                <div class="sessions-loading" style="padding: 40px 20px; text-align: center; color: rgba(255,255,255,0.4);">
                                    <div class="spinner" style="width:24px;height:24px;border:2px solid rgba(255,255,255,0.1);border-top-color:var(--accent);border-radius:50%;animation:spin 1s linear infinite;margin:0 auto 12px;"></div>
                                    Sessions werden geladen...
                                </div>
                            </div>
                            <a href="sessions.html?create=true" class="invite-row">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <line x1="12" y1="5" x2="12" y2="19"/>
                                    <line x1="5" y1="12" x2="19" y2="12"/>
                                </svg>
                                Neue Session erstellen
                            </a>
                        </div>
                        
                        <!-- Quick Actions Card -->
                        <div class="gm-card gm-card--wide">
                            <div class="gm-card__header">
                                <div class="gm-card__icon gm-card__icon--yellow">
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"/>
                                    </svg>
                                </div>
                                <span class="gm-card__title">Schnellaktionen</span>
                            </div>
                            <div class="quick-actions-grid">
                                <a href="sessions.html" class="quick-action-btn">
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <rect x="3" y="4" width="18" height="18" rx="2" ry="2"/>
                                        <line x1="16" y1="2" x2="16" y2="6"/>
                                        <line x1="8" y1="2" x2="8" y2="6"/>
                                        <line x1="3" y1="10" x2="21" y2="10"/>
                                    </svg>
                                    Sessions verwalten
                                </a>
                                <a href="dice.html" class="quick-action-btn">
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <rect x="2" y="2" width="20" height="20" rx="2"/>
                                        <circle cx="8" cy="8" r="1.5" fill="currentColor"/>
                                        <circle cx="16" cy="8" r="1.5" fill="currentColor"/>
                                        <circle cx="8" cy="16" r="1.5" fill="currentColor"/>
                                        <circle cx="16" cy="16" r="1.5" fill="currentColor"/>
                                        <circle cx="12" cy="12" r="1.5" fill="currentColor"/>
                                    </svg>
                                    W√ºrfeln
                                </a>
                                <a href="chat.html" class="quick-action-btn">
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/>
                                    </svg>
                                    Chat √∂ffnen
                                </a>
                                <a href="map.html" class="quick-action-btn">
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <polygon points="1 6 1 22 8 18 16 22 23 18 23 2 16 6 8 2 1 6"/>
                                        <line x1="8" y1="2" x2="8" y2="18"/>
                                        <line x1="16" y1="6" x2="16" y2="22"/>
                                    </svg>
                                    Karte √∂ffnen
                                </a>
                            </div>
                        </div>
                        
                        <!-- Broadcast Card -->
                        <div class="gm-card">
                            <div class="gm-card__header">
                                <div class="gm-card__icon gm-card__icon--orange">
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"/>
                                        <circle cx="12" cy="12" r="3"/>
                                    </svg>
                                </div>
                                <span class="gm-card__title">Broadcast</span>
                            </div>
                            <div class="broadcast-content">
                                <textarea class="broadcast-input" id="broadcastInput" placeholder="Nachricht an alle Spieler..." rows="2"></textarea>
                                <div class="broadcast-actions">
                                    <label class="broadcast-checkbox">
                                        <input type="checkbox" id="broadcastSound">
                                        <span>üîî Mit Sound</span>
                                    </label>
                                    <button class="broadcast-send-btn" id="broadcastSendBtn">
                                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                            <line x1="22" y1="2" x2="11" y2="13"/>
                                            <polygon points="22 2 15 22 11 13 2 9 22 2"/>
                                        </svg>
                                        Senden
                                    </button>
                                </div>
                            </div>
                        </div>
                        
                        <!-- GM Notizen Card -->
                        <div class="gm-card">
                            <div class="gm-card__header">
                                <div class="gm-card__icon gm-card__icon--cyan">
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
                                        <polyline points="14 2 14 8 20 8"/>
                                        <line x1="16" y1="13" x2="8" y2="13"/>
                                        <line x1="16" y1="17" x2="8" y2="17"/>
                                        <polyline points="10 9 9 9 8 9"/>
                                    </svg>
                                </div>
                                <span class="gm-card__title">GM Notizen</span>
                                <span class="gm-notes-status" id="gmNotesStatus"></span>
                            </div>
                            <div class="gm-notes-content">
                                <textarea class="gm-notes-input" id="gmNotesInput" placeholder="Private Notizen nur f√ºr dich als GM...&#10;&#10;‚Ä¢ Geheime Plot-Twists&#10;‚Ä¢ NPC-Geheimnisse&#10;‚Ä¢ Encounter-Ideen"></textarea>
                            </div>
                        </div>
                        
                        <!-- Danger Zone Card -->
                        <div class="gm-card gm-card--wide gm-card--danger">
                            <div class="gm-card__header">
                                <div class="gm-card__icon gm-card__icon--red">
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"/>
                                        <line x1="12" y1="9" x2="12" y2="13"/>
                                        <line x1="12" y1="17" x2="12.01" y2="17"/>
                                    </svg>
                                </div>
                                <span class="gm-card__title">Gefahrenzone</span>
                            </div>
                            <div class="danger-zone">
                                <!-- GM Transfer -->
                                <div class="danger-item danger-item--transfer">
                                    <div class="danger-item__info">
                                        <strong>GM √ºbertragen</strong>
                                        <p>√úbertrage die GM-Rechte an einen anderen Spieler.</p>
                                    </div>
                                    <div class="transfer-controls">
                                        <select id="transferTargetSelect" class="transfer-select">
                                            <option value="">Spieler w√§hlen...</option>
                                        </select>
                                        <button class="danger-btn danger-btn--transfer" id="transferGMBtn" disabled>
                                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width:16px;height:16px;">
                                                <path d="M16 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/>
                                                <circle cx="8.5" cy="7" r="4"/>
                                                <polyline points="17 11 19 13 23 9"/>
                                            </svg>
                                            √úbertragen
                                        </button>
                                    </div>
                                </div>
                                <div class="danger-item">
                                    <div class="danger-item__info">
                                        <strong>Raum verlassen</strong>
                                        <p>Du verl√§sst den Raum. Ein anderer Spieler wird zum GM.</p>
                                    </div>
                                    <button class="danger-btn danger-btn--warning" id="leaveRoomBtn">Verlassen</button>
                                </div>
                                <div class="danger-item">
                                    <div class="danger-item__info">
                                        <strong>Raum l√∂schen</strong>
                                        <p>Der Raum und alle Daten werden unwiderruflich gel√∂scht.</p>
                                    </div>
                                    <button class="danger-btn danger-btn--danger" id="deleteRoomBtn">L√∂schen</button>
                                </div>
                            </div>
                        </div>
                        
                    </div>
                </div>
                
                <!-- Access Denied -->
                <div class="access-denied" id="accessDenied" style="display: none;">
                    <div class="access-denied__icon">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                            <rect x="3" y="11" width="18" height="11" rx="2" ry="2"/>
                            <path d="M7 11V7a5 5 0 0 1 10 0v4"/>
                        </svg>
                    </div>
                    <h2 class="access-denied__title">Zugriff verweigert</h2>
                    <p class="access-denied__text">Diese Seite ist nur f√ºr den Spielleiter (GM) zug√§nglich.</p>
                    <a href="index.html" class="access-denied__btn">Zur√ºck zum Hub</a>
                </div>
                
            </div>
        </main>
    </div>
    
    <style>
        @keyframes spin { to { transform: rotate(360deg); } }
        
        .quick-actions-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
        }
        
        .quick-action-btn {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
            padding: 20px 16px;
            background: rgba(255,255,255,0.03);
            border: 1px solid rgba(255,255,255,0.06);
            border-radius: 12px;
            color: rgba(255,255,255,0.7);
            text-decoration: none;
            font-size: 13px;
            transition: all 0.2s ease;
        }
        
        .quick-action-btn:hover {
            background: rgba(255,255,255,0.06);
            border-color: rgba(255,255,255,0.1);
            color: white;
        }
        
        .quick-action-btn svg {
            width: 24px;
            height: 24px;
            opacity: 0.7;
        }
        
        .danger-zone {
            display: flex;
            flex-direction: column;
            gap: 16px;
        }
        
        .danger-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 16px;
            padding: 16px;
            background: rgba(255,70,85,0.05);
            border: 1px solid rgba(255,70,85,0.1);
            border-radius: 12px;
        }
        
        .danger-item__info strong {
            display: block;
            color: white;
            margin-bottom: 4px;
        }
        
        .danger-item__info p {
            color: rgba(255,255,255,0.5);
            font-size: 13px;
            margin: 0;
        }
        
        .danger-btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            white-space: nowrap;
        }
        
        .danger-btn--warning {
            background: rgba(255,200,0,0.1);
            color: #ffc800;
        }
        
        .danger-btn--warning:hover {
            background: rgba(255,200,0,0.2);
        }
        
        .danger-btn--danger {
            background: rgba(255,70,85,0.1);
            color: var(--accent);
        }
        
        .danger-btn--danger:hover {
            background: rgba(255,70,85,0.2);
        }
        
        .gm-card--danger {
            border-color: rgba(255,70,85,0.2);
        }
        
        .sessions-list, .players-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
            max-height: 300px;
            overflow-y: auto;
        }
        
        .session-row {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px;
            background: rgba(255,255,255,0.03);
            border-radius: 10px;
            text-decoration: none;
            color: white;
            transition: background 0.2s ease;
        }
        
        .session-row:hover {
            background: rgba(255,255,255,0.06);
        }
        
        .session-row__date {
            display: flex;
            flex-direction: column;
            align-items: center;
            min-width: 45px;
            padding: 6px 8px;
            background: rgba(255,255,255,0.05);
            border-radius: 8px;
            font-size: 11px;
            line-height: 1.3;
        }
        
        .session-row__date-day {
            font-weight: 700;
            font-size: 16px;
        }
        
        .session-row__info {
            flex: 1;
            min-width: 0;
        }
        
        .session-row__name {
            font-weight: 600;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .session-row__meta {
            font-size: 12px;
            color: rgba(255,255,255,0.5);
        }
        
        .session-row__status {
            padding: 4px 8px;
            border-radius: 6px;
            font-size: 11px;
            font-weight: 600;
        }
        
        .session-row__status--planned { background: rgba(139,92,246,0.2); color: #a78bfa; }
        .session-row__status--live { background: rgba(34,197,94,0.2); color: #22c55e; }
        
        /* Interactive Session Row */
        .session-row--interactive {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 0;
            background: rgba(255,255,255,0.03);
            border-radius: 10px;
            transition: background 0.2s ease;
        }
        
        .session-row--interactive:hover {
            background: rgba(255,255,255,0.06);
        }
        
        .session-row__link {
            flex: 1;
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px;
            text-decoration: none;
            color: white;
        }
        
        .session-start-btn {
            width: 36px;
            height: 36px;
            margin-right: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(34,197,94,0.15);
            border: none;
            border-radius: 8px;
            color: #22c55e;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .session-start-btn:hover:not(:disabled) {
            background: rgba(34,197,94,0.3);
            transform: scale(1.05);
        }
        
        .session-start-btn:disabled {
            opacity: 0.3;
            cursor: not-allowed;
        }
        
        .session-start-btn svg {
            width: 14px;
            height: 14px;
        }
        
        .sessions-empty, .players-empty {
            padding: 40px 20px;
            text-align: center;
            color: rgba(255,255,255,0.4);
        }
        
        .sessions-empty svg, .players-empty svg {
            width: 48px;
            height: 48px;
            margin-bottom: 12px;
            opacity: 0.3;
        }
        
        .gm-card__icon--purple {
            background: rgba(139, 92, 246, 0.15);
            color: #a78bfa;
        }
        
        /* GM Transfer Styles */
        .danger-item--transfer {
            flex-wrap: wrap;
        }
        
        .transfer-controls {
            display: flex;
            gap: 8px;
            width: 100%;
            margin-top: 12px;
        }
        
        .transfer-select {
            flex: 1;
            padding: 10px 12px;
            background: rgba(0,0,0,0.3);
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 8px;
            color: white;
            font-size: 14px;
            cursor: pointer;
        }
        
        .transfer-select:focus {
            outline: none;
            border-color: var(--accent);
        }
        
        .transfer-select option {
            background: #1a1a1a;
            color: white;
        }
        
        .danger-btn--transfer {
            display: flex;
            align-items: center;
            gap: 6px;
            background: rgba(139,92,246,0.15);
            color: #a78bfa;
        }
        
        .danger-btn--transfer:hover:not(:disabled) {
            background: rgba(139,92,246,0.25);
        }
        
        .danger-btn--transfer:disabled {
            opacity: 0.4;
            cursor: not-allowed;
        }
        
        /* Session Control Styles */
        .gm-card__header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 16px;
        }
        
        .session-control-btn {
            margin-left: auto;
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 6px 12px;
            background: rgba(34,197,94,0.15);
            border: none;
            border-radius: 6px;
            color: #22c55e;
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .session-control-btn:hover {
            background: rgba(34,197,94,0.25);
        }
        
        .session-control-btn--live {
            background: rgba(255,70,85,0.15);
            color: var(--accent);
        }
        
        .session-control-btn--live:hover {
            background: rgba(255,70,85,0.25);
        }
        
        .session-control-btn__icon::before {
            content: '‚ñ∂';
        }
        
        .session-control-btn--live .session-control-btn__icon::before {
            content: '‚ñ†';
        }
        
        /* Active Session Banner */
        .active-session-banner {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px;
            margin-bottom: 12px;
            background: linear-gradient(135deg, rgba(34,197,94,0.15), rgba(34,197,94,0.05));
            border: 1px solid rgba(34,197,94,0.3);
            border-radius: 10px;
        }
        
        .active-session-banner__pulse {
            width: 10px;
            height: 10px;
            background: #22c55e;
            border-radius: 50%;
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.5; transform: scale(1.2); }
        }
        
        .active-session-banner__info {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 2px;
        }
        
        .active-session-banner__label {
            font-size: 10px;
            font-weight: 700;
            color: #22c55e;
            letter-spacing: 1px;
        }
        
        .active-session-banner__name {
            font-size: 14px;
            font-weight: 600;
            color: white;
        }
        
        .active-session-banner__stop {
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(255,70,85,0.15);
            border: none;
            border-radius: 8px;
            color: var(--accent);
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .active-session-banner__stop:hover {
            background: rgba(255,70,85,0.3);
        }
        
        .active-session-banner__stop svg {
            width: 16px;
            height: 16px;
        }
        
        /* Broadcast Styles */
        .gm-card__icon--orange {
            background: rgba(249,115,22,0.15);
            color: #fb923c;
        }
        
        .broadcast-content {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }
        
        .broadcast-input {
            width: 100%;
            padding: 12px;
            background: rgba(0,0,0,0.3);
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 10px;
            color: white;
            font-size: 14px;
            font-family: inherit;
            resize: none;
        }
        
        .broadcast-input:focus {
            outline: none;
            border-color: var(--accent);
        }
        
        .broadcast-input::placeholder {
            color: rgba(255,255,255,0.3);
        }
        
        .broadcast-actions {
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        
        .broadcast-checkbox {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 13px;
            color: rgba(255,255,255,0.6);
            cursor: pointer;
        }
        
        .broadcast-checkbox input {
            accent-color: var(--accent);
        }
        
        .broadcast-send-btn {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 10px 16px;
            background: var(--accent);
            border: none;
            border-radius: 8px;
            color: white;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .broadcast-send-btn:hover {
            filter: brightness(1.1);
            transform: translateY(-1px);
        }
        
        .broadcast-send-btn svg {
            width: 16px;
            height: 16px;
        }
        
        /* GM Notizen Styles */
        .gm-card__icon--cyan {
            background: rgba(6,182,212,0.15);
            color: #22d3ee;
        }
        
        .gm-notes-status {
            margin-left: auto;
            font-size: 11px;
            color: rgba(255,255,255,0.4);
        }
        
        .gm-notes-status--saving {
            color: #fbbf24;
        }
        
        .gm-notes-status--saved {
            color: #22c55e;
        }
        
        .gm-notes-content {
            display: flex;
            flex-direction: column;
        }
        
        .gm-notes-input {
            width: 100%;
            min-height: 120px;
            padding: 12px;
            background: rgba(0,0,0,0.3);
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 10px;
            color: white;
            font-size: 14px;
            font-family: inherit;
            line-height: 1.5;
            resize: vertical;
        }
        
        .gm-notes-input:focus {
            outline: none;
            border-color: rgba(6,182,212,0.5);
        }
        
        .gm-notes-input::placeholder {
            color: rgba(255,255,255,0.25);
        }
    </style>
    
    <!-- Firebase Scripts -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    <script src="assets/js/firebase-config.js"></script>
    <script src="assets/js/app.js"></script>
    <script src="assets/js/user-service.js"></script>
    <script src="assets/js/room-service.js"></script>
    <script src="assets/js/layout.js"></script>
    
    <script>
        // ========================================
        // GM DASHBOARD - FUNKTIONAL
        // ========================================
        
        const GMDash = {
            roomCode: null,
            members: [],
            sessions: [],
            room: null,
            unsubscribeMembers: null,
            unsubscribeSessions: null,
            
            // ----------------------------------------
            // INITIALIZATION
            // ----------------------------------------
            async init() {
                console.log('[GM] Initializing...');
                
                this.roomCode = localStorage.getItem('rift_current_room');
                if (!this.roomCode) {
                    console.error('[GM] No room code!');
                    return;
                }
                
                // Update room code displays
                const formatted = this.roomCode.replace(/(.{3})(.{3})/, '$1-$2');
                document.getElementById('roomCodeDisplay').textContent = formatted;
                document.getElementById('roomCodeCopy').textContent = formatted;
                
                // Setup event listeners
                this.setupEventListeners();
                
                // Wait for Firebase to be ready
                await this.waitForFirebase();
                
                // Load data
                await this.loadRoomInfo();
                this.subscribeToMembers();
                this.subscribeToSessions();
                await this.loadGMNotes();
            },
            
            // ----------------------------------------
            // WAIT FOR FIREBASE
            // ----------------------------------------
            waitForFirebase(timeout = 5000) {
                return new Promise((resolve) => {
                    const start = Date.now();
                    const check = () => {
                        const db = RIFT?.firebase?.getFirestore?.();
                        if (db) {
                            console.log('[GM] Firebase ready');
                            resolve(true);
                        } else if (Date.now() - start > timeout) {
                            console.warn('[GM] Firebase timeout, proceeding anyway');
                            resolve(false);
                        } else {
                            setTimeout(check, 100);
                        }
                    };
                    check();
                });
            },
            
            // ----------------------------------------
            // EVENT LISTENERS
            // ----------------------------------------
            setupEventListeners() {
                // Copy code button
                document.getElementById('copyCodeBtn')?.addEventListener('click', () => {
                    navigator.clipboard.writeText(this.roomCode).then(() => {
                        this.showToast('Raum-Code kopiert!', 'success');
                    });
                });
                
                // Copy invite link button
                document.getElementById('copyInviteBtn')?.addEventListener('click', () => {
                    const url = `${window.location.origin}/login.html?room=${this.roomCode}`;
                    navigator.clipboard.writeText(url).then(() => {
                        this.showToast('Einladungslink kopiert!', 'success');
                    });
                });
                
                // Invite player button
                document.getElementById('invitePlayerBtn')?.addEventListener('click', () => {
                    const url = `${window.location.origin}/login.html?room=${this.roomCode}`;
                    navigator.clipboard.writeText(url).then(() => {
                        this.showToast('Einladungslink kopiert!', 'success');
                    });
                });
                
                // Leave room button
                document.getElementById('leaveRoomBtn')?.addEventListener('click', () => this.leaveRoom());
                
                // Delete room button
                document.getElementById('deleteRoomBtn')?.addEventListener('click', () => this.deleteRoom());
                
                // GM Transfer
                document.getElementById('transferTargetSelect')?.addEventListener('change', (e) => {
                    document.getElementById('transferGMBtn').disabled = !e.target.value;
                });
                document.getElementById('transferGMBtn')?.addEventListener('click', () => this.transferGM());
                
                // Session Control
                document.getElementById('stopSessionBtn')?.addEventListener('click', () => this.stopSession());
                
                // Broadcast
                document.getElementById('broadcastSendBtn')?.addEventListener('click', () => this.sendBroadcast());
                document.getElementById('broadcastInput')?.addEventListener('keydown', (e) => {
                    if (e.key === 'Enter' && e.ctrlKey) this.sendBroadcast();
                });
                
                // GM Notes - Auto-save with debounce
                let notesTimeout;
                document.getElementById('gmNotesInput')?.addEventListener('input', () => {
                    clearTimeout(notesTimeout);
                    document.getElementById('gmNotesStatus').textContent = 'Speichert...';
                    document.getElementById('gmNotesStatus').className = 'gm-notes-status gm-notes-status--saving';
                    notesTimeout = setTimeout(() => this.saveGMNotes(), 1000);
                });
            },
            
            // ----------------------------------------
            // LOAD ROOM INFO
            // ----------------------------------------
            async loadRoomInfo() {
                try {
                    const room = await RIFT.rooms.getRoom(this.roomCode);
                    if (!room) {
                        console.error('[GM] Room not found');
                        return;
                    }
                    
                    this.room = room;
                    
                    // Created date
                    if (room.createdAt) {
                        const date = room.createdAt.toDate ? room.createdAt.toDate() : new Date(room.createdAt);
                        document.getElementById('roomCreated').textContent = date.toLocaleDateString('de-DE', {
                            day: '2-digit', month: '2-digit', year: 'numeric', hour: '2-digit', minute: '2-digit'
                        });
                    }
                    
                    // Ruleset
                    const rulesetNames = {
                        '5e2024': 'D&D 5E (2024)',
                        'worldsapart': 'Worlds Apart',
                        'htbah': 'How To Be A Hero',
                        'cyberpunk': 'Cyberpunk Red'
                    };
                    document.getElementById('roomRuleset').textContent = rulesetNames[room.ruleset] || room.ruleset || '-';
                    
                    console.log('[GM] Room loaded:', room.name);
                } catch (e) {
                    console.error('[GM] Failed to load room:', e);
                }
            },
            
            // ----------------------------------------
            // MEMBERS SUBSCRIPTION
            // ----------------------------------------
            subscribeToMembers() {
                if (this.unsubscribeMembers) this.unsubscribeMembers();
                
                console.log('[GM] Subscribing to members...');
                
                this.unsubscribeMembers = RIFT.rooms.subscribeToMembers(this.roomCode, (members) => {
                    console.log('[GM] Members update:', members.length, members);
                    this.members = members;
                    this.renderPlayers(members);
                    this.updateTransferDropdown();
                    
                    // Update counts
                    const onlineCount = members.filter(m => m.online === true).length;
                    document.getElementById('roomPlayers').textContent = `${onlineCount} / ${members.length}`;
                    document.getElementById('playerCount').textContent = `(${members.length})`;
                });
            },
            
            // ----------------------------------------
            // RENDER PLAYERS
            // ----------------------------------------
            renderPlayers(members) {
                const list = document.getElementById('playersList');
                if (!list) return;
                
                const currentUserId = firebase?.auth()?.currentUser?.uid;
                
                if (members.length === 0) {
                    list.innerHTML = `
                        <div class="players-empty">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                                <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/>
                                <circle cx="9" cy="7" r="4"/>
                                <path d="M23 21v-2a4 4 0 0 0-3-3.87"/>
                                <path d="M16 3.13a4 4 0 0 1 0 7.75"/>
                            </svg>
                            <p>Noch keine Spieler im Raum</p>
                        </div>
                    `;
                    return;
                }
                
                list.innerHTML = members.map(member => {
                    const name = member.displayName || member.name || 'Unbekannt';
                    const color = member.color || '#8B5CF6';
                    const initial = name.charAt(0).toUpperCase();
                    const isGM = member.role === 'gm';
                    const isYou = member.id === currentUserId;
                    const isOnline = member.online === true;
                    
                    return `
                        <div class="player-row">
                            <div class="player-row__avatar ${isOnline ? '' : 'player-row__avatar--offline'}" style="background: ${color};">${initial}</div>
                            <div class="player-row__info">
                                <div class="player-row__name">${name}</div>
                                <div class="player-row__role">${isGM ? 'Game Master' : 'Spieler'}${isOnline ? '' : ' ¬∑ Offline'}</div>
                            </div>
                            ${isGM ? '<span class="player-row__badge player-row__badge--gm">GM</span>' : ''}
                            ${isYou ? '<span class="player-row__badge player-row__badge--you">Du</span>' : ''}
                            ${!isGM && !isYou ? `
                                <button class="player-row__action" onclick="GMDash.kickPlayer('${member.id}', '${name.replace(/'/g, "\\'")}')" title="Spieler entfernen">
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <line x1="18" y1="6" x2="6" y2="18"/>
                                        <line x1="6" y1="6" x2="18" y2="18"/>
                                    </svg>
                                </button>
                            ` : ''}
                        </div>
                    `;
                }).join('');
            },
            
            // ----------------------------------------
            // SESSIONS SUBSCRIPTION
            // ----------------------------------------
            subscribeToSessions() {
                if (this.unsubscribeSessions) this.unsubscribeSessions();
                
                console.log('[GM] Subscribing to sessions...');
                
                this.unsubscribeSessions = RIFT.rooms.subscribeToSessions(this.roomCode, (sessions) => {
                    console.log('[GM] Sessions update:', sessions.length);
                    this.sessions = sessions;
                    this.renderSessions(sessions);
                    
                    // Update count
                    document.getElementById('roomSessions').textContent = sessions.length;
                    document.getElementById('sessionCount').textContent = `(${sessions.length})`;
                    
                    // Check for active session
                    const activeSession = sessions.find(s => s.status === 'live');
                    this.updateSessionUI(activeSession);
                    if (activeSession) {
                        localStorage.setItem('rift_active_session', activeSession.id);
                    }
                });
            },
            
            // ----------------------------------------
            // RENDER SESSIONS
            // ----------------------------------------
            renderSessions(sessions) {
                const list = document.getElementById('sessionsList');
                if (!list) return;
                
                if (sessions.length === 0) {
                    list.innerHTML = `
                        <div class="sessions-empty">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                                <rect x="3" y="4" width="18" height="18" rx="2" ry="2"/>
                                <line x1="16" y1="2" x2="16" y2="6"/>
                                <line x1="8" y1="2" x2="8" y2="6"/>
                                <line x1="3" y1="10" x2="21" y2="10"/>
                            </svg>
                            <p>Noch keine Sessions erstellt</p>
                        </div>
                    `;
                    return;
                }
                
                // Sort by date (upcoming first)
                const sorted = [...sessions].sort((a, b) => new Date(a.date) - new Date(b.date));
                const months = ['Jan', 'Feb', 'M√§r', 'Apr', 'Mai', 'Jun', 'Jul', 'Aug', 'Sep', 'Okt', 'Nov', 'Dez'];
                const hasLive = sessions.some(s => s.status === 'live');
                
                list.innerHTML = sorted.map(session => {
                    const date = new Date(session.date);
                    const day = date.getDate();
                    const month = months[date.getMonth()];
                    const isLive = session.status === 'live';
                    const statusClass = isLive ? 'live' : 'planned';
                    const statusText = isLive ? 'Live' : 'Geplant';
                    const safeName = (session.name || 'Unbenannte Session').replace(/'/g, "\\'");
                    
                    return `
                        <div class="session-row session-row--interactive">
                            <a href="session.html?id=${session.id}" class="session-row__link">
                                <div class="session-row__date">
                                    <span class="session-row__date-day">${day}</span>
                                    <span>${month}</span>
                                </div>
                                <div class="session-row__info">
                                    <div class="session-row__name">${session.name || 'Unbenannte Session'}</div>
                                    <div class="session-row__meta">${session.time || '20:00'} Uhr</div>
                                </div>
                            </a>
                            ${isLive ? `
                                <span class="session-row__status session-row__status--live">Live</span>
                            ` : `
                                <button class="session-start-btn" onclick="event.stopPropagation(); GMDash.startSession('${session.id}', '${safeName}')" ${hasLive ? 'disabled title="Bereits eine Session aktiv"' : ''}>
                                    <svg viewBox="0 0 24 24" fill="currentColor"><polygon points="5 3 19 12 5 21 5 3"/></svg>
                                </button>
                            `}
                        </div>
                    `;
                }).join('');
            },
            
            // ----------------------------------------
            // KICK PLAYER
            // ----------------------------------------
            async kickPlayer(oderId, name) {
                if (!confirm(`${name} wirklich aus dem Raum entfernen?`)) return;
                
                try {
                    const db = RIFT.firebase.getFirestore();
                    const normalizedCode = this.roomCode.replace('-', '').toUpperCase();
                    
                    await db.collection('rooms').doc(normalizedCode)
                        .collection('members').doc(oderId).delete();
                    
                    this.showToast(`${name} wurde entfernt`, 'success');
                } catch (e) {
                    console.error('[GM] Failed to kick player:', e);
                    this.showToast('Fehler beim Entfernen', 'error');
                }
            },
            
            // ----------------------------------------
            // LEAVE ROOM
            // ----------------------------------------
            async leaveRoom() {
                if (!confirm('Raum wirklich verlassen? Du verlierst deine GM-Rechte.')) return;
                
                try {
                    const currentUserId = firebase.auth().currentUser?.uid;
                    if (!currentUserId) return;
                    
                    const db = RIFT.firebase.getFirestore();
                    const normalizedCode = this.roomCode.replace('-', '').toUpperCase();
                    
                    // Remove self from members
                    await db.collection('rooms').doc(normalizedCode)
                        .collection('members').doc(currentUserId).delete();
                    
                    // Clear local storage
                    localStorage.removeItem('rift_current_room');
                    const userData = JSON.parse(localStorage.getItem('rift_user') || '{}');
                    userData.isGM = false;
                    localStorage.setItem('rift_user', JSON.stringify(userData));
                    
                    this.showToast('Raum verlassen', 'success');
                    setTimeout(() => window.location.href = 'login.html', 1000);
                } catch (e) {
                    console.error('[GM] Failed to leave room:', e);
                    this.showToast('Fehler beim Verlassen', 'error');
                }
            },
            
            // ----------------------------------------
            // DELETE ROOM
            // ----------------------------------------
            async deleteRoom() {
                if (!confirm('‚ö†Ô∏è ACHTUNG!\n\nDer Raum und ALLE Daten werden unwiderruflich gel√∂scht!\n\nDiese Aktion kann NICHT r√ºckg√§ngig gemacht werden.\n\nFortfahren?')) return;
                
                try {
                    const db = RIFT.firebase.getFirestore();
                    const normalizedCode = this.roomCode.replace('-', '').toUpperCase();
                    const roomRef = db.collection('rooms').doc(normalizedCode);
                    
                    this.showToast('Raum wird gel√∂scht...', 'info');
                    
                    // Delete all subcollections
                    const subcollections = ['members', 'sessions', 'characters', 'chat', 'dice', 'notes', 'whiteboard', 'markers'];
                    
                    for (const subcol of subcollections) {
                        const snapshot = await roomRef.collection(subcol).get();
                        const batch = db.batch();
                        snapshot.docs.forEach(doc => batch.delete(doc.ref));
                        if (snapshot.docs.length > 0) await batch.commit();
                    }
                    
                    // Delete room document
                    await roomRef.delete();
                    
                    // Clear local storage
                    localStorage.removeItem('rift_current_room');
                    localStorage.removeItem('rift_active_session');
                    const userData = JSON.parse(localStorage.getItem('rift_user') || '{}');
                    userData.isGM = false;
                    localStorage.setItem('rift_user', JSON.stringify(userData));
                    
                    this.showToast('Raum gel√∂scht!', 'success');
                    setTimeout(() => window.location.href = 'login.html', 1500);
                } catch (e) {
                    console.error('[GM] Failed to delete room:', e);
                    this.showToast('Fehler beim L√∂schen', 'error');
                }
            },
            
            // ----------------------------------------
            // GM TRANSFER
            // ----------------------------------------
            async transferGM() {
                const select = document.getElementById('transferTargetSelect');
                const targetId = select.value;
                const targetName = select.options[select.selectedIndex].text;
                
                if (!targetId) return;
                if (!confirm(`GM-Rechte wirklich an "${targetName}" √ºbertragen?\n\nDu verlierst deine GM-Rechte und wirst zum normalen Spieler.`)) return;
                
                try {
                    const db = RIFT.firebase.getFirestore();
                    const normalizedCode = this.roomCode.replace('-', '').toUpperCase();
                    const currentUserId = firebase.auth().currentUser?.uid;
                    
                    // Update target to GM
                    await db.collection('rooms').doc(normalizedCode)
                        .collection('members').doc(targetId)
                        .update({ role: 'gm' });
                    
                    // Update self to player
                    await db.collection('rooms').doc(normalizedCode)
                        .collection('members').doc(currentUserId)
                        .update({ role: 'player' });
                    
                    // Update room gmId
                    await db.collection('rooms').doc(normalizedCode)
                        .update({ gmId: targetId });
                    
                    // Update localStorage
                    const userData = JSON.parse(localStorage.getItem('rift_user') || '{}');
                    userData.isGM = false;
                    localStorage.setItem('rift_user', JSON.stringify(userData));
                    
                    this.showToast(`GM-Rechte an ${targetName} √ºbertragen!`, 'success');
                    setTimeout(() => window.location.href = 'index.html', 1500);
                } catch (e) {
                    console.error('[GM] Transfer failed:', e);
                    this.showToast('Fehler bei der √úbertragung', 'error');
                }
            },
            
            // ----------------------------------------
            // UPDATE TRANSFER DROPDOWN
            // ----------------------------------------
            updateTransferDropdown() {
                const select = document.getElementById('transferTargetSelect');
                if (!select) return;
                
                const currentUserId = firebase?.auth()?.currentUser?.uid;
                const nonGMMembers = this.members.filter(m => m.role !== 'gm' && m.id !== currentUserId);
                
                select.innerHTML = '<option value="">Spieler w√§hlen...</option>' + 
                    nonGMMembers.map(m => `<option value="${m.id}">${m.displayName || m.name || 'Unbekannt'}</option>`).join('');
            },
            
            // ----------------------------------------
            // SESSION CONTROL
            // ----------------------------------------
            async startSession(sessionId, sessionName) {
                try {
                    const db = RIFT.firebase.getFirestore();
                    const normalizedCode = this.roomCode.replace('-', '').toUpperCase();
                    
                    // Update session status
                    await db.collection('rooms').doc(normalizedCode)
                        .collection('sessions').doc(sessionId)
                        .update({ 
                            status: 'live',
                            startedAt: firebase.firestore.FieldValue.serverTimestamp()
                        });
                    
                    // Set as active session in room
                    await db.collection('rooms').doc(normalizedCode)
                        .update({ activeSession: sessionId });
                    
                    localStorage.setItem('rift_active_session', sessionId);
                    this.showToast(`Session "${sessionName}" gestartet!`, 'success');
                } catch (e) {
                    console.error('[GM] Start session failed:', e);
                    this.showToast('Fehler beim Starten', 'error');
                }
            },
            
            async stopSession() {
                const activeId = localStorage.getItem('rift_active_session');
                if (!activeId) return;
                
                if (!confirm('Session wirklich beenden?')) return;
                
                try {
                    const db = RIFT.firebase.getFirestore();
                    const normalizedCode = this.roomCode.replace('-', '').toUpperCase();
                    
                    // Update session status
                    await db.collection('rooms').doc(normalizedCode)
                        .collection('sessions').doc(activeId)
                        .update({ 
                            status: 'completed',
                            endedAt: firebase.firestore.FieldValue.serverTimestamp()
                        });
                    
                    // Clear active session
                    await db.collection('rooms').doc(normalizedCode)
                        .update({ activeSession: null });
                    
                    localStorage.removeItem('rift_active_session');
                    this.updateSessionUI(null);
                    this.showToast('Session beendet!', 'success');
                } catch (e) {
                    console.error('[GM] Stop session failed:', e);
                    this.showToast('Fehler beim Beenden', 'error');
                }
            },
            
            updateSessionUI(activeSession) {
                const banner = document.getElementById('activeSessionBanner');
                const nameEl = document.getElementById('activeSessionName');
                
                if (activeSession) {
                    banner.style.display = 'flex';
                    nameEl.textContent = activeSession.name || 'Aktive Session';
                } else {
                    banner.style.display = 'none';
                }
            },
            
            // ----------------------------------------
            // BROADCAST
            // ----------------------------------------
            async sendBroadcast() {
                const input = document.getElementById('broadcastInput');
                const message = input.value.trim();
                const withSound = document.getElementById('broadcastSound').checked;
                
                if (!message) {
                    this.showToast('Bitte Nachricht eingeben', 'error');
                    return;
                }
                
                try {
                    const db = RIFT.firebase.getFirestore();
                    const normalizedCode = this.roomCode.replace('-', '').toUpperCase();
                    const user = firebase.auth().currentUser;
                    
                    // Add to chat as system message
                    await db.collection('rooms').doc(normalizedCode)
                        .collection('chat').add({
                            type: 'broadcast',
                            message: message,
                            senderId: user?.uid,
                            senderName: 'Game Master',
                            withSound: withSound,
                            timestamp: firebase.firestore.FieldValue.serverTimestamp()
                        });
                    
                    input.value = '';
                    this.showToast('Broadcast gesendet!', 'success');
                } catch (e) {
                    console.error('[GM] Broadcast failed:', e);
                    this.showToast('Fehler beim Senden', 'error');
                }
            },
            
            // ----------------------------------------
            // GM NOTES
            // ----------------------------------------
            async loadGMNotes() {
                try {
                    const db = RIFT.firebase.getFirestore();
                    const normalizedCode = this.roomCode.replace('-', '').toUpperCase();
                    
                    const doc = await db.collection('rooms').doc(normalizedCode)
                        .collection('gm_data').doc('notes').get();
                    
                    if (doc.exists) {
                        document.getElementById('gmNotesInput').value = doc.data().content || '';
                    }
                } catch (e) {
                    console.error('[GM] Load notes failed:', e);
                }
            },
            
            async saveGMNotes() {
                try {
                    const db = RIFT.firebase.getFirestore();
                    const normalizedCode = this.roomCode.replace('-', '').toUpperCase();
                    const content = document.getElementById('gmNotesInput').value;
                    
                    await db.collection('rooms').doc(normalizedCode)
                        .collection('gm_data').doc('notes').set({
                            content: content,
                            updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                        }, { merge: true });
                    
                    document.getElementById('gmNotesStatus').textContent = '‚úì Gespeichert';
                    document.getElementById('gmNotesStatus').className = 'gm-notes-status gm-notes-status--saved';
                    
                    setTimeout(() => {
                        document.getElementById('gmNotesStatus').textContent = '';
                    }, 2000);
                } catch (e) {
                    console.error('[GM] Save notes failed:', e);
                    document.getElementById('gmNotesStatus').textContent = '‚úó Fehler';
                }
            },
            
            // ----------------------------------------
            // TOAST HELPER
            // ----------------------------------------
            showToast(message, type = 'info') {
                if (window.RIFT?.ui?.Toast) {
                    RIFT.ui.Toast[type]?.(message) || RIFT.ui.Toast.info(message);
                } else {
                    console.log(`[Toast] ${type}: ${message}`);
                }
            },
            
            // ----------------------------------------
            // CLEANUP
            // ----------------------------------------
            cleanup() {
                if (this.unsubscribeMembers) this.unsubscribeMembers();
                if (this.unsubscribeSessions) this.unsubscribeSessions();
            }
        };
        
        // Cleanup on page unload
        window.addEventListener('beforeunload', () => GMDash.cleanup());
        
        // ========================================
        // ACCESS CHECK & INITIALIZATION
        // ========================================
        
        (async function() {
            const gmContent = document.getElementById('gmContent');
            const accessDenied = document.getElementById('accessDenied');
            const currentRoomCode = localStorage.getItem('rift_current_room');
            const userData = JSON.parse(localStorage.getItem('rift_user') || '{}');
            
            console.log('[GM] Starting...');
            
            // NICHT verstecken - soll sichtbar bleiben
            // gmContent startet sichtbar, wird nur bei !isGM versteckt
            
            function showContent() {
                console.log('[GM] showContent');
                gmContent.style.display = 'block';
                accessDenied.style.display = 'none';
            }
            
            function showDenied() {
                console.log('[GM] showDenied');
                gmContent.style.display = 'none';
                accessDenied.style.display = 'flex';
            }
            
            // Wait for RIFT with timeout
            function waitForRIFT(timeout = 8000) {
                return new Promise((resolve, reject) => {
                    const start = Date.now();
                    const check = () => {
                        // Check if RIFT, rooms, firebase, AND getFirestore() returns something
                        const db = RIFT?.firebase?.getFirestore?.();
                        if (typeof RIFT !== 'undefined' && RIFT.rooms && RIFT.firebase && db) {
                            console.log('[GM] RIFT fully ready with Firestore');
                            resolve(true);
                        } else if (Date.now() - start > timeout) {
                            reject(new Error('Timeout'));
                        } else {
                            setTimeout(check, 100);
                        }
                    };
                    check();
                });
            }
            
            // Wait for Firebase Auth
            function waitForAuth(timeout = 5000) {
                return new Promise((resolve) => {
                    if (firebase?.auth()?.currentUser) {
                        resolve(firebase.auth().currentUser);
                        return;
                    }
                    
                    const unsubscribe = firebase.auth().onAuthStateChanged(user => {
                        unsubscribe();
                        resolve(user);
                    });
                    
                    setTimeout(() => resolve(null), timeout);
                });
            }
            
            try {
                await waitForRIFT();
                console.log('[GM] RIFT ready');
                
                // Wait for auth
                const user = await waitForAuth();
                console.log('[GM] Auth user:', user?.uid);
                
                if (!currentRoomCode) {
                    console.log('[GM] No room code');
                    showDenied();
                    return;
                }
                
                if (!user) {
                    console.log('[GM] No authenticated user');
                    showDenied();
                    return;
                }
                
                // Check if user is GM
                let isGM = false;
                
                try {
                    isGM = await RIFT.rooms.isUserGM(currentRoomCode);
                    console.log('[GM] Firebase GM check result:', isGM);
                } catch (e) {
                    console.warn('[GM] Firebase check failed, using localStorage:', e);
                    isGM = userData.isGM === true;
                }
                
                if (isGM) {
                    // Update localStorage
                    userData.isGM = true;
                    localStorage.setItem('rift_user', JSON.stringify(userData));
                    
                    // Show content and init
                    showContent();
                    GMDash.init();
                } else {
                    showDenied();
                }
            } catch (e) {
                console.error('[GM] Init failed:', e);
                
                // Fallback to localStorage
                if (userData.isGM === true && currentRoomCode) {
                    showContent();
                    GMDash.init();
                } else {
                    showDenied();
                }
            }
        })();
        
        // Initialize layout
        initLayout();
    </script>
</body>
</html>
