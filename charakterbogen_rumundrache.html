<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Charakterbogen - PnP Companion</title>
    <script>(function(){var t=localStorage.getItem('pnp_theme')||'dark';document.documentElement.setAttribute('data-theme',t)})();</script>
    <link rel="icon" type="image/png" href="assets/icons/icon_favicon.png">
    <link rel="manifest" href="manifest.json">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;600;700;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="assets/css/global.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.6.1/cropper.min.css">
    <style>
        /* Module-specific styles only */

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Roboto', sans-serif;
            background: var(--md-background);
            color: var(--md-on-background);
            min-height: 100vh;
        }

        /* ===== MAIN LAYOUT ===== */
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 24px;
        }

        /* ===== PORTRAIT UPLOAD - TOP SECTION ===== */
        .portrait-upload-section {
            background: var(--md-surface-container);
            border-radius: var(--shape-lg);
            padding: 24px;
            margin-bottom: 24px;
            box-shadow: var(--elevation-2);
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .portrait-container {
            position: relative;
            width: 200px;
            height: 200px;
        }

        .portrait-preview {
            width: 100%;
            height: 100%;
            border-radius: var(--shape-lg);
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
            background: var(--md-surface-container-high);
            cursor: pointer;
            transition: all 200ms cubic-bezier(0.4, 0, 0.2, 1);
        }

        .portrait-preview:hover {
            transform: scale(1.02);
        }

        .portrait-preview img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .portrait-placeholder {
            text-align: center;
            color: var(--md-on-surface-variant);
            font-size: 12px;
            padding: 10px;
            white-space: nowrap;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 4px;
        }

        .portrait-upload-input {
            display: none;
        }

        /* Portrait Controls - Only visible when active */
        .portrait-controls {
            position: absolute;
            bottom: 8px;
            left: 50%;
            transform: translateX(-50%);
            display: none;
            gap: 8px;
        }

        .portrait-container.show-controls .portrait-controls {
            display: flex;
        }

        .portrait-btn {
            width: 40px;
            height: 40px;
            background: var(--md-surface-container-highest);
            backdrop-filter: blur(10px);
            border: none;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: var(--elevation-2);
            transition: all 200ms cubic-bezier(0.4, 0, 0.2, 1);
        }

        .portrait-btn:hover {
            transform: scale(1.1);
        }

        .portrait-btn img {
            width: 20px;
            height: 20px;
            object-fit: contain;
        }

        .portrait-btn.change {
            background: var(--md-primary);
        }

        .portrait-btn.remove {
            background: var(--md-error);
        }

        /* Portrait Divider */
        .portrait-divider {
            width: 1px;
            height: 160px;
            background: var(--md-outline-variant);
            opacity: 0.5;
            margin: 0 24px;
        }

        /* Jolly Roger Container */
        .jolly-container {
            position: relative;
            width: 200px;
            height: 120px;
        }

        .jolly-preview {
            width: 100%;
            height: 100%;
            border-radius: var(--shape-lg);
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
            background: var(--md-surface-container-high);
            cursor: pointer;
            transition: all 200ms cubic-bezier(0.4, 0, 0.2, 1);
        }

        .jolly-preview:hover {
            transform: scale(1.02);
        }

        .jolly-preview img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .jolly-placeholder {
            text-align: center;
            color: var(--md-on-surface-variant);
            font-size: 12px;
            padding: 12px;
        }

        .jolly-controls {
            position: absolute;
            bottom: 6px;
            left: 50%;
            transform: translateX(-50%);
            display: none;
            gap: 6px;
        }

        .jolly-container.show-controls .jolly-controls {
            display: flex;
        }

        .jolly-controls .portrait-btn {
            width: 32px;
            height: 32px;
        }

        .jolly-controls .portrait-btn img {
            width: 16px;
            height: 16px;
        }

        /* Crew Input */
        .jolly-wrapper {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
        }

        .crew-input-container {
            width: 200px;
        }

        .crew-input {
            width: 100%;
            background: var(--md-surface-container-high);
            border: none;
            border-radius: var(--shape-sm);
            padding: 8px 12px;
            color: var(--md-on-surface);
            font-size: 13px;
            font-family: 'Roboto', sans-serif;
            text-align: center;
        }

        .crew-input:focus {
            outline: none;
            box-shadow: 0 0 0 2px var(--md-primary);
        }

        .crew-input::placeholder {
            color: var(--md-on-surface-variant);
            opacity: 0.6;
        }

        /* Ruleset Box */
        .ruleset-box {
            background: var(--md-surface-container);
            border-radius: var(--shape-lg);
            padding: 16px 24px;
            margin-bottom: 24px;
            box-shadow: var(--elevation-2);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
        }

        .ruleset-label {
            font-size: 14px;
            color: var(--md-on-surface-variant);
        }

        .ruleset-icon {
            width: 32px;
            height: 32px;
            object-fit: contain;
        }

        .ruleset-name {
            font-size: 16px;
            font-weight: 600;
            color: var(--md-on-surface);
        }

        /* ===== HEADER SECTION ===== */
        .character-header {
            background: var(--md-surface-container);
            border-radius: var(--shape-lg);
            padding: 24px;
            margin-bottom: 24px;
            box-shadow: var(--elevation-2);
        }

        .header-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 16px;
        }

        .input-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .input-group label {
            font-size: 12px;
            font-weight: 600;
            color: var(--md-on-surface-variant);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .input-field {
            background: var(--md-surface-container-high);
            border: 1px solid var(--md-outline-variant);
            border-radius: var(--shape-md);
            padding: 12px 16px;
            color: var(--md-on-surface);
            font-size: 16px;
            font-family: 'Roboto', sans-serif;
            transition: all 200ms cubic-bezier(0.4, 0, 0.2, 1);
            width: 100%;
        }

        .input-field:focus {
            outline: none;
            border-color: var(--md-primary);
            box-shadow: 0 0 0 3px rgba(103, 80, 164, 0.1);
        }

        textarea.input-field {
            resize: vertical;
            min-height: 80px;
            font-size: 14px;
        }

        .input-row {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 16px;
        }

        /* ===== STATS SECTION ===== */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 16px;
            margin-bottom: 24px;
        }

        .stat-card {
            background: var(--md-surface-container-high);
            border-radius: var(--shape-lg);
            padding: 16px;
            position: relative;
            overflow: hidden;
        }

        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 60%;
            pointer-events: none;
            opacity: 0.12;
        }

        .stat-card.leben::before {
            background: linear-gradient(to bottom, var(--stat-leben), transparent);
        }

        .stat-card.moral::before {
            background: linear-gradient(to bottom, var(--stat-moral), transparent);
        }

        .stat-card.resonanz::before {
            background: linear-gradient(to bottom, var(--stat-resonanz), transparent);
        }

        .stat-label {
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 8px;
            color: var(--md-on-surface-variant);
        }

        .stat-input-group {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .stat-input {
            background: var(--md-surface-container-lowest);
            border: 1px solid var(--md-outline-variant);
            border-radius: var(--shape-sm);
            padding: 8px 12px;
            color: var(--md-on-surface);
            font-size: 20px;
            font-weight: 600;
            text-align: center;
            width: 90px;
            transition: all 200ms cubic-bezier(0.4, 0, 0.2, 1);
        }

        .stat-input:focus {
            outline: none;
            border-color: var(--md-primary);
        }

        .stat-separator {
            font-size: 20px;
            font-weight: 300;
            color: var(--md-on-surface-variant);
        }

        .stat-max {
            font-size: 16px;
            color: var(--md-on-surface-variant);
        }

        /* ===== PROGRESS BAR ===== */
        .progress-bar {
            height: 6px;
            background: var(--md-surface-container-lowest);
            border-radius: 3px;
            overflow: hidden;
            margin-top: 8px;
        }

        .progress-fill {
            height: 100%;
            transition: width 300ms cubic-bezier(0.4, 0, 0.2, 1);
            border-radius: 3px;
        }

        .progress-fill.leben {
            background: var(--stat-leben);
            transition: background 300ms ease, width 300ms cubic-bezier(0.4, 0, 0.2, 1);
        }

        .progress-fill.leben.warning {
            background: #f57c00;
        }

        .progress-fill.leben.critical {
            background: #b71c1c;
        }

        .progress-fill.moral {
            background: var(--stat-moral);
        }

        .progress-fill.resonanz {
            background: var(--stat-resonanz);
        }

        /* Dead Overlay - inside Leben card only */
        .stat-card.leben {
            position: relative;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        /* ===== FOKUS SYSTEM ===== */
        .fokus-section {
            background: var(--md-surface-container);
            border-radius: var(--shape-lg);
            padding: 20px;
            margin-bottom: 24px;
            box-shadow: var(--elevation-1);
        }

        .fokus-header {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 16px;
        }

        .fokus-header label {
            font-size: 14px;
            font-weight: 600;
            color: var(--md-on-surface);
        }

        .fokus-grid {
            display: grid;
            grid-template-columns: 70px 1fr 1fr 1fr;
            gap: 12px;
            align-items: stretch;
        }

        /* Desktop: Hide mobile-only elements */
        .fokus-top-row {
            display: none;
        }
        
        .fokus-type-name-mobile {
            display: none;
        }
        
        /* Desktop: Show desktop icon */
        .fokus-desktop-only {
            display: flex;
        }

        @media (max-width: 600px) {
            .fokus-grid {
                display: flex;
                flex-direction: column;
                gap: 8px;
            }
            
            .fokus-top-row {
                display: flex;
                gap: 8px;
            }
            
            /* Hide the desktop type card on mobile */
            .fokus-desktop-only {
                display: none !important;
            }
            
            .fokus-type-card {
                width: 60px;
                height: 60px;
                flex-shrink: 0;
            }
            
            .fokus-type-name-mobile {
                flex: 1;
                display: flex;
                align-items: center;
                justify-content: center;
                background: var(--md-surface-container-high);
                border-radius: var(--shape-md);
                font-size: 16px;
                font-weight: 600;
                color: var(--md-on-surface);
            }
            
            .fokus-ability-card {
                width: 100%;
            }
        }

        /* Element gradients - from top 25% fading down */
        .fokus-type-card.fire { background: linear-gradient(180deg, rgba(255, 107, 53, 0.25) 0%, var(--md-surface-container-high) 100%); }
        .fokus-type-card.water { background: linear-gradient(180deg, rgba(79, 195, 247, 0.25) 0%, var(--md-surface-container-high) 100%); }
        .fokus-type-card.wind { background: linear-gradient(180deg, rgba(178, 235, 242, 0.25) 0%, var(--md-surface-container-high) 100%); }
        .fokus-type-card.earth { background: linear-gradient(180deg, rgba(141, 110, 99, 0.25) 0%, var(--md-surface-container-high) 100%); }
        .fokus-type-card.lightning { background: linear-gradient(180deg, rgba(255, 235, 59, 0.25) 0%, var(--md-surface-container-high) 100%); }
        .fokus-type-card.room { background: linear-gradient(180deg, rgba(206, 147, 216, 0.25) 0%, var(--md-surface-container-high) 100%); }
        .fokus-type-card.illusion { background: linear-gradient(180deg, rgba(179, 157, 219, 0.25) 0%, var(--md-surface-container-high) 100%); }

        .fokus-type-card {
            aspect-ratio: 1;
            background: var(--md-surface-container-high);
            border-radius: var(--shape-md);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s;
            border: none;
            overflow: hidden;
        }

        @media (max-width: 600px) {
            .fokus-type-card {
                aspect-ratio: auto;
            }
        }

        .fokus-type-card:hover {
            transform: scale(1.05);
            box-shadow: 0 2px 8px rgba(0,0,0,0.3);
        }

        .fokus-type-card img {
            width: 44px;
            height: 44px;
        }

        .fokus-type-placeholder {
            font-size: 24px;
            color: var(--md-on-surface-variant);
        }

        .fokus-ability-card {
            background: var(--md-surface-container-high);
            border-radius: var(--shape-md);
            padding: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            text-align: center;
            min-height: 70px;
            cursor: pointer;
            transition: all 0.2s;
            border: none;
        }

        @media (max-width: 600px) {
            .fokus-ability-card {
                min-height: 50px;
                padding: 10px;
            }
        }

        .fokus-ability-card:hover:not(.locked):not(.empty) {
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
        }

        .fokus-ability-card.locked {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .fokus-ability-card.unlocked {
            opacity: 1;
            cursor: pointer;
        }

        .fokus-ability-content {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 2px;
        }

        .fokus-ability-card .fokus-ability-placeholder {
            font-size: 11px;
            color: var(--md-on-surface-variant);
        }

        .fokus-ability-card .fokus-ability-name {
            font-size: 14px;
            font-weight: 600;
            color: var(--md-on-surface);
            word-break: break-word;
            display: none;
        }

        .fokus-ability-card .fokus-ability-desc-small {
            font-size: 10px;
            color: var(--md-on-surface-variant);
            line-height: 1.3;
            display: none;
            max-width: 100%;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        @media (max-width: 600px) {
            .fokus-ability-card .fokus-ability-name {
                font-size: 13px;
            }
            .fokus-ability-card .fokus-ability-desc-small {
                font-size: 9px;
            }
        }

        .fokus-ability-card.selected {
            border: none;
            background: var(--md-surface-container-high);
        }

        /* Element-specific colors for ability cards - subtle gradient */
        .fokus-ability-card.selected.fire { background: linear-gradient(180deg, rgba(255, 107, 53, 0.25) 0%, var(--md-surface-container-high) 100%); }
        .fokus-ability-card.selected.water { background: linear-gradient(180deg, rgba(79, 195, 247, 0.25) 0%, var(--md-surface-container-high) 100%); }
        .fokus-ability-card.selected.wind { background: linear-gradient(180deg, rgba(178, 235, 242, 0.25) 0%, var(--md-surface-container-high) 100%); }
        .fokus-ability-card.selected.earth { background: linear-gradient(180deg, rgba(141, 110, 99, 0.25) 0%, var(--md-surface-container-high) 100%); }
        .fokus-ability-card.selected.lightning { background: linear-gradient(180deg, rgba(255, 235, 59, 0.25) 0%, var(--md-surface-container-high) 100%); }
        .fokus-ability-card.selected.room { background: linear-gradient(180deg, rgba(206, 147, 216, 0.25) 0%, var(--md-surface-container-high) 100%); }
        .fokus-ability-card.selected.illusion { background: linear-gradient(180deg, rgba(179, 157, 219, 0.25) 0%, var(--md-surface-container-high) 100%); }

        /* Fokus Popup */
        .fokus-popup-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.8);
            z-index: 10000;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .fokus-popup {
            background: var(--md-surface-container);
            border-radius: 16px;
            max-width: 700px;
            width: 100%;
            max-height: 85vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        .fokus-popup-header {
            padding: 20px;
            border-bottom: 1px solid var(--md-outline-variant);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .fokus-popup-title {
            font-size: 20px;
            font-weight: 600;
            color: var(--md-on-surface);
        }

        .fokus-popup-close {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            border: none;
            background: var(--md-surface-container-high);
            color: var(--md-on-surface);
            font-size: 20px;
            cursor: pointer;
        }

        .fokus-categories {
            display: flex;
            gap: 8px;
            padding: 16px 20px;
            justify-content: center;
            border-bottom: 1px solid var(--md-outline-variant);
        }

        .fokus-category-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 50px;
            height: 50px;
            padding: 8px;
            border-radius: 12px;
            border: 2px solid transparent;
            background: var(--md-surface-container-high);
            cursor: pointer;
            transition: all 0.2s;
        }

        .fokus-category-btn img {
            width: 32px;
            height: 32px;
        }

        .fokus-category-btn.active {
            border-color: var(--md-primary);
            background: color-mix(in srgb, var(--md-primary) 20%, var(--md-surface-container-high));
        }

        .fokus-popup-content {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
        }

        .fokus-category-title {
            font-size: 20px;
            font-weight: 600;
            color: var(--md-on-surface);
            text-align: center;
            padding: 16px;
            background: var(--md-surface-container-high);
            border-radius: 12px;
            margin-bottom: 20px;
        }

        .fokus-abilities-section {
            margin-bottom: 24px;
        }

        .fokus-abilities-title {
            font-size: 14px;
            font-weight: 600;
            color: var(--md-on-surface);
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .fokus-abilities-title::before {
            content: '';
            width: 4px;
            height: 16px;
            background: var(--md-primary);
            border-radius: 2px;
        }

        .fokus-abilities-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .fokus-ability-row {
            display: flex;
            gap: 12px;
            align-items: flex-start;
            padding: 12px;
            background: var(--md-surface-container-high);
            border: 2px solid transparent;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .fokus-ability-row:hover {
            border-color: var(--md-outline);
        }

        .fokus-ability-row.selected {
            border: 2px solid transparent;
            background: var(--md-surface-container-high);
        }

        /* Element-specific colors for ability rows in popup */
        .fokus-ability-row.selected.fire { background: linear-gradient(90deg, rgba(255, 107, 53, 0.25) 0%, var(--md-surface-container-high) 100%); }
        .fokus-ability-row.selected.water { background: linear-gradient(90deg, rgba(79, 195, 247, 0.25) 0%, var(--md-surface-container-high) 100%); }
        .fokus-ability-row.selected.wind { background: linear-gradient(90deg, rgba(178, 235, 242, 0.25) 0%, var(--md-surface-container-high) 100%); }
        .fokus-ability-row.selected.earth { background: linear-gradient(90deg, rgba(141, 110, 99, 0.25) 0%, var(--md-surface-container-high) 100%); }
        .fokus-ability-row.selected.lightning { background: linear-gradient(90deg, rgba(255, 235, 59, 0.25) 0%, var(--md-surface-container-high) 100%); }
        .fokus-ability-row.selected.room { background: linear-gradient(90deg, rgba(206, 147, 216, 0.25) 0%, var(--md-surface-container-high) 100%); }
        .fokus-ability-row.selected.illusion { background: linear-gradient(90deg, rgba(179, 157, 219, 0.25) 0%, var(--md-surface-container-high) 100%); }

        .fokus-ability-row.disabled {
            opacity: 0.4;
            cursor: not-allowed;
        }

        .fokus-ability-name {
            font-size: 13px;
            font-weight: 600;
            color: var(--md-on-surface);
            min-width: 140px;
            flex-shrink: 0;
        }

        .fokus-ability-desc {
            font-size: 12px;
            color: var(--md-on-surface-variant);
            line-height: 1.4;
        }

        .fokus-popup-footer {
            padding: 16px 20px;
            border-top: 1px solid var(--md-outline-variant);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .fokus-selection-info {
            font-size: 12px;
            color: var(--md-on-surface-variant);
        }

        .fokus-confirm-btn {
            padding: 10px 24px;
            background: var(--md-primary);
            color: white;
            border: none;
            border-radius: 20px;
            font-weight: 500;
            cursor: pointer;
        }

        .fokus-confirm-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* ===== TABS SYSTEM ===== */
        .tabs-container {
            background: var(--md-surface-container);
            border-radius: var(--shape-lg);
            padding: 24px;
            box-shadow: var(--elevation-2);
            margin-bottom: 24px;
        }

        .tabs-header {
            display: flex;
            gap: 8px;
            margin-bottom: 24px;
            border-bottom: 1px solid var(--md-outline-variant);
        }

        .tab-btn {
            background: transparent;
            border: none;
            padding: 12px 24px;
            color: var(--md-on-surface-variant);
            font-size: 14px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            cursor: pointer;
            position: relative;
            transition: all 200ms cubic-bezier(0.4, 0, 0.2, 1);
            font-family: 'Roboto', sans-serif;
        }

        .tab-btn:hover {
            background: rgba(103, 80, 164, 0.08);
        }

        .tab-btn.active {
            color: var(--md-primary);
        }

        .tab-btn.active::after {
            content: '';
            position: absolute;
            bottom: -1px;
            left: 0;
            right: 0;
            height: 2px;
            background: var(--md-primary);
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        /* ===== GLOBAL POINTS HEADER - SINGLE LINE ===== */
        .global-points-header {
            background: #6750A4;
            color: var(--md-on-primary);
            padding: 12px 24px;
            border-radius: var(--shape-lg);
            margin-bottom: 24px;
            box-shadow: var(--elevation-2);
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 24px;
            flex-wrap: wrap;
        }

        .global-points-title {
            font-weight: 600;
            font-size: 14px;
        }

        .global-points-info {
            display: flex;
            gap: 32px;
            align-items: center;
        }

        .global-counter {
            font-size: 13px;
            font-weight: 500;
        }

        .global-counter strong {
            font-size: 18px;
            font-weight: 700;
            margin-left: 6px;
        }

        .global-points-remaining.warning {
            color: #ffcdd2;
            animation: pulse 1s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }

        /* ===== SKILLS HEADER ===== */
        .skills-header {
            display: flex;
            justify-content: flex-end;
            align-items: center;
            margin-bottom: 16px;
        }

        .category-final-value {
            background: var(--md-primary);
            color: var(--md-on-primary);
            width: 80px;
            height: 42px;
            border-radius: var(--shape-sm);
            font-weight: 700;
            font-size: 20px;
            box-shadow: var(--elevation-2);
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 40px; /* Align with skill-value (32px delete btn + 8px gap) */
        }

        /* ===== SKILLS LIST ===== */
        .skills-grid {
            display: grid;
            gap: 12px;
        }

        .add-skill-btn {
            width: 100%;
            padding: 8px;
            margin-top: 12px;
            background: var(--md-surface-container-high);
            border: 1px dashed var(--md-outline-variant);
            border-radius: var(--shape-sm);
            color: var(--md-on-surface-variant);
            font-size: 18px;
            cursor: pointer;
            transition: all 200ms ease;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .add-skill-btn:hover {
            background: var(--md-surface-container-highest);
            border-color: var(--md-primary);
            color: var(--md-primary);
        }

        .skill-row {
            display: grid;
            grid-template-columns: 1fr 80px 32px;
            gap: 8px;
            align-items: center;
        }

        .skill-delete-btn {
            width: 28px;
            height: 28px;
            border: none;
            background: transparent;
            color: var(--md-on-surface-variant);
            cursor: pointer;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0.4;
            transition: all 150ms ease;
            font-size: 16px;
        }

        .skill-delete-btn:hover {
            opacity: 1;
            background: var(--md-error-container);
            color: var(--md-error);
        }

        .skill-name {
            background: var(--md-surface-container-high);
            border: 1px solid var(--md-outline-variant);
            border-radius: var(--shape-sm);
            padding: 12px 16px;
            color: var(--md-on-surface);
            font-size: 14px;
            font-family: 'Roboto', sans-serif;
            transition: all 200ms cubic-bezier(0.4, 0, 0.2, 1);
        }

        .skill-name:focus {
            outline: none;
            border-color: var(--md-primary);
        }

        .skill-value {
            background: var(--md-surface-container-high);
            border: 1px solid var(--md-outline-variant);
            border-radius: var(--shape-sm);
            padding: 12px 16px;
            color: var(--md-on-surface);
            font-size: 14px;
            font-weight: 600;
            text-align: center;
            font-family: 'Roboto', sans-serif;
            transition: all 200ms cubic-bezier(0.4, 0, 0.2, 1);
        }

        .skill-value:focus {
            outline: none;
            border-color: var(--md-primary);
        }

        /* ===== ZWEITE CHANCE ===== */
        .zweite-chance {
            background: var(--md-surface-container);
            border-radius: var(--shape-lg);
            padding: 24px;
            box-shadow: var(--elevation-2);
            margin-bottom: 24px;
        }

        .zweite-chance h3 {
            font-size: 14px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 16px;
            color: var(--md-on-surface-variant);
        }

        .dice-checks {
            display: flex;
            gap: 24px;
            justify-content: center;
        }

        .dice-check {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 12px;
        }

        .dice-icon {
            width: 80px;
            height: 80px;
            cursor: pointer;
            transition: all 200ms cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
        }

        .dice-icon img {
            width: 100%;
            height: 100%;
            object-fit: contain;
            transition: all 200ms cubic-bezier(0.4, 0, 0.2, 1);
        }

        .dice-icon:hover {
            transform: scale(1.05);
        }

        .dice-icon.used img {
            opacity: 0.2;
        }

        /* Dice Click Animation */
        .dice-icon.clicking {
            animation: diceUseEffect 0.5s ease-out;
        }

        @keyframes diceUseEffect {
            0% { transform: scale(1); }
            20% { transform: scale(1.2) rotate(10deg); }
            40% { transform: scale(0.8) rotate(-5deg); }
            60% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }

        .dice-icon::after {
            content: '';
            position: absolute;
            inset: -10px;
            border-radius: 50%;
            background: var(--md-primary);
            opacity: 0;
            transform: scale(0);
            pointer-events: none;
        }

        .dice-icon.clicking::after {
            animation: diceRipple 0.5s ease-out;
        }

        @keyframes diceRipple {
            0% { transform: scale(0); opacity: 0.4; }
            100% { transform: scale(2); opacity: 0; }
        }

        /* ===== INVENTAR ===== */
        .inventar-section {
            background: var(--md-surface-container);
            border-radius: var(--shape-lg);
            padding: 24px;
            box-shadow: var(--elevation-2);
            margin-bottom: 24px;
        }

        .inventar-section h3 {
            font-size: 14px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 16px;
            color: var(--md-on-surface-variant);
        }

        .inventar-textarea {
            min-height: 300px;
            width: 100%;
        }

        .currency-field {
            margin-bottom: 16px;
        }

        .currency-label {
            display: block;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 8px;
            color: var(--md-on-surface-variant);
        }

        .currency-input-group {
            display: flex;
            gap: 8px;
            align-items: center;
        }

        .currency-input {
            flex: 1;
            max-width: 200px;
        }

        .currency-type-btn {
            width: 48px;
            height: 48px;
            background: var(--md-primary);
            border: none;
            border-radius: var(--shape-md);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 200ms cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: var(--elevation-1);
        }

        .currency-type-btn:hover {
            background: color-mix(in srgb, var(--md-primary) 85%, white);
            transform: scale(1.05);
        }

        .currency-type-btn:active {
            transform: scale(0.95);
        }

        .currency-type-btn img {
            width: 28px;
            height: 28px;
            filter: brightness(0) invert(1);
            transition: transform 200ms ease;
        }

        .currency-type-btn:active img {
            transform: rotate(15deg);
        }

        /* ===== CHARACTER FILE ACTIONS ===== */
        .character-file-actions {
            background: var(--md-surface-container);
            border-radius: var(--shape-lg);
            padding: 24px;
            box-shadow: var(--elevation-2);
            margin-bottom: 24px;
        }

        .character-file-actions h3 {
            font-size: 14px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 16px;
            color: var(--md-on-surface-variant);
            text-align: center;
        }

        .file-action-buttons {
            display: flex;
            gap: 16px;
            justify-content: center;
            align-items: center;
        }

        .file-action-btn {
            background: var(--md-primary);
            color: var(--md-on-primary);
            border: none;
            padding: 12px 24px;
            border-radius: var(--shape-md);
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 200ms cubic-bezier(0.4, 0, 0.2, 1);
            font-family: 'Roboto', sans-serif;
            box-shadow: var(--elevation-2);
        }

        .file-action-btn:hover {
            background: #7c70a0;
            transform: translateY(-2px);
            box-shadow: var(--elevation-3);
        }

        .file-action-btn.danger {
            background: #d32f2f;
        }

        .file-action-btn.danger:hover {
            background: #b71c1c;
        }

        .file-action-btn img {
            width: 20px;
            height: 20px;
        }

        .char-upload-input {
            display: none;
        }

        /* ===== SAVE INDICATOR ===== */
        .save-indicator {
            position: fixed;
            bottom: 24px;
            right: 24px;
            background: var(--md-primary);
            color: var(--md-on-primary);
            padding: 12px 24px;
            border-radius: var(--shape-full);
            font-size: 14px;
            font-weight: 600;
            box-shadow: var(--elevation-3);
            opacity: 0;
            transform: translateY(20px);
            transition: all 300ms cubic-bezier(0.4, 0, 0.2, 1);
            pointer-events: none;
            z-index: 1000;
        }

        .save-indicator.show {
            opacity: 1;
            transform: translateY(0);
        }

        /* ===== POWERED BY FOOTER ===== */
        .powered-by-footer {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: var(--space-sm);
            padding: var(--space-xl) 0;
            margin-top: var(--space-xl);
            border-top: 1px solid var(--md-outline-variant);
        }

        .powered-by-footer span {
            font-size: var(--label-small);
            color: var(--md-on-surface-variant);
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .powered-by-footer a {
            transition: opacity 200ms ease, transform 200ms ease;
        }

        .powered-by-footer a:hover {
            opacity: 0.8;
            transform: scale(1.05);
        }

        .htbah-logo {
            height: 40px;
            width: auto;
        }

        /* ===== HILFE BUTTON ===== */
        .help-btn-container {
            display: flex;
            justify-content: center;
            margin: 24px 0;
        }

        .help-btn {
            background: #2b2930;
            color: var(--md-on-surface);
            border: none;
            padding: 12px 20px;
            border-radius: var(--shape-md);
            cursor: pointer;
            box-shadow: var(--elevation-2);
            transition: all 200ms cubic-bezier(0.4, 0, 0.2, 1);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .help-btn:hover {
            transform: scale(1.02);
            box-shadow: var(--elevation-3);
            background: #3a3840;
        }

        .help-btn img {
            width: 20px;
            height: 20px;
        }

        /* ===== HELP DIALOG ===== */
        .help-dialog-scrim {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.6);
            z-index: 2000;
            align-items: center;
            justify-content: center;
            padding: 24px;
        }

        .help-dialog-scrim.active {
            display: flex;
        }

        .help-dialog {
            background: var(--md-surface-container-high);
            border-radius: var(--shape-xl);
            box-shadow: var(--elevation-3);
            width: 100%;
            max-width: 900px;
            max-height: 90vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        .help-dialog-head {
            padding: 24px;
            border-bottom: 1px solid var(--md-outline-variant);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .help-dialog-title {
            font-size: 24px;
            font-weight: 500;
            color: var(--md-on-surface);
        }

        .help-close-btn {
            background: transparent;
            border: none;
            cursor: pointer;
            padding: 8px;
            border-radius: 8px;
            transition: background 0.2s;
            color: var(--md-on-surface);
            font-size: 24px;
        }

        .help-close-btn:hover {
            background: rgba(103, 80, 164, 0.1);
        }

        .help-dialog-content {
            padding: 24px;
            overflow-y: auto;
            flex: 1;
        }

        .help-tabs {
            display: flex;
            gap: 8px;
            margin-bottom: 24px;
            border-bottom: 1px solid var(--md-outline-variant);
        }

        .help-tab-btn {
            background: transparent;
            border: none;
            padding: 12px 24px;
            color: var(--md-on-surface-variant);
            font-size: 14px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            cursor: pointer;
            position: relative;
            transition: all 200ms cubic-bezier(0.4, 0, 0.2, 1);
            font-family: 'Roboto', sans-serif;
        }

        .help-tab-btn:hover {
            background: rgba(103, 80, 164, 0.08);
        }

        .help-tab-btn.active {
            color: var(--md-primary);
        }

        .help-tab-btn.active::after {
            content: '';
            position: absolute;
            bottom: -1px;
            left: 0;
            right: 0;
            height: 2px;
            background: var(--md-primary);
        }

        .help-category {
            display: none;
        }

        .help-category.active {
            display: block;
        }

        .help-skills-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 12px;
        }

        .help-skill-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 16px;
            background: var(--md-surface-container);
            border-radius: var(--shape-md);
            gap: 12px;
        }

        .help-skill-name {
            font-size: 14px;
            color: var(--md-on-surface);
            flex: 1;
        }

        .help-transfer-btn {
            background: var(--md-primary);
            color: var(--md-on-primary);
            border: none;
            padding: 6px 12px;
            border-radius: var(--shape-sm);
            font-size: 12px;
            font-weight: 500;
            cursor: pointer;
            transition: all 200ms cubic-bezier(0.4, 0, 0.2, 1);
            white-space: nowrap;
            font-family: 'Roboto', sans-serif;
        }

        .help-transfer-btn:hover {
            background: #7c70a0;
        }

        .help-transfer-btn.remove {
            background: var(--md-error);
        }

        .help-transfer-btn.remove:hover {
            background: #d32f2f;
        }

        /* ===== RESPONSIVE ===== */
        @media (max-width: 1024px) {
            .input-row {
                grid-template-columns: 1fr;
            }

            .portrait-container {
                width: 160px;
                height: 160px;
            }
        }

        @media (max-width: 768px) {
            .container {
                padding: 16px;
            }

            .portrait-container {
                width: 140px;
                height: 140px;
            }

            .stats-grid {
                grid-template-columns: repeat(3, 1fr);
                gap: 8px;
            }

            .stat-card {
                padding: 12px 8px;
            }

            .stat-label {
                font-size: 10px;
            }

            .stat-input {
                width: 60px;
                font-size: 16px;
                padding: 6px 8px;
            }

            .stat-separator {
                font-size: 14px;
            }

            .stat-max {
                font-size: 12px;
            }

            .tabs-header {
                flex-wrap: wrap;
            }

            .tab-btn {
                flex: 1;
                min-width: 100px;
            }

            .skill-row {
                grid-template-columns: 1fr 70px 28px;
                gap: 6px;
            }

            .skill-delete-btn {
                width: 24px;
                height: 24px;
                font-size: 14px;
            }

            .dice-checks {
                gap: 16px;
            }

            .dice-icon {
                width: 64px;
                height: 64px;
            }

            .global-points-info {
                flex-direction: row;
                gap: 16px;
                flex-wrap: wrap;
            }

            .global-counter strong {
                font-size: 16px;
            }

            .category-final-value {
                width: 70px;
                height: 38px;
                font-size: 16px;
                margin-right: 34px;
            }

            .help-skills-grid {
                grid-template-columns: 1fr;
            }

            .help-dialog {
                max-width: 100%;
            }

            .file-action-buttons {
                flex-direction: column;
            }

            .file-action-btn {
                width: 100%;
                justify-content: center;
            }
        }

        @media (max-width: 480px) {
            .stat-input {
                width: 50px;
                font-size: 14px;
            }
        }

        /* Print Styles */
        @media print {
            body {
                background: white !important;
                color: black !important;
            }
            
            .container {
                max-width: 100% !important;
                padding: 0 !important;
            }
            
            .nav-container,
            .fly-btn-container,
            .character-file-actions,
            .help-btn-container,
            .powered-by-footer,
            .add-skill-btn,
            .skill-delete-btn,
            .help-dialog-scrim {
                display: none !important;
            }
            
            .portrait-upload-section,
            .character-header,
            .fokus-section,
            .stats-grid,
            .tabs-container,
            .zweite-chance,
            .inventar-section {
                break-inside: avoid;
                page-break-inside: avoid;
            }
        }

        /* ===== IMAGE CROPPER MODAL ===== */
        .crop-dialog-overlay {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.92);
            z-index: 10000;
            align-items: center;
            justify-content: center;
            padding: 16px;
        }

        .crop-dialog-overlay.active {
            display: flex;
            animation: fadeIn 200ms ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .crop-dialog {
            background: var(--md-surface-container);
            border-radius: 24px;
            max-width: 480px;
            width: 100%;
            max-height: 85vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.5);
            animation: slideUp 250ms ease;
        }

        @keyframes slideUp {
            from { opacity: 0; transform: translateY(20px) scale(0.98); }
            to { opacity: 1; transform: translateY(0) scale(1); }
        }

        .crop-dialog-header {
            padding: 20px 24px 16px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .crop-dialog-title {
            font-size: 20px;
            font-weight: 500;
            color: var(--md-on-surface);
            letter-spacing: -0.3px;
        }

        .crop-dialog-close {
            background: none;
            border: none;
            color: var(--md-on-surface-variant);
            cursor: pointer;
            padding: 8px;
            margin: -8px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 200ms;
        }

        .crop-dialog-close:hover {
            background: var(--md-surface-container-highest);
            color: var(--md-on-surface);
        }

        .crop-dialog-body {
            flex: 1;
            overflow: hidden;
            background: var(--md-surface-container-lowest, #0f0f0f);
            min-height: 300px;
            max-height: 50vh;
            position: relative;
            margin: 0 16px;
            border-radius: 16px;
        }

        .crop-dialog-body img {
            display: block;
            max-width: 100%;
            max-height: 100%;
        }

        .crop-dialog-footer {
            padding: 20px 24px 24px;
            display: flex;
            gap: 12px;
            justify-content: flex-end;
        }

        .crop-dialog-btn {
            padding: 12px 24px;
            border-radius: 100px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 200ms;
            font-family: inherit;
        }

        .crop-dialog-btn-cancel {
            background: var(--md-surface-container-high);
            border: none;
            color: var(--md-on-surface);
        }

        .crop-dialog-btn-cancel:hover {
            background: var(--md-surface-container-highest);
        }

        .crop-dialog-btn-confirm {
            background: var(--md-primary);
            border: none;
            color: var(--md-on-primary);
        }

        .crop-dialog-btn-confirm:hover {
            filter: brightness(1.15);
        }

        /* ===== CROPPER.JS STYLING ===== */
        /* Crop-Box Rahmen */
        .crop-dialog-body .cropper-view-box {
            outline: 2px solid var(--md-primary) !important;
            outline-offset: -2px !important;
        }

        .crop-dialog-body .cropper-face {
            background-color: transparent !important;
        }

        /* Verstecke das karierte Standard-Muster */
        .crop-dialog-body .cropper-bg {
            background-image: none !important;
        }

        /* Dashed Lines innerhalb der Crop-Box - dezenter */
        .crop-dialog-body .cropper-dashed {
            border-color: rgba(255, 255, 255, 0.2) !important;
        }

        /* Resize-Linien an den Kanten */
        .crop-dialog-body .cropper-line {
            background-color: var(--md-primary) !important;
        }

        /* Eck-Handles */
        .crop-dialog-body .cropper-point {
            background-color: var(--md-primary) !important;
            width: 12px !important;
            height: 12px !important;
            border-radius: 50% !important;
            opacity: 1 !important;
            border: 2px solid #fff !important;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.3) !important;
        }

        .crop-dialog-body .cropper-point.point-e,
        .crop-dialog-body .cropper-point.point-w,
        .crop-dialog-body .cropper-point.point-n,
        .crop-dialog-body .cropper-point.point-s {
            display: none !important;
        }

        .crop-dialog-body .cropper-point.point-nw {
            left: -6px !important;
            top: -6px !important;
        }
        .crop-dialog-body .cropper-point.point-ne {
            right: -6px !important;
            top: -6px !important;
        }
        .crop-dialog-body .cropper-point.point-sw {
            left: -6px !important;
            bottom: -6px !important;
        }
        .crop-dialog-body .cropper-point.point-se {
            right: -6px !important;
            bottom: -6px !important;
        }

        /* Center-Indicator verstecken */
        .crop-dialog-body .cropper-center {
            display: none !important;
        }

        /* Drag-Box - nicht berschreiben */
        .crop-dialog-body .cropper-crop-box {
            border-radius: 0 !important;
        }

        @media (max-width: 600px) {
            .crop-dialog {
                max-width: 100%;
                max-height: 90vh;
                border-radius: 20px;
                margin: 8px;
            }

            .crop-dialog-body {
                min-height: 250px;
                margin: 0 12px;
                border-radius: 12px;
            }

            .crop-dialog-header {
                padding: 16px 20px 12px;
            }

            .crop-dialog-footer {
                padding: 16px 20px 20px;
                flex-direction: column;
            }

            .crop-dialog-btn {
                width: 100%;
                justify-content: center;
            }
        }
    </style>
</head>
<body>
    <!-- Image Cropper Modal -->
    <div class="crop-dialog-overlay" id="cropperModal">
        <div class="crop-dialog">
            <div class="crop-dialog-header">
                <span class="crop-dialog-title" id="cropperTitle" data-i18n="char.crop_portrait">Portrt zuschneiden</span>
                <button class="crop-dialog-close" onclick="closeCropper()">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M18 6L6 18M6 6l12 12"/>
                    </svg>
                </button>
            </div>
            <div class="crop-dialog-body">
                <img id="cropperImage" src="" alt="Crop preview">
            </div>
            <div class="crop-dialog-footer">
                <button class="crop-dialog-btn crop-dialog-btn-cancel" onclick="closeCropper()" data-i18n="common.cancel">Abbrechen</button>
                <button class="crop-dialog-btn crop-dialog-btn-confirm" onclick="confirmCrop()" data-i18n="char.confirm_crop">Ausschnitt besttigen</button>
            </div>
        </div>
    </div>

    <div class="container">
        <!-- RULESET BOX -->
        <div class="ruleset-box">
            <span class="ruleset-label" data-i18n="char.current_adventure">Aktuelles Abenteuer:</span>
            <img src="assets/icons/icon_ruleset_rumundrache.svg" alt="Regelwerk" class="ruleset-icon" id="ruleset-icon">
            <span class="ruleset-name" id="ruleset-name">Rum & Rache</span>
        </div>

        <!-- PORTRAIT UPLOAD - GANZ OBEN -->
        <div class="portrait-upload-section">
            <div class="portrait-container" id="portrait-container">
                <div class="portrait-preview" id="portrait-preview" onclick="togglePortraitControls()">
                    <div class="portrait-placeholder" id="portrait-placeholder">
                        <img src="assets/icons/icon_fileupload.png" alt="Upload" style="width: 32px; height: 32px; opacity: 0.7;">
                        <div data-i18n="char.upload_portrait">Portrait hochladen</div>
                        <div style="font-size: 12px; margin-top: 8px; opacity: 0.7;">Max. 5 MB</div>
                    </div>
                </div>
                <div class="portrait-controls" id="portrait-controls">
                    <button class="portrait-btn change" onclick="openFileDialog(event)" data-i18n-title="char.change_image" title="Bild ndern">
                        <img src="assets/icons/icon_image.png" alt="ndern">
                    </button>
                    <button class="portrait-btn remove" id="portrait-remove" onclick="removePortrait(event)" data-i18n-title="char.remove_image" title="Bild entfernen">
                        <img src="assets/icons/icon_delete.png" alt="Lschen">
                    </button>
                </div>
                <input type="file" id="portrait-input" class="portrait-upload-input" accept="image/jpeg,image/png,image/webp,image/gif" onchange="handlePortraitUpload(event)">
            </div>
            
            <!-- Trennlinie -->
            <div class="portrait-divider"></div>
            
            <!-- Jolly Roger Upload + Crew -->
            <div class="jolly-wrapper">
                <div class="jolly-container" id="jolly-container">
                    <div class="jolly-preview" id="jolly-preview" onclick="toggleJollyControls()">
                        <div class="jolly-placeholder" id="jolly-placeholder">
                            <img src="assets/icons/icon_fileupload.png" alt="Upload" style="width: 24px; height: 24px; opacity: 0.7;">
                            <div data-i18n="char.jolly_roger">Jolly Roger</div>
                            <div style="font-size: 11px; margin-top: 4px; opacity: 0.7;">Max. 5 MB</div>
                        </div>
                    </div>
                    <div class="jolly-controls" id="jolly-controls">
                        <button class="portrait-btn change" onclick="openJollyDialog(event)" data-i18n-title="char.change_image" title="Bild ndern">
                            <img src="assets/icons/icon_image.png" alt="ndern">
                        </button>
                        <button class="portrait-btn remove" id="jolly-remove" onclick="removeJolly(event)" data-i18n-title="char.remove_image" title="Bild entfernen">
                            <img src="assets/icons/icon_delete.png" alt="Lschen">
                        </button>
                    </div>
                    <input type="file" id="jolly-input" class="portrait-upload-input" accept="image/jpeg,image/png,image/webp,image/gif" onchange="handleJollyUpload(event)">
                </div>
                
                <!-- Crew Input -->
                <div class="crew-input-container">
                    <input type="text" class="crew-input" id="char-crew" data-i18n-placeholder="char.crew_placeholder" placeholder="Name der Piraten-Crew...">
                </div>
            </div>
        </div>

        <!-- CHARACTER HEADER -->
        <div class="character-header">
            <div class="header-grid">
                <div class="input-row">
                    <div class="input-group">
                        <label data-i18n="char.name">Name</label>
                        <input type="text" class="input-field" id="char-name" data-i18n-placeholder="char.name_placeholder" placeholder="Dein Charaktername...">
                    </div>
                    <div class="input-group">
                        <label data-i18n="char.gender">Geschlecht</label>
                        <input type="text" class="input-field" id="char-gender" data-i18n-placeholder="char.gender_placeholder" placeholder="z.B. Mnnlich, Weiblich...">
                    </div>
                </div>
                <div class="input-row">
                    <div class="input-group">
                        <label data-i18n="char.age">Alter</label>
                        <input type="text" class="input-field" id="char-age" data-i18n-placeholder="char.age_placeholder" placeholder="z.B. 25 Jahre">
                    </div>
                    <div class="input-group">
                        <label data-i18n="char.role">Rolle in der Crew</label>
                        <input type="text" class="input-field" id="char-role" data-i18n-placeholder="char.role_placeholder" placeholder="z.B. Kapitn, Navigator...">
                    </div>
                </div>
                <div class="input-group">
                    <label data-i18n="char.appearance">Aussehen</label>
                    <input type="text" class="input-field" id="char-aussehen" data-i18n-placeholder="char.appearance_placeholder" placeholder="z.B. 1.80m, athletisch, blaue Augen...">
                </div>
            </div>
        </div>

        <!-- FOKUS SYSTEM -->
        <div class="fokus-section">
            <div class="fokus-header">
                <label data-i18n="char.focus">Fokus</label>
            </div>
            <div class="fokus-grid" id="fokusGrid">
                <!-- Desktop: Icon card (hidden on mobile) -->
                <div class="fokus-type-card fokus-desktop-only" id="fokusTypeCardDesktop" onclick="openFokusPopup()">
                    <img src="assets/icons/icon_focus_fire.png" alt="Fokus" id="fokusTypeIconDesktop" style="display: none;">
                    <span class="fokus-type-placeholder" id="fokusTypePlaceholderDesktop">?</span>
                </div>
                <!-- Mobile: Top row with icon + name -->
                <div class="fokus-top-row" id="fokusTopRow">
                    <div class="fokus-type-card" id="fokusTypeCard" onclick="openFokusPopup()">
                        <img src="assets/icons/icon_focus_fire.png" alt="Fokus" id="fokusTypeIcon" style="display: none;">
                        <span class="fokus-type-placeholder" id="fokusTypePlaceholder">?</span>
                    </div>
                    <div class="fokus-type-name-mobile" id="fokusTypeNameMobile">-</div>
                </div>
                <div class="fokus-ability-card" id="fokusAbility1">
                    <div class="fokus-ability-content">
                        <span class="fokus-ability-placeholder" data-i18n="char.ability_1">Fhigkeit 1</span>
                        <span class="fokus-ability-name"></span>
                        <span class="fokus-ability-desc-small"></span>
                    </div>
                </div>
                <div class="fokus-ability-card" id="fokusAbility2">
                    <div class="fokus-ability-content">
                        <span class="fokus-ability-placeholder" data-i18n="char.ability_2">Fhigkeit 2</span>
                        <span class="fokus-ability-name"></span>
                        <span class="fokus-ability-desc-small"></span>
                    </div>
                </div>
                <div class="fokus-ability-card locked" id="fokusAbility3">
                    <div class="fokus-ability-content">
                        <span class="fokus-ability-placeholder"></span>
                        <span class="fokus-ability-name"></span>
                        <span class="fokus-ability-desc-small"></span>
                    </div>
                </div>
            </div>
        </div>

        <!-- STATS -->
        <div class="stats-grid" id="statsGrid">
            <div class="stat-card leben" id="lebenCard">
                <div class="stat-label" data-i18n="char.health">Lebenspunkte</div>
                <div class="stat-input-group">
                    <input type="number" class="stat-input" id="leben-current" value="100" min="0" max="100">
                    <span class="stat-separator">/</span>
                    <span class="stat-max">100</span>
                </div>
                <div class="progress-bar">
                    <div class="progress-fill leben" id="leben-bar" style="width: 100%"></div>
                </div>
            </div>

            <div class="stat-card moral" id="moralCard">
                <div class="stat-label" data-i18n="char.morale">Moral</div>
                <div class="stat-input-group">
                    <input type="number" class="stat-input" id="moral-current" value="100" min="0" max="100">
                    <span class="stat-separator">/</span>
                    <span class="stat-max">100</span>
                </div>
                <div class="progress-bar">
                    <div class="progress-fill moral" id="moral-bar" style="width: 100%"></div>
                </div>
            </div>

            <div class="stat-card resonanz" id="resonanzCard">
                <div class="stat-label" data-i18n="char.resonance">Resonanz</div>
                <div class="stat-input-group">
                    <input type="number" class="stat-input" id="resonanz-value" value="0" min="0" max="100">
                    <span class="stat-separator">%</span>
                </div>
                <div class="progress-bar">
                    <div class="progress-fill resonanz" id="resonanz-bar" style="width: 0%"></div>
                </div>
            </div>
        </div>

        <!-- GLOBAL POINTS COUNTER - SINGLE LINE -->
        <div class="global-points-header" id="global-points-header">
            <div class="global-points-title" data-i18n="char.points_overview">Punktebersicht</div>
            <div class="global-points-info">
                <div class="global-counter">
                    <span data-i18n="char.points_used">Vergeben:</span> <strong id="global-used">0</strong>
                </div>
                <div class="global-counter global-points-remaining" id="global-remaining-container">
                    <span data-i18n="char.points_remaining">Verbleibend:</span> <strong id="global-remaining">500</strong>
                </div>
            </div>
        </div>

        <!-- TABS: BEGABUNGEN WERTE -->
        <div class="tabs-container">
            <div class="tabs-header">
                <button class="tab-btn active" data-tab="handeln" data-i18n="char.tab_action">Handeln</button>
                <button class="tab-btn" data-tab="wissen" data-i18n="char.tab_knowledge">Wissen</button>
                <button class="tab-btn" data-tab="soziales" data-i18n="char.tab_social">Soziales</button>
            </div>

            <!-- HANDELN TAB -->
            <div class="tab-content active" id="tab-handeln">
                <div class="skills-header">
                    <div class="category-final-value" id="handeln-final">0</div>
                </div>
                <div class="skills-grid" id="skills-handeln"></div>
                <button class="add-skill-btn" onclick="addSkillRow('handeln')" data-i18n-title="char.add_skill" title="Weitere Begabung hinzufgen">
                    <span>+</span>
                </button>
            </div>

            <!-- WISSEN TAB -->
            <div class="tab-content" id="tab-wissen">
                <div class="skills-header">
                    <div class="category-final-value" id="wissen-final">0</div>
                </div>
                <div class="skills-grid" id="skills-wissen"></div>
                <button class="add-skill-btn" onclick="addSkillRow('wissen')" title="Weitere Begabung hinzufgen">
                    <span>+</span>
                </button>
            </div>

            <!-- SOZIALES TAB -->
            <div class="tab-content" id="tab-soziales">
                <div class="skills-header">
                    <div class="category-final-value" id="soziales-final">0</div>
                </div>
                <div class="skills-grid" id="skills-soziales"></div>
                <button class="add-skill-btn" onclick="addSkillRow('soziales')" data-i18n-title="char.add_skill" title="Weitere Begabung hinzufgen">
                    <span>+</span>
                </button>
            </div>
        </div>

        <!-- HILFE BUTTON -->
        <div class="help-btn-container">
            <button class="help-btn" onclick="toggleHelpDialog()" data-i18n-title="char.skills_help" title="Fhigkeiten Beispiele">
                <img src="assets/icons/icon_help.png" alt="Hilfe">
                <span data-i18n="char.skills_help">Fhigkeiten Beispiele</span>
            </button>
        </div>

        <!-- ZWEITE CHANCE -->
        <div class="zweite-chance">
            <h3 data-i18n="char.second_chance">Zweite Chance</h3>
            <div class="dice-checks">
                <div class="dice-check">
                    <div class="dice-icon" data-dice="1">
                        <img src="assets/icons/icon_dice20.png" alt="W20">
                    </div>
                </div>
                <div class="dice-check">
                    <div class="dice-icon" data-dice="2">
                        <img src="assets/icons/icon_dice20.png" alt="W20">
                    </div>
                </div>
                <div class="dice-check">
                    <div class="dice-icon" data-dice="3">
                        <img src="assets/icons/icon_dice20.png" alt="W20">
                    </div>
                </div>
            </div>
        </div>

        <!-- INVENTAR -->
        <div class="inventar-section">
            <h3 data-i18n="char.inventory">Inventar</h3>
            <div class="currency-field">
                <label class="currency-label" data-i18n="char.currency">Whrung</label>
                <div class="currency-input-group">
                    <input type="text" inputmode="numeric" pattern="[0-9.]*" class="input-field currency-input" id="char-currency" data-i18n-placeholder="char.currency_placeholder" placeholder="Menge eingeben" oninput="formatCurrency(this)">
                    <button class="currency-type-btn" id="currency-type-btn" onclick="rotateCurrencyType()" data-i18n-title="char.change_currency" title="Whrungstyp wechseln">
                        <img src="assets/icons/icon_dollar.png" alt="Whrung" id="currency-icon">
                    </button>
                </div>
            </div>
            <textarea class="input-field inventar-textarea" id="char-inventar" data-i18n-placeholder="char.inventory_placeholder" placeholder="Trage hier dein Inventar ein..."></textarea>
        </div>

        <!-- CHARACTER FILE DOWNLOAD/UPLOAD -->
        <div class="character-file-actions">
            <h3 data-i18n="char.manage">Charakterbogen verwalten</h3>
            <div class="file-action-buttons">
                <button class="file-action-btn" onclick="downloadCharacter()">
                    <img src="assets/icons/icon_filedownload.png" alt="Download">
                    <span data-i18n="char.download_json">JSON herunterladen</span>
                </button>
                <button class="file-action-btn" onclick="document.getElementById('char-upload-input').click()">
                    <img src="assets/icons/icon_fileupload.png" alt="Upload">
                    <span data-i18n="char.upload_json">JSON hochladen</span>
                </button>
                <button class="file-action-btn" onclick="exportAsPDF()">
                    <img src="assets/icons/icon_filedownload.png" alt="PDF">
                    <span data-i18n="char.export_pdf">Als PDF drucken</span>
                </button>
                <button class="file-action-btn danger" onclick="resetCharacter()">
                    <img src="assets/icons/icon_delete.png" alt="Reset">
                    <span data-i18n="char.reset">Zurcksetzen</span>
                </button>
            </div>
            <input type="file" id="char-upload-input" class="char-upload-input" accept=".json" onchange="uploadCharacter(event)">
        </div>

        <!-- POWERED BY FOOTER -->
        <div class="powered-by-footer">
            <span>Powered by</span>
            <a href="https://howtobeahero.de/index.php/Hauptseite" target="_blank" rel="noopener noreferrer">
                <img src="assets/images/logo_htbah_light.png" alt="How To Be A Hero" class="htbah-logo">
            </a>
        </div>
    </div>

    <!-- SAVE INDICATOR -->
    <div class="save-indicator" id="save-indicator">
        <img src="assets/icons/icon_save.png" alt="" style="width:16px;height:16px;vertical-align:middle;margin-right:6px;filter:brightness(0) invert(1);"> <span data-i18n="char.saved">Gespeichert</span>
    </div>

    <!-- HELP DIALOG -->
    <div class="help-dialog-scrim" id="helpDialog" onclick="if(event.target === this) toggleHelpDialog()">
        <div class="help-dialog" onclick="event.stopPropagation()">
            <div class="help-dialog-head">
                <h2 class="help-dialog-title" data-i18n="char.skills_examples">Fhigkeiten - Beispiele</h2>
                <button class="help-close-btn" onclick="toggleHelpDialog()"></button>
            </div>
            <div class="help-dialog-content">
                <div class="help-tabs">
                    <button class="help-tab-btn active" data-help-tab="handeln" data-i18n="char.tab_action">Handeln</button>
                    <button class="help-tab-btn" data-help-tab="wissen" data-i18n="char.tab_knowledge">Wissen</button>
                    <button class="help-tab-btn" data-help-tab="soziales" data-i18n="char.tab_social">Soziales</button>
                </div>

                <!-- HANDELN EXAMPLES -->
                <div class="help-category active" id="help-handeln">
                    <div class="help-skills-grid" id="help-handeln-grid">
                        <!-- Dynamically populated -->
                    </div>
                </div>

                <!-- WISSEN EXAMPLES -->
                <div class="help-category" id="help-wissen">
                    <div class="help-skills-grid" id="help-wissen-grid">
                        <!-- Dynamically populated -->
                    </div>
                </div>

                <!-- SOZIALES EXAMPLES -->
                <div class="help-category" id="help-soziales">
                    <div class="help-skills-grid" id="help-soziales-grid">
                        <!-- Dynamically populated -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.6.1/cropper.min.js"></script>

    <!-- AUTH & NAVIGATION -->
    <script src="assets/js/lang.js"></script>
    <script src="assets/js/i18n.js"></script>
    <script src="assets/js/auth.js"></script>
    <script src="assets/js/firebase-sync.js"></script>
    <script src="assets/js/nav.js"></script>

    <script>
        'use strict';

        requireAuth();

        // ===== IMAGE CROPPER =====
        let cropper = null;
        let cropperTarget = null; // 'portrait' or 'jolly'
        let cropperFile = null;

        function openCropper(imageSrc, target, aspectRatio) {
            // Prfe ob Cropper.js verfgbar ist
            if (typeof Cropper === 'undefined') {
                console.error('[Cropper] Cropper.js nicht geladen - Bild wird direkt verwendet');
                // Fallback: Bild direkt verwenden ohne Crop
                processImageWithoutCropper(imageSrc, target);
                return;
            }
            
            cropperTarget = target;
            const modal = document.getElementById('cropperModal');
            const image = document.getElementById('cropperImage');
            const title = document.getElementById('cropperTitle');
            
            // Set title based on target
            title.textContent = target === 'portrait' ? t('char.crop_portrait') : t('char.crop_jolly');
            
            image.src = imageSrc;
            modal.classList.add('active');
            
            // Initialize cropper after image loads
            image.onload = function() {
                if (cropper) {
                    cropper.destroy();
                }
                try {
                    cropper = new Cropper(image, {
                        aspectRatio: aspectRatio,
                        viewMode: 2,
                        dragMode: 'move',
                        autoCropArea: 0.9,
                        restore: false,
                        guides: true,
                        center: true,
                        highlight: false,
                        cropBoxMovable: true,
                        cropBoxResizable: true,
                        toggleDragModeOnDblclick: false,
                        background: false,
                        modal: false,
                        minContainerWidth: 250,
                        minContainerHeight: 250
                    });
                } catch (err) {
                    console.error('[Cropper] Fehler beim Initialisieren:', err);
                    closeCropper();
                    processImageWithoutCropper(imageSrc, target);
                }
            };
        }
        
        // Fallback wenn Cropper.js nicht verfgbar
        function processImageWithoutCropper(imageSrc, target) {
            const img = new Image();
            img.onload = function() {
                const maxEdge = 768;
                let width = img.width;
                let height = img.height;

                if (width > maxEdge || height > maxEdge) {
                    if (width > height) {
                        height = Math.round(height * (maxEdge / width));
                        width = maxEdge;
                    } else {
                        width = Math.round(width * (maxEdge / height));
                        height = maxEdge;
                    }
                }

                const canvas = document.createElement('canvas');
                canvas.width = width;
                canvas.height = height;
                const ctx = canvas.getContext('2d');
                ctx.drawImage(img, 0, 0, width, height);

                const hasTransparency = cropperFile && (cropperFile.type === 'image/png' || cropperFile.type === 'image/webp');
                const imageData = hasTransparency ? canvas.toDataURL('image/png') : canvas.toDataURL('image/jpeg', 0.85);

                if (target === 'portrait') {
                    characterData.portrait = imageData;
                    displayPortrait(imageData);
                } else if (target === 'jolly') {
                    characterData.jollyRoger = imageData;
                    displayJolly(imageData);
                }
                autoSave();
            };
            img.src = imageSrc;
        }

        function closeCropper() {
            const modal = document.getElementById('cropperModal');
            modal.classList.remove('active');
            
            if (cropper) {
                cropper.destroy();
                cropper = null;
            }
            cropperTarget = null;
            cropperFile = null;
            
            // Reset file inputs
            document.getElementById('portrait-input').value = '';
            document.getElementById('jolly-input').value = '';
        }

        function confirmCrop() {
            if (!cropper || !cropperTarget) return;
            
            // Check if file has transparency (PNG or WebP)
            const hasTransparency = cropperFile && (cropperFile.type === 'image/png' || cropperFile.type === 'image/webp');
            
            // Get cropped canvas
            const canvas = cropper.getCroppedCanvas({
                maxWidth: 768,
                maxHeight: 768,
                imageSmoothingEnabled: true,
                imageSmoothingQuality: 'high'
            });
            
            let imageData;
            if (hasTransparency) {
                // PNG: Behalte Transparenz
                imageData = canvas.toDataURL('image/png');
            } else {
                // JPEG fr alles andere (bessere Kompression)
                imageData = canvas.toDataURL('image/jpeg', 0.85);
            }
            
            if (cropperTarget === 'portrait') {
                characterData.portrait = imageData;
                displayPortrait(imageData);
            } else if (cropperTarget === 'jolly') {
                characterData.jollyRoger = imageData;
                displayJolly(imageData);
            }
            
            autoSave();
            closeCropper();
        }

        // Close modal on backdrop click
        document.getElementById('cropperModal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeCropper();
            }
        });

        // Close modal on Escape key
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape' && document.getElementById('cropperModal').classList.contains('active')) {
                closeCropper();
            }
        });

        const moduleTools = ``;
        createNavigationBar(t('module.character'), moduleTools);
        
        // ===== GM VIEW SYSTEM =====
        let isGM = false;
        let allPlayers = {};
        let viewingPlayer = null; // null = own character, string = other player's name
        let unsubscribePlayers = null;
        let unsubscribeCharacters = null;

        async function initGMView() {
            const user = getCurrentUser();
            isGM = user?.isGM || false;
            
            await initFirebase();
            
            if (isGM && isFirebaseOnline()) {
                // Create player selector bar
                createPlayerBar();
                
                // Listen for players
                unsubscribePlayers = onPlayersChange(updatePlayerBar);
                
                // Check URL parameter for direct character view
                const urlParams = new URLSearchParams(window.location.search);
                const viewParam = urlParams.get('view');
                if (viewParam) {
                    console.log('[Charakter] GM view requested for:', viewParam);
                    
                    // Wait for players to load, then switch
                    const waitForPlayers = () => {
                        if (Object.keys(allPlayers).length === 0) {
                            setTimeout(waitForPlayers, 100);
                            return;
                        }
                        
                        // Load the character directly using the key
                        viewingPlayer = viewParam;
                        document.body.classList.add('gm-readonly');
                        
                        // Update player bar to reflect current selection
                        updatePlayerBar(allPlayers);
                        
                        // Add banner
                        const existingBanner = document.querySelector('.gm-viewing-banner');
                        if (!existingBanner) {
                            const banner = document.createElement('div');
                            banner.className = 'gm-viewing-banner';
                            banner.innerHTML = `
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/>
                                    <circle cx="12" cy="12" r="3"/>
                                </svg>
                                ${t('char.viewing_character')} <strong>${viewParam}</strong> ${t('char.view_only')}
                            `;
                            const container = document.querySelector('.container');
                            const playerBar = document.getElementById('playerBar');
                            if (playerBar) {
                                container.insertBefore(banner, playerBar.nextSibling);
                            } else {
                                container.insertBefore(banner, container.firstChild);
                            }
                        }
                        
                        // Load the character - viewParam is already the sanitized key
                        getRef(`characters/${viewParam}`).once('value').then(snapshot => {
                            const data = snapshot.val();
                            console.log('[Charakter] Loaded character data:', data ? 'found' : 'not found');
                            if (data) {
                                applyCharacterData(data);
                            }
                        });
                    };
                    
                    setTimeout(waitForPlayers, 200);
                }
            }
            
            // Listen for character updates (both GM and players)
            if (isFirebaseOnline()) {
                listenToAllCharacters();
            }
            
            // Sync own character to Firebase
            if (isFirebaseOnline() && !isGM) {
                syncCharacterToFirebase();
            }
            
            // Init dice popups
            initDicePopupListener();
        }

        function createPlayerBar() {
            const bar = document.createElement('div');
            bar.id = 'playerBar';
            bar.className = 'player-bar';
            bar.innerHTML = `
                <div class="player-bar-inner" id="playerBarInner">
                    <div class="player-bar-label">${t('char.players')}:</div>
                </div>
            `;
            
            // Insert after nav
            const container = document.querySelector('.container');
            container.insertBefore(bar, container.firstChild);
            
            // Add styles
            if (!document.getElementById('playerBarStyles')) {
                const style = document.createElement('style');
                style.id = 'playerBarStyles';
                style.textContent = `
                    .player-bar {
                        background: var(--md-surface-container);
                        border-radius: var(--shape-lg);
                        padding: 8px 16px;
                        margin-bottom: 16px;
                        overflow-x: auto;
                        box-shadow: var(--elevation-1);
                    }
                    
                    .player-bar-inner {
                        display: flex;
                        align-items: center;
                        gap: 8px;
                        min-width: max-content;
                    }
                    
                    .player-bar-label {
                        font-size: 12px;
                        color: var(--md-on-surface-variant);
                        font-weight: 500;
                    }
                    
                    .player-tab {
                        display: flex;
                        align-items: center;
                        gap: 6px;
                        padding: 6px 12px;
                        background: var(--md-surface-container-high);
                        border: 2px solid transparent;
                        border-radius: var(--shape-full);
                        font-size: 13px;
                        font-weight: 500;
                        color: var(--md-on-surface);
                        cursor: pointer;
                        transition: all 200ms ease;
                        white-space: nowrap;
                    }
                    
                    .player-tab:hover {
                        background: var(--md-surface-container-highest);
                    }
                    
                    .player-tab.active {
                        border-color: var(--md-primary);
                        background: color-mix(in srgb, var(--md-primary) 15%, var(--md-surface-container));
                    }
                    
                    .player-tab-dot {
                        width: 10px;
                        height: 10px;
                        border-radius: 50%;
                    }
                    
                    .player-tab.own {
                        font-style: italic;
                    }
                    
                    .gm-viewing-banner {
                        background: color-mix(in srgb, var(--md-primary) 10%, var(--md-surface-container));
                        border: 1px solid var(--md-primary);
                        border-radius: var(--shape-md);
                        padding: 8px 16px;
                        margin-bottom: 16px;
                        font-size: 13px;
                        color: var(--md-on-surface);
                        display: flex;
                        align-items: center;
                        gap: 8px;
                    }
                    
                    .gm-viewing-banner svg {
                        width: 18px;
                        height: 18px;
                        color: var(--md-primary);
                    }
                    
                    /* Read-only mode for GM viewing others */
                    .gm-readonly .input-field,
                    .gm-readonly .skill-value,
                    .gm-readonly .stat-input,
                    .gm-readonly .skill-name,
                    .gm-readonly textarea,
                    .gm-readonly select {
                        pointer-events: none;
                        opacity: 0.8;
                    }
                    
                    .gm-readonly .portrait-btn,
                    .gm-readonly .currency-type-btn,
                    .gm-readonly .skill-btn,
                    .gm-readonly .add-skill-btn,
                    .gm-readonly .dice-icon {
                        pointer-events: none;
                        opacity: 0.6;
                    }
                `;
                document.head.appendChild(style);
            }
        }

        function updatePlayerBar(players) {
            allPlayers = players;
            const container = document.getElementById('playerBarInner');
            if (!container) return;
            
            const user = getCurrentUser();
            
            // Clear existing tabs (keep label)
            container.innerHTML = `<div class="player-bar-label">${t('char.players')}:</div>`;
            
            // Add "Eigener Charakter" tab
            const ownTab = document.createElement('button');
            ownTab.className = `player-tab own ${!viewingPlayer ? 'active' : ''}`;
            ownTab.innerHTML = `
                <span class="player-tab-dot" style="background: ${user?.color || '#6750a4'}"></span>
                ${t('char.own_character')}
            `;
            ownTab.onclick = () => switchToPlayer(null);
            container.appendChild(ownTab);
            
            // Add other players
            Object.values(players).forEach(player => {
                if (player.username === user?.username) return; // Skip self
                if (player.isGM) return; // Skip other GMs
                
                const sanitizedName = sanitizeKey(player.username);
                const tab = document.createElement('button');
                tab.className = `player-tab ${viewingPlayer === player.username || viewingPlayer === sanitizedName ? 'active' : ''}`;
                tab.dataset.player = player.username;
                tab.dataset.playerKey = sanitizedName;
                tab.innerHTML = `
                    <span class="player-tab-dot" style="background: ${player.color}"></span>
                    ${player.username}
                `;
                tab.onclick = () => switchToPlayer(player.username);
                container.appendChild(tab);
            });
        }

        function switchToPlayer(playerName) {
            viewingPlayer = playerName;
            console.log('[Charakter] switchToPlayer:', playerName);
            
            // Update tabs
            document.querySelectorAll('.player-tab').forEach(tab => {
                tab.classList.remove('active');
                // Activate correct tab based on playerName (can be username or sanitized key)
                if (playerName === null && tab.classList.contains('own')) {
                    tab.classList.add('active');
                } else if (tab.dataset.player === playerName || tab.dataset.playerKey === playerName) {
                    tab.classList.add('active');
                    // Use the actual username for loading
                    if (tab.dataset.player) {
                        viewingPlayer = tab.dataset.player;
                    }
                }
            });
            
            // Remove existing banner
            const existingBanner = document.querySelector('.gm-viewing-banner');
            if (existingBanner) existingBanner.remove();
            
            if (playerName) {
                // Viewing another player
                document.body.classList.add('gm-readonly');
                
                // Add banner
                const banner = document.createElement('div');
                banner.className = 'gm-viewing-banner';
                banner.innerHTML = `
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/>
                        <circle cx="12" cy="12" r="3"/>
                    </svg>
                    ${t('char.viewing_character')} <strong>${playerName}</strong> ${t('char.view_only')}
                `;
                const container = document.querySelector('.container');
                const playerBar = document.getElementById('playerBar');
                container.insertBefore(banner, playerBar.nextSibling);
                
                // Load their character
                loadPlayerCharacter(playerName);
            } else {
                // Viewing own character
                document.body.classList.remove('gm-readonly');
                
                // Reload own character from localStorage
                characterData = loadCharacter();
                renderAllFields();
            }
        }

        function listenToAllCharacters() {
            // Listen for character updates from all players
            if (!database) return;
            
            const user = getCurrentUser();
            
            unsubscribeCharacters = getRef('characters').on('value', (snapshot) => {
                const characters = snapshot.val() || {};
                
                // If we're viewing another player (GM mode), update their data
                if (viewingPlayer) {
                    const playerChar = characters[sanitizeKey(viewingPlayer)];
                    if (playerChar) {
                        applyCharacterData(playerChar);
                    }
                }
                // If we're a regular player, listen for GM changes to our own character
                else if (user && !user.isGM) {
                    const myChar = characters[sanitizeKey(user.username)];
                    if (myChar && myChar.updatedAt) {
                        // Check if this is a remote update (not from us)
                        const lastLocalSave = characterData._lastLocalSave || 0;
                        if (myChar.updatedAt > lastLocalSave) {
                            console.log('[Charakter] Remote update detected, applying...');
                            applyCharacterData(myChar);
                        }
                    }
                }
            });
        }

        function loadPlayerCharacter(playerName) {
            if (!database) return;
            
            getRef(`characters/${sanitizeKey(playerName)}`).once('value').then(snapshot => {
                const data = snapshot.val();
                if (data) {
                    applyCharacterData(data);
                } else {
                    // No data - show empty
                    applyCharacterData(getDefaultCharacterData());
                }
            });
        }

        function syncCharacterToFirebase() {
            const user = getCurrentUser();
            if (!user || user.isGM) return; // GMs don't sync their character
            
            // Hook into existing save function
            const originalSaveCharacter = window.saveCharacter;
            if (typeof originalSaveCharacter === 'function') {
                window.saveCharacter = function(showIndicator = false) {
                    originalSaveCharacter(showIndicator);
                    syncCharacterToFirebase_inner();
                };
            }
            
            // Initial sync
            syncCharacterToFirebase_inner();
        }
        
        function syncCharacterToFirebase_inner() {
            if (!isFirebaseOnline()) return;
            const user = getCurrentUser();
            if (!user || user.isGM) return;
            
            // Mark this as a local save to avoid triggering our own listener
            const timestamp = Date.now();
            characterData._lastLocalSave = timestamp;
            
            console.log('[Charakter] Syncing to Firebase...');
            getRef(`characters/${sanitizeKey(user.username)}`).set({
                ...characterData,
                updatedAt: timestamp
            });
        }

        function debounce(fn, delay) {
            let timeout;
            return function(...args) {
                clearTimeout(timeout);
                timeout = setTimeout(() => fn.apply(this, args), delay);
            };
        }

        function sanitizeKey(str) {
            return str.replace(/[.#$\/\[\]]/g, '_');
        }

        function applyCharacterData(data) {
            characterData = { ...loadCharacter(), ...data };
            renderAllFields();
        }

        function renderAllFields() {
            // Re-render all form fields from characterData
            console.log('[Charakter] Rendering fields:', characterData);
            
            // Basic fields - ID  data key mapping
            const fieldMapping = {
                'char-name': 'name',
                'char-gender': 'gender',
                'char-age': 'age',
                'char-role': 'role',
                'char-crew': 'crew',
                'char-aussehen': 'aussehen',
                'char-inventar': 'inventar',
                'char-currency': 'currency'
            };
            
            Object.entries(fieldMapping).forEach(([id, key]) => {
                const el = document.getElementById(id);
                if (el) {
                    el.value = characterData[key] || '';
                }
            });
            
            // Update Fokus display
            updateFokusDisplay();
            
            // Portrait & Jolly
            updatePortraitDisplay();
            updateJollyDisplay();
            
            // Leben/Moral - korrigierte IDs
            if (characterData.leben) {
                const lebenCurrent = document.getElementById('leben-current');
                const lebenMax = document.getElementById('leben-max');
                if (lebenCurrent) lebenCurrent.value = characterData.leben.current || 100;
                if (lebenMax) lebenMax.value = characterData.leben.max || 100;
            }
            if (characterData.moral) {
                const moralCurrent = document.getElementById('moral-current');
                const moralMax = document.getElementById('moral-max');
                if (moralCurrent) moralCurrent.value = characterData.moral.current || 100;
                if (moralMax) moralMax.value = characterData.moral.max || 100;
            }
            
            // Resonanz
            const resonanzEl = document.getElementById('resonanz-value');
            if (resonanzEl) resonanzEl.value = characterData.resonanz || 0;
            const resonanzBar = document.getElementById('resonanz-bar');
            if (resonanzBar) resonanzBar.style.width = `${characterData.resonanz || 0}%`;
            
            // Zweite Chance checkboxes
            if (characterData.zweiteChance && Array.isArray(characterData.zweiteChance)) {
                characterData.zweiteChance.forEach((checked, i) => {
                    const cb = document.getElementById(`zweiteChance${i + 1}`);
                    if (cb) cb.checked = checked;
                });
            }
            
            // Currency Type (Icon)
            if (characterData.currencyType) {
                const CURRENCY_TYPES_MAP = {
                    'dollar': 'icon_dollar.png',
                    'gold': 'icon_gold.png', 
                    'silver': 'icon_silver.png',
                    'copper': 'icon_copper.png',
                    'gem': 'icon_gem.png'
                };
                const iconFile = CURRENCY_TYPES_MAP[characterData.currencyType] || 'icon_dollar.png';
                const currencyIcon = document.getElementById('currency-icon');
                if (currencyIcon) {
                    currencyIcon.src = `assets/icons/${iconFile}`;
                }
            }
            
            // Skills - Re-render from characterData
            if (characterData.skills) {
                ['handeln', 'wissen', 'soziales'].forEach(category => {
                    const container = document.getElementById(`skills-${category}`);
                    if (!container || !characterData.skills[category]) return;
                    
                    const skills = characterData.skills[category];
                    
                    // Update existing inputs or recreate
                    const rows = container.querySelectorAll('.skill-row');
                    skills.forEach((skill, index) => {
                        if (rows[index]) {
                            const nameInput = rows[index].querySelector('.skill-name');
                            const valueInput = rows[index].querySelector('.skill-value');
                            if (nameInput) nameInput.value = skill.name || '';
                            if (valueInput) valueInput.value = skill.value || 0;
                        }
                    });
                });
            }
            
            // Update point counters
            updatePointCounters();
            
            // Update progress bars and check death
            updateProgressBars();
        }
        
        function updatePortraitDisplay() {
            const preview = document.getElementById('portrait-preview');
            const placeholder = document.getElementById('portrait-placeholder');
            const removeBtn = document.getElementById('portrait-remove');
            
            if (characterData.portrait) {
                preview.style.backgroundImage = `url(${characterData.portrait})`;
                preview.style.backgroundSize = 'cover';
                preview.style.backgroundPosition = 'center';
                if (placeholder) placeholder.style.display = 'none';
                if (removeBtn) removeBtn.style.display = 'flex';
            } else {
                preview.style.backgroundImage = '';
                if (placeholder) placeholder.style.display = 'flex';
                if (removeBtn) removeBtn.style.display = 'none';
            }
        }
        
        function updateJollyDisplay() {
            const preview = document.getElementById('jolly-preview');
            const placeholder = document.getElementById('jolly-placeholder');
            const removeBtn = document.getElementById('jolly-remove');
            
            if (characterData.jollyRoger) {
                preview.style.backgroundImage = `url(${characterData.jollyRoger})`;
                preview.style.backgroundSize = 'cover';
                preview.style.backgroundPosition = 'center';
                if (placeholder) placeholder.style.display = 'none';
                if (removeBtn) removeBtn.style.display = 'flex';
            } else {
                preview.style.backgroundImage = '';
                if (placeholder) placeholder.style.display = 'flex';
                if (removeBtn) removeBtn.style.display = 'none';
            }
        }

        // Initialize GM view after page loads
        setTimeout(initGMView, 100);

        const STORAGE_KEY_PREFIX = 'rumRache_character_';

        function getStorageKey() {
            const user = getCurrentUser();
            const username = user && user.username
                ? user.username
                : localStorage.getItem('rumRache_currentUser');

            return STORAGE_KEY_PREFIX + (username || 'unknown');
        }
        const TOTAL_POINTS = 500;
        const SKILLS_PER_CATEGORY = 10;

        // Example Skills Database - now with translations
        function getExampleSkills() {
            const lang = currentLang || 'de';
            return SKILL_EXAMPLES_TRANSLATIONS[lang] || SKILL_EXAMPLES_TRANSLATIONS.de;
        }

        // Translate a skill name to the current language
        function translateSkillName(name, category) {
            if (!name) return name;
            
            const deSkills = SKILL_EXAMPLES_TRANSLATIONS.de[category];
            const enSkills = SKILL_EXAMPLES_TRANSLATIONS.en[category];
            const currentSkills = getExampleSkills()[category];
            
            if (!deSkills || !enSkills || !currentSkills) return name;
            
            // Check if name is in German list
            const deIndex = deSkills.indexOf(name);
            if (deIndex !== -1) {
                return currentSkills[deIndex] || name;
            }
            
            // Check if name is in English list
            const enIndex = enSkills.indexOf(name);
            if (enIndex !== -1) {
                return currentSkills[enIndex] || name;
            }
            
            // Name not in translation list, return as-is
            return name;
        }

        // Get the base (German) name for storage
        function getBaseSkillName(name, category) {
            if (!name) return name;
            
            const deSkills = SKILL_EXAMPLES_TRANSLATIONS.de[category];
            const enSkills = SKILL_EXAMPLES_TRANSLATIONS.en[category];
            
            if (!deSkills || !enSkills) return name;
            
            // If already German, return as-is
            if (deSkills.includes(name)) return name;
            
            // If English, translate to German for storage
            const enIndex = enSkills.indexOf(name);
            if (enIndex !== -1) {
                return deSkills[enIndex] || name;
            }
            
            return name;
        }

        // Track transferred skills per category
        let transferredSkills = {
            handeln: new Set(),
            wissen: new Set(),
            soziales: new Set()
        };

        let characterData = loadCharacter();
        let saveTimeout = null;

        // Initialize Help Dialog with skills
        function initializeHelpDialog() {
            const EXAMPLE_SKILLS = getExampleSkills();
            Object.keys(EXAMPLE_SKILLS).forEach(category => {
                const grid = document.getElementById(`help-${category}-grid`);
                grid.innerHTML = '';

                EXAMPLE_SKILLS[category].forEach((skill, index) => {
                    const item = document.createElement('div');
                    item.className = 'help-skill-item';
                    item.dataset.skillName = skill;
                    item.dataset.category = category;

                    // Check if transferred using base (German) name
                    const baseSkillName = SKILL_EXAMPLES_TRANSLATIONS.de[category][index];
                    const isTransferred = transferredSkills[category].has(baseSkillName);

                    item.innerHTML = `
                        <span class="help-skill-name">${skill}</span>
                        <button class="help-transfer-btn ${isTransferred ? 'remove' : ''}" 
                                onclick="handleSkillTransfer('${category}', '${skill.replace(/'/g, "\\'")}', this)">
                            ${isTransferred ? t('char.skill_remove') : t('char.skill_transfer')}
                        </button>
                    `;
                    grid.appendChild(item);
                });
            });
        }

        // Handle skill transfer or removal
        function handleSkillTransfer(category, displaySkillName, btnElement) {
            const skills = characterData.skills[category];
            // Convert display name to base name for storage
            const baseSkillName = getBaseSkillName(displaySkillName, category);
            const isCurrentlyTransferred = transferredSkills[category].has(baseSkillName);

            if (isCurrentlyTransferred) {
                // Remove skill
                const skillIndex = skills.findIndex(s => s.name === baseSkillName);
                if (skillIndex !== -1) {
                    skills[skillIndex].name = '';
                    skills[skillIndex].value = 0;
                }
                transferredSkills[category].delete(baseSkillName);

                btnElement.textContent = t('char.skill_transfer');
                btnElement.classList.remove('remove');
            } else {
                // Transfer skill
                const emptyIndex = skills.findIndex(s => !s.name || s.name.trim() === '');

                if (emptyIndex === -1) {
                    alert(t('char.no_empty_slots'));
                    return;
                }

                // Store base name (German)
                skills[emptyIndex].name = baseSkillName;
                transferredSkills[category].add(baseSkillName);

                btnElement.textContent = t('char.skill_remove');
                btnElement.classList.add('remove');
            }

            saveCharacter();
            initializeSkills();
            updatePointCounters();
        }

        // Load transferred skills from character data
        function loadTransferredSkills() {
            const DE_SKILLS = SKILL_EXAMPLES_TRANSLATIONS.de;
            Object.keys(characterData.skills).forEach(category => {
                characterData.skills[category].forEach(skill => {
                    // Skills are stored with base (German) names
                    if (skill.name && DE_SKILLS[category] && DE_SKILLS[category].includes(skill.name)) {
                        transferredSkills[category].add(skill.name);
                    }
                });
            });
        }

        // Portrait Controls Toggle
        function togglePortraitControls() {
            const container = document.getElementById('portrait-container');
            container.classList.toggle('show-controls');
        }

        // Close controls when clicking outside
        document.addEventListener('click', function(e) {
            const container = document.getElementById('portrait-container');
            if (!container.contains(e.target)) {
                container.classList.remove('show-controls');
            }
        });

        function openFileDialog(event) {
            event.stopPropagation();
            document.getElementById('portrait-input').click();
        }

        function handlePortraitUpload(event) {
            const file = event.target.files[0];
            if (!file) return;

            // Erlaubte Formate prfen
            const allowedTypes = ['image/jpeg', 'image/png', 'image/webp', 'image/gif'];
            if (!allowedTypes.includes(file.type)) {
                alert(t('char.invalid_format'));
                return;
            }

            // Max 5 MB Dateigre
            const maxSize = 5 * 1024 * 1024; // 5 MB
            if (file.size > maxSize) {
                alert(t('char.file_too_large'));
                return;
            }

            const reader = new FileReader();
            reader.onload = function(e) {
                // GIFs: Direkt speichern um Animation zu erhalten (kein Cropper)
                if (file.type === 'image/gif') {
                    characterData.portrait = e.target.result;
                    displayPortrait(e.target.result);
                    autoSave();
                    return;
                }
                
                // Andere Formate: Cropper ffnen
                cropperFile = file;
                openCropper(e.target.result, 'portrait', 1);
            };
            reader.readAsDataURL(file);
        }

        function displayPortrait(imageData) {
            const preview = document.getElementById('portrait-preview');
            const placeholder = document.getElementById('portrait-placeholder');

            placeholder.style.display = 'none';
            preview.style.backgroundImage = `url(${imageData})`;
            preview.style.backgroundSize = 'cover';
            preview.style.backgroundPosition = 'center';
        }

        function removePortrait(event) {
            event.stopPropagation();

            const preview = document.getElementById('portrait-preview');
            const placeholder = document.getElementById('portrait-placeholder');
            const container = document.getElementById('portrait-container');

            characterData.portrait = null;
            preview.style.backgroundImage = 'none';
            placeholder.style.display = 'block';
            document.getElementById('portrait-input').value = '';
            container.classList.remove('show-controls');

            autoSave();
        }

        // Jolly Roger Functions
        function toggleJollyControls() {
            const container = document.getElementById('jolly-container');
            container.classList.toggle('show-controls');
        }

        document.addEventListener('click', function(e) {
            const jollyContainer = document.getElementById('jolly-container');
            if (jollyContainer && !jollyContainer.contains(e.target)) {
                jollyContainer.classList.remove('show-controls');
            }
        });

        function openJollyDialog(event) {
            event.stopPropagation();
            document.getElementById('jolly-input').click();
        }

        function handleJollyUpload(event) {
            const file = event.target.files[0];
            if (!file) return;

            // Erlaubte Formate prfen
            const allowedTypes = ['image/jpeg', 'image/png', 'image/webp', 'image/gif'];
            if (!allowedTypes.includes(file.type)) {
                alert(t('char.invalid_format'));
                return;
            }

            // Max 5 MB Dateigre
            const maxSize = 5 * 1024 * 1024; // 5 MB
            if (file.size > maxSize) {
                alert(t('char.file_too_large'));
                return;
            }

            const reader = new FileReader();
            reader.onload = function(e) {
                // GIFs: Direkt speichern um Animation zu erhalten (kein Cropper)
                if (file.type === 'image/gif') {
                    characterData.jollyRoger = e.target.result;
                    displayJolly(e.target.result);
                    autoSave();
                    return;
                }
                
                // Andere Formate: Cropper ffnen
                cropperFile = file;
                openCropper(e.target.result, 'jolly', 5/3);
            };
            reader.readAsDataURL(file);
        }

        function displayJolly(imageData) {
            const preview = document.getElementById('jolly-preview');
            const placeholder = document.getElementById('jolly-placeholder');

            placeholder.style.display = 'none';
            preview.style.backgroundImage = `url(${imageData})`;
            preview.style.backgroundSize = 'cover';
            preview.style.backgroundPosition = 'center';
        }

        function removeJolly(event) {
            event.stopPropagation();

            const preview = document.getElementById('jolly-preview');
            const placeholder = document.getElementById('jolly-placeholder');
            const container = document.getElementById('jolly-container');

            characterData.jollyRoger = null;
            preview.style.backgroundImage = 'none';
            placeholder.style.display = 'block';
            document.getElementById('jolly-input').value = '';
            container.classList.remove('show-controls');

            autoSave();
        }

        function initializeSkills() {
            ['handeln', 'wissen', 'soziales'].forEach(category => {
                const container = document.getElementById(`skills-${category}`);
                const skills = characterData.skills[category];

                container.innerHTML = '';

                skills.forEach((skill, index) => {
                    const row = document.createElement('div');
                    row.className = 'skill-row';
                    // Translate skill name for display
                    const displayName = translateSkillName(skill.name, category);
                    row.innerHTML = `
                        <input type="text" 
                               class="skill-name" 
                               value="${displayName}" 
                               data-category="${category}" 
                               data-index="${index}" 
                               placeholder="${t('char.skill_name_placeholder')}">
                        <input type="number" 
                               class="skill-value" 
                               value="${skill.value}" 
                               data-category="${category}" 
                               data-index="${index}" 
                               placeholder="0" 
                               min="0" 
                               max="100">
                        <button class="skill-delete-btn" onclick="deleteSkillRow('${category}', ${index})" title="${t('char.delete_row')}"></button>
                    `;
                    container.appendChild(row);
                });
            });

            document.querySelectorAll('.skill-name, .skill-value').forEach(input => {
                input.addEventListener('input', handleSkillChange);
            });

            updatePointCounters();
        }

        function loadCharacter() {
            // 1) Neuer, nutzerspezifischer Speicherstand
            let saved = localStorage.getItem(getStorageKey());

            // 2) Migration: alter globaler Key (falls vorhanden)
            if (!saved) {
                const legacy = localStorage.getItem('rumRache_character');
                if (legacy) {
                    localStorage.setItem(getStorageKey(), legacy);
                    localStorage.removeItem('rumRache_character');
                    saved = legacy;
                }
            }

            if (saved) {
                try {
                    return JSON.parse(saved);
                } catch (e) {
                    console.warn('Charakterbogen: Speicherstand beschdigt, lade Standardwerte.', e);
                }
            }

            return {
                name: '',
                gender: '',
                age: '',
                role: '',
                crew: '',
                aussehen: '',
                currency: '',
                currencyType: 'dollar',
                inventar: '',
                portrait: null,
                jollyRoger: null,
                leben: { current: 100, max: 100 },
                moral: { current: 100, max: 100 },
                resonanz: 0,
                zweiteChance: [false, false, false],
                fokus: { type: null, abilities: [], slot3Unlocked: false },
                skills: {
                    handeln: Array(SKILLS_PER_CATEGORY).fill(null).map(() => ({ name: '', value: 0 })),
                    wissen: Array(SKILLS_PER_CATEGORY).fill(null).map(() => ({ name: '', value: 0 })),
                    soziales: Array(SKILLS_PER_CATEGORY).fill(null).map(() => ({ name: '', value: 0 }))
                }
            };
        }

        function saveCharacter(showIndicator = false) {
            localStorage.setItem(getStorageKey(), JSON.stringify(characterData));
            if (showIndicator) {
                showSaveIndicator();
            }
        }

        function autoSave() {
            clearTimeout(saveTimeout);
            saveTimeout = setTimeout(() => saveCharacter(true), 500);
        }

        function showSaveIndicator() {
            const indicator = document.getElementById('save-indicator');
            indicator.classList.add('show');
            setTimeout(() => indicator.classList.remove('show'), 2000);
        }

        // Download character as JSON
        function downloadCharacter() {
            const dataStr = JSON.stringify(characterData, null, 2);
            const dataBlob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(dataBlob);

            const link = document.createElement('a');
            link.href = url;
            const fileName = characterData.name ? `${characterData.name}_Charakterbogen.json` : 'Charakterbogen.json';
            link.download = fileName;

            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);

            showSaveIndicator();
        }

        // Upload character from JSON
        function uploadCharacter(event) {
            const file = event.target.files[0];
            if (!file) return;

            if (!file.name.endsWith('.json')) {
                alert(t('char.json_required'));
                return;
            }

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const uploadedData = JSON.parse(e.target.result);

                    // Validate structure
                    if (!uploadedData.skills || !uploadedData.leben || !uploadedData.moral) {
                        throw new Error(t('char.invalid_format'));
                    }

                    characterData = uploadedData;
                    saveCharacter(true);

                    // Reload transferred skills
                    transferredSkills = {
                        handeln: new Set(),
                        wissen: new Set(),
                        soziales: new Set()
                    };
                    loadTransferredSkills();

                    populateFields();
                    initializeSkills();
                    initializeHelpDialog();

                    alert(t('char.load_success'));
                    showSaveIndicator();
                } catch (error) {
                    alert(t('char.load_error') + ' ' + error.message);
                }
            };
            reader.readAsText(file);

            // Reset input
            event.target.value = '';
        }

        function populateFields() {
            document.getElementById('char-name').value = characterData.name;
            document.getElementById('char-gender').value = characterData.gender;
            document.getElementById('char-age').value = characterData.age;
            document.getElementById('char-role').value = characterData.role;
            document.getElementById('char-crew').value = characterData.crew || '';
            document.getElementById('char-aussehen').value = characterData.aussehen;
            document.getElementById('char-currency').value = characterData.currency || '';
            document.getElementById('char-inventar').value = characterData.inventar;

            if (characterData.portrait) {
                displayPortrait(characterData.portrait);
            }

            if (characterData.jollyRoger) {
                displayJolly(characterData.jollyRoger);
            }

            document.getElementById('leben-current').value = characterData.leben.current;
            document.getElementById('moral-current').value = characterData.moral.current;
            document.getElementById('resonanz-value').value = characterData.resonanz;

            updateProgressBars();

            characterData.zweiteChance.forEach((used, index) => {
                const dice = document.querySelector(`[data-dice="${index + 1}"]`);
                if (used) dice.classList.add('used');
            });
        }

        function updateProgressBars() {
            const lebenPercent = (characterData.leben.current / characterData.leben.max) * 100;
            const moralPercent = (characterData.moral.current / characterData.moral.max) * 100;

            const lebenBar = document.getElementById('leben-bar');
            lebenBar.style.width = `${lebenPercent}%`;
            
            // Update Leben color based on percentage
            lebenBar.classList.remove('warning', 'critical');
            if (lebenPercent <= 20 && lebenPercent > 0) {
                lebenBar.classList.add('critical');
            } else if (lebenPercent <= 50) {
                lebenBar.classList.add('warning');
            }
            
            document.getElementById('moral-bar').style.width = `${moralPercent}%`;
            document.getElementById('resonanz-bar').style.width = `${characterData.resonanz}%`;
        }

        function updatePointCounters() {
            let globalTotal = 0;

            ['handeln', 'wissen', 'soziales'].forEach(category => {
                const skills = characterData.skills[category];
                const categoryTotal = skills.reduce((sum, skill) => {
                    const value = parseInt(skill.value) || 0;
                    return sum + value;
                }, 0);

                const finalValue = Math.round(categoryTotal / 10);
                document.getElementById(`${category}-final`).textContent = finalValue;

                globalTotal += categoryTotal;
            });

            const remaining = TOTAL_POINTS - globalTotal;
            document.getElementById('global-used').textContent = globalTotal;
            document.getElementById('global-remaining').textContent = remaining;

            const remainingContainer = document.getElementById('global-remaining-container');
            if (remaining < 0) {
                remainingContainer.classList.add('warning');
            } else {
                remainingContainer.classList.remove('warning');
            }
        }

        document.getElementById('char-name').addEventListener('input', (e) => {
            characterData.name = e.target.value;
            autoSave();
        });

        document.getElementById('char-gender').addEventListener('input', (e) => {
            characterData.gender = e.target.value;
            autoSave();
        });

        document.getElementById('char-age').addEventListener('input', (e) => {
            characterData.age = e.target.value;
            autoSave();
        });

        document.getElementById('char-role').addEventListener('input', (e) => {
            characterData.role = e.target.value;
            autoSave();
        });

        document.getElementById('char-crew').addEventListener('input', (e) => {
            characterData.crew = e.target.value;
            autoSave();
        });

        document.getElementById('char-aussehen').addEventListener('input', (e) => {
            characterData.aussehen = e.target.value;
            autoSave();
        });

        document.getElementById('char-currency').addEventListener('input', (e) => {
            characterData.currency = e.target.value;
            autoSave();
        });

        document.getElementById('char-inventar').addEventListener('input', (e) => {
            characterData.inventar = e.target.value;
            autoSave();
        });

        document.getElementById('leben-current').addEventListener('input', (e) => {
            let value = parseInt(e.target.value) || 0;
            value = Math.max(0, Math.min(characterData.leben.max, value));
            e.target.value = value;
            characterData.leben.current = value;
            updateProgressBars();
            autoSave();
        });

        document.getElementById('moral-current').addEventListener('input', (e) => {
            let value = parseInt(e.target.value) || 0;
            value = Math.max(0, Math.min(characterData.moral.max, value));
            e.target.value = value;
            characterData.moral.current = value;
            updateProgressBars();
            autoSave();
        });

        document.getElementById('resonanz-value').addEventListener('input', (e) => {
            let value = parseInt(e.target.value) || 0;
            value = Math.max(0, Math.min(100, value));
            e.target.value = value;
            characterData.resonanz = value;
            updateProgressBars();
            autoSave();
        });

        function handleSkillChange(e) {
            const category = e.target.dataset.category;
            const index = parseInt(e.target.dataset.index);
            const isName = e.target.classList.contains('skill-name');

            if (isName) {
                const oldBaseName = characterData.skills[category][index].name;
                const newDisplayName = e.target.value;
                // Store base name (German) for consistency
                const newBaseName = getBaseSkillName(newDisplayName, category);
                const EXAMPLE_SKILLS = getExampleSkills();
                const DE_SKILLS = SKILL_EXAMPLES_TRANSLATIONS.de[category];

                // Update transferred skills tracking (use base names)
                if (oldBaseName && DE_SKILLS && DE_SKILLS.includes(oldBaseName)) {
                    transferredSkills[category].delete(oldBaseName);
                }
                if (newBaseName && DE_SKILLS && DE_SKILLS.includes(newBaseName)) {
                    transferredSkills[category].add(newBaseName);
                }

                characterData.skills[category][index].name = newBaseName;
                initializeHelpDialog(); // Update button states
            } else {
                let value = e.target.value;
                if (value !== '') {
                    value = Math.max(0, Math.min(100, parseInt(value) || 0));
                    e.target.value = value;
                }
                characterData.skills[category][index].value = value;
                updatePointCounters();
            }

            autoSave();
        }

        function addSkillRow(category) {
            // Add new skill to data
            characterData.skills[category].push({ name: '', value: 0 });
            
            // Re-render the skills grid for this category
            const container = document.getElementById(`skills-${category}`);
            const skills = characterData.skills[category];
            const newIndex = skills.length - 1;
            
            const row = document.createElement('div');
            row.className = 'skill-row';
            row.innerHTML = `
                <input type="text" 
                       class="skill-name" 
                       value="" 
                       data-category="${category}" 
                       data-index="${newIndex}" 
                       placeholder="${t('char.skill_name_placeholder')}">
                <input type="number" 
                       class="skill-value" 
                       value="0" 
                       data-category="${category}" 
                       data-index="${newIndex}" 
                       placeholder="0" 
                       min="0" 
                       max="100">
                <button class="skill-delete-btn" onclick="deleteSkillRow('${category}', ${newIndex})" title="${t('char.delete_row')}"></button>
            `;
            container.appendChild(row);
            
            // Add event listeners to new inputs
            row.querySelectorAll('.skill-name, .skill-value').forEach(input => {
                input.addEventListener('input', handleSkillChange);
            });
            
            // Focus the new name input
            row.querySelector('.skill-name').focus();
            
            autoSave();
        }

        function deleteSkillRow(category, index) {
            // Minimum 1 Zeile behalten
            if (characterData.skills[category].length <= 1) {
                return;
            }
            
            // Remove from data
            characterData.skills[category].splice(index, 1);
            
            // Re-render all skills (to fix indices)
            initializeSkills();
            updatePointCounters();
            autoSave();
        }

        document.querySelectorAll('.dice-icon').forEach(dice => {
            dice.addEventListener('click', () => {
                const index = parseInt(dice.dataset.dice) - 1;
                
                // Wenn noch nicht used, Effekt abspielen
                if (!characterData.zweiteChance[index]) {
                    dice.classList.add('clicking');
                    setTimeout(() => dice.classList.remove('clicking'), 500);
                }
                
                characterData.zweiteChance[index] = !characterData.zweiteChance[index];
                dice.classList.toggle('used');
                autoSave();
            });
        });

        document.querySelectorAll('.tab-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                const tabName = btn.dataset.tab;

                document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
                document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));

                btn.classList.add('active');
                document.getElementById(`tab-${tabName}`).classList.add('active');
            });
        });

        function exportAsPDF() {
            // Hide elements that shouldn't be printed
            const elementsToHide = [
                '.nav-container',
                '.fly-btn-container', 
                '.character-file-actions',
                '.help-btn-container',
                '.powered-by-footer',
                '.add-skill-btn',
                '.skill-delete-btn'
            ];
            
            elementsToHide.forEach(selector => {
                document.querySelectorAll(selector).forEach(el => {
                    el.dataset.wasVisible = el.style.display;
                    el.style.display = 'none';
                });
            });
            
            // Trigger print
            window.print();
            
            // Restore elements after print
            setTimeout(() => {
                elementsToHide.forEach(selector => {
                    document.querySelectorAll(selector).forEach(el => {
                        el.style.display = el.dataset.wasVisible || '';
                        delete el.dataset.wasVisible;
                    });
                });
            }, 1000);
        }

        function resetCharacter() {
            if (confirm(t('char.reset_confirm'))) {
                localStorage.removeItem(getStorageKey());
                // falls noch Altlasten existieren
                localStorage.removeItem('rumRache_character');
                location.reload();
            }
        }

        function toggleHelpDialog() {
            document.getElementById('helpDialog').classList.toggle('active');
        }

        document.addEventListener('DOMContentLoaded', function() {
            document.querySelectorAll('.help-tab-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    document.querySelectorAll('.help-tab-btn').forEach(b => b.classList.remove('active'));
                    this.classList.add('active');

                    document.querySelectorAll('.help-category').forEach(c => c.classList.remove('active'));
                    document.getElementById('help-' + this.dataset.helpTab).classList.add('active');
                });
            });
        });

        // Currency type rotation
        const CURRENCY_TYPES = [
            { id: 'dollar', icon: 'icon_dollar.png', name: 'Dollar' },
            { id: 'euro', icon: 'icon_euro.png', name: 'Euro' },
            { id: 'yen', icon: 'icon_yen.png', name: 'Yen' },
            { id: 'berry', icon: 'icon_berry.png', name: 'Berry' },
            { id: 'skull', icon: 'icon_skull.png', name: 'Skull' }
        ];
        let currentCurrencyIndex = 0;

        function rotateCurrencyType() {
            currentCurrencyIndex = (currentCurrencyIndex + 1) % CURRENCY_TYPES.length;
            const currency = CURRENCY_TYPES[currentCurrencyIndex];
            document.getElementById('currency-icon').src = `assets/icons/${currency.icon}`;
            document.getElementById('currency-type-btn').title = currency.name;
            characterData.currencyType = currency.id;
            autoSave();
        }

        function formatCurrency(input) {
            // Get cursor position before change
            const cursorPos = input.selectionStart;
            const oldLength = input.value.length;
            
            // Remove all non-digit characters except dots (thousand separators)
            let value = input.value.replace(/[^\d]/g, '');
            
            // Convert to number and back to add thousand separators
            if (value) {
                const num = parseInt(value, 10);
                input.value = num.toLocaleString('de-DE');
            } else {
                input.value = '';
            }
            
            // Restore cursor position
            const newLength = input.value.length;
            const diff = newLength - oldLength;
            input.setSelectionRange(cursorPos + diff, cursorPos + diff);
        }

        function loadCurrencyType() {
            if (characterData.currencyType) {
                const index = CURRENCY_TYPES.findIndex(c => c.id === characterData.currencyType);
                if (index !== -1) {
                    currentCurrencyIndex = index;
                    const currency = CURRENCY_TYPES[currentCurrencyIndex];
                    document.getElementById('currency-icon').src = `assets/icons/${currency.icon}`;
                    document.getElementById('currency-type-btn').title = currency.name;
                }
            }
        }

        // ===== FOKUS SYSTEM =====
        function getFokusData() {
            const lang = currentLang || 'de';
            const translations = FOKUS_TRANSLATIONS[lang] || FOKUS_TRANSLATIONS.de;
            return {
                fire: { ...translations.fire, icon: 'icon_focus_fire.png' },
                water: { ...translations.water, icon: 'icon_focus_water.png' },
                wind: { ...translations.wind, icon: 'icon_focus_wind.png' },
                earth: { ...translations.earth, icon: 'icon_focus_earth.png' },
                lightning: { ...translations.lightning, icon: 'icon_focus_lightning.png' },
                room: { ...translations.room, icon: 'icon_focus_room.png' },
                illusion: { ...translations.illusion, icon: 'icon_focus_illusion.png' }
            };
        }

        // Translate a Fokus ability name to the current language
        function translateFokusAbility(abilityName, fokusType) {
            if (!abilityName || !fokusType) return abilityName;
            
            const deData = FOKUS_TRANSLATIONS.de[fokusType];
            const currentData = (FOKUS_TRANSLATIONS[currentLang] || FOKUS_TRANSLATIONS.de)[fokusType];
            
            if (!deData || !currentData) return abilityName;
            
            // Check attacks
            const deAttackIndex = deData.attacks.findIndex(a => a.name === abilityName);
            if (deAttackIndex !== -1 && currentData.attacks[deAttackIndex]) {
                return currentData.attacks[deAttackIndex].name;
            }
            
            // Check defenses
            const deDefenseIndex = deData.defenses.findIndex(d => d.name === abilityName);
            if (deDefenseIndex !== -1 && currentData.defenses[deDefenseIndex]) {
                return currentData.defenses[deDefenseIndex].name;
            }
            
            return abilityName;
        }

        // Get the base (German) name for storage
        function getBaseFokusAbility(abilityName, fokusType) {
            if (!abilityName || !fokusType) return abilityName;
            
            const deData = FOKUS_TRANSLATIONS.de[fokusType];
            const enData = FOKUS_TRANSLATIONS.en[fokusType];
            
            if (!deData || !enData) return abilityName;
            
            // Already German?
            if (deData.attacks.some(a => a.name === abilityName) || 
                deData.defenses.some(d => d.name === abilityName)) {
                return abilityName;
            }
            
            // Find in English and return German equivalent
            const enAttackIndex = enData.attacks.findIndex(a => a.name === abilityName);
            if (enAttackIndex !== -1) {
                return deData.attacks[enAttackIndex].name;
            }
            
            const enDefenseIndex = enData.defenses.findIndex(d => d.name === abilityName);
            if (enDefenseIndex !== -1) {
                return deData.defenses[enDefenseIndex].name;
            }
            
            return abilityName;
        }

        let selectedFokusCategory = null;
        let selectedFokusAbilities = [];
        let fokusPopupOpen = false;

        function openFokusPopup() {
            if (fokusPopupOpen) return;
            fokusPopupOpen = true;

            // Pre-select current fokus if exists
            if (characterData.fokus?.type) {
                selectedFokusCategory = characterData.fokus.type;
                selectedFokusAbilities = [...(characterData.fokus.abilities || [])];
            } else {
                selectedFokusCategory = null;
                selectedFokusAbilities = [];
            }

            const popup = document.createElement('div');
            popup.className = 'fokus-popup-overlay';
            popup.id = 'fokusPopup';
            popup.onclick = (e) => { if (e.target === popup) closeFokusPopup(); };

            const maxAbilities = characterData.fokus?.slot3Unlocked ? 3 : 2;

            const FOKUS_DATA = getFokusData();
            popup.innerHTML = `
                <div class="fokus-popup">
                    <div class="fokus-popup-header">
                        <span class="fokus-popup-title">${t('char.focus_select')}</span>
                        <button class="fokus-popup-close" onclick="closeFokusPopup()"></button>
                    </div>
                    
                    <div class="fokus-categories" id="fokusCategories">
                        ${Object.entries(FOKUS_DATA).map(([key, data]) => `
                            <button class="fokus-category-btn ${selectedFokusCategory === key ? 'active' : ''}" 
                                    onclick="selectFokusCategory('${key}')" title="${data.name}">
                                <img src="assets/icons/${data.icon}" alt="${data.name}">
                            </button>
                        `).join('')}
                    </div>
                    
                    <div class="fokus-popup-content" id="fokusAbilitiesContent">
                        <div style="text-align: center; color: var(--md-on-surface-variant); padding: 40px;">
                            ${t('char.focus_select_type')}
                        </div>
                    </div>
                    
                    <div class="fokus-popup-footer">
                        <span class="fokus-selection-info" id="fokusSelectionInfo">
                            ${t('char.focus_abilities_selected', { count: selectedFokusAbilities.length, max: maxAbilities })}
                        </span>
                        <button class="fokus-confirm-btn" onclick="confirmFokusSelection()" id="fokusConfirmBtn">
                            ${t('gm.confirm_btn')}
                        </button>
                    </div>
                </div>
            `;

            document.body.appendChild(popup);

            // Show abilities if category already selected
            if (selectedFokusCategory) {
                renderFokusAbilities();
            }
        }

        function closeFokusPopup() {
            const popup = document.getElementById('fokusPopup');
            if (popup) popup.remove();
            fokusPopupOpen = false;
        }

        function selectFokusCategory(category) {
            // If switching category, reset abilities
            if (selectedFokusCategory !== category) {
                selectedFokusAbilities = [];
            }
            selectedFokusCategory = category;

            // Update category buttons
            document.querySelectorAll('.fokus-category-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event.currentTarget.classList.add('active');

            renderFokusAbilities();
            updateFokusSelectionInfo();
        }

        function renderFokusAbilities() {
            const content = document.getElementById('fokusAbilitiesContent');
            if (!selectedFokusCategory) return;

            const data = getFokusData()[selectedFokusCategory];
            const deData = FOKUS_TRANSLATIONS.de[selectedFokusCategory];
            const maxAbilities = characterData.fokus?.slot3Unlocked ? 3 : 2;
            const elementClass = selectedFokusCategory || '';

            content.innerHTML = `
                <div class="fokus-category-title">${data.name}</div>
                
                <div class="fokus-abilities-section">
                    <div class="fokus-abilities-title"> ${t('char.focus_attacks')}</div>
                    <div class="fokus-abilities-list">
                        ${data.attacks.map((ability, idx) => {
                            // Use base (German) name for tracking
                            const baseName = deData.attacks[idx].name;
                            const isSelected = selectedFokusAbilities.includes(baseName);
                            const isDisabled = !isSelected && selectedFokusAbilities.length >= maxAbilities;
                            return `
                                <div class="fokus-ability-row ${isSelected ? 'selected ' + elementClass : ''} ${isDisabled ? 'disabled' : ''}"
                                     onclick="toggleFokusAbility('${baseName}', ${isDisabled})">
                                    <span class="fokus-ability-name">${ability.name}</span>
                                    <span class="fokus-ability-desc">${ability.desc}</span>
                                </div>
                            `;
                        }).join('')}
                    </div>
                </div>
                
                <div class="fokus-abilities-section">
                    <div class="fokus-abilities-title"> ${t('char.focus_defenses')}</div>
                    <div class="fokus-abilities-list">
                        ${deData.defenses.map((deAbility, idx) => {
                            const ability = data.defenses[idx];
                            // Use base (German) name for tracking
                            const baseName = deAbility.name;
                            const isSelected = selectedFokusAbilities.includes(baseName);
                            const isDisabled = !isSelected && selectedFokusAbilities.length >= maxAbilities;
                            return `
                                <div class="fokus-ability-row ${isSelected ? 'selected ' + elementClass : ''} ${isDisabled ? 'disabled' : ''}"
                                     onclick="toggleFokusAbility('${baseName}', ${isDisabled})">
                                    <span class="fokus-ability-name">${ability.name}</span>
                                    <span class="fokus-ability-desc">${ability.desc}</span>
                                </div>
                            `;
                        }).join('')}
                    </div>
                </div>
            `;
        }

        function toggleFokusAbility(ability, isDisabled) {
            if (isDisabled) return;

            const index = selectedFokusAbilities.indexOf(ability);
            if (index > -1) {
                selectedFokusAbilities.splice(index, 1);
            } else {
                const maxAbilities = characterData.fokus?.slot3Unlocked ? 3 : 2;
                if (selectedFokusAbilities.length < maxAbilities) {
                    selectedFokusAbilities.push(ability);
                }
            }

            renderFokusAbilities();
            updateFokusSelectionInfo();
        }

        function updateFokusSelectionInfo() {
            const maxAbilities = characterData.fokus?.slot3Unlocked ? 3 : 2;
            const info = document.getElementById('fokusSelectionInfo');
            if (info) {
                info.textContent = t('char.focus_abilities_selected', { count: selectedFokusAbilities.length, max: maxAbilities });
            }
        }

        function confirmFokusSelection() {
            if (!selectedFokusCategory) {
                alert('Bitte whle einen Fokus-Typ aus.');
                return;
            }

            // Save to characterData
            characterData.fokus = {
                type: selectedFokusCategory,
                abilities: selectedFokusAbilities,
                slot3Unlocked: characterData.fokus?.slot3Unlocked || false
            };

            // Update UI
            updateFokusDisplay();
            autoSave();
            closeFokusPopup();
        }

        function updateFokusDisplay() {
            // Mobile elements
            const typeCard = document.getElementById('fokusTypeCard');
            const typeIcon = document.getElementById('fokusTypeIcon');
            const typePlaceholder = document.getElementById('fokusTypePlaceholder');
            const typeNameMobile = document.getElementById('fokusTypeNameMobile');
            
            // Desktop elements
            const typeCardDesktop = document.getElementById('fokusTypeCardDesktop');
            const typeIconDesktop = document.getElementById('fokusTypeIconDesktop');
            const typePlaceholderDesktop = document.getElementById('fokusTypePlaceholderDesktop');
            
            // GM viewing other player - no access to fokus (except slot 3)
            const isViewingOther = isGM && viewingPlayer;
            
            if (isViewingOther) {
                typeCard?.style && (typeCard.style.pointerEvents = 'none');
                typeCardDesktop?.style && (typeCardDesktop.style.pointerEvents = 'none');
            } else {
                typeCard?.style && (typeCard.style.pointerEvents = 'auto');
                typeCardDesktop?.style && (typeCardDesktop.style.pointerEvents = 'auto');
            }

            // Remove all gradient classes from both
            const gradientClasses = ['fire', 'water', 'wind', 'earth', 'lightning', 'room', 'illusion'];
            gradientClasses.forEach(c => {
                typeCard?.classList.remove(c);
                typeCardDesktop?.classList.remove(c);
            });

            if (characterData.fokus?.type) {
                const data = getFokusData()[characterData.fokus.type];
                
                // Mobile
                if (typeIcon) {
                    typeIcon.src = `assets/icons/${data.icon}`;
                    typeIcon.style.display = 'block';
                }
                if (typePlaceholder) typePlaceholder.style.display = 'none';
                typeCard?.classList.add(characterData.fokus.type);
                
                // Desktop
                if (typeIconDesktop) {
                    typeIconDesktop.src = `assets/icons/${data.icon}`;
                    typeIconDesktop.style.display = 'block';
                }
                if (typePlaceholderDesktop) typePlaceholderDesktop.style.display = 'none';
                typeCardDesktop?.classList.add(characterData.fokus.type);
                
                // Update mobile name
                if (typeNameMobile) {
                    typeNameMobile.textContent = data.name;
                }
            } else {
                // Mobile
                if (typeIcon) typeIcon.style.display = 'none';
                if (typePlaceholder) typePlaceholder.style.display = 'block';
                
                // Desktop
                if (typeIconDesktop) typeIconDesktop.style.display = 'none';
                if (typePlaceholderDesktop) typePlaceholderDesktop.style.display = 'block';
                
                if (typeNameMobile) typeNameMobile.textContent = '-';
            }

            // Get ability descriptions from FOKUS_DATA
            const fokusType = characterData.fokus?.type;
            const fokusData = fokusType ? getFokusData()[fokusType] : null;

            // Update ability cards
            for (let i = 1; i <= 3; i++) {
                const card = document.getElementById(`fokusAbility${i}`);
                const placeholder = card.querySelector('.fokus-ability-placeholder');
                const nameSpan = card.querySelector('.fokus-ability-name');
                const descSpan = card.querySelector('.fokus-ability-desc-small');
                const baseAbilityName = characterData.fokus?.abilities?.[i - 1];
                
                // Translate ability name for display
                const displayAbilityName = translateFokusAbility(baseAbilityName, fokusType);
                
                // Find ability description using translated name
                let abilityDesc = '';
                if (displayAbilityName && fokusData) {
                    const foundAttack = fokusData.attacks.find(a => a.name === displayAbilityName);
                    const foundDefense = fokusData.defenses.find(d => d.name === displayAbilityName);
                    abilityDesc = foundAttack?.desc || foundDefense?.desc || '';
                }

                if (i === 3) {
                    // Third slot - check if unlocked
                    if (characterData.fokus?.slot3Unlocked) {
                        card.classList.remove('locked');
                        card.classList.add('unlocked');
                        placeholder.textContent = 'Fhigkeit 3';
                        // GM can lock it again (own or others)
                        if (isGM) {
                            card.style.cursor = 'pointer';
                            card.onclick = () => lockFokusSlot3();
                        } else {
                            card.onclick = () => openFokusPopup();
                        }
                    } else {
                        card.classList.add('locked');
                        card.classList.remove('unlocked');
                        // GM can unlock slot 3 (own or others)
                        if (isGM) {
                            placeholder.innerHTML = '';
                            card.style.cursor = 'pointer';
                            card.onclick = () => unlockFokusSlot3();
                        } else {
                            placeholder.textContent = '';
                            card.onclick = null;
                        }
                    }
                } else {
                    // GM viewing other player - no access
                    if (isViewingOther) {
                        card.style.pointerEvents = 'none';
                    } else {
                        card.style.pointerEvents = 'auto';
                        card.onclick = () => openFokusPopup();
                    }
                }

                // Remove element classes first
                gradientClasses.forEach(c => card.classList.remove(c));

                if (baseAbilityName) {
                    placeholder.style.display = 'none';
                    nameSpan.textContent = displayAbilityName;
                    nameSpan.style.display = 'block';
                    descSpan.textContent = abilityDesc;
                    descSpan.style.display = 'block';
                    card.classList.add('selected');
                    // Add element class for color
                    if (characterData.fokus?.type) {
                        card.classList.add(characterData.fokus.type);
                    }
                } else {
                    placeholder.style.display = 'block';
                    nameSpan.style.display = 'none';
                    descSpan.style.display = 'none';
                    card.classList.remove('selected');
                }
            }
        }

        // GM can unlock slot 3 (own or other player)
        async function unlockFokusSlot3() {
            if (!isGM) return;
            
            const targetName = viewingPlayer || t('char.yourself');
            if (!confirm(t('char.unlock_slot3_confirm', { name: targetName }))) return;
            
            characterData.fokus = characterData.fokus || { type: null, abilities: [] };
            characterData.fokus.slot3Unlocked = true;
            updateFokusDisplay();
            
            // Sync to Firebase
            if (isFirebaseOnline()) {
                try {
                    const targetUser = viewingPlayer || getCurrentUser()?.username;
                    if (targetUser) {
                        await getRef(`characters/${sanitizeKey(targetUser)}`).update({
                            fokus: characterData.fokus,
                            updatedAt: Date.now()
                        });
                        console.log('[GM] Unlocked Fokus slot 3 for:', targetUser);
                    }
                } catch (e) {
                    console.error('[GM] Unlock slot 3 failed:', e);
                }
            }
            
            // Save locally for own character
            if (!viewingPlayer) {
                autoSave();
            }
        }
        
        // GM can lock slot 3 (own or other player)
        async function lockFokusSlot3() {
            if (!isGM) return;
            
            const targetName = viewingPlayer || t('char.yourself');
            if (!confirm(t('char.lock_slot3_confirm', { name: targetName }))) return;
            
            characterData.fokus = characterData.fokus || { type: null, abilities: [] };
            characterData.fokus.slot3Unlocked = false;
            // Remove ability from slot 3 if exists
            if (characterData.fokus.abilities && characterData.fokus.abilities.length > 2) {
                characterData.fokus.abilities = characterData.fokus.abilities.slice(0, 2);
            }
            updateFokusDisplay();
            
            // Sync to Firebase
            if (isFirebaseOnline()) {
                try {
                    const targetUser = viewingPlayer || getCurrentUser()?.username;
                    if (targetUser) {
                        await getRef(`characters/${sanitizeKey(targetUser)}`).update({
                            fokus: characterData.fokus,
                            updatedAt: Date.now()
                        });
                        console.log('[GM] Locked Fokus slot 3 for:', targetUser);
                    }
                } catch (e) {
                    console.error('[GM] Lock slot 3 failed:', e);
                }
            }
            
            // Save locally for own character
            if (!viewingPlayer) {
                autoSave();
            }
        }

        // Initialize everything
        loadTransferredSkills();
        initializeHelpDialog();
        initializeSkills();
        populateFields();
        loadCurrencyType();
        updateFokusDisplay();
        
        // Scroll to fokus if coming from other modules
        if (window.location.hash === '#fokus') {
            setTimeout(() => {
                const fokusGrid = document.getElementById('fokusGrid');
                if (fokusGrid) {
                    const topBarHeight = 100; // Top bar height offset
                    const elementPosition = fokusGrid.getBoundingClientRect().top + window.pageYOffset;
                    window.scrollTo({
                        top: elementPosition - topBarHeight,
                        behavior: 'smooth'
                    });
                }
            }, 100);
        }
        
        // Create footer
        createFooter();
        
        // ===== CATALOG DISPLAY =====
        const CATALOG_INFO = {
            'rum-und-rache': { name: 'Rum & Rache', icon: 'assets/icons/icon_ruleset_rumundrache.svg' },
            '5e-2024': { name: '5e (2024)  SRD 5.2.1', icon: 'assets/icons/icon_ruleset_fantasy.svg' },
            'neon-abyss': { name: 'Neon Abyss', icon: 'assets/icons/icon_ruleset_neon.svg' },
            'basis': { name: 'Basis', icon: 'assets/icons/icon_ruleset_basis.svg' }
        };
        
        function updateRulesetDisplay() {
            const catalogId = localStorage.getItem('rift_active_catalog') || 'rum-und-rache';
            const catalog = CATALOG_INFO[catalogId] || CATALOG_INFO['rum-und-rache'];
            
            const nameEl = document.getElementById('ruleset-name');
            const iconEl = document.getElementById('ruleset-icon');
            
            if (nameEl) nameEl.textContent = catalog.name;
            if (iconEl) {
                iconEl.src = catalog.icon;
                iconEl.onerror = () => { iconEl.src = 'assets/icons/icon_hub.png'; };
            }
        }
        
        // Listen for catalog changes from Firebase
        function listenForCatalogChanges() {
            if (typeof getRef === 'function' && typeof isFirebaseOnline === 'function' && isFirebaseOnline()) {
                const ref = getRef('settings/catalog');
                if (ref) {
                    ref.on('value', (snapshot) => {
                        const catalogId = snapshot.val();
                        if (catalogId) {
                            const currentCatalog = localStorage.getItem('rift_active_catalog');
                            localStorage.setItem('rift_active_catalog', catalogId);
                            
                            // Redirect if catalog changed to different ruleset
                            if (currentCatalog && currentCatalog !== catalogId) {
                                console.log('[CharSheet] Catalog changed to:', catalogId);
                                const CATALOG_SHEETS = {
                                    'none': 'charakterbogen.html',
                                    'rum-und-rache': 'charakterbogen_rumundrache.html',
                                    '5e-2024': 'charakterbogen_5e_2024.html',
                                    'neon-abyss': 'charakterbogen.html',
                                    'basis': 'charakterbogen_basis.html'
                                };
                                window.location.href = CATALOG_SHEETS[catalogId] || 'charakterbogen.html';
                                return;
                            }
                            
                            updateRulesetDisplay();
                        }
                    });
                }
            }
        }
        
        // Initial display update
        updateRulesetDisplay();
        
        // Try to sync with Firebase if available
        if (typeof initFirebase === 'function') {
            initFirebase().then(() => {
                listenForCatalogChanges();
            }).catch(() => {});
        }
        
        // Wrap setLanguage to update skills on language change
        const originalSetLanguage = window.setLanguage;
        window.setLanguage = function(lang) {
            originalSetLanguage(lang);
            // Re-render skills with translated names
            initializeSkills();
            initializeHelpDialog();
            // Also update Fokus display
            updateFokusDisplay();
            // Update viewing banner if exists
            updateViewingBanner();
        };
        
        // Update the GM viewing banner text
        function updateViewingBanner() {
            const banner = document.querySelector('.gm-viewing-banner');
            if (banner && viewingPlayer) {
                banner.innerHTML = `
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/>
                        <circle cx="12" cy="12" r="3"/>
                    </svg>
                    ${t('char.viewing_character')} <strong>${viewingPlayer}</strong> ${t('char.view_only')}
                `;
            }
        }
    </script>
</body>
</html>
