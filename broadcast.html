<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <meta name="view-transition" content="same-origin">
    <title>RIFT ‚Äì Broadcast Center</title>
    
    <link rel="stylesheet" href="assets/css/core.css">
    <link rel="stylesheet" href="assets/css/ui.css">
    <link rel="stylesheet" href="assets/css/sidebar.css">
    <link rel="stylesheet" href="assets/css/topbar.css">
    <link rel="stylesheet" href="assets/css/footer.css">
    <link rel="stylesheet" href="assets/css/settings.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.6.1/cropper.min.css">
    
    <style>
        /* ==================== BROADCAST CENTER STYLES ==================== */
        
        .broadcast-page {
            padding: 24px;
            --bc-accent: #8b5cf6;
            --bc-accent-light: #a78bfa;
            --bc-bg-card: #111111;
            --bc-bg-elevated: #1a1a1a;
            --bc-border: rgba(255,255,255,0.08);
            --bc-text: rgba(255,255,255,0.9);
            --bc-text-muted: rgba(255,255,255,0.5);
        }
        
        .broadcast-container {
            max-width: 1400px;
            margin: 0 auto;
        }
        
        .broadcast-header {
            margin-bottom: 32px;
        }
        
        .broadcast-header__title {
            font-size: 28px;
            font-weight: 700;
            color: white;
            margin: 0 0 8px 0;
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .broadcast-header__title svg {
            width: 32px;
            height: 32px;
            color: #8b5cf6;
        }
        
        .broadcast-header__subtitle {
            font-size: 14px;
            color: rgba(255,255,255,0.5);
            margin: 0;
        }
        
        /* ==================== TAB NAVIGATION ==================== */
        .broadcast-tabs {
            display: flex;
            gap: 4px;
            background: #111111;
            padding: 6px;
            border-radius: 12px;
            margin-bottom: 24px;
            overflow-x: auto;
        }
        
        .broadcast-tab {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 12px 20px;
            background: transparent;
            border: none;
            border-radius: 8px;
            color: rgba(255,255,255,0.5);
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            white-space: nowrap;
        }
        
        .broadcast-tab:hover {
            background: rgba(255,255,255,0.05);
            color: rgba(255,255,255,0.9);
        }
        
        .broadcast-tab.active {
            background: #8b5cf6;
            color: white;
        }
        
        .broadcast-tab svg {
            width: 18px;
            height: 18px;
        }
        
        /* ==================== CONTENT PANELS ==================== */
        .broadcast-panel {
            display: none;
        }
        
        .broadcast-panel.active {
            display: block;
        }
        
        .broadcast-grid {
            display: grid;
            grid-template-columns: 1fr 400px;
            gap: 24px;
        }
        
        @media (max-width: 1200px) {
            .broadcast-grid {
                grid-template-columns: 1fr;
            }
        }
        
        /* ==================== CARDS ==================== */
        .bc-card {
            background: #111111;
            border: 1px solid rgba(255,255,255,0.08);
            border-radius: 16px;
            overflow: hidden;
            margin-bottom: 24px;
        }
        
        .bc-card__header {
            padding: 20px 24px;
            border-bottom: 1px solid rgba(255,255,255,0.08);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .bc-card__title {
            font-size: 16px;
            font-weight: 600;
            color: white;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .bc-card__title svg {
            width: 20px;
            height: 20px;
            color: #8b5cf6;
        }
        
        .bc-card__body {
            padding: 24px;
        }
        
        /* ==================== FORM ELEMENTS ==================== */
        .bc-input {
            width: 100%;
            padding: 14px 16px;
            background: rgba(0,0,0,0.3);
            border: 1px solid rgba(255,255,255,0.08);
            border-radius: 10px;
            color: white;
            font-size: 14px;
            transition: all 0.2s;
            box-sizing: border-box;
        }
        
        .bc-input:focus {
            outline: none;
            border-color: #8b5cf6;
            background: rgba(0,0,0,0.4);
        }
        
        .bc-input::placeholder {
            color: rgba(255,255,255,0.4);
        }
        
        .bc-textarea {
            width: 100%;
            min-height: 120px;
            padding: 14px 16px;
            background: rgba(0,0,0,0.3);
            border: 1px solid rgba(255,255,255,0.08);
            border-radius: 10px;
            color: white;
            font-size: 14px;
            font-family: inherit;
            resize: vertical;
            transition: all 0.2s;
            box-sizing: border-box;
        }
        
        .bc-textarea:focus {
            outline: none;
            border-color: #8b5cf6;
        }
        
        .bc-label {
            display: block;
            font-size: 12px;
            font-weight: 600;
            color: rgba(255,255,255,0.5);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 8px;
        }
        
        .bc-field {
            margin-bottom: 20px;
        }
        
        .bc-field:last-child {
            margin-bottom: 0;
        }
        
        /* ==================== BUTTONS ==================== */
        .bc-btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            padding: 14px 24px;
            background: #8b5cf6;
            border: none;
            border-radius: 10px;
            color: white;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .bc-btn:hover {
            filter: brightness(1.1);
            transform: translateY(-1px);
        }
        
        .bc-btn svg {
            width: 18px;
            height: 18px;
        }
        
        .bc-btn--secondary {
            background: rgba(255,255,255,0.1);
        }
        
        .bc-btn--danger {
            background: #ef4444;
        }
        
        .bc-btn--success {
            background: #22c55e;
        }
        
        .bc-btn--full {
            width: 100%;
        }
        
        .bc-btn--small {
            padding: 10px 16px;
            font-size: 13px;
        }
        
        /* ==================== TYPE SELECTOR ==================== */
        .bc-types {
            display: grid;
            grid-template-columns: repeat(6, 1fr);
            gap: 8px;
            margin-bottom: 20px;
        }
        
        @media (max-width: 768px) {
            .bc-types {
                grid-template-columns: repeat(3, 1fr);
            }
        }
        
        .bc-type {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 6px;
            padding: 14px 12px;
            background: rgba(255,255,255,0.03);
            border: 2px solid transparent;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .bc-type:hover {
            background: rgba(255,255,255,0.06);
        }
        
        .bc-type.active {
            border-color: #8b5cf6;
            background: rgba(139,92,246,0.1);
        }
        
        .bc-type__icon {
            width: 40px;
            height: 40px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            background: rgba(255,255,255,0.05);
        }
        
        .bc-type__label {
            font-size: 12px;
            color: rgba(255,255,255,0.5);
        }
        
        .bc-type.active .bc-type__label {
            color: white;
        }
        
        /* ==================== SOUND SELECTOR ==================== */
        .bc-sounds {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }
        
        .bc-sound {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 10px 14px;
            background: rgba(255,255,255,0.05);
            border: 1px solid transparent;
            border-radius: 8px;
            color: rgba(255,255,255,0.6);
            font-size: 13px;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .bc-sound:hover {
            background: rgba(255,255,255,0.08);
            color: white;
        }
        
        .bc-sound.active {
            border-color: #8b5cf6;
            background: rgba(139,92,246,0.1);
            color: white;
        }
        
        .bc-sound__preview {
            width: 24px;
            height: 24px;
            background: rgba(255,255,255,0.1);
            border: none;
            border-radius: 50%;
            color: white;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 10px;
        }
        
        .bc-sound__preview:hover {
            background: #8b5cf6;
        }
        
        /* ==================== IMAGE UPLOAD ==================== */
        .bc-image-upload {
            border: 2px dashed rgba(255,255,255,0.15);
            border-radius: 12px;
            padding: 40px 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .bc-image-upload:hover {
            border-color: #8b5cf6;
            background: rgba(139,92,246,0.05);
        }
        
        .bc-image-upload.has-image {
            padding: 0;
            border-style: solid;
        }
        
        .bc-image-upload__placeholder {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 12px;
            color: rgba(255,255,255,0.4);
        }
        
        .bc-image-upload__placeholder svg {
            width: 48px;
            height: 48px;
            opacity: 0.5;
        }
        
        .bc-image-upload__preview {
            width: 100%;
            aspect-ratio: 16/9;
            object-fit: cover;
            border-radius: 10px;
        }
        
        .bc-image-upload input[type="file"] {
            display: none;
        }
        
        /* ==================== PLAYER SELECTOR ==================== */
        .bc-players {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }
        
        .bc-player {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px 14px;
            background: rgba(255,255,255,0.03);
            border: 2px solid transparent;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .bc-player:hover {
            background: rgba(255,255,255,0.06);
        }
        
        .bc-player.selected {
            border-color: #8b5cf6;
            background: rgba(139,92,246,0.1);
        }
        
        .bc-player__avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            font-weight: 600;
            color: white;
        }
        
        .bc-player__name {
            font-size: 14px;
            color: white;
        }
        
        .bc-player__check {
            width: 20px;
            height: 20px;
            border: 2px solid rgba(255,255,255,0.2);
            border-radius: 50%;
            margin-left: auto;
            transition: all 0.2s;
        }
        
        .bc-player.selected .bc-player__check {
            background: #8b5cf6;
            border-color: #8b5cf6;
        }
        
        /* ==================== QUICK REACTIONS ==================== */
        .bc-reactions {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 12px;
        }
        
        @media (max-width: 768px) {
            .bc-reactions {
                grid-template-columns: repeat(2, 1fr);
            }
        }
        
        .bc-reaction {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
            padding: 20px 12px;
            background: rgba(255,255,255,0.03);
            border: 1px solid rgba(255,255,255,0.08);
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .bc-reaction:hover {
            background: rgba(255,255,255,0.08);
            transform: translateY(-2px);
        }
        
        .bc-reaction__emoji {
            font-size: 32px;
        }
        
        .bc-reaction__label {
            font-size: 11px;
            color: rgba(255,255,255,0.5);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        /* Emoji Picker */
        .emoji-pick {
            font-size: 20px;
            cursor: pointer;
            padding: 4px;
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background 0.15s;
        }
        
        .emoji-pick:hover {
            background: rgba(139,92,246,0.3);
        }
        
        /* ==================== POLL OPTIONS ==================== */
        .bc-poll-options {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        
        .bc-poll-option {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .bc-poll-option__emoji {
            width: 44px;
            height: 44px;
            background: rgba(0,0,0,0.3);
            border: 1px solid rgba(255,255,255,0.08);
            border-radius: 8px;
            font-size: 20px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
            color: white;
        }
        
        .bc-poll-option__emoji:hover {
            border-color: #8b5cf6;
        }
        
        .bc-poll-option__input {
            flex: 1;
        }
        
        .bc-poll-option__remove {
            width: 36px;
            height: 36px;
            background: transparent;
            border: none;
            color: rgba(255,255,255,0.4);
            cursor: pointer;
            border-radius: 8px;
            transition: all 0.2s;
            font-size: 16px;
        }
        
        .bc-poll-option__remove:hover {
            background: rgba(239,68,68,0.1);
            color: #ef4444;
        }
        
        /* ==================== POLL SETTINGS ==================== */
        .bc-poll-settings {
            display: flex;
            flex-wrap: wrap;
            gap: 16px;
            padding: 16px;
            background: rgba(255,255,255,0.02);
            border-radius: 10px;
            margin-top: 20px;
        }
        
        .bc-toggle {
            display: flex;
            align-items: center;
            gap: 10px;
            cursor: pointer;
        }
        
        .bc-toggle__switch {
            width: 44px;
            height: 24px;
            background: rgba(255,255,255,0.1);
            border-radius: 12px;
            position: relative;
            transition: all 0.2s;
        }
        
        .bc-toggle__switch::after {
            content: '';
            position: absolute;
            top: 2px;
            left: 2px;
            width: 20px;
            height: 20px;
            background: white;
            border-radius: 50%;
            transition: all 0.2s;
        }
        
        .bc-toggle input {
            display: none;
        }
        
        .bc-toggle input:checked + .bc-toggle__switch {
            background: #8b5cf6;
        }
        
        .bc-toggle input:checked + .bc-toggle__switch::after {
            left: 22px;
        }
        
        .bc-toggle__label {
            font-size: 13px;
            color: rgba(255,255,255,0.6);
        }
        
        /* ==================== COUNTDOWN BUTTONS ==================== */
        .bc-countdown-selector {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }
        
        .bc-countdown-btn {
            padding: 10px 16px;
            background: rgba(255,255,255,0.05);
            border: 1px solid transparent;
            border-radius: 8px;
            color: rgba(255,255,255,0.6);
            font-size: 13px;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .bc-countdown-btn:hover {
            background: rgba(255,255,255,0.1);
        }
        
        .bc-countdown-btn.active {
            border-color: #8b5cf6;
            background: rgba(139,92,246,0.1);
            color: white;
        }
        
        /* ==================== CINEMATIC GRID ==================== */
        .bc-cinematic-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 16px;
        }
        
        .bc-cinematic {
            position: relative;
            aspect-ratio: 16/9;
            background: #1a1a1a;
            border: 1px solid rgba(255,255,255,0.08);
            border-radius: 12px;
            overflow: hidden;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .bc-cinematic:hover {
            border-color: #8b5cf6;
            transform: translateY(-4px);
            box-shadow: 0 10px 40px rgba(139,92,246,0.2);
        }
        
        .bc-cinematic__preview {
            position: absolute;
            inset: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 48px;
        }
        
        .bc-cinematic__label {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            padding: 12px;
            background: linear-gradient(transparent, rgba(0,0,0,0.8));
            font-size: 13px;
            font-weight: 600;
            color: white;
        }
        
        /* ==================== ACTIVE POLL ==================== */
        .bc-active {
            background: rgba(139,92,246,0.1);
            border: 1px solid rgba(139,92,246,0.3);
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 24px;
        }
        
        .bc-active__header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
            flex-wrap: wrap;
            gap: 12px;
        }
        
        .bc-active__badge {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 6px 12px;
            background: #8b5cf6;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            color: white;
        }
        
        .bc-active__badge::before {
            content: '';
            width: 8px;
            height: 8px;
            background: white;
            border-radius: 50%;
            animation: pulse 1.5s infinite;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        
        .bc-active__content {
            font-size: 16px;
            color: white;
            margin-bottom: 16px;
        }
        
        .bc-active__results {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        
        .bc-active__result {
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .bc-active__result-label {
            min-width: 80px;
            font-size: 14px;
            color: white;
        }
        
        .bc-active__result-bar {
            flex: 1;
            height: 32px;
            background: rgba(255,255,255,0.1);
            border-radius: 8px;
            overflow: hidden;
            position: relative;
        }
        
        .bc-active__result-fill {
            height: 100%;
            background: linear-gradient(90deg, #8b5cf6, #a78bfa);
            transition: width 0.5s ease;
        }
        
        .bc-active__result-count {
            position: absolute;
            right: 12px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 13px;
            font-weight: 600;
            color: white;
        }
        
        /* ==================== EMPTY STATE ==================== */
        .bc-empty {
            text-align: center;
            padding: 60px 20px;
            color: rgba(255,255,255,0.5);
        }
        
        .bc-empty svg {
            width: 64px;
            height: 64px;
            opacity: 0.3;
            margin-bottom: 16px;
        }
        
        .bc-empty__title {
            font-size: 16px;
            font-weight: 600;
            color: white;
            margin-bottom: 8px;
        }
        
        /* ==================== HISTORY ==================== */
        .bc-history {
            max-height: 500px;
            overflow-y: auto;
        }
        
        .bc-history-item {
            display: flex;
            align-items: flex-start;
            gap: 14px;
            padding: 16px;
            border-bottom: 1px solid rgba(255,255,255,0.05);
        }
        
        .bc-history-item:last-child {
            border-bottom: none;
        }
        
        /* ==================== RESPONSIVE ==================== */
        @media (max-width: 768px) {
            .broadcast-page {
                padding: 16px;
            }
            
            .broadcast-tabs {
                padding: 4px;
            }
            
            .broadcast-tab {
                padding: 10px 14px;
                font-size: 13px;
            }
            
            .broadcast-tab span {
                display: none;
            }
        }
    </style>
</head>
<body>
    <div class="app">
        <main class="main">
            <div class="main__content">
                <div class="broadcast-page">
                    <div class="broadcast-container">
                    
                    <!-- Header -->
                    <div class="broadcast-header">
                        <h1 class="broadcast-header__title">
                            <svg viewBox="0 0 24 24" fill="currentColor">
                                <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-1 17.93c-3.95-.49-7-3.85-7-7.93 0-.62.08-1.21.21-1.79L9 15v1c0 1.1.9 2 2 2v1.93zm6.9-2.54c-.26-.81-1-1.39-1.9-1.39h-1v-3c0-.55-.45-1-1-1H8v-2h2c.55 0 1-.45 1-1V7h2c1.1 0 2-.9 2-2v-.41c2.93 1.19 5 4.06 5 7.41 0 2.08-.8 3.97-2.1 5.39z"/>
                            </svg>
                            Broadcast Center
                        </h1>
                        <p class="broadcast-header__subtitle">Kommuniziere mit deinen Spielern in Echtzeit</p>
                    </div>
                    
                    <!-- Tab Navigation -->
                    <div class="broadcast-tabs">
                        <button class="broadcast-tab active" data-tab="broadcast" onclick="BC.switchTab('broadcast')">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polygon points="22 2 15 22 11 13 2 9 22 2"/></svg>
                            <span>Broadcast</span>
                        </button>
                        <button class="broadcast-tab" data-tab="poll" onclick="BC.switchTab('poll')">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 20V10M12 20V4M6 20v-6"/></svg>
                            <span>Umfragen</span>
                        </button>
                        <button class="broadcast-tab" data-tab="reactions" onclick="BC.switchTab('reactions')">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><path d="M8 14s1.5 2 4 2 4-2 4-2"/><line x1="9" y1="9" x2="9.01" y2="9"/><line x1="15" y1="9" x2="15.01" y2="9"/></svg>
                            <span>Reaktionen</span>
                        </button>
                        <button class="broadcast-tab" data-tab="spotlight" onclick="BC.switchTab('spotlight')">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="3"/><path d="M12 1v2M12 21v2M4.22 4.22l1.42 1.42M18.36 18.36l1.42 1.42M1 12h2M21 12h2M4.22 19.78l1.42-1.42M18.36 5.64l1.42-1.42"/></svg>
                            <span>Spotlight</span>
                        </button>
                        <button class="broadcast-tab" data-tab="cinematic" onclick="BC.switchTab('cinematic')">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="2" y="2" width="20" height="20" rx="2.18" ry="2.18"/><line x1="7" y1="2" x2="7" y2="22"/><line x1="17" y1="2" x2="17" y2="22"/><line x1="2" y1="12" x2="22" y2="12"/><line x1="2" y1="7" x2="7" y2="7"/><line x1="2" y1="17" x2="7" y2="17"/><line x1="17" y1="17" x2="22" y2="17"/><line x1="17" y1="7" x2="22" y2="7"/></svg>
                            <span>Cinematic</span>
                        </button>
                        <button class="broadcast-tab" data-tab="history" onclick="BC.switchTab('history')">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>
                            <span>Verlauf</span>
                        </button>
                    </div>
                    
                    <!-- ==================== BROADCAST PANEL ==================== -->
                    <div class="broadcast-panel active" id="panel-broadcast">
                        <div class="broadcast-grid">
                            <div class="bc-card">
                                <div class="bc-card__header">
                                    <div class="bc-card__title">
                                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polygon points="22 2 15 22 11 13 2 9 22 2"/></svg>
                                        Neue Nachricht
                                    </div>
                                </div>
                                <div class="bc-card__body">
                                    <!-- Broadcast Type -->
                                    <div class="bc-field">
                                        <label class="bc-label">Nachrichten-Typ</label>
                                        <div class="bc-types" id="broadcastTypes">
                                            <div class="bc-type bc-type--info active" data-type="info" onclick="BC.selectType('info')">
                                                <div class="bc-type__icon">üí°</div>
                                                <span class="bc-type__label">Info</span>
                                            </div>
                                            <div class="bc-type bc-type--warning" data-type="warning" onclick="BC.selectType('warning')">
                                                <div class="bc-type__icon">‚ö†Ô∏è</div>
                                                <span class="bc-type__label">Warnung</span>
                                            </div>
                                            <div class="bc-type bc-type--danger" data-type="danger" onclick="BC.selectType('danger')">
                                                <div class="bc-type__icon">üö®</div>
                                                <span class="bc-type__label">Gefahr</span>
                                            </div>
                                            <div class="bc-type bc-type--success" data-type="success" onclick="BC.selectType('success')">
                                                <div class="bc-type__icon">‚úÖ</div>
                                                <span class="bc-type__label">Erfolg</span>
                                            </div>
                                            <div class="bc-type bc-type--epic" data-type="epic" onclick="BC.selectType('epic')">
                                                <div class="bc-type__icon">‚öîÔ∏è</div>
                                                <span class="bc-type__label">Episch</span>
                                            </div>
                                            <div class="bc-type bc-type--mystery" data-type="mystery" onclick="BC.selectType('mystery')">
                                                <div class="bc-type__icon">üîÆ</div>
                                                <span class="bc-type__label">Mysteri√∂s</span>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <!-- Message -->
                                    <div class="bc-field">
                                        <label class="bc-label">Nachricht</label>
                                        <textarea class="bc-textarea" id="broadcastMessage" placeholder="Deine Nachricht an die Spieler..."></textarea>
                                    </div>
                                    
                                    <!-- Image Upload -->
                                    <div class="bc-field">
                                        <label class="bc-label">Bild (optional)</label>
                                        <div class="bc-image-upload" id="broadcastImageUpload" onclick="document.getElementById('broadcastImageInput').click()">
                                            <div class="bc-image-upload__placeholder" id="broadcastImagePlaceholder">
                                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><rect x="3" y="3" width="18" height="18" rx="2"/><circle cx="8.5" cy="8.5" r="1.5"/><path d="M21 15l-5-5L5 21"/></svg>
                                                <span>Bild hochladen oder hierher ziehen</span>
                                            </div>
                                            <img id="broadcastImagePreview" class="bc-image-upload__preview" style="display:none;">
                                        </div>
                                        <input type="file" id="broadcastImageInput" accept="image/*" onchange="BC.handleImageUpload(event, 'broadcast')">
                                    </div>
                                    
                                    <!-- Sound -->
                                    <div class="bc-field">
                                        <label class="bc-label">Sound</label>
                                        <div class="bc-sounds" id="broadcastSounds">
                                            <div class="bc-sound active" data-sound="none" onclick="BC.selectSound('none')">
                                                üîá Keiner
                                            </div>
                                            <div class="bc-sound" data-sound="notification" onclick="BC.selectSound('notification')">
                                                üîî Standard
                                                <button class="bc-sound__preview" onclick="event.stopPropagation(); BC.previewSound('notification')">‚ñ∂</button>
                                            </div>
                                            <div class="bc-sound" data-sound="fanfare" onclick="BC.selectSound('fanfare')">
                                                üé∫ Fanfare
                                                <button class="bc-sound__preview" onclick="event.stopPropagation(); BC.previewSound('fanfare')">‚ñ∂</button>
                                            </div>
                                            <div class="bc-sound" data-sound="dramatic" onclick="BC.selectSound('dramatic')">
                                                üé≠ Dramatisch
                                                <button class="bc-sound__preview" onclick="event.stopPropagation(); BC.previewSound('dramatic')">‚ñ∂</button>
                                            </div>
                                            <div class="bc-sound" data-sound="combat" onclick="BC.selectSound('combat')">
                                                ‚öîÔ∏è Kampf
                                                <button class="bc-sound__preview" onclick="event.stopPropagation(); BC.previewSound('combat')">‚ñ∂</button>
                                            </div>
                                            <div class="bc-sound" data-sound="mystery" onclick="BC.selectSound('mystery')">
                                                üåô Mysteri√∂s
                                                <button class="bc-sound__preview" onclick="event.stopPropagation(); BC.previewSound('mystery')">‚ñ∂</button>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <!-- Target Players -->
                                    <div class="bc-field">
                                        <label class="bc-label">Empf√§nger</label>
                                        <div class="bc-players" id="broadcastTargets">
                                            <div class="bc-player selected" data-target="all" onclick="BC.toggleTarget('all')">
                                                <div class="bc-player__avatar" style="background: var(--accent);">üë•</div>
                                                <span class="bc-player__name">Alle Spieler</span>
                                                <div class="bc-player__check"></div>
                                            </div>
                                            <!-- Players loaded dynamically -->
                                        </div>
                                    </div>
                                    
                                    <button class="bc-btn bc-btn--full" onclick="BC.sendBroadcast()">
                                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polygon points="22 2 15 22 11 13 2 9 22 2"/></svg>
                                        Broadcast senden
                                    </button>
                                </div>
                            </div>
                            
                            <!-- Sidebar: Dice Request & Handouts -->
                            <div style="display: flex; flex-direction: column; gap: 24px;">
                                <!-- Dice Request -->
                                <div class="bc-card">
                                    <div class="bc-card__header">
                                        <div class="bc-card__title">
                                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="18" height="18" rx="2"/><circle cx="8.5" cy="8.5" r="1"/><circle cx="15.5" cy="8.5" r="1"/><circle cx="8.5" cy="15.5" r="1"/><circle cx="15.5" cy="15.5" r="1"/><circle cx="12" cy="12" r="1"/></svg>
                                            W√ºrfelanforderung
                                        </div>
                                    </div>
                                    <div class="bc-card__body">
                                        <div class="bc-field">
                                            <label class="bc-label">W√ºrfelart</label>
                                            <select class="bc-input" id="diceRequestType">
                                                <option value="d4">W4</option>
                                                <option value="d6">W6</option>
                                                <option value="d10">W10</option>
                                                <option value="d12">W12</option>
                                                <option value="d20" selected>W20 (Standard)</option>
                                                <option value="d100">W100</option>
                                                <option value="d20+mod">W20 + Modifikator</option>
                                                <option value="custom">Benutzerdefiniert</option>
                                            </select>
                                        </div>
                                        <div class="bc-field">
                                            <label class="bc-label">Beschreibung</label>
                                            <input type="text" class="bc-input" id="diceRequestDesc" placeholder="z.B. Wahrnehmungsprobe">
                                        </div>
                                        <div class="bc-field">
                                            <label class="bc-label">Empf√§nger</label>
                                            <div class="bc-players" id="diceRequestTargets">
                                                <div class="bc-player selected" data-target="all" onclick="BC.toggleDiceTarget('all')">
                                                    <div class="bc-player__avatar" style="background: #8b5cf6;">üë•</div>
                                                    <span class="bc-player__name">Alle Spieler</span>
                                                    <div class="bc-player__check"></div>
                                                </div>
                                            </div>
                                        </div>
                                        <button class="bc-btn bc-btn--full bc-btn--secondary" onclick="BC.sendDiceRequest()">
                                            üé≤ W√ºrfeln lassen
                                        </button>
                                    </div>
                                </div>
                                
                                <!-- Quick Handout -->
                                <div class="bc-card">
                                    <div class="bc-card__header">
                                        <div class="bc-card__title">
                                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/></svg>
                                            Schnelles Handout
                                        </div>
                                    </div>
                                    <div class="bc-card__body">
                                        <div class="bc-image-upload" id="handoutUpload" onclick="document.getElementById('handoutInput').click()">
                                            <div class="bc-image-upload__placeholder">
                                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/></svg>
                                                <span>Handout hochladen</span>
                                            </div>
                                        </div>
                                        <input type="file" id="handoutInput" accept="image/*" onchange="BC.handleHandoutUpload(event)">
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- ==================== POLL PANEL ==================== -->
                    <div class="broadcast-panel" id="panel-poll">
                        <div class="broadcast-grid">
                            <div>
                                <!-- Active Poll Display -->
                                <div class="bc-active" id="activePoll" style="display:none;">
                                    <div class="bc-active__header">
                                        <div class="bc-active__badge">
                                            <span>AKTIVE UMFRAGE</span>
                                            <span id="activePollCountdown" style="margin-left: 12px; color: #f59e0b; font-weight: 700;"></span>
                                        </div>
                                        <div style="display: flex; gap: 8px;">
                                            <button class="bc-btn bc-btn--small bc-btn--success" onclick="BC.resolvePoll()">üèÜ Aufl√∂sen</button>
                                            <button class="bc-btn bc-btn--small bc-btn--secondary" onclick="BC.closePoll()">‚úï Schlie√üen</button>
                                        </div>
                                    </div>
                                    <div class="bc-active__content" id="activePollQuestion">-</div>
                                    <div class="bc-active__results" id="activePollResults"></div>
                                    <div id="activePollVoters" style="margin-top: 12px; font-size: 12px; color: rgba(255,255,255,0.5);"></div>
                                </div>
                                
                                <div class="bc-card">
                                    <div class="bc-card__header">
                                        <div class="bc-card__title">
                                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 20V10M12 20V4M6 20v-6"/></svg>
                                            Neue Umfrage
                                        </div>
                                    </div>
                                    <div class="bc-card__body">
                                        <!-- Question -->
                                        <div class="bc-field">
                                            <label class="bc-label">Frage</label>
                                            <input type="text" class="bc-input" id="pollQuestion" placeholder="Deine Frage an die Spieler...">
                                        </div>
                                        
                                        <!-- Quick Presets -->
                                        <div class="bc-field">
                                            <label class="bc-label">Schnellauswahl</label>
                                            <div style="display: flex; gap: 8px; flex-wrap: wrap;">
                                                <button class="bc-countdown-btn" onclick="BC.setPollPreset('yesno')">Ja / Nein</button>
                                                <button class="bc-countdown-btn" onclick="BC.setPollPreset('abc')">A / B / C</button>
                                                <button class="bc-countdown-btn" onclick="BC.setPollPreset('numbers')">1 - 5</button>
                                                <button class="bc-countdown-btn" onclick="BC.setPollPreset('werewolf')">"Wer war's?"</button>
                                            </div>
                                        </div>
                                        
                                        <!-- Poll Image -->
                                        <div class="bc-field">
                                            <label class="bc-label">Bild (optional)</label>
                                            <div class="bc-image-upload" id="pollImageUpload" onclick="document.getElementById('pollImageInput').click()" style="padding: 20px;">
                                                <div class="bc-image-upload__placeholder" id="pollImagePlaceholder">
                                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" style="width:32px;height:32px;"><rect x="3" y="3" width="18" height="18" rx="2"/><circle cx="8.5" cy="8.5" r="1.5"/><path d="M21 15l-5-5L5 21"/></svg>
                                                    <span>Bild hinzuf√ºgen</span>
                                                </div>
                                                <img id="pollImagePreview" class="bc-image-upload__preview" style="display:none;">
                                            </div>
                                            <input type="file" id="pollImageInput" accept="image/*" onchange="BC.handleImageUpload(event, 'poll')">
                                        </div>
                                        
                                        <!-- Options -->
                                        <div class="bc-field">
                                            <label class="bc-label">Antwortm√∂glichkeiten</label>
                                            <div class="bc-poll-options" id="pollOptions">
                                                <div class="bc-poll-option" data-index="0">
                                                    <button class="bc-poll-option__emoji" onclick="BC.openEmojiPicker(0)">‚ûä</button>
                                                    <input type="text" class="bc-input bc-poll-option__input" placeholder="Option 1">
                                                </div>
                                                <div class="bc-poll-option" data-index="1">
                                                    <button class="bc-poll-option__emoji" onclick="BC.openEmojiPicker(1)">‚ûã</button>
                                                    <input type="text" class="bc-input bc-poll-option__input" placeholder="Option 2">
                                                </div>
                                            </div>
                                            <button class="bc-btn bc-btn--secondary bc-btn--small" style="margin-top: 12px;" onclick="BC.addPollOption()">
                                                + Option hinzuf√ºgen
                                            </button>
                                        </div>
                                        
                                        <!-- Poll Settings -->
                                        <div class="bc-poll-settings">
                                            <label class="bc-toggle">
                                                <input type="checkbox" id="pollCountdown">
                                                <div class="bc-toggle__switch"></div>
                                                <span class="bc-toggle__label">‚è±Ô∏è Mit Countdown</span>
                                            </label>
                                            <label class="bc-toggle">
                                                <input type="checkbox" id="pollMultiple">
                                                <div class="bc-toggle__switch"></div>
                                                <span class="bc-toggle__label">‚òëÔ∏è Mehrfachauswahl</span>
                                            </label>
                                            <label class="bc-toggle">
                                                <input type="checkbox" id="pollBlind">
                                                <div class="bc-toggle__switch"></div>
                                                <span class="bc-toggle__label">üôà Blind Vote</span>
                                            </label>
                                            <label class="bc-toggle">
                                                <input type="checkbox" id="pollShowVoters">
                                                <div class="bc-toggle__switch"></div>
                                                <span class="bc-toggle__label">üë• Voter anzeigen</span>
                                            </label>
                                            <label class="bc-toggle">
                                                <input type="checkbox" id="pollNoEmojis">
                                                <div class="bc-toggle__switch"></div>
                                                <span class="bc-toggle__label">üö´ Ohne Emojis</span>
                                            </label>
                                            <label class="bc-toggle">
                                                <input type="checkbox" id="pollSound" checked>
                                                <div class="bc-toggle__switch"></div>
                                                <span class="bc-toggle__label">üîî Mit Sound</span>
                                            </label>
                                        </div>
                                        
                                        <!-- Countdown Time -->
                                        <div class="bc-field" id="countdownField" style="display:none; margin-top: 20px;">
                                            <label class="bc-label">Countdown Zeit</label>
                                            <div class="bc-countdown-selector">
                                                <button class="bc-countdown-btn" data-time="15" onclick="BC.setCountdown(15)">15s</button>
                                                <button class="bc-countdown-btn active" data-time="30" onclick="BC.setCountdown(30)">30s</button>
                                                <button class="bc-countdown-btn" data-time="60" onclick="BC.setCountdown(60)">1 min</button>
                                                <button class="bc-countdown-btn" data-time="120" onclick="BC.setCountdown(120)">2 min</button>
                                                <button class="bc-countdown-btn" data-time="300" onclick="BC.setCountdown(300)">5 min</button>
                                            </div>
                                        </div>
                                        
                                        <button class="bc-btn bc-btn--full" style="margin-top: 24px;" onclick="BC.startPoll()">
                                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 20V10M12 20V4M6 20v-6"/></svg>
                                            Umfrage starten
                                        </button>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Poll History -->
                            <div class="bc-card">
                                <div class="bc-card__header">
                                    <div class="bc-card__title">
                                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>
                                        Umfrage-Verlauf
                                    </div>
                                </div>
                                <div class="bc-card__body" style="padding: 0;">
                                    <div class="bc-history" id="pollHistory">
                                        <div class="bc-empty">
                                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M18 20V10M12 20V4M6 20v-6"/></svg>
                                            <div class="bc-empty__title">Keine Umfragen</div>
                                            <p>Vergangene Umfragen erscheinen hier</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- ==================== REACTIONS PANEL ==================== -->
                    <div class="broadcast-panel" id="panel-reactions">
                        <div class="bc-card">
                            <div class="bc-card__header">
                                <div class="bc-card__title">
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><path d="M8 14s1.5 2 4 2 4-2 4-2"/></svg>
                                    Schnelle Reaktionen
                                </div>
                                <label class="bc-toggle">
                                    <input type="checkbox" id="reactionSound" checked>
                                    <span class="bc-toggle__switch"></span>
                                    <span class="bc-toggle__label">üîä Sound</span>
                                </label>
                            </div>
                            <div class="bc-card__body">
                                <div class="bc-reactions" style="grid-template-columns: repeat(5, 1fr);">
                                    <div class="bc-reaction" onclick="BC.sendReaction('thumbsup', 'üëç')">
                                        <span class="bc-reaction__emoji">üëç</span>
                                    </div>
                                    <div class="bc-reaction" onclick="BC.sendReaction('thumbsdown', 'üëé')">
                                        <span class="bc-reaction__emoji">üëé</span>
                                    </div>
                                    <div class="bc-reaction" onclick="BC.sendReaction('fire', 'üî•')">
                                        <span class="bc-reaction__emoji">üî•</span>
                                    </div>
                                    <div class="bc-reaction" onclick="BC.sendReaction('skull', 'üíÄ')">
                                        <span class="bc-reaction__emoji">üíÄ</span>
                                    </div>
                                    <div class="bc-reaction" onclick="BC.sendReaction('laugh', 'üòÇ')">
                                        <span class="bc-reaction__emoji">üòÇ</span>
                                    </div>
                                    <div class="bc-reaction" onclick="BC.sendReaction('think', 'ü§î')">
                                        <span class="bc-reaction__emoji">ü§î</span>
                                    </div>
                                    <div class="bc-reaction" onclick="BC.sendReaction('crown', 'üëë')">
                                        <span class="bc-reaction__emoji">üëë</span>
                                    </div>
                                    <div class="bc-reaction" onclick="BC.sendReaction('heart', '‚ù§Ô∏è')">
                                        <span class="bc-reaction__emoji">‚ù§Ô∏è</span>
                                    </div>
                                    <div class="bc-reaction" onclick="BC.sendReaction('star', '‚≠ê')">
                                        <span class="bc-reaction__emoji">‚≠ê</span>
                                    </div>
                                    <div class="bc-reaction" onclick="BC.sendReaction('clap', 'üëè')">
                                        <span class="bc-reaction__emoji">üëè</span>
                                    </div>
                                    <div class="bc-reaction" onclick="BC.sendReaction('eyes', 'üëÄ')">
                                        <span class="bc-reaction__emoji">üëÄ</span>
                                    </div>
                                    <div class="bc-reaction" onclick="BC.sendReaction('question', '‚ùì')">
                                        <span class="bc-reaction__emoji">‚ùì</span>
                                    </div>
                                    <div class="bc-reaction" onclick="BC.sendReaction('exclaim', '‚ùó')">
                                        <span class="bc-reaction__emoji">‚ùó</span>
                                    </div>
                                    <div class="bc-reaction" onclick="BC.sendReaction('swords', '‚öîÔ∏è')">
                                        <span class="bc-reaction__emoji">‚öîÔ∏è</span>
                                    </div>
                                    <div class="bc-reaction" onclick="BC.sendReaction('shield', 'üõ°Ô∏è')">
                                        <span class="bc-reaction__emoji">üõ°Ô∏è</span>
                                    </div>
                                    <div class="bc-reaction" onclick="BC.sendReaction('dice', 'üé≤')">
                                        <span class="bc-reaction__emoji">üé≤</span>
                                    </div>
                                    <div class="bc-reaction" onclick="BC.sendReaction('magic', '‚ú®')">
                                        <span class="bc-reaction__emoji">‚ú®</span>
                                    </div>
                                    <div class="bc-reaction" onclick="BC.sendReaction('potion', 'üß™')">
                                        <span class="bc-reaction__emoji">üß™</span>
                                    </div>
                                    <div class="bc-reaction" onclick="BC.sendReaction('dragon', 'üêâ')">
                                        <span class="bc-reaction__emoji">üêâ</span>
                                    </div>
                                    <div class="bc-reaction" onclick="BC.sendReaction('wizard', 'üßô')">
                                        <span class="bc-reaction__emoji">üßô</span>
                                    </div>
                                </div>
                                
                                <!-- Custom Reaction with Emoji Picker -->
                                <div style="margin-top: 24px; padding-top: 20px; border-top: 1px solid rgba(255,255,255,0.08);">
                                    <label class="bc-label">Eigene Reaktion</label>
                                    <div style="display: flex; gap: 10px; margin-top: 8px; align-items: flex-start;">
                                        <div style="position: relative;">
                                            <button class="bc-btn bc-btn--secondary" id="emojiPickerBtn" onclick="BC.toggleEmojiPicker()" style="width: 60px; height: 44px; font-size: 24px;">
                                                <span id="selectedEmoji">üéâ</span>
                                            </button>
                                            <div id="emojiPicker" style="display: none; position: absolute; bottom: 54px; left: 0; background: #1a1a1a; border: 1px solid rgba(255,255,255,0.1); border-radius: 12px; padding: 12px; width: 280px; max-height: 200px; overflow-y: auto; z-index: 100;">
                                                <div id="emojiPickerGrid" style="display: grid; grid-template-columns: repeat(7, 1fr); gap: 4px;">
                                                    <!-- Emojis loaded dynamically -->
                                                </div>
                                            </div>
                                        </div>
                                        <input type="text" class="bc-input" id="customReactionText" placeholder="Optionaler Text..." style="flex: 1;">
                                        <button class="bc-btn" onclick="BC.sendCustomReaction()">Senden</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- ==================== SPOTLIGHT PANEL ==================== -->
                    <div class="broadcast-panel" id="panel-spotlight">
                        <div class="broadcast-grid">
                            <div class="bc-card">
                                <div class="bc-card__header">
                                    <div class="bc-card__title">
                                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="3"/><path d="M12 1v2M12 21v2M4.22 4.22l1.42 1.42M18.36 18.36l1.42 1.42M1 12h2M21 12h2"/></svg>
                                        Spotlight
                                    </div>
                                </div>
                                <div class="bc-card__body">
                                    <p style="color: var(--text-muted); margin-bottom: 20px;">W√§hle einen Spieler, um ihn in den Fokus zu setzen. Alle anderen sehen eine dramatische Ank√ºndigung.</p>
                                    
                                    <div class="bc-field">
                                        <label class="bc-label">Spieler ausw√§hlen</label>
                                        <div class="bc-players" id="spotlightPlayers">
                                            <!-- Players loaded dynamically -->
                                        </div>
                                    </div>
                                    
                                    <div class="bc-field">
                                        <label class="bc-label">Nachricht (optional)</label>
                                        <input type="text" class="bc-input" id="spotlightMessage" placeholder="z.B. Du bist dran!">
                                    </div>
                                    
                                    <button class="bc-btn bc-btn--full" onclick="BC.sendSpotlight()">
                                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="3"/></svg>
                                        Spotlight aktivieren
                                    </button>
                                </div>
                            </div>
                            
                            <!-- Private Message -->
                            <div class="bc-card">
                                <div class="bc-card__header">
                                    <div class="bc-card__title">
                                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"/><polyline points="22,6 12,13 2,6"/></svg>
                                        Geheime Nachricht
                                    </div>
                                </div>
                                <div class="bc-card__body">
                                    <p style="color: rgba(255,255,255,0.5); margin-bottom: 20px;">Sende eine Nachricht, die nur ein bestimmter Spieler sieht.</p>
                                    
                                    <div class="bc-field">
                                        <label class="bc-label">Empf√§nger</label>
                                        <div class="bc-players" id="secretPlayers">
                                            <!-- Players loaded dynamically -->
                                        </div>
                                    </div>
                                    
                                    <div class="bc-field">
                                        <label class="bc-label">Nachricht</label>
                                        <textarea class="bc-textarea" id="secretMessage" placeholder="Nur dieser Spieler wird diese Nachricht sehen..."></textarea>
                                    </div>
                                    
                                    <div class="bc-field">
                                        <label class="bc-toggle" style="width: fit-content;">
                                            <input type="checkbox" id="secretSound" checked>
                                            <span class="bc-toggle__switch"></span>
                                            <span class="bc-toggle__label">üîä Sound abspielen</span>
                                        </label>
                                    </div>
                                    
                                    <button class="bc-btn bc-btn--full bc-btn--secondary" onclick="BC.sendSecretMessage()">
                                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/></svg>
                                        Geheim senden
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- ==================== CINEMATIC PANEL ==================== -->
                    <div class="broadcast-panel" id="panel-cinematic">
                        <div class="bc-card">
                            <div class="bc-card__header">
                                <div class="bc-card__title">
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="2" y="2" width="20" height="20" rx="2.18" ry="2.18"/><line x1="7" y1="2" x2="7" y2="22"/><line x1="17" y1="2" x2="17" y2="22"/></svg>
                                    Cinematic Effekte
                                </div>
                            </div>
                            <div class="bc-card__body">
                                <div class="bc-cinematic-grid">
                                    <!-- Scene Transition -->
                                    <div class="bc-cinematic" onclick="BC.openCinematic('scene')">
                                        <div class="bc-cinematic__preview" style="background: linear-gradient(135deg, #1a1a2e, #16213e);">üé¨</div>
                                        <div class="bc-cinematic__label">Szenen-√úbergang</div>
                                    </div>
                                    
                                    <!-- Dramatic Reveal -->
                                    <div class="bc-cinematic" onclick="BC.openCinematic('reveal')">
                                        <div class="bc-cinematic__preview" style="background: linear-gradient(135deg, #2d1b4e, #1a1a2e);">‚ú®</div>
                                        <div class="bc-cinematic__label">Dramatic Reveal</div>
                                    </div>
                                    
                                    <!-- Combat Start -->
                                    <div class="bc-cinematic" onclick="BC.openCinematic('combat')">
                                        <div class="bc-cinematic__preview" style="background: linear-gradient(135deg, #4a1c1c, #1a1a2e);">‚öîÔ∏è</div>
                                        <div class="bc-cinematic__label">Kampf beginnt!</div>
                                    </div>
                                    
                                    <!-- Ambient Change -->
                                    <div class="bc-cinematic" onclick="BC.openCinematic('ambient')">
                                        <div class="bc-cinematic__preview" style="background: linear-gradient(135deg, #1a3a2e, #1a1a2e);">üåô</div>
                                        <div class="bc-cinematic__label">Atmosph√§re</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Scene Transition Card (hidden by default) -->
                        <div class="bc-card" id="cinematicScene" style="display:none; margin-top: 24px;">
                            <div class="bc-card__header">
                                <div class="bc-card__title">üé¨ Szenen-√úbergang</div>
                                <button class="bc-btn bc-btn--small bc-btn--secondary" onclick="BC.closeCinematic()">‚úï</button>
                            </div>
                            <div class="bc-card__body">
                                <div class="bc-field">
                                    <label class="bc-label">Text</label>
                                    <input type="text" class="bc-input" id="sceneText" placeholder="z.B. 3 Tage sp√§ter...">
                                </div>
                                <div class="bc-field">
                                    <label class="bc-label">Stil</label>
                                    <div style="display: flex; gap: 8px; flex-wrap: wrap;">
                                        <button class="bc-countdown-btn active" data-style="fade" onclick="BC.setSceneStyle('fade')">Fade</button>
                                        <button class="bc-countdown-btn" data-style="slide" onclick="BC.setSceneStyle('slide')">Slide</button>
                                        <button class="bc-countdown-btn" data-style="zoom" onclick="BC.setSceneStyle('zoom')">Zoom</button>
                                    </div>
                                </div>
                                <div class="bc-field">
                                    <label class="bc-toggle" style="width: fit-content;">
                                        <input type="checkbox" id="sceneSound" checked>
                                        <span class="bc-toggle__switch"></span>
                                        <span class="bc-toggle__label">üîä Sound abspielen</span>
                                    </label>
                                </div>
                                <button class="bc-btn bc-btn--full" onclick="BC.sendSceneTransition()">Abspielen</button>
                            </div>
                        </div>
                        
                        <!-- Dramatic Reveal Card -->
                        <div class="bc-card" id="cinematicReveal" style="display:none; margin-top: 24px;">
                            <div class="bc-card__header">
                                <div class="bc-card__title">‚ú® Dramatic Reveal</div>
                                <button class="bc-btn bc-btn--small bc-btn--secondary" onclick="BC.closeCinematic()">‚úï</button>
                            </div>
                            <div class="bc-card__body">
                                <div class="bc-field">
                                    <label class="bc-label">Bild</label>
                                    <div class="bc-image-upload" id="revealImageUpload" onclick="document.getElementById('revealImageInput').click()">
                                        <div class="bc-image-upload__placeholder">
                                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" style="width:32px;height:32px;"><rect x="3" y="3" width="18" height="18" rx="2"/><circle cx="8.5" cy="8.5" r="1.5"/><path d="M21 15l-5-5L5 21"/></svg>
                                            <span>Reveal-Bild hochladen</span>
                                        </div>
                                        <img id="revealImagePreview" class="bc-image-upload__preview" style="display:none;">
                                    </div>
                                    <input type="file" id="revealImageInput" accept="image/*" onchange="BC.handleImageUpload(event, 'reveal')">
                                </div>
                                <div class="bc-field">
                                    <label class="bc-label">Titel (optional)</label>
                                    <input type="text" class="bc-input" id="revealTitle" placeholder="z.B. Der wahre Feind...">
                                </div>
                                <div class="bc-field">
                                    <label class="bc-toggle" style="width: fit-content;">
                                        <input type="checkbox" id="revealSound" checked>
                                        <span class="bc-toggle__switch"></span>
                                        <span class="bc-toggle__label">üîä Dramatischer Sound</span>
                                    </label>
                                </div>
                                <button class="bc-btn bc-btn--full" onclick="BC.sendReveal()">‚ú® Enth√ºllen!</button>
                            </div>
                        </div>
                        
                        <!-- Combat Start Card -->
                        <div class="bc-card" id="cinematicCombat" style="display:none; margin-top: 24px;">
                            <div class="bc-card__header">
                                <div class="bc-card__title">‚öîÔ∏è Kampf beginnt!</div>
                                <button class="bc-btn bc-btn--small bc-btn--secondary" onclick="BC.closeCinematic()">‚úï</button>
                            </div>
                            <div class="bc-card__body">
                                <div class="bc-field">
                                    <label class="bc-label">Titel</label>
                                    <input type="text" class="bc-input" id="combatTitle" placeholder="z.B. INITIATIVE!" value="INITIATIVE!">
                                </div>
                                <div class="bc-field">
                                    <label class="bc-label">Untertitel (optional)</label>
                                    <input type="text" class="bc-input" id="combatSubtitle" placeholder="z.B. W√ºrfelt Initiative!">
                                </div>
                                <div class="bc-field">
                                    <label class="bc-toggle" style="width: fit-content;">
                                        <input type="checkbox" id="combatSound" checked>
                                        <span class="bc-toggle__switch"></span>
                                        <span class="bc-toggle__label">üîä Kampf-Sound</span>
                                    </label>
                                </div>
                                <button class="bc-btn bc-btn--full bc-btn--danger" onclick="BC.sendCombatStart()">‚öîÔ∏è Kampf starten!</button>
                            </div>
                        </div>
                        
                        <!-- Ambient Change Card -->
                        <div class="bc-card" id="cinematicAmbient" style="display:none; margin-top: 24px;">
                            <div class="bc-card__header">
                                <div class="bc-card__title">üåô Atmosph√§re √§ndern</div>
                                <button class="bc-btn bc-btn--small bc-btn--secondary" onclick="BC.closeCinematic()">‚úï</button>
                            </div>
                            <div class="bc-card__body">
                                <p style="font-size: 13px; color: rgba(255,255,255,0.5); margin-bottom: 16px;">
                                    Setzt einen dauerhaften visuellen Effekt auf allen Spielerbildschirmen.
                                </p>
                                <div class="bc-field">
                                    <label class="bc-label">Effekt w√§hlen</label>
                                    <div class="bc-cinematic-grid" style="grid-template-columns: repeat(4, 1fr);">
                                        <div class="bc-cinematic" style="aspect-ratio: 1;" data-ambient="rain" onclick="BC.selectAmbient('rain')">
                                            <div class="bc-cinematic__preview">üåßÔ∏è</div>
                                            <div class="bc-cinematic__label">Regen</div>
                                        </div>
                                        <div class="bc-cinematic" style="aspect-ratio: 1;" data-ambient="storm" onclick="BC.selectAmbient('storm')">
                                            <div class="bc-cinematic__preview">‚õàÔ∏è</div>
                                            <div class="bc-cinematic__label">Gewitter</div>
                                        </div>
                                        <div class="bc-cinematic" style="aspect-ratio: 1;" data-ambient="snow" onclick="BC.selectAmbient('snow')">
                                            <div class="bc-cinematic__preview">‚ùÑÔ∏è</div>
                                            <div class="bc-cinematic__label">Schnee</div>
                                        </div>
                                        <div class="bc-cinematic" style="aspect-ratio: 1;" data-ambient="fog" onclick="BC.selectAmbient('fog')">
                                            <div class="bc-cinematic__preview">üå´Ô∏è</div>
                                            <div class="bc-cinematic__label">Nebel</div>
                                        </div>
                                        <div class="bc-cinematic" style="aspect-ratio: 1;" data-ambient="fire" onclick="BC.selectAmbient('fire')">
                                            <div class="bc-cinematic__preview">üî•</div>
                                            <div class="bc-cinematic__label">Feuer</div>
                                        </div>
                                        <div class="bc-cinematic" style="aspect-ratio: 1;" data-ambient="darkness" onclick="BC.selectAmbient('darkness')">
                                            <div class="bc-cinematic__preview">üåë</div>
                                            <div class="bc-cinematic__label">Dunkelheit</div>
                                        </div>
                                        <div class="bc-cinematic" style="aspect-ratio: 1;" data-ambient="magic" onclick="BC.selectAmbient('magic')">
                                            <div class="bc-cinematic__preview">‚ú®</div>
                                            <div class="bc-cinematic__label">Magie</div>
                                        </div>
                                        <div class="bc-cinematic" style="aspect-ratio: 1;" data-ambient="blood" onclick="BC.selectAmbient('blood')">
                                            <div class="bc-cinematic__preview">ü©∏</div>
                                            <div class="bc-cinematic__label">Blut</div>
                                        </div>
                                        <div class="bc-cinematic" style="aspect-ratio: 1;" data-ambient="underwater" onclick="BC.selectAmbient('underwater')">
                                            <div class="bc-cinematic__preview">üåä</div>
                                            <div class="bc-cinematic__label">Unterwasser</div>
                                        </div>
                                        <div class="bc-cinematic" style="aspect-ratio: 1;" data-ambient="poison" onclick="BC.selectAmbient('poison')">
                                            <div class="bc-cinematic__preview">‚ò†Ô∏è</div>
                                            <div class="bc-cinematic__label">Gift</div>
                                        </div>
                                        <div class="bc-cinematic" style="aspect-ratio: 1;" data-ambient="holy" onclick="BC.selectAmbient('holy')">
                                            <div class="bc-cinematic__preview">üåü</div>
                                            <div class="bc-cinematic__label">Heilig</div>
                                        </div>
                                        <div class="bc-cinematic" style="aspect-ratio: 1;" data-ambient="clear" onclick="BC.selectAmbient('clear')">
                                            <div class="bc-cinematic__preview">‚òÄÔ∏è</div>
                                            <div class="bc-cinematic__label">Aus</div>
                                        </div>
                                    </div>
                                </div>
                                <button class="bc-btn bc-btn--full" onclick="BC.sendAmbient()">Atmosph√§re setzen</button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- ==================== HISTORY PANEL ==================== -->
                    <div class="broadcast-panel" id="panel-history">
                        <div class="bc-card">
                            <div class="bc-card__header">
                                <div class="bc-card__title">
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>
                                    Gesamtverlauf
                                </div>
                                <button class="bc-btn bc-btn--small bc-btn--secondary" onclick="BC.clearHistory()">L√∂schen</button>
                            </div>
                            <div class="bc-card__body" style="padding: 0;">
                                <div class="bc-history" id="fullHistory">
                                    <div class="bc-empty" id="historyEmpty">
                                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>
                                        <div class="bc-empty__title">Keine Eintr√§ge</div>
                                        <p>Broadcasts und Umfragen erscheinen hier</p>
                                    </div>
                                    <div id="historyList"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                </div>
            </div>
            </div>
        </main>
    </div>
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    
    <!-- RIFT Services -->
    <script src="assets/js/firebase-config.js"></script>
    <script src="assets/js/room-service.js"></script>
    <script src="assets/js/user-service.js"></script>
    <script src="assets/js/auth.js"></script>
    <script src="assets/js/ui.js"></script>
    <script src="assets/js/layout.js"></script>
    <script src="assets/js/settings.js"></script>
    <script src="assets/js/transitions.js"></script>
    <script src="assets/js/app.js"></script>
    <script>
        // Ensure DOM is ready before initializing layout
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', () => {
                initLayout();
            });
        } else {
            initLayout();
        }
    </script>
    
    <script>
        // ==================== BROADCAST CENTER ====================
        const BC = {
            db: null,
            roomCode: null,
            members: [],
            pollVotes: [],
            currentPoll: null,
            pollOptionCount: 2,
            selectedBroadcastType: 'info',
            selectedSound: 'none',
            selectedCountdown: 30,
            selectedAmbient: null,
            broadcastImageData: null,
            pollImageData: null,
            revealImageData: null,
            unsubs: [],
            
            pollEmojis: ['‚ûä','‚ûã','‚ûå','‚ûç','‚ûé','‚ûè','‚ûê','‚ûë','üÖ∞Ô∏è','üÖ±Ô∏è','‚úÖ','‚ùå','üëç','üëé','‚ù§Ô∏è','‚≠ê','üî•','üíé','üéØ','üé≤','‚öîÔ∏è','üõ°Ô∏è','üíÄ','üëë','üó°Ô∏è','üèÜ','üí∞','üé≠','üßô','üêâ','üè∞','üìú','‚ö°','üåü','üí´','üîÆ'],
            
            // ============ INIT ============
            async init() {
                console.log('[BC] Initializing Broadcast Center...');
                
                // Wait for Firebase to be ready
                let attempts = 0;
                while (!window.firebase?.firestore || !window.firebase?.auth) {
                    await new Promise(r => setTimeout(r, 100));
                    attempts++;
                    if (attempts > 50) {
                        console.error('[BC] Firebase not available after 5s');
                        return;
                    }
                }
                
                console.log('[BC] Firebase ready');
                this.db = firebase.firestore();
                
                // Wait for auth state
                const user = await new Promise(resolve => {
                    const unsubscribe = firebase.auth().onAuthStateChanged(u => {
                        unsubscribe();
                        resolve(u);
                    });
                });
                
                console.log('[BC] Auth user:', user?.uid);
                
                if (!user) {
                    console.log('[BC] No user logged in');
                    this.toast('Bitte einloggen!', 'error');
                    return;
                }
                
                this.roomCode = localStorage.getItem('rift_current_room');
                console.log('[BC] Room code:', this.roomCode);
                
                if (!this.roomCode) {
                    console.log('[BC] No room code');
                    this.toast('Kein Raum aktiv!', 'error');
                    return;
                }
                
                // Check if user is GM
                const isGM = await this.checkGM(user.uid);
                console.log('[BC] Is GM:', isGM);
                
                if (!isGM) {
                    this.toast('Nur f√ºr Spielleiter!', 'error');
                    setTimeout(() => {
                        window.location.href = 'index.html';
                    }, 1500);
                    return;
                }
                
                // Load members
                await this.loadMembers();
                
                // Subscribe to poll
                this.subPoll();
                
                // Setup countdown toggle
                const countdownCheckbox = document.getElementById('pollCountdown');
                if (countdownCheckbox) {
                    countdownCheckbox.addEventListener('change', (e) => {
                        document.getElementById('countdownField').style.display = e.target.checked ? 'block' : 'none';
                    });
                }
                
                console.log('[BC] Initialized successfully');
                this.toast('Broadcast Center bereit!', 'success');
            },
            
            async checkGM(uid) {
                try {
                    const doc = await this.db.collection('rooms').doc(this.roomCode).get();
                    const gmId = doc.data()?.gmId;
                    console.log('[BC] Room gmId:', gmId, 'User uid:', uid);
                    return doc.exists && gmId === uid;
                } catch (e) {
                    console.error('[BC] Error checking GM:', e);
                    return false;
                }
            },
            
            ref() {
                if (!this.db) {
                    console.error('[BC] Database not initialized!');
                    this.toast('Datenbank nicht bereit!', 'error');
                    return null;
                }
                return this.db.collection('rooms').doc(this.roomCode);
            },
            
            // ============ MEMBERS ============
            async loadMembers() {
                const ref = this.ref();
                if (!ref) return;
                
                try {
                    const snap = await ref.collection('members').get();
                    this.members = snap.docs.map(d => ({ id: d.id, ...d.data() }));
                    this.renderPlayerSelectors();
                    console.log('[BC] Loaded members:', this.members.length);
                } catch (e) {
                    console.error('[BC] Error loading members:', e);
                }
            },
            
            renderPlayerSelectors() {
                const players = this.members.filter(m => m.id !== firebase.auth().currentUser?.uid);
                
                const html = players.map(p => `
                    <div class="bc-player" data-id="${p.id}" onclick="BC.togglePlayerSelect(this, '${p.id}')">
                        <div class="bc-player__avatar" style="background: ${p.color || '#8b5cf6'};">${(p.name || '?')[0].toUpperCase()}</div>
                        <span class="bc-player__name">${p.name || 'Unbekannt'}</span>
                        <div class="bc-player__check"></div>
                    </div>
                `).join('');
                
                // Broadcast targets (with "All" option)
                const broadcastTargets = document.getElementById('broadcastTargets');
                if (broadcastTargets) {
                    broadcastTargets.innerHTML = `
                        <div class="bc-player selected" data-target="all" onclick="BC.toggleTarget('all')">
                            <div class="bc-player__avatar" style="background: #8b5cf6;">üë•</div>
                            <span class="bc-player__name">Alle Spieler</span>
                            <div class="bc-player__check"></div>
                        </div>
                        ${html}
                    `;
                }
                
                // Dice Request targets
                const diceTargets = document.getElementById('diceRequestTargets');
                if (diceTargets) {
                    diceTargets.innerHTML = `
                        <div class="bc-player selected" data-target="all" onclick="BC.toggleDiceTarget('all')">
                            <div class="bc-player__avatar" style="background: #8b5cf6;">üë•</div>
                            <span class="bc-player__name">Alle Spieler</span>
                            <div class="bc-player__check"></div>
                        </div>
                        ${players.map(p => `
                            <div class="bc-player" data-id="${p.id}" onclick="BC.toggleDiceTarget('${p.id}')">
                                <div class="bc-player__avatar" style="background: ${p.color || '#8b5cf6'};">${(p.name || '?')[0].toUpperCase()}</div>
                                <span class="bc-player__name">${p.name || 'Unbekannt'}</span>
                                <div class="bc-player__check"></div>
                            </div>
                        `).join('')}
                    `;
                }
                
                // Spotlight players
                if (document.getElementById('spotlightPlayers')) {
                    document.getElementById('spotlightPlayers').innerHTML = html;
                }
                if (document.getElementById('secretPlayers')) {
                    document.getElementById('secretPlayers').innerHTML = html;
                }
            },
            
            toggleTarget(target) {
                if (target === 'all') {
                    document.querySelectorAll('#broadcastTargets .bc-player').forEach(p => {
                        p.classList.toggle('selected', p.dataset.target === 'all');
                    });
                } else {
                    document.querySelector('#broadcastTargets .bc-player[data-target="all"]').classList.remove('selected');
                    document.querySelector(`#broadcastTargets .bc-player[data-id="${target}"]`)?.classList.toggle('selected');
                }
            },
            
            toggleDiceTarget(target) {
                if (target === 'all') {
                    document.querySelectorAll('#diceRequestTargets .bc-player').forEach(p => {
                        p.classList.toggle('selected', p.dataset.target === 'all');
                    });
                } else {
                    document.querySelector('#diceRequestTargets .bc-player[data-target="all"]').classList.remove('selected');
                    document.querySelector(`#diceRequestTargets .bc-player[data-id="${target}"]`)?.classList.toggle('selected');
                }
            },
            
            togglePlayerSelect(el, id) {
                const container = el.closest('.bc-players');
                container.querySelectorAll('.bc-player').forEach(p => p.classList.remove('selected'));
                el.classList.add('selected');
            },
            
            // ============ TABS ============
            switchTab(tab) {
                document.querySelectorAll('.broadcast-tab').forEach(t => t.classList.remove('active'));
                document.querySelector(`.broadcast-tab[data-tab="${tab}"]`).classList.add('active');
                
                document.querySelectorAll('.broadcast-panel').forEach(p => p.classList.remove('active'));
                document.getElementById(`panel-${tab}`).classList.add('active');
            },
            
            // ============ BROADCAST ============
            selectType(type) {
                this.selectedBroadcastType = type;
                document.querySelectorAll('#broadcastTypes .bc-type').forEach(t => {
                    t.classList.toggle('active', t.dataset.type === type);
                });
            },
            
            selectSound(sound) {
                this.selectedSound = sound;
                document.querySelectorAll('#broadcastSounds .bc-sound').forEach(s => {
                    s.classList.toggle('active', s.dataset.sound === sound);
                });
            },
            
            previewSound(sound) {
                // TODO: Implement sound preview
                console.log('[BC] Preview sound:', sound);
                this.toast('Sound: ' + sound, 'info');
            },
            
            handleImageUpload(event, target) {
                const file = event.target.files[0];
                if (!file) return;
                
                const reader = new FileReader();
                reader.onload = (e) => {
                    const data = e.target.result;
                    
                    if (target === 'broadcast') {
                        this.broadcastImageData = data;
                        document.getElementById('broadcastImagePreview').src = data;
                        document.getElementById('broadcastImagePreview').style.display = 'block';
                        document.getElementById('broadcastImagePlaceholder').style.display = 'none';
                        document.getElementById('broadcastImageUpload').classList.add('has-image');
                    } else if (target === 'poll') {
                        this.pollImageData = data;
                        document.getElementById('pollImagePreview').src = data;
                        document.getElementById('pollImagePreview').style.display = 'block';
                        document.getElementById('pollImagePlaceholder').style.display = 'none';
                        document.getElementById('pollImageUpload').classList.add('has-image');
                    } else if (target === 'reveal') {
                        this.revealImageData = data;
                        document.getElementById('revealImagePreview').src = data;
                        document.getElementById('revealImagePreview').style.display = 'block';
                        document.getElementById('revealImageUpload').classList.add('has-image');
                    }
                };
                reader.readAsDataURL(file);
            },
            
            async sendBroadcast() {
                const message = document.getElementById('broadcastMessage').value.trim();
                if (!message && !this.broadcastImageData) {
                    this.toast('Nachricht oder Bild erforderlich!', 'error');
                    return;
                }
                
                // Get selected targets
                const allSelected = document.querySelector('#broadcastTargets .bc-player[data-target="all"]').classList.contains('selected');
                let targets = null;
                if (!allSelected) {
                    targets = Array.from(document.querySelectorAll('#broadcastTargets .bc-player.selected'))
                        .map(p => p.dataset.id)
                        .filter(id => id);
                }
                
                const typeLabels = {
                    info: 'Info', warning: 'Warnung', danger: 'Gefahr',
                    success: 'Erfolg', epic: 'Episch', mystery: 'Mysteri√∂s'
                };
                
                try {
                    await this.ref().update({
                        broadcast: {
                            message,
                            type: this.selectedBroadcastType,
                            sound: this.selectedSound,
                            image: this.broadcastImageData || null,
                            targets,
                            id: Date.now(),
                            timestamp: firebase.firestore.FieldValue.serverTimestamp()
                        }
                    });
                    
                    // Clear form
                    document.getElementById('broadcastMessage').value = '';
                    this.broadcastImageData = null;
                    document.getElementById('broadcastImagePreview').style.display = 'none';
                    document.getElementById('broadcastImagePlaceholder').style.display = 'flex';
                    document.getElementById('broadcastImageUpload').classList.remove('has-image');
                    
                    this.addToHistory('broadcast', `${typeLabels[this.selectedBroadcastType] || 'Broadcast'}: ${message.substring(0, 50)}${message.length > 50 ? '...' : ''}`);
                    this.toast('Broadcast gesendet!', 'success');
                } catch (e) {
                    console.error('[BC] Broadcast error:', e);
                    this.toast('Fehler beim Senden', 'error');
                }
            },
            
            // ============ POLL ============
            subPoll() {
                // Subscribe to room for poll config
                const u = this.ref().onSnapshot(doc => {
                    const poll = doc.data()?.poll;
                    if (poll?.active) {
                        document.getElementById('activePoll').style.display = 'block';
                        document.getElementById('activePollQuestion').textContent = poll.question;
                        this.currentPoll = poll;
                        this.updatePollResults();
                        
                        // Start or update countdown
                        if (poll.countdown && poll.startedAt) {
                            this.startGMCountdown(poll.countdown, poll.startedAt);
                        } else {
                            document.getElementById('activePollCountdown').textContent = '';
                        }
                    } else {
                        document.getElementById('activePoll').style.display = 'none';
                        this.currentPoll = null;
                        this.stopGMCountdown();
                    }
                });
                this.unsubs.push(u);
                
                // Subscribe to poll_votes subcollection
                const v = this.ref().collection('poll_votes').onSnapshot(snap => {
                    this.pollVotes = snap.docs.map(d => ({ oderId: d.id, ...d.data() }));
                    this.updatePollResults();
                });
                this.unsubs.push(v);
            },
            
            gmCountdownInterval: null,
            
            startGMCountdown(countdown, startedAt) {
                this.stopGMCountdown();
                
                const startTime = startedAt?.toDate?.() || new Date(startedAt);
                const endTime = new Date(startTime.getTime() + countdown * 1000);
                
                const update = () => {
                    const now = new Date();
                    const remaining = Math.max(0, Math.ceil((endTime - now) / 1000));
                    document.getElementById('activePollCountdown').textContent = remaining > 0 ? `‚è±Ô∏è ${remaining}s` : '‚è±Ô∏è Abgelaufen';
                };
                
                update();
                this.gmCountdownInterval = setInterval(update, 1000);
            },
            
            stopGMCountdown() {
                if (this.gmCountdownInterval) {
                    clearInterval(this.gmCountdownInterval);
                    this.gmCountdownInterval = null;
                }
            },
            
            updatePollResults() {
                if (!this.currentPoll) return;
                const el = document.getElementById('activePollResults');
                const votersEl = document.getElementById('activePollVoters');
                const options = this.currentPoll.options || [];
                const emojis = this.currentPoll.emojis || [];
                const showVoters = this.currentPoll.showVoters;
                
                // Count votes from subcollection (support both single and multi-select)
                const voteCounts = {};
                const votersByOption = {};
                options.forEach(opt => {
                    voteCounts[opt] = 0;
                    votersByOption[opt] = [];
                });
                
                (this.pollVotes || []).forEach(vote => {
                    // Support multi-select (options array) and single select (option string)
                    const voteOptions = vote.options || (vote.option ? [vote.option] : []);
                    voteOptions.forEach(opt => {
                        if (voteCounts.hasOwnProperty(opt)) {
                            voteCounts[opt]++;
                            // Get voter name
                            const member = this.members.find(m => m.id === vote.oderId);
                            const voterName = member?.name || 'Unbekannt';
                            votersByOption[opt].push(voterName);
                        }
                    });
                });
                
                const total = Object.values(voteCounts).reduce((a, b) => a + b, 0) || 1;
                
                el.innerHTML = options.map((opt, i) => {
                    const count = voteCounts[opt] || 0;
                    const pct = Math.round((count / total) * 100);
                    const emoji = emojis[i] || '';
                    const label = emoji ? `${emoji} ${opt}` : opt;
                    const voters = showVoters && votersByOption[opt].length > 0 
                        ? `<div style="font-size: 11px; color: rgba(255,255,255,0.4); margin-top: 4px;">${votersByOption[opt].join(', ')}</div>` 
                        : '';
                    return `<div class="bc-active__result">
                        <span class="bc-active__result-label">${label}</span>
                        <div class="bc-active__result-bar">
                            <div class="bc-active__result-fill" style="width:${pct}%"></div>
                            <span class="bc-active__result-count">${count}</span>
                        </div>
                        ${voters}
                    </div>`;
                }).join('');
                
                // Show total voters
                const totalVoters = (this.pollVotes || []).length;
                if (votersEl) {
                    votersEl.textContent = `${totalVoters} Stimme${totalVoters !== 1 ? 'n' : ''} abgegeben`;
                }
            },
            
            setPollPreset(preset) {
                const container = document.getElementById('pollOptions');
                
                let options = [];
                let emojis = [];
                
                if (preset === 'yesno') {
                    options = ['Ja', 'Nein'];
                    emojis = ['‚úÖ', '‚ùå'];
                } else if (preset === 'abc') {
                    options = ['A', 'B', 'C'];
                    emojis = ['üÖ∞Ô∏è', 'üÖ±Ô∏è', '¬©Ô∏è'];
                } else if (preset === 'numbers') {
                    options = ['1', '2', '3', '4', '5'];
                    emojis = ['‚ûä', '‚ûã', '‚ûå', '‚ûç', '‚ûé'];
                } else if (preset === 'werewolf') {
                    // Load players as options
                    const players = this.members.filter(m => m.id !== firebase.auth().currentUser?.uid);
                    options = players.map(p => p.name || 'Unbekannt');
                    emojis = players.map(() => 'üé≠');
                }
                
                container.innerHTML = options.map((opt, i) => `
                    <div class="bc-poll-option" data-index="${i}">
                        <button class="bc-poll-option__emoji" onclick="BC.openEmojiPicker(${i})">${emojis[i] || this.pollEmojis[i]}</button>
                        <input type="text" class="bc-input bc-poll-option__input" placeholder="Option ${i + 1}" value="${opt}">
                        ${i > 1 ? `<button class="bc-poll-option__remove" onclick="BC.removePollOption(${i})">‚úï</button>` : ''}
                    </div>
                `).join('');
                
                this.pollOptionCount = options.length;
            },
            
            addPollOption() {
                if (this.pollOptionCount >= 10) {
                    this.toast('Maximum 10 Optionen', 'error');
                    return;
                }
                
                const container = document.getElementById('pollOptions');
                const index = this.pollOptionCount;
                const emoji = this.pollEmojis[index] || '‚≠ê';
                
                const row = document.createElement('div');
                row.className = 'bc-poll-option';
                row.dataset.index = index;
                row.innerHTML = `
                    <button class="bc-poll-option__emoji" onclick="BC.openEmojiPicker(${index})">${emoji}</button>
                    <input type="text" class="bc-input bc-poll-option__input" placeholder="Option ${index + 1}">
                    <button class="bc-poll-option__remove" onclick="BC.removePollOption(${index})">‚úï</button>
                `;
                container.appendChild(row);
                this.pollOptionCount++;
                
                row.querySelector('input').focus();
            },
            
            removePollOption(index) {
                const row = document.querySelector(`.bc-poll-option[data-index="${index}"]`);
                if (row) {
                    row.remove();
                    this.pollOptionCount--;
                }
            },
            
            openEmojiPicker(index) {
                // Simple emoji picker - could be enhanced
                const emojis = this.pollEmojis;
                const picker = document.createElement('div');
                picker.className = 'emoji-picker-modal';
                picker.style.cssText = `
                    position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
                    background: #1a1a1a; border: 1px solid rgba(255,255,255,0.1); border-radius: 12px;
                    padding: 16px; z-index: 10000; max-width: 320px;
                    display: grid; grid-template-columns: repeat(8, 1fr); gap: 4px;
                `;
                picker.innerHTML = emojis.map(e => `
                    <button style="width:36px;height:36px;background:transparent;border:none;font-size:20px;cursor:pointer;border-radius:6px;"
                        onmouseover="this.style.background='rgba(255,255,255,0.1)'"
                        onmouseout="this.style.background='transparent'"
                        onclick="BC.selectPollEmoji(${index}, '${e}'); this.closest('.emoji-picker-modal').remove()">
                        ${e}
                    </button>
                `).join('');
                
                // Backdrop
                const backdrop = document.createElement('div');
                backdrop.style.cssText = 'position:fixed;inset:0;background:rgba(0,0,0,0.5);z-index:9999;';
                backdrop.onclick = () => { backdrop.remove(); picker.remove(); };
                
                document.body.appendChild(backdrop);
                document.body.appendChild(picker);
            },
            
            selectPollEmoji(index, emoji) {
                const btn = document.querySelector(`.bc-poll-option[data-index="${index}"] .bc-poll-option__emoji`);
                if (btn) btn.textContent = emoji;
            },
            
            setCountdown(seconds) {
                this.selectedCountdown = seconds;
                document.querySelectorAll('.bc-countdown-selector .bc-countdown-btn').forEach(b => {
                    b.classList.toggle('active', parseInt(b.dataset.time) === seconds);
                });
            },
            
            async startPoll() {
                const question = document.getElementById('pollQuestion').value.trim();
                if (!question) {
                    this.toast('Frage eingeben!', 'error');
                    return;
                }
                
                // Collect options
                const options = [];
                const emojis = [];
                document.querySelectorAll('.bc-poll-option').forEach(row => {
                    const input = row.querySelector('input');
                    const emojiBtn = row.querySelector('.bc-poll-option__emoji');
                    const text = input.value.trim();
                    if (text) {
                        options.push(text);
                        emojis.push(emojiBtn.textContent);
                    }
                });
                
                if (options.length < 2) {
                    this.toast('Mindestens 2 Optionen!', 'error');
                    return;
                }
                
                const withCountdown = document.getElementById('pollCountdown').checked;
                const withMultiple = document.getElementById('pollMultiple').checked;
                const withBlind = document.getElementById('pollBlind').checked;
                const showVoters = document.getElementById('pollShowVoters').checked;
                const noEmojis = document.getElementById('pollNoEmojis').checked;
                const withSound = document.getElementById('pollSound').checked;
                
                try {
                    // Delete old votes first
                    const votesSnap = await this.ref().collection('poll_votes').get();
                    const batch = this.db.batch();
                    votesSnap.docs.forEach(doc => batch.delete(doc.ref));
                    if (votesSnap.docs.length) await batch.commit();
                    
                    const pollData = {
                        question,
                        options,
                        emojis: noEmojis ? [] : emojis,
                        withSound,
                        withCountdown,
                        multiSelect: withMultiple,
                        blindVote: withBlind,
                        showVoters,
                        image: this.pollImageData || null,
                        active: true,
                        resolved: false,
                        countdown: withCountdown ? this.selectedCountdown : null,
                        startedAt: firebase.firestore.FieldValue.serverTimestamp(),
                        timestamp: Date.now()
                    };
                    
                    await this.ref().update({ poll: pollData });
                    
                    // Clear form
                    document.getElementById('pollQuestion').value = '';
                    this.pollImageData = null;
                    document.getElementById('pollImagePreview').style.display = 'none';
                    document.getElementById('pollImagePlaceholder').style.display = 'flex';
                    
                    this.addToHistory('poll', `Umfrage: ${question}`);
                    this.toast('Umfrage gestartet!', 'success');
                } catch (e) {
                    console.error('[BC] Poll error:', e);
                    this.toast('Fehler', 'error');
                }
            },
            
            async resolvePoll() {
                if (!this.currentPoll) return;
                
                try {
                    const options = this.currentPoll.options || [];
                    const emojis = this.currentPoll.emojis || [];
                    const voteCounts = {};
                    options.forEach(opt => voteCounts[opt] = 0);
                    
                    // Support both single and multi-select votes
                    this.pollVotes.forEach(vote => {
                        const voteOptions = vote.options || (vote.option ? [vote.option] : []);
                        voteOptions.forEach(opt => {
                            if (voteCounts.hasOwnProperty(opt)) {
                                voteCounts[opt]++;
                            }
                        });
                    });
                    
                    const maxVotes = Math.max(...Object.values(voteCounts), 0);
                    
                    const results = options.map((opt, i) => ({
                        option: opt,
                        emoji: emojis[i] || '',
                        votes: voteCounts[opt],
                        isWinner: voteCounts[opt] === maxVotes && maxVotes > 0,
                        voters: this.currentPoll.showVoters ? 
                            this.pollVotes.filter(v => v.option === opt).map(v => {
                                const member = this.members.find(m => m.id === v.oderId);
                                return member?.name || 'Unbekannt';
                            }) : null
                    }));
                    
                    const resolvedPoll = {
                        ...this.currentPoll,
                        active: false,
                        resolved: true,
                        results,
                        totalVotes: Object.values(voteCounts).reduce((a, b) => a + b, 0),
                        resolvedAt: Date.now()
                    };
                    
                    await this.ref().update({ poll: resolvedPoll });
                    this.toast('Umfrage aufgel√∂st!', 'success');
                } catch (e) {
                    console.error('[BC] Resolve error:', e);
                    this.toast('Fehler', 'error');
                }
            },
            
            async closePoll() {
                try {
                    await this.ref().update({ 'poll.active': false });
                    this.toast('Umfrage geschlossen', 'success');
                } catch (e) {
                    this.toast('Fehler', 'error');
                }
            },
            
            // ============ REACTIONS ============
            selectedCustomEmoji: 'üéâ',
            emojiPickerInitialized: false,
            
            toggleEmojiPicker() {
                const picker = document.getElementById('emojiPicker');
                const isHidden = picker.style.display === 'none';
                
                // Initialize emoji grid on first open
                if (!this.emojiPickerInitialized && isHidden) {
                    const grid = document.getElementById('emojiPickerGrid');
                    const emojis = ['üòÄ','üòÉ','üòÑ','üòÅ','üòÖ','üòÇ','ü§£','üòä','üòá','üôÇ','üòâ','üòç','ü•∞','üòò','üòã','üòõ','üòú','ü§™','ü§ó','ü§≠','ü§´','ü§î','üòè','üôÑ','üò¨','üò≤','üò≥','ü•∫','üò¢','üò≠','üò±','üò§','üò°','ü§¨','üòà','üëø','üíÄ','‚ò†Ô∏è','üí©','ü§°','üëπ','üë∫','üëª','üëΩ','üëæ','ü§ñ','üí™','üëä','‚úä','üëè','üôå','ü§ù','üôè','üëç','üëé','üëÄ','üß†','‚ù§Ô∏è','üî•','‚≠ê','‚ú®','üí´','üåü','üí•','üí¢','üí¶','üéâ','üéä','üèÜ','üëë','üíé','üé≠','üé™','üéØ','üé≤','üó°Ô∏è','‚öîÔ∏è','üõ°Ô∏è','üèπ','üîÆ','üßø','üìú','üìö','üóùÔ∏è','‚ö°','üí®','üåä','‚ùÑÔ∏è','‚òÄÔ∏è','üåô','üêâ','üê≤','ü¶Ñ','üê∫','ü¶ä','üêª','ü¶Å','üêØ','üßô','üßù','üßõ','üßü','üëπ','üíÄ','‚ò†Ô∏è','‚ö∞Ô∏è','ü™¶','üïØÔ∏è'];
                    grid.innerHTML = emojis.map(e => 
                        `<span class="emoji-pick" onclick="BC.selectEmoji('${e}')">${e}</span>`
                    ).join('');
                    this.emojiPickerInitialized = true;
                }
                
                picker.style.display = isHidden ? 'block' : 'none';
            },
            
            selectEmoji(emoji) {
                this.selectedCustomEmoji = emoji;
                document.getElementById('selectedEmoji').textContent = emoji;
                document.getElementById('emojiPicker').style.display = 'none';
            },
            
            async sendReaction(type, emoji) {
                const withSound = document.getElementById('reactionSound')?.checked !== false;
                
                try {
                    await this.ref().update({
                        broadcast: {
                            message: '',
                            type: 'reaction',
                            emoji,
                            sound: withSound ? 'notification' : 'none',
                            id: Date.now(),
                            timestamp: firebase.firestore.FieldValue.serverTimestamp()
                        }
                    });
                    this.addToHistory('reaction', `Reaktion: ${emoji}`);
                    this.toast(`${emoji} gesendet!`, 'success');
                } catch (e) {
                    this.toast('Fehler', 'error');
                }
            },
            
            async sendCustomReaction() {
                const emoji = this.selectedCustomEmoji;
                const text = document.getElementById('customReactionText').value.trim();
                
                const withSound = document.getElementById('reactionSound')?.checked !== false;
                
                try {
                    await this.ref().update({
                        broadcast: {
                            message: text,
                            type: 'reaction',
                            emoji: emoji,
                            sound: withSound ? 'notification' : 'none',
                            id: Date.now(),
                            timestamp: firebase.firestore.FieldValue.serverTimestamp()
                        }
                    });
                    
                    document.getElementById('customReactionText').value = '';
                    this.addToHistory('reaction', `Reaktion: ${emoji} ${text}`);
                    this.toast('Reaktion gesendet!', 'success');
                } catch (e) {
                    this.toast('Fehler', 'error');
                }
            },
            
            // ============ SPOTLIGHT ============
            async sendSpotlight() {
                const selected = document.querySelector('#spotlightPlayers .bc-player.selected');
                if (!selected) {
                    this.toast('Spieler ausw√§hlen!', 'error');
                    return;
                }
                
                const playerId = selected.dataset.id;
                const playerName = selected.querySelector('.bc-player__name').textContent;
                const message = document.getElementById('spotlightMessage').value.trim();
                
                try {
                    await this.ref().update({
                        broadcast: {
                            type: 'spotlight',
                            targetId: playerId,
                            targetName: playerName,
                            message: message || 'Du bist dran!',
                            sound: 'fanfare',
                            id: Date.now(),
                            timestamp: firebase.firestore.FieldValue.serverTimestamp()
                        }
                    });
                    this.addToHistory('spotlight', `Spotlight: ${playerName}`);
                    this.toast('Spotlight aktiviert!', 'success');
                } catch (e) {
                    this.toast('Fehler', 'error');
                }
            },
            
            async sendSecretMessage() {
                const selected = document.querySelector('#secretPlayers .bc-player.selected');
                if (!selected) {
                    this.toast('Empf√§nger ausw√§hlen!', 'error');
                    return;
                }
                
                const message = document.getElementById('secretMessage').value.trim();
                if (!message) {
                    this.toast('Nachricht eingeben!', 'error');
                    return;
                }
                
                const playerId = selected.dataset.id;
                const playerName = selected.querySelector('.bc-player__name').textContent;
                const withSound = document.getElementById('secretSound')?.checked !== false;
                
                try {
                    await this.ref().update({
                        broadcast: {
                            type: 'secret',
                            message,
                            targets: [playerId],
                            sound: withSound ? 'mystery' : 'none',
                            id: Date.now(),
                            timestamp: firebase.firestore.FieldValue.serverTimestamp()
                        }
                    });
                    
                    document.getElementById('secretMessage').value = '';
                    this.addToHistory('secret', `Geheime Nachricht an ${playerName}`);
                    this.toast('Geheime Nachricht gesendet!', 'success');
                } catch (e) {
                    this.toast('Fehler', 'error');
                }
            },
            
            // ============ DICE REQUEST ============
            async sendDiceRequest() {
                const type = document.getElementById('diceRequestType').value;
                const desc = document.getElementById('diceRequestDesc').value.trim();
                
                // Get selected targets
                const selectedAll = document.querySelector('#diceRequestTargets .bc-player[data-target="all"].selected');
                let targets = null;
                
                if (!selectedAll) {
                    const selectedPlayers = document.querySelectorAll('#diceRequestTargets .bc-player.selected[data-id]');
                    if (selectedPlayers.length === 0) {
                        this.toast('Mindestens einen Empf√§nger w√§hlen!', 'error');
                        return;
                    }
                    targets = Array.from(selectedPlayers).map(p => p.dataset.id);
                }
                
                try {
                    await this.ref().update({
                        broadcast: {
                            type: 'diceRequest',
                            diceType: type,
                            description: desc || 'W√ºrfelprobe',
                            targets: targets,
                            sound: 'notification',
                            id: Date.now(),
                            timestamp: firebase.firestore.FieldValue.serverTimestamp()
                        }
                    });
                    
                    document.getElementById('diceRequestDesc').value = '';
                    this.addToHistory('diceRequest', `W√ºrfelanforderung: ${type.toUpperCase()}`);
                    this.toast('W√ºrfelanforderung gesendet!', 'success');
                } catch (e) {
                    this.toast('Fehler', 'error');
                }
            },
            
            // ============ HANDOUT ============
            async handleHandoutUpload(event) {
                const file = event.target.files[0];
                if (!file) return;
                
                // Show loading
                this.toast('Bild wird verarbeitet...', 'info');
                
                try {
                    // Compress image if needed
                    const compressedData = await this.compressImage(file, 1200, 0.8);
                    
                    await this.ref().update({
                        broadcast: {
                            type: 'handout',
                            image: compressedData,
                            sound: 'notification',
                            id: Date.now(),
                            timestamp: firebase.firestore.FieldValue.serverTimestamp()
                        }
                    });
                    this.addToHistory('handout', 'Handout gesendet');
                    this.toast('Handout gesendet!', 'success');
                } catch (e) {
                    console.error('[Handout]', e);
                    this.toast('Fehler beim Senden', 'error');
                }
            },
            
            // Image compression helper
            compressImage(file, maxSize = 1200, quality = 0.8) {
                return new Promise((resolve) => {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        const img = new Image();
                        img.onload = () => {
                            const canvas = document.createElement('canvas');
                            let { width, height } = img;
                            
                            // Scale down if larger than maxSize
                            if (width > maxSize || height > maxSize) {
                                if (width > height) {
                                    height = (height / width) * maxSize;
                                    width = maxSize;
                                } else {
                                    width = (width / height) * maxSize;
                                    height = maxSize;
                                }
                            }
                            
                            canvas.width = width;
                            canvas.height = height;
                            
                            const ctx = canvas.getContext('2d');
                            ctx.drawImage(img, 0, 0, width, height);
                            
                            resolve(canvas.toDataURL('image/jpeg', quality));
                        };
                        img.src = e.target.result;
                    };
                    reader.readAsDataURL(file);
                });
            },
            
            // ============ CINEMATIC ============
            openCinematic(type) {
                // Hide all cinematic cards
                document.querySelectorAll('[id^="cinematic"]').forEach(el => el.style.display = 'none');
                
                // Show selected
                const card = document.getElementById('cinematic' + type.charAt(0).toUpperCase() + type.slice(1));
                if (card) card.style.display = 'block';
            },
            
            closeCinematic() {
                document.querySelectorAll('[id^="cinematic"]').forEach(el => el.style.display = 'none');
            },
            
            setSceneStyle(style) {
                document.querySelectorAll('#cinematicScene .bc-countdown-btn').forEach(b => {
                    b.classList.toggle('active', b.dataset.style === style);
                });
            },
            
            async sendSceneTransition() {
                const text = document.getElementById('sceneText').value.trim();
                const style = document.querySelector('#cinematicScene .bc-countdown-btn.active')?.dataset.style || 'fade';
                const withSound = document.getElementById('sceneSound')?.checked !== false;
                
                if (!text) {
                    this.toast('Text eingeben!', 'error');
                    return;
                }
                
                try {
                    await this.ref().update({
                        broadcast: {
                            type: 'scene',
                            text,
                            style,
                            sound: withSound ? 'dramatic' : 'none',
                            id: Date.now(),
                            timestamp: firebase.firestore.FieldValue.serverTimestamp()
                        }
                    });
                    
                    document.getElementById('sceneText').value = '';
                    this.closeCinematic();
                    this.addToHistory('scene', `Szene: ${text}`);
                    this.toast('Szenen-√úbergang gesendet!', 'success');
                } catch (e) {
                    this.toast('Fehler', 'error');
                }
            },
            
            async sendReveal() {
                if (!this.revealImageData) {
                    this.toast('Bild hochladen!', 'error');
                    return;
                }
                
                const title = document.getElementById('revealTitle').value.trim();
                const withSound = document.getElementById('revealSound')?.checked !== false;
                
                try {
                    await this.ref().update({
                        broadcast: {
                            type: 'reveal',
                            image: this.revealImageData,
                            title,
                            sound: withSound ? 'dramatic' : 'none',
                            id: Date.now(),
                            timestamp: firebase.firestore.FieldValue.serverTimestamp()
                        }
                    });
                    
                    this.revealImageData = null;
                    document.getElementById('revealImagePreview').style.display = 'none';
                    document.getElementById('revealTitle').value = '';
                    this.closeCinematic();
                    this.addToHistory('reveal', `Reveal: ${title || 'Bild'}`);
                    this.toast('Reveal gesendet!', 'success');
                } catch (e) {
                    this.toast('Fehler', 'error');
                }
            },
            
            async sendCombatStart() {
                const title = document.getElementById('combatTitle').value.trim() || 'INITIATIVE!';
                const subtitle = document.getElementById('combatSubtitle').value.trim();
                const withSound = document.getElementById('combatSound')?.checked !== false;
                
                try {
                    await this.ref().update({
                        broadcast: {
                            type: 'combat',
                            title,
                            subtitle,
                            sound: withSound ? 'combat' : 'none',
                            id: Date.now(),
                            timestamp: firebase.firestore.FieldValue.serverTimestamp()
                        }
                    });
                    
                    this.closeCinematic();
                    this.addToHistory('combat', `Kampf: ${title}`);
                    this.toast('Kampf gestartet!', 'success');
                } catch (e) {
                    this.toast('Fehler', 'error');
                }
            },
            
            selectAmbient(ambient) {
                this.selectedAmbient = ambient;
                document.querySelectorAll('#cinematicAmbient .bc-cinematic').forEach(c => {
                    c.style.borderColor = c.dataset.ambient === ambient ? 'var(--accent)' : 'var(--border)';
                });
            },
            
            async sendAmbient() {
                if (!this.selectedAmbient) {
                    this.toast('Effekt ausw√§hlen!', 'error');
                    return;
                }
                
                const effectNames = {
                    rain: 'Regen', storm: 'Gewitter', snow: 'Schnee', fog: 'Nebel',
                    fire: 'Feuer', darkness: 'Dunkelheit', magic: 'Magie', blood: 'Blut',
                    underwater: 'Unterwasser', poison: 'Gift', holy: 'Heilig', clear: 'Aus'
                };
                
                try {
                    await this.ref().update({
                        broadcast: {
                            type: 'ambient',
                            effect: this.selectedAmbient,
                            sound: 'none', // Ambient ist subtil, kein Sound
                            id: Date.now(),
                            timestamp: firebase.firestore.FieldValue.serverTimestamp()
                        }
                    });
                    
                    this.closeCinematic();
                    this.addToHistory('ambient', `Atmosph√§re: ${effectNames[this.selectedAmbient] || this.selectedAmbient}`);
                    this.toast('Atmosph√§re ge√§ndert!', 'success');
                } catch (e) {
                    this.toast('Fehler', 'error');
                }
            },
            
            // ============ HISTORY ============
            historyItems: [],
            
            addToHistory(type, text) {
                const now = new Date();
                const time = now.toLocaleTimeString('de-DE', { hour: '2-digit', minute: '2-digit' });
                
                const icons = {
                    broadcast: 'üì¢', poll: 'üìä', reaction: 'üòÄ', spotlight: 'üåü',
                    secret: 'ü§´', diceRequest: 'üé≤', handout: 'üìú', scene: 'üé¨',
                    reveal: '‚ú®', combat: '‚öîÔ∏è', ambient: 'üåô'
                };
                
                this.historyItems.unshift({ type, text, time, icon: icons[type] || 'üìã' });
                
                // Keep only last 50 items
                if (this.historyItems.length > 50) {
                    this.historyItems = this.historyItems.slice(0, 50);
                }
                
                this.renderHistory();
            },
            
            renderHistory() {
                const list = document.getElementById('historyList');
                const empty = document.getElementById('historyEmpty');
                
                if (!list) return;
                
                if (this.historyItems.length === 0) {
                    if (empty) empty.style.display = 'block';
                    list.innerHTML = '';
                    return;
                }
                
                if (empty) empty.style.display = 'none';
                
                list.innerHTML = this.historyItems.map(item => `
                    <div class="bc-history-item" style="display: flex; align-items: center; gap: 12px; padding: 12px 16px; border-bottom: 1px solid rgba(255,255,255,0.05);">
                        <span style="font-size: 20px;">${item.icon}</span>
                        <div style="flex: 1;">
                            <div style="font-size: 14px; color: white;">${item.text}</div>
                            <div style="font-size: 12px; color: rgba(255,255,255,0.4);">${item.time}</div>
                        </div>
                    </div>
                `).join('');
            },
            
            clearHistory() {
                this.historyItems = [];
                this.renderHistory();
                this.toast('Verlauf gel√∂scht', 'success');
            },
            
            // ============ UTILS ============
            toast(message, type = 'info') {
                // Simple toast
                const toast = document.createElement('div');
                toast.style.cssText = `
                    position: fixed; bottom: 24px; right: 24px; z-index: 10000;
                    padding: 14px 24px; border-radius: 10px;
                    background: ${type === 'success' ? '#22c55e' : type === 'error' ? '#ef4444' : '#8b5cf6'};
                    color: white; font-weight: 500; font-size: 14px;
                    animation: slideIn 0.3s ease;
                `;
                toast.textContent = message;
                document.body.appendChild(toast);
                
                setTimeout(() => {
                    toast.style.animation = 'slideOut 0.3s ease';
                    setTimeout(() => toast.remove(), 300);
                }, 2500);
            }
        };
        
        // Keyframe animations
        const style = document.createElement('style');
        style.textContent = `
            @keyframes slideIn { from { transform: translateX(100px); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
            @keyframes slideOut { from { transform: translateX(0); opacity: 1; } to { transform: translateX(100px); opacity: 0; } }
        `;
        document.head.appendChild(style);
        
        // Init AFTER layout is fully rendered
        // Use requestAnimationFrame to wait for next render cycle after initLayout()
        requestAnimationFrame(() => {
            requestAnimationFrame(() => {
                BC.init();
            });
        });
    </script>
</body>
</html>
