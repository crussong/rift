<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="PnP Companion - Session Notizen">
    <meta name="theme-color" content="#6750a4">
    <title>Notizen - PnP Companion</title>
    <script>(function(){var t=localStorage.getItem('pnp_theme')||'dark';document.documentElement.setAttribute('data-theme',t)})();</script>
    <link rel="icon" type="image/png" href="assets/icons/icon_favicon.png">
    <link rel="manifest" href="manifest.json">
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="assets/css/rift.css">
    
    <style>
        /* ===== NOTIZEN MODULE STYLES ===== */
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            padding-top: 60px;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        .notes-container {
            max-width: 900px;
            margin: 0 auto;
            padding: var(--space-lg);
            flex: 1;
            width: 100%;
        }

        /* ===== TOOLBAR ===== */
        .toolbar {
            display: flex;
            gap: var(--space-md);
            margin-bottom: var(--space-lg);
            flex-wrap: wrap;
            align-items: center;
        }

        /* Add Note Button */
        .add-note-btn {
            display: flex;
            align-items: center;
            gap: var(--space-xs);
            height: 48px;
            padding: 0 var(--space-lg) 0 var(--space-md);
            background: var(--md-primary);
            color: var(--md-on-primary);
            border: none;
            border-radius: var(--shape-full);
            font-family: inherit;
            font-size: var(--label-large);
            font-weight: 500;
            cursor: pointer;
            transition: all var(--transition-standard);
            white-space: nowrap;
        }

        .add-note-btn:hover {
            background: var(--md-primary-hover, var(--md-primary));
            box-shadow: var(--elevation-2);
        }

        .add-note-btn:active {
            transform: scale(0.97);
        }

        .add-note-btn svg {
            width: 20px;
            height: 20px;
        }

        .search-box {
            flex: 1;
            min-width: 200px;
            position: relative;
        }

        .search-box input {
            width: 100%;
            height: 48px;
            padding: 0 var(--space-md) 0 48px;
            background: var(--md-surface-container);
            border: 2px solid transparent;
            border-radius: var(--shape-full);
            font-family: inherit;
            font-size: var(--body-medium);
            color: var(--md-on-surface);
            transition: all var(--transition-standard);
        }

        .search-box input:focus {
            outline: none;
            border-color: var(--md-primary);
            background: var(--md-surface-container-high);
        }

        .search-box input::placeholder {
            color: var(--md-on-surface-variant);
        }

        .search-box svg {
            position: absolute;
            left: 16px;
            top: 50%;
            transform: translateY(-50%);
            width: 20px;
            height: 20px;
            color: var(--md-on-surface-variant);
            pointer-events: none;
        }

        /* Toolbar Actions */
        .toolbar-actions {
            display: flex;
            gap: var(--space-sm);
        }

        .toolbar-btn {
            width: 44px;
            height: 44px;
            background: var(--md-surface-container);
            border: 1px solid var(--md-outline-variant);
            border-radius: var(--shape-md);
            color: var(--md-on-surface-variant);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all var(--transition-standard);
            position: relative;
        }

        .toolbar-btn:hover {
            background: var(--md-surface-container-high);
            color: var(--md-on-surface);
        }

        .toolbar-btn svg {
            width: 20px;
            height: 20px;
        }

        /* Sort Dropdown */
        .sort-dropdown {
            position: relative;
        }

        .sort-menu {
            position: absolute;
            top: calc(100% + 8px);
            right: 0;
            background: var(--md-surface-container-high);
            border-radius: var(--shape-md);
            box-shadow: var(--elevation-3);
            min-width: 180px;
            z-index: 100;
            opacity: 0;
            visibility: hidden;
            transform: translateY(-8px);
            transition: all var(--transition-standard);
        }

        .sort-dropdown.open .sort-menu {
            opacity: 1;
            visibility: visible;
            transform: translateY(0);
        }

        .sort-option {
            display: flex;
            align-items: center;
            gap: var(--space-sm);
            padding: var(--space-sm) var(--space-md);
            font-size: var(--body-medium);
            color: var(--md-on-surface);
            cursor: pointer;
            transition: background var(--transition-standard);
        }

        .sort-option:first-child {
            border-radius: var(--shape-md) var(--shape-md) 0 0;
        }

        .sort-option:last-child {
            border-radius: 0 0 var(--shape-md) var(--shape-md);
        }

        .sort-option:hover {
            background: var(--md-surface-container-highest);
        }

        .sort-option.active {
            color: var(--md-primary);
        }

        .sort-option svg {
            width: 18px;
            height: 18px;
            opacity: 0;
        }

        .sort-option.active svg {
            opacity: 1;
        }

        /* Filter Chips */
        .filter-row {
            width: 100%;
            display: flex;
            gap: var(--space-sm);
            overflow-x: auto;
            padding-bottom: var(--space-xs);
        }

        .chip {
            height: 36px;
            padding: 0 16px;
            background: var(--md-surface-container);
            border: 1px solid var(--md-outline-variant);
            border-radius: var(--shape-full);
            font-size: var(--body-small);
            font-weight: 500;
            color: var(--md-on-surface-variant);
            cursor: pointer;
            transition: all var(--transition-standard);
            display: flex;
            align-items: center;
            gap: var(--space-xs);
            flex-shrink: 0;
        }

        .chip:hover {
            background: var(--md-surface-container-high);
        }

        .chip.active {
            background: var(--md-primary);
            border-color: var(--md-primary);
            color: var(--md-on-primary);
        }

        .chip .dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
        }

        /* ===== NOTES LIST ===== */
        .notes-list {
            display: flex;
            flex-direction: column;
            gap: var(--space-md);
        }

        .session-group {
            animation: slideUp 0.3s ease-out backwards;
        }

        .session-header {
            display: flex;
            align-items: center;
            gap: var(--space-sm);
            padding: var(--space-sm) 0;
            margin-bottom: var(--space-sm);
        }

        .session-date {
            font-size: var(--body-small);
            font-weight: 600;
            color: var(--md-primary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .session-line {
            flex: 1;
            height: 1px;
            background: var(--md-outline-variant);
        }

        .session-count {
            font-size: var(--label-small);
            color: var(--md-on-surface-variant);
            background: var(--md-surface-container);
            padding: 2px 8px;
            border-radius: var(--shape-full);
        }

        /* Note Card */
        .note-card {
            background: var(--md-surface-container);
            border-radius: var(--shape-lg);
            padding: var(--space-md);
            cursor: pointer;
            transition: all var(--transition-standard);
            border: 1px solid transparent;
            position: relative;
        }

        .note-card:hover {
            background: var(--md-surface-container-high);
            border-color: var(--md-outline-variant);
        }

        .note-card.pinned {
            border-left: 3px solid var(--md-primary);
        }

        .note-pin-icon {
            position: absolute;
            top: 8px;
            right: 8px;
            font-size: 14px;
            opacity: 0.8;
        }

        .note-header {
            display: flex;
            align-items: flex-start;
            gap: var(--space-sm);
            margin-bottom: var(--space-sm);
            padding-right: 24px;
        }

        .note-category {
            padding: 4px 10px;
            border-radius: var(--shape-sm);
            font-size: var(--label-small);
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.3px;
            flex-shrink: 0;
        }

        /* Category Colors */
        .note-category.quest { background: rgba(124, 58, 237, 0.2); color: #a78bfa; }
        .note-category.npc { background: rgba(5, 150, 105, 0.2); color: #34d399; }
        .note-category.ort { background: rgba(37, 99, 235, 0.2); color: #60a5fa; }
        .note-category.lore { background: rgba(217, 119, 6, 0.2); color: #fbbf24; }
        .note-category.item { background: rgba(220, 38, 38, 0.2); color: #f87171; }
        .note-category.idee { background: rgba(236, 72, 153, 0.2); color: #f472b6; }
        .note-category.monster { background: rgba(249, 115, 22, 0.2); color: #fb923c; }
        .note-category.geheimnis { background: rgba(168, 85, 247, 0.2); color: #c084fc; }
        .note-category.session { background: rgba(6, 182, 212, 0.2); color: #22d3ee; }

        .note-title {
            font-size: var(--body-large);
            font-weight: 500;
            color: var(--md-on-surface);
            flex: 1;
            line-height: 1.3;
        }

        /* Markdown rendered content */
        .note-content {
            font-size: var(--body-medium);
            color: var(--md-on-surface-variant);
            line-height: 1.6;
            display: -webkit-box;
            -webkit-line-clamp: 3;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }

        .note-content strong {
            font-weight: 600;
            color: var(--md-on-surface);
        }

        .note-content em {
            font-style: italic;
        }

        .note-content code {
            background: var(--md-surface-container-highest);
            padding: 2px 6px;
            border-radius: 4px;
            font-family: monospace;
            font-size: 0.9em;
        }

        .note-meta {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: var(--space-sm);
            font-size: var(--label-small);
            color: var(--md-on-surface-variant);
            opacity: 0.7;
        }

        /* ===== EMPTY STATE ===== */
        .empty-state {
            text-align: center;
            padding: var(--space-3xl) var(--space-lg);
            color: var(--md-on-surface-variant);
        }

        .empty-state svg {
            width: 80px;
            height: 80px;
            margin-bottom: var(--space-md);
            opacity: 0.5;
        }

        .empty-state h3 {
            font-size: var(--title-medium);
            font-weight: 500;
            margin-bottom: var(--space-sm);
            color: var(--md-on-surface);
        }

        .empty-state p {
            font-size: var(--body-medium);
            max-width: 300px;
            margin: 0 auto;
        }

        /* ===== MODAL ===== */
        .modal-backdrop {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.6);
            z-index: 200;
            opacity: 0;
            visibility: hidden;
            transition: all var(--transition-standard);
        }

        .modal-backdrop.active {
            opacity: 1;
            visibility: visible;
        }

        .modal {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) scale(0.9);
            background: var(--md-surface-container-high);
            border-radius: var(--shape-xl);
            box-shadow: var(--elevation-5);
            z-index: 201;
            width: calc(100% - 32px);
            max-width: 560px;
            max-height: calc(100vh - 48px);
            overflow: hidden;
            opacity: 0;
            visibility: hidden;
            transition: all var(--transition-emphasized);
            display: flex;
            flex-direction: column;
        }

        .modal.active {
            opacity: 1;
            visibility: visible;
            transform: translate(-50%, -50%) scale(1);
        }

        .modal-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: var(--space-md) var(--space-lg);
            border-bottom: 1px solid var(--md-outline-variant);
        }

        .modal-title {
            font-size: var(--title-large);
            font-weight: 500;
            color: var(--md-on-surface);
        }

        .modal-header-actions {
            display: flex;
            align-items: center;
            gap: var(--space-xs);
        }

        .modal-icon-btn {
            width: 40px;
            height: 40px;
            background: transparent;
            border: none;
            border-radius: var(--shape-full);
            color: var(--md-on-surface-variant);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all var(--transition-standard);
        }

        .modal-icon-btn:hover {
            background: var(--md-surface-container-highest);
        }

        .modal-icon-btn.pinned {
            color: var(--md-primary);
        }

        .modal-body {
            padding: var(--space-lg);
            overflow-y: auto;
            flex: 1;
        }

        .form-group {
            margin-bottom: var(--space-md);
        }

        .form-label {
            display: block;
            font-size: var(--label-large);
            font-weight: 500;
            color: var(--md-on-surface-variant);
            margin-bottom: var(--space-sm);
        }

        .form-hint {
            font-size: var(--label-small);
            color: var(--md-on-surface-variant);
            opacity: 0.7;
            margin-top: var(--space-xs);
        }

        .form-input {
            width: 100%;
            height: 48px;
            padding: 0 var(--space-md);
            background: var(--md-surface-container);
            border: 2px solid transparent;
            border-radius: var(--shape-md);
            font-family: inherit;
            font-size: var(--body-medium);
            color: var(--md-on-surface);
            transition: all var(--transition-standard);
        }

        .form-input:focus {
            outline: none;
            border-color: var(--md-primary);
        }

        .form-textarea {
            width: 100%;
            min-height: 150px;
            padding: var(--space-md);
            background: var(--md-surface-container);
            border: 2px solid transparent;
            border-radius: var(--shape-md);
            font-family: inherit;
            font-size: var(--body-medium);
            color: var(--md-on-surface);
            resize: vertical;
            transition: all var(--transition-standard);
            line-height: 1.6;
        }

        .form-textarea:focus {
            outline: none;
            border-color: var(--md-primary);
        }

        .category-select {
            display: flex;
            flex-wrap: wrap;
            gap: var(--space-sm);
        }

        .category-option {
            padding: 8px 16px;
            background: var(--md-surface-container);
            border: 2px solid transparent;
            border-radius: var(--shape-full);
            font-size: var(--body-small);
            font-weight: 500;
            color: var(--md-on-surface);
            cursor: pointer;
            transition: all var(--transition-standard);
        }

        .category-option:hover {
            background: var(--md-surface-container-highest);
        }

        .category-option.selected {
            border-color: var(--md-primary);
            background: var(--md-primary);
            color: var(--md-on-primary);
        }

        .modal-footer {
            display: flex;
            justify-content: space-between;
            gap: var(--space-sm);
            padding: var(--space-md) var(--space-lg);
            border-top: 1px solid var(--md-outline-variant);
        }

        .modal-footer .left-actions {
            display: flex;
            gap: var(--space-sm);
        }

        .btn-delete {
            background: var(--md-error);
            color: var(--md-on-error);
        }

        .btn-delete:hover {
            background: #d32f2f;
        }

        /* ===== MARKDOWN TOOLBAR ===== */
        .markdown-toolbar {
            display: flex;
            align-items: center;
            gap: 4px;
            padding: 8px;
            background: var(--md-surface-container);
            border-radius: var(--shape-md) var(--shape-md) 0 0;
            border: 2px solid transparent;
            border-bottom: none;
        }

        .md-btn {
            width: 32px;
            height: 32px;
            background: transparent;
            border: none;
            border-radius: var(--shape-sm);
            color: var(--md-on-surface-variant);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-family: inherit;
            font-size: 14px;
            transition: all var(--transition-standard);
        }

        .md-btn:hover {
            background: var(--md-surface-container-highest);
            color: var(--md-on-surface);
        }

        .md-btn:active {
            transform: scale(0.95);
        }

        .md-btn strong {
            font-weight: 700;
        }

        .md-btn em {
            font-style: italic;
        }

        .md-btn code {
            font-family: monospace;
            font-size: 11px;
        }

        .md-separator {
            width: 1px;
            height: 20px;
            background: var(--md-outline-variant);
            margin: 0 4px;
        }

        .form-group:has(.markdown-toolbar) .form-textarea {
            border-radius: 0 0 var(--shape-md) var(--shape-md);
        }

        .form-group:has(.markdown-toolbar) .form-textarea:focus {
            border-color: var(--md-primary);
        }

        .form-group:has(.markdown-toolbar) .markdown-toolbar:has(+ .form-textarea:focus) {
            border-color: var(--md-primary);
        }

        /* ===== TOAST ===== */
        .toast {
            position: fixed;
            bottom: 80px;
            left: 50%;
            transform: translateX(-50%) translateY(20px);
            background: var(--md-surface-container-highest);
            color: var(--md-on-surface);
            padding: var(--space-sm) var(--space-lg);
            border-radius: var(--shape-md);
            box-shadow: var(--elevation-3);
            font-size: var(--body-medium);
            z-index: 300;
            opacity: 0;
            visibility: hidden;
            transition: all var(--transition-standard);
        }

        .toast.show {
            opacity: 1;
            visibility: visible;
            transform: translateX(-50%) translateY(0);
        }

        /* ===== RESPONSIVE ===== */
        @media (max-width: 768px) {
            .notes-container {
                padding: var(--space-md);
            }

            .toolbar {
                flex-direction: row;
                flex-wrap: wrap;
            }

            .add-note-btn {
                order: 1;
                width: 48px;
                height: 48px;
                padding: 0;
                justify-content: center;
                border-radius: 50%;
                flex-shrink: 0;
            }

            .add-note-btn span {
                display: none;
            }

            .search-box {
                order: 0;
                flex: 1;
                min-width: 0;
            }

            .toolbar-actions {
                order: 2;
                flex: 1 1 100%;
                justify-content: flex-end;
                margin-top: var(--space-sm);
            }
        }

        @media (max-width: 480px) {
            .note-header {
                flex-direction: column;
                gap: var(--space-xs);
            }

            .modal {
                width: calc(100% - 16px);
                max-height: calc(100vh - 24px);
            }
        }
    </style>
</head>
<body>
    <!-- Navigation -->
    <div id="nav-placeholder"></div>

    <main class="notes-container">
        <!-- Toolbar -->
        <div class="toolbar">
            <!-- Add Note Button -->
            <button class="add-note-btn" onclick="openModal()" data-i18n-title="notes.new_note_shortcut" title="Neue Notiz (Strg+N)">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
                    <line x1="12" y1="5" x2="12" y2="19"></line>
                    <line x1="5" y1="12" x2="19" y2="12"></line>
                </svg>
                <span data-i18n="notes.new_note">Neue Notiz</span>
            </button>
            
            <div class="search-box">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <circle cx="11" cy="11" r="8"></circle>
                    <path d="M21 21l-4.35-4.35"></path>
                </svg>
                <input type="text" id="searchInput" data-i18n-placeholder="notes.search" placeholder="Notizen durchsuchen...">
            </div>
            
            <div class="toolbar-actions">
                <!-- Sort Button -->
                <div class="sort-dropdown" id="sortDropdown">
                    <button class="toolbar-btn" onclick="toggleSortMenu()" data-i18n-title="notes.sort" title="Sortierung">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M3 6h18M6 12h12M9 18h6"/>
                        </svg>
                    </button>
                    <div class="sort-menu">
                        <div class="sort-option active" data-sort="date" onclick="setSort('date')">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <polyline points="20 6 9 17 4 12"></polyline>
                            </svg>
                            <span data-i18n="notes.sort_newest">Neueste zuerst</span>
                        </div>
                        <div class="sort-option" data-sort="alpha" onclick="setSort('alpha')">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <polyline points="20 6 9 17 4 12"></polyline>
                            </svg>
                            <span data-i18n="notes.sort_alpha">Alphabetisch</span>
                        </div>
                        <div class="sort-option" data-sort="category" onclick="setSort('category')">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <polyline points="20 6 9 17 4 12"></polyline>
                            </svg>
                            <span data-i18n="notes.sort_category">Nach Kategorie</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Filter Chips -->
        <div class="filter-row" id="filterChips">
            <button class="chip active" data-filter="all" data-i18n="notes.filter_all">Alle</button>
            <button class="chip" data-filter="quest"><span class="dot" style="background: #a78bfa"></span>Quest</button>
            <button class="chip" data-filter="npc"><span class="dot" style="background: #34d399"></span>NPC</button>
            <button class="chip" data-filter="ort"><span class="dot" style="background: #60a5fa"></span><span data-i18n="notes.filter_place">Ort</span></button>
            <button class="chip" data-filter="lore"><span class="dot" style="background: #fbbf24"></span>Lore</button>
            <button class="chip" data-filter="item"><span class="dot" style="background: #f87171"></span>Item</button>
            <button class="chip" data-filter="idee"><span class="dot" style="background: #f472b6"></span><span data-i18n="notes.filter_idea">Idee</span></button>
            <button class="chip" data-filter="monster"><span class="dot" style="background: #fb923c"></span>Monster</button>
            <button class="chip" data-filter="geheimnis"><span class="dot" style="background: #c084fc"></span><span data-i18n="notes.filter_secret">Geheimnis</span></button>
            <button class="chip" data-filter="session"><span class="dot" style="background: #22d3ee"></span>Session</button>
        </div>

        <!-- Notes List -->
        <div class="notes-list" id="notesList"></div>

        <!-- Empty State -->
        <div class="empty-state" id="emptyState" style="display: none;">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                <path d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
            </svg>
            <h3 data-i18n="notes.no_notes">Keine Notizen</h3>
            <p data-i18n="notes.create_first">Erstelle deine erste Notiz mit dem + Button unten rechts.</p>
        </div>
    </main>

    <!-- Hidden Import Input -->
    <input type="file" id="notesImport" accept=".json,.md" style="display: none;" onchange="importNotes(event)">

    <!-- Toast -->
    <div class="toast" id="toast"></div>

    <!-- Modal -->
    <div class="modal-backdrop" id="modalBackdrop" onclick="closeModal()"></div>
    <div class="modal" id="noteModal">
        <div class="modal-header">
            <h2 class="modal-title" id="modalTitle">Neue Notiz</h2>
            <div class="modal-header-actions">
                <button class="modal-icon-btn" id="btnPin" onclick="togglePin()" title="Anpinnen" style="display: none;">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M12 2L12 12"/>
                        <path d="M18.5 8.5L18 14L12 17L6 14L5.5 8.5"/>
                        <path d="M12 17V22"/>
                        <circle cx="12" cy="5" r="3"/>
                    </svg>
                </button>
                <button class="modal-icon-btn" onclick="closeModal()" title="Schlie√üen">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="18" y1="6" x2="6" y2="18"></line>
                        <line x1="6" y1="6" x2="18" y2="18"></line>
                    </svg>
                </button>
            </div>
        </div>
        <div class="modal-body">
            <input type="hidden" id="noteId">
            
            <div class="form-group">
                <label class="form-label">Kategorie</label>
                <div class="category-select" id="categorySelect">
                    <button type="button" class="category-option" data-category="quest">üó°Ô∏è Quest</button>
                    <button type="button" class="category-option" data-category="npc">üë§ NPC</button>
                    <button type="button" class="category-option" data-category="ort">üìç Ort</button>
                    <button type="button" class="category-option" data-category="lore">üìú Lore</button>
                    <button type="button" class="category-option" data-category="item">‚öîÔ∏è Item</button>
                    <button type="button" class="category-option" data-category="idee">üí° Idee</button>
                    <button type="button" class="category-option" data-category="monster">üëπ Monster</button>
                    <button type="button" class="category-option" data-category="geheimnis">üîÆ Geheimnis</button>
                    <button type="button" class="category-option" data-category="session">üìÖ Session</button>
                </div>
            </div>

            <div class="form-group">
                <label class="form-label" for="noteTitle" data-i18n="notes.label_title">Titel</label>
                <input type="text" id="noteTitle" class="form-input" data-i18n-placeholder="notes.title_placeholder" placeholder="Titel der Notiz..." maxlength="100">
            </div>

            <div class="form-group">
                <label class="form-label" for="noteContent" data-i18n="notes.label_content">Inhalt</label>
                <div class="markdown-toolbar">
                    <button type="button" class="md-btn" onclick="insertMarkdown('bold')" data-i18n-title="notes.bold" title="Fett (Strg+B)">
                        <strong>B</strong>
                    </button>
                    <button type="button" class="md-btn" onclick="insertMarkdown('italic')" data-i18n-title="notes.italic" title="Kursiv (Strg+I)">
                        <em>I</em>
                    </button>
                    <button type="button" class="md-btn" onclick="insertMarkdown('code')" data-i18n-title="notes.code" title="Code">
                        <code>&lt;/&gt;</code>
                    </button>
                    <span class="md-separator"></span>
                    <button type="button" class="md-btn" onclick="insertMarkdown('list')" data-i18n-title="notes.list" title="Liste">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <line x1="8" y1="6" x2="21" y2="6"></line>
                            <line x1="8" y1="12" x2="21" y2="12"></line>
                            <line x1="8" y1="18" x2="21" y2="18"></line>
                            <line x1="3" y1="6" x2="3.01" y2="6"></line>
                            <line x1="3" y1="12" x2="3.01" y2="12"></line>
                            <line x1="3" y1="18" x2="3.01" y2="18"></line>
                        </svg>
                    </button>
                    <button type="button" class="md-btn" onclick="insertMarkdown('heading')" data-i18n-title="notes.heading" title="√úberschrift">
                        <strong>H</strong>
                    </button>
                </div>
                <textarea id="noteContent" class="form-textarea" data-i18n-placeholder="notes.content_placeholder" placeholder="Beschreibung, Details, Hinweise..." maxlength="5000"></textarea>
                <div class="form-hint" data-i18n="notes.hint">Tipp: Text markieren, dann Button klicken</div>
            </div>
        </div>
        <div class="modal-footer">
            <div class="left-actions">
                <button class="btn btn-text btn-delete" id="btnDelete" onclick="deleteNote()" style="display: none;" data-i18n="delete">
                    L√∂schen
                </button>
            </div>
            <div class="right-actions" style="display: flex; gap: 8px;">
                <button class="btn btn-text" onclick="closeModal()" data-i18n="cancel">Abbrechen</button>
                <button class="btn btn-filled" onclick="saveNote()" data-i18n="save">Speichern</button>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

    <script src="assets/js/lang.js"></script>
    <script src="assets/js/i18n.js"></script>
    <script src="assets/js/auth.js"></script>
    <script src="assets/js/firebase-sync.js"></script>
    <script src="assets/js/nav.js"></script>
    <script>
        // ===== CONSTANTS =====
        const CATEGORIES = ['quest', 'npc', 'ort', 'lore', 'item', 'idee', 'monster', 'geheimnis', 'session'];
        const CATEGORY_LABELS = {
            quest: 'üó°Ô∏è Quest',
            npc: 'üë§ NPC',
            ort: 'üìç Ort',
            lore: 'üìú Lore',
            item: '‚öîÔ∏è Item',
            idee: 'üí° Idee',
            monster: 'üëπ Monster',
            geheimnis: 'üîÆ Geheimnis',
            session: 'üìÖ Session'
        };

        // ===== STATE =====
        let notes = [];
        let currentFilter = 'all';
        let currentSort = 'date';
        let searchQuery = '';
        let selectedCategory = 'quest';
        let editingNoteId = null;
        let editingNotePinned = false;

        // ===== INITIALIZATION =====
        document.addEventListener('DOMContentLoaded', async () => {
            if (!requireAuth()) return;

            const moduleTools = `
                <button class="icon-btn" onclick="exportNotesJSON()" title="${t('notes.export')}">
                    <img src="assets/icons/icon_filedownload.png" alt="Export" style="width: 24px; height: 24px;">
                </button>
                <button class="icon-btn" onclick="document.getElementById('notesImport').click()" title="${t('notes.import')}">
                    <img src="assets/icons/icon_fileupload.png" alt="Import" style="width: 24px; height: 24px;">
                </button>
            `;
            initNavigation(t('module.notes'), moduleTools);
            loadNotes();
            setupEventListeners();
            renderNotes();
            
            // Initialize Firebase for dice popups
            await initFirebase();
            initDicePopupListener();
        });

        // ===== STORAGE =====
        function loadNotes() {
            // Notes are individual (per user)
            notes = loadIndividualData('notes', []);
        }

        function saveNotes() {
            if (!saveIndividualData('notes', notes)) {
                showToast('Fehler beim Speichern!');
            }
        }

        // ===== EVENT LISTENERS =====
        function setupEventListeners() {
            // Search
            document.getElementById('searchInput').addEventListener('input', debounce((e) => {
                searchQuery = e.target.value.toLowerCase();
                renderNotes();
            }, 200));

            // Filter chips
            document.getElementById('filterChips').addEventListener('click', (e) => {
                const chip = e.target.closest('.chip');
                if (!chip) return;

                document.querySelectorAll('.chip').forEach(c => c.classList.remove('active'));
                chip.classList.add('active');
                currentFilter = chip.dataset.filter;
                renderNotes();
            });

            // Category select
            document.getElementById('categorySelect').addEventListener('click', (e) => {
                const option = e.target.closest('.category-option');
                if (!option) return;

                document.querySelectorAll('.category-option').forEach(o => o.classList.remove('selected'));
                option.classList.add('selected');
                selectedCategory = option.dataset.category;
            });

            // Close sort menu on outside click
            document.addEventListener('click', (e) => {
                const dropdown = document.getElementById('sortDropdown');
                if (!dropdown.contains(e.target)) {
                    dropdown.classList.remove('open');
                }
            });

            // Keyboard shortcuts
            document.addEventListener('keydown', (e) => {
                if (e.key === 'Escape') closeModal();
                if (e.ctrlKey && e.key === 'n') {
                    e.preventDefault();
                    openModal();
                }
            });
        }

        // ===== SORTING =====
        function toggleSortMenu() {
            const dropdown = document.getElementById('sortDropdown');
            dropdown.classList.toggle('open');
        }

        function setSort(sortType) {
            currentSort = sortType;
            
            // Update UI
            document.querySelectorAll('.sort-option').forEach(opt => {
                opt.classList.toggle('active', opt.dataset.sort === sortType);
            });
            
            document.getElementById('sortDropdown').classList.remove('open');
            renderNotes();
        }

        // ===== RENDER =====
        function renderNotes() {
            const container = document.getElementById('notesList');
            const emptyState = document.getElementById('emptyState');

            // Filter
            let filtered = notes.filter(note => {
                if (currentFilter !== 'all' && note.category !== currentFilter) return false;
                if (searchQuery) {
                    const searchIn = (note.title + ' ' + note.content).toLowerCase();
                    if (!searchIn.includes(searchQuery)) return false;
                }
                return true;
            });

            // Sort
            filtered.sort((a, b) => {
                // Pinned always first
                if (a.pinned && !b.pinned) return -1;
                if (!a.pinned && b.pinned) return 1;

                // Then by selected sort
                switch (currentSort) {
                    case 'alpha':
                        return a.title.localeCompare(b.title, 'de');
                    case 'category':
                        return a.category.localeCompare(b.category);
                    case 'date':
                    default:
                        return b.updated - a.updated;
                }
            });

            // Empty state
            if (filtered.length === 0) {
                container.innerHTML = '';
                emptyState.style.display = 'block';
                return;
            }
            emptyState.style.display = 'none';

            // Group by session (only for date sort)
            if (currentSort === 'date') {
                const grouped = groupBySession(filtered);
                let html = '';
                for (const [session, sessionNotes] of Object.entries(grouped)) {
                    html += `
                        <div class="session-group">
                            <div class="session-header">
                                <span class="session-date">${formatSessionDate(session)}</span>
                                <div class="session-line"></div>
                                <span class="session-count">${sessionNotes.length}</span>
                            </div>
                            ${sessionNotes.map(note => renderNoteCard(note)).join('')}
                        </div>
                    `;
                }
                container.innerHTML = html;
            } else {
                // No grouping for other sorts
                container.innerHTML = filtered.map(note => renderNoteCard(note)).join('');
            }

            // Click handlers
            container.querySelectorAll('.note-card').forEach(card => {
                card.addEventListener('click', () => openModal(card.dataset.id));
                
                // Long press for mobile delete
                let longPressTimer;
                let longPressTriggered = false;
                
                card.addEventListener('touchstart', (e) => {
                    longPressTriggered = false;
                    longPressTimer = setTimeout(() => {
                        longPressTriggered = true;
                        // Haptic feedback if available
                        if (navigator.vibrate) navigator.vibrate(50);
                        
                        // Show delete confirmation
                        const noteId = card.dataset.id;
                        const note = notes.find(n => n.id === noteId);
                        if (note && confirm(`"${note.title}" l√∂schen?`)) {
                            notes = notes.filter(n => n.id !== noteId);
                            saveNotes();
                            renderNotes();
                            showToast('Notiz gel√∂scht');
                        }
                    }, 500);
                }, { passive: true });
                
                card.addEventListener('touchend', () => {
                    clearTimeout(longPressTimer);
                });
                
                card.addEventListener('touchmove', () => {
                    clearTimeout(longPressTimer);
                });
                
                card.addEventListener('click', (e) => {
                    if (longPressTriggered) {
                        e.preventDefault();
                        e.stopPropagation();
                    }
                });
            });
        }

        function renderNoteCard(note) {
            const renderedContent = note.content ? renderMarkdown(note.content) : '';
            return `
                <div class="note-card ${note.pinned ? 'pinned' : ''}" data-id="${note.id}">
                    ${note.pinned ? '<span class="note-pin-icon">üìå</span>' : ''}
                    <div class="note-header">
                        <span class="note-category ${note.category}">${note.category}</span>
                        <span class="note-title">${escapeHtml(note.title)}</span>
                    </div>
                    ${renderedContent ? `<div class="note-content">${renderedContent}</div>` : ''}
                    <div class="note-meta">
                        <span>${formatTime(note.updated)}</span>
                    </div>
                </div>
            `;
        }

        function groupBySession(notes) {
            const groups = {};
            notes.forEach(note => {
                const session = note.session || formatDate(note.created);
                if (!groups[session]) groups[session] = [];
                groups[session].push(note);
            });
            return groups;
        }

        // ===== MARKDOWN =====
        function renderMarkdown(text) {
            if (!text) return '';
            
            let html = escapeHtml(text);
            
            // Headings: ## text (muss vor Line breaks passieren)
            html = html.replace(/^### (.+)$/gm, '<strong style="font-size:1.1em;color:var(--md-on-surface)">$1</strong>');
            html = html.replace(/^## (.+)$/gm, '<strong style="font-size:1.2em;color:var(--md-on-surface)">$1</strong>');
            html = html.replace(/^# (.+)$/gm, '<strong style="font-size:1.3em;color:var(--md-on-surface)">$1</strong>');
            
            // Lists: - item
            html = html.replace(/^- (.+)$/gm, '‚Ä¢ $1');
            
            // Bold: **text** or __text__
            html = html.replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>');
            html = html.replace(/__(.+?)__/g, '<strong>$1</strong>');
            
            // Italic: *text* or _text_
            html = html.replace(/\*([^*]+)\*/g, '<em>$1</em>');
            html = html.replace(/_([^_]+)_/g, '<em>$1</em>');
            
            // Code: `text`
            html = html.replace(/`([^`]+)`/g, '<code>$1</code>');
            
            // Line breaks
            html = html.replace(/\n/g, '<br>');
            
            return html;
        }

        // ===== MODAL =====
        function openModal(noteId = null) {
            const modal = document.getElementById('noteModal');
            const backdrop = document.getElementById('modalBackdrop');
            const title = document.getElementById('modalTitle');
            const deleteBtn = document.getElementById('btnDelete');
            const pinBtn = document.getElementById('btnPin');

            editingNoteId = noteId;

            if (noteId) {
                const note = notes.find(n => n.id === noteId);
                if (!note) return;

                title.textContent = 'Notiz bearbeiten';
                document.getElementById('noteId').value = note.id;
                document.getElementById('noteTitle').value = note.title;
                document.getElementById('noteContent').value = note.content || '';
                selectedCategory = note.category;
                editingNotePinned = note.pinned || false;
                
                deleteBtn.style.display = 'block';
                pinBtn.style.display = 'flex';
                pinBtn.classList.toggle('pinned', editingNotePinned);
            } else {
                title.textContent = 'Neue Notiz';
                document.getElementById('noteId').value = '';
                document.getElementById('noteTitle').value = '';
                document.getElementById('noteContent').value = '';
                selectedCategory = 'quest';
                editingNotePinned = false;
                
                deleteBtn.style.display = 'none';
                pinBtn.style.display = 'none';
            }

            // Update category selection
            document.querySelectorAll('.category-option').forEach(opt => {
                opt.classList.toggle('selected', opt.dataset.category === selectedCategory);
            });

            modal.classList.add('active');
            backdrop.classList.add('active');

            setTimeout(() => document.getElementById('noteTitle').focus(), 100);
        }

        function closeModal() {
            document.getElementById('noteModal').classList.remove('active');
            document.getElementById('modalBackdrop').classList.remove('active');
            editingNoteId = null;
        }

        function togglePin() {
            editingNotePinned = !editingNotePinned;
            document.getElementById('btnPin').classList.toggle('pinned', editingNotePinned);
        }

        // ===== CRUD =====
        function saveNote() {
            const titleInput = document.getElementById('noteTitle');
            const contentInput = document.getElementById('noteContent');

            let title = titleInput.value.trim();
            const content = contentInput.value.trim();

            // Wenn kein Titel, erste Zeile des Contents als Titel nehmen
            if (!title && content) {
                const firstLine = content.split('\n')[0].trim();
                title = firstLine.substring(0, 50) + (firstLine.length > 50 ? '...' : '');
            }
            
            // Wenn immer noch kein Titel und kein Content
            if (!title && !content) {
                contentInput.focus();
                contentInput.style.borderColor = 'var(--md-error)';
                setTimeout(() => contentInput.style.borderColor = 'transparent', 2000);
                showToast('Bitte gib etwas ein');
                return;
            }
            
            // Fallback Titel
            if (!title) {
                title = 'Unbenannte Notiz';
            }

            const now = Date.now();
            const today = formatDate(now);

            if (editingNoteId) {
                const index = notes.findIndex(n => n.id === editingNoteId);
                if (index !== -1) {
                    notes[index] = {
                        ...notes[index],
                        title,
                        content,
                        category: selectedCategory,
                        pinned: editingNotePinned,
                        updated: now
                    };
                }
                showToast('Notiz gespeichert');
            } else {
                notes.unshift({
                    id: generateId(),
                    title,
                    content,
                    category: selectedCategory,
                    session: today,
                    created: now,
                    updated: now,
                    pinned: false
                });
                showToast('Notiz erstellt');
            }

            saveNotes();
            renderNotes();
            closeModal();
        }

        function deleteNote() {
            if (!editingNoteId) return;
            if (!confirm('Notiz wirklich l√∂schen?')) return;

            notes = notes.filter(n => n.id !== editingNoteId);
            saveNotes();
            renderNotes();
            closeModal();
            showToast('Notiz gel√∂scht');
        }

        // ===== EXPORT =====
        function exportNotes() {
            if (notes.length === 0) {
                showToast('Keine Notizen zum Exportieren');
                return;
            }

            const user = getCurrentUser();
            const username = user?.username || 'export';
            const date = new Date().toISOString().split('T')[0];

            // Build Markdown content
            let md = `# PnP Companion - Notizen\n`;
            md += `**Spieler:** ${username}\n`;
            md += `**Exportiert:** ${new Date().toLocaleString('de-DE')}\n\n`;
            md += `---\n\n`;

            // Group by category for export
            const byCategory = {};
            notes.forEach(note => {
                if (!byCategory[note.category]) byCategory[note.category] = [];
                byCategory[note.category].push(note);
            });

            for (const [cat, catNotes] of Object.entries(byCategory)) {
                md += `## ${CATEGORY_LABELS[cat] || cat}\n\n`;
                
                catNotes.forEach(note => {
                    md += `### ${note.title}${note.pinned ? ' üìå' : ''}\n`;
                    if (note.content) {
                        md += `${note.content}\n`;
                    }
                    md += `\n*Erstellt: ${new Date(note.created).toLocaleString('de-DE')}*\n\n`;
                });
            }

            // Download
            const blob = new Blob([md], { type: 'text/markdown' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `pnp_notizen_${username}_${date}.md`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);

            showToast('Export heruntergeladen');
        }

        // ===== IMPORT =====
        function importNotes(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const content = e.target.result;
                    let importedNotes = [];

                    if (file.name.endsWith('.json')) {
                        // JSON import
                        importedNotes = JSON.parse(content);
                        if (!Array.isArray(importedNotes)) {
                            throw new Error('Ung√ºltiges Format');
                        }
                    } else {
                        showToast('Nur JSON-Import wird unterst√ºtzt');
                        return;
                    }

                    // Validate notes structure
                    importedNotes = importedNotes.filter(note => 
                        note && note.title && note.category
                    ).map(note => ({
                        id: note.id || generateId(),
                        title: note.title,
                        content: note.content || '',
                        category: note.category,
                        pinned: note.pinned || false,
                        created: note.created || Date.now(),
                        updated: note.updated || Date.now()
                    }));

                    if (importedNotes.length === 0) {
                        showToast('Keine g√ºltigen Notizen gefunden');
                        return;
                    }

                    // Ask user how to import
                    const action = confirm(
                        `${importedNotes.length} Notizen gefunden.\n\n` +
                        `OK = Zu bestehenden hinzuf√ºgen\n` +
                        `Abbrechen = Import abbrechen`
                    );

                    if (action) {
                        // Merge - add imported notes, avoid duplicates by ID
                        const existingIds = new Set(notes.map(n => n.id));
                        importedNotes.forEach(note => {
                            if (!existingIds.has(note.id)) {
                                notes.push(note);
                            }
                        });
                        saveNotes();
                        renderNotes();
                        showToast(`${importedNotes.length} Notizen importiert`);
                    }
                } catch (err) {
                    console.error('Import error:', err);
                    showToast('Fehler beim Import: ' + err.message);
                }

                // Reset file input
                event.target.value = '';
            };

            reader.readAsText(file);
        }

        // ===== EXPORT JSON (for backup/import) =====
        function exportNotesJSON() {
            if (notes.length === 0) {
                showToast('Keine Notizen zum Exportieren');
                return;
            }

            const user = getCurrentUser();
            const username = user?.username || 'export';
            const date = new Date().toISOString().split('T')[0];

            const blob = new Blob([JSON.stringify(notes, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `pnp_notizen_${username}_${date}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);

            showToast('JSON-Backup heruntergeladen');
        }

        // ===== UTILITIES =====
        function generateId() {
            return 'note_' + Date.now().toString(36) + Math.random().toString(36).substr(2, 5);
        }

        function escapeHtml(str) {
            if (!str) return '';
            const div = document.createElement('div');
            div.textContent = str;
            return div.innerHTML;
        }

        function formatDate(timestamp) {
            return new Date(timestamp).toISOString().split('T')[0];
        }

        function formatSessionDate(dateStr) {
            const d = new Date(dateStr);
            const today = new Date();
            const yesterday = new Date(today);
            yesterday.setDate(yesterday.getDate() - 1);

            if (d.toDateString() === today.toDateString()) return 'Heute';
            if (d.toDateString() === yesterday.toDateString()) return 'Gestern';
            
            return d.toLocaleDateString('de-DE', {
                weekday: 'long',
                day: 'numeric',
                month: 'long',
                year: 'numeric'
            });
        }

        function formatTime(timestamp) {
            return new Date(timestamp).toLocaleTimeString('de-DE', {
                hour: '2-digit',
                minute: '2-digit'
            });
        }

        function debounce(func, wait) {
            let timeout;
            return function(...args) {
                clearTimeout(timeout);
                timeout = setTimeout(() => func(...args), wait);
            };
        }

        function showToast(message) {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.classList.add('show');
            setTimeout(() => toast.classList.remove('show'), 2500);
        }

        // ===== MARKDOWN TOOLBAR =====
        function insertMarkdown(type) {
            const textarea = document.getElementById('noteContent');
            const start = textarea.selectionStart;
            const end = textarea.selectionEnd;
            const text = textarea.value;
            const selectedText = text.substring(start, end);

            let before = '';
            let after = '';
            let placeholder = '';

            switch (type) {
                case 'bold':
                    before = '**';
                    after = '**';
                    placeholder = 'fetter Text';
                    break;
                case 'italic':
                    before = '*';
                    after = '*';
                    placeholder = 'kursiver Text';
                    break;
                case 'code':
                    before = '`';
                    after = '`';
                    placeholder = 'code';
                    break;
                case 'list':
                    before = '\n- ';
                    after = '';
                    placeholder = 'Listenpunkt';
                    break;
                case 'heading':
                    before = '\n## ';
                    after = '';
                    placeholder = '√úberschrift';
                    break;
            }

            const insert = selectedText || placeholder;
            const newText = text.substring(0, start) + before + insert + after + text.substring(end);

            textarea.value = newText;
            textarea.focus();

            // Position cursor
            if (selectedText) {
                // Keep selection
                textarea.selectionStart = start + before.length;
                textarea.selectionEnd = start + before.length + insert.length;
            } else {
                // Select placeholder
                textarea.selectionStart = start + before.length;
                textarea.selectionEnd = start + before.length + placeholder.length;
            }
        }

        // Keyboard shortcuts for markdown in textarea
        document.addEventListener('DOMContentLoaded', () => {
            const textarea = document.getElementById('noteContent');
            if (textarea) {
                textarea.addEventListener('keydown', (e) => {
                    if (e.ctrlKey || e.metaKey) {
                        if (e.key === 'b') {
                            e.preventDefault();
                            insertMarkdown('bold');
                        } else if (e.key === 'i') {
                            e.preventDefault();
                            insertMarkdown('italic');
                        }
                    }
                });
            }
        });
        
        // Create footer
        createFooter();
    </script>
</body>
</html>
